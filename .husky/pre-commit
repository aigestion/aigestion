#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# =============================================================================
# Pre-commit Security & Quality Checks
# =============================================================================

echo "ğŸ” Running pre-commit security checks..."

# Check 1: Prevent .env files from being committed
echo "ğŸ“ Checking for .env files..."
if git diff --cached --name-only | grep -qE "\.env$" | grep -v "\.env\.example"; then
    echo "âŒ ERROR: Attempted to commit .env file(s)"
    echo "ğŸ’¡ Use .env.example instead for templates"
    git diff --cached --name-only | grep "\.env$" | grep -v "\.env\.example"
    exit 1
fi

# Check 2: Scan for potential secrets in staged files
echo "ğŸ” Scanning for potential secrets..."
if git diff --cached | grep -iE "(api[_-]?key|secret|password|token)\s*[:=]\s*['\"]?[a-zA-Z0-9]{20,}"; then
    echo "âš ï¸  WARNING: Potential secret detected in staged files!"
    echo "Please review your commit carefully."
    read -p "Continue anyway? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "âŒ Commit aborted"
        exit 1
    fi
fi

echo "âœ… Security checks passed"

# Run lint-staged
npx lint-staged
