# =============================================================================
# Pre-commit Security & Quality Checks
# =============================================================================

echo "ğŸ” Running pre-commit security checks..."

# Check 1: Prevent .env files from being committed
echo "ğŸ“ Checking for .env files..."
if git diff --cached --name-only | grep -qE "\.env$" | grep -v "\.env\.example"; then
    echo "âŒ ERROR: Attempted to commit .env file(s)"
    echo "ğŸ’¡ Use .env.example instead for templates"
    git diff --cached --name-only | grep "\.env$" | grep -v "\.env\.example"
    exit 1
fi

# Check 2: Scan for potential secrets in staged files
echo "ğŸ” Scanning for potential secrets..."
# Exclude minified files, dist folders, and known safe patterns (dev defaults)
if git diff --cached --name-only | grep -vE "\.(min\.js|bundle\.js)$" | grep -vE "^(dist|build|node_modules)/" | xargs -r git diff --cached | grep -iE "(api[_-]?key|secret|password|token)\s*[:=]\s*['\"]?[a-zA-Z0-9_-]{30,}" | grep -vE "(getChildKey|resolveKeyframes|startsWithToken|startsAsVariableToken|dev_secret_key_change_in_production)"; then
    echo "âš ï¸  WARNING: Potential secret detected in staged files!"
    echo "Please review your commit carefully. (Proceeding in non-interactive mode)"
fi

echo "âœ… Security checks passed"

# Run lint-staged
npx lint-staged

