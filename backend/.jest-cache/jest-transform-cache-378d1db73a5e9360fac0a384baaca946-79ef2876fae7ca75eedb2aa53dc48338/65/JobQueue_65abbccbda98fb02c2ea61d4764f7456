b213727abd1070cef736455624e239c9
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.JobQueue = void 0;
const inversify_1 = require("inversify");
const bullmq_1 = require("bullmq");
const job_definitions_1 = require("./job-definitions");
const logger_1 = require("../../utils/logger");
let JobQueue = class JobQueue {
    queues = new Map();
    redisOptions;
    constructor() {
        this.redisOptions = {
            host: process.env.REDIS_HOST || 'localhost',
            port: parseInt(process.env.REDIS_PORT || '6379'),
            password: process.env.REDIS_PASSWORD || undefined,
        };
        this.initializeQueues();
    }
    initializeQueues() {
        if (process.env.ENABLE_REDIS === 'false') {
            logger_1.logger.info('JobQueue: Redis disabled, skipping queue initialization');
            return;
        }
        Object.values(job_definitions_1.JobName).forEach(name => {
            const queue = new bullmq_1.Queue(name, {
                connection: this.redisOptions,
            });
            this.queues.set(name, queue);
        });
    }
    async addJob(name, data, opts) {
        const queue = this.queues.get(name);
        if (!queue) {
            if (process.env.ENABLE_REDIS === 'false') {
                logger_1.logger.warn(`JobQueue: Redis disabled, skipping job ${name}`);
                return;
            }
            logger_1.logger.error(`Queue not found for job: ${name}`);
            throw new Error(`Queue not found for job: ${name}`);
        }
        await queue.add(name, data, opts);
    }
    async close() {
        for (const queue of this.queues.values()) {
            await queue.close();
        }
    }
};
exports.JobQueue = JobQueue;
exports.JobQueue = JobQueue = __decorate([
    (0, inversify_1.injectable)(),
    __metadata("design:paramtypes", [])
], JobQueue);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxpbmZyYXN0cnVjdHVyZVxcam9ic1xcSm9iUXVldWUudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBQUEseUNBQStDO0FBQy9DLG1DQUE2QztBQUM3Qyx1REFBMEQ7QUFDMUQsK0NBQTRDO0FBR3JDLElBQU0sUUFBUSxHQUFkLE1BQU0sUUFBUTtJQUNYLE1BQU0sR0FBdUIsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUN2QyxZQUFZLENBQU07SUFFMUI7UUFDRSxJQUFJLENBQUMsWUFBWSxHQUFHO1lBQ2xCLElBQUksRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsSUFBSSxXQUFXO1lBQzNDLElBQUksRUFBRSxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksTUFBTSxDQUFDO1lBQ2hELFFBQVEsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsSUFBSSxTQUFTO1NBQ2xELENBQUM7UUFDRixJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztJQUMxQixDQUFDO0lBRU8sZ0JBQWdCO1FBQ3RCLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLEtBQUssT0FBTyxFQUFFLENBQUM7WUFDekMsZUFBTSxDQUFDLElBQUksQ0FBQyx5REFBeUQsQ0FBQyxDQUFDO1lBQ3ZFLE9BQU87UUFDVCxDQUFDO1FBRUQsTUFBTSxDQUFDLE1BQU0sQ0FBQyx5QkFBTyxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ3BDLE1BQU0sS0FBSyxHQUFHLElBQUksY0FBSyxDQUFDLElBQUksRUFBRTtnQkFDNUIsVUFBVSxFQUFFLElBQUksQ0FBQyxZQUFZO2FBQzlCLENBQUMsQ0FBQztZQUNILElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztRQUMvQixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFTSxLQUFLLENBQUMsTUFBTSxDQUNqQixJQUFPLEVBQ1AsSUFBcUIsRUFDckIsSUFBVTtRQUVWLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLElBQWMsQ0FBQyxDQUFDO1FBQzlDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUNYLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLEtBQUssT0FBTyxFQUFFLENBQUM7Z0JBQ3pDLGVBQU0sQ0FBQyxJQUFJLENBQUMsMENBQTBDLElBQUksRUFBRSxDQUFDLENBQUM7Z0JBQzlELE9BQU87WUFDVCxDQUFDO1lBQ0QsZUFBTSxDQUFDLEtBQUssQ0FBQyw0QkFBNEIsSUFBSSxFQUFFLENBQUMsQ0FBQztZQUNqRCxNQUFNLElBQUksS0FBSyxDQUFDLDRCQUE0QixJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQ3RELENBQUM7UUFDRCxNQUFNLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBYyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztJQUM5QyxDQUFDO0lBRU0sS0FBSyxDQUFDLEtBQUs7UUFDaEIsS0FBSyxNQUFNLEtBQUssSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUM7WUFDekMsTUFBTSxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDdEIsQ0FBQztJQUNILENBQUM7Q0FDRixDQUFBO0FBakRZLDRCQUFRO21CQUFSLFFBQVE7SUFEcEIsSUFBQSxzQkFBVSxHQUFFOztHQUNBLFFBQVEsQ0FpRHBCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcQWxlamFuZHJvXFxBSUdlc3Rpb25cXGJhY2tlbmRcXHNyY1xcaW5mcmFzdHJ1Y3R1cmVcXGpvYnNcXEpvYlF1ZXVlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGluamVjdGFibGUsIGluamVjdCB9IGZyb20gJ2ludmVyc2lmeSc7XG5pbXBvcnQgeyBRdWV1ZSwgUXVldWVPcHRpb25zIH0gZnJvbSAnYnVsbG1xJztcbmltcG9ydCB7IEpvYk5hbWUsIElKb2JQYXlsb2FkcyB9IGZyb20gJy4vam9iLWRlZmluaXRpb25zJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uLy4uL3V0aWxzL2xvZ2dlcic7XG5cbkBpbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBKb2JRdWV1ZSB7XG4gIHByaXZhdGUgcXVldWVzOiBNYXA8c3RyaW5nLCBRdWV1ZT4gPSBuZXcgTWFwKCk7XG4gIHByaXZhdGUgcmVkaXNPcHRpb25zOiBhbnk7XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5yZWRpc09wdGlvbnMgPSB7XG4gICAgICBob3N0OiBwcm9jZXNzLmVudi5SRURJU19IT1NUIHx8ICdsb2NhbGhvc3QnLFxuICAgICAgcG9ydDogcGFyc2VJbnQocHJvY2Vzcy5lbnYuUkVESVNfUE9SVCB8fCAnNjM3OScpLFxuICAgICAgcGFzc3dvcmQ6IHByb2Nlc3MuZW52LlJFRElTX1BBU1NXT1JEIHx8IHVuZGVmaW5lZCxcbiAgICB9O1xuICAgIHRoaXMuaW5pdGlhbGl6ZVF1ZXVlcygpO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0aWFsaXplUXVldWVzKCkge1xuICAgIGlmIChwcm9jZXNzLmVudi5FTkFCTEVfUkVESVMgPT09ICdmYWxzZScpIHtcbiAgICAgIGxvZ2dlci5pbmZvKCdKb2JRdWV1ZTogUmVkaXMgZGlzYWJsZWQsIHNraXBwaW5nIHF1ZXVlIGluaXRpYWxpemF0aW9uJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgT2JqZWN0LnZhbHVlcyhKb2JOYW1lKS5mb3JFYWNoKG5hbWUgPT4ge1xuICAgICAgY29uc3QgcXVldWUgPSBuZXcgUXVldWUobmFtZSwge1xuICAgICAgICBjb25uZWN0aW9uOiB0aGlzLnJlZGlzT3B0aW9ucyxcbiAgICAgIH0pO1xuICAgICAgdGhpcy5xdWV1ZXMuc2V0KG5hbWUsIHF1ZXVlKTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBhZGRKb2I8VCBleHRlbmRzIEpvYk5hbWU+KFxuICAgIG5hbWU6IFQsXG4gICAgZGF0YTogSUpvYlBheWxvYWRzW1RdLFxuICAgIG9wdHM/OiBhbnksXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHF1ZXVlID0gdGhpcy5xdWV1ZXMuZ2V0KG5hbWUgYXMgc3RyaW5nKTtcbiAgICBpZiAoIXF1ZXVlKSB7XG4gICAgICBpZiAocHJvY2Vzcy5lbnYuRU5BQkxFX1JFRElTID09PSAnZmFsc2UnKSB7XG4gICAgICAgIGxvZ2dlci53YXJuKGBKb2JRdWV1ZTogUmVkaXMgZGlzYWJsZWQsIHNraXBwaW5nIGpvYiAke25hbWV9YCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGxvZ2dlci5lcnJvcihgUXVldWUgbm90IGZvdW5kIGZvciBqb2I6ICR7bmFtZX1gKTtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgUXVldWUgbm90IGZvdW5kIGZvciBqb2I6ICR7bmFtZX1gKTtcbiAgICB9XG4gICAgYXdhaXQgcXVldWUuYWRkKG5hbWUgYXMgc3RyaW5nLCBkYXRhLCBvcHRzKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBjbG9zZSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBmb3IgKGNvbnN0IHF1ZXVlIG9mIHRoaXMucXVldWVzLnZhbHVlcygpKSB7XG4gICAgICBhd2FpdCBxdWV1ZS5jbG9zZSgpO1xuICAgIH1cbiAgfVxufVxuIl0sInZlcnNpb24iOjN9