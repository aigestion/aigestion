24059af3070d9b852177f426144c75f8
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.apiKeyAuth = void 0;
const env_schema_1 = require("../config/env.schema");
const logger_1 = require("../utils/logger");
/**
 * Service-to-Service Authentication Middleware.
 * Validates X-API-Key against known microservice keys.
 */
const apiKeyAuth = (req, res, next) => {
    const apiKey = req.headers['x-api-key'];
    if (!apiKey) {
        return next(); // Pass to next middleware (likely JWT protect)
    }
    // Check against our known service keys
    const validKeys = [
        env_schema_1.env.ML_SERVICE_API_KEY,
        env_schema_1.env.IA_ENGINE_API_KEY,
    ];
    if (validKeys.includes(apiKey)) {
        // If it's a valid service key, we grant a "system" user context
        req.user = {
            id: 'system-agent',
            email: 'service@aigestion.net',
            role: 'admin', // Microservices are granted high-level access
        };
        logger_1.logger.debug(`[Auth] Validated microservice callback via X-API-Key`);
        return next();
    }
    // If a key was provided but it's invalid
    return res.status(403).json({
        success: false,
        message: 'Invalid Service API Key',
    });
};
exports.apiKeyAuth = apiKeyAuth;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxtaWRkbGV3YXJlXFxhcGkta2V5Lm1pZGRsZXdhcmUudHMiLCJtYXBwaW5ncyI6Ijs7O0FBQ0EscURBQTJDO0FBQzNDLDRDQUF5QztBQUV6Qzs7O0dBR0c7QUFDSSxNQUFNLFVBQVUsR0FBRyxDQUFDLEdBQVksRUFBRSxHQUFhLEVBQUUsSUFBa0IsRUFBRSxFQUFFO0lBQzVFLE1BQU0sTUFBTSxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7SUFFeEMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ1osT0FBTyxJQUFJLEVBQUUsQ0FBQyxDQUFDLCtDQUErQztJQUNoRSxDQUFDO0lBRUQsdUNBQXVDO0lBQ3ZDLE1BQU0sU0FBUyxHQUFHO1FBQ2hCLGdCQUFHLENBQUMsa0JBQWtCO1FBQ3RCLGdCQUFHLENBQUMsaUJBQWlCO0tBQ3RCLENBQUM7SUFFRixJQUFJLFNBQVMsQ0FBQyxRQUFRLENBQUMsTUFBZ0IsQ0FBQyxFQUFFLENBQUM7UUFDekMsZ0VBQWdFO1FBQy9ELEdBQVcsQ0FBQyxJQUFJLEdBQUc7WUFDbEIsRUFBRSxFQUFFLGNBQWM7WUFDbEIsS0FBSyxFQUFFLHVCQUF1QjtZQUM5QixJQUFJLEVBQUUsT0FBTyxFQUFFLDhDQUE4QztTQUM5RCxDQUFDO1FBQ0YsZUFBTSxDQUFDLEtBQUssQ0FBQyxzREFBc0QsQ0FBQyxDQUFDO1FBQ3JFLE9BQU8sSUFBSSxFQUFFLENBQUM7SUFDaEIsQ0FBQztJQUVELHlDQUF5QztJQUN6QyxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO1FBQzFCLE9BQU8sRUFBRSxLQUFLO1FBQ2QsT0FBTyxFQUFFLHlCQUF5QjtLQUNuQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUM7QUE3QlcsUUFBQSxVQUFVLGNBNkJyQiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXEFsZWphbmRyb1xcQUlHZXN0aW9uXFxiYWNrZW5kXFxzcmNcXG1pZGRsZXdhcmVcXGFwaS1rZXkubWlkZGxld2FyZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IE5leHRGdW5jdGlvbiwgUmVxdWVzdCwgUmVzcG9uc2UgfSBmcm9tICdleHByZXNzJztcclxuaW1wb3J0IHsgZW52IH0gZnJvbSAnLi4vY29uZmlnL2Vudi5zY2hlbWEnO1xyXG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuLi91dGlscy9sb2dnZXInO1xyXG5cclxuLyoqXHJcbiAqIFNlcnZpY2UtdG8tU2VydmljZSBBdXRoZW50aWNhdGlvbiBNaWRkbGV3YXJlLlxyXG4gKiBWYWxpZGF0ZXMgWC1BUEktS2V5IGFnYWluc3Qga25vd24gbWljcm9zZXJ2aWNlIGtleXMuXHJcbiAqL1xyXG5leHBvcnQgY29uc3QgYXBpS2V5QXV0aCA9IChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xyXG4gIGNvbnN0IGFwaUtleSA9IHJlcS5oZWFkZXJzWyd4LWFwaS1rZXknXTtcclxuXHJcbiAgaWYgKCFhcGlLZXkpIHtcclxuICAgIHJldHVybiBuZXh0KCk7IC8vIFBhc3MgdG8gbmV4dCBtaWRkbGV3YXJlIChsaWtlbHkgSldUIHByb3RlY3QpXHJcbiAgfVxyXG5cclxuICAvLyBDaGVjayBhZ2FpbnN0IG91ciBrbm93biBzZXJ2aWNlIGtleXNcclxuICBjb25zdCB2YWxpZEtleXMgPSBbXHJcbiAgICBlbnYuTUxfU0VSVklDRV9BUElfS0VZLFxyXG4gICAgZW52LklBX0VOR0lORV9BUElfS0VZLFxyXG4gIF07XHJcblxyXG4gIGlmICh2YWxpZEtleXMuaW5jbHVkZXMoYXBpS2V5IGFzIHN0cmluZykpIHtcclxuICAgIC8vIElmIGl0J3MgYSB2YWxpZCBzZXJ2aWNlIGtleSwgd2UgZ3JhbnQgYSBcInN5c3RlbVwiIHVzZXIgY29udGV4dFxyXG4gICAgKHJlcSBhcyBhbnkpLnVzZXIgPSB7XHJcbiAgICAgIGlkOiAnc3lzdGVtLWFnZW50JyxcclxuICAgICAgZW1haWw6ICdzZXJ2aWNlQGFpZ2VzdGlvbi5uZXQnLFxyXG4gICAgICByb2xlOiAnYWRtaW4nLCAvLyBNaWNyb3NlcnZpY2VzIGFyZSBncmFudGVkIGhpZ2gtbGV2ZWwgYWNjZXNzXHJcbiAgICB9O1xyXG4gICAgbG9nZ2VyLmRlYnVnKGBbQXV0aF0gVmFsaWRhdGVkIG1pY3Jvc2VydmljZSBjYWxsYmFjayB2aWEgWC1BUEktS2V5YCk7XHJcbiAgICByZXR1cm4gbmV4dCgpO1xyXG4gIH1cclxuXHJcbiAgLy8gSWYgYSBrZXkgd2FzIHByb3ZpZGVkIGJ1dCBpdCdzIGludmFsaWRcclxuICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oe1xyXG4gICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICBtZXNzYWdlOiAnSW52YWxpZCBTZXJ2aWNlIEFQSSBLZXknLFxyXG4gIH0pO1xyXG59O1xyXG4iXSwidmVyc2lvbiI6M30=