{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\middleware\\api-key.middleware.ts","mappings":";;;AACA,qDAA2C;AAC3C,4CAAyC;AAEzC;;;GAGG;AACI,MAAM,UAAU,GAAG,CAAC,GAAY,EAAE,GAAa,EAAE,IAAkB,EAAE,EAAE;IAC5E,MAAM,MAAM,GAAG,GAAG,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC;IAExC,IAAI,CAAC,MAAM,EAAE,CAAC;QACZ,OAAO,IAAI,EAAE,CAAC,CAAC,+CAA+C;IAChE,CAAC;IAED,uCAAuC;IACvC,MAAM,SAAS,GAAG;QAChB,gBAAG,CAAC,kBAAkB;QACtB,gBAAG,CAAC,iBAAiB;KACtB,CAAC;IAEF,IAAI,SAAS,CAAC,QAAQ,CAAC,MAAgB,CAAC,EAAE,CAAC;QACzC,gEAAgE;QAC/D,GAAW,CAAC,IAAI,GAAG;YAClB,EAAE,EAAE,cAAc;YAClB,KAAK,EAAE,uBAAuB;YAC9B,IAAI,EAAE,OAAO,EAAE,8CAA8C;SAC9D,CAAC;QACF,eAAM,CAAC,KAAK,CAAC,sDAAsD,CAAC,CAAC;QACrE,OAAO,IAAI,EAAE,CAAC;IAChB,CAAC;IAED,yCAAyC;IACzC,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;QAC1B,OAAO,EAAE,KAAK;QACd,OAAO,EAAE,yBAAyB;KACnC,CAAC,CAAC;AACL,CAAC,CAAC;AA7BW,QAAA,UAAU,cA6BrB","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\middleware\\api-key.middleware.ts"],"sourcesContent":["import type { NextFunction, Request, Response } from 'express';\r\nimport { env } from '../config/env.schema';\r\nimport { logger } from '../utils/logger';\r\n\r\n/**\r\n * Service-to-Service Authentication Middleware.\r\n * Validates X-API-Key against known microservice keys.\r\n */\r\nexport const apiKeyAuth = (req: Request, res: Response, next: NextFunction) => {\r\n  const apiKey = req.headers['x-api-key'];\r\n\r\n  if (!apiKey) {\r\n    return next(); // Pass to next middleware (likely JWT protect)\r\n  }\r\n\r\n  // Check against our known service keys\r\n  const validKeys = [\r\n    env.ML_SERVICE_API_KEY,\r\n    env.IA_ENGINE_API_KEY,\r\n  ];\r\n\r\n  if (validKeys.includes(apiKey as string)) {\r\n    // If it's a valid service key, we grant a \"system\" user context\r\n    (req as any).user = {\r\n      id: 'system-agent',\r\n      email: 'service@aigestion.net',\r\n      role: 'admin', // Microservices are granted high-level access\r\n    };\r\n    logger.debug(`[Auth] Validated microservice callback via X-API-Key`);\r\n    return next();\r\n  }\r\n\r\n  // If a key was provided but it's invalid\r\n  return res.status(403).json({\r\n    success: false,\r\n    message: 'Invalid Service API Key',\r\n  });\r\n};\r\n"],"version":3}