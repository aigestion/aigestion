{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\rate-limit.service.ts","mappings":";;;;;;;;;AAAA,yCAAuC;AACvC,0CAAgD;AAChD,4CAA2C;AAC3C,4CAAyC;AAGlC,IAAM,gBAAgB,GAAtB,MAAM,gBAAgB;IAC3B;;;;;;;;OAQG;IACH,KAAK,CAAC,iBAAiB,CAAC,GAAW,EAAE,KAAa,EAAE,aAAqB;QACvE,MAAM,KAAK,GAAG,IAAA,sBAAc,GAAE,CAAC;QAE/B,IAAI,CAAC,KAAK,IAAI,CAAC,KAAK,CAAC,MAAM,EAAE,CAAC;YAC5B,eAAM,CAAC,IAAI,CAAC,uDAAuD,CAAC,CAAC;YACrE,OAAO;QACT,CAAC;QAED,IAAI,CAAC;YACH,6BAA6B;YAC7B,MAAM,OAAO,GAAG,MAAM,KAAK,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;YAEtC,+DAA+D;YAC/D,IAAI,OAAO,KAAK,CAAC,EAAE,CAAC;gBAClB,MAAM,KAAK,CAAC,MAAM,CAAC,GAAG,EAAE,aAAa,CAAC,CAAC;YACzC,CAAC;YAED,IAAI,OAAO,GAAG,KAAK,EAAE,CAAC;gBACpB,MAAM,GAAG,GAAG,MAAM,KAAK,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;gBACjC,MAAM,IAAI,iBAAQ,CAChB,0CAA0C,IAAI,CAAC,IAAI,CAAC,GAAG,GAAG,EAAE,CAAC,WAAW,EACxE,GAAG,EACH,qBAAqB,CACtB,CAAC;YACJ,CAAC;QACH,CAAC;QAAC,OAAO,KAAU,EAAE,CAAC;YACpB,2CAA2C;YAC3C,IAAI,KAAK,YAAY,iBAAQ,EAAE,CAAC;gBAC9B,MAAM,KAAK,CAAC;YACd,CAAC;YACD,kEAAkE;YAClE,uFAAuF;YACvF,6CAA6C;YAC7C,mGAAmG;YACnG,8EAA8E;YAC9E,oDAAoD;YACpD,eAAM,CAAC,KAAK,CAAC,EAAE,KAAK,EAAE,GAAG,EAAE,EAAE,0BAA0B,CAAC,CAAC;QAC3D,CAAC;IACH,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,KAAK,CAAC,GAAW;QACrB,MAAM,KAAK,GAAG,IAAA,sBAAc,GAAE,CAAC;QAC/B,IAAI,CAAC,KAAK,IAAI,CAAC,KAAK,CAAC,MAAM;YAAE,OAAO;QAEpC,IAAI,CAAC;YACH,MAAM,KAAK,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;QACvB,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,EAAE,KAAK,EAAE,GAAG,EAAE,EAAE,gCAAgC,CAAC,CAAC;QACjE,CAAC;IACH,CAAC;CACF,CAAA;AA/DY,4CAAgB;2BAAhB,gBAAgB;IAD5B,IAAA,sBAAU,GAAE;GACA,gBAAgB,CA+D5B","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\rate-limit.service.ts"],"sourcesContent":["import { injectable } from 'inversify';\nimport { getRedisClient } from '../cache/redis';\nimport { AppError } from '../utils/errors';\nimport { logger } from '../utils/logger';\n\n@injectable()\nexport class RateLimitService {\n  /**\n   * Increments a counter for a specific key and checks if it exceeds the limit.\n   * If the key doesn't exist, it sets it with the specified expiration window.\n   *\n   * @param key The unique key to rate limit (e.g., \"2fa:userId\")\n   * @param limit Maximum allowed attempts\n   * @param windowSeconds Time window in seconds\n   * @throws AppError if limit is exceeded\n   */\n  async incrementAndCheck(key: string, limit: number, windowSeconds: number): Promise<void> {\n    const redis = getRedisClient();\n\n    if (!redis || !redis.isOpen) {\n      logger.warn('Redis not available for rate limiting, skipping check');\n      return;\n    }\n\n    try {\n      // INCR returns the new value\n      const current = await redis.incr(key);\n\n      // If this is the first request (current === 1), set expiration\n      if (current === 1) {\n        await redis.expire(key, windowSeconds);\n      }\n\n      if (current > limit) {\n        const ttl = await redis.ttl(key);\n        throw new AppError(\n          `Too many attempts. Please try again in ${Math.ceil(ttl / 60)} minutes.`,\n          429,\n          'RATE_LIMIT_EXCEEDED',\n        );\n      }\n    } catch (error: any) {\n      // Re-throw AppErrors (rate limit exceeded)\n      if (error instanceof AppError) {\n        throw error;\n      }\n      // Log other Redis errors but don't block the user flow generally,\n      // unless strict sec is required. For now, log and proceed is \"safer\" for availability,\n      // but \"fail open\" might be bad for security.\n      // Given this is a security feature, \"fail closed\" (block) is safer but risky for UX if Redis dies.\n      // Decision: Let's log error and allow access to avoid lockout if Redis blips,\n      // UNLESS it's the specific AppError we threw above.\n      logger.error({ error, key }, 'Rate limit service error');\n    }\n  }\n\n  /**\n   * Resets (deletes) the rate limit key. Useful on successful verification.\n   */\n  async reset(key: string): Promise<void> {\n    const redis = getRedisClient();\n    if (!redis || !redis.isOpen) return;\n\n    try {\n      await redis.del(key);\n    } catch (error) {\n      logger.error({ error, key }, 'Failed to reset rate limit key');\n    }\n  }\n}\n"],"version":3}