{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\voice.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\voice.service.ts"],"sourcesContent":["import { inject, injectable } from 'inversify';\nimport { TYPES } from '../types';\nimport { AIService } from './ai.service';\nimport { AnalyticsService } from './analytics.service';\nimport { MetaverseService } from './metaverse.service';\nimport { logger } from '../utils/logger';\nimport { env } from '../config/env.schema';\nimport { DANIELA_SYSTEM_PROMPT } from '../config/prompts/daniela.persona';\n\n@injectable()\nexport class VoiceService {\n  constructor(\n    @inject(TYPES.AIService) private aiService: AIService,\n    @inject(TYPES.AnalyticsService) private analyticsService: AnalyticsService,\n    @inject(TYPES.MetaverseService) private metaverseService: MetaverseService,\n  ) {}\n\n  /**\n   * Processes a message from Vapi and returns the response for the voice assistant\n   */\n  async processVapiMessage(payload: any): Promise<any> {\n    const messageType = payload.message?.type;\n\n    if (messageType === 'assistant-request') {\n      // Return the initial assistant configuration\n      return {\n        assistant: {\n          name: 'Daniela',\n          model: {\n            provider: 'openai',\n            model: 'gpt-4o',\n            systemPrompt: `${DANIELA_SYSTEM_PROMPT}\\n\\n[CONTEXTO ACTUAL]\\nFecha: ${new Date().toLocaleDateString()}\\nHora: ${new Date().toLocaleTimeString()}\\nEntorno: ${\n              env.NODE_ENV\n            }`,\n          },\n          voice: {\n            provider: 'eleven_labs',\n            voiceId: env.ELEVENLABS_VOICE_ID || 'eleven_monica',\n          },\n          tools: [\n            {\n              type: 'function',\n              function: {\n                name: 'get_business_summary',\n                description: 'Get a summary of business health, revenue, and growth.',\n                parameters: { type: 'object', properties: {} },\n              },\n            },\n            {\n              type: 'function',\n              function: {\n                name: 'get_metaverse_office_status',\n                description:\n                  'Get the coordinates and status of our Decentraland virtual headquarters.',\n                parameters: { type: 'object', properties: {} },\n              },\n            },\n          ],\n        },\n      };\n    }\n\n    if (messageType === 'function-call') {\n      const functionCall = payload.message.functionCall;\n      return await this.handleFunctionCall(functionCall);\n    }\n\n    return { status: 'ignored', type: messageType };\n  }\n\n  private async handleFunctionCall(call: any): Promise<any> {\n    const { name, parameters } = call;\n    logger.info(`[VoiceService] Voice Tool Call: ${name}`, parameters);\n\n    try {\n      if (name === 'get_business_summary') {\n        const data = await this.analyticsService.getDashboardData();\n        return {\n          result: `The current monthly revenue is $${data.revenue.reduce(\n            (acc: number, curr: any) => acc + curr.value,\n            0,\n          )}. User growth is steady with ${data.users.length} new signups recently.`,\n        };\n      }\n\n      if (name === 'get_metaverse_office_status') {\n        const status = await this.metaverseService.getStatus();\n        return {\n          result: `Our virtual headquarters is located at coordinates ${\n            status.coordinates\n          } in Decentraland. ${\n            status.activeEvents.length > 0\n              ? `We have an active event: ${status.activeEvents[0].title}.`\n              : 'No events are currently scheduled.'\n          } You can visit it at ${status.visitUrl}`,\n        };\n      }\n\n      return { error: 'Unknown function' };\n    } catch (error) {\n      logger.error(error, `[VoiceService] Error handling voice tool: ${name}`);\n      return { error: 'Internal service error' };\n    }\n  }\n}\n"],"version":3}