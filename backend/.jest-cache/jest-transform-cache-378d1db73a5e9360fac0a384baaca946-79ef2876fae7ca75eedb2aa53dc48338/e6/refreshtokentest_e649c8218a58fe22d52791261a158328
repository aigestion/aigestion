6e6b6676428ee2e25688d8bc9e7d30f7
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const supertest_1 = __importDefault(require("supertest"));
const app_1 = require("../../../app");
const User_1 = require("../../../models/User");
const SKIP_DB_TESTS = process.env.NODE_ENV === 'test' && !process.env.RUN_INTEGRATION_TESTS;
// Variables prefixed with 'mock' are available in jest.mock
const mockUsers = [];
(SKIP_DB_TESTS ? describe.skip : describe)('Refresh Token Rotation', () => {
    let authCookie;
    beforeAll(async () => {
        jest.setTimeout(30000);
        jest.clearAllMocks();
        // @ts-ignore
        await User_1.User.deleteMany({});
    });
    it('should set httpOnly cookie on login', async () => {
        await (0, supertest_1.default)(app_1.app).post('/api/v1/auth/register').send({
            name: 'Cookie Monster',
            email: 'cookie@test.com',
            password: 'AIGestion123!',
        });
        const response = await (0, supertest_1.default)(app_1.app).post('/api/v1/auth/login').send({
            email: 'cookie@test.com',
            password: 'AIGestion123!',
        });
        expect(response.status).toBe(200);
        const cookies = response.headers['set-cookie'];
        authCookie = cookies.find((c) => c.startsWith('refresh_token'));
    });
    it('should rotate token on refresh', async () => {
        await new Promise(r => setTimeout(r, 10));
        const response = await (0, supertest_1.default)(app_1.app).get('/api/v1/auth/refresh').set('Cookie', [authCookie]);
        expect(response.status).toBe(200);
        const newCookies = response.headers['set-cookie'];
        const newAuthCookie = newCookies.find((c) => c.startsWith('refresh_token'));
        expect(newAuthCookie).not.toEqual(authCookie);
        authCookie = newAuthCookie;
    });
    it('should detect reuse and invalidate family', async () => {
        // 1. Get current valid cookie (Family A, generation 2)
        const checkResponse = await (0, supertest_1.default)(app_1.app)
            .get('/api/v1/auth/refresh')
            .set('Cookie', [authCookie]);
        expect(checkResponse.status).toBe(200);
        const validCookie = checkResponse.headers['set-cookie'][0];
        // 2. Legit refresh (switches to generation 3)
        const legitResponse = await (0, supertest_1.default)(app_1.app)
            .get('/api/v1/auth/refresh')
            .set('Cookie', [validCookie]);
        expect(legitResponse.status).toBe(200);
        // 3. ATTACK: Re-use generation 2 cookie
        const attackResponse = await (0, supertest_1.default)(app_1.app)
            .get('/api/v1/auth/refresh')
            .set('Cookie', [validCookie]);
        // Should fail
        expect(attackResponse.status).not.toBe(200);
        // 4. Legit user tries to use generation 3 cookie (should now be invalid due to family wipe)
        const nextGenCookie = legitResponse.headers['set-cookie'][0];
        const victimResponse = await (0, supertest_1.default)(app_1.app)
            .get('/api/v1/auth/refresh')
            .set('Cookie', [nextGenCookie]);
        // Should fail
        expect(victimResponse.status).not.toBe(200);
    });
    it('should logout correctly', async () => {
        await (0, supertest_1.default)(app_1.app).post('/api/v1/auth/register').send({
            name: 'Cookie Monster 2',
            email: 'cookie2@test.com',
            password: 'AIGestion2026!',
        });
        const loginResponse = await (0, supertest_1.default)(app_1.app).post('/api/v1/auth/login').send({
            email: 'cookie2@test.com',
            password: 'AIGestion2026!',
        });
        const cookie = loginResponse.headers['set-cookie'][0];
        const logoutResponse = await (0, supertest_1.default)(app_1.app).post('/api/v1/auth/logout').set('Cookie', [cookie]);
        expect(logoutResponse.status).toBe(200);
        const setCookie = logoutResponse.headers['set-cookie'][0];
        expect(setCookie).toMatch(/Max-Age=0|Expires=Thu, 01 Jan 1970/);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxfX3Rlc3RzX19cXGZlYXR1cmVzXFxhdXRoXFxyZWZyZXNoLXRva2VuLnRlc3QudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSwwREFBZ0M7QUFDaEMsc0NBQW1DO0FBQ25DLCtDQUE0QztBQUc1QyxNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsS0FBSyxNQUFNLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFxQixDQUFDO0FBRTVGLDREQUE0RDtBQUM1RCxNQUFNLFNBQVMsR0FBVSxFQUFFLENBQUM7QUFFNUIsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLHdCQUF3QixFQUFFLEdBQUcsRUFBRTtJQUN4RSxJQUFJLFVBQWtCLENBQUM7SUFFdkIsU0FBUyxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ25CLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDdkIsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3JCLGFBQWE7UUFDYixNQUFNLFdBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDNUIsQ0FBQyxDQUFDLENBQUM7SUFFSCxFQUFFLENBQUMscUNBQXFDLEVBQUUsS0FBSyxJQUFJLEVBQUU7UUFDbkQsTUFBTSxJQUFBLG1CQUFPLEVBQUMsU0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLENBQUMsSUFBSSxDQUFDO1lBQ3BELElBQUksRUFBRSxnQkFBZ0I7WUFDdEIsS0FBSyxFQUFFLGlCQUFpQjtZQUN4QixRQUFRLEVBQUUsZUFBZTtTQUMxQixDQUFDLENBQUM7UUFFSCxNQUFNLFFBQVEsR0FBRyxNQUFNLElBQUEsbUJBQU8sRUFBQyxTQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxJQUFJLENBQUM7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QUFTLENBQUMsQ0FBQyxPQUFPLENBQUMsb0NBQW9DLENBQUMsQ0FBQztJQUNsRSxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcQWxlamFuZHJvXFxBSUdlc3Rpb25cXGJhY2tlbmRcXHNyY1xcX190ZXN0c19fXFxmZWF0dXJlc1xcYXV0aFxccmVmcmVzaC10b2tlbi50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCByZXF1ZXN0IGZyb20gJ3N1cGVydGVzdCc7XG5pbXBvcnQgeyBhcHAgfSBmcm9tICcuLi8uLi8uLi9hcHAnO1xuaW1wb3J0IHsgVXNlciB9IGZyb20gJy4uLy4uLy4uL21vZGVscy9Vc2VyJztcbmltcG9ydCBtb25nb29zZSBmcm9tICdtb25nb29zZSc7XG5cbmNvbnN0IFNLSVBfREJfVEVTVFMgPSBwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ3Rlc3QnICYmICFwcm9jZXNzLmVudi5SVU5fSU5URUdSQVRJT05fVEVTVFM7XG5cbi8vIFZhcmlhYmxlcyBwcmVmaXhlZCB3aXRoICdtb2NrJyBhcmUgYXZhaWxhYmxlIGluIGplc3QubW9ja1xuY29uc3QgbW9ja1VzZXJzOiBhbnlbXSA9IFtdO1xuXG4oU0tJUF9EQl9URVNUUyA/IGRlc2NyaWJlLnNraXAgOiBkZXNjcmliZSkoJ1JlZnJlc2ggVG9rZW4gUm90YXRpb24nLCAoKSA9PiB7XG4gIGxldCBhdXRoQ29va2llOiBzdHJpbmc7XG5cbiAgYmVmb3JlQWxsKGFzeW5jICgpID0+IHtcbiAgICBqZXN0LnNldFRpbWVvdXQoMzAwMDApO1xuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBhd2FpdCBVc2VyLmRlbGV0ZU1hbnkoe30pO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIHNldCBodHRwT25seSBjb29raWUgb24gbG9naW4nLCBhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgcmVxdWVzdChhcHApLnBvc3QoJy9hcGkvdjEvYXV0aC9yZWdpc3RlcicpLnNlbmQoe1xuICAgICAgbmFtZTogJ0Nvb2tpZSBNb25zdGVyJyxcbiAgICAgIGVtYWlsOiAnY29va2llQHRlc3QuY29tJyxcbiAgICAgIHBhc3N3b3JkOiAnQUlHZXN0aW9uMTIzIScsXG4gICAgfSk7XG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKS5wb3N0KCcvYXBpL3YxL2F1dGgvbG9naW4nKS5zZW5kKHtcbiAgICAgIGVtYWlsOiAnY29va2llQHRlc3QuY29tJyxcbiAgICAgIHBhc3N3b3JkOiAnQUlHZXN0aW9uMTIzIScsXG4gICAgfSk7XG5cbiAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzKS50b0JlKDIwMCk7XG4gICAgY29uc3QgY29va2llcyA9IHJlc3BvbnNlLmhlYWRlcnNbJ3NldC1jb29raWUnXTtcbiAgICBhdXRoQ29va2llID0gY29va2llcy5maW5kKChjOiBzdHJpbmcpID0+IGMuc3RhcnRzV2l0aCgncmVmcmVzaF90b2tlbicpKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCByb3RhdGUgdG9rZW4gb24gcmVmcmVzaCcsIGFzeW5jICgpID0+IHtcbiAgICBhd2FpdCBuZXcgUHJvbWlzZShyID0+IHNldFRpbWVvdXQociwgMTApKTtcblxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApLmdldCgnL2FwaS92MS9hdXRoL3JlZnJlc2gnKS5zZXQoJ0Nvb2tpZScsIFthdXRoQ29va2llXSk7XG5cbiAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzKS50b0JlKDIwMCk7XG4gICAgY29uc3QgbmV3Q29va2llcyA9IHJlc3BvbnNlLmhlYWRlcnNbJ3NldC1jb29raWUnXTtcbiAgICBjb25zdCBuZXdBdXRoQ29va2llID0gbmV3Q29va2llcy5maW5kKChjOiBzdHJpbmcpID0+IGMuc3RhcnRzV2l0aCgncmVmcmVzaF90b2tlbicpKTtcblxuICAgIGV4cGVjdChuZXdBdXRoQ29va2llKS5ub3QudG9FcXVhbChhdXRoQ29va2llKTtcbiAgICBhdXRoQ29va2llID0gbmV3QXV0aENvb2tpZTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBkZXRlY3QgcmV1c2UgYW5kIGludmFsaWRhdGUgZmFtaWx5JywgYXN5bmMgKCkgPT4ge1xuICAgIC8vIDEuIEdldCBjdXJyZW50IHZhbGlkIGNvb2tpZSAoRmFtaWx5IEEsIGdlbmVyYXRpb24gMilcbiAgICBjb25zdCBjaGVja1Jlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAuZ2V0KCcvYXBpL3YxL2F1dGgvcmVmcmVzaCcpXG4gICAgICAuc2V0KCdDb29raWUnLCBbYXV0aENvb2tpZV0pO1xuICAgIGV4cGVjdChjaGVja1Jlc3BvbnNlLnN0YXR1cykudG9CZSgyMDApO1xuICAgIGNvbnN0IHZhbGlkQ29va2llID0gY2hlY2tSZXNwb25zZS5oZWFkZXJzWydzZXQtY29va2llJ11bMF07XG5cbiAgICAvLyAyLiBMZWdpdCByZWZyZXNoIChzd2l0Y2hlcyB0byBnZW5lcmF0aW9uIDMpXG4gICAgY29uc3QgbGVnaXRSZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgLmdldCgnL2FwaS92MS9hdXRoL3JlZnJlc2gnKVxuICAgICAgLnNldCgnQ29va2llJywgW3ZhbGlkQ29va2llXSk7XG4gICAgZXhwZWN0KGxlZ2l0UmVzcG9uc2Uuc3RhdHVzKS50b0JlKDIwMCk7XG5cbiAgICAvLyAzLiBBVFRBQ0s6IFJlLXVzZSBnZW5lcmF0aW9uIDIgY29va2llXG4gICAgY29uc3QgYXR0YWNrUmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgIC5nZXQoJy9hcGkvdjEvYXV0aC9yZWZyZXNoJylcbiAgICAgIC5zZXQoJ0Nvb2tpZScsIFt2YWxpZENvb2tpZV0pO1xuXG4gICAgLy8gU2hvdWxkIGZhaWxcbiAgICBleHBlY3QoYXR0YWNrUmVzcG9uc2Uuc3RhdHVzKS5ub3QudG9CZSgyMDApO1xuXG4gICAgLy8gNC4gTGVnaXQgdXNlciB0cmllcyB0byB1c2UgZ2VuZXJhdGlvbiAzIGNvb2tpZSAoc2hvdWxkIG5vdyBiZSBpbnZhbGlkIGR1ZSB0byBmYW1pbHkgd2lwZSlcbiAgICBjb25zdCBuZXh0R2VuQ29va2llID0gbGVnaXRSZXNwb25zZS5oZWFkZXJzWydzZXQtY29va2llJ11bMF07XG4gICAgY29uc3QgdmljdGltUmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgIC5nZXQoJy9hcGkvdjEvYXV0aC9yZWZyZXNoJylcbiAgICAgIC5zZXQoJ0Nvb2tpZScsIFtuZXh0R2VuQ29va2llXSk7XG5cbiAgICAvLyBTaG91bGQgZmFpbFxuICAgIGV4cGVjdCh2aWN0aW1SZXNwb25zZS5zdGF0dXMpLm5vdC50b0JlKDIwMCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgbG9nb3V0IGNvcnJlY3RseScsIGFzeW5jICgpID0+IHtcbiAgICBhd2FpdCByZXF1ZXN0KGFwcCkucG9zdCgnL2FwaS92MS9hdXRoL3JlZ2lzdGVyJykuc2VuZCh7XG4gICAgICBuYW1lOiAnQ29va2llIE1vbnN0ZXIgMicsXG4gICAgICBlbWFpbDogJ2Nvb2tpZTJAdGVzdC5jb20nLFxuICAgICAgcGFzc3dvcmQ6ICdBSUdlc3Rpb24yMDI2IScsXG4gICAgfSk7XG5cbiAgICBjb25zdCBsb2dpblJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApLnBvc3QoJy9hcGkvdjEvYXV0aC9sb2dpbicpLnNlbmQoe1xuICAgICAgZW1haWw6ICdjb29raWUyQHRlc3QuY29tJyxcbiAgICAgIHBhc3N3b3JkOiAnQUlHZXN0aW9uMjAyNiEnLFxuICAgIH0pO1xuICAgIGNvbnN0IGNvb2tpZSA9IGxvZ2luUmVzcG9uc2UuaGVhZGVyc1snc2V0LWNvb2tpZSddWzBdO1xuXG4gICAgY29uc3QgbG9nb3V0UmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcCkucG9zdCgnL2FwaS92MS9hdXRoL2xvZ291dCcpLnNldCgnQ29va2llJywgW2Nvb2tpZV0pO1xuXG4gICAgZXhwZWN0KGxvZ291dFJlc3BvbnNlLnN0YXR1cykudG9CZSgyMDApO1xuICAgIGNvbnN0IHNldENvb2tpZSA9IGxvZ291dFJlc3BvbnNlLmhlYWRlcnNbJ3NldC1jb29raWUnXVswXTtcbiAgICBleHBlY3Qoc2V0Q29va2llKS50b01hdGNoKC9NYXgtQWdlPTB8RXhwaXJlcz1UaHUsIDAxIEphbiAxOTcwLyk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=