{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\__tests__\\features\\auth\\refresh-token.test.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\__tests__\\features\\auth\\refresh-token.test.ts"],"sourcesContent":["import request from 'supertest';\nimport { app } from '../../../app';\nimport { User } from '../../../models/User';\nimport mongoose from 'mongoose';\n\nconst SKIP_DB_TESTS = process.env.NODE_ENV === 'test' && !process.env.RUN_INTEGRATION_TESTS;\n\n// Variables prefixed with 'mock' are available in jest.mock\nconst mockUsers: any[] = [];\n\n(SKIP_DB_TESTS ? describe.skip : describe)('Refresh Token Rotation', () => {\n  let authCookie: string;\n\n  beforeAll(async () => {\n    jest.setTimeout(30000);\n    jest.clearAllMocks();\n    // @ts-ignore\n    await User.deleteMany({});\n  });\n\n  it('should set httpOnly cookie on login', async () => {\n    await request(app).post('/api/v1/auth/register').send({\n      name: 'Cookie Monster',\n      email: 'cookie@test.com',\n      password: 'AIGestion123!',\n    });\n\n    const response = await request(app).post('/api/v1/auth/login').send({\n      email: 'cookie@test.com',\n      password: 'AIGestion123!',\n    });\n\n    expect(response.status).toBe(200);\n    const cookies = response.headers['set-cookie'];\n    authCookie = cookies.find((c: string) => c.startsWith('refresh_token'));\n  });\n\n  it('should rotate token on refresh', async () => {\n    await new Promise(r => setTimeout(r, 10));\n\n    const response = await request(app).get('/api/v1/auth/refresh').set('Cookie', [authCookie]);\n\n    expect(response.status).toBe(200);\n    const newCookies = response.headers['set-cookie'];\n    const newAuthCookie = newCookies.find((c: string) => c.startsWith('refresh_token'));\n\n    expect(newAuthCookie).not.toEqual(authCookie);\n    authCookie = newAuthCookie;\n  });\n\n  it('should detect reuse and invalidate family', async () => {\n    // 1. Get current valid cookie (Family A, generation 2)\n    const checkResponse = await request(app)\n      .get('/api/v1/auth/refresh')\n      .set('Cookie', [authCookie]);\n    expect(checkResponse.status).toBe(200);\n    const validCookie = checkResponse.headers['set-cookie'][0];\n\n    // 2. Legit refresh (switches to generation 3)\n    const legitResponse = await request(app)\n      .get('/api/v1/auth/refresh')\n      .set('Cookie', [validCookie]);\n    expect(legitResponse.status).toBe(200);\n\n    // 3. ATTACK: Re-use generation 2 cookie\n    const attackResponse = await request(app)\n      .get('/api/v1/auth/refresh')\n      .set('Cookie', [validCookie]);\n\n    // Should fail\n    expect(attackResponse.status).not.toBe(200);\n\n    // 4. Legit user tries to use generation 3 cookie (should now be invalid due to family wipe)\n    const nextGenCookie = legitResponse.headers['set-cookie'][0];\n    const victimResponse = await request(app)\n      .get('/api/v1/auth/refresh')\n      .set('Cookie', [nextGenCookie]);\n\n    // Should fail\n    expect(victimResponse.status).not.toBe(200);\n  });\n\n  it('should logout correctly', async () => {\n    await request(app).post('/api/v1/auth/register').send({\n      name: 'Cookie Monster 2',\n      email: 'cookie2@test.com',\n      password: 'AIGestion2026!',\n    });\n\n    const loginResponse = await request(app).post('/api/v1/auth/login').send({\n      email: 'cookie2@test.com',\n      password: 'AIGestion2026!',\n    });\n    const cookie = loginResponse.headers['set-cookie'][0];\n\n    const logoutResponse = await request(app).post('/api/v1/auth/logout').set('Cookie', [cookie]);\n\n    expect(logoutResponse.status).toBe(200);\n    const setCookie = logoutResponse.headers['set-cookie'][0];\n    expect(setCookie).toMatch(/Max-Age=0|Expires=Thu, 01 Jan 1970/);\n  });\n});\n"],"version":3}