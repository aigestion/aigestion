{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\ai.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\ai.service.ts"],"sourcesContent":["import { inject, injectable } from 'inversify';\nimport { Readable } from 'stream';\n\nimport { env } from '../config/env.schema';\nimport { CircuitBreakerFactory } from '../infrastructure/resilience/CircuitBreakerFactory';\nimport { StripeTool } from '../tools/stripe.tool';\nimport { SearchWebTool } from '../tools/web-search.tool';\nimport { TYPES } from '../types';\nimport { logger } from '../utils/logger';\nimport { AIModelRouter, AIModelTier, ModelConfig } from '../utils/aiRouter';\nimport { AnalyticsService } from './analytics.service';\nimport { RagService } from './rag.service';\nimport { SemanticCacheService } from './semantic-cache.service';\nimport { UsageService } from './usage.service';\n// Types for function declarations and schema types are loosely typed as any to avoid TS2709 errors\ntype FunctionDeclaration = any;\n\nexport interface AIStreamParams {\n  prompt: string;\n  history?: { role: 'user' | 'assistant' | 'system'; content: string }[];\n  userId: string;\n  userRole?: string;\n}\n\n@injectable()\nexport class AIService {\n  private _model: any;\n\n  private generateContentBreaker: any;\n  private chatStreamBreaker: any;\n\n  constructor(\n    @inject(TYPES.AnalyticsService) private analyticsService: AnalyticsService,\n    @inject(TYPES.RagService) private ragService: RagService,\n    @inject(TYPES.UsageService) private usageService: UsageService,\n    @inject(TYPES.SemanticCacheService) private semanticCache: SemanticCacheService,\n  ) {\n    // Breakers initialized with async lambdas that will call getModel() on execution\n    this.generateContentBreaker = CircuitBreakerFactory.create(\n      async (prompt: string) => {\n        const model = await this.getModel();\n        return model.generateContent(prompt);\n      },\n      { name: 'Gemini.generateContent', timeout: 10000 }, // Higher timeout for AI\n    );\n\n    this.chatStreamBreaker = CircuitBreakerFactory.create(\n      async (prompt: string, chatSession: any) => chatSession.sendMessageStream(prompt),\n      { name: 'Gemini.sendMessageStream', timeout: 10000 },\n    );\n  }\n\n  private async getProviderModel(config: ModelConfig) {\n    if (config.provider === 'gemini') {\n      const { GoogleGenerativeAI } = await import('@google/generative-ai');\n      const genAI = new GoogleGenerativeAI(env.GEMINI_API_KEY || '');\n      return genAI.getGenerativeModel({ model: config.modelId });\n    }\n    throw new Error(`Unsupported provider: ${config.provider}`);\n  }\n\n  private async getModel() {\n    if (!this._model) {\n      const config = AIModelRouter.getModelConfig(AIModelTier.STANDARD);\n      this._model = await this.getProviderModel(config);\n    }\n    return this._model;\n  }\n\n  private getTools(): FunctionDeclaration[] {\n    return [\n      {\n        name: 'get_revenue_analytics',\n        description: 'Get monthly revenue data for the dashboard.',\n        parameters: {\n          type: 'object',\n          properties: {},\n        },\n      },\n      {\n        name: 'get_user_growth',\n        description: 'Get user growth trends for the last 14 days.',\n        parameters: {\n          type: 'object',\n          properties: {},\n        },\n      },\n      {\n        name: 'search_web',\n        description: 'Search the web for real-time information, news, or technical documentation.',\n        parameters: {\n          type: 'object' as any,\n          properties: {\n            query: { type: 'string', description: 'The search query.' },\n          },\n          required: ['query'],\n        },\n      },\n      {\n        name: 'get_codebase_context',\n        description:\n          'Read the codebase to understand the project architecture, files, or specific implementation details. Use this when asked about the \"project\", \"code\", \"architecture\", or \"how something works\" in this app.',\n        parameters: {\n          type: 'object',\n          properties: {\n            query: {\n              type: 'string',\n              description:\n                'Optional focus or query to filter the context (currently returns full context)',\n            },\n          },\n        },\n      },\n      {\n        name: 'manage_subscription',\n        description:\n          'Manage user subscriptions, check status, or generate checkout/portal links. Use this tool when the user asks about their billing, subscription, or upgrading plan.',\n        parameters: {\n          type: 'object',\n          properties: {\n            action: {\n              type: 'string',\n              enum: ['get_status', 'create_checkout', 'create_portal'],\n              description: 'The action to perform.',\n            },\n            userId: { type: 'string', description: 'The ID of the user context (implicit).' },\n            priceId: {\n              type: 'string',\n              description:\n                'The Stripe Price ID for checkout (required if action is create_checkout).',\n            },\n          },\n          required: ['action'],\n        },\n      },\n    ];\n  }\n\n  public async streamChat(params: AIStreamParams): Promise<Readable> {\n    const stream = new Readable({ read() {} });\n\n    // Map roles for history\n    const history = (params.history || []).map(msg => ({\n      role: msg.role === 'assistant' ? 'model' : 'user',\n      content: msg.content,\n      parts: [{ text: msg.content }], // For Gemini\n    }));\n\n    // God Mode: Force PREMIUM tier for admin/god\n    const tier =\n      params.userRole === 'god' || params.userRole === 'admin'\n        ? AIModelTier.PREMIUM\n        : AIModelRouter.route(params.prompt);\n\n    const config = AIModelRouter.getModelConfig(tier);\n\n    const runner = async () => {\n      let fullResponse = '';\n      try {\n        // Default / Gemini implementation\n        const modelTier = AIModelRouter.getModelConfig(AIModelTier.STANDARD);\n        const model = await this.getProviderModel(modelTier);\n\n        const systemInstruction = `You are Nexus AI, an advanced agent.\n                When asked about revenue or users, use the provided tools.\n                Current User ID: ${params.userId}.\n                Use the 'search_web' tool for current info.`;\n\n        const chat = model.startChat({\n          history: history.map(h => ({ role: h.role, parts: h.parts })),\n          generationConfig: { maxOutputTokens: 2048 },\n          systemInstruction: { parts: [{ text: systemInstruction }] },\n          tools: [{ functionDeclarations: this.getTools() }],\n        });\n\n        const result = await this.chatStreamBreaker.fire(params.prompt, chat);\n\n        for await (const chunk of result.stream) {\n          const chunkText = chunk.text();\n          if (chunkText) {\n            fullResponse += chunkText;\n            stream.push(`data: ${JSON.stringify({ type: 'text', content: chunkText })}\\n\\n`);\n          }\n\n          // Tool calls handling (Gemini specific for now)\n          const functionCalls = chunk.functionCalls();\n          if (functionCalls && functionCalls.length > 0) {\n            for (const call of functionCalls) {\n              await this.handleToolCall(\n                call,\n                stream,\n                params,\n                this.ragService,\n                this.analyticsService,\n              );\n            }\n          }\n        }\n\n        stream.push('data: [DONE]\\n\\n');\n        stream.push(null);\n\n        // Track usage (Simplified for stream)\n        this.usageService.trackUsage({\n          userId: params.userId,\n          provider: 'gemini',\n          modelId: modelTier.modelId,\n          prompt: params.prompt,\n          completion: fullResponse || 'Streamed response',\n        });\n      } catch (error) {\n        logger.error(error, '[AIService] Error in streamChat');\n        stream.emit('error', error);\n        stream.push(null);\n      }\n    };\n\n    runner();\n    return stream;\n  }\n\n  /**\n   * Generate content (Single-shot) with Semantic Routing\n   */\n  public async generateContent(\n    prompt: string,\n    userId: string = 'anonymous',\n    userRole: string = 'user',\n  ): Promise<string> {\n    try {\n      // God Mode: Force PREMIUM tier for admin/god\n      const tier =\n        userRole === 'god' || userRole === 'admin'\n          ? AIModelTier.PREMIUM\n          : AIModelRouter.route(prompt);\n\n      // [GOD MODE] Semantic Cache Check\n      const cached = await this.semanticCache.getSemantic(prompt);\n      if (cached) {\n        logger.info(`[AIService] Semantic Cache Hit for: \"${prompt.substring(0, 30)}...\"`);\n        return cached;\n      }\n\n      const config = AIModelRouter.getModelConfig(tier);\n\n      logger.info(`[AIService] Routing to Tier: ${tier} (${config.provider}/${config.modelId})`);\n\n      if (config.provider === 'gemini') {\n        const model = await this.getProviderModel(config);\n        const result = await model.generateContent(prompt);\n        const text = result.response.text();\n\n        // Track usage\n        this.usageService.trackUsage({\n          userId,\n          provider: 'gemini',\n          modelId: config.modelId,\n          prompt: prompt,\n          completion: text,\n        });\n\n        await this.semanticCache.setSemantic(prompt, text);\n\n        return text;\n      }\n\n      return 'Error: Unsupported provider in router.';\n    } catch (error) {\n      logger.error(error, '[AIService] Error in generateContent');\n      return 'Error generating content.';\n    }\n  }\n\n  /**\n   * Chat (Non-streaming)\n   */\n  public async chat(history: any[], message: string): Promise<string> {\n    try {\n      const model = await this.getModel();\n      const chat = model.startChat({\n        history: history.map(msg => ({\n          role: msg.role === 'assistant' ? 'model' : 'user',\n          parts: [{ text: msg.content }],\n        })),\n      });\n      const result = await chat.sendMessage(message);\n      return result.response.text();\n    } catch (error) {\n      logger.error(error, '[AIService] Error in chat');\n      return 'Error in chat processing.';\n    }\n  }\n\n  private async handleToolCall(\n    call: any,\n    stream: Readable,\n    params: AIStreamParams,\n    ragService: RagService,\n    analyticsService: AnalyticsService,\n  ) {\n    const name = call.name;\n    const args = call.args;\n\n    logger.info(`[AIService] Tool Call: ${name}`, args);\n\n    let toolResult = '';\n    if (name === 'get_revenue_analytics') {\n      const data = await analyticsService.getDashboardData();\n      toolResult = JSON.stringify(data.revenue);\n      stream.push(\n        `data: ${JSON.stringify({\n          type: 'a2ui',\n          component: 'chart',\n          props: { title: 'Revenue Overview', type: 'area', data: data.revenue },\n        })}\\n\\n`,\n      );\n    } else if (name === 'get_user_growth') {\n      const data = await analyticsService.getDashboardData();\n      toolResult = JSON.stringify(data.users);\n      stream.push(\n        `data: ${JSON.stringify({\n          type: 'a2ui',\n          component: 'chart',\n          props: { title: 'User Growth', type: 'bar', data: data.users },\n        })}\\n\\n`,\n      );\n    } else if (name === 'search_web') {\n      const query = args.query;\n      stream.push(\n        `data: ${JSON.stringify({\n          type: 'text',\n          content: `\\n\\nSearching web for: \"${query}\"...\\n\\n`,\n        })}\\n\\n`,\n      );\n      const searchTool = new SearchWebTool();\n      const results = await searchTool.execute({ query });\n      toolResult = JSON.stringify(results);\n    } else if (name === 'get_codebase_context') {\n      stream.push(\n        `data: ${JSON.stringify({\n          type: 'text',\n          content: `\\n\\nReading codebase context for: \"${args.query}\"...\\n\\n`,\n        })}\\n\\n`,\n      );\n      const context = await ragService.getProjectContext(args.query);\n      toolResult = context;\n    } else if (name === 'manage_subscription') {\n      stream.push(\n        `data: ${JSON.stringify({\n          type: 'text',\n          content: `\\n\\nAccessing subscription data...\\n\\n`,\n        })}\\n\\n`,\n      );\n      const stripeTool = new StripeTool();\n      const toolInput = { ...args, userId: params.userId };\n      const result = await stripeTool.execute(toolInput);\n      toolResult = JSON.stringify(result);\n    }\n\n    stream.push(`data: ${JSON.stringify({ type: 'text', content: toolResult })}\\n\\n`);\n  }\n}\n"],"version":3}