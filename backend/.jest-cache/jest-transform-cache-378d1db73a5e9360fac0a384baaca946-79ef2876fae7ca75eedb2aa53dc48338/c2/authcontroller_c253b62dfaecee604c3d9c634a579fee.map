{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\controllers\\auth.controller.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\controllers\\auth.controller.ts"],"sourcesContent":["import bcrypt from 'bcryptjs';\nimport type { NextFunction, Request, Response } from 'express';\nimport jwt from 'jsonwebtoken';\n\nimport { buildResponse } from '../common/response-builder';\nimport { config } from '../config';\nimport { container } from '../config/inversify.config';\nimport { User } from '../models/User';\nimport { AuthService } from '../services/auth.service';\nimport { Enable2FAUseCase } from '../application/usecases/Enable2FAUseCase';\nimport { Verify2FAUseCase } from '../application/usecases/Verify2FAUseCase';\nimport { TYPES } from '../types';\nimport { AppError } from '../utils/errors';\nimport { validate, schemas } from '../middleware/validation.middleware';\n\n// Helper to set refresh token cookie\nconst setRefreshTokenCookie = (res: Response, token: string) => {\n  res.cookie('refresh_token', token, {\n    httpOnly: true,\n    secure: config.nodeEnv === 'production',\n    sameSite: 'strict',\n    maxAge: 7 * 24 * 60 * 60 * 1000, // 7 days\n  });\n};\n\nexport const register = async (req: Request, res: Response, next: NextFunction): Promise<void> => {\n  try {\n    const authService = container.get<AuthService>(TYPES.AuthService);\n    const { user, token, refreshToken } = await authService.register(req.body);\n\n    // No devolver la contraseña en la respuesta\n    const userResponse: any = user.toObject();\n    delete userResponse.password;\n    delete userResponse.refreshTokens; // Don't send DB array to client\n\n    setRefreshTokenCookie(res, refreshToken);\n\n    res.status(201).json(buildResponse({ user: userResponse, token }, 201, (req as any).requestId));\n  } catch (error) {\n    next(error);\n  }\n};\n\nexport const login = async (req: Request, res: Response, next: NextFunction): Promise<void> => {\n  try {\n    const authService = container.get<AuthService>(TYPES.AuthService);\n    const { email, password } = req.body;\n    const ip = req.ip;\n    const userAgent = req.headers['user-agent'];\n\n    const { user, token, refreshToken, mfaRequired } = await authService.login({\n      email,\n      password,\n      ip,\n      userAgent,\n    });\n\n    if (mfaRequired) {\n      res.status(200).json(\n        buildResponse(\n          {\n            mfaRequired: true,\n            userId: user._id,\n          },\n          200,\n          (req as any).requestId,\n        ),\n      );\n      return;\n    }\n\n    // Ensure we have tokens before setting cookie (typescript guard)\n    if (refreshToken && token) {\n      const userResponse: any = user.toObject();\n      delete userResponse.password;\n      delete userResponse.refreshTokens;\n\n      setRefreshTokenCookie(res, refreshToken);\n\n      res\n        .status(200)\n        .json(buildResponse({ user: userResponse, token }, 200, (req as any).requestId));\n    } else {\n      throw new AppError('Login failed to generate tokens', 500, 'INTERNAL_ERROR');\n    }\n  } catch (error) {\n    next(error);\n  }\n};\n\nexport const refresh = async (req: Request, res: Response, next: NextFunction): Promise<void> => {\n  try {\n    const refreshToken = req.cookies['refresh_token'];\n    if (!refreshToken) {\n      throw new AppError('Refresh Token Required', 401, 'REFRESH_TOKEN_REQUIRED');\n    }\n\n    const authService = container.get<AuthService>(TYPES.AuthService);\n    const ip = req.ip || 'unknown';\n    const userAgent = req.headers['user-agent'] || 'unknown';\n\n    const {\n      user,\n      accessToken,\n      refreshToken: newRefreshToken,\n    } = await authService.refreshToken(refreshToken, ip, userAgent);\n\n    setRefreshTokenCookie(res, newRefreshToken);\n\n    res.status(200).json(buildResponse({ accessToken }, 200, (req as any).requestId));\n  } catch (error) {\n    // If refresh fails (security reuse, expired), clear cookie\n    res.clearCookie('refresh_token');\n    next(error);\n  }\n};\n\nexport const logout = async (req: Request, res: Response, next: NextFunction): Promise<void> => {\n  try {\n    const refreshToken = req.cookies['refresh_token'];\n    if (refreshToken) {\n      // @ts-ignore\n      const authService = container.get<AuthService>(TYPES.AuthService);\n      await authService.logout(refreshToken);\n    }\n\n    res.clearCookie('refresh_token');\n    res\n      .status(200)\n      .json(buildResponse({ message: 'Logged out successfully' }, 200, (req as any).requestId));\n  } catch (error) {\n    next(error);\n  }\n};\n\nexport const getMe = async (req: Request, res: Response, next: NextFunction): Promise<void> => {\n  try {\n    if (!req.user) {\n      return next(new AppError('Usuario no autenticado', 401, 'UNAUTHORIZED'));\n    }\n    const authService = container.get<AuthService>(TYPES.AuthService);\n    const user = await authService.getUserProfile(req.user.id);\n\n    if (!user) {\n      return next(new AppError('Usuario no encontrado', 404, 'NOT_FOUND'));\n    }\n\n    res.status(200).json(buildResponse(user, 200, (req as any).requestId));\n  } catch (error) {\n    next(error);\n  }\n};\n\n// Enable 2FA\nexport const enable2FA = [\n  validate({ body: schemas.auth.enable2FA }),\n  async (req: Request, res: Response, next: NextFunction): Promise<void> => {\n    try {\n      const enable2FAUseCase = container.get<Enable2FAUseCase>(TYPES.Enable2FAUseCase);\n      const { userId } = req.body;\n      const result = await enable2FAUseCase.execute(userId);\n      res.status(200).json(buildResponse(result, 200, (req as any).requestId));\n    } catch (error) {\n      next(error);\n    }\n  },\n];\n\n// Verify 2FA token\nexport const verify2FA = [\n  validate({ body: schemas.auth.verify2FA }),\n  async (req: Request, res: Response, next: NextFunction): Promise<void> => {\n    try {\n      const verify2FAUseCase = container.get<Verify2FAUseCase>(TYPES.Verify2FAUseCase);\n      const { userId, token } = req.body;\n      await verify2FAUseCase.execute(userId, token);\n      res.status(200).json(buildResponse({ success: true }, 200, (req as any).requestId));\n    } catch (error) {\n      next(error);\n    }\n  },\n];\n\n// Verify Login 2FA (Step 2 of Login)\nexport const verifyLogin2FA = async (\n  req: Request,\n  res: Response,\n  next: NextFunction,\n): Promise<void> => {\n  try {\n    const authService = container.get<AuthService>(TYPES.AuthService);\n    const { userId, token } = req.body;\n    const ip = req.ip;\n    const userAgent = req.headers['user-agent'];\n\n    const {\n      user,\n      token: accessToken,\n      refreshToken,\n    } = await authService.verifyLogin2FA({\n      userId,\n      token,\n      ip,\n      userAgent,\n    });\n\n    const userResponse: any = user.toObject();\n    delete userResponse.password;\n    delete userResponse.refreshTokens;\n\n    setRefreshTokenCookie(res, refreshToken);\n\n    res\n      .status(200)\n      .json(buildResponse({ user: userResponse, token: accessToken }, 200, (req as any).requestId));\n  } catch (error) {\n    next(error);\n  }\n};\n\n// Verify Email Code\nexport const verifyEmail = async (req: Request, res: Response, next: NextFunction): Promise<void> => {\n  try {\n    const authService = container.get<AuthService>(TYPES.AuthService);\n    const { userId, code } = req.body;\n    await authService.verifyEmail(userId, code);\n    res.status(200).json(buildResponse({ success: true, message: 'Email verificado correctamente' }, 200, (req as any).requestId));\n  } catch (error) {\n    next(error);\n  }\n};\n\n// Update User Role\nexport const updateUserRole = async (req: Request, res: Response, next: NextFunction): Promise<void> => {\n  try {\n    const authService = container.get<AuthService>(TYPES.AuthService);\n    const { userId, role } = req.body;\n    // Validate role is 'family' or 'professional' ??\n    // Ideally validate via middleware schema, but here for safety:\n    if (!['family', 'professional'].includes(role)) {\n        throw new AppError('Rol inválido. Debe ser \"family\" o \"professional\"', 400, 'INVALID_ROLE');\n    }\n\n    const user = await authService.updateUserRole(userId, role);\n    res.status(200).json(buildResponse({ success: true, user }, 200, (req as any).requestId));\n  } catch (error) {\n    next(error);\n  }\n};\n\n// Update Subscription Plan\nexport const updateSubscription = async (req: Request, res: Response, next: NextFunction): Promise<void> => {\n  try {\n    const authService = container.get<AuthService>(TYPES.AuthService);\n    const { userId, plan } = req.body;\n\n    const user = await authService.updateSubscription(userId, plan);\n    res.status(200).json(buildResponse({ success: true, user }, 200, (req as any).requestId));\n  } catch (error) {\n    next(error);\n  }\n};\n"],"version":3}