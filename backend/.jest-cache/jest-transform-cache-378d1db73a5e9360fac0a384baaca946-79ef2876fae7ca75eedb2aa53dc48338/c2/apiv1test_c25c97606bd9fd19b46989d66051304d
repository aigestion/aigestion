ffaa7e682f6318145fac3cdb5b95a09c
"use strict";
/**
 * Sprint 1: Task 1.1 - REST API Refactoring Tests
 *
 * Standardized for God Mode Phase 5
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const supertest_1 = __importDefault(require("supertest"));
const app_1 = require("../app");
const User_1 = require("../models/User");
const SKIP_DB_TESTS = process.env.NODE_ENV === 'test' && !process.env.RUN_INTEGRATION_TESTS;
(SKIP_DB_TESTS ? describe.skip : describe)('API v1 - REST Refactoring', () => {
    let testUserId;
    beforeAll(async () => {
        // Cleanup test users to prevent 409 Conflict
        await User_1.User.deleteMany({
            email: { $in: ['api-v1-test@example.com'] },
        });
        // Create a test user for ID-based tests
        const response = await (0, supertest_1.default)(app_1.app).post('/api/v1/users').send({
            email: 'api-v1-test@example.com',
            name: 'API Test User',
            password: 'AIGestion2026!',
        });
        if (response.status === 201) {
            testUserId = response.body.id || response.body.data?.id;
        }
    });
    describe('GET /health', () => {
        it('should return standardized health response', async () => {
            const response = await (0, supertest_1.default)(app_1.app).get('/api/v1/health').expect(200);
            expect(response.body).toHaveProperty('status', 200);
            expect(response.body).toHaveProperty('data');
            expect(response.body.data).toHaveProperty('status', 'healthy');
            const requestId = response.body.requestId;
            expect(requestId).toBeDefined();
        });
    });
    describe('POST /users (create)', () => {
        it('should create user with valid input', async () => {
            const uniqueEmail = `unique-${Date.now()}@example.com`;
            const response = await (0, supertest_1.default)(app_1.app)
                .post('/api/v1/users')
                .send({
                email: uniqueEmail,
                name: 'Unique Test User',
                password: 'AIGestion123!',
            })
                .expect(201);
            expect(response.body.status).toBe(201);
            const data = response.body.data || response.body;
            expect(data.email).toBe(uniqueEmail);
        });
        it('should validate required fields', async () => {
            await (0, supertest_1.default)(app_1.app)
                .post('/api/v1/users')
                .send({
                name: 'Test User',
            })
                .expect(400);
        });
    });
    describe('User Retrieval', () => {
        it('should get user by ID', async () => {
            if (!testUserId) {
                console.warn('Skipping ID test: testUserId not created');
                return;
            }
            const response = await (0, supertest_1.default)(app_1.app).get(`/api/v1/users/${testUserId}`).expect(200);
            expect(response.body.status).toBe(200);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxfX3Rlc3RzX19cXGFwaS12MS50ZXN0LnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7OztHQUlHOzs7OztBQUVILDBEQUFnQztBQUNoQyxnQ0FBNkI7QUFDN0IseUNBQXNDO0FBRXRDLE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxLQUFLLE1BQU0sSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMscUJBQXFCLENBQUM7QUFFNUYsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLDJCQUEyQixFQUFFLEdBQUcsRUFBRTtJQUMzRSxJQUFJLFVBQWtCLENBQUM7SUFFdkIsU0FBUyxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ25CLDZDQUE2QztRQUM3QyxNQUFNLFdBQUksQ0FBQyxVQUFVLENBQUM7WUFDcEIsS0FBSyxFQUFFLEVBQUUsR0FBRyxFQUFFLENBQUMseUJBQXlCLENBQUMsRUFBRTtTQUM1QyxDQUFDLENBQUM7UUFFSCx3Q0FBd0M7UUFDeEMsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFBLG1CQUFPLEVBQUMsU0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUM3RCxLQUFLLEVBQUUseUJBQXlCO1lBQ2hDLElBQUksRUFBRSxlQUFlO1lBQ3JCLFFBQVEsRUFBRSxnQkFBZ0I7U0FDM0IsQ0FBQyxDQUFDO1FBRUgsSUFBSSxRQUFRLENBQUMsTUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFDO1lBQzVCLFVBQVUsR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUM7UUFDMUQsQ0FBQztJQUNILENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLGFBQWEsRUFBRSxHQUFHLEVBQUU7UUFD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b25cXGJhY2tlbmRcXHNyY1xcX190ZXN0c19fXFxhcGktdjEudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogU3ByaW50IDE6IFRhc2sgMS4xIC0gUkVTVCBBUEkgUmVmYWN0b3JpbmcgVGVzdHNcclxuICogXHJcbiAqIFN0YW5kYXJkaXplZCBmb3IgR29kIE1vZGUgUGhhc2UgNVxyXG4gKi9cclxuXHJcbmltcG9ydCByZXF1ZXN0IGZyb20gJ3N1cGVydGVzdCc7XHJcbmltcG9ydCB7IGFwcCB9IGZyb20gJy4uL2FwcCc7XHJcbmltcG9ydCB7IFVzZXIgfSBmcm9tICcuLi9tb2RlbHMvVXNlcic7XHJcblxyXG5jb25zdCBTS0lQX0RCX1RFU1RTID0gcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICd0ZXN0JyAmJiAhcHJvY2Vzcy5lbnYuUlVOX0lOVEVHUkFUSU9OX1RFU1RTO1xyXG5cclxuKFNLSVBfREJfVEVTVFMgPyBkZXNjcmliZS5za2lwIDogZGVzY3JpYmUpKCdBUEkgdjEgLSBSRVNUIFJlZmFjdG9yaW5nJywgKCkgPT4ge1xyXG4gIGxldCB0ZXN0VXNlcklkOiBzdHJpbmc7XHJcblxyXG4gIGJlZm9yZUFsbChhc3luYyAoKSA9PiB7XHJcbiAgICAvLyBDbGVhbnVwIHRlc3QgdXNlcnMgdG8gcHJldmVudCA0MDkgQ29uZmxpY3RcclxuICAgIGF3YWl0IFVzZXIuZGVsZXRlTWFueSh7XHJcbiAgICAgIGVtYWlsOiB7ICRpbjogWydhcGktdjEtdGVzdEBleGFtcGxlLmNvbSddIH0sXHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBDcmVhdGUgYSB0ZXN0IHVzZXIgZm9yIElELWJhc2VkIHRlc3RzXHJcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKS5wb3N0KCcvYXBpL3YxL3VzZXJzJykuc2VuZCh7XHJcbiAgICAgIGVtYWlsOiAnYXBpLXYxLXRlc3RAZXhhbXBsZS5jb20nLFxyXG4gICAgICBuYW1lOiAnQVBJIFRlc3QgVXNlcicsXHJcbiAgICAgIHBhc3N3b3JkOiAnQUlHZXN0aW9uMjAyNiEnLFxyXG4gICAgfSk7XHJcblxyXG4gICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gMjAxKSB7XHJcbiAgICAgIHRlc3RVc2VySWQgPSByZXNwb25zZS5ib2R5LmlkIHx8IHJlc3BvbnNlLmJvZHkuZGF0YT8uaWQ7XHJcbiAgICB9XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdHRVQgL2hlYWx0aCcsICgpID0+IHtcclxuICAgIGl0KCdzaG91bGQgcmV0dXJuIHN0YW5kYXJkaXplZCBoZWFsdGggcmVzcG9uc2UnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApLmdldCgnL2FwaS92MS9oZWFsdGgnKS5leHBlY3QoMjAwKTtcclxuXHJcbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5KS50b0hhdmVQcm9wZXJ0eSgnc3RhdHVzJywgMjAwKTtcclxuICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkpLnRvSGF2ZVByb3BlcnR5KCdkYXRhJyk7XHJcbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5LmRhdGEpLnRvSGF2ZVByb3BlcnR5KCdzdGF0dXMnLCAnaGVhbHRoeScpO1xyXG4gICAgICBcclxuICAgICAgY29uc3QgcmVxdWVzdElkID0gcmVzcG9uc2UuYm9keS5yZXF1ZXN0SWQ7XHJcbiAgICAgIGV4cGVjdChyZXF1ZXN0SWQpLnRvQmVEZWZpbmVkKCk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ1BPU1QgL3VzZXJzIChjcmVhdGUpJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCBjcmVhdGUgdXNlciB3aXRoIHZhbGlkIGlucHV0JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCB1bmlxdWVFbWFpbCA9IGB1bmlxdWUtJHtEYXRlLm5vdygpfUBleGFtcGxlLmNvbWA7XHJcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXHJcbiAgICAgICAgLnBvc3QoJy9hcGkvdjEvdXNlcnMnKVxyXG4gICAgICAgIC5zZW5kKHtcclxuICAgICAgICAgIGVtYWlsOiB1bmlxdWVFbWFpbCxcclxuICAgICAgICAgIG5hbWU6ICdVbmlxdWUgVGVzdCBVc2VyJyxcclxuICAgICAgICAgIHBhc3N3b3JkOiAnQUlHZXN0aW9uMTIzIScsXHJcbiAgICAgICAgfSlcclxuICAgICAgICAuZXhwZWN0KDIwMSk7XHJcblxyXG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5zdGF0dXMpLnRvQmUoMjAxKTtcclxuICAgICAgY29uc3QgZGF0YSA9IHJlc3BvbnNlLmJvZHkuZGF0YSB8fCByZXNwb25zZS5ib2R5O1xyXG4gICAgICBleHBlY3QoZGF0YS5lbWFpbCkudG9CZSh1bmlxdWVFbWFpbCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIHZhbGlkYXRlIHJlcXVpcmVkIGZpZWxkcycsIGFzeW5jICgpID0+IHtcclxuICAgICAgYXdhaXQgcmVxdWVzdChhcHApXHJcbiAgICAgICAgLnBvc3QoJy9hcGkvdjEvdXNlcnMnKVxyXG4gICAgICAgIC5zZW5kKHtcclxuICAgICAgICAgIG5hbWU6ICdUZXN0IFVzZXInLFxyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLmV4cGVjdCg0MDApO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdVc2VyIFJldHJpZXZhbCcsICgpID0+IHtcclxuICAgIGl0KCdzaG91bGQgZ2V0IHVzZXIgYnkgSUQnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGlmICghdGVzdFVzZXJJZCkge1xyXG4gICAgICAgIGNvbnNvbGUud2FybignU2tpcHBpbmcgSUQgdGVzdDogdGVzdFVzZXJJZCBub3QgY3JlYXRlZCcpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKS5nZXQoYC9hcGkvdjEvdXNlcnMvJHt0ZXN0VXNlcklkfWApLmV4cGVjdCgyMDApO1xyXG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5zdGF0dXMpLnRvQmUoMjAwKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG59KTtcclxuIl0sInZlcnNpb24iOjN9