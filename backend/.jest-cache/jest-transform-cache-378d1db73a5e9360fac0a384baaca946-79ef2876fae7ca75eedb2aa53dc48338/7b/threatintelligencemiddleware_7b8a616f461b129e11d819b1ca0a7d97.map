{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\middleware\\threat-intelligence.middleware.ts","mappings":";;;AACA,yFAAoF;AACpF,4CAAyC;AAYzC;;GAEG;AACH,MAAa,4BAA4B;IAC/B,aAAa,CAA4B;IAEjD;QACE,IAAI,CAAC,aAAa,GAAG,IAAI,uDAAyB,EAAE,CAAC;IACvD,CAAC;IAED;;OAEG;IACI,aAAa,GAAG,KAAK,EAAE,GAAkB,EAAE,GAAa,EAAE,IAAkB,EAAE,EAAE;QACrF,IAAI,CAAC;YACH,MAAM,QAAQ,GAAG,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC;YAEvC,IAAI,CAAC,QAAQ,IAAI,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,EAAE,CAAC;gBAC5C,OAAO,IAAI,EAAE,CAAC;YAChB,CAAC;YAED,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,aAAa,CAAC,cAAc,CAAC,QAAQ,CAAC,CAAC;YAEjE,IAAI,MAAM,EAAE,CAAC;gBACX,GAAG,CAAC,WAAW,GAAG,GAAG,CAAC,WAAW,IAAI,EAAE,SAAS,EAAE,CAAC,EAAE,MAAM,EAAE,OAAO,EAAE,CAAC;gBACvE,GAAG,CAAC,WAAW,CAAC,QAAQ,GAAG,MAAM,CAAC;gBAClC,GAAG,CAAC,WAAW,CAAC,SAAS,IAAI,IAAI,CAAC,oBAAoB,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;gBAExE,qCAAqC;gBACrC,IAAI,MAAM,CAAC,QAAQ,KAAK,UAAU,IAAI,MAAM,CAAC,QAAQ,KAAK,MAAM,EAAE,CAAC;oBACjE,GAAG,CAAC,WAAW,CAAC,MAAM,GAAG,OAAO,CAAC;gBACnC,CAAC;qBAAM,IAAI,MAAM,CAAC,QAAQ,KAAK,QAAQ,EAAE,CAAC;oBACxC,GAAG,CAAC,WAAW,CAAC,MAAM,GAAG,GAAG,CAAC,WAAW,CAAC,MAAM,KAAK,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC;gBACjF,CAAC;gBAED,eAAM,CAAC,IAAI,CAAC,sBAAsB,EAAE;oBAClC,EAAE,EAAE,QAAQ;oBACZ,MAAM,EAAE,MAAM,CAAC,WAAW;oBAC1B,QAAQ,EAAE,MAAM,CAAC,QAAQ;oBACzB,MAAM,EAAE,GAAG,CAAC,WAAW,CAAC,MAAM;iBAC/B,CAAC,CAAC;gBAEH,uBAAuB;gBACvB,GAAG,CAAC,SAAS,CAAC,sBAAsB,EAAE,MAAM,CAAC,CAAC;gBAC9C,GAAG,CAAC,SAAS,CAAC,sBAAsB,EAAE,MAAM,CAAC,QAAQ,CAAC,CAAC;gBACvD,GAAG,CAAC,SAAS,CAAC,oBAAoB,EAAE,MAAM,CAAC,MAAM,CAAC,CAAC;YACrD,CAAC;YAED,IAAI,EAAE,CAAC;QACT,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,2BAA2B,EAAE,KAAK,CAAC,CAAC;YACjD,IAAI,EAAE,CAAC,CAAC,oDAAoD;QAC9D,CAAC;IACH,CAAC,CAAC;IAEF;;OAEG;IACI,iBAAiB,GAAG,KAAK,EAAE,GAAkB,EAAE,GAAa,EAAE,IAAkB,EAAE,EAAE;QACzF,IAAI,CAAC;YACH,MAAM,MAAM,GAAG,IAAI,CAAC,wBAAwB,CAAC,GAAG,CAAC,CAAC;YAElD,IAAI,CAAC,MAAM,EAAE,CAAC;gBACZ,OAAO,IAAI,EAAE,CAAC;YAChB,CAAC;YAED,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,aAAa,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC;YAE5D,IAAI,MAAM,EAAE,CAAC;gBACX,GAAG,CAAC,WAAW,GAAG,GAAG,CAAC,WAAW,IAAI,EAAE,SAAS,EAAE,CAAC,EAAE,MAAM,EAAE,OAAO,EAAE,CAAC;gBACvE,GAAG,CAAC,WAAW,CAAC,YAAY,GAAG,MAAM,CAAC;gBACtC,GAAG,CAAC,WAAW,CAAC,SAAS,IAAI,IAAI,CAAC,oBAAoB,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;gBAExE,qCAAqC;gBACrC,IAAI,MAAM,CAAC,QAAQ,KAAK,UAAU,IAAI,MAAM,CAAC,QAAQ,KAAK,MAAM,EAAE,CAAC;oBACjE,GAAG,CAAC,WAAW,CAAC,MAAM,GAAG,OAAO,CAAC;gBACnC,CAAC;qBAAM,IAAI,MAAM,CAAC,QAAQ,KAAK,QAAQ,EAAE,CAAC;oBACxC,GAAG,CAAC,WAAW,CAAC,MAAM,GAAG,GAAG,CAAC,WAAW,CAAC,MAAM,KAAK,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC;gBACjF,CAAC;gBAED,eAAM,CAAC,IAAI,CAAC,0BAA0B,EAAE;oBACtC,MAAM;oBACN,MAAM,EAAE,MAAM,CAAC,WAAW;oBAC1B,QAAQ,EAAE,MAAM,CAAC,QAAQ;oBACzB,MAAM,EAAE,GAAG,CAAC,WAAW,CAAC,MAAM;iBAC/B,CAAC,CAAC;gBAEH,uBAAuB;gBACvB,GAAG,CAAC,SAAS,CAAC,0BAA0B,EAAE,MAAM,CAAC,CAAC;gBAClD,GAAG,CAAC,SAAS,CAAC,0BAA0B,EAAE,MAAM,CAAC,QAAQ,CAAC,CAAC;gBAC3D,GAAG,CAAC,SAAS,CAAC,wBAAwB,EAAE,MAAM,CAAC,MAAM,CAAC,CAAC;YACzD,CAAC;YAED,IAAI,EAAE,CAAC;QACT,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,+BAA+B,EAAE,KAAK,CAAC,CAAC;YACrD,IAAI,EAAE,CAAC;QACT,CAAC;IACH,CAAC,CAAC;IAEF;;OAEG;IACI,cAAc,GAAG,KAAK,EAAE,GAAkB,EAAE,GAAa,EAAE,IAAkB,EAAE,EAAE;QACtF,IAAI,CAAC;YACH,MAAM,GAAG,GAAG,IAAI,CAAC,qBAAqB,CAAC,GAAG,CAAC,CAAC;YAE5C,IAAI,CAAC,GAAG,EAAE,CAAC;gBACT,OAAO,IAAI,EAAE,CAAC;YAChB,CAAC;YAED,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,aAAa,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC;YAEtD,IAAI,MAAM,EAAE,CAAC;gBACX,GAAG,CAAC,WAAW,GAAG,GAAG,CAAC,WAAW,IAAI,EAAE,SAAS,EAAE,CAAC,EAAE,MAAM,EAAE,OAAO,EAAE,CAAC;gBACvE,GAAG,CAAC,WAAW,CAAC,SAAS,GAAG,MAAM,CAAC;gBACnC,GAAG,CAAC,WAAW,CAAC,SAAS,IAAI,IAAI,CAAC,oBAAoB,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;gBAExE,qCAAqC;gBACrC,IAAI,MAAM,CAAC,QAAQ,KAAK,UAAU,IAAI,MAAM,CAAC,QAAQ,KAAK,MAAM,EAAE,CAAC;oBACjE,GAAG,CAAC,WAAW,CAAC,MAAM,GAAG,OAAO,CAAC;gBACnC,CAAC;qBAAM,IAAI,MAAM,CAAC,QAAQ,KAAK,QAAQ,EAAE,CAAC;oBACxC,GAAG,CAAC,WAAW,CAAC,MAAM,GAAG,GAAG,CAAC,WAAW,CAAC,MAAM,KAAK,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC;gBACjF,CAAC;gBAED,eAAM,CAAC,IAAI,CAAC,uBAAuB,EAAE;oBACnC,GAAG;oBACH,MAAM,EAAE,MAAM,CAAC,WAAW;oBAC1B,QAAQ,EAAE,MAAM,CAAC,QAAQ;oBACzB,MAAM,EAAE,GAAG,CAAC,WAAW,CAAC,MAAM;iBAC/B,CAAC,CAAC;gBAEH,uBAAuB;gBACvB,GAAG,CAAC,SAAS,CAAC,uBAAuB,EAAE,MAAM,CAAC,CAAC;gBAC/C,GAAG,CAAC,SAAS,CAAC,uBAAuB,EAAE,MAAM,CAAC,QAAQ,CAAC,CAAC;gBACxD,GAAG,CAAC,SAAS,CAAC,qBAAqB,EAAE,MAAM,CAAC,MAAM,CAAC,CAAC;YACtD,CAAC;YAED,IAAI,EAAE,CAAC;QACT,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,4BAA4B,EAAE,KAAK,CAAC,CAAC;YAClD,IAAI,EAAE,CAAC;QACT,CAAC;IACH,CAAC,CAAC;IAEF;;OAEG;IACI,eAAe,GAAG,KAAK,EAAE,GAAkB,EAAE,GAAa,EAAE,IAAkB,EAAE,EAAE;QACvF,IAAI,CAAC;YACH,MAAM,IAAI,GAAG,IAAI,CAAC,sBAAsB,CAAC,GAAG,CAAC,CAAC;YAE9C,IAAI,CAAC,IAAI,EAAE,CAAC;gBACV,OAAO,IAAI,EAAE,CAAC;YAChB,CAAC;YAED,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,aAAa,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC;YAExD,IAAI,MAAM,EAAE,CAAC;gBACX,GAAG,CAAC,WAAW,GAAG,GAAG,CAAC,WAAW,IAAI,EAAE,SAAS,EAAE,CAAC,EAAE,MAAM,EAAE,OAAO,EAAE,CAAC;gBACvE,GAAG,CAAC,WAAW,CAAC,SAAS,IAAI,IAAI,CAAC,oBAAoB,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;gBAExE,+BAA+B;gBAC/B,GAAG,CAAC,WAAW,CAAC,MAAM,GAAG,OAAO,CAAC;gBAEjC,eAAM,CAAC,IAAI,CAAC,6BAA6B,EAAE;oBACzC,IAAI;oBACJ,MAAM,EAAE,MAAM,CAAC,WAAW;oBAC1B,QAAQ,EAAE,MAAM,CAAC,QAAQ;oBACzB,MAAM,EAAE,GAAG,CAAC,WAAW,CAAC,MAAM;iBAC/B,CAAC,CAAC;gBAEH,uBAAuB;gBACvB,GAAG,CAAC,SAAS,CAAC,wBAAwB,EAAE,MAAM,CAAC,CAAC;gBAChD,GAAG,CAAC,SAAS,CAAC,wBAAwB,EAAE,MAAM,CAAC,QAAQ,CAAC,CAAC;gBACzD,GAAG,CAAC,SAAS,CAAC,sBAAsB,EAAE,MAAM,CAAC,MAAM,CAAC,CAAC;YACvD,CAAC;YAED,IAAI,EAAE,CAAC;QACT,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,6BAA6B,EAAE,KAAK,CAAC,CAAC;YACnD,IAAI,EAAE,CAAC;QACT,CAAC;IACH,CAAC,CAAC;IAEF;;OAEG;IACI,wBAAwB,GAAG,KAAK,EACrC,GAAkB,EAClB,GAAa,EACb,IAAkB,EAClB,EAAE;QACF,IAAI,CAAC;YACH,GAAG,CAAC,WAAW,GAAG,EAAE,SAAS,EAAE,CAAC,EAAE,MAAM,EAAE,OAAO,EAAE,CAAC;YAEpD,oCAAoC;YACpC,MAAM,OAAO,CAAC,GAAG,CAAC;gBAChB,IAAI,CAAC,aAAa,CAAC,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,GAAE,CAAC,CAAC;gBACtC,IAAI,CAAC,iBAAiB,CAAC,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,GAAE,CAAC,CAAC;gBAC1C,IAAI,CAAC,cAAc,CAAC,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,GAAE,CAAC,CAAC;aACxC,CAAC,CAAC;YAEH,kCAAkC;YAClC,GAAG,CAAC,SAAS,CAAC,gBAAgB,EAAE,GAAG,CAAC,WAAW,CAAC,SAAS,CAAC,QAAQ,EAAE,CAAC,CAAC;YACtE,GAAG,CAAC,SAAS,CAAC,iBAAiB,EAAE,GAAG,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC;YAEzD,mCAAmC;YACnC,IAAI,GAAG,CAAC,WAAW,CAAC,MAAM,KAAK,OAAO,EAAE,CAAC;gBACvC,eAAM,CAAC,IAAI,CAAC,4CAA4C,EAAE;oBACxD,EAAE,EAAE,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC;oBACzB,IAAI,EAAE,GAAG,CAAC,IAAI;oBACd,SAAS,EAAE,GAAG,CAAC,WAAW,CAAC,SAAS;oBACpC,OAAO,EAAE;wBACP,EAAE,EAAE,GAAG,CAAC,WAAW,CAAC,QAAQ,EAAE,WAAW;wBACzC,MAAM,EAAE,GAAG,CAAC,WAAW,CAAC,YAAY,EAAE,WAAW;wBACjD,GAAG,EAAE,GAAG,CAAC,WAAW,CAAC,SAAS,EAAE,WAAW;qBAC5C;iBACF,CAAC,CAAC;gBAEH,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;oBAC1B,OAAO,EAAE,KAAK;oBACd,KAAK,EAAE,0CAA0C;oBACjD,IAAI,EAAE,gBAAgB;oBACtB,IAAI,EAAE;wBACJ,SAAS,EAAE,GAAG,CAAC,WAAW,CAAC,SAAS;wBACpC,OAAO,EAAE;4BACP,EAAE,EAAE,GAAG,CAAC,WAAW,CAAC,QAAQ;gCAC1B,CAAC,CAAC;oCACE,QAAQ,EAAE,GAAG,CAAC,WAAW,CAAC,QAAQ,CAAC,QAAQ;oCAC3C,WAAW,EAAE,GAAG,CAAC,WAAW,CAAC,QAAQ,CAAC,WAAW;oCACjD,MAAM,EAAE,GAAG,CAAC,WAAW,CAAC,QAAQ,CAAC,MAAM;iCACxC;gCACH,CAAC,CAAC,IAAI;4BACR,MAAM,EAAE,GAAG,CAAC,WAAW,CAAC,YAAY;gCAClC,CAAC,CAAC;oCACE,QAAQ,EAAE,GAAG,CAAC,WAAW,CAAC,YAAY,CAAC,QAAQ;oCAC/C,WAAW,EAAE,GAAG,CAAC,WAAW,CAAC,YAAY,CAAC,WAAW;oCACrD,MAAM,EAAE,GAAG,CAAC,WAAW,CAAC,YAAY,CAAC,MAAM;iCAC5C;gCACH,CAAC,CAAC,IAAI;4BACR,GAAG,EAAE,GAAG,CAAC,WAAW,CAAC,SAAS;gCAC5B,CAAC,CAAC;oCACE,QAAQ,EAAE,GAAG,CAAC,WAAW,CAAC,SAAS,CAAC,QAAQ;oCAC5C,WAAW,EAAE,GAAG,CAAC,WAAW,CAAC,SAAS,CAAC,WAAW;oCAClD,MAAM,EAAE,GAAG,CAAC,WAAW,CAAC,SAAS,CAAC,MAAM;iCACzC;gCACH,CAAC,CAAC,IAAI;yBACT;qBACF;iBACF,CAAC,CAAC;YACL,CAAC;YAED,wCAAwC;YACxC,IAAI,GAAG,CAAC,WAAW,CAAC,MAAM,KAAK,MAAM,EAAE,CAAC;gBACtC,GAAG,CAAC,SAAS,CAAC,kBAAkB,EAAE,MAAM,CAAC,CAAC;gBAC1C,eAAM,CAAC,IAAI,CAAC,qCAAqC,EAAE;oBACjD,EAAE,EAAE,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC;oBACzB,IAAI,EAAE,GAAG,CAAC,IAAI;oBACd,SAAS,EAAE,GAAG,CAAC,WAAW,CAAC,SAAS;iBACrC,CAAC,CAAC;YACL,CAAC;YAED,IAAI,EAAE,CAAC;QACT,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,sCAAsC,EAAE,KAAK,CAAC,CAAC;YAC5D,IAAI,EAAE,CAAC;QACT,CAAC;IACH,CAAC,CAAC;IAEF;;OAEG;IACK,WAAW,CAAC,GAAY;QAC9B,OAAO,CACL,GAAG,CAAC,EAAE;YACN,GAAG,CAAC,UAAU,CAAC,aAAa;YAC5B,GAAG,CAAC,MAAM,CAAC,aAAa;YACvB,GAAG,CAAC,UAAkB,EAAE,MAAM,EAAE,aAAa;YAC9C,SAAS,CACV,CAAC;IACJ,CAAC;IAED;;OAEG;IACK,WAAW,CAAC,EAAU;QAC5B,oBAAoB;QACpB,MAAM,aAAa,GAAG;YACpB,OAAO;YACP,+BAA+B;YAC/B,aAAa;YACb,QAAQ;YACR,aAAa;YACb,OAAO;YACP,QAAQ;YACR,QAAQ;SACT,CAAC;QAEF,OAAO,aAAa,CAAC,IAAI,CAAC,KAAK,CAAC,EAAE,CAAC,KAAK,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC,CAAC;IACrD,CAAC;IAED;;OAEG;IACK,wBAAwB,CAAC,GAAY;QAC3C,yCAAyC;QACzC,MAAM,IAAI,GAAG,GAAG,CAAC,GAAG,CAAC,MAAM,CAAC,IAAI,GAAG,CAAC,GAAG,CAAC,kBAAkB,CAAC,IAAI,GAAG,CAAC,QAAQ,CAAC;QAE5E,IAAI,IAAI,EAAE,CAAC;YACT,yBAAyB;YACzB,OAAO,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC;QAC5B,CAAC;QAED,oCAAoC;QACpC,IAAI,GAAG,CAAC,KAAK,IAAI,OAAO,GAAG,CAAC,KAAK,CAAC,GAAG,KAAK,QAAQ,EAAE,CAAC;YACnD,IAAI,CAAC;gBACH,OAAO,IAAI,GAAG,CAAC,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,QAAQ,CAAC;YACzC,CAAC;YAAC,MAAM,CAAC;gBACP,cAAc;YAChB,CAAC;QACH,CAAC;QAED,2BAA2B;QAC3B,IAAI,GAAG,CAAC,IAAI,IAAI,OAAO,GAAG,CAAC,IAAI,KAAK,QAAQ,EAAE,CAAC;YAC7C,MAAM,GAAG,GAAG,GAAG,CAAC,IAAI,CAAC,GAAG,IAAI,GAAG,CAAC,IAAI,CAAC,MAAM,IAAI,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC;YAChE,IAAI,OAAO,GAAG,KAAK,QAAQ,EAAE,CAAC;gBAC5B,IAAI,CAAC;oBACH,OAAO,IAAI,GAAG,CAAC,GAAG,CAAC,CAAC,QAAQ,CAAC;gBAC/B,CAAC;gBAAC,MAAM,CAAC;oBACP,sCAAsC;oBACtC,IAAI,GAAG,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE,CAAC;wBACtB,OAAO,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,qBAAqB;oBACjD,CAAC;gBACH,CAAC;YACH,CAAC;QACH,CAAC;QAED,OAAO,IAAI,CAAC;IACd,CAAC;IAED;;OAEG;IACK,qBAAqB,CAAC,GAAY;QACxC,sCAAsC;QACtC,IAAI,GAAG,CAAC,KAAK,IAAI,OAAO,GAAG,CAAC,KAAK,CAAC,GAAG,KAAK,QAAQ,EAAE,CAAC;YACnD,OAAO,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC;QACvB,CAAC;QAED,IAAI,GAAG,CAAC,IAAI,IAAI,OAAO,GAAG,CAAC,IAAI,KAAK,QAAQ,EAAE,CAAC;YAC7C,MAAM,GAAG,GAAG,GAAG,CAAC,IAAI,CAAC,GAAG,IAAI,GAAG,CAAC,IAAI,CAAC,IAAI,IAAI,GAAG,CAAC,IAAI,CAAC,QAAQ,CAAC;YAC/D,IAAI,OAAO,GAAG,KAAK,QAAQ,EAAE,CAAC;gBAC5B,OAAO,GAAG,CAAC;YACb,CAAC;QACH,CAAC;QAED,qBAAqB;QACrB,MAAM,OAAO,GAAG,GAAG,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC;QACnC,IAAI,OAAO,EAAE,CAAC;YACZ,OAAO,OAAO,CAAC;QACjB,CAAC;QAED,OAAO,IAAI,CAAC;IACd,CAAC;IAED;;OAEG;IACK,sBAAsB,CAAC,GAAY;QACzC,uCAAuC;QACvC,IAAI,GAAG,CAAC,KAAK,IAAI,OAAO,GAAG,CAAC,KAAK,CAAC,IAAI,KAAK,QAAQ,EAAE,CAAC;YACpD,OAAO,GAAG,CAAC,KAAK,CAAC,IAAI,CAAC;QACxB,CAAC;QAED,IAAI,GAAG,CAAC,IAAI,IAAI,OAAO,GAAG,CAAC,IAAI,KAAK,QAAQ,EAAE,CAAC;YAC7C,MAAM,IAAI,GAAG,GAAG,CAAC,IAAI,CAAC,IAAI,IAAI,GAAG,CAAC,IAAI,CAAC,QAAQ,IAAI,GAAG,CAAC,IAAI,CAAC,QAAQ,CAAC;YACrE,IAAI,OAAO,IAAI,KAAK,QAAQ,EAAE,CAAC;gBAC7B,OAAO,IAAI,CAAC;YACd,CAAC;QACH,CAAC;QAED,uBAAuB;QACvB,IAAK,GAAW,CAAC,IAAI,IAAK,GAAW,CAAC,IAAI,CAAC,QAAQ,EAAE,CAAC;YACpD,8DAA8D;YAC9D,uBAAuB;YACvB,OAAO,IAAI,CAAC;QACd,CAAC;QAED,OAAO,IAAI,CAAC;IACd,CAAC;IAED;;OAEG;IACK,oBAAoB,CAAC,QAAgB;QAC3C,QAAQ,QAAQ,EAAE,CAAC;YACjB,KAAK,UAAU;gBACb,OAAO,EAAE,CAAC;YACZ,KAAK,MAAM;gBACT,OAAO,CAAC,CAAC;YACX,KAAK,QAAQ;gBACX,OAAO,CAAC,CAAC;YACX,KAAK,KAAK;gBACR,OAAO,CAAC,CAAC;YACX;gBACE,OAAO,CAAC,CAAC;QACb,CAAC;IACH,CAAC;IAED;;OAEG;IACI,QAAQ,GAAG,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,EAAE;QACtD,IAAI,CAAC;YACH,MAAM,KAAK,GAAG,MAAM,IAAI,CAAC,aAAa,CAAC,QAAQ,EAAE,CAAC;YAElD,GAAG,CAAC,IAAI,CAAC;gBACP,OAAO,EAAE,IAAI;gBACb,IAAI,EAAE,KAAK;aACZ,CAAC,CAAC;QACL,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,6BAA6B,EAAE,KAAK,CAAC,CAAC;YACnD,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;gBACnB,OAAO,EAAE,KAAK;gBACd,KAAK,EAAE,8CAA8C;aACtD,CAAC,CAAC;QACL,CAAC;IACH,CAAC,CAAC;IAEF;;OAEG;IACI,eAAe,GAAG,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,EAAE;QAC7D,IAAI,CAAC;YACH,MAAM,KAAK,GAAG,QAAQ,CAAC,GAAG,CAAC,KAAK,CAAC,KAAe,CAAC,IAAI,GAAG,CAAC;YACzD,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,aAAa,CAAC,eAAe,CAAC,KAAK,CAAC,CAAC;YAE/D,GAAG,CAAC,IAAI,CAAC;gBACP,OAAO,EAAE,IAAI;gBACb,IAAI,EAAE,MAAM;aACb,CAAC,CAAC;QACL,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,8BAA8B,EAAE,KAAK,CAAC,CAAC;YACpD,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;gBACnB,OAAO,EAAE,KAAK;gBACd,KAAK,EAAE,oCAAoC;aAC5C,CAAC,CAAC;QACL,CAAC;IACH,CAAC,CAAC;IAEF;;OAEG;IACI,kBAAkB,GAAG,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,EAAE;QAChE,IAAI,CAAC;YACH,MAAM,SAAS,GAAG,GAAG,CAAC,IAAI,CAAC;YAE3B,IAAI,CAAC,SAAS,CAAC,IAAI,IAAI,CAAC,SAAS,CAAC,KAAK,IAAI,CAAC,SAAS,CAAC,MAAM,EAAE,CAAC;gBAC7D,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;oBAC1B,OAAO,EAAE,KAAK;oBACd,KAAK,EAAE,sCAAsC;iBAC9C,CAAC,CAAC;YACL,CAAC;YAED,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,aAAa,CAAC,kBAAkB,CAAC,SAAS,CAAC,CAAC;YAEvE,GAAG,CAAC,IAAI,CAAC;gBACP,OAAO,EAAE,IAAI;gBACb,IAAI,EAAE,EAAE,KAAK,EAAE,OAAO,EAAE;aACzB,CAAC,CAAC;QACL,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,gCAAgC,EAAE,KAAK,CAAC,CAAC;YACtD,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;gBACnB,OAAO,EAAE,KAAK;gBACd,KAAK,EAAE,uCAAuC;aAC/C,CAAC,CAAC;QACL,CAAC;IACH,CAAC,CAAC;IAEF;;OAEG;IACI,QAAQ,GAAG,CAAC,GAAY,EAAE,GAAa,EAAE,EAAE;QAChD,IAAI,CAAC;YACH,MAAM,KAAK,GAAG,IAAI,CAAC,aAAa,CAAC,QAAQ,EAAE,CAAC;YAE5C,GAAG,CAAC,IAAI,CAAC;gBACP,OAAO,EAAE,IAAI;gBACb,IAAI,EAAE,KAAK;aACZ,CAAC,CAAC;QACL,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,6BAA6B,EAAE,KAAK,CAAC,CAAC;YACnD,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;gBACnB,OAAO,EAAE,KAAK;gBACd,KAAK,EAAE,4BAA4B;aACpC,CAAC,CAAC;QACL,CAAC;IACH,CAAC,CAAC;IAEF;;OAEG;IACI,UAAU,GAAG,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,EAAE;QACxD,IAAI,CAAC;YACH,MAAM,EAAE,QAAQ,EAAE,OAAO,EAAE,GAAG,GAAG,CAAC,IAAI,CAAC;YAEvC,IAAI,CAAC,QAAQ,IAAI,OAAO,OAAO,KAAK,SAAS,EAAE,CAAC;gBAC9C,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;oBAC1B,OAAO,EAAE,KAAK;oBACd,KAAK,EAAE,mCAAmC;iBAC3C,CAAC,CAAC;YACL,CAAC;YAED,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,aAAa,CAAC,UAAU,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;YAEvE,GAAG,CAAC,IAAI,CAAC;gBACP,OAAO,EAAE,IAAI;gBACb,IAAI,EAAE,EAAE,OAAO,EAAE,OAAO,EAAE;aAC3B,CAAC,CAAC;QACL,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,sBAAsB,EAAE,KAAK,CAAC,CAAC;YAC5C,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;gBACnB,OAAO,EAAE,KAAK;gBACd,KAAK,EAAE,8BAA8B;aACtC,CAAC,CAAC;QACL,CAAC;IACH,CAAC,CAAC;CACH;AA7gBD,oEA6gBC;AAED,4BAA4B;AACf,QAAA,4BAA4B,GAAG,IAAI,4BAA4B,EAAE,CAAC;AAE/E,6BAA6B;AAChB,QAAA,aAAa,GAAG,oCAA4B,CAAC,aAAa,CAAC;AAC3D,QAAA,iBAAiB,GAAG,oCAA4B,CAAC,iBAAiB,CAAC;AACnE,QAAA,cAAc,GAAG,oCAA4B,CAAC,cAAc,CAAC;AAC7D,QAAA,eAAe,GAAG,oCAA4B,CAAC,eAAe,CAAC;AAC/D,QAAA,wBAAwB,GAAG,oCAA4B,CAAC,wBAAwB,CAAC","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\middleware\\threat-intelligence.middleware.ts"],"sourcesContent":["import { NextFunction, Request, Response } from 'express';\nimport { ThreatIntelligenceService } from '../services/threat-intelligence.service';\nimport { logger } from '../utils/logger';\n\ninterface ThreatRequest extends Request {\n  threatCheck?: {\n    ipThreat?: any;\n    domainThreat?: any;\n    urlThreat?: any;\n    riskScore: number;\n    action: 'allow' | 'warn' | 'block';\n  };\n}\n\n/**\n * Middleware for threat intelligence integration\n */\nexport class ThreatIntelligenceMiddleware {\n  private threatService: ThreatIntelligenceService;\n\n  constructor() {\n    this.threatService = new ThreatIntelligenceService();\n  }\n\n  /**\n   * Check IP address against threat intelligence\n   */\n  public checkIPThreat = async (req: ThreatRequest, res: Response, next: NextFunction) => {\n    try {\n      const clientIP = this.getClientIP(req);\n\n      if (!clientIP || this.isPrivateIP(clientIP)) {\n        return next();\n      }\n\n      const threat = await this.threatService.checkIPAddress(clientIP);\n\n      if (threat) {\n        req.threatCheck = req.threatCheck || { riskScore: 0, action: 'allow' };\n        req.threatCheck.ipThreat = threat;\n        req.threatCheck.riskScore += this.getScoreFromSeverity(threat.severity);\n\n        // Determine action based on severity\n        if (threat.severity === 'critical' || threat.severity === 'high') {\n          req.threatCheck.action = 'block';\n        } else if (threat.severity === 'medium') {\n          req.threatCheck.action = req.threatCheck.action === 'block' ? 'block' : 'warn';\n        }\n\n        logger.warn('Threat detected - IP', {\n          ip: clientIP,\n          threat: threat.description,\n          severity: threat.severity,\n          action: req.threatCheck.action,\n        });\n\n        // Add security headers\n        res.setHeader('X-Threat-IP-Detected', 'true');\n        res.setHeader('X-Threat-IP-Severity', threat.severity);\n        res.setHeader('X-Threat-IP-Source', threat.source);\n      }\n\n      next();\n    } catch (error) {\n      logger.error('Error checking IP threat:', error);\n      next(); // Continue on error to avoid breaking functionality\n    }\n  };\n\n  /**\n   * Check domain against threat intelligence\n   */\n  public checkDomainThreat = async (req: ThreatRequest, res: Response, next: NextFunction) => {\n    try {\n      const domain = this.extractDomainFromRequest(req);\n\n      if (!domain) {\n        return next();\n      }\n\n      const threat = await this.threatService.checkDomain(domain);\n\n      if (threat) {\n        req.threatCheck = req.threatCheck || { riskScore: 0, action: 'allow' };\n        req.threatCheck.domainThreat = threat;\n        req.threatCheck.riskScore += this.getScoreFromSeverity(threat.severity);\n\n        // Determine action based on severity\n        if (threat.severity === 'critical' || threat.severity === 'high') {\n          req.threatCheck.action = 'block';\n        } else if (threat.severity === 'medium') {\n          req.threatCheck.action = req.threatCheck.action === 'block' ? 'block' : 'warn';\n        }\n\n        logger.warn('Threat detected - Domain', {\n          domain,\n          threat: threat.description,\n          severity: threat.severity,\n          action: req.threatCheck.action,\n        });\n\n        // Add security headers\n        res.setHeader('X-Threat-Domain-Detected', 'true');\n        res.setHeader('X-Threat-Domain-Severity', threat.severity);\n        res.setHeader('X-Threat-Domain-Source', threat.source);\n      }\n\n      next();\n    } catch (error) {\n      logger.error('Error checking domain threat:', error);\n      next();\n    }\n  };\n\n  /**\n   * Check URL against threat intelligence\n   */\n  public checkURLThreat = async (req: ThreatRequest, res: Response, next: NextFunction) => {\n    try {\n      const url = this.extractURLFromRequest(req);\n\n      if (!url) {\n        return next();\n      }\n\n      const threat = await this.threatService.checkURL(url);\n\n      if (threat) {\n        req.threatCheck = req.threatCheck || { riskScore: 0, action: 'allow' };\n        req.threatCheck.urlThreat = threat;\n        req.threatCheck.riskScore += this.getScoreFromSeverity(threat.severity);\n\n        // Determine action based on severity\n        if (threat.severity === 'critical' || threat.severity === 'high') {\n          req.threatCheck.action = 'block';\n        } else if (threat.severity === 'medium') {\n          req.threatCheck.action = req.threatCheck.action === 'block' ? 'block' : 'warn';\n        }\n\n        logger.warn('Threat detected - URL', {\n          url,\n          threat: threat.description,\n          severity: threat.severity,\n          action: req.threatCheck.action,\n        });\n\n        // Add security headers\n        res.setHeader('X-Threat-URL-Detected', 'true');\n        res.setHeader('X-Threat-URL-Severity', threat.severity);\n        res.setHeader('X-Threat-URL-Source', threat.source);\n      }\n\n      next();\n    } catch (error) {\n      logger.error('Error checking URL threat:', error);\n      next();\n    }\n  };\n\n  /**\n   * Check file hash against threat intelligence\n   */\n  public checkHashThreat = async (req: ThreatRequest, res: Response, next: NextFunction) => {\n    try {\n      const hash = this.extractHashFromRequest(req);\n\n      if (!hash) {\n        return next();\n      }\n\n      const threat = await this.threatService.checkHash(hash);\n\n      if (threat) {\n        req.threatCheck = req.threatCheck || { riskScore: 0, action: 'allow' };\n        req.threatCheck.riskScore += this.getScoreFromSeverity(threat.severity);\n\n        // Always block malicious files\n        req.threatCheck.action = 'block';\n\n        logger.warn('Threat detected - File Hash', {\n          hash,\n          threat: threat.description,\n          severity: threat.severity,\n          action: req.threatCheck.action,\n        });\n\n        // Add security headers\n        res.setHeader('X-Threat-Hash-Detected', 'true');\n        res.setHeader('X-Threat-Hash-Severity', threat.severity);\n        res.setHeader('X-Threat-Hash-Source', threat.source);\n      }\n\n      next();\n    } catch (error) {\n      logger.error('Error checking hash threat:', error);\n      next();\n    }\n  };\n\n  /**\n   * Comprehensive threat check (IP, Domain, URL)\n   */\n  public comprehensiveThreatCheck = async (\n    req: ThreatRequest,\n    res: Response,\n    next: NextFunction,\n  ) => {\n    try {\n      req.threatCheck = { riskScore: 0, action: 'allow' };\n\n      // Run all threat checks in parallel\n      await Promise.all([\n        this.checkIPThreat(req, res, () => {}),\n        this.checkDomainThreat(req, res, () => {}),\n        this.checkURLThreat(req, res, () => {}),\n      ]);\n\n      // Add overall threat score header\n      res.setHeader('X-Threat-Score', req.threatCheck.riskScore.toString());\n      res.setHeader('X-Threat-Action', req.threatCheck.action);\n\n      // Block request if action is block\n      if (req.threatCheck.action === 'block') {\n        logger.warn('Request blocked due to threat intelligence', {\n          ip: this.getClientIP(req),\n          path: req.path,\n          riskScore: req.threatCheck.riskScore,\n          threats: {\n            ip: req.threatCheck.ipThreat?.description,\n            domain: req.threatCheck.domainThreat?.description,\n            url: req.threatCheck.urlThreat?.description,\n          },\n        });\n\n        return res.status(403).json({\n          success: false,\n          error: 'Request blocked due to security concerns',\n          code: 'THREAT_BLOCKED',\n          data: {\n            riskScore: req.threatCheck.riskScore,\n            threats: {\n              ip: req.threatCheck.ipThreat\n                ? {\n                    severity: req.threatCheck.ipThreat.severity,\n                    description: req.threatCheck.ipThreat.description,\n                    source: req.threatCheck.ipThreat.source,\n                  }\n                : null,\n              domain: req.threatCheck.domainThreat\n                ? {\n                    severity: req.threatCheck.domainThreat.severity,\n                    description: req.threatCheck.domainThreat.description,\n                    source: req.threatCheck.domainThreat.source,\n                  }\n                : null,\n              url: req.threatCheck.urlThreat\n                ? {\n                    severity: req.threatCheck.urlThreat.severity,\n                    description: req.threatCheck.urlThreat.description,\n                    source: req.threatCheck.urlThreat.source,\n                  }\n                : null,\n            },\n          },\n        });\n      }\n\n      // Add warning headers if action is warn\n      if (req.threatCheck.action === 'warn') {\n        res.setHeader('X-Threat-Warning', 'true');\n        logger.warn('Request allowed with threat warning', {\n          ip: this.getClientIP(req),\n          path: req.path,\n          riskScore: req.threatCheck.riskScore,\n        });\n      }\n\n      next();\n    } catch (error) {\n      logger.error('Error in comprehensive threat check:', error);\n      next();\n    }\n  };\n\n  /**\n   * Get client IP address\n   */\n  private getClientIP(req: Request): string {\n    return (\n      req.ip ||\n      req.connection.remoteAddress ||\n      req.socket.remoteAddress ||\n      (req.connection as any)?.socket?.remoteAddress ||\n      'unknown'\n    );\n  }\n\n  /**\n   * Check if IP is private\n   */\n  private isPrivateIP(ip: string): boolean {\n    // Private IP ranges\n    const privateRanges = [\n      /^10\\./,\n      /^172\\.(1[6-9]|2[0-9]|3[01])\\./,\n      /^192\\.168\\./,\n      /^127\\./,\n      /^169\\.254\\./,\n      /^::1$/,\n      /^fc00:/,\n      /^fe80:/,\n    ];\n\n    return privateRanges.some(range => range.test(ip));\n  }\n\n  /**\n   * Extract domain from request\n   */\n  private extractDomainFromRequest(req: Request): string | null {\n    // Try to get domain from various sources\n    const host = req.get('Host') || req.get('X-Forwarded-Host') || req.hostname;\n\n    if (host) {\n      // Remove port if present\n      return host.split(':')[0];\n    }\n\n    // Try to extract from URL parameter\n    if (req.query && typeof req.query.url === 'string') {\n      try {\n        return new URL(req.query.url).hostname;\n      } catch {\n        // Invalid URL\n      }\n    }\n\n    // Try to extract from body\n    if (req.body && typeof req.body === 'object') {\n      const url = req.body.url || req.body.domain || req.body.website;\n      if (typeof url === 'string') {\n        try {\n          return new URL(url).hostname;\n        } catch {\n          // Invalid URL, might be just a domain\n          if (url.includes('.')) {\n            return url.split('/')[0]; // Remove path if any\n          }\n        }\n      }\n    }\n\n    return null;\n  }\n\n  /**\n   * Extract URL from request\n   */\n  private extractURLFromRequest(req: Request): string | null {\n    // Try to get URL from various sources\n    if (req.query && typeof req.query.url === 'string') {\n      return req.query.url;\n    }\n\n    if (req.body && typeof req.body === 'object') {\n      const url = req.body.url || req.body.link || req.body.redirect;\n      if (typeof url === 'string') {\n        return url;\n      }\n    }\n\n    // Try Referer header\n    const referer = req.get('Referer');\n    if (referer) {\n      return referer;\n    }\n\n    return null;\n  }\n\n  /**\n   * Extract hash from request\n   */\n  private extractHashFromRequest(req: Request): string | null {\n    // Try to get hash from various sources\n    if (req.query && typeof req.query.hash === 'string') {\n      return req.query.hash;\n    }\n\n    if (req.body && typeof req.body === 'object') {\n      const hash = req.body.hash || req.body.fileHash || req.body.checksum;\n      if (typeof hash === 'string') {\n        return hash;\n      }\n    }\n\n    // Try from file upload\n    if ((req as any).file && (req as any).file.filename) {\n      // In a real implementation, you would calculate the file hash\n      // For now, return null\n      return null;\n    }\n\n    return null;\n  }\n\n  /**\n   * Get score from severity\n   */\n  private getScoreFromSeverity(severity: string): number {\n    switch (severity) {\n      case 'critical':\n        return 10;\n      case 'high':\n        return 7;\n      case 'medium':\n        return 4;\n      case 'low':\n        return 1;\n      default:\n        return 0;\n    }\n  }\n\n  /**\n   * Get threat intelligence statistics\n   */\n  public getStats = async (req: Request, res: Response) => {\n    try {\n      const stats = await this.threatService.getStats();\n\n      res.json({\n        success: true,\n        data: stats,\n      });\n    } catch (error) {\n      logger.error('Error getting threat stats:', error);\n      res.status(500).json({\n        success: false,\n        error: 'Failed to get threat intelligence statistics',\n      });\n    }\n  };\n\n  /**\n   * Get recent threat alerts\n   */\n  public getRecentAlerts = async (req: Request, res: Response) => {\n    try {\n      const limit = parseInt(req.query.limit as string) || 100;\n      const alerts = await this.threatService.getRecentAlerts(limit);\n\n      res.json({\n        success: true,\n        data: alerts,\n      });\n    } catch (error) {\n      logger.error('Error getting recent alerts:', error);\n      res.status(500).json({\n        success: false,\n        error: 'Failed to get recent threat alerts',\n      });\n    }\n  };\n\n  /**\n   * Add custom threat indicator\n   */\n  public addCustomIndicator = async (req: Request, res: Response) => {\n    try {\n      const indicator = req.body;\n\n      if (!indicator.type || !indicator.value || !indicator.source) {\n        return res.status(400).json({\n          success: false,\n          error: 'type, value, and source are required',\n        });\n      }\n\n      const success = await this.threatService.addCustomIndicator(indicator);\n\n      res.json({\n        success: true,\n        data: { added: success },\n      });\n    } catch (error) {\n      logger.error('Error adding custom indicator:', error);\n      res.status(500).json({\n        success: false,\n        error: 'Failed to add custom threat indicator',\n      });\n    }\n  };\n\n  /**\n   * Get threat feeds\n   */\n  public getFeeds = (req: Request, res: Response) => {\n    try {\n      const feeds = this.threatService.getFeeds();\n\n      res.json({\n        success: true,\n        data: feeds,\n      });\n    } catch (error) {\n      logger.error('Error getting threat feeds:', error);\n      res.status(500).json({\n        success: false,\n        error: 'Failed to get threat feeds',\n      });\n    }\n  };\n\n  /**\n   * Toggle threat feed\n   */\n  public toggleFeed = async (req: Request, res: Response) => {\n    try {\n      const { feedName, enabled } = req.body;\n\n      if (!feedName || typeof enabled !== 'boolean') {\n        return res.status(400).json({\n          success: false,\n          error: 'feedName and enabled are required',\n        });\n      }\n\n      const success = await this.threatService.toggleFeed(feedName, enabled);\n\n      res.json({\n        success: true,\n        data: { toggled: success },\n      });\n    } catch (error) {\n      logger.error('Error toggling feed:', error);\n      res.status(500).json({\n        success: false,\n        error: 'Failed to toggle threat feed',\n      });\n    }\n  };\n}\n\n// Export singleton instance\nexport const threatIntelligenceMiddleware = new ThreatIntelligenceMiddleware();\n\n// Export convenience methods\nexport const checkIPThreat = threatIntelligenceMiddleware.checkIPThreat;\nexport const checkDomainThreat = threatIntelligenceMiddleware.checkDomainThreat;\nexport const checkURLThreat = threatIntelligenceMiddleware.checkURLThreat;\nexport const checkHashThreat = threatIntelligenceMiddleware.checkHashThreat;\nexport const comprehensiveThreatCheck = threatIntelligenceMiddleware.comprehensiveThreatCheck;\n"],"version":3}