{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\PredictiveHealingService.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\PredictiveHealingService.ts"],"sourcesContent":["import { neuralHealthService, HealthMetrics } from './NeuralHealthService';\nimport { logger } from '../utils/logger';\n\ninterface AnomalyPattern {\n  id: string;\n  metric: keyof HealthMetrics;\n  threshold: number;\n  duration: number; // ms\n  count: number;\n}\n\nexport class PredictiveHealingService {\n  private static instance: PredictiveHealingService;\n  private anomalyHistory: { timestamp: number; metrics: HealthMetrics }[] = [];\n  private readonly ANOMALY_WINDOW = 60000; // 1 minute history\n\n  private constructor() {\n    this.init();\n  }\n\n  public static getInstance(): PredictiveHealingService {\n    if (!PredictiveHealingService.instance) {\n      PredictiveHealingService.instance = new PredictiveHealingService();\n    }\n    return PredictiveHealingService.instance;\n  }\n\n  private init() {\n    neuralHealthService.on('healthWarning', (metrics: HealthMetrics) => {\n      this.analyzeAndHeal(metrics);\n    });\n    logger.info('Predictive Healing Service activado y escuchando al Núcleo Neural.');\n  }\n\n  private async analyzeAndHeal(metrics: HealthMetrics) {\n    logger.warn(`Analizando degradación del sistema. Sanity Score: ${metrics.sanityScore}%`);\n\n    this.checkAnomalies(metrics);\n\n    if (metrics.status === 'CRITICAL') {\n      await this.performEmergencyHealing(metrics);\n    } else if (metrics.status === 'DEGRADED') {\n      await this.performProactiveMaintenance(metrics);\n    }\n  }\n\n  private checkAnomalies(metrics: HealthMetrics) {\n    const now = Date.now();\n    this.anomalyHistory.push({ timestamp: now, metrics });\n    this.anomalyHistory = this.anomalyHistory.filter(h => now - h.timestamp < this.ANOMALY_WINDOW);\n\n    // Detección de anomalías por gradiente (subida rápida de carga)\n    if (this.anomalyHistory.length > 5) {\n      const first = this.anomalyHistory[0].metrics;\n      if (metrics.cpuUsage - first.cpuUsage > 40) {\n        logger.error('ANOMALÍA DETECTADA: Gradiente de CPU agresivo. Activando Protocolo Escudo.');\n        this.activateShieldProtocol();\n      }\n    }\n  }\n\n  private activateShieldProtocol() {\n    logger.warn(\n      'Protocolo Escudo Activo: Limitando conexiones entrantes y priorizando procesos de core.',\n    );\n  }\n\n  private async performEmergencyHealing(metrics: HealthMetrics) {\n    logger.error('NIVEL CRÍTICO DETECTADO. Iniciando Protocolos de Emergencia.');\n\n    if (metrics.sanityScore < 30) {\n      await this.triggerPhoenixProtocol();\n    }\n\n    if (metrics.memoryUsage > 90) {\n      logger.info('Acción: Forzando recolección de basura y limpieza de caches.');\n      if (global.gc) {\n        global.gc();\n      }\n      // Simulación de limpieza de Redis\n      logger.info('Acción: Purgando segmentos de cache Redis marcados como volátiles.');\n    }\n\n    if (metrics.cpuUsage > 95) {\n      logger.info(\n        'Acción: Suspendiendo tareas de fondo no críticas y reduciendo frecuencia de telemetría.',\n      );\n    }\n  }\n\n  private async triggerPhoenixProtocol() {\n    logger.error('⚠️ PROTOCOLO FÉNIX ACTIVADO ⚠️');\n    logger.info('Proceso de renacimiento: Reiniciando servicios de infraestructura en cascada.');\n    // Simulación de reinicio de servicios\n    setTimeout(() => {\n      logger.info('Fénix: Reposicionando pools de base de datos y refrescando buffers de memoria.');\n    }, 2000);\n  }\n\n  private async performProactiveMaintenance(metrics: HealthMetrics) {\n    logger.info('Nivel Degradado detectado. Iniciando mantenimiento proactivo.');\n\n    if (metrics.memoryUsage > 70) {\n      logger.info('Acción: Pre-vaciado de buffers de logs y optimización de pools de conexión.');\n    }\n  }\n}\n\nexport const predictiveHealingService = PredictiveHealingService.getInstance();\n"],"version":3}