{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\usage.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\usage.service.ts"],"sourcesContent":["import { injectable, inject } from 'inversify';\nimport { encode } from 'gpt-tokenizer';\nimport { User } from '../models/User';\nimport { UsageRecord } from '../models/UsageRecord';\nimport { StripeService } from './stripe.service';\nimport { TYPES } from '../types';\nimport { logger } from '../utils/logger';\n\n@injectable()\nexport class UsageService {\n  constructor(@inject(TYPES.StripeService) private stripeService: StripeService) {}\n\n  /**\n   * Calculates token count for a text\n   */\n  public countTokens(text: string): number {\n    if (!text) return 0;\n    try {\n      // gpt-tokenizer is compatible with most modern LLMs (BPE)\n      return encode(text).length;\n    } catch (error) {\n      logger.warn('Token counting failed, using fallback estimate');\n      return Math.ceil(text.length / 4); // Very rough fallback\n    }\n  }\n\n  /**\n   * Tracks and reports AI usage\n   */\n  public async trackUsage(params: {\n    userId: string;\n    provider: string;\n    modelId: string;\n    prompt: string;\n    completion: string;\n  }): Promise<void> {\n    const promptTokens = this.countTokens(params.prompt);\n    const completionTokens = this.countTokens(params.completion);\n    const totalTokens = promptTokens + completionTokens;\n\n    try {\n      // 1. Save record to DB for internal auditing\n      const record = new UsageRecord({\n        userId: params.userId,\n        provider: params.provider,\n        modelId: params.modelId,\n        promptTokens,\n        completionTokens,\n        totalTokens,\n        costEstimate: this.estimateCost(params.modelId, promptTokens, completionTokens),\n      });\n      await record.save();\n\n      // 2. Report to Stripe if user has a metered subscription\n      const user = await User.findById(params.userId).select('+stripeSubscriptionItemId');\n      if (user?.stripeSubscriptionItemId) {\n        // Stripe usually bills in fixed units.\n        // Example: 1 unit per 1,000 tokens.\n        const units = Math.ceil(totalTokens / 1000);\n        if (units > 0) {\n          await this.stripeService.reportUsage(user.stripeSubscriptionItemId, units);\n        }\n      }\n\n      logger.info(\n        `[UsageService] Tracked ${totalTokens} tokens for user ${params.userId} (${params.modelId})`,\n      );\n    } catch (error) {\n      logger.error(error, `[UsageService] Failed to track usage for user ${params.userId}`);\n    }\n  }\n\n  /**\n   * Simple cost estimator (Reflected in USD)\n   */\n  private estimateCost(modelId: string, promptTokens: number, completionTokens: number): number {\n    const rates: Record<string, { prompt: number; completion: number }> = {\n      'gemini-3.0-flash': { prompt: 0.1 / 1_000_000, completion: 0.3 / 1_000_000 },\n      'gemini-1.5-flash-8b': { prompt: 0.03 / 1_000_000, completion: 0.09 / 1_000_000 },\n      'claude-3-5-sonnet-20241022': { prompt: 3 / 1_000_000, completion: 15 / 1_000_000 },\n    };\n\n    const rate = rates[modelId] || rates['gemini-3.0-flash'];\n    return promptTokens * rate.prompt + completionTokens * rate.completion;\n  }\n}\n"],"version":3}