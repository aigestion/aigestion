{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\config\\database.ts","mappings":";;;;;;AAAA,wDAAoD;AAEpD,4CAAyC;AACzC,qCAAkC;AAElC,MAAM,EAAE,KAAK,EAAE,GAAG,eAAM,CAAC;AAEzB,MAAM,cAAc,GAAmB;IACrC,wBAAwB,EAAE,IAAI;IAC9B,WAAW,EAAE,GAAG,EAAE,qCAAqC;IACvD,WAAW,EAAE,EAAE,EAAE,wBAAwB;IACzC,gBAAgB,EAAE,IAAI;IACtB,eAAe,EAAE,KAAK;IACtB,MAAM,EAAE,CAAC,EAAE,qBAAqB;CACjC,CAAC;AAEF,IAAI,WAAW,GAAG,KAAK,CAAC;AAEjB,MAAM,iBAAiB,GAAG,KAAK,IAAmB,EAAE;IACzD,IAAI,WAAW,EAAE,CAAC;QAChB,eAAM,CAAC,IAAI,CAAC,oCAAoC,CAAC,CAAC;QAClD,OAAO;IACT,CAAC;IAED,IAAI,CAAC;QACH,MAAM,GAAG,GACP,OAAO,CAAC,GAAG,CAAC,WAAW;YACvB,OAAO,CAAC,GAAG,CAAC,SAAS;YACrB,KAAK,CAAC,GAAG;YACT,4FAA4F,CAAC;QAE/F,OAAO,CAAC,KAAK,CACX,8CAA8C,GAAG,EAAE,OAAO,CAAC,WAAW,EAAE,QAAQ,CAAC,EAAE,CACpF,CAAC;QACF,eAAM,CAAC,IAAI,CAAC,EAAE,GAAG,EAAE,GAAG,EAAE,OAAO,CAAC,WAAW,EAAE,QAAQ,CAAC,EAAE,EAAE,0BAA0B,CAAC,CAAC;QAEtF,IAAI,CAAC,GAAG,EAAE,CAAC;YACT,MAAM,IAAI,KAAK,CAAC,mBAAmB,CAAC,CAAC;QACvC,CAAC;QAED,MAAM,kBAAQ,CAAC,OAAO,CAAC,GAAG,EAAE,cAAc,CAAC,CAAC;QAE5C,WAAW,GAAG,IAAI,CAAC;QACnB,eAAM,CAAC,IAAI,CAAC,mCAAmC,CAAC,CAAC;QAEjD,2BAA2B;QAC3B,kBAAQ,CAAC,UAAU,CAAC,EAAE,CAAC,WAAW,EAAE,GAAG,EAAE;YACvC,eAAM,CAAC,IAAI,CAAC,mBAAmB,CAAC,CAAC;QACnC,CAAC,CAAC,CAAC;QAEH,kBAAQ,CAAC,UAAU,CAAC,EAAE,CAAC,OAAO,EAAE,GAAG,CAAC,EAAE;YACpC,eAAM,CAAC,KAAK,CAAC,GAAG,EAAE,2BAA2B,CAAC,CAAC;QACjD,CAAC,CAAC,CAAC;QAEH,kBAAQ,CAAC,UAAU,CAAC,EAAE,CAAC,cAAc,EAAE,GAAG,EAAE;YAC1C,eAAM,CAAC,IAAI,CAAC,sBAAsB,CAAC,CAAC;YACpC,WAAW,GAAG,KAAK,CAAC;QACtB,CAAC,CAAC,CAAC;QAEH,6BAA6B;QAC7B,OAAO,CAAC,EAAE,CAAC,QAAQ,EAAE,KAAK,IAAI,EAAE;YAC9B,MAAM,kBAAQ,CAAC,UAAU,CAAC,KAAK,EAAE,CAAC;YAClC,eAAM,CAAC,IAAI,CAAC,mDAAmD,CAAC,CAAC;YACjE,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;QAClB,CAAC,CAAC,CAAC;IACL,CAAC;IAAC,OAAO,KAAK,EAAE,CAAC;QACf,MAAM,GAAG,GAAG,KAAc,CAAC;QAC3B,eAAM,CAAC,KAAK,CAAC,GAAG,EAAE,mDAAmD,CAAC,CAAC;QACvE,eAAM,CAAC,IAAI,CAAC,kEAAkE,CAAC,CAAC;QAChF,+DAA+D;IACjE,CAAC;AACH,CAAC,CAAC;AArDW,QAAA,iBAAiB,qBAqD5B","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\config\\database.ts"],"sourcesContent":["import mongoose, { ConnectOptions } from 'mongoose';\n\nimport { logger } from '../utils/logger';\nimport { config } from './config';\n\nconst { mongo } = config;\n\nconst connectOptions: ConnectOptions = {\n  serverSelectionTimeoutMS: 5000,\n  maxPoolSize: 100, // Increase pool for high concurrency\n  minPoolSize: 10, // Keep warm connections\n  connectTimeoutMS: 5000,\n  socketTimeoutMS: 45000,\n  family: 4, // Faster IPv4 lookup\n};\n\nlet isConnected = false;\n\nexport const connectToDatabase = async (): Promise<void> => {\n  if (isConnected) {\n    logger.info('Using existing database connection');\n    return;\n  }\n\n  try {\n    const uri =\n      process.env.MONGODB_URI ||\n      process.env.MONGO_URI ||\n      mongo.uri ||\n      'mongodb://admin:AWReTznw7k3Sf4lWFEenRw@localhost:27017/aigestion-platform?authSource=admin';\n\n    console.error(\n      `[DEBUG_DB] Attempting connection with URI: ${uri?.replace(/:([^@]+)@/, ':****@')}`,\n    );\n    logger.info({ uri: uri?.replace(/:([^@]+)@/, ':****@') }, 'Connecting to MongoDB...');\n\n    if (!uri) {\n      throw new Error('CORE_DB_URI_UNDEF');\n    }\n\n    await mongoose.connect(uri, connectOptions);\n\n    isConnected = true;\n    logger.info('Successfully connected to MongoDB');\n\n    // Handle connection events\n    mongoose.connection.on('connected', () => {\n      logger.info('MongoDB connected');\n    });\n\n    mongoose.connection.on('error', err => {\n      logger.error(err, 'MongoDB connection error:');\n    });\n\n    mongoose.connection.on('disconnected', () => {\n      logger.warn('MongoDB disconnected');\n      isConnected = false;\n    });\n\n    // Handle process termination\n    process.on('SIGINT', async () => {\n      await mongoose.connection.close();\n      logger.info('MongoDB connection closed through app termination');\n      process.exit(0);\n    });\n  } catch (error) {\n    const err = error as Error;\n    logger.error(err, 'MongoDB connection error (Resilient Mode Active):');\n    logger.warn('⚠️ SERVER STARTING WITHOUT DATABASE. SOME FEATURES WILL FAIL. ⚠️');\n    // Do NOT exit process. Allow server to start for health check.\n  }\n};\n"],"version":3}