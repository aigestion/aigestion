{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\middleware\\idempotency.middleware.ts","mappings":";;;AACA,wDAA8C;AAC9C,4CAAyC;AAYlC,MAAM,qBAAqB,GAAG,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,IAAkB,EAAE,EAAE;IAC7F,MAAM,cAAc,GAAG,GAAG,CAAC,OAAO,CAAC,iBAAiB,CAAW,CAAC;IAEhE,8FAA8F;IAC9F,IAAI,CAAC,cAAc,IAAI,GAAG,CAAC,MAAM,KAAK,KAAK,EAAE,CAAC;QAC5C,OAAO,IAAI,EAAE,CAAC;IAChB,CAAC;IAED,sGAAsG;IACtG,MAAM,MAAM,GAAI,GAAW,CAAC,IAAI,EAAE,EAAE,IAAI,WAAW,CAAC;IACpD,MAAM,QAAQ,GAAG,eAAe,MAAM,IAAI,cAAc,EAAE,CAAC;IAE3D,IAAI,CAAC;QACH,6DAA6D;QAC7D,MAAM,cAAc,GAAG,CAAC,MAAM,oBAAK,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAmB,CAAC;QAErE,IAAI,cAAc,EAAE,CAAC;YACnB,eAAM,CAAC,IAAI,CAAC,EAAE,QAAQ,EAAE,IAAI,EAAE,GAAG,CAAC,IAAI,EAAE,EAAE,gDAAgD,CAAC,CAAC;YAC5F,GAAG,CAAC,SAAS,CAAC,mBAAmB,EAAE,MAAM,CAAC,CAAC;YAC3C,OAAO,GAAG,CAAC,MAAM,CAAC,cAAc,CAAC,MAAM,CAAC,CAAC,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,CAAC;QACrE,CAAC;QAED,sEAAsE;QACtE,MAAM,YAAY,GAAG,GAAG,CAAC,IAAI,CAAC;QAE9B,GAAG,CAAC,IAAI,GAAG,UAAU,IAAS;YAC5B,iCAAiC;YACjC,GAAG,CAAC,IAAI,GAAG,YAAY,CAAC;YAExB,iFAAiF;YACjF,iFAAiF;YACjF,IAAI,GAAG,CAAC,UAAU,GAAG,GAAG,EAAE,CAAC;gBACzB,0DAA0D;gBAC1D,oBAAK;qBACF,GAAG,CACF,QAAQ,EACR;oBACE,MAAM,EAAE,GAAG,CAAC,UAAU;oBACtB,IAAI;iBACL,EACD,EAAE,GAAG,EAAE,KAAK,EAAE,CACf;qBACA,KAAK,CAAC,GAAG,CAAC,EAAE;oBACX,eAAM,CAAC,KAAK,CAAC,EAAE,GAAG,EAAE,QAAQ,EAAE,EAAE,4CAA4C,CAAC,CAAC;gBAChF,CAAC,CAAC,CAAC;YACP,CAAC;YAED,OAAO,YAAY,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;QACvC,CAAC,CAAC;QAEF,GAAG,CAAC,SAAS,CAAC,mBAAmB,EAAE,OAAO,CAAC,CAAC;QAC5C,IAAI,EAAE,CAAC;IACT,CAAC;IAAC,OAAO,KAAK,EAAE,CAAC;QACf,eAAM,CAAC,KAAK,CAAC,EAAE,KAAK,EAAE,QAAQ,EAAE,EAAE,qCAAqC,CAAC,CAAC;QACzE,IAAI,EAAE,CAAC;IACT,CAAC;AACH,CAAC,CAAC;AAxDW,QAAA,qBAAqB,yBAwDhC","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\middleware\\idempotency.middleware.ts"],"sourcesContent":["import type { NextFunction, Request, Response } from 'express';\nimport { cache } from '../utils/cacheManager';\nimport { logger } from '../utils/logger';\n\n/**\n * Middleware de Idempotencia\n * Garantiza que peticiones repetidas con el mismo 'Idempotency-Key' retornen el mismo resultado\n * sin ejecutar la lógica de negocio múltiples veces.\n */\ninterface CachedResponse {\n  status: number;\n  body: any;\n}\n\nexport const idempotencyMiddleware = async (req: Request, res: Response, next: NextFunction) => {\n  const idempotencyKey = req.headers['idempotency-key'] as string;\n\n  // Solo aplicar si hay una clave y NO es un GET (las lecturas son idempotentes por naturaleza)\n  if (!idempotencyKey || req.method === 'GET') {\n    return next();\n  }\n\n  // Si el usuario está autenticado, incluimos su ID en el prefijo para evitar colisiones entre usuarios\n  const userId = (req as any).user?.id || 'anonymous';\n  const cacheKey = `idempotency:${userId}:${idempotencyKey}`;\n\n  try {\n    // 1. Intentar recuperar respuesta previa del caché (L1 o L2)\n    const cachedResponse = (await cache.get(cacheKey)) as CachedResponse;\n\n    if (cachedResponse) {\n      logger.info({ cacheKey, path: req.path }, 'Idempotency HIT: Retornando respuesta cacheada');\n      res.setHeader('X-Idempotency-Hit', 'true');\n      return res.status(cachedResponse.status).json(cachedResponse.body);\n    }\n\n    // 2. Interceptar res.json para guardar la respuesta antes de enviarla\n    const originalJson = res.json;\n\n    res.json = function (body: any): Response {\n      // Restauramos el método original\n      res.json = originalJson;\n\n      // Guardar en caché solo si la respuesta es exitosa o error de cliente (2xx, 4xx)\n      // Evitamos cachear errores de servidor (5xx) para permitir reintentos inmediatos\n      if (res.statusCode < 500) {\n        // TTL de 24 horas por defecto para llaves de idempotencia\n        cache\n          .set(\n            cacheKey,\n            {\n              status: res.statusCode,\n              body,\n            },\n            { ttl: 86400 },\n          )\n          .catch(err => {\n            logger.error({ err, cacheKey }, 'Error al guardar respuesta de idempotencia');\n          });\n      }\n\n      return originalJson.call(this, body);\n    };\n\n    res.setHeader('X-Idempotency-Hit', 'false');\n    next();\n  } catch (error) {\n    logger.error({ error, cacheKey }, 'Error en middleware de idempotencia');\n    next();\n  }\n};\n"],"version":3}