327b5e6c31f4373221e08fde7e9a2027
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = require("express");
const response_builder_1 = require("../common/response-builder");
const inversify_config_1 = require("../config/inversify.config");
const types_1 = require("../types");
// Middleware
const api_key_middleware_1 = require("../middleware/api-key.middleware");
const idempotency_middleware_1 = require("../middleware/idempotency.middleware");
const rate_limit_middleware_1 = require("../middleware/rate-limit.middleware");
const redis_cache_middleware_1 = require("../middleware/redis-cache.middleware");
const auth_middleware_1 = require("../middleware/auth.middleware");
const apiV1Router = (0, express_1.Router)();
// Middleware
apiV1Router.use(idempotency_middleware_1.idempotencyMiddleware);
apiV1Router.use(api_key_middleware_1.apiKeyAuth);
console.log('DEBUG: API V1 router loading with lazy-loaded sub-routers');
// Lazy-Loaded Routers to avoid top-level container.get / circular dependency issues
const lazy = (path) => (req, res, next) => {
    const router = require(path).default;
    if (typeof router === 'function') {
        return router(req, res, next);
    }
    // Handle cases where it might be a named export or already a router instance
    const r = router.router || router;
    return r(req, res, next);
};
// Mount Routes (Lazy)
apiV1Router.use('/auth', lazy('./auth.routes'));
apiV1Router.use('/docker', lazy('./docker.routes'));
apiV1Router.use('/personas', lazy('./persona.routes'));
apiV1Router.use('/swarm', lazy('./swarm.routes'));
apiV1Router.use('/webauthn', lazy('./webauthn.routes'));
apiV1Router.use('/sovereign', lazy('./sovereign-handshake.routes'));
apiV1Router.use('/users', lazy('./users.routes'));
apiV1Router.use('/health', lazy('./health.routes'));
apiV1Router.use('/stripe', lazy('./stripe.routes'));
apiV1Router.use('/youtube', lazy('./youtube.routes'));
// System Endpoints
apiV1Router.post('/system/credentials/verify', async (req, res) => {
    const requestId = req.requestId;
    try {
        const credManager = inversify_config_1.container.get(types_1.TYPES.CredentialManagerService);
        const report = await credManager.verifyAll();
        res.json((0, response_builder_1.buildResponse)(report, 200, requestId));
    }
    catch (err) {
        res.status(500).json((0, response_builder_1.buildError)('Verification failed', 'VERIFICATION_ERROR', 500, requestId));
    }
});
apiV1Router.get('/system/history/:metric', async (req, res) => {
    const requestId = req.requestId;
    try {
        const { metric } = req.params;
        const historyService = inversify_config_1.container.get(types_1.TYPES.HistoryService);
        const history = await historyService.getHistory(metric);
        res.json((0, response_builder_1.buildResponse)(history, 200, requestId));
    }
    catch (err) {
        res.status(500).json((0, response_builder_1.buildError)('Internal server error', 'INTERNAL_ERROR', 500, requestId));
    }
});
// Controllers (Lazy-ish resolution inside handlers)
apiV1Router.get('/usage/current', (0, redis_cache_middleware_1.redisCache)(60), (req, res, next) => {
    const { UsageController } = require('../controllers/usage.controller');
    const controller = inversify_config_1.container.get(types_1.TYPES.UsageController);
    return controller.getCurrentUsage(req, res, next);
});
apiV1Router.get('/billing/snapshot', auth_middleware_1.requireAuth, (0, redis_cache_middleware_1.redisCache)(300), (req, res, next) => {
    const controller = inversify_config_1.container.get(types_1.TYPES.BillingController);
    return controller.getBillingSnapshot(req, res, next);
});
apiV1Router.post('/billing/checkout', auth_middleware_1.requireAuth, (req, res, next) => {
    const controller = inversify_config_1.container.get(types_1.TYPES.BillingController);
    return controller.createCheckoutSession(req, res, next);
});
apiV1Router.post('/billing/portal', auth_middleware_1.requireAuth, (req, res, next) => {
    const controller = inversify_config_1.container.get(types_1.TYPES.BillingController);
    return controller.createPortalSession(req, res, next);
});
// Monitoring and AI (Lazy)
apiV1Router.use('/analytics', (0, redis_cache_middleware_1.redisCache)(30), lazy('./analytics.routes'));
apiV1Router.use('/enhanced-voice', lazy('./enhanced-voice.routes'));
apiV1Router.use('/daniela', lazy('./daniela.routes'));
apiV1Router.use('/ai', rate_limit_middleware_1.dynamicRateLimiter, lazy('./ai.routes'));
apiV1Router.use('/rag', lazy('./rag.routes'));
// System Management (Lazy)
apiV1Router.use('/system', lazy('./system.routes'));
apiV1Router.use('/social', lazy('./social.routes'));
apiV1Router.use('/logs', lazy('./logs.routes'));
apiV1Router.use('/security-dashboard', lazy('./security-dashboard.routes'));
apiV1Router.use('/waf', lazy('./waf.routes'));
apiV1Router.use('/malware-scanner', lazy('./malware-scanner.routes'));
apiV1Router.use('/threat-intelligence', lazy('./threat-intelligence.routes'));
apiV1Router.use('/behavior', lazy('./user-behavior.routes'));
apiV1Router.use('/device-posture', lazy('./device-posture.routes'));
apiV1Router.use('/nexus', lazy('./nexus.routes'));
apiV1Router.use('/god-mode', lazy('./godmode.routes'));
exports.default = apiV1Router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxyb3V0ZXNcXGFwaS12MS5yb3V0ZXMudHMiLCJtYXBwaW5ncyI6Ijs7QUFBQSxxQ0FBaUM7QUFDakMsaUVBQXVFO0FBQ3ZFLGlFQUF1RDtBQUd2RCxvQ0FBaUM7QUFFakMsYUFBYTtBQUNiLHlFQUE4RDtBQUM5RCxpRkFBNkU7QUFDN0UsK0VBQXlFO0FBQ3pFLGlGQUFrRTtBQUNsRSxtRUFBNEQ7QUFFNUQsTUFBTSxXQUFXLEdBQUcsSUFBQSxnQkFBTSxHQUFFLENBQUM7QUFFN0IsYUFBYTtBQUNiLFdBQVcsQ0FBQyxHQUFHLENBQUMsOENBQXFCLENBQUMsQ0FBQztBQUN2QyxXQUFXLENBQUMsR0FBRyxDQUFDLCtCQUFVLENBQUMsQ0FBQztBQUU1QixPQUFPLENBQUMsR0FBRyxDQUFDLDJEQUEyRCxDQUFDLENBQUM7QUFFekUsb0ZBQW9GO0FBQ3BGLE1BQU0sSUFBSSxHQUFHLENBQUMsSUFBWSxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQVEsRUFBRSxHQUFRLEVBQUUsSUFBUyxFQUFFLEVBQUU7SUFDL0QsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQztJQUNyQyxJQUFJLE9BQU8sTUFBTSxLQUFLLFVBQVUsRUFBRSxDQUFDO1FBQ2pDLE9BQU8sTUFBTSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUNELDZFQUE2RTtJQUM3RSxNQUFNLENBQUMsR0FBRyxNQUFNLENBQUMsTUFBTSxJQUFJLE1BQU0sQ0FBQztJQUNsQyxPQUFPLENBQUMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO0FBQzNCLENBQUMsQ0FBQztBQUVGLHNCQUFzQjtBQUN0QixXQUFXLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQztBQUNoRCxXQUFXLENBQUMsR0FBRyxD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Q0FBQyxDQUFDLENBQUM7QUFDdEUsV0FBVyxDQUFDLEdBQUcsQ0FBQyxzQkFBc0IsRUFBRSxJQUFJLENBQUMsOEJBQThCLENBQUMsQ0FBQyxDQUFDO0FBQzlFLFdBQVcsQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDLENBQUM7QUFDN0QsV0FBVyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsRUFBRSxJQUFJLENBQUMseUJBQXlCLENBQUMsQ0FBQyxDQUFDO0FBQ3BFLFdBQVcsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUM7QUFDbEQsV0FBVyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQztBQUV2RCxrQkFBZSxXQUFXLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxyb3V0ZXNcXGFwaS12MS5yb3V0ZXMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBidWlsZEVycm9yLCBidWlsZFJlc3BvbnNlIH0gZnJvbSAnLi4vY29tbW9uL3Jlc3BvbnNlLWJ1aWxkZXInO1xuaW1wb3J0IHsgY29udGFpbmVyIH0gZnJvbSAnLi4vY29uZmlnL2ludmVyc2lmeS5jb25maWcnO1xuaW1wb3J0IHsgQ3JlZGVudGlhbE1hbmFnZXJTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvY3JlZGVudGlhbC1tYW5hZ2VyLnNlcnZpY2UnO1xuaW1wb3J0IHsgSGlzdG9yeVNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9oaXN0b3J5LnNlcnZpY2UnO1xuaW1wb3J0IHsgVFlQRVMgfSBmcm9tICcuLi90eXBlcyc7XG5cbi8vIE1pZGRsZXdhcmVcbmltcG9ydCB7IGFwaUtleUF1dGggfSBmcm9tICcuLi9taWRkbGV3YXJlL2FwaS1rZXkubWlkZGxld2FyZSc7XG5pbXBvcnQgeyBpZGVtcG90ZW5jeU1pZGRsZXdhcmUgfSBmcm9tICcuLi9taWRkbGV3YXJlL2lkZW1wb3RlbmN5Lm1pZGRsZXdhcmUnO1xuaW1wb3J0IHsgZHluYW1pY1JhdGVMaW1pdGVyIH0gZnJvbSAnLi4vbWlkZGxld2FyZS9yYXRlLWxpbWl0Lm1pZGRsZXdhcmUnO1xuaW1wb3J0IHsgcmVkaXNDYWNoZSB9IGZyb20gJy4uL21pZGRsZXdhcmUvcmVkaXMtY2FjaGUubWlkZGxld2FyZSc7XG5pbXBvcnQgeyByZXF1aXJlQXV0aCB9IGZyb20gJy4uL21pZGRsZXdhcmUvYXV0aC5taWRkbGV3YXJlJztcblxuY29uc3QgYXBpVjFSb3V0ZXIgPSBSb3V0ZXIoKTtcblxuLy8gTWlkZGxld2FyZVxuYXBpVjFSb3V0ZXIudXNlKGlkZW1wb3RlbmN5TWlkZGxld2FyZSk7XG5hcGlWMVJvdXRlci51c2UoYXBpS2V5QXV0aCk7XG5cbmNvbnNvbGUubG9nKCdERUJVRzogQVBJIFYxIHJvdXRlciBsb2FkaW5nIHdpdGggbGF6eS1sb2FkZWQgc3ViLXJvdXRlcnMnKTtcblxuLy8gTGF6eS1Mb2FkZWQgUm91dGVycyB0byBhdm9pZCB0b3AtbGV2ZWwgY29udGFpbmVyLmdldCAvIGNpcmN1bGFyIGRlcGVuZGVuY3kgaXNzdWVzXG5jb25zdCBsYXp5ID0gKHBhdGg6IHN0cmluZykgPT4gKHJlcTogYW55LCByZXM6IGFueSwgbmV4dDogYW55KSA9PiB7XG4gIGNvbnN0IHJvdXRlciA9IHJlcXVpcmUocGF0aCkuZGVmYXVsdDtcbiAgaWYgKHR5cGVvZiByb3V0ZXIgPT09ICdmdW5jdGlvbicpIHtcbiAgICByZXR1cm4gcm91dGVyKHJlcSwgcmVzLCBuZXh0KTtcbiAgfVxuICAvLyBIYW5kbGUgY2FzZXMgd2hlcmUgaXQgbWlnaHQgYmUgYSBuYW1lZCBleHBvcnQgb3IgYWxyZWFkeSBhIHJvdXRlciBpbnN0YW5jZVxuICBjb25zdCByID0gcm91dGVyLnJvdXRlciB8fCByb3V0ZXI7XG4gIHJldHVybiByKHJlcSwgcmVzLCBuZXh0KTtcbn07XG5cbi8vIE1vdW50IFJvdXRlcyAoTGF6eSlcbmFwaVYxUm91dGVyLnVzZSgnL2F1dGgnLCBsYXp5KCcuL2F1dGgucm91dGVzJykpO1xuYXBpVjFSb3V0ZXIudXNlKCcvZG9ja2VyJywgbGF6eSgnLi9kb2NrZXIucm91dGVzJykpO1xuYXBpVjFSb3V0ZXIudXNlKCcvcGVyc29uYXMnLCBsYXp5KCcuL3BlcnNvbmEucm91dGVzJykpO1xuYXBpVjFSb3V0ZXIudXNlKCcvc3dhcm0nLCBsYXp5KCcuL3N3YXJtLnJvdXRlcycpKTtcbmFwaVYxUm91dGVyLnVzZSgnL3dlYmF1dGhuJywgbGF6eSgnLi93ZWJhdXRobi5yb3V0ZXMnKSk7XG5hcGlWMVJvdXRlci51c2UoJy9zb3ZlcmVpZ24nLCBsYXp5KCcuL3NvdmVyZWlnbi1oYW5kc2hha2Uucm91dGVzJykpO1xuYXBpVjFSb3V0ZXIudXNlKCcvdXNlcnMnLCBsYXp5KCcuL3VzZXJzLnJvdXRlcycpKTtcbmFwaVYxUm91dGVyLnVzZSgnL2hlYWx0aCcsIGxhenkoJy4vaGVhbHRoLnJvdXRlcycpKTtcbmFwaVYxUm91dGVyLnVzZSgnL3N0cmlwZScsIGxhenkoJy4vc3RyaXBlLnJvdXRlcycpKTtcbmFwaVYxUm91dGVyLnVzZSgnL3lvdXR1YmUnLCBsYXp5KCcuL3lvdXR1YmUucm91dGVzJykpO1xuXG4vLyBTeXN0ZW0gRW5kcG9pbnRzXG5hcGlWMVJvdXRlci5wb3N0KCcvc3lzdGVtL2NyZWRlbnRpYWxzL3ZlcmlmeScsIGFzeW5jIChyZXE6IGFueSwgcmVzOiBhbnkpID0+IHtcbiAgY29uc3QgcmVxdWVzdElkID0gcmVxLnJlcXVlc3RJZDtcbiAgdHJ5IHtcbiAgICBjb25zdCBjcmVkTWFuYWdlciA9IGNvbnRhaW5lci5nZXQ8Q3JlZGVudGlhbE1hbmFnZXJTZXJ2aWNlPihUWVBFUy5DcmVkZW50aWFsTWFuYWdlclNlcnZpY2UpO1xuICAgIGNvbnN0IHJlcG9ydCA9IGF3YWl0IGNyZWRNYW5hZ2VyLnZlcmlmeUFsbCgpO1xuICAgIHJlcy5qc29uKGJ1aWxkUmVzcG9uc2UocmVwb3J0LCAyMDAsIHJlcXVlc3RJZCkpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICByZXMuc3RhdHVzKDUwMCkuanNvbihidWlsZEVycm9yKCdWZXJpZmljYXRpb24gZmFpbGVkJywgJ1ZFUklGSUNBVElPTl9FUlJPUicsIDUwMCwgcmVxdWVzdElkKSk7XG4gIH1cbn0pO1xuXG5hcGlWMVJvdXRlci5nZXQoJy9zeXN0ZW0vaGlzdG9yeS86bWV0cmljJywgYXN5bmMgKHJlcTogYW55LCByZXM6IGFueSkgPT4ge1xuICBjb25zdCByZXF1ZXN0SWQgPSByZXEucmVxdWVzdElkO1xuICB0cnkge1xuICAgIGNvbnN0IHsgbWV0cmljIH0gPSByZXEucGFyYW1zO1xuICAgIGNvbnN0IGhpc3RvcnlTZXJ2aWNlID0gY29udGFpbmVyLmdldDxIaXN0b3J5U2VydmljZT4oVFlQRVMuSGlzdG9yeVNlcnZpY2UpO1xuICAgIGNvbnN0IGhpc3RvcnkgPSBhd2FpdCBoaXN0b3J5U2VydmljZS5nZXRIaXN0b3J5KG1ldHJpYyk7XG4gICAgcmVzLmpzb24oYnVpbGRSZXNwb25zZShoaXN0b3J5LCAyMDAsIHJlcXVlc3RJZCkpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICByZXMuc3RhdHVzKDUwMCkuanNvbihidWlsZEVycm9yKCdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InLCAnSU5URVJOQUxfRVJST1InLCA1MDAsIHJlcXVlc3RJZCkpO1xuICB9XG59KTtcblxuLy8gQ29udHJvbGxlcnMgKExhenktaXNoIHJlc29sdXRpb24gaW5zaWRlIGhhbmRsZXJzKVxuYXBpVjFSb3V0ZXIuZ2V0KCcvdXNhZ2UvY3VycmVudCcsIHJlZGlzQ2FjaGUoNjApLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgY29uc3QgeyBVc2FnZUNvbnRyb2xsZXIgfSA9IHJlcXVpcmUoJy4uL2NvbnRyb2xsZXJzL3VzYWdlLmNvbnRyb2xsZXInKTtcbiAgY29uc3QgY29udHJvbGxlciA9IGNvbnRhaW5lci5nZXQ8YW55PihUWVBFUy5Vc2FnZUNvbnRyb2xsZXIpO1xuICByZXR1cm4gY29udHJvbGxlci5nZXRDdXJyZW50VXNhZ2UocmVxLCByZXMsIG5leHQpO1xufSk7XG5cbmFwaVYxUm91dGVyLmdldCgnL2JpbGxpbmcvc25hcHNob3QnLCByZXF1aXJlQXV0aCwgcmVkaXNDYWNoZSgzMDApLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgY29uc3QgY29udHJvbGxlciA9IGNvbnRhaW5lci5nZXQ8YW55PihUWVBFUy5CaWxsaW5nQ29udHJvbGxlcik7XG4gIHJldHVybiBjb250cm9sbGVyLmdldEJpbGxpbmdTbmFwc2hvdChyZXEsIHJlcywgbmV4dCk7XG59KTtcblxuYXBpVjFSb3V0ZXIucG9zdCgnL2JpbGxpbmcvY2hlY2tvdXQnLCByZXF1aXJlQXV0aCwgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gIGNvbnN0IGNvbnRyb2xsZXIgPSBjb250YWluZXIuZ2V0PGFueT4oVFlQRVMuQmlsbGluZ0NvbnRyb2xsZXIpO1xuICByZXR1cm4gY29udHJvbGxlci5jcmVhdGVDaGVja291dFNlc3Npb24ocmVxLCByZXMsIG5leHQpO1xufSk7XG5cbmFwaVYxUm91dGVyLnBvc3QoJy9iaWxsaW5nL3BvcnRhbCcsIHJlcXVpcmVBdXRoLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgY29uc3QgY29udHJvbGxlciA9IGNvbnRhaW5lci5nZXQ8YW55PihUWVBFUy5CaWxsaW5nQ29udHJvbGxlcik7XG4gIHJldHVybiBjb250cm9sbGVyLmNyZWF0ZVBvcnRhbFNlc3Npb24ocmVxLCByZXMsIG5leHQpO1xufSk7XG5cbi8vIE1vbml0b3JpbmcgYW5kIEFJIChMYXp5KVxuYXBpVjFSb3V0ZXIudXNlKCcvYW5hbHl0aWNzJywgcmVkaXNDYWNoZSgzMCksIGxhenkoJy4vYW5hbHl0aWNzLnJvdXRlcycpKTtcbmFwaVYxUm91dGVyLnVzZSgnL2VuaGFuY2VkLXZvaWNlJywgbGF6eSgnLi9lbmhhbmNlZC12b2ljZS5yb3V0ZXMnKSk7XG5hcGlWMVJvdXRlci51c2UoJy9kYW5pZWxhJywgbGF6eSgnLi9kYW5pZWxhLnJvdXRlcycpKTtcbmFwaVYxUm91dGVyLnVzZSgnL2FpJywgZHluYW1pY1JhdGVMaW1pdGVyLCBsYXp5KCcuL2FpLnJvdXRlcycpKTtcbmFwaVYxUm91dGVyLnVzZSgnL3JhZycsIGxhenkoJy4vcmFnLnJvdXRlcycpKTtcblxuLy8gU3lzdGVtIE1hbmFnZW1lbnQgKExhenkpXG5hcGlWMVJvdXRlci51c2UoJy9zeXN0ZW0nLCBsYXp5KCcuL3N5c3RlbS5yb3V0ZXMnKSk7XG5hcGlWMVJvdXRlci51c2UoJy9zb2NpYWwnLCBsYXp5KCcuL3NvY2lhbC5yb3V0ZXMnKSk7XG5hcGlWMVJvdXRlci51c2UoJy9sb2dzJywgbGF6eSgnLi9sb2dzLnJvdXRlcycpKTtcbmFwaVYxUm91dGVyLnVzZSgnL3NlY3VyaXR5LWRhc2hib2FyZCcsIGxhenkoJy4vc2VjdXJpdHktZGFzaGJvYXJkLnJvdXRlcycpKTtcbmFwaVYxUm91dGVyLnVzZSgnL3dhZicsIGxhenkoJy4vd2FmLnJvdXRlcycpKTtcbmFwaVYxUm91dGVyLnVzZSgnL21hbHdhcmUtc2Nhbm5lcicsIGxhenkoJy4vbWFsd2FyZS1zY2FubmVyLnJvdXRlcycpKTtcbmFwaVYxUm91dGVyLnVzZSgnL3RocmVhdC1pbnRlbGxpZ2VuY2UnLCBsYXp5KCcuL3RocmVhdC1pbnRlbGxpZ2VuY2Uucm91dGVzJykpO1xuYXBpVjFSb3V0ZXIudXNlKCcvYmVoYXZpb3InLCBsYXp5KCcuL3VzZXItYmVoYXZpb3Iucm91dGVzJykpO1xuYXBpVjFSb3V0ZXIudXNlKCcvZGV2aWNlLXBvc3R1cmUnLCBsYXp5KCcuL2RldmljZS1wb3N0dXJlLnJvdXRlcycpKTtcbmFwaVYxUm91dGVyLnVzZSgnL25leHVzJywgbGF6eSgnLi9uZXh1cy5yb3V0ZXMnKSk7XG5hcGlWMVJvdXRlci51c2UoJy9nb2QtbW9kZScsIGxhenkoJy4vZ29kbW9kZS5yb3V0ZXMnKSk7XG5cbmV4cG9ydCBkZWZhdWx0IGFwaVYxUm91dGVyO1xuIl0sInZlcnNpb24iOjN9