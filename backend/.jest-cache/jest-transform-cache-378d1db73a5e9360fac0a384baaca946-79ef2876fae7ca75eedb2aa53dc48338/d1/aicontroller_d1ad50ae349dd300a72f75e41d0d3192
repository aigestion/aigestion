698873fc0012ecf119433aae5d4c269e
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.streamChat = exports.runPrompt = void 0;
const inversify_config_1 = require("../config/inversify.config");
const response_builder_1 = require("../common/response-builder");
const validation_middleware_1 = require("../middleware/validation.middleware");
const types_1 = require("../types");
exports.runPrompt = [
    (0, validation_middleware_1.validate)({ body: validation_middleware_1.schemas.ai.prompt }),
    async (req, res, next) => {
        try {
            const { prompt } = req.body;
            const userId = req.user?.id || 'anonymous';
            // Get the service from the container to ensure dependencies (Analytics, Search, etc.) are injected
            const aiService = inversify_config_1.container.get(types_1.TYPES.AIService);
            const rateLimitService = inversify_config_1.container.get(types_1.TYPES.RateLimitService);
            // God Mode: Bypass rate limits for admin/god
            const userRole = req.user?.role;
            if (userRole !== 'god' && userRole !== 'admin') {
                // Rate Limit: 10 requests per minute for prompts
                await rateLimitService.incrementAndCheck(`ai_prompt:${userId}`, 10, 60);
            }
            const result = await aiService.generateContent(prompt, userId, userRole);
            res.json((0, response_builder_1.buildResponse)(result, 200, req.requestId || 'unknown'));
        }
        catch (err) {
            next(err);
        }
    },
];
exports.streamChat = [
    (0, validation_middleware_1.validate)({ body: validation_middleware_1.schemas.ai.chat }),
    async (req, res, next) => {
        try {
            const { prompt, history } = req.body;
            const userId = req.user?.id || 'anonymous';
            const aiService = inversify_config_1.container.get(types_1.TYPES.AIService);
            const rateLimitService = inversify_config_1.container.get(types_1.TYPES.RateLimitService);
            // God Mode: Bypass rate limits for admin/god
            const userRole = req.user?.role;
            if (userRole !== 'god' && userRole !== 'admin') {
                // Rate Limit: 20 requests per minute for chat sessions
                await rateLimitService.incrementAndCheck(`ai_chat:${userId}`, 20, 60);
            }
            // Set headers for SSE
            res.setHeader('Content-Type', 'text/event-stream');
            res.setHeader('Cache-Control', 'no-cache');
            res.setHeader('Connection', 'keep-alive');
            try {
                const stream = await aiService.streamChat({ prompt, history, userId, userRole });
                for await (const chunk of stream) {
                    res.write(chunk);
                }
                res.write('data: [DONE]\n\n');
                res.end();
            }
            catch (streamError) {
                console.error('Streaming error:', streamError);
                res.write(`data: ${JSON.stringify({ type: 'error', content: 'Streaming failed' })}\n\n`);
                res.end();
            }
        }
        catch (err) {
            next(err);
        }
    },
];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxjb250cm9sbGVyc1xcYWkuY29udHJvbGxlci50cyIsIm1hcHBpbmdzIjoiOzs7QUFHQSxpRUFBdUQ7QUFDdkQsaUVBQTJEO0FBQzNELCtFQUF3RTtBQUV4RSxvQ0FBaUM7QUFHcEIsUUFBQSxTQUFTLEdBQUc7SUFDdkIsSUFBQSxnQ0FBUSxFQUFDLEVBQUUsSUFBSSxFQUFFLCtCQUFPLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQ3JDLEtBQUssRUFBRSxHQUFZLEVBQUUsR0FBYSxFQUFFLElBQWtCLEVBQUUsRUFBRTtRQUN4RCxJQUFJLENBQUM7WUFDSCxNQUFNLEVBQUUsTUFBTSxFQUFFLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQztZQUM1QixNQUFNLE1BQU0sR0FBSSxHQUFXLENBQUMsSUFBSSxFQUFFLEVBQUUsSUFBSSxXQUFXLENBQUM7WUFDcEQsbUdBQW1HO1lBQ25HLE1BQU0sU0FBUyxHQUFHLDRCQUFTLENBQUMsR0FBRyxDQUFZLGFBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUM1RCxNQUFNLGdCQUFnQixHQUFHLDRCQUFTLENBQUMsR0FBRyxDQUFtQixhQUFLLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztZQUVqRiw2Q0FBNkM7WUFDN0MsTUFBTSxRQUFRLEdBQUksR0FBVyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUM7WUFDekMsSUFBSSxRQUFRLEtBQUssS0FBSyxJQUFJLFFBQVEsS0FBSyxPQUFPLEVBQUUsQ0FBQztnQkFDL0MsaURBQWlEO2dCQUNqRCxNQUFNLGdCQUFnQixDQUFDLGlCQUFpQixDQUFDLGFBQWEsTUFBTSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQzFFLENBQUM7WUFFRCxNQUFNLE1BQU0sR0FBRyxNQUFNLFNBQVMsQ0FBQyxlQUFlLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxRQUFRLENBQUMsQ0FBQztZQUN6RSxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUEsZ0NBQWEsRUFBQyxNQUFNLEVBQUUsR0FBRyxFQUFHLEdBQVcsQ0FBQyxTQUFTLElBQUksU0FBUyxDQUFDLENBQUMsQ0FBQztRQUM1RSxDQUFDO1FBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztZQUNiLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNaLENBQUM7SUFDSCxDQUFDO0NBQ0YsQ0FBQztBQUVXLFFBQUEsVUFBVSxHQUFHO0lBQ3hCLElBQUEsZ0NBQVEsRUFBQyxFQUFFLElBQUksRUFBRSwrQkFBTyxDQUFDLEVBQUUsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNuQyxLQUFLLEVBQUUsR0FBWSxFQUFFLEdBQWEsRUFBRSxJQUFrQixFQUFFLEVBQUU7UUFDeEQsSUFBSSxDQUFDO1lBQ0gsTUFBTSxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1lBQ3JDLE1BQU0sTUFBTSxHQUFJLEdBQVcsQ0FBQyxJQUFJLEVBQUUsRUFBRSxJQUFJLFdBQVcsQ0FBQztZQUNwRCxNQUFNLFNBQVMsR0FBRyw0QkFBUyxDQUFDLEdBQUcsQ0FBWSxhQUFLLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDNUQsTUFBTSxnQkFBZ0IsR0FBRyw0QkFBUyxDQUFDLEdBQUcsQ0FBbUIsYUFBSyxDQUFDLGdCQUFnQixDQUFDLENBQUM7WUFFakYsNkNBQTZDO1lBQzdDLE1BQU0sUUFBUSxHQUFJLEdBQVcsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDO1lBQ3pDLElBQUksUUFBUSxLQUFLLEtBQUssSUFBSSxRQUFRLEtBQUssT0FBTyxFQUFFLENBQUM7Z0JBQy9DLHVEQUF1RDtnQkFDdkQsTUFBTSxnQkFBZ0IsQ0FBQyxpQkFBaUIsQ0FBQyxXQUFXLE1BQU0sRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUN4RSxDQUFDO1lBRUQsc0JBQXNCO1lBQ3RCLEdBQUcsQ0FBQyxTQUFTLENBQUMsY0FBYyxFQUFFLG1CQUFtQixDQUFDLENBQUM7WUFDbkQsR0FBRyxDQUFDLFNBQVMsQ0FBQyxlQUFlLEVBQUUsVUFBVSxDQUFDLENBQUM7WUFDM0MsR0FBRyxDQUFDLFNBQVMsQ0FBQyxZQUFZLEVBQUUsWUFBWSxDQUFDLENBQUM7WUFFMUMsSUFBSSxDQUFDO2dCQUNILE1BQU0sTUFBTSxHQUFHLE1BQU0sU0FBUyxDQUFDLFVBQVUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUM7Z0JBRWpGLElBQUksS0FBSyxFQUFFLE1BQU0sS0FBSyxJQUFJLE1BQU0sRUFBRSxDQUFDO29CQUNqQyxHQUFHLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUNuQixDQUFDO2dCQUVELEdBQUcsQ0FBQyxLQUFLLENBQUMsa0JBQWtCLENBQUMsQ0FBQztnQkFDOUIsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQ1osQ0FBQztZQUFDLE9BQU8sV0FBVyxFQUFFLENBQUM7Z0JBQ3JCLE9BQU8sQ0FBQyxLQUFLLENBQUMsa0JBQWtCLEVBQUUsV0FBVyxDQUFDLENBQUM7Z0JBQy9DLEdBQUcsQ0FBQyxLQUFLLENBQUMsU0FBUyxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDekYsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQ1osQ0FBQztRQUNILENBQUM7UUFBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO1lBQ2IsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ1osQ0FBQztJQUNILENBQUM7Q0FDRixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcQWxlamFuZHJvXFxBSUdlc3Rpb25cXGJhY2tlbmRcXHNyY1xcY29udHJvbGxlcnNcXGFpLmNvbnRyb2xsZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gc3JjL2NvbnRyb2xsZXJzL2FpLmNvbnRyb2xsZXIudHNcbmltcG9ydCB0eXBlIHsgTmV4dEZ1bmN0aW9uLCBSZXF1ZXN0LCBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnO1xuXG5pbXBvcnQgeyBjb250YWluZXIgfSBmcm9tICcuLi9jb25maWcvaW52ZXJzaWZ5LmNvbmZpZyc7XG5pbXBvcnQgeyBidWlsZFJlc3BvbnNlIH0gZnJvbSAnLi4vY29tbW9uL3Jlc3BvbnNlLWJ1aWxkZXInO1xuaW1wb3J0IHsgdmFsaWRhdGUsIHNjaGVtYXMgfSBmcm9tICcuLi9taWRkbGV3YXJlL3ZhbGlkYXRpb24ubWlkZGxld2FyZSc7XG5pbXBvcnQgeyBBSVNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9haS5zZXJ2aWNlJztcbmltcG9ydCB7IFRZUEVTIH0gZnJvbSAnLi4vdHlwZXMnO1xuaW1wb3J0IHsgUmF0ZUxpbWl0U2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL3JhdGUtbGltaXQuc2VydmljZSc7XG5cbmV4cG9ydCBjb25zdCBydW5Qcm9tcHQgPSBbXG4gIHZhbGlkYXRlKHsgYm9keTogc2NoZW1hcy5haS5wcm9tcHQgfSksXG4gIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IHByb21wdCB9ID0gcmVxLmJvZHk7XG4gICAgICBjb25zdCB1c2VySWQgPSAocmVxIGFzIGFueSkudXNlcj8uaWQgfHwgJ2Fub255bW91cyc7XG4gICAgICAvLyBHZXQgdGhlIHNlcnZpY2UgZnJvbSB0aGUgY29udGFpbmVyIHRvIGVuc3VyZSBkZXBlbmRlbmNpZXMgKEFuYWx5dGljcywgU2VhcmNoLCBldGMuKSBhcmUgaW5qZWN0ZWRcbiAgICAgIGNvbnN0IGFpU2VydmljZSA9IGNvbnRhaW5lci5nZXQ8QUlTZXJ2aWNlPihUWVBFUy5BSVNlcnZpY2UpO1xuICAgICAgY29uc3QgcmF0ZUxpbWl0U2VydmljZSA9IGNvbnRhaW5lci5nZXQ8UmF0ZUxpbWl0U2VydmljZT4oVFlQRVMuUmF0ZUxpbWl0U2VydmljZSk7XG5cbiAgICAgIC8vIEdvZCBNb2RlOiBCeXBhc3MgcmF0ZSBsaW1pdHMgZm9yIGFkbWluL2dvZFxuICAgICAgY29uc3QgdXNlclJvbGUgPSAocmVxIGFzIGFueSkudXNlcj8ucm9sZTtcbiAgICAgIGlmICh1c2VyUm9sZSAhPT0gJ2dvZCcgJiYgdXNlclJvbGUgIT09ICdhZG1pbicpIHtcbiAgICAgICAgLy8gUmF0ZSBMaW1pdDogMTAgcmVxdWVzdHMgcGVyIG1pbnV0ZSBmb3IgcHJvbXB0c1xuICAgICAgICBhd2FpdCByYXRlTGltaXRTZXJ2aWNlLmluY3JlbWVudEFuZENoZWNrKGBhaV9wcm9tcHQ6JHt1c2VySWR9YCwgMTAsIDYwKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgYWlTZXJ2aWNlLmdlbmVyYXRlQ29udGVudChwcm9tcHQsIHVzZXJJZCwgdXNlclJvbGUpO1xuICAgICAgcmVzLmpzb24oYnVpbGRSZXNwb25zZShyZXN1bHQsIDIwMCwgKHJlcSBhcyBhbnkpLnJlcXVlc3RJZCB8fCAndW5rbm93bicpKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIG5leHQoZXJyKTtcbiAgICB9XG4gIH0sXG5dO1xuXG5leHBvcnQgY29uc3Qgc3RyZWFtQ2hhdCA9IFtcbiAgdmFsaWRhdGUoeyBib2R5OiBzY2hlbWFzLmFpLmNoYXQgfSksXG4gIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IHByb21wdCwgaGlzdG9yeSB9ID0gcmVxLmJvZHk7XG4gICAgICBjb25zdCB1c2VySWQgPSAocmVxIGFzIGFueSkudXNlcj8uaWQgfHwgJ2Fub255bW91cyc7XG4gICAgICBjb25zdCBhaVNlcnZpY2UgPSBjb250YWluZXIuZ2V0PEFJU2VydmljZT4oVFlQRVMuQUlTZXJ2aWNlKTtcbiAgICAgIGNvbnN0IHJhdGVMaW1pdFNlcnZpY2UgPSBjb250YWluZXIuZ2V0PFJhdGVMaW1pdFNlcnZpY2U+KFRZUEVTLlJhdGVMaW1pdFNlcnZpY2UpO1xuXG4gICAgICAvLyBHb2QgTW9kZTogQnlwYXNzIHJhdGUgbGltaXRzIGZvciBhZG1pbi9nb2RcbiAgICAgIGNvbnN0IHVzZXJSb2xlID0gKHJlcSBhcyBhbnkpLnVzZXI/LnJvbGU7XG4gICAgICBpZiAodXNlclJvbGUgIT09ICdnb2QnICYmIHVzZXJSb2xlICE9PSAnYWRtaW4nKSB7XG4gICAgICAgIC8vIFJhdGUgTGltaXQ6IDIwIHJlcXVlc3RzIHBlciBtaW51dGUgZm9yIGNoYXQgc2Vzc2lvbnNcbiAgICAgICAgYXdhaXQgcmF0ZUxpbWl0U2VydmljZS5pbmNyZW1lbnRBbmRDaGVjayhgYWlfY2hhdDoke3VzZXJJZH1gLCAyMCwgNjApO1xuICAgICAgfVxuXG4gICAgICAvLyBTZXQgaGVhZGVycyBmb3IgU1NFXG4gICAgICByZXMuc2V0SGVhZGVyKCdDb250ZW50LVR5cGUnLCAndGV4dC9ldmVudC1zdHJlYW0nKTtcbiAgICAgIHJlcy5zZXRIZWFkZXIoJ0NhY2hlLUNvbnRyb2wnLCAnbm8tY2FjaGUnKTtcbiAgICAgIHJlcy5zZXRIZWFkZXIoJ0Nvbm5lY3Rpb24nLCAna2VlcC1hbGl2ZScpO1xuXG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBzdHJlYW0gPSBhd2FpdCBhaVNlcnZpY2Uuc3RyZWFtQ2hhdCh7IHByb21wdCwgaGlzdG9yeSwgdXNlcklkLCB1c2VyUm9sZSB9KTtcblxuICAgICAgICBmb3IgYXdhaXQgKGNvbnN0IGNodW5rIG9mIHN0cmVhbSkge1xuICAgICAgICAgIHJlcy53cml0ZShjaHVuayk7XG4gICAgICAgIH1cblxuICAgICAgICByZXMud3JpdGUoJ2RhdGE6IFtET05FXVxcblxcbicpO1xuICAgICAgICByZXMuZW5kKCk7XG4gICAgICB9IGNhdGNoIChzdHJlYW1FcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKCdTdHJlYW1pbmcgZXJyb3I6Jywgc3RyZWFtRXJyb3IpO1xuICAgICAgICByZXMud3JpdGUoYGRhdGE6ICR7SlNPTi5zdHJpbmdpZnkoeyB0eXBlOiAnZXJyb3InLCBjb250ZW50OiAnU3RyZWFtaW5nIGZhaWxlZCcgfSl9XFxuXFxuYCk7XG4gICAgICAgIHJlcy5lbmQoKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIG5leHQoZXJyKTtcbiAgICB9XG4gIH0sXG5dO1xuIl0sInZlcnNpb24iOjN9