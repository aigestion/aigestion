{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\middleware\\security.middleware.ts","mappings":";;;;;;AACA,4EAA2C;AAC3C,oDAA4B;AAE5B;;;GAGG;AACI,MAAM,iBAAiB,GAAG,CAAC,QAAgB,EAAE,GAAW,EAAE,OAAgB,EAAE,EAAE;IACnF,OAAO,IAAA,4BAAS,EAAC;QACf,QAAQ;QACR,GAAG;QACH,OAAO,EAAE;YACP,KAAK,EAAE,mBAAmB;YAC1B,OAAO,EAAE,OAAO,IAAI,gCAAgC,GAAG,iBAAiB,QAAQ,KAAK;YACrF,UAAU,EAAE,IAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;SACvC;QACD,eAAe,EAAE,IAAI;QACrB,aAAa,EAAE,KAAK;KACrB,CAAC,CAAC;AACL,CAAC,CAAC;AAZW,QAAA,iBAAiB,qBAY5B;AAEF;;GAEG;AACU,QAAA,YAAY,GAAG;IAC1B,0CAA0C;IAC1C,IAAI,EAAE,IAAA,yBAAiB,EACrB,EAAE,GAAG,EAAE,GAAG,IAAI,EAAE,aAAa;IAC7B,GAAG,EACH,6DAA6D,CAC9D;IAED,0CAA0C;IAC1C,GAAG,EAAE,IAAA,yBAAiB,EACpB,EAAE,GAAG,EAAE,GAAG,IAAI,EAAE,aAAa;IAC7B,IAAI,EACJ,+BAA+B,CAChC;IAED,kDAAkD;IAClD,UAAU,EAAE,IAAA,yBAAiB,EAC3B,EAAE,GAAG,EAAE,GAAG,IAAI,EAAE,aAAa;IAC7B,KAAK,EACL,sCAAsC,CACvC;IAED,6CAA6C;IAC7C,IAAI,EAAE,IAAA,yBAAiB,EACrB,EAAE,GAAG,EAAE,GAAG,IAAI,EAAE,aAAa;IAC7B,CAAC,EACD,2DAA2D,CAC5D;IAED,iCAAiC;IACjC,EAAE,EAAE,IAAA,yBAAiB,EACnB,CAAC,GAAG,EAAE,GAAG,IAAI,EAAE,WAAW;IAC1B,EAAE,EACF,4EAA4E,CAC7E;IAED,6CAA6C;IAC7C,MAAM,EAAE,IAAA,yBAAiB,EACvB,EAAE,GAAG,EAAE,GAAG,IAAI,EAAE,SAAS;IACzB,EAAE,EACF,sEAAsE,CACvE;CACF,CAAC;AAEF;;GAEG;AACI,MAAM,gBAAgB,GAAG,CAAC,GAAY,EAAE,GAAa,EAAE,IAAkB,EAAE,EAAE;IAClF,+DAA+D;IAC/D,MAAM,QAAQ,GAAI,GAAW,CAAC,IAAI,EAAE,IAAI,IAAI,MAAM,CAAC;IAEnD,iCAAiC;IACjC,MAAM,OAAO,GAAG,oBAAY,CAAC,QAAQ,CAAC,IAAI,oBAAY,CAAC,IAAI,CAAC;IAC5D,OAAO,OAAO,CAAC,GAAG,EAAE,GAAG,EAAE,IAAI,CAAC,CAAC;AACjC,CAAC,CAAC;AAPW,QAAA,gBAAgB,oBAO3B;AAEF;;GAEG;AACU,QAAA,eAAe,GAAG,IAAA,gBAAM,EAAC;IACpC,0BAA0B;IAC1B,qBAAqB,EAAE;QACrB,UAAU,EAAE;YACV,UAAU,EAAE,CAAC,QAAQ,CAAC;YACtB,SAAS,EAAE,CAAC,QAAQ,EAAE,eAAe,CAAC;YACtC,QAAQ,EAAE,CAAC,QAAQ,EAAE,iBAAiB,EAAE,sBAAsB,CAAC;YAC/D,MAAM,EAAE,CAAC,QAAQ,EAAE,OAAO,EAAE,QAAQ,EAAE,OAAO,CAAC;YAC9C,UAAU,EAAE;gBACV,QAAQ;gBACR,KAAK;gBACL,MAAM;gBACN,gBAAgB;gBAChB,mBAAmB;gBACnB,gBAAgB;gBAChB,yBAAyB;gBACzB,aAAa;aACd;YACD,OAAO,EAAE,CAAC,QAAQ,EAAE,mBAAmB,EAAE,OAAO,CAAC;YACjD,SAAS,EAAE,CAAC,QAAQ,CAAC;YACrB,QAAQ,EAAE,CAAC,QAAQ,CAAC;YACpB,QAAQ,EAAE,CAAC,QAAQ,CAAC;YACpB,QAAQ,EAAE,CAAC,QAAQ,CAAC;YACpB,SAAS,EAAE,CAAC,QAAQ,EAAE,OAAO,CAAC;YAC9B,WAAW,EAAE,CAAC,QAAQ,CAAC;YACvB,uBAAuB,EAAE,EAAE;SAC5B;KACF;IAED,yBAAyB;IACzB,yBAAyB,EAAE,KAAK;IAChC,uBAAuB,EAAE,EAAE,MAAM,EAAE,aAAa,EAAE;IAClD,yBAAyB,EAAE,EAAE,MAAM,EAAE,cAAc,EAAE;IACrD,kBAAkB,EAAE,EAAE,KAAK,EAAE,KAAK,EAAE;IACpC,UAAU,EAAE,EAAE,MAAM,EAAE,MAAM,EAAE;IAC9B,aAAa,EAAE,IAAI;IACnB,IAAI,EAAE;QACJ,MAAM,EAAE,QAAQ;QAChB,iBAAiB,EAAE,IAAI;QACvB,OAAO,EAAE,IAAI;KACd;IACD,QAAQ,EAAE,IAAI;IACd,OAAO,EAAE,IAAI;IACb,kBAAkB,EAAE,IAAI;IACxB,4BAA4B,EAAE,KAAK;IACnC,cAAc,EAAE,EAAE,MAAM,EAAE,aAAa,EAAE;IACzC,SAAS,EAAE,IAAI;CAChB,CAAC,CAAC;AAEH;;GAEG;AACI,MAAM,UAAU,GAAG,CAAC,GAAY,EAAE,GAAa,EAAE,IAAkB,EAAE,EAAE;IAC5E,MAAM,QAAQ,GAAG,CAAC,GAAG,CAAC,EAAE,IAAI,GAAG,CAAC,UAAU,CAAC,aAAa,IAAI,SAAS,CAAW,CAAC;IAEjF,0EAA0E;IAC1E,MAAM,UAAU,GAAG,IAAI,GAAG,EAAU,CAAC;IAErC,IAAI,UAAU,CAAC,GAAG,CAAC,QAAQ,CAAC,EAAE,CAAC;QAC7B,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;YAC1B,KAAK,EAAE,WAAW;YAClB,OAAO,EAAE,qCAAqC;SAC/C,CAAC,CAAC;IACL,CAAC;IAED,gCAAgC;IAChC,MAAM,SAAS,GAAG,GAAG,CAAC,GAAG,CAAC,YAAY,CAAC,IAAI,EAAE,CAAC;IAC9C,MAAM,kBAAkB,GAAG,CAAC,MAAM,EAAE,UAAU,EAAE,UAAU,EAAE,SAAS,EAAE,QAAQ,CAAC,CAAC;IACjF,MAAM,YAAY,GAAG,kBAAkB,CAAC,IAAI,CAAC,OAAO,CAAC,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC;IAEjF,IAAI,YAAY,EAAE,CAAC;QACjB,OAAO,CAAC,IAAI,CAAC,8BAA8B,EAAE;YAC3C,EAAE,EAAE,QAAQ;YACZ,SAAS;YACT,IAAI,EAAE,GAAG,CAAC,IAAI;YACd,SAAS,EAAE,IAAI,IAAI,EAAE,CAAC,WAAW,EAAE;SACpC,CAAC,CAAC;QAEH,uDAAuD;QACvD,OAAO,oBAAY,CAAC,IAAI,CAAC,GAAG,EAAE,GAAG,EAAE,IAAI,CAAC,CAAC;IAC3C,CAAC;IAED,IAAI,EAAE,CAAC;AACT,CAAC,CAAC;AA/BW,QAAA,UAAU,cA+BrB;AAEF;;GAEG;AACI,MAAM,gBAAgB,GAAG,CAAC,UAAkB,MAAM,EAAE,EAAE;IAC3D,OAAO,CAAC,GAAY,EAAE,GAAa,EAAE,IAAkB,EAAE,EAAE;QACzD,MAAM,aAAa,GAAG,GAAG,CAAC,GAAG,CAAC,gBAAgB,CAAC,CAAC;QAEhD,IAAI,aAAa,EAAE,CAAC;YAClB,MAAM,WAAW,GAAG,QAAQ,CAAC,aAAa,CAAC,CAAC;YAC5C,MAAM,cAAc,GAAG,SAAS,CAAC,OAAO,CAAC,CAAC;YAE1C,IAAI,WAAW,GAAG,cAAc,EAAE,CAAC;gBACjC,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;oBAC1B,KAAK,EAAE,mBAAmB;oBAC1B,OAAO,EAAE,gDAAgD,OAAO,GAAG;iBACpE,CAAC,CAAC;YACL,CAAC;QACH,CAAC;QAED,IAAI,EAAE,CAAC;IACT,CAAC,CAAC;AACJ,CAAC,CAAC;AAlBW,QAAA,gBAAgB,oBAkB3B;AAEF;;GAEG;AACH,SAAS,SAAS,CAAC,IAAY;IAC7B,MAAM,KAAK,GAA8B;QACvC,CAAC,EAAE,CAAC;QACJ,EAAE,EAAE,IAAI;QACR,EAAE,EAAE,IAAI,GAAG,IAAI;QACf,EAAE,EAAE,IAAI,GAAG,IAAI,GAAG,IAAI;KACvB,CAAC;IAEF,MAAM,KAAK,GAAG,IAAI,CAAC,WAAW,EAAE,CAAC,KAAK,CAAC,qBAAqB,CAAC,CAAC;IAC9D,IAAI,CAAC,KAAK,EAAE,CAAC;QACX,MAAM,IAAI,KAAK,CAAC,wBAAwB,IAAI,EAAE,CAAC,CAAC;IAClD,CAAC;IAED,MAAM,CAAC,EAAE,KAAK,EAAE,IAAI,CAAC,GAAG,KAAK,CAAC;IAC9B,OAAO,QAAQ,CAAC,KAAK,CAAC,GAAG,KAAK,CAAC,IAAI,CAAC,CAAC;AACvC,CAAC;AAED;;GAEG;AACI,MAAM,eAAe,GAAG,CAAC,GAAY,EAAE,GAAa,EAAE,IAAkB,EAAE,EAAE;IACjF,MAAM,SAAS,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;IAE7B,GAAG,CAAC,EAAE,CAAC,QAAQ,EAAE,GAAG,EAAE;QACpB,MAAM,QAAQ,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,SAAS,CAAC;QAExC,IAAI,QAAQ,GAAG,IAAI,EAAE,CAAC;YACpB,OAAO,CAAC,IAAI,CAAC,wBAAwB,EAAE;gBACrC,MAAM,EAAE,GAAG,CAAC,MAAM;gBAClB,IAAI,EAAE,GAAG,CAAC,IAAI;gBACd,QAAQ;gBACR,EAAE,EAAE,GAAG,CAAC,EAAE;gBACV,SAAS,EAAE,GAAG,CAAC,GAAG,CAAC,YAAY,CAAC;aACjC,CAAC,CAAC;QACL,CAAC;QAED,IAAI,GAAG,CAAC,UAAU,IAAI,GAAG,EAAE,CAAC;YAC1B,OAAO,CAAC,IAAI,CAAC,iBAAiB,EAAE;gBAC9B,MAAM,EAAE,GAAG,CAAC,MAAM;gBAClB,IAAI,EAAE,GAAG,CAAC,IAAI;gBACd,UAAU,EAAE,GAAG,CAAC,UAAU;gBAC1B,EAAE,EAAE,GAAG,CAAC,EAAE;gBACV,SAAS,EAAE,GAAG,CAAC,GAAG,CAAC,YAAY,CAAC;aACjC,CAAC,CAAC;QACL,CAAC;IACH,CAAC,CAAC,CAAC;IAEH,IAAI,EAAE,CAAC;AACT,CAAC,CAAC;AA5BW,QAAA,eAAe,mBA4B1B;AAEF;;GAEG;AACI,MAAM,cAAc,GAAG,CAAC,GAAY,EAAE,GAAa,EAAE,IAAkB,EAAE,EAAE;IAChF,MAAM,MAAM,GAAG,GAAG,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC;IAEpC,MAAM,WAAW,GAAG,CAAC,SAAS,EAAE,UAAU,EAAE,OAAO,EAAE,oBAAoB,CAAC,CAAC;IAC3E,MAAM,YAAY,GAAG,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,GAAG,CAAC,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC,CAAC;IACzE,IAAI,YAAY,EAAE,CAAC;QACjB,OAAO,IAAI,EAAE,CAAC;IAChB,CAAC;IAED,IAAI,CAAC,MAAM,EAAE,CAAC;QACZ,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;YAC1B,KAAK,EAAE,cAAc;YACrB,OAAO,EAAE,sBAAsB;SAChC,CAAC,CAAC;IACL,CAAC;IAED,IAAI,CAAC,MAAM,CAAC,UAAU,CAAC,QAAQ,CAAC,IAAI,MAAM,CAAC,MAAM,KAAK,EAAE,EAAE,CAAC;QACzD,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;YAC1B,KAAK,EAAE,cAAc;YACrB,OAAO,EAAE,yBAAyB;SACnC,CAAC,CAAC;IACL,CAAC;IAED,IAAI,EAAE,CAAC;AACT,CAAC,CAAC;AAxBW,QAAA,cAAc,kBAwBzB;AAEW,QAAA,aAAa,GAAG,sBAAc,CAAC","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\middleware\\security.middleware.ts"],"sourcesContent":["import type { NextFunction, Request, Response } from 'express';\nimport rateLimit from 'express-rate-limit';\nimport helmet from 'helmet';\n\n/**\n * Enhanced Rate Limiting Configuration\n * Different limits for different user tiers and endpoints\n */\nexport const createRateLimiter = (windowMs: number, max: number, message?: string) => {\n  return rateLimit({\n    windowMs,\n    max,\n    message: {\n      error: 'Too many requests',\n      message: message || `Rate limit exceeded. Maximum ${max} requests per ${windowMs}ms.`,\n      retryAfter: Math.ceil(windowMs / 1000),\n    },\n    standardHeaders: true,\n    legacyHeaders: false,\n  });\n};\n\n/**\n * Tier-based rate limiting\n */\nexport const rateLimiters = {\n  // Free tier - 100 requests per 15 minutes\n  free: createRateLimiter(\n    15 * 60 * 1000, // 15 minutes\n    100,\n    'Free tier limit exceeded. Upgrade to Pro for higher limits.',\n  ),\n\n  // Pro tier - 1000 requests per 15 minutes\n  pro: createRateLimiter(\n    15 * 60 * 1000, // 15 minutes\n    1000,\n    'Pro tier rate limit exceeded.',\n  ),\n\n  // Enterprise tier - 10000 requests per 15 minutes\n  enterprise: createRateLimiter(\n    15 * 60 * 1000, // 15 minutes\n    10000,\n    'Enterprise tier rate limit exceeded.',\n  ),\n\n  // Authentication endpoints - stricter limits\n  auth: createRateLimiter(\n    15 * 60 * 1000, // 15 minutes\n    5,\n    'Too many authentication attempts. Please try again later.',\n  ),\n\n  // AI endpoints - moderate limits\n  ai: createRateLimiter(\n    1 * 60 * 1000, // 1 minute\n    10,\n    'AI service rate limit exceeded. Please wait before making another request.',\n  ),\n\n  // File upload endpoints - very strict limits\n  upload: createRateLimiter(\n    60 * 60 * 1000, // 1 hour\n    10,\n    'Upload rate limit exceeded. Please wait before uploading more files.',\n  ),\n};\n\n/**\n * Dynamic rate limiting based on user tier\n */\nexport const dynamicRateLimit = (req: Request, res: Response, next: NextFunction) => {\n  // Get user tier from request (would be set by auth middleware)\n  const userTier = (req as any).user?.tier || 'free';\n\n  // Apply appropriate rate limiter\n  const limiter = rateLimiters[userTier] || rateLimiters.free;\n  return limiter(req, res, next);\n};\n\n/**\n * Enhanced Security Headers\n */\nexport const securityHeaders = helmet({\n  // Content Security Policy\n  contentSecurityPolicy: {\n    directives: {\n      defaultSrc: [\"'self'\"],\n      scriptSrc: [\"'self'\", \"'unsafe-eval'\"],\n      styleSrc: [\"'self'\", \"'unsafe-inline'\", 'fonts.googleapis.com'],\n      imgSrc: [\"'self'\", 'data:', 'https:', 'blob:'],\n      connectSrc: [\n        \"'self'\",\n        'ws:',\n        'wss:',\n        'api.openai.com',\n        'api.anthropic.com',\n        'googleapis.com',\n        'vertexai.googleapis.com',\n        'pinecone.io',\n      ],\n      fontSrc: [\"'self'\", 'fonts.gstatic.com', 'data:'],\n      objectSrc: [\"'none'\"],\n      mediaSrc: [\"'self'\"],\n      frameSrc: [\"'none'\"],\n      childSrc: [\"'none'\"],\n      workerSrc: [\"'self'\", 'blob:'],\n      manifestSrc: [\"'self'\"],\n      upgradeInsecureRequests: [],\n    },\n  },\n\n  // Other security headers\n  crossOriginEmbedderPolicy: false,\n  crossOriginOpenerPolicy: { policy: 'same-origin' },\n  crossOriginResourcePolicy: { policy: 'cross-origin' },\n  dnsPrefetchControl: { allow: false },\n  frameguard: { action: 'deny' },\n  hidePoweredBy: true,\n  hsts: {\n    maxAge: 31536000,\n    includeSubDomains: true,\n    preload: true,\n  },\n  ieNoOpen: true,\n  noSniff: true,\n  originAgentCluster: true,\n  permittedCrossDomainPolicies: false,\n  referrerPolicy: { policy: 'no-referrer' },\n  xssFilter: true,\n});\n\n/**\n * IP-based security middleware\n */\nexport const ipSecurity = (req: Request, res: Response, next: NextFunction) => {\n  const clientIP = (req.ip || req.connection.remoteAddress || 'unknown') as string;\n\n  // Block known malicious IPs (would be populated from threat intelligence)\n  const blockedIPs = new Set<string>();\n\n  if (blockedIPs.has(clientIP)) {\n    return res.status(403).json({\n      error: 'Forbidden',\n      message: 'Access denied from this IP address.',\n    });\n  }\n\n  // Check for suspicious patterns\n  const userAgent = req.get('User-Agent') || '';\n  const suspiciousPatterns = [/bot/i, /crawler/i, /scanner/i, /sqlmap/i, /nikto/i];\n  const isSuspicious = suspiciousPatterns.some(pattern => pattern.test(userAgent));\n\n  if (isSuspicious) {\n    console.warn('Suspicious request detected:', {\n      ip: clientIP,\n      userAgent,\n      path: req.path,\n      timestamp: new Date().toISOString(),\n    });\n\n    // Apply stricter rate limiting for suspicious requests\n    return rateLimiters.auth(req, res, next);\n  }\n\n  next();\n};\n\n/**\n * Request size limiting middleware\n */\nexport const requestSizeLimit = (maxSize: string = '10mb') => {\n  return (req: Request, res: Response, next: NextFunction) => {\n    const contentLength = req.get('Content-Length');\n\n    if (contentLength) {\n      const sizeInBytes = parseInt(contentLength);\n      const maxSizeInBytes = parseSize(maxSize);\n\n      if (sizeInBytes > maxSizeInBytes) {\n        return res.status(413).json({\n          error: 'Payload Too Large',\n          message: `Request size exceeds maximum allowed size of ${maxSize}.`,\n        });\n      }\n    }\n\n    next();\n  };\n};\n\n/**\n * Helper function to parse size strings (e.g., '10mb' -> bytes)\n */\nfunction parseSize(size: string): number {\n  const units: { [key: string]: number } = {\n    b: 1,\n    kb: 1024,\n    mb: 1024 * 1024,\n    gb: 1024 * 1024 * 1024,\n  };\n\n  const match = size.toLowerCase().match(/^(\\d+)(b|kb|mb|gb)$/);\n  if (!match) {\n    throw new Error(`Invalid size format: ${size}`);\n  }\n\n  const [, value, unit] = match;\n  return parseInt(value) * units[unit];\n}\n\n/**\n * Security monitoring middleware\n */\nexport const securityMonitor = (req: Request, res: Response, next: NextFunction) => {\n  const startTime = Date.now();\n\n  res.on('finish', () => {\n    const duration = Date.now() - startTime;\n\n    if (duration > 5000) {\n      console.warn('Slow request detected:', {\n        method: req.method,\n        path: req.path,\n        duration,\n        ip: req.ip,\n        userAgent: req.get('User-Agent'),\n      });\n    }\n\n    if (res.statusCode >= 400) {\n      console.warn('Error response:', {\n        method: req.method,\n        path: req.path,\n        statusCode: res.statusCode,\n        ip: req.ip,\n        userAgent: req.get('User-Agent'),\n      });\n    }\n  });\n\n  next();\n};\n\n/**\n * API key validation middleware\n */\nexport const validateApiKey = (req: Request, res: Response, next: NextFunction) => {\n  const apiKey = req.get('X-API-Key');\n\n  const publicPaths = ['/health', '/metrics', '/docs', '/api/v1/auth/login'];\n  const isPublicPath = publicPaths.some(path => req.path.startsWith(path));\n  if (isPublicPath) {\n    return next();\n  }\n\n  if (!apiKey) {\n    return res.status(401).json({\n      error: 'Unauthorized',\n      message: 'API key is required.',\n    });\n  }\n\n  if (!apiKey.startsWith('nexus_') || apiKey.length !== 40) {\n    return res.status(401).json({\n      error: 'Unauthorized',\n      message: 'Invalid API key format.',\n    });\n  }\n\n  next();\n};\n\nexport const requireApiKey = validateApiKey;\n"],"version":3}