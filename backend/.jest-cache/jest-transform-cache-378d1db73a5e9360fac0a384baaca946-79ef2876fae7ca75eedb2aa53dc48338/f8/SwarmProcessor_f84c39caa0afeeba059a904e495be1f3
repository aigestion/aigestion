f115b62ea198db22686de7f308e040ed
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SwarmProcessor = void 0;
const logger_1 = require("../../utils/logger");
const inversify_config_1 = require("../../config/inversify.config");
const types_1 = require("../../types");
const Mission_1 = require("../../models/Mission");
const Notification_1 = require("../../models/Notification");
const secrets_1 = require("../../utils/secrets");
const TOKEN_SAFETY_LIMIT = 50000; // Auto-freeze if mission exceeds this estimated limit
class SwarmProcessor {
    /**
     * Main entry point for processing an autonomous swarm mission.
     */
    static async process(job) {
        const { objective, userId, missionId, context } = job.data;
        logger_1.logger.info(`[SwarmProcessor] Starting mission [${job.id} / ${missionId}] for user ${userId}: ${objective}`);
        try {
            // Resolve services from the container
            const aiService = inversify_config_1.container.get(types_1.TYPES.AIService);
            const missionRepo = inversify_config_1.container.get(types_1.TYPES.MissionRepository);
            const socketService = inversify_config_1.container.get(types_1.TYPES.SocketService);
            const notificationService = inversify_config_1.container.get(types_1.TYPES.NotificationService);
            const swarmClient = inversify_config_1.container.get(types_1.TYPES.SwarmInternalClient);
            const kgService = inversify_config_1.container.get(types_1.TYPES.KnowledgeGraphService);
            const vaultService = inversify_config_1.container.get(types_1.TYPES.VaultService);
            // 0. Update status to PLANNING
            await missionRepo.update(missionId, { status: Mission_1.MissionStatus.PLANNING });
            socketService.emitMissionUpdate(missionId, { status: Mission_1.MissionStatus.PLANNING });
            // 1. Initial Research & Analysis
            logger_1.logger.info(`[SwarmProcessor] [${job.id}] Phase 1: Planning mission strategy...`);
            const plan = await aiService.generateContent(`
                You are the Orchestrator for an autonomous AI agent swarm.
                A user has launched a mission with the following objective: "${objective}".

                Develop a concise step-by-step strategy to accomplish this.
                The system has access to metaverse data, financial yields, and infrastructure metrics.
                The God Mode dashboard is active.

                Respond only with the technical plan.
            `, userId);
            await missionRepo.update(missionId, {
                plan,
                status: Mission_1.MissionStatus.EXECUTING,
            });
            socketService.emitMissionUpdate(missionId, { plan, status: Mission_1.MissionStatus.EXECUTING });
            // 2. Execution & Autonomous Research
            logger_1.logger.info(`[SwarmProcessor] [${job.id}] Phase 2: Executing strategy & autonomous research...`);
            let specializedResearch = '';
            const lowerObjective = objective.toLowerCase();
            // Autonomous Decision: Do we need external market research or browsing?
            if (lowerObjective.includes('mercado') ||
                lowerObjective.includes('investiga') ||
                lowerObjective.includes('competidor')) {
                logger_1.logger.info(`[SwarmProcessor] [${job.id}] Autonomous decision: Triggering Swarm Engine Research.`);
                try {
                    const researchResult = await swarmClient.post('/daniela/market-research', {
                        topic: objective,
                    });
                    specializedResearch = researchResult.report || JSON.stringify(researchResult);
                    logger_1.logger.info(`[SwarmProcessor] [${job.id}] Swarm research completed.`);
                    // 2.1 Persist findings to Knowledge Graph (Sovereign Memory)
                    await kgService.indexMissionFindings(missionId, objective, specializedResearch);
                }
                catch (researchError) {
                    logger_1.logger.warn(`[SwarmProcessor] [${job.id}] Autonomous research failed (using internal fallback):`, researchError);
                    specializedResearch = 'Mission proceeded with internal knowledge context.';
                }
            }
            // 3. Final Report (Incorporate research if available)
            logger_1.logger.info(`[SwarmProcessor] [${job.id}] Phase 3: Compiling final mission report...`);
            const report = await aiService.generateContent(`
                The mission objective was: "${objective}".
                The plan was: "${plan}".
                
                Additional Swarm Research Context:
                ${specializedResearch}

                Generate a final summary of results and recommendations for the user.
                Express why this mission strengthens the AIGestion ecosystem.
            `, userId);
            // 3.1 Sovereign Guardrails: Anomaly Detection
            const estimatedTokens = (plan?.length || 0) / 4 + (report?.length || 0) / 4;
            if (estimatedTokens > TOKEN_SAFETY_LIMIT) {
                logger_1.logger.warn(`[SwarmProcessor] [${job.id}] Sovereign Guardrail triggered: Excessive resource usage detected (${estimatedTokens} tokens). Freezing mission.`);
                await missionRepo.update(missionId, {
                    status: Mission_1.MissionStatus.FAILED,
                    error: 'SOVEREIGN_RESOURCE_GUARD: Excessive tokens detected. Mission frozen for audit.'
                });
                throw new Error('SOVEREIGN_GUARD_FREEZE');
            }
            // 4. Encrypt Findings for Sovereignty
            logger_1.logger.info(`[SwarmProcessor] [${job.id}] Phase 4: Securing findings in Sovereign Vault...`);
            // Derive Mission-Specific Key via HKDF
            const masterSeed = process.env.JWT_SECRET || 'SOVEREIGN_FALLBACK_SEED'; // In production, derived from user HW key via WebAuthn
            const missionKey = await (0, secrets_1.deriveMissionKey)(masterSeed, missionId, userId);
            const encrypted = await vaultService.encrypt(report, missionKey.toString('hex'));
            // 5. Update Final Status with E2EE
            await missionRepo.update(missionId, {
                result: encrypted.ciphertext,
                vaultIV: encrypted.iv,
                vaultTag: encrypted.tag,
                isEncrypted: true,
                status: Mission_1.MissionStatus.COMPLETED,
                completedAt: new Date(),
            });
            socketService.emitMissionUpdate(missionId, {
                result: '[ENCRYPTED_SOVEREIGN_DATA]',
                isEncrypted: true,
                status: Mission_1.MissionStatus.COMPLETED,
            });
            // 5. Create Notification
            await notificationService.createNotification(userId, Notification_1.NotificationType.MISSION_COMPLETED, 'Mission Completed', `Mission "${objective}" completed successfully.`, { missionId, resultPreview: report.substring(0, 100) });
            logger_1.logger.info(`[SwarmProcessor] Mission [${job.id}] completed successfully.`);
            // In a real implementation, we might save this results to a DB or notify user via Telegram/Email
        }
        catch (error) {
            logger_1.logger.error(`[SwarmProcessor] Mission [${job.id} / ${missionId}] failed:`, error);
            try {
                const missionRepo = inversify_config_1.container.get(types_1.TYPES.MissionRepository);
                const socketService = inversify_config_1.container.get(types_1.TYPES.SocketService);
                const notificationService = inversify_config_1.container.get(types_1.TYPES.NotificationService);
                await missionRepo.update(missionId, {
                    status: Mission_1.MissionStatus.FAILED,
                    error: error instanceof Error ? error.message : 'Unknown error',
                    completedAt: new Date(),
                });
                socketService.emitMissionUpdate(missionId, {
                    status: Mission_1.MissionStatus.FAILED,
                    error: error instanceof Error ? error.message : 'Unknown error',
                });
                await notificationService.createNotification(userId, Notification_1.NotificationType.MISSION_FAILED, 'Mission Failed', `Mission "${objective}" failed: ${error instanceof Error ? error.message : 'Unknown error'}`, { missionId, error: error instanceof Error ? error.message : 'Unknown error' });
            }
            catch (repoError) {
                logger_1.logger.error('[SwarmProcessor] Failed to update mission failure status/notification:', repoError);
            }
            throw error;
        }
    }
}
exports.SwarmProcessor = SwarmProcessor;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxpbmZyYXN0cnVjdHVyZVxcam9ic1xcU3dhcm1Qcm9jZXNzb3IudHMiLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsK0NBQTRDO0FBQzVDLG9FQUEwRDtBQUMxRCx1Q0FBb0M7QUFHcEMsa0RBQXFEO0FBR3JELDREQUE2RDtBQUk3RCxpREFBdUQ7QUFFdkQsTUFBTSxrQkFBa0IsR0FBRyxLQUFLLENBQUMsQ0FBQyxzREFBc0Q7QUFFeEYsTUFBYSxjQUFjO0lBQ3pCOztPQUVHO0lBQ0ksTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBUTtRQUNsQyxNQUFNLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQztRQUMzRCxlQUFNLENBQUMsSUFBSSxDQUNULHNDQUFzQyxHQUFHLENBQUMsRUFBRSxNQUFNLFNBQVMsY0FBYyxNQUFNLEtBQUssU0FBUyxFQUFFLENBQ2hHLENBQUM7UUFFRixJQUFJLENBQUM7WUFDSCxzQ0FBc0M7WUFDdEMsTUFBTSxTQUFTLEdBQUcsNEJBQVMsQ0FBQyxHQUFHLENBQVksYUFBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQzVELE1BQU0sV0FBVyxHQUFHLDRCQUFTLENBQUMsR0FBRyxDQUFxQixhQUFLLENBQUMsaUJBQWlCLENBQUMsQ0FBQztZQUMvRSxNQUFNLGFBQWEsR0FBRyw0QkFBUyxDQUFDLEdBQUcsQ0FBZ0IsYUFBSyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1lBQ3hFLE1BQU0sbUJBQW1CLEdBQUcsNEJBQVMsQ0FBQyxHQUFHLENBQXNCLGFBQUssQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1lBQzFGLE1BQU0sV0FBVyxHQUFHLDRCQUFTLENBQUMsR0FBRyxDQUFzQixhQUFLLENBQUMsbUJBQW1CLENBQUMsQ0FBQztZQUNsRixNQUFNLFNBQVMsR0FBRyw0QkFBUyxDQUFDLEdBQUcsQ0FBd0IsYUFBSyxD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QyxDQUFDLENBQUMsZUFBZTtvQkFDL0QsV0FBVyxFQUFFLElBQUksSUFBSSxFQUFFO2lCQUN4QixDQUFDLENBQUM7Z0JBRUgsYUFBYSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsRUFBRTtvQkFDekMsTUFBTSxFQUFFLHVCQUFhLENBQUMsTUFBTTtvQkFDNUIsS0FBSyxFQUFFLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLGVBQWU7aUJBQ2hFLENBQUMsQ0FBQztnQkFFSCxNQUFNLG1CQUFtQixDQUFDLGtCQUFrQixDQUMxQyxNQUFNLEVBQ04sK0JBQWdCLENBQUMsY0FBYyxFQUMvQixnQkFBZ0IsRUFDaEIsWUFBWSxTQUFTLGFBQ25CLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLGVBQzNDLEVBQUUsRUFDRixFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsS0FBSyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsZUFBZSxFQUFFLENBQy9FLENBQUM7WUFDSixDQUFDO1lBQUMsT0FBTyxTQUFTLEVBQUUsQ0FBQztnQkFDbkIsZUFBTSxDQUFDLEtBQUssQ0FDVix3RUFBd0UsRUFDeEUsU0FBUyxDQUNWLENBQUM7WUFDSixDQUFDO1lBRUQsTUFBTSxLQUFLLENBQUM7UUFDZCxDQUFDO0lBQ0gsQ0FBQztDQUNGO0FBekxELHdDQXlMQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXEFsZWphbmRyb1xcQUlHZXN0aW9uXFxiYWNrZW5kXFxzcmNcXGluZnJhc3RydWN0dXJlXFxqb2JzXFxTd2FybVByb2Nlc3Nvci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBKb2IgfSBmcm9tICdidWxsbXEnO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi4vLi4vdXRpbHMvbG9nZ2VyJztcbmltcG9ydCB7IGNvbnRhaW5lciB9IGZyb20gJy4uLy4uL2NvbmZpZy9pbnZlcnNpZnkuY29uZmlnJztcbmltcG9ydCB7IFRZUEVTIH0gZnJvbSAnLi4vLi4vdHlwZXMnO1xuaW1wb3J0IHsgQUlTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvYWkuc2VydmljZSc7XG5pbXBvcnQgeyBJTWlzc2lvblJlcG9zaXRvcnkgfSBmcm9tICcuLi9yZXBvc2l0b3J5L01pc3Npb25SZXBvc2l0b3J5JztcbmltcG9ydCB7IE1pc3Npb25TdGF0dXMgfSBmcm9tICcuLi8uLi9tb2RlbHMvTWlzc2lvbic7XG5pbXBvcnQgeyBTb2NrZXRTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvc29ja2V0LnNlcnZpY2UnO1xuaW1wb3J0IHsgTm90aWZpY2F0aW9uU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL25vdGlmaWNhdGlvbi5zZXJ2aWNlJztcbmltcG9ydCB7IE5vdGlmaWNhdGlvblR5cGUgfSBmcm9tICcuLi8uLi9tb2RlbHMvTm90aWZpY2F0aW9uJztcbmltcG9ydCB7IFN3YXJtSW50ZXJuYWxDbGllbnQgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9zd2FybS1pbnRlcm5hbC5jbGllbnQnO1xuaW1wb3J0IHsgS25vd2xlZGdlR3JhcGhTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMva25vd2xlZGdlLWdyYXBoLnNlcnZpY2UnO1xuaW1wb3J0IHsgVmF1bHRTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvdmF1bHQuc2VydmljZSc7XG5pbXBvcnQgeyBkZXJpdmVNaXNzaW9uS2V5IH0gZnJvbSAnLi4vLi4vdXRpbHMvc2VjcmV0cyc7XG5cbmNvbnN0IFRPS0VOX1NBRkVUWV9MSU1JVCA9IDUwMDAwOyAvLyBBdXRvLWZyZWV6ZSBpZiBtaXNzaW9uIGV4Y2VlZHMgdGhpcyBlc3RpbWF0ZWQgbGltaXRcblxuZXhwb3J0IGNsYXNzIFN3YXJtUHJvY2Vzc29yIHtcbiAgLyoqXG4gICAqIE1haW4gZW50cnkgcG9pbnQgZm9yIHByb2Nlc3NpbmcgYW4gYXV0b25vbW91cyBzd2FybSBtaXNzaW9uLlxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBhc3luYyBwcm9jZXNzKGpvYjogSm9iKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgeyBvYmplY3RpdmUsIHVzZXJJZCwgbWlzc2lvbklkLCBjb250ZXh0IH0gPSBqb2IuZGF0YTtcbiAgICBsb2dnZXIuaW5mbyhcbiAgICAgIGBbU3dhcm1Qcm9jZXNzb3JdIFN0YXJ0aW5nIG1pc3Npb24gWyR7am9iLmlkfSAvICR7bWlzc2lvbklkfV0gZm9yIHVzZXIgJHt1c2VySWR9OiAke29iamVjdGl2ZX1gLFxuICAgICk7XG5cbiAgICB0cnkge1xuICAgICAgLy8gUmVzb2x2ZSBzZXJ2aWNlcyBmcm9tIHRoZSBjb250YWluZXJcbiAgICAgIGNvbnN0IGFpU2VydmljZSA9IGNvbnRhaW5lci5nZXQ8QUlTZXJ2aWNlPihUWVBFUy5BSVNlcnZpY2UpO1xuICAgICAgY29uc3QgbWlzc2lvblJlcG8gPSBjb250YWluZXIuZ2V0PElNaXNzaW9uUmVwb3NpdG9yeT4oVFlQRVMuTWlzc2lvblJlcG9zaXRvcnkpO1xuICAgICAgY29uc3Qgc29ja2V0U2VydmljZSA9IGNvbnRhaW5lci5nZXQ8U29ja2V0U2VydmljZT4oVFlQRVMuU29ja2V0U2VydmljZSk7XG4gICAgICBjb25zdCBub3RpZmljYXRpb25TZXJ2aWNlID0gY29udGFpbmVyLmdldDxOb3RpZmljYXRpb25TZXJ2aWNlPihUWVBFUy5Ob3RpZmljYXRpb25TZXJ2aWNlKTtcbiAgICAgIGNvbnN0IHN3YXJtQ2xpZW50ID0gY29udGFpbmVyLmdldDxTd2FybUludGVybmFsQ2xpZW50PihUWVBFUy5Td2FybUludGVybmFsQ2xpZW50KTtcbiAgICAgIGNvbnN0IGtnU2VydmljZSA9IGNvbnRhaW5lci5nZXQ8S25vd2xlZGdlR3JhcGhTZXJ2aWNlPihUWVBFUy5Lbm93bGVkZ2VHcmFwaFNlcnZpY2UpO1xuICAgICAgY29uc3QgdmF1bHRTZXJ2aWNlID0gY29udGFpbmVyLmdldDxWYXVsdFNlcnZpY2U+KFRZUEVTLlZhdWx0U2VydmljZSk7XG5cbiAgICAgIC8vIDAuIFVwZGF0ZSBzdGF0dXMgdG8gUExBTk5JTkdcbiAgICAgIGF3YWl0IG1pc3Npb25SZXBvLnVwZGF0ZShtaXNzaW9uSWQsIHsgc3RhdHVzOiBNaXNzaW9uU3RhdHVzLlBMQU5OSU5HIH0pO1xuICAgICAgc29ja2V0U2VydmljZS5lbWl0TWlzc2lvblVwZGF0ZShtaXNzaW9uSWQsIHsgc3RhdHVzOiBNaXNzaW9uU3RhdHVzLlBMQU5OSU5HIH0pO1xuXG4gICAgICAvLyAxLiBJbml0aWFsIFJlc2VhcmNoICYgQW5hbHlzaXNcbiAgICAgIGxvZ2dlci5pbmZvKGBbU3dhcm1Qcm9jZXNzb3JdIFske2pvYi5pZH1dIFBoYXNlIDE6IFBsYW5uaW5nIG1pc3Npb24gc3RyYXRlZ3kuLi5gKTtcbiAgICAgIGNvbnN0IHBsYW4gPSBhd2FpdCBhaVNlcnZpY2UuZ2VuZXJhdGVDb250ZW50KFxuICAgICAgICBgXG4gICAgICAgICAgICAgICAgWW91IGFyZSB0aGUgT3JjaGVzdHJhdG9yIGZvciBhbiBhdXRvbm9tb3VzIEFJIGFnZW50IHN3YXJtLlxuICAgICAgICAgICAgICAgIEEgdXNlciBoYXMgbGF1bmNoZWQgYSBtaXNzaW9uIHdpdGggdGhlIGZvbGxvd2luZyBvYmplY3RpdmU6IFwiJHtvYmplY3RpdmV9XCIuXG5cbiAgICAgICAgICAgICAgICBEZXZlbG9wIGEgY29uY2lzZSBzdGVwLWJ5LXN0ZXAgc3RyYXRlZ3kgdG8gYWNjb21wbGlzaCB0aGlzLlxuICAgICAgICAgICAgICAgIFRoZSBzeXN0ZW0gaGFzIGFjY2VzcyB0byBtZXRhdmVyc2UgZGF0YSwgZmluYW5jaWFsIHlpZWxkcywgYW5kIGluZnJhc3RydWN0dXJlIG1ldHJpY3MuXG4gICAgICAgICAgICAgICAgVGhlIEdvZCBNb2RlIGRhc2hib2FyZCBpcyBhY3RpdmUuXG5cbiAgICAgICAgICAgICAgICBSZXNwb25kIG9ubHkgd2l0aCB0aGUgdGVjaG5pY2FsIHBsYW4uXG4gICAgICAgICAgICBgLFxuICAgICAgICB1c2VySWQsXG4gICAgICApO1xuXG4gICAgICBhd2FpdCBtaXNzaW9uUmVwby51cGRhdGUobWlzc2lvbklkLCB7XG4gICAgICAgIHBsYW4sXG4gICAgICAgIHN0YXR1czogTWlzc2lvblN0YXR1cy5FWEVDVVRJTkcsXG4gICAgICB9KTtcbiAgICAgIHNvY2tldFNlcnZpY2UuZW1pdE1pc3Npb25VcGRhdGUobWlzc2lvbklkLCB7IHBsYW4sIHN0YXR1czogTWlzc2lvblN0YXR1cy5FWEVDVVRJTkcgfSk7XG5cbiAgICAgIC8vIDIuIEV4ZWN1dGlvbiAmIEF1dG9ub21vdXMgUmVzZWFyY2hcbiAgICAgIGxvZ2dlci5pbmZvKFxuICAgICAgICBgW1N3YXJtUHJvY2Vzc29yXSBbJHtqb2IuaWR9XSBQaGFzZSAyOiBFeGVjdXRpbmcgc3RyYXRlZ3kgJiBhdXRvbm9tb3VzIHJlc2VhcmNoLi4uYCxcbiAgICAgICk7XG5cbiAgICAgIGxldCBzcGVjaWFsaXplZFJlc2VhcmNoID0gJyc7XG4gICAgICBjb25zdCBsb3dlck9iamVjdGl2ZSA9IG9iamVjdGl2ZS50b0xvd2VyQ2FzZSgpO1xuXG4gICAgICAvLyBBdXRvbm9tb3VzIERlY2lzaW9uOiBEbyB3ZSBuZWVkIGV4dGVybmFsIG1hcmtldCByZXNlYXJjaCBvciBicm93c2luZz9cbiAgICAgIGlmIChcbiAgICAgICAgbG93ZXJPYmplY3RpdmUuaW5jbHVkZXMoJ21lcmNhZG8nKSB8fFxuICAgICAgICBsb3dlck9iamVjdGl2ZS5pbmNsdWRlcygnaW52ZXN0aWdhJykgfHxcbiAgICAgICAgbG93ZXJPYmplY3RpdmUuaW5jbHVkZXMoJ2NvbXBldGlkb3InKVxuICAgICAgKSB7XG4gICAgICAgIGxvZ2dlci5pbmZvKFxuICAgICAgICAgIGBbU3dhcm1Qcm9jZXNzb3JdIFske2pvYi5pZH1dIEF1dG9ub21vdXMgZGVjaXNpb246IFRyaWdnZXJpbmcgU3dhcm0gRW5naW5lIFJlc2VhcmNoLmAsXG4gICAgICAgICk7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCByZXNlYXJjaFJlc3VsdCA9IGF3YWl0IHN3YXJtQ2xpZW50LnBvc3QoJy9kYW5pZWxhL21hcmtldC1yZXNlYXJjaCcsIHtcbiAgICAgICAgICAgIHRvcGljOiBvYmplY3RpdmUsXG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICBzcGVjaWFsaXplZFJlc2VhcmNoID0gcmVzZWFyY2hSZXN1bHQucmVwb3J0IHx8IEpTT04uc3RyaW5naWZ5KHJlc2VhcmNoUmVzdWx0KTtcbiAgICAgICAgICBsb2dnZXIuaW5mbyhgW1N3YXJtUHJvY2Vzc29yXSBbJHtqb2IuaWR9XSBTd2FybSByZXNlYXJjaCBjb21wbGV0ZWQuYCk7XG5cbiAgICAgICAgICAvLyAyLjEgUGVyc2lzdCBmaW5kaW5ncyB0byBLbm93bGVkZ2UgR3JhcGggKFNvdmVyZWlnbiBNZW1vcnkpXG4gICAgICAgICAgYXdhaXQga2dTZXJ2aWNlLmluZGV4TWlzc2lvbkZpbmRpbmdzKG1pc3Npb25JZCwgb2JqZWN0aXZlLCBzcGVjaWFsaXplZFJlc2VhcmNoKTtcbiAgICAgICAgfSBjYXRjaCAocmVzZWFyY2hFcnJvcikge1xuICAgICAgICAgIGxvZ2dlci53YXJuKFxuICAgICAgICAgICAgYFtTd2FybVByb2Nlc3Nvcl0gWyR7am9iLmlkfV0gQXV0b25vbW91cyByZXNlYXJjaCBmYWlsZWQgKHVzaW5nIGludGVybmFsIGZhbGxiYWNrKTpgLFxuICAgICAgICAgICAgcmVzZWFyY2hFcnJvcixcbiAgICAgICAgICApO1xuICAgICAgICAgIHNwZWNpYWxpemVkUmVzZWFyY2ggPSAnTWlzc2lvbiBwcm9jZWVkZWQgd2l0aCBpbnRlcm5hbCBrbm93bGVkZ2UgY29udGV4dC4nO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIDMuIEZpbmFsIFJlcG9ydCAoSW5jb3Jwb3JhdGUgcmVzZWFyY2ggaWYgYXZhaWxhYmxlKVxuICAgICAgbG9nZ2VyLmluZm8oYFtTd2FybVByb2Nlc3Nvcl0gWyR7am9iLmlkfV0gUGhhc2UgMzogQ29tcGlsaW5nIGZpbmFsIG1pc3Npb24gcmVwb3J0Li4uYCk7XG4gICAgICBjb25zdCByZXBvcnQgPSBhd2FpdCBhaVNlcnZpY2UuZ2VuZXJhdGVDb250ZW50KFxuICAgICAgICBgXG4gICAgICAgICAgICAgICAgVGhlIG1pc3Npb24gb2JqZWN0aXZlIHdhczogXCIke29iamVjdGl2ZX1cIi5cbiAgICAgICAgICAgICAgICBUaGUgcGxhbiB3YXM6IFwiJHtwbGFufVwiLlxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIEFkZGl0aW9uYWwgU3dhcm0gUmVzZWFyY2ggQ29udGV4dDpcbiAgICAgICAgICAgICAgICAke3NwZWNpYWxpemVkUmVzZWFyY2h9XG5cbiAgICAgICAgICAgICAgICBHZW5lcmF0ZSBhIGZpbmFsIHN1bW1hcnkgb2YgcmVzdWx0cyBhbmQgcmVjb21tZW5kYXRpb25zIGZvciB0aGUgdXNlci5cbiAgICAgICAgICAgICAgICBFeHByZXNzIHdoeSB0aGlzIG1pc3Npb24gc3RyZW5ndGhlbnMgdGhlIEFJR2VzdGlvbiBlY29zeXN0ZW0uXG4gICAgICAgICAgICBgLFxuICAgICAgICB1c2VySWQsXG4gICAgICApO1xuXG4gICAgICAvLyAzLjEgU292ZXJlaWduIEd1YXJkcmFpbHM6IEFub21hbHkgRGV0ZWN0aW9uXG4gICAgICBjb25zdCBlc3RpbWF0ZWRUb2tlbnMgPSAocGxhbj8ubGVuZ3RoIHx8IDApIC8gNCArIChyZXBvcnQ/Lmxlbmd0aCB8fCAwKSAvIDQ7XG4gICAgICBpZiAoZXN0aW1hdGVkVG9rZW5zID4gVE9LRU5fU0FGRVRZX0xJTUlUKSB7XG4gICAgICAgIGxvZ2dlci53YXJuKGBbU3dhcm1Qcm9jZXNzb3JdIFske2pvYi5pZH1dIFNvdmVyZWlnbiBHdWFyZHJhaWwgdHJpZ2dlcmVkOiBFeGNlc3NpdmUgcmVzb3VyY2UgdXNhZ2UgZGV0ZWN0ZWQgKCR7ZXN0aW1hdGVkVG9rZW5zfSB0b2tlbnMpLiBGcmVlemluZyBtaXNzaW9uLmApO1xuICAgICAgICBhd2FpdCBtaXNzaW9uUmVwby51cGRhdGUobWlzc2lvbklkLCB7IFxuICAgICAgICAgIHN0YXR1czogTWlzc2lvblN0YXR1cy5GQUlMRUQsIFxuICAgICAgICAgIGVycm9yOiAnU09WRVJFSUdOX1JFU09VUkNFX0dVQVJEOiBFeGNlc3NpdmUgdG9rZW5zIGRldGVjdGVkLiBNaXNzaW9uIGZyb3plbiBmb3IgYXVkaXQuJyBcbiAgICAgICAgfSk7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignU09WRVJFSUdOX0dVQVJEX0ZSRUVaRScpO1xuICAgICAgfVxuXG4gICAgICAvLyA0LiBFbmNyeXB0IEZpbmRpbmdzIGZvciBTb3ZlcmVpZ250eVxuICAgICAgbG9nZ2VyLmluZm8oYFtTd2FybVByb2Nlc3Nvcl0gWyR7am9iLmlkfV0gUGhhc2UgNDogU2VjdXJpbmcgZmluZGluZ3MgaW4gU292ZXJlaWduIFZhdWx0Li4uYCk7XG5cbiAgICAgIC8vIERlcml2ZSBNaXNzaW9uLVNwZWNpZmljIEtleSB2aWEgSEtERlxuICAgICAgY29uc3QgbWFzdGVyU2VlZCA9IHByb2Nlc3MuZW52LkpXVF9TRUNSRVQgfHwgJ1NPVkVSRUlHTl9GQUxMQkFDS19TRUVEJzsgLy8gSW4gcHJvZHVjdGlvbiwgZGVyaXZlZCBmcm9tIHVzZXIgSFcga2V5IHZpYSBXZWJBdXRoblxuICAgICAgY29uc3QgbWlzc2lvbktleSA9IGF3YWl0IGRlcml2ZU1pc3Npb25LZXkobWFzdGVyU2VlZCwgbWlzc2lvbklkLCB1c2VySWQpO1xuXG4gICAgICBjb25zdCBlbmNyeXB0ZWQgPSBhd2FpdCB2YXVsdFNlcnZpY2UuZW5jcnlwdChyZXBvcnQsIG1pc3Npb25LZXkudG9TdHJpbmcoJ2hleCcpKTtcblxuICAgICAgLy8gNS4gVXBkYXRlIEZpbmFsIFN0YXR1cyB3aXRoIEUyRUVcbiAgICAgIGF3YWl0IG1pc3Npb25SZXBvLnVwZGF0ZShtaXNzaW9uSWQsIHtcbiAgICAgICAgcmVzdWx0OiBlbmNyeXB0ZWQuY2lwaGVydGV4dCxcbiAgICAgICAgdmF1bHRJVjogZW5jcnlwdGVkLml2LFxuICAgICAgICB2YXVsdFRhZzogZW5jcnlwdGVkLnRhZyxcbiAgICAgICAgaXNFbmNyeXB0ZWQ6IHRydWUsXG4gICAgICAgIHN0YXR1czogTWlzc2lvblN0YXR1cy5DT01QTEVURUQsXG4gICAgICAgIGNvbXBsZXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgfSk7XG5cbiAgICAgIHNvY2tldFNlcnZpY2UuZW1pdE1pc3Npb25VcGRhdGUobWlzc2lvbklkLCB7XG4gICAgICAgIHJlc3VsdDogJ1tFTkNSWVBURURfU09WRVJFSUdOX0RBVEFdJyxcbiAgICAgICAgaXNFbmNyeXB0ZWQ6IHRydWUsXG4gICAgICAgIHN0YXR1czogTWlzc2lvblN0YXR1cy5DT01QTEVURUQsXG4gICAgICB9KTtcblxuICAgICAgLy8gNS4gQ3JlYXRlIE5vdGlmaWNhdGlvblxuICAgICAgYXdhaXQgbm90aWZpY2F0aW9uU2VydmljZS5jcmVhdGVOb3RpZmljYXRpb24oXG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgTm90aWZpY2F0aW9uVHlwZS5NSVNTSU9OX0NPTVBMRVRFRCxcbiAgICAgICAgJ01pc3Npb24gQ29tcGxldGVkJyxcbiAgICAgICAgYE1pc3Npb24gXCIke29iamVjdGl2ZX1cIiBjb21wbGV0ZWQgc3VjY2Vzc2Z1bGx5LmAsXG4gICAgICAgIHsgbWlzc2lvbklkLCByZXN1bHRQcmV2aWV3OiByZXBvcnQuc3Vic3RyaW5nKDAsIDEwMCkgfSxcbiAgICAgICk7XG5cbiAgICAgIGxvZ2dlci5pbmZvKGBbU3dhcm1Qcm9jZXNzb3JdIE1pc3Npb24gWyR7am9iLmlkfV0gY29tcGxldGVkIHN1Y2Nlc3NmdWxseS5gKTtcblxuICAgICAgLy8gSW4gYSByZWFsIGltcGxlbWVudGF0aW9uLCB3ZSBtaWdodCBzYXZlIHRoaXMgcmVzdWx0cyB0byBhIERCIG9yIG5vdGlmeSB1c2VyIHZpYSBUZWxlZ3JhbS9FbWFpbFxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoYFtTd2FybVByb2Nlc3Nvcl0gTWlzc2lvbiBbJHtqb2IuaWR9IC8gJHttaXNzaW9uSWR9XSBmYWlsZWQ6YCwgZXJyb3IpO1xuXG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBtaXNzaW9uUmVwbyA9IGNvbnRhaW5lci5nZXQ8SU1pc3Npb25SZXBvc2l0b3J5PihUWVBFUy5NaXNzaW9uUmVwb3NpdG9yeSk7XG4gICAgICAgIGNvbnN0IHNvY2tldFNlcnZpY2UgPSBjb250YWluZXIuZ2V0PFNvY2tldFNlcnZpY2U+KFRZUEVTLlNvY2tldFNlcnZpY2UpO1xuICAgICAgICBjb25zdCBub3RpZmljYXRpb25TZXJ2aWNlID0gY29udGFpbmVyLmdldDxOb3RpZmljYXRpb25TZXJ2aWNlPihUWVBFUy5Ob3RpZmljYXRpb25TZXJ2aWNlKTtcblxuICAgICAgICBhd2FpdCBtaXNzaW9uUmVwby51cGRhdGUobWlzc2lvbklkLCB7XG4gICAgICAgICAgc3RhdHVzOiBNaXNzaW9uU3RhdHVzLkZBSUxFRCxcbiAgICAgICAgICBlcnJvcjogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcicsXG4gICAgICAgICAgY29tcGxldGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHNvY2tldFNlcnZpY2UuZW1pdE1pc3Npb25VcGRhdGUobWlzc2lvbklkLCB7XG4gICAgICAgICAgc3RhdHVzOiBNaXNzaW9uU3RhdHVzLkZBSUxFRCxcbiAgICAgICAgICBlcnJvcjogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcicsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGF3YWl0IG5vdGlmaWNhdGlvblNlcnZpY2UuY3JlYXRlTm90aWZpY2F0aW9uKFxuICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICBOb3RpZmljYXRpb25UeXBlLk1JU1NJT05fRkFJTEVELFxuICAgICAgICAgICdNaXNzaW9uIEZhaWxlZCcsXG4gICAgICAgICAgYE1pc3Npb24gXCIke29iamVjdGl2ZX1cIiBmYWlsZWQ6ICR7XG4gICAgICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJ1xuICAgICAgICAgIH1gLFxuICAgICAgICAgIHsgbWlzc2lvbklkLCBlcnJvcjogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcicgfSxcbiAgICAgICAgKTtcbiAgICAgIH0gY2F0Y2ggKHJlcG9FcnJvcikge1xuICAgICAgICBsb2dnZXIuZXJyb3IoXG4gICAgICAgICAgJ1tTd2FybVByb2Nlc3Nvcl0gRmFpbGVkIHRvIHVwZGF0ZSBtaXNzaW9uIGZhaWx1cmUgc3RhdHVzL25vdGlmaWNhdGlvbjonLFxuICAgICAgICAgIHJlcG9FcnJvcixcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=