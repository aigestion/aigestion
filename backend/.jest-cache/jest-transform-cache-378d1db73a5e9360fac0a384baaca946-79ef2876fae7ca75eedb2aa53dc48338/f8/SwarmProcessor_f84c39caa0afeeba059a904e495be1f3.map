{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\infrastructure\\jobs\\SwarmProcessor.ts","mappings":";;;AACA,+CAA4C;AAC5C,oEAA0D;AAC1D,uCAAoC;AAGpC,kDAAqD;AAGrD,4DAA6D;AAI7D,iDAAuD;AAEvD,MAAM,kBAAkB,GAAG,KAAK,CAAC,CAAC,sDAAsD;AAExF,MAAa,cAAc;IACzB;;OAEG;IACI,MAAM,CAAC,KAAK,CAAC,OAAO,CAAC,GAAQ;QAClC,MAAM,EAAE,SAAS,EAAE,MAAM,EAAE,SAAS,EAAE,OAAO,EAAE,GAAG,GAAG,CAAC,IAAI,CAAC;QAC3D,eAAM,CAAC,IAAI,CACT,sCAAsC,GAAG,CAAC,EAAE,MAAM,SAAS,cAAc,MAAM,KAAK,SAAS,EAAE,CAChG,CAAC;QAEF,IAAI,CAAC;YACH,sCAAsC;YACtC,MAAM,SAAS,GAAG,4BAAS,CAAC,GAAG,CAAY,aAAK,CAAC,SAAS,CAAC,CAAC;YAC5D,MAAM,WAAW,GAAG,4BAAS,CAAC,GAAG,CAAqB,aAAK,CAAC,iBAAiB,CAAC,CAAC;YAC/E,MAAM,aAAa,GAAG,4BAAS,CAAC,GAAG,CAAgB,aAAK,CAAC,aAAa,CAAC,CAAC;YACxE,MAAM,mBAAmB,GAAG,4BAAS,CAAC,GAAG,CAAsB,aAAK,CAAC,mBAAmB,CAAC,CAAC;YAC1F,MAAM,WAAW,GAAG,4BAAS,CAAC,GAAG,CAAsB,aAAK,CAAC,mBAAmB,CAAC,CAAC;YAClF,MAAM,SAAS,GAAG,4BAAS,CAAC,GAAG,CAAwB,aAAK,CAAC,qBAAqB,CAAC,CAAC;YACpF,MAAM,YAAY,GAAG,4BAAS,CAAC,GAAG,CAAe,aAAK,CAAC,YAAY,CAAC,CAAC;YAErE,+BAA+B;YAC/B,MAAM,WAAW,CAAC,MAAM,CAAC,SAAS,EAAE,EAAE,MAAM,EAAE,uBAAa,CAAC,QAAQ,EAAE,CAAC,CAAC;YACxE,aAAa,CAAC,iBAAiB,CAAC,SAAS,EAAE,EAAE,MAAM,EAAE,uBAAa,CAAC,QAAQ,EAAE,CAAC,CAAC;YAE/E,iCAAiC;YACjC,eAAM,CAAC,IAAI,CAAC,qBAAqB,GAAG,CAAC,EAAE,yCAAyC,CAAC,CAAC;YAClF,MAAM,IAAI,GAAG,MAAM,SAAS,CAAC,eAAe,CAC1C;;+EAEuE,SAAS;;;;;;;aAO3E,EACL,MAAM,CACP,CAAC;YAEF,MAAM,WAAW,CAAC,MAAM,CAAC,SAAS,EAAE;gBAClC,IAAI;gBACJ,MAAM,EAAE,uBAAa,CAAC,SAAS;aAChC,CAAC,CAAC;YACH,aAAa,CAAC,iBAAiB,CAAC,SAAS,EAAE,EAAE,IAAI,EAAE,MAAM,EAAE,uBAAa,CAAC,SAAS,EAAE,CAAC,CAAC;YAEtF,qCAAqC;YACrC,eAAM,CAAC,IAAI,CACT,qBAAqB,GAAG,CAAC,EAAE,wDAAwD,CACpF,CAAC;YAEF,IAAI,mBAAmB,GAAG,EAAE,CAAC;YAC7B,MAAM,cAAc,GAAG,SAAS,CAAC,WAAW,EAAE,CAAC;YAE/C,wEAAwE;YACxE,IACE,cAAc,CAAC,QAAQ,CAAC,SAAS,CAAC;gBAClC,cAAc,CAAC,QAAQ,CAAC,WAAW,CAAC;gBACpC,cAAc,CAAC,QAAQ,CAAC,YAAY,CAAC,EACrC,CAAC;gBACD,eAAM,CAAC,IAAI,CACT,qBAAqB,GAAG,CAAC,EAAE,0DAA0D,CACtF,CAAC;gBAEF,IAAI,CAAC;oBACH,MAAM,cAAc,GAAG,MAAM,WAAW,CAAC,IAAI,CAAC,0BAA0B,EAAE;wBACxE,KAAK,EAAE,SAAS;qBACjB,CAAC,CAAC;oBAEH,mBAAmB,GAAG,cAAc,CAAC,MAAM,IAAI,IAAI,CAAC,SAAS,CAAC,cAAc,CAAC,CAAC;oBAC9E,eAAM,CAAC,IAAI,CAAC,qBAAqB,GAAG,CAAC,EAAE,6BAA6B,CAAC,CAAC;oBAEtE,6DAA6D;oBAC7D,MAAM,SAAS,CAAC,oBAAoB,CAAC,SAAS,EAAE,SAAS,EAAE,mBAAmB,CAAC,CAAC;gBAClF,CAAC;gBAAC,OAAO,aAAa,EAAE,CAAC;oBACvB,eAAM,CAAC,IAAI,CACT,qBAAqB,GAAG,CAAC,EAAE,yDAAyD,EACpF,aAAa,CACd,CAAC;oBACF,mBAAmB,GAAG,oDAAoD,CAAC;gBAC7E,CAAC;YACH,CAAC;YAED,sDAAsD;YACtD,eAAM,CAAC,IAAI,CAAC,qBAAqB,GAAG,CAAC,EAAE,8CAA8C,CAAC,CAAC;YACvF,MAAM,MAAM,GAAG,MAAM,SAAS,CAAC,eAAe,CAC5C;8CACsC,SAAS;iCACtB,IAAI;;;kBAGnB,mBAAmB;;;;aAIxB,EACL,MAAM,CACP,CAAC;YAEF,8CAA8C;YAC9C,MAAM,eAAe,GAAG,CAAC,IAAI,EAAE,MAAM,IAAI,CAAC,CAAC,GAAG,CAAC,GAAG,CAAC,MAAM,EAAE,MAAM,IAAI,CAAC,CAAC,GAAG,CAAC,CAAC;YAC5E,IAAI,eAAe,GAAG,kBAAkB,EAAE,CAAC;gBACzC,eAAM,CAAC,IAAI,CAAC,qBAAqB,GAAG,CAAC,EAAE,uEAAuE,eAAe,6BAA6B,CAAC,CAAC;gBAC5J,MAAM,WAAW,CAAC,MAAM,CAAC,SAAS,EAAE;oBAClC,MAAM,EAAE,uBAAa,CAAC,MAAM;oBAC5B,KAAK,EAAE,gFAAgF;iBACxF,CAAC,CAAC;gBACH,MAAM,IAAI,KAAK,CAAC,wBAAwB,CAAC,CAAC;YAC5C,CAAC;YAED,sCAAsC;YACtC,eAAM,CAAC,IAAI,CAAC,qBAAqB,GAAG,CAAC,EAAE,oDAAoD,CAAC,CAAC;YAE7F,uCAAuC;YACvC,MAAM,UAAU,GAAG,OAAO,CAAC,GAAG,CAAC,UAAU,IAAI,yBAAyB,CAAC,CAAC,uDAAuD;YAC/H,MAAM,UAAU,GAAG,MAAM,IAAA,0BAAgB,EAAC,UAAU,EAAE,SAAS,EAAE,MAAM,CAAC,CAAC;YAEzE,MAAM,SAAS,GAAG,MAAM,YAAY,CAAC,OAAO,CAAC,MAAM,EAAE,UAAU,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,CAAC;YAEjF,mCAAmC;YACnC,MAAM,WAAW,CAAC,MAAM,CAAC,SAAS,EAAE;gBAClC,MAAM,EAAE,SAAS,CAAC,UAAU;gBAC5B,OAAO,EAAE,SAAS,CAAC,EAAE;gBACrB,QAAQ,EAAE,SAAS,CAAC,GAAG;gBACvB,WAAW,EAAE,IAAI;gBACjB,MAAM,EAAE,uBAAa,CAAC,SAAS;gBAC/B,WAAW,EAAE,IAAI,IAAI,EAAE;aACxB,CAAC,CAAC;YAEH,aAAa,CAAC,iBAAiB,CAAC,SAAS,EAAE;gBACzC,MAAM,EAAE,4BAA4B;gBACpC,WAAW,EAAE,IAAI;gBACjB,MAAM,EAAE,uBAAa,CAAC,SAAS;aAChC,CAAC,CAAC;YAEH,yBAAyB;YACzB,MAAM,mBAAmB,CAAC,kBAAkB,CAC1C,MAAM,EACN,+BAAgB,CAAC,iBAAiB,EAClC,mBAAmB,EACnB,YAAY,SAAS,2BAA2B,EAChD,EAAE,SAAS,EAAE,aAAa,EAAE,MAAM,CAAC,SAAS,CAAC,CAAC,EAAE,GAAG,CAAC,EAAE,CACvD,CAAC;YAEF,eAAM,CAAC,IAAI,CAAC,6BAA6B,GAAG,CAAC,EAAE,2BAA2B,CAAC,CAAC;YAE5E,iGAAiG;QACnG,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,6BAA6B,GAAG,CAAC,EAAE,MAAM,SAAS,WAAW,EAAE,KAAK,CAAC,CAAC;YAEnF,IAAI,CAAC;gBACH,MAAM,WAAW,GAAG,4BAAS,CAAC,GAAG,CAAqB,aAAK,CAAC,iBAAiB,CAAC,CAAC;gBAC/E,MAAM,aAAa,GAAG,4BAAS,CAAC,GAAG,CAAgB,aAAK,CAAC,aAAa,CAAC,CAAC;gBACxE,MAAM,mBAAmB,GAAG,4BAAS,CAAC,GAAG,CAAsB,aAAK,CAAC,mBAAmB,CAAC,CAAC;gBAE1F,MAAM,WAAW,CAAC,MAAM,CAAC,SAAS,EAAE;oBAClC,MAAM,EAAE,uBAAa,CAAC,MAAM;oBAC5B,KAAK,EAAE,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,eAAe;oBAC/D,WAAW,EAAE,IAAI,IAAI,EAAE;iBACxB,CAAC,CAAC;gBAEH,aAAa,CAAC,iBAAiB,CAAC,SAAS,EAAE;oBACzC,MAAM,EAAE,uBAAa,CAAC,MAAM;oBAC5B,KAAK,EAAE,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,eAAe;iBAChE,CAAC,CAAC;gBAEH,MAAM,mBAAmB,CAAC,kBAAkB,CAC1C,MAAM,EACN,+BAAgB,CAAC,cAAc,EAC/B,gBAAgB,EAChB,YAAY,SAAS,aACnB,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,eAC3C,EAAE,EACF,EAAE,SAAS,EAAE,KAAK,EAAE,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,eAAe,EAAE,CAC/E,CAAC;YACJ,CAAC;YAAC,OAAO,SAAS,EAAE,CAAC;gBACnB,eAAM,CAAC,KAAK,CACV,wEAAwE,EACxE,SAAS,CACV,CAAC;YACJ,CAAC;YAED,MAAM,KAAK,CAAC;QACd,CAAC;IACH,CAAC;CACF;AAzLD,wCAyLC","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\infrastructure\\jobs\\SwarmProcessor.ts"],"sourcesContent":["import { Job } from 'bullmq';\nimport { logger } from '../../utils/logger';\nimport { container } from '../../config/inversify.config';\nimport { TYPES } from '../../types';\nimport { AIService } from '../../services/ai.service';\nimport { IMissionRepository } from '../repository/MissionRepository';\nimport { MissionStatus } from '../../models/Mission';\nimport { SocketService } from '../../services/socket.service';\nimport { NotificationService } from '../../services/notification.service';\nimport { NotificationType } from '../../models/Notification';\nimport { SwarmInternalClient } from '../../services/swarm-internal.client';\nimport { KnowledgeGraphService } from '../../services/knowledge-graph.service';\nimport { VaultService } from '../../services/vault.service';\nimport { deriveMissionKey } from '../../utils/secrets';\n\nconst TOKEN_SAFETY_LIMIT = 50000; // Auto-freeze if mission exceeds this estimated limit\n\nexport class SwarmProcessor {\n  /**\n   * Main entry point for processing an autonomous swarm mission.\n   */\n  public static async process(job: Job): Promise<void> {\n    const { objective, userId, missionId, context } = job.data;\n    logger.info(\n      `[SwarmProcessor] Starting mission [${job.id} / ${missionId}] for user ${userId}: ${objective}`,\n    );\n\n    try {\n      // Resolve services from the container\n      const aiService = container.get<AIService>(TYPES.AIService);\n      const missionRepo = container.get<IMissionRepository>(TYPES.MissionRepository);\n      const socketService = container.get<SocketService>(TYPES.SocketService);\n      const notificationService = container.get<NotificationService>(TYPES.NotificationService);\n      const swarmClient = container.get<SwarmInternalClient>(TYPES.SwarmInternalClient);\n      const kgService = container.get<KnowledgeGraphService>(TYPES.KnowledgeGraphService);\n      const vaultService = container.get<VaultService>(TYPES.VaultService);\n\n      // 0. Update status to PLANNING\n      await missionRepo.update(missionId, { status: MissionStatus.PLANNING });\n      socketService.emitMissionUpdate(missionId, { status: MissionStatus.PLANNING });\n\n      // 1. Initial Research & Analysis\n      logger.info(`[SwarmProcessor] [${job.id}] Phase 1: Planning mission strategy...`);\n      const plan = await aiService.generateContent(\n        `\n                You are the Orchestrator for an autonomous AI agent swarm.\n                A user has launched a mission with the following objective: \"${objective}\".\n\n                Develop a concise step-by-step strategy to accomplish this.\n                The system has access to metaverse data, financial yields, and infrastructure metrics.\n                The God Mode dashboard is active.\n\n                Respond only with the technical plan.\n            `,\n        userId,\n      );\n\n      await missionRepo.update(missionId, {\n        plan,\n        status: MissionStatus.EXECUTING,\n      });\n      socketService.emitMissionUpdate(missionId, { plan, status: MissionStatus.EXECUTING });\n\n      // 2. Execution & Autonomous Research\n      logger.info(\n        `[SwarmProcessor] [${job.id}] Phase 2: Executing strategy & autonomous research...`,\n      );\n\n      let specializedResearch = '';\n      const lowerObjective = objective.toLowerCase();\n\n      // Autonomous Decision: Do we need external market research or browsing?\n      if (\n        lowerObjective.includes('mercado') ||\n        lowerObjective.includes('investiga') ||\n        lowerObjective.includes('competidor')\n      ) {\n        logger.info(\n          `[SwarmProcessor] [${job.id}] Autonomous decision: Triggering Swarm Engine Research.`,\n        );\n\n        try {\n          const researchResult = await swarmClient.post('/daniela/market-research', {\n            topic: objective,\n          });\n\n          specializedResearch = researchResult.report || JSON.stringify(researchResult);\n          logger.info(`[SwarmProcessor] [${job.id}] Swarm research completed.`);\n\n          // 2.1 Persist findings to Knowledge Graph (Sovereign Memory)\n          await kgService.indexMissionFindings(missionId, objective, specializedResearch);\n        } catch (researchError) {\n          logger.warn(\n            `[SwarmProcessor] [${job.id}] Autonomous research failed (using internal fallback):`,\n            researchError,\n          );\n          specializedResearch = 'Mission proceeded with internal knowledge context.';\n        }\n      }\n\n      // 3. Final Report (Incorporate research if available)\n      logger.info(`[SwarmProcessor] [${job.id}] Phase 3: Compiling final mission report...`);\n      const report = await aiService.generateContent(\n        `\n                The mission objective was: \"${objective}\".\n                The plan was: \"${plan}\".\n                \n                Additional Swarm Research Context:\n                ${specializedResearch}\n\n                Generate a final summary of results and recommendations for the user.\n                Express why this mission strengthens the AIGestion ecosystem.\n            `,\n        userId,\n      );\n\n      // 3.1 Sovereign Guardrails: Anomaly Detection\n      const estimatedTokens = (plan?.length || 0) / 4 + (report?.length || 0) / 4;\n      if (estimatedTokens > TOKEN_SAFETY_LIMIT) {\n        logger.warn(`[SwarmProcessor] [${job.id}] Sovereign Guardrail triggered: Excessive resource usage detected (${estimatedTokens} tokens). Freezing mission.`);\n        await missionRepo.update(missionId, { \n          status: MissionStatus.FAILED, \n          error: 'SOVEREIGN_RESOURCE_GUARD: Excessive tokens detected. Mission frozen for audit.' \n        });\n        throw new Error('SOVEREIGN_GUARD_FREEZE');\n      }\n\n      // 4. Encrypt Findings for Sovereignty\n      logger.info(`[SwarmProcessor] [${job.id}] Phase 4: Securing findings in Sovereign Vault...`);\n\n      // Derive Mission-Specific Key via HKDF\n      const masterSeed = process.env.JWT_SECRET || 'SOVEREIGN_FALLBACK_SEED'; // In production, derived from user HW key via WebAuthn\n      const missionKey = await deriveMissionKey(masterSeed, missionId, userId);\n\n      const encrypted = await vaultService.encrypt(report, missionKey.toString('hex'));\n\n      // 5. Update Final Status with E2EE\n      await missionRepo.update(missionId, {\n        result: encrypted.ciphertext,\n        vaultIV: encrypted.iv,\n        vaultTag: encrypted.tag,\n        isEncrypted: true,\n        status: MissionStatus.COMPLETED,\n        completedAt: new Date(),\n      });\n\n      socketService.emitMissionUpdate(missionId, {\n        result: '[ENCRYPTED_SOVEREIGN_DATA]',\n        isEncrypted: true,\n        status: MissionStatus.COMPLETED,\n      });\n\n      // 5. Create Notification\n      await notificationService.createNotification(\n        userId,\n        NotificationType.MISSION_COMPLETED,\n        'Mission Completed',\n        `Mission \"${objective}\" completed successfully.`,\n        { missionId, resultPreview: report.substring(0, 100) },\n      );\n\n      logger.info(`[SwarmProcessor] Mission [${job.id}] completed successfully.`);\n\n      // In a real implementation, we might save this results to a DB or notify user via Telegram/Email\n    } catch (error) {\n      logger.error(`[SwarmProcessor] Mission [${job.id} / ${missionId}] failed:`, error);\n\n      try {\n        const missionRepo = container.get<IMissionRepository>(TYPES.MissionRepository);\n        const socketService = container.get<SocketService>(TYPES.SocketService);\n        const notificationService = container.get<NotificationService>(TYPES.NotificationService);\n\n        await missionRepo.update(missionId, {\n          status: MissionStatus.FAILED,\n          error: error instanceof Error ? error.message : 'Unknown error',\n          completedAt: new Date(),\n        });\n\n        socketService.emitMissionUpdate(missionId, {\n          status: MissionStatus.FAILED,\n          error: error instanceof Error ? error.message : 'Unknown error',\n        });\n\n        await notificationService.createNotification(\n          userId,\n          NotificationType.MISSION_FAILED,\n          'Mission Failed',\n          `Mission \"${objective}\" failed: ${\n            error instanceof Error ? error.message : 'Unknown error'\n          }`,\n          { missionId, error: error instanceof Error ? error.message : 'Unknown error' },\n        );\n      } catch (repoError) {\n        logger.error(\n          '[SwarmProcessor] Failed to update mission failure status/notification:',\n          repoError,\n        );\n      }\n\n      throw error;\n    }\n  }\n}\n"],"version":3}