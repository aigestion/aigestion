{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\application\\usecases\\RegisterUserUseCase.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\application\\usecases\\RegisterUserUseCase.ts"],"sourcesContent":["import { injectable, inject } from 'inversify';\nimport bcrypt from 'bcryptjs';\nimport crypto from 'crypto';\nimport jwt from 'jsonwebtoken';\nimport type { IUserRepository } from '../../infrastructure/repository/UserRepository';\nimport { TYPES } from '../../types';\nimport { AppError } from '../../utils/errors';\nimport { config } from '../../config';\n\n@injectable()\nexport class RegisterUserUseCase {\n  constructor(@inject(TYPES.UserRepository) private userRepository: IUserRepository) {}\n\n  async execute(data: { name: string; email: string; password: string }) {\n    const { name, email, password } = data;\n    const existingUser = await this.userRepository.findByEmail(email);\n    if (existingUser) {\n      throw new AppError('El correo electrónico ya está registrado', 400, 'AUTH_ERROR');\n    }\n    const salt = await bcrypt.genSalt(10);\n    const hashedPassword = await bcrypt.hash(password, salt);\n\n    // Generate Verification Code\n    const verificationCode = Math.floor(100000 + Math.random() * 900000).toString();\n    const verificationExpires = new Date(Date.now() + 15 * 60 * 1000); // 15 minutes\n\n    console.log(`[GOD MODE AUTH] Verification Code for ${email}: ${verificationCode}`);\n\n    // Create the user via repository\n    const user = await this.userRepository.create('', {\n      name,\n      email,\n      password: hashedPassword,\n      role: 'user', // Default role, user selects Family/Pro later\n      emailVerificationCode: verificationCode,\n      emailVerificationExpires: verificationExpires,\n      isEmailVerified: false,\n    });\n\n    const token = this.generateToken(user);\n    const refreshToken = this.generateRefreshTokenString(user);\n\n    user.refreshTokens = [\n      {\n        token: refreshToken,\n        expires: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),\n        familyId: crypto.randomUUID(),\n        ip: '127.0.0.1',\n        userAgent: 'unknown',\n        createdAt: new Date(),\n      },\n    ];\n\n    // Use repository to update the user with tokens\n    await this.userRepository.update(user.id, { refreshTokens: user.refreshTokens });\n\n    return { user, token, refreshToken };\n  }\n\n  private generateToken(user: any, fingerprint?: { ip?: string; userAgent?: string }): string {\n    const payload: any = { id: user._id, email: user.email, role: user.role };\n    if (fingerprint) {\n      payload.fingerprint = {\n        ip: fingerprint.ip ?? 'unknown',\n        userAgent: fingerprint.userAgent ?? 'unknown',\n      };\n    }\n    return jwt.sign(payload, config.jwt.secret, { expiresIn: config.jwt.expiresIn as any });\n  }\n\n  private generateRefreshTokenString(user: any, familyId?: string): string {\n    const payload = { id: user._id, familyId: familyId ?? crypto.randomUUID(), type: 'refresh' };\n    return jwt.sign(payload, config.jwt.secret, { expiresIn: '7d' });\n  }\n}\n"],"version":3}