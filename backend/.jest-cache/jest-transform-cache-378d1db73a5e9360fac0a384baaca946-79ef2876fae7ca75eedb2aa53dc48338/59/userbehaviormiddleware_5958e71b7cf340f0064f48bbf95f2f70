f7f0a57201e2debf1436c6f2b59c54df
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.monitorSuspiciousPatterns = exports.checkRiskScore = exports.trackBehavior = exports.userBehaviorMiddleware = exports.UserBehaviorMiddleware = void 0;
const user_behavior_service_1 = require("../services/user-behavior.service");
const logger_1 = require("../utils/logger");
/**
 * Middleware for user behavior analysis
 */
class UserBehaviorMiddleware {
    behaviorService;
    constructor() {
        this.behaviorService = new user_behavior_service_1.UserBehaviorService();
        // Start cleanup interval
        setInterval(() => {
            this.behaviorService.cleanup();
        }, 60 * 60 * 1000); // Every hour
    }
    /**
     * Track user behavior events
     */
    trackBehavior = (eventType) => {
        return async (req, res, next) => {
            try {
                if (!req.user || !req.user.id) {
                    return next();
                }
                const event = {
                    userId: req.user.id,
                    eventType,
                    timestamp: new Date(),
                    ipAddress: this.getClientIP(req),
                    userAgent: req.get('User-Agent') || 'unknown',
                    sessionId: req.sessionId || this.generateSessionId(req),
                    metadata: this.extractMetadata(req, eventType),
                };
                await this.behaviorService.trackEvent(event);
                // Add behavior headers
                const profile = await this.behaviorService.getUserProfile(req.user.id);
                if (profile) {
                    res.setHeader('X-Behavior-Risk-Score', profile.riskScore.toString());
                    res.setHeader('X-Behavior-Session-Id', event.sessionId);
                }
                next();
            }
            catch (error) {
                logger_1.logger.error('Error tracking user behavior:', error);
                next(); // Continue on error to avoid breaking functionality
            }
        };
    };
    /**
     * Check user risk score and take action if needed
     */
    checkRiskScore = async (req, res, next) => {
        try {
            if (!req.user || !req.user.id) {
                return next();
            }
            const profile = await this.behaviorService.getUserProfile(req.user.id);
            if (!profile) {
                return next();
            }
            // Add risk score header
            res.setHeader('X-Behavior-Risk-Score', profile.riskScore.toString());
            // Take action based on risk score
            if (profile.riskScore >= 80) {
                logger_1.logger.warn('High risk user detected', {
                    userId: req.user.id,
                    riskScore: profile.riskScore,
                    ipAddress: this.getClientIP(req),
                });
                // Require additional authentication
                res.setHeader('X-Behavior-Action', 'additional-auth-required');
                return res.status(403).json({
                    success: false,
                    error: 'Additional authentication required',
                    code: 'HIGH_RISK_USER',
                    data: {
                        riskScore: profile.riskScore,
                        reason: 'Unusual behavior detected',
                    },
                });
            }
            else if (profile.riskScore >= 60) {
                logger_1.logger.warn('Medium risk user detected', {
                    userId: req.user.id,
                    riskScore: profile.riskScore,
                });
                // Add warning headers
                res.setHeader('X-Behavior-Action', 'monitor');
                res.setHeader('X-Behavior-Warning', 'true');
            }
            next();
        }
        catch (error) {
            logger_1.logger.error('Error checking risk score:', error);
            next();
        }
    };
    /**
     * Monitor for suspicious patterns
     */
    monitorSuspiciousPatterns = async (req, res, next) => {
        try {
            if (!req.user || !req.user.id) {
                return next();
            }
            const profile = await this.behaviorService.getUserProfile(req.user.id);
            if (!profile) {
                return next();
            }
            // Check for rapid successive requests
            const session = profile.currentSession;
            const sessionDuration = Date.now() - session.startTime.getTime();
            const requestsPerMinute = session.apiCalls / (sessionDuration / 60000);
            if (requestsPerMinute > 100) {
                logger_1.logger.warn('High frequency requests detected', {
                    userId: req.user.id,
                    requestsPerMinute,
                    sessionDuration,
                });
                res.setHeader('X-Behavior-Pattern', 'high-frequency');
                // Rate limit more aggressively
                if (requestsPerMinute > 500) {
                    return res.status(429).json({
                        success: false,
                        error: 'Rate limit exceeded due to unusual activity',
                        code: 'BEHAVIOR_RATE_LIMIT',
                    });
                }
            }
            // Check for error patterns
            if (session.errors > 10 && session.apiCalls > 0) {
                const errorRate = session.errors / session.apiCalls;
                if (errorRate > 0.5) {
                    logger_1.logger.warn('High error rate detected', {
                        userId: req.user.id,
                        errorRate,
                        errors: session.errors,
                        apiCalls: session.apiCalls,
                    });
                    res.setHeader('X-Behavior-Pattern', 'high-error-rate');
                }
            }
            next();
        }
        catch (error) {
            logger_1.logger.error('Error monitoring suspicious patterns:', error);
            next();
        }
    };
    /**
     * Generate session ID
     */
    generateSessionId(req) {
        const ip = this.getClientIP(req);
        const userAgent = req.get('User-Agent') || 'unknown';
        const timestamp = Date.now();
        return Buffer.from(`${ip}:${userAgent}:${timestamp}`).toString('base64').substring(0, 32);
    }
    /**
     * Get client IP address
     */
    getClientIP(req) {
        const socket = req.connection?.socket;
        return (req.ip ||
            req.connection.remoteAddress ||
            req.socket.remoteAddress ||
            socket?.remoteAddress ||
            'unknown');
    }
    /**
     * Extract metadata from request
     */
    extractMetadata(req, eventType) {
        const metadata = {
            path: req.path,
            method: req.method,
            query: req.query,
            timestamp: new Date().toISOString(),
        };
        // Add specific metadata based on event type
        switch (eventType) {
            case 'login':
                metadata.loginMethod = req.body?.method || 'password';
                metadata.success = req.body?.success || true;
                break;
            case 'file_upload':
                if (req.file) {
                    metadata.fileSize = req.file.size;
                    metadata.fileType = req.file.mimetype;
                    metadata.fileName = req.file.originalname;
                }
                break;
            case 'api_call':
                metadata.endpoint = req.path;
                metadata.responseTime = req.get('X-Response-Time');
                metadata.statusCode = req.res?.statusCode;
                break;
            case 'error':
                metadata.error = req.body?.error || 'Unknown error';
                metadata.errorCode = req.body?.errorCode;
                metadata.stack = req.body?.stack;
                break;
            case 'permission_denied':
                metadata.resource = req.body?.resource || 'Unknown resource';
                metadata.action = req.body?.action || 'Unknown action';
                metadata.requiredPermission = req.body?.requiredPermission;
                break;
            case 'data_access':
                metadata.resource =
                    req.body?.resource || req.params?.resource || req.query?.resource;
                metadata.action = req.body?.action || req.method?.toLowerCase();
                metadata.dataType = req.body?.dataType || 'unknown';
                break;
            case 'page_view':
                metadata.referrer = req.get('Referer');
                metadata.page = req.path;
                metadata.duration = req.body?.duration;
                break;
        }
        // Add user information
        if (req.user) {
            metadata.userId = req.user.id;
            metadata.userEmail = req.user.email;
            metadata.userRole = req.user.role;
        }
        return metadata;
    }
    /**
     * Get behavior statistics
     */
    getStats = async (_req, res) => {
        try {
            const stats = await this.behaviorService.getStats();
            res.json({
                success: true,
                data: stats,
            });
        }
        catch (error) {
            logger_1.logger.error('Error getting behavior stats:', error);
            res.status(500).json({
                success: false,
                error: 'Failed to get behavior statistics',
            });
        }
    };
    /**
     * Get user behavior profile
     */
    getUserProfile = async (req, res) => {
        try {
            const { userId } = req.params;
            const userIdStr = Array.isArray(userId) ? userId[0] : userId;
            if (!userIdStr) {
                return res.status(400).json({
                    success: false,
                    error: 'userId is required',
                });
            }
            const profile = await this.behaviorService.getUserProfile(userIdStr);
            if (!profile) {
                return res.status(404).json({
                    success: false,
                    error: 'User behavior profile not found',
                });
            }
            res.json({
                success: true,
                data: profile,
            });
        }
        catch (error) {
            logger_1.logger.error('Error getting user profile:', error);
            res.status(500).json({
                success: false,
                error: 'Failed to get user behavior profile',
            });
        }
    };
    /**
     * Get user anomalies
     */
    getUserAnomalies = async (req, res) => {
        try {
            const { userId } = req.params;
            const limitParam = req.query.limit;
            const limitStr = Array.isArray(limitParam) ? limitParam[0] : limitParam;
            const limit = limitStr ? parseInt(limitStr) : 50;
            const userIdStr = Array.isArray(userId) ? userId[0] : userId;
            if (!userIdStr) {
                return res.status(400).json({
                    success: false,
                    error: 'userId is required',
                });
            }
            const anomalies = await this.behaviorService.getUserAnomalies(userIdStr, limit);
            res.json({
                success: true,
                data: anomalies,
            });
        }
        catch (error) {
            logger_1.logger.error('Error getting user anomalies:', error);
            res.status(500).json({
                success: false,
                error: 'Failed to get user anomalies',
            });
        }
    };
    /**
     * Get recent anomalies
     */
    getRecentAnomalies = async (req, res) => {
        try {
            const limitParam = req.query.limit;
            const limitStr = Array.isArray(limitParam) ? limitParam[0] : limitParam;
            const limit = limitStr ? parseInt(limitStr) : 100;
            const anomalies = await this.behaviorService.getRecentAnomalies(limit);
            res.json({
                success: true,
                data: anomalies,
            });
        }
        catch (error) {
            logger_1.logger.error('Error getting recent anomalies:', error);
            res.status(500).json({
                success: false,
                error: 'Failed to get recent anomalies',
            });
        }
    };
    /**
     * Resolve anomaly
     */
    resolveAnomaly = async (req, res) => {
        try {
            const { anomalyId } = req.params;
            const anomalyIdStr = Array.isArray(anomalyId) ? anomalyId[0] : anomalyId;
            if (!anomalyIdStr) {
                return res.status(400).json({
                    success: false,
                    error: 'anomalyId is required',
                });
            }
            const success = await this.behaviorService.resolveAnomaly(anomalyIdStr);
            res.json({
                success: true,
                data: { resolved: success },
            });
        }
        catch (error) {
            logger_1.logger.error('Error resolving anomaly:', error);
            res.status(500).json({
                success: false,
                error: 'Failed to resolve anomaly',
            });
        }
    };
}
exports.UserBehaviorMiddleware = UserBehaviorMiddleware;
// Export singleton instance
exports.userBehaviorMiddleware = new UserBehaviorMiddleware();
// Export convenience methods
exports.trackBehavior = exports.userBehaviorMiddleware.trackBehavior;
exports.checkRiskScore = exports.userBehaviorMiddleware.checkRiskScore;
exports.monitorSuspiciousPatterns = exports.userBehaviorMiddleware.monitorSuspiciousPatterns;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxtaWRkbGV3YXJlXFx1c2VyLWJlaGF2aW9yLm1pZGRsZXdhcmUudHMiLCJtYXBwaW5ncyI6Ijs7O0FBRUEsNkVBQXdFO0FBQ3hFLDRDQUF5QztBQXVCekM7O0dBRUc7QUFDSCxNQUFhLHNCQUFzQjtJQUN6QixlQUFlLENBQXNCO0lBRTdDO1FBQ0UsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLDJDQUFtQixFQUFFLENBQUM7UUFFakQseUJBQXlCO1FBQ3pCLFdBQVcsQ0FDVCxHQUFHLEVBQUU7WUFDSCxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ2pDLENBQUMsRUFDRCxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FDZixDQUFDLENBQUMsYUFBYTtJQUNsQixDQUFDO0lBRUQ7O09BRUc7SUFDSSxhQUFhLEdBQUcsQ0FDckIsU0FRaUIsRUFDakIsRUFBRTtRQUNGLE9BQU8sS0FBSyxFQUFFLEdBQW9CLEVBQUUsR0FBYSxFQUFFLElBQWtCLEVBQUUsRUFBRTtZQUN2RSxJQUFJLENBQUM7Z0JBQ0gsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO29CQUM5QixPQUFPLElBQUksRUFBRSxDQUFDO2dCQUNoQixDQUFDO2dCQUVELE1BQU0sS0FBSyxHQUFHO29CQUNaLE1BQU0sRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUU7b0JBQ25CLFNBQVM7b0JBQ1QsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO29CQUNyQixTQUFTLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUM7b0JBQ2hDLFNBQVMsRUFBRSxHQUFHLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxJQUFJLFNBQVM7b0JBQzdDLFNBQVMsRUFBRSxHQUFHLENBQUMsU0FBUyxJQUFJLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLENB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RSxJQUFJO2dCQUNiLElBQUksRUFBRSxFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQUU7YUFDNUIsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixlQUFNLENBQUMsS0FBSyxDQUFDLDBCQUEwQixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ2hELEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUNuQixPQUFPLEVBQUUsS0FBSztnQkFDZCxLQUFLLEVBQUUsMkJBQTJCO2FBQ25DLENBQUMsQ0FBQztRQUNMLENBQUM7SUFDSCxDQUFDLENBQUM7Q0FDSDtBQWhhRCx3REFnYUM7QUFFRCw0QkFBNEI7QUFDZixRQUFBLHNCQUFzQixHQUFHLElBQUksc0JBQXNCLEVBQUUsQ0FBQztBQUVuRSw2QkFBNkI7QUFDaEIsUUFBQSxhQUFhLEdBQUcsOEJBQXNCLENBQUMsYUFBYSxDQUFDO0FBQ3JELFFBQUEsY0FBYyxHQUFHLDhCQUFzQixDQUFDLGNBQWMsQ0FBQztBQUN2RCxRQUFBLHlCQUF5QixHQUFHLDhCQUFzQixDQUFDLHlCQUF5QixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcQWxlamFuZHJvXFxBSUdlc3Rpb25cXGJhY2tlbmRcXHNyY1xcbWlkZGxld2FyZVxcdXNlci1iZWhhdmlvci5taWRkbGV3YXJlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE5leHRGdW5jdGlvbiwgUmVxdWVzdCwgUmVzcG9uc2UgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IFNvY2tldCB9IGZyb20gJ25ldCc7XG5pbXBvcnQgeyBVc2VyQmVoYXZpb3JTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvdXNlci1iZWhhdmlvci5zZXJ2aWNlJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uL3V0aWxzL2xvZ2dlcic7XG5cbmludGVyZmFjZSBCZWhhdmlvclVzZXIge1xuICBpZDogc3RyaW5nO1xuICBlbWFpbDogc3RyaW5nO1xuICByb2xlOiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBCZWhhdmlvclJlcXVlc3QgZXh0ZW5kcyBSZXF1ZXN0IHtcbiAgdXNlcj86IEJlaGF2aW9yVXNlcjtcbiAgc2Vzc2lvbklkPzogc3RyaW5nO1xuICBmaWxlPzogeyBzaXplOiBudW1iZXI7IG1pbWV0eXBlOiBzdHJpbmc7IG9yaWdpbmFsbmFtZTogc3RyaW5nIH0gfCBhbnk7XG4gIHJlcz86IFJlc3BvbnNlO1xufVxuXG5pbnRlcmZhY2UgRXZlbnRNZXRhZGF0YSB7XG4gIHBhdGg6IHN0cmluZztcbiAgbWV0aG9kOiBzdHJpbmc7XG4gIHF1ZXJ5OiBhbnk7XG4gIHRpbWVzdGFtcDogc3RyaW5nO1xuICBba2V5OiBzdHJpbmddOiBhbnk7XG59XG5cbi8qKlxuICogTWlkZGxld2FyZSBmb3IgdXNlciBiZWhhdmlvciBhbmFseXNpc1xuICovXG5leHBvcnQgY2xhc3MgVXNlckJlaGF2aW9yTWlkZGxld2FyZSB7XG4gIHByaXZhdGUgYmVoYXZpb3JTZXJ2aWNlOiBVc2VyQmVoYXZpb3JTZXJ2aWNlO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMuYmVoYXZpb3JTZXJ2aWNlID0gbmV3IFVzZXJCZWhhdmlvclNlcnZpY2UoKTtcblxuICAgIC8vIFN0YXJ0IGNsZWFudXAgaW50ZXJ2YWxcbiAgICBzZXRJbnRlcnZhbChcbiAgICAgICgpID0+IHtcbiAgICAgICAgdGhpcy5iZWhhdmlvclNlcnZpY2UuY2xlYW51cCgpO1xuICAgICAgfSxcbiAgICAgIDYwICogNjAgKiAxMDAwLFxuICAgICk7IC8vIEV2ZXJ5IGhvdXJcbiAgfVxuXG4gIC8qKlxuICAgKiBUcmFjayB1c2VyIGJlaGF2aW9yIGV2ZW50c1xuICAgKi9cbiAgcHVibGljIHRyYWNrQmVoYXZpb3IgPSAoXG4gICAgZXZlbnRUeXBlOlxuICAgICAgfCAnbG9naW4nXG4gICAgICB8ICdsb2dvdXQnXG4gICAgICB8ICdmaWxlX3VwbG9hZCdcbiAgICAgIHwgJ2FwaV9jYWxsJ1xuICAgICAgfCAncGFnZV92aWV3J1xuICAgICAgfCAnZXJyb3InXG4gICAgICB8ICdwZXJtaXNzaW9uX2RlbmllZCdcbiAgICAgIHwgJ2RhdGFfYWNjZXNzJyxcbiAgKSA9PiB7XG4gICAgcmV0dXJuIGFzeW5jIChyZXE6IEJlaGF2aW9yUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBpZiAoIXJlcS51c2VyIHx8ICFyZXEudXNlci5pZCkge1xuICAgICAgICAgIHJldHVybiBuZXh0KCk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBldmVudCA9IHtcbiAgICAgICAgICB1c2VySWQ6IHJlcS51c2VyLmlkLFxuICAgICAgICAgIGV2ZW50VHlwZSxcbiAgICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICAgICAgaXBBZGRyZXNzOiB0aGlzLmdldENsaWVudElQKHJlcSksXG4gICAgICAgICAgdXNlckFnZW50OiByZXEuZ2V0KCdVc2VyLUFnZW50JykgfHwgJ3Vua25vd24nLFxuICAgICAgICAgIHNlc3Npb25JZDogcmVxLnNlc3Npb25JZCB8fCB0aGlzLmdlbmVyYXRlU2Vzc2lvbklkKHJlcSksXG4gICAgICAgICAgbWV0YWRhdGE6IHRoaXMuZXh0cmFjdE1ldGFkYXRhKHJlcSwgZXZlbnRUeXBlKSxcbiAgICAgICAgfTtcblxuICAgICAgICBhd2FpdCB0aGlzLmJlaGF2aW9yU2VydmljZS50cmFja0V2ZW50KGV2ZW50KTtcblxuICAgICAgICAvLyBBZGQgYmVoYXZpb3IgaGVhZGVyc1xuICAgICAgICBjb25zdCBwcm9maWxlID0gYXdhaXQgdGhpcy5iZWhhdmlvclNlcnZpY2UuZ2V0VXNlclByb2ZpbGUocmVxLnVzZXIuaWQpO1xuICAgICAgICBpZiAocHJvZmlsZSkge1xuICAgICAgICAgIHJlcy5zZXRIZWFkZXIoJ1gtQmVoYXZpb3ItUmlzay1TY29yZScsIHByb2ZpbGUucmlza1Njb3JlLnRvU3RyaW5nKCkpO1xuICAgICAgICAgIHJlcy5zZXRIZWFkZXIoJ1gtQmVoYXZpb3ItU2Vzc2lvbi1JZCcsIGV2ZW50LnNlc3Npb25JZCk7XG4gICAgICAgIH1cblxuICAgICAgICBuZXh0KCk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIHRyYWNraW5nIHVzZXIgYmVoYXZpb3I6JywgZXJyb3IpO1xuICAgICAgICBuZXh0KCk7IC8vIENvbnRpbnVlIG9uIGVycm9yIHRvIGF2b2lkIGJyZWFraW5nIGZ1bmN0aW9uYWxpdHlcbiAgICAgIH1cbiAgICB9O1xuICB9O1xuXG4gIC8qKlxuICAgKiBDaGVjayB1c2VyIHJpc2sgc2NvcmUgYW5kIHRha2UgYWN0aW9uIGlmIG5lZWRlZFxuICAgKi9cbiAgcHVibGljIGNoZWNrUmlza1Njb3JlID0gYXN5bmMgKHJlcTogQmVoYXZpb3JSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcbiAgICB0cnkge1xuICAgICAgaWYgKCFyZXEudXNlciB8fCAhcmVxLnVzZXIuaWQpIHtcbiAgICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcHJvZmlsZSA9IGF3YWl0IHRoaXMuYmVoYXZpb3JTZXJ2aWNlLmdldFVzZXJQcm9maWxlKHJlcS51c2VyLmlkKTtcbiAgICAgIGlmICghcHJvZmlsZSkge1xuICAgICAgICByZXR1cm4gbmV4dCgpO1xuICAgICAgfVxuXG4gICAgICAvLyBBZGQgcmlzayBzY29yZSBoZWFkZXJcbiAgICAgIHJlcy5zZXRIZWFkZXIoJ1gtQmVoYXZpb3ItUmlzay1TY29yZScsIHByb2ZpbGUucmlza1Njb3JlLnRvU3RyaW5nKCkpO1xuXG4gICAgICAvLyBUYWtlIGFjdGlvbiBiYXNlZCBvbiByaXNrIHNjb3JlXG4gICAgICBpZiAocHJvZmlsZS5yaXNrU2NvcmUgPj0gODApIHtcbiAgICAgICAgbG9nZ2VyLndhcm4oJ0hpZ2ggcmlzayB1c2VyIGRldGVjdGVkJywge1xuICAgICAgICAgIHVzZXJJZDogcmVxLnVzZXIuaWQsXG4gICAgICAgICAgcmlza1Njb3JlOiBwcm9maWxlLnJpc2tTY29yZSxcbiAgICAgICAgICBpcEFkZHJlc3M6IHRoaXMuZ2V0Q2xpZW50SVAocmVxKSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gUmVxdWlyZSBhZGRpdGlvbmFsIGF1dGhlbnRpY2F0aW9uXG4gICAgICAgIHJlcy5zZXRIZWFkZXIoJ1gtQmVoYXZpb3ItQWN0aW9uJywgJ2FkZGl0aW9uYWwtYXV0aC1yZXF1aXJlZCcpO1xuXG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgZXJyb3I6ICdBZGRpdGlvbmFsIGF1dGhlbnRpY2F0aW9uIHJlcXVpcmVkJyxcbiAgICAgICAgICBjb2RlOiAnSElHSF9SSVNLX1VTRVInLFxuICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIHJpc2tTY29yZTogcHJvZmlsZS5yaXNrU2NvcmUsXG4gICAgICAgICAgICByZWFzb246ICdVbnVzdWFsIGJlaGF2aW9yIGRldGVjdGVkJyxcbiAgICAgICAgICB9LFxuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSBpZiAocHJvZmlsZS5yaXNrU2NvcmUgPj0gNjApIHtcbiAgICAgICAgbG9nZ2VyLndhcm4oJ01lZGl1bSByaXNrIHVzZXIgZGV0ZWN0ZWQnLCB7XG4gICAgICAgICAgdXNlcklkOiByZXEudXNlci5pZCxcbiAgICAgICAgICByaXNrU2NvcmU6IHByb2ZpbGUucmlza1Njb3JlLFxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBBZGQgd2FybmluZyBoZWFkZXJzXG4gICAgICAgIHJlcy5zZXRIZWFkZXIoJ1gtQmVoYXZpb3ItQWN0aW9uJywgJ21vbml0b3InKTtcbiAgICAgICAgcmVzLnNldEhlYWRlcignWC1CZWhhdmlvci1XYXJuaW5nJywgJ3RydWUnKTtcbiAgICAgIH1cblxuICAgICAgbmV4dCgpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGNoZWNraW5nIHJpc2sgc2NvcmU6JywgZXJyb3IpO1xuICAgICAgbmV4dCgpO1xuICAgIH1cbiAgfTtcblxuICAvKipcbiAgICogTW9uaXRvciBmb3Igc3VzcGljaW91cyBwYXR0ZXJuc1xuICAgKi9cbiAgcHVibGljIG1vbml0b3JTdXNwaWNpb3VzUGF0dGVybnMgPSBhc3luYyAoXG4gICAgcmVxOiBCZWhhdmlvclJlcXVlc3QsXG4gICAgcmVzOiBSZXNwb25zZSxcbiAgICBuZXh0OiBOZXh0RnVuY3Rpb24sXG4gICkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBpZiAoIXJlcS51c2VyIHx8ICFyZXEudXNlci5pZCkge1xuICAgICAgICByZXR1cm4gbmV4dCgpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBwcm9maWxlID0gYXdhaXQgdGhpcy5iZWhhdmlvclNlcnZpY2UuZ2V0VXNlclByb2ZpbGUocmVxLnVzZXIuaWQpO1xuICAgICAgaWYgKCFwcm9maWxlKSB7XG4gICAgICAgIHJldHVybiBuZXh0KCk7XG4gICAgICB9XG5cbiAgICAgIC8vIENoZWNrIGZvciByYXBpZCBzdWNjZXNzaXZlIHJlcXVlc3RzXG4gICAgICBjb25zdCBzZXNzaW9uID0gcHJvZmlsZS5jdXJyZW50U2Vzc2lvbjtcbiAgICAgIGNvbnN0IHNlc3Npb25EdXJhdGlvbiA9IERhdGUubm93KCkgLSBzZXNzaW9uLnN0YXJ0VGltZS5nZXRUaW1lKCk7XG4gICAgICBjb25zdCByZXF1ZXN0c1Blck1pbnV0ZSA9IHNlc3Npb24uYXBpQ2FsbHMgLyAoc2Vzc2lvbkR1cmF0aW9uIC8gNjAwMDApO1xuXG4gICAgICBpZiAocmVxdWVzdHNQZXJNaW51dGUgPiAxMDApIHtcbiAgICAgICAgbG9nZ2VyLndhcm4oJ0hpZ2ggZnJlcXVlbmN5IHJlcXVlc3RzIGRldGVjdGVkJywge1xuICAgICAgICAgIHVzZXJJZDogcmVxLnVzZXIuaWQsXG4gICAgICAgICAgcmVxdWVzdHNQZXJNaW51dGUsXG4gICAgICAgICAgc2Vzc2lvbkR1cmF0aW9uLFxuICAgICAgICB9KTtcblxuICAgICAgICByZXMuc2V0SGVhZGVyKCdYLUJlaGF2aW9yLVBhdHRlcm4nLCAnaGlnaC1mcmVxdWVuY3knKTtcblxuICAgICAgICAvLyBSYXRlIGxpbWl0IG1vcmUgYWdncmVzc2l2ZWx5XG4gICAgICAgIGlmIChyZXF1ZXN0c1Blck1pbnV0ZSA+IDUwMCkge1xuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQyOSkuanNvbih7XG4gICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICAgIGVycm9yOiAnUmF0ZSBsaW1pdCBleGNlZWRlZCBkdWUgdG8gdW51c3VhbCBhY3Rpdml0eScsXG4gICAgICAgICAgICBjb2RlOiAnQkVIQVZJT1JfUkFURV9MSU1JVCcsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgLy8gQ2hlY2sgZm9yIGVycm9yIHBhdHRlcm5zXG4gICAgICBpZiAoc2Vzc2lvbi5lcnJvcnMgPiAxMCAmJiBzZXNzaW9uLmFwaUNhbGxzID4gMCkge1xuICAgICAgICBjb25zdCBlcnJvclJhdGUgPSBzZXNzaW9uLmVycm9ycyAvIHNlc3Npb24uYXBpQ2FsbHM7XG4gICAgICAgIGlmIChlcnJvclJhdGUgPiAwLjUpIHtcbiAgICAgICAgICBsb2dnZXIud2FybignSGlnaCBlcnJvciByYXRlIGRldGVjdGVkJywge1xuICAgICAgICAgICAgdXNlcklkOiByZXEudXNlci5pZCxcbiAgICAgICAgICAgIGVycm9yUmF0ZSxcbiAgICAgICAgICAgIGVycm9yczogc2Vzc2lvbi5lcnJvcnMsXG4gICAgICAgICAgICBhcGlDYWxsczogc2Vzc2lvbi5hcGlDYWxscyxcbiAgICAgICAgICB9KTtcblxuICAgICAgICAgIHJlcy5zZXRIZWFkZXIoJ1gtQmVoYXZpb3ItUGF0dGVybicsICdoaWdoLWVycm9yLXJhdGUnKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBuZXh0KCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignRXJyb3IgbW9uaXRvcmluZyBzdXNwaWNpb3VzIHBhdHRlcm5zOicsIGVycm9yKTtcbiAgICAgIG5leHQoKTtcbiAgICB9XG4gIH07XG5cbiAgLyoqXG4gICAqIEdlbmVyYXRlIHNlc3Npb24gSURcbiAgICovXG4gIHByaXZhdGUgZ2VuZXJhdGVTZXNzaW9uSWQocmVxOiBSZXF1ZXN0KTogc3RyaW5nIHtcbiAgICBjb25zdCBpcCA9IHRoaXMuZ2V0Q2xpZW50SVAocmVxKTtcbiAgICBjb25zdCB1c2VyQWdlbnQgPSByZXEuZ2V0KCdVc2VyLUFnZW50JykgfHwgJ3Vua25vd24nO1xuICAgIGNvbnN0IHRpbWVzdGFtcCA9IERhdGUubm93KCk7XG5cbiAgICByZXR1cm4gQnVmZmVyLmZyb20oYCR7aXB9OiR7dXNlckFnZW50fToke3RpbWVzdGFtcH1gKS50b1N0cmluZygnYmFzZTY0Jykuc3Vic3RyaW5nKDAsIDMyKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgY2xpZW50IElQIGFkZHJlc3NcbiAgICovXG4gIHByaXZhdGUgZ2V0Q2xpZW50SVAocmVxOiBCZWhhdmlvclJlcXVlc3QpOiBzdHJpbmcge1xuICAgIGNvbnN0IHNvY2tldCA9IChyZXEuY29ubmVjdGlvbiBhcyBhbnkpPy5zb2NrZXQgYXMgU29ja2V0IHwgdW5kZWZpbmVkO1xuICAgIHJldHVybiAoXG4gICAgICByZXEuaXAgfHxcbiAgICAgIHJlcS5jb25uZWN0aW9uLnJlbW90ZUFkZHJlc3MgfHxcbiAgICAgIHJlcS5zb2NrZXQucmVtb3RlQWRkcmVzcyB8fFxuICAgICAgc29ja2V0Py5yZW1vdGVBZGRyZXNzIHx8XG4gICAgICAndW5rbm93bidcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIEV4dHJhY3QgbWV0YWRhdGEgZnJvbSByZXF1ZXN0XG4gICAqL1xuICBwcml2YXRlIGV4dHJhY3RNZXRhZGF0YShyZXE6IEJlaGF2aW9yUmVxdWVzdCwgZXZlbnRUeXBlOiBzdHJpbmcpOiBFdmVudE1ldGFkYXRhIHtcbiAgICBjb25zdCBtZXRhZGF0YTogRXZlbnRNZXRhZGF0YSA9IHtcbiAgICAgIHBhdGg6IHJlcS5wYXRoLFxuICAgICAgbWV0aG9kOiByZXEubWV0aG9kLFxuICAgICAgcXVlcnk6IHJlcS5xdWVyeSxcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgIH07XG5cbiAgICAvLyBBZGQgc3BlY2lmaWMgbWV0YWRhdGEgYmFzZWQgb24gZXZlbnQgdHlwZVxuICAgIHN3aXRjaCAoZXZlbnRUeXBlKSB7XG4gICAgICBjYXNlICdsb2dpbic6XG4gICAgICAgIG1ldGFkYXRhLmxvZ2luTWV0aG9kID0gcmVxLmJvZHk/Lm1ldGhvZCB8fCAncGFzc3dvcmQnO1xuICAgICAgICBtZXRhZGF0YS5zdWNjZXNzID0gcmVxLmJvZHk/LnN1Y2Nlc3MgfHwgdHJ1ZTtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgJ2ZpbGVfdXBsb2FkJzpcbiAgICAgICAgaWYgKHJlcS5maWxlKSB7XG4gICAgICAgICAgbWV0YWRhdGEuZmlsZVNpemUgPSByZXEuZmlsZS5zaXplO1xuICAgICAgICAgIG1ldGFkYXRhLmZpbGVUeXBlID0gcmVxLmZpbGUubWltZXR5cGU7XG4gICAgICAgICAgbWV0YWRhdGEuZmlsZU5hbWUgPSByZXEuZmlsZS5vcmlnaW5hbG5hbWU7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgJ2FwaV9jYWxsJzpcbiAgICAgICAgbWV0YWRhdGEuZW5kcG9pbnQgPSByZXEucGF0aDtcbiAgICAgICAgbWV0YWRhdGEucmVzcG9uc2VUaW1lID0gcmVxLmdldCgnWC1SZXNwb25zZS1UaW1lJyk7XG4gICAgICAgIG1ldGFkYXRhLnN0YXR1c0NvZGUgPSByZXEucmVzPy5zdGF0dXNDb2RlO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSAnZXJyb3InOlxuICAgICAgICBtZXRhZGF0YS5lcnJvciA9IHJlcS5ib2R5Py5lcnJvciB8fCAnVW5rbm93biBlcnJvcic7XG4gICAgICAgIG1ldGFkYXRhLmVycm9yQ29kZSA9IHJlcS5ib2R5Py5lcnJvckNvZGU7XG4gICAgICAgIG1ldGFkYXRhLnN0YWNrID0gcmVxLmJvZHk/LnN0YWNrO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSAncGVybWlzc2lvbl9kZW5pZWQnOlxuICAgICAgICBtZXRhZGF0YS5yZXNvdXJjZSA9IHJlcS5ib2R5Py5yZXNvdXJjZSB8fCAnVW5rbm93biByZXNvdXJjZSc7XG4gICAgICAgIG1ldGFkYXRhLmFjdGlvbiA9IHJlcS5ib2R5Py5hY3Rpb24gfHwgJ1Vua25vd24gYWN0aW9uJztcbiAgICAgICAgbWV0YWRhdGEucmVxdWlyZWRQZXJtaXNzaW9uID0gcmVxLmJvZHk/LnJlcXVpcmVkUGVybWlzc2lvbjtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgJ2RhdGFfYWNjZXNzJzpcbiAgICAgICAgbWV0YWRhdGEucmVzb3VyY2UgPVxuICAgICAgICAgIHJlcS5ib2R5Py5yZXNvdXJjZSB8fCAocmVxLnBhcmFtcyBhcyBhbnkpPy5yZXNvdXJjZSB8fCAocmVxLnF1ZXJ5IGFzIGFueSk/LnJlc291cmNlO1xuICAgICAgICBtZXRhZGF0YS5hY3Rpb24gPSByZXEuYm9keT8uYWN0aW9uIHx8IHJlcS5tZXRob2Q/LnRvTG93ZXJDYXNlKCk7XG4gICAgICAgIG1ldGFkYXRhLmRhdGFUeXBlID0gcmVxLmJvZHk/LmRhdGFUeXBlIHx8ICd1bmtub3duJztcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgJ3BhZ2Vfdmlldyc6XG4gICAgICAgIG1ldGFkYXRhLnJlZmVycmVyID0gcmVxLmdldCgnUmVmZXJlcicpO1xuICAgICAgICBtZXRhZGF0YS5wYWdlID0gcmVxLnBhdGg7XG4gICAgICAgIG1ldGFkYXRhLmR1cmF0aW9uID0gcmVxLmJvZHk/LmR1cmF0aW9uO1xuICAgICAgICBicmVhaztcbiAgICB9XG5cbiAgICAvLyBBZGQgdXNlciBpbmZvcm1hdGlvblxuICAgIGlmIChyZXEudXNlcikge1xuICAgICAgbWV0YWRhdGEudXNlcklkID0gcmVxLnVzZXIuaWQ7XG4gICAgICBtZXRhZGF0YS51c2VyRW1haWwgPSByZXEudXNlci5lbWFpbDtcbiAgICAgIG1ldGFkYXRhLnVzZXJSb2xlID0gcmVxLnVzZXIucm9sZTtcbiAgICB9XG5cbiAgICByZXR1cm4gbWV0YWRhdGE7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGJlaGF2aW9yIHN0YXRpc3RpY3NcbiAgICovXG4gIHB1YmxpYyBnZXRTdGF0cyA9IGFzeW5jIChfcmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHN0YXRzID0gYXdhaXQgdGhpcy5iZWhhdmlvclNlcnZpY2UuZ2V0U3RhdHMoKTtcblxuICAgICAgcmVzLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBkYXRhOiBzdGF0cyxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGdldHRpbmcgYmVoYXZpb3Igc3RhdHM6JywgZXJyb3IpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6ICdGYWlsZWQgdG8gZ2V0IGJlaGF2aW9yIHN0YXRpc3RpY3MnLFxuICAgICAgfSk7XG4gICAgfVxuICB9O1xuXG4gIC8qKlxuICAgKiBHZXQgdXNlciBiZWhhdmlvciBwcm9maWxlXG4gICAqL1xuICBwdWJsaWMgZ2V0VXNlclByb2ZpbGUgPSBhc3luYyAocmVxOiBCZWhhdmlvclJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyB1c2VySWQgfSA9IHJlcS5wYXJhbXM7XG4gICAgICBjb25zdCB1c2VySWRTdHIgPSBBcnJheS5pc0FycmF5KHVzZXJJZCkgPyB1c2VySWRbMF0gOiB1c2VySWQ7XG5cbiAgICAgIGlmICghdXNlcklkU3RyKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgZXJyb3I6ICd1c2VySWQgaXMgcmVxdWlyZWQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcHJvZmlsZSA9IGF3YWl0IHRoaXMuYmVoYXZpb3JTZXJ2aWNlLmdldFVzZXJQcm9maWxlKHVzZXJJZFN0cik7XG5cbiAgICAgIGlmICghcHJvZmlsZSkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oe1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIGVycm9yOiAnVXNlciBiZWhhdmlvciBwcm9maWxlIG5vdCBmb3VuZCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICByZXMuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIGRhdGE6IHByb2ZpbGUsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdFcnJvciBnZXR0aW5nIHVzZXIgcHJvZmlsZTonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjogJ0ZhaWxlZCB0byBnZXQgdXNlciBiZWhhdmlvciBwcm9maWxlJyxcbiAgICAgIH0pO1xuICAgIH1cbiAgfTtcblxuICAvKipcbiAgICogR2V0IHVzZXIgYW5vbWFsaWVzXG4gICAqL1xuICBwdWJsaWMgZ2V0VXNlckFub21hbGllcyA9IGFzeW5jIChyZXE6IEJlaGF2aW9yUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IHVzZXJJZCB9ID0gcmVxLnBhcmFtcztcbiAgICAgIGNvbnN0IGxpbWl0UGFyYW0gPSByZXEucXVlcnkubGltaXQ7XG4gICAgICBjb25zdCBsaW1pdFN0ciA9IEFycmF5LmlzQXJyYXkobGltaXRQYXJhbSkgPyBsaW1pdFBhcmFtWzBdIDogbGltaXRQYXJhbTtcbiAgICAgIGNvbnN0IGxpbWl0ID0gbGltaXRTdHIgPyBwYXJzZUludChsaW1pdFN0ciBhcyBzdHJpbmcpIDogNTA7XG4gICAgICBjb25zdCB1c2VySWRTdHIgPSBBcnJheS5pc0FycmF5KHVzZXJJZCkgPyB1c2VySWRbMF0gOiB1c2VySWQ7XG5cbiAgICAgIGlmICghdXNlcklkU3RyKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgZXJyb3I6ICd1c2VySWQgaXMgcmVxdWlyZWQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgYW5vbWFsaWVzID0gYXdhaXQgdGhpcy5iZWhhdmlvclNlcnZpY2UuZ2V0VXNlckFub21hbGllcyh1c2VySWRTdHIsIGxpbWl0KTtcblxuICAgICAgcmVzLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBkYXRhOiBhbm9tYWxpZXMsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdFcnJvciBnZXR0aW5nIHVzZXIgYW5vbWFsaWVzOicsIGVycm9yKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOiAnRmFpbGVkIHRvIGdldCB1c2VyIGFub21hbGllcycsXG4gICAgICB9KTtcbiAgICB9XG4gIH07XG5cbiAgLyoqXG4gICAqIEdldCByZWNlbnQgYW5vbWFsaWVzXG4gICAqL1xuICBwdWJsaWMgZ2V0UmVjZW50QW5vbWFsaWVzID0gYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBsaW1pdFBhcmFtID0gcmVxLnF1ZXJ5LmxpbWl0O1xuICAgICAgY29uc3QgbGltaXRTdHIgPSBBcnJheS5pc0FycmF5KGxpbWl0UGFyYW0pID8gbGltaXRQYXJhbVswXSA6IGxpbWl0UGFyYW07XG4gICAgICBjb25zdCBsaW1pdCA9IGxpbWl0U3RyID8gcGFyc2VJbnQobGltaXRTdHIgYXMgc3RyaW5nKSA6IDEwMDtcbiAgICAgIGNvbnN0IGFub21hbGllcyA9IGF3YWl0IHRoaXMuYmVoYXZpb3JTZXJ2aWNlLmdldFJlY2VudEFub21hbGllcyhsaW1pdCk7XG5cbiAgICAgIHJlcy5qc29uKHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGF0YTogYW5vbWFsaWVzLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignRXJyb3IgZ2V0dGluZyByZWNlbnQgYW5vbWFsaWVzOicsIGVycm9yKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOiAnRmFpbGVkIHRvIGdldCByZWNlbnQgYW5vbWFsaWVzJyxcbiAgICAgIH0pO1xuICAgIH1cbiAgfTtcblxuICAvKipcbiAgICogUmVzb2x2ZSBhbm9tYWx5XG4gICAqL1xuICBwdWJsaWMgcmVzb2x2ZUFub21hbHkgPSBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgYW5vbWFseUlkIH0gPSByZXEucGFyYW1zO1xuICAgICAgY29uc3QgYW5vbWFseUlkU3RyID0gQXJyYXkuaXNBcnJheShhbm9tYWx5SWQpID8gYW5vbWFseUlkWzBdIDogYW5vbWFseUlkO1xuXG4gICAgICBpZiAoIWFub21hbHlJZFN0cikge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIGVycm9yOiAnYW5vbWFseUlkIGlzIHJlcXVpcmVkJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHN1Y2Nlc3MgPSBhd2FpdCB0aGlzLmJlaGF2aW9yU2VydmljZS5yZXNvbHZlQW5vbWFseShhbm9tYWx5SWRTdHIpO1xuXG4gICAgICByZXMuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIGRhdGE6IHsgcmVzb2x2ZWQ6IHN1Y2Nlc3MgfSxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIHJlc29sdmluZyBhbm9tYWx5OicsIGVycm9yKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOiAnRmFpbGVkIHRvIHJlc29sdmUgYW5vbWFseScsXG4gICAgICB9KTtcbiAgICB9XG4gIH07XG59XG5cbi8vIEV4cG9ydCBzaW5nbGV0b24gaW5zdGFuY2VcbmV4cG9ydCBjb25zdCB1c2VyQmVoYXZpb3JNaWRkbGV3YXJlID0gbmV3IFVzZXJCZWhhdmlvck1pZGRsZXdhcmUoKTtcblxuLy8gRXhwb3J0IGNvbnZlbmllbmNlIG1ldGhvZHNcbmV4cG9ydCBjb25zdCB0cmFja0JlaGF2aW9yID0gdXNlckJlaGF2aW9yTWlkZGxld2FyZS50cmFja0JlaGF2aW9yO1xuZXhwb3J0IGNvbnN0IGNoZWNrUmlza1Njb3JlID0gdXNlckJlaGF2aW9yTWlkZGxld2FyZS5jaGVja1Jpc2tTY29yZTtcbmV4cG9ydCBjb25zdCBtb25pdG9yU3VzcGljaW91c1BhdHRlcm5zID0gdXNlckJlaGF2aW9yTWlkZGxld2FyZS5tb25pdG9yU3VzcGljaW91c1BhdHRlcm5zO1xuIl0sInZlcnNpb24iOjN9