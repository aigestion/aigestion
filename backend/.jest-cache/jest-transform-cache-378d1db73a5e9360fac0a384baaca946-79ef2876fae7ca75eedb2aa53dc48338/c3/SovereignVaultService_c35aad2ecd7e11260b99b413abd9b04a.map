{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\SovereignVaultService.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\SovereignVaultService.ts"],"sourcesContent":["import { injectable, inject } from 'inversify';\nimport axios from 'axios';\nimport { TYPES } from '../types';\nimport { env } from '../config/env.schema';\nimport { logger } from '../utils/logger';\nimport { pineconeService } from './pinecone.service';\nimport { supabaseService } from './supabase.service';\nimport { vertexAIService } from './google/vertex-ai.service';\n\nexport interface VaultResult {\n  content: string;\n  source: 'local' | 'cloud' | 'sovereign';\n  score: number;\n  metadata: Record<string, any>;\n}\n\n@injectable()\nexport class SovereignVaultService {\n  private readonly chromaUrl: string;\n\n  constructor() {\n    this.chromaUrl = process.env.CHROMA_URL || 'http://localhost:8000';\n  }\n\n  /**\n   * ðŸŒŒ Unified Semantic Recall\n   * Queries Local (Chroma), Cloud (Pinecone), and Sovereign (Supabase) in parallel.\n   */\n  async query(text: string, limit: number = 3): Promise<VaultResult[]> {\n    logger.info({ query: text }, '[SovereignVault] Unified recall triggered');\n\n    try {\n      // Generate embeddings ONCE for all queries\n      const embedding = await vertexAIService.generateEmbeddings(text);\n\n      const [local, cloud, sovereign] = await Promise.all([\n        this.queryLocal(text, embedding, limit),\n        this.queryCloud(text, embedding, limit),\n        this.querySovereign(text, embedding, limit),\n      ]);\n\n      const allResults = [...local, ...cloud, ...sovereign];\n\n      // Multi-source Reranking by Score\n      return allResults.sort((a, b) => b.score - a.score).slice(0, limit * 2);\n    } catch (error: any) {\n      logger.error({ error: error.message }, '[SovereignVault] Query failed');\n      return [];\n    }\n  }\n\n  private async queryLocal(\n    text: string,\n    embedding: number[],\n    limit: number,\n  ): Promise<VaultResult[]> {\n    try {\n      // Direct call to ChromaDB Port 8000\n      const response = await axios.get(`${this.chromaUrl}/api/v1/heartbeat`);\n      if (response.status === 200) {\n        // Placeholder: ChromaDB implementation would use the embedding vector here\n        // For now, we return empty but log the health status\n        return [];\n      }\n      return [];\n    } catch (err) {\n      logger.warn('[SovereignVault] Local ChromaDB unreachable');\n      return [];\n    }\n  }\n\n  private async queryCloud(\n    text: string,\n    embedding: number[],\n    limit: number,\n  ): Promise<VaultResult[]> {\n    try {\n      // Pinecone search using pre-generated embeddings could be optimized,\n      // but current pineconeService.search re-ranks/generates.\n      // We use the text for now as search accepts string, but ideally would accept vector.\n      const results = await pineconeService.search(text, limit);\n      return results.map(res => ({\n        content: res.metadata?.text || '',\n        source: 'cloud',\n        score: res.score || 0,\n        metadata: res.metadata || {},\n      }));\n    } catch (err) {\n      logger.warn('[SovereignVault] Cloud retrieval failed');\n      return [];\n    }\n  }\n\n  private async querySovereign(\n    text: string,\n    embedding: number[],\n    limit: number,\n  ): Promise<VaultResult[]> {\n    try {\n      // Supabase Hybrid Search using real embeddings\n      const results = await supabaseService.hybridSearch(undefined, text, embedding, 0.3, limit);\n\n      return results.map((res: any) => ({\n        content: res.content || '',\n        source: 'sovereign',\n        score: res.rank || 0.5,\n        metadata: { title: res.title, ...res.metadata },\n      }));\n    } catch (err) {\n      logger.warn('[SovereignVault] Sovereign retrieval failed');\n      return [];\n    }\n  }\n\n  /**\n   * ðŸ“¥ Multi-Vault Ingestion\n   */\n  async ingest(filename: string, content: string, tags: string[] = []): Promise<void> {\n    logger.info({ filename }, '[SovereignVault] Synchronized ingestion started');\n\n    await Promise.all([\n      pineconeService.upsertDocument(filename, content, { filename, tags }),\n      supabaseService.upsertDocument({\n        title: filename,\n        content,\n        metadata: { tags },\n      }),\n      // Local Chroma ingestion would go here\n    ]);\n  }\n}\n"],"version":3}