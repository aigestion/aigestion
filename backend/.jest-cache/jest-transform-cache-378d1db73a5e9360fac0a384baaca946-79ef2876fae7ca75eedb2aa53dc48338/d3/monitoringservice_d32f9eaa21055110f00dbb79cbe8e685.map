{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\monitoring.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\monitoring.service.ts"],"sourcesContent":["import { injectable } from 'inversify';\nimport type { RedisClientType } from 'redis';\nimport { getRedisClient } from '../cache/redis';\nimport { config } from '../config/config';\nimport { logger } from '../utils/logger';\n\ninterface Metric {\n  name: string;\n  value: number;\n  timestamp: Date;\n  tags: { [key: string]: string };\n  unit: string;\n  type: 'counter' | 'gauge' | 'histogram' | 'timer';\n}\n\ninterface PerformanceMetrics {\n  responseTime: {\n    avg: number;\n    min: number;\n    max: number;\n    p50: number;\n    p95: number;\n    p99: number;\n  };\n  throughput: {\n    requestsPerSecond: number;\n    requestsPerMinute: number;\n    requestsPerHour: number;\n  };\n  errorRate: {\n    total: number;\n    percentage: number;\n    byStatus: { [key: string]: number };\n  };\n  resourceUsage: {\n    cpu: number;\n    memory: number;\n    disk: number;\n    network: {\n      inbound: number;\n      outbound: number;\n    };\n  };\n  database: {\n    connections: number;\n    queryTime: {\n      avg: number;\n      slow: number;\n    };\n    cacheHitRate: number;\n  };\n}\n\ninterface Alert {\n  id: string;\n  name: string;\n  severity: 'info' | 'warning' | 'critical';\n  message: string;\n  timestamp: Date;\n  resolved: boolean;\n  resolvedAt?: Date;\n  metadata: {\n    [key: string]: any;\n  };\n}\n\n@injectable()\nexport class MonitoringService {\n  private readonly redis: RedisClientType;\n  private readonly metrics: Map<string, Metric[]> = new Map();\n  private readonly alerts: Alert[] = [];\n  private readonly maxMetricsPerKey = 1000;\n  private readonly maxAlerts = 10000;\n  private readonly metricsRetention = 24 * 60 * 60 * 1000; // 24 hours\n  private readonly alertRetention = 7 * 24 * 60 * 60 * 1000; // 7 days\n\n  constructor() {\n    this.redis = getRedisClient();\n\n    this.startMetricsCollection();\n    this.startMetricsCleanup();\n  }\n\n  /**\n   * Record a metric\n   */\n  public async recordMetric(\n    name: string,\n    value: number,\n    tags: { [key: string]: string } = {},\n    unit = '',\n    type: Metric['type'] = 'gauge',\n  ): Promise<void> {\n    try {\n      const metric: Metric = {\n        name,\n        value,\n        timestamp: new Date(),\n        tags,\n        unit,\n        type,\n      };\n\n      // Store in memory\n      if (!this.metrics.has(name)) {\n        this.metrics.set(name, []);\n      }\n\n      const metricList = this.metrics.get(name)!;\n      metricList.push(metric);\n\n      // Keep only recent metrics\n      if (metricList.length > this.maxMetricsPerKey) {\n        metricList.splice(0, metricList.length - this.maxMetricsPerKey);\n      }\n\n      // Check Redis connection before using it\n      if (this.redis && this.redis.isOpen) {\n        try {\n          // Store in Redis\n          const redisKey = `metric:${name}:${Date.now()}`;\n          await this.redis.setEx(redisKey, this.metricsRetention / 1000, JSON.stringify(metric));\n\n          // Add to time series\n          await this.redis.lPush(`metrics:${name}:timeseries`, JSON.stringify(metric));\n          await this.redis.lTrim(`metrics:${name}:timeseries`, 0, this.maxMetricsPerKey - 1);\n        } catch (redisError) {\n          logger.warn('Redis operation failed, continuing without Redis:', redisError);\n        }\n      }\n\n      // Check for alerts\n      this.checkMetricAlerts(metric);\n    } catch (error) {\n      logger.error('Failed to record metric:', error);\n    }\n  }\n\n  /**\n   * Record response time\n   */\n  public recordResponseTime(\n    duration: number,\n    endpoint: string,\n    method: string,\n    statusCode: number,\n  ): void {\n    this.recordMetric(\n      'response_time',\n      duration,\n      {\n        endpoint,\n        method,\n        status_code: statusCode.toString(),\n      },\n      'ms',\n      'timer',\n    );\n\n    // Record request count\n    this.recordMetric(\n      'requests',\n      1,\n      {\n        endpoint,\n        method,\n        status_code: statusCode.toString(),\n      },\n      '',\n      'counter',\n    );\n\n    // Record error if applicable\n    if (statusCode >= 400) {\n      this.recordMetric(\n        'errors',\n        1,\n        {\n          endpoint,\n          method,\n          status_code: statusCode.toString(),\n        },\n        '',\n        'counter',\n      );\n    }\n  }\n\n  /**\n   * Record database performance\n   */\n  public recordDatabasePerformance(queryTime: number, queryType: string, success: boolean): void {\n    this.recordMetric(\n      'db_query_time',\n      queryTime,\n      {\n        query_type: queryType,\n        success: success.toString(),\n      },\n      'ms',\n      'timer',\n    );\n\n    if (!success) {\n      this.recordMetric(\n        'db_errors',\n        1,\n        {\n          query_type: queryType,\n        },\n        '',\n        'counter',\n      );\n    }\n  }\n\n  /**\n   * Record resource usage\n   */\n  public recordResourceUsage(): void {\n    const memory = process.memoryUsage();\n    // Record actual percentages instead of raw bytes for thresholds\n    const heapPercentage = (memory.heapUsed / memory.heapTotal) * 100;\n\n    this.recordMetric(\n      'memory_usage',\n      heapPercentage,\n      {\n        type: 'heap',\n      },\n      '%',\n      'gauge',\n    );\n\n    this.recordMetric(\n      'memory_bytes',\n      memory.heapUsed,\n      {\n        type: 'heap_used',\n      },\n      'bytes',\n      'gauge',\n    );\n\n    // Node.js process.cpuUsage() returns microseconds.\n    // To get a percentage, we'd need to compare over time.\n    // For now, we normalize the check or use a simplified mock for the threshold check.\n    const cpu = process.cpuUsage();\n    const totalCpuTime = cpu.user + cpu.system;\n    // Simplified: we will treat this as a raw metric but the check will be aware of units.\n    this.recordMetric(\n      'cpu_usage',\n      totalCpuTime / 1000000, // Seconds\n      {\n        type: 'total_seconds',\n      },\n      's',\n      'gauge',\n    );\n  }\n\n  /**\n   * Get performance metrics\n   */\n  public async getPerformanceMetrics(\n    timeRange: 'minute' | 'hour' | 'day' = 'hour',\n  ): Promise<PerformanceMetrics> {\n    try {\n      const now = Date.now();\n      let startTime: number;\n\n      switch (timeRange) {\n        case 'minute':\n          startTime = now - 60 * 1000;\n          break;\n        case 'hour':\n          startTime = now - 60 * 60 * 1000;\n          break;\n        case 'day':\n          startTime = now - 24 * 60 * 60 * 1000;\n          break;\n      }\n\n      // Get response time metrics\n      const responseTimeMetrics = await this.getMetricsInRange('response_time', startTime, now);\n      const responseTimes = responseTimeMetrics.map(m => m.value);\n\n      // Get request metrics\n      const requestMetrics = await this.getMetricsInRange('requests', startTime, now);\n      const errorMetrics = await this.getMetricsInRange('errors', startTime, now);\n\n      // Calculate statistics\n      const responseTimeStats = this.calculatePercentiles(responseTimes);\n      const totalRequests = requestMetrics.reduce((sum, m) => sum + m.value, 0);\n      const totalErrors = errorMetrics.reduce((sum, m) => sum + m.value, 0);\n\n      const metrics: PerformanceMetrics = {\n        responseTime: responseTimeStats,\n        throughput: {\n          requestsPerSecond:\n            totalRequests / (timeRange === 'minute' ? 60 : timeRange === 'hour' ? 3600 : 86400),\n          requestsPerMinute:\n            totalRequests / (timeRange === 'minute' ? 1 : timeRange === 'hour' ? 60 : 1440),\n          requestsPerHour:\n            totalRequests / (timeRange === 'minute' ? 1 / 60 : timeRange === 'hour' ? 1 : 24),\n        },\n        errorRate: {\n          total: totalErrors,\n          percentage: totalRequests > 0 ? (totalErrors / totalRequests) * 100 : 0,\n          byStatus: this.groupErrorsByStatus(errorMetrics),\n        },\n        resourceUsage: await this.getResourceUsage(),\n        database: await this.getDatabaseMetrics(),\n      };\n\n      return metrics;\n    } catch (error) {\n      logger.error('Failed to get performance metrics:', error);\n      return this.getDefaultPerformanceMetrics();\n    }\n  }\n\n  /**\n   * Get metrics in time range\n   */\n  private async getMetricsInRange(\n    name: string,\n    startTime: number,\n    endTime: number,\n  ): Promise<Metric[]> {\n    try {\n      // Check Redis connection before using it\n      if (!this.redis || !this.redis.isOpen) {\n        // Fallback to memory metrics if Redis is not available\n        const memoryMetrics = this.metrics.get(name) || [];\n        return memoryMetrics.filter(metric => {\n          const metricTime = new Date(metric.timestamp).getTime();\n          return metricTime >= startTime && metricTime <= endTime;\n        });\n      }\n\n      const key = `metrics:${name}:timeseries`;\n      const metricData = await this.redis.lRange(key, 0, -1);\n\n      return metricData\n        .map(data => JSON.parse(data))\n        .filter(metric => {\n          const metricTime = new Date(metric.timestamp).getTime();\n          return metricTime >= startTime && metricTime <= endTime;\n        });\n    } catch (error) {\n      logger.error('Failed to get metrics in range:', error);\n      // Fallback to memory metrics\n      const memoryMetrics = this.metrics.get(name) || [];\n      return memoryMetrics.filter(metric => {\n        const metricTime = new Date(metric.timestamp).getTime();\n        return metricTime >= startTime && metricTime <= endTime;\n      });\n    }\n  }\n\n  /**\n   * Calculate percentiles\n   */\n  private calculatePercentiles(values: number[]): {\n    avg: number;\n    min: number;\n    max: number;\n    p50: number;\n    p95: number;\n    p99: number;\n  } {\n    if (values.length === 0) {\n      return { avg: 0, min: 0, max: 0, p50: 0, p95: 0, p99: 0 };\n    }\n\n    const sorted = values.sort((a, b) => a - b);\n    const sum = values.reduce((acc, val) => acc + val, 0);\n\n    return {\n      avg: sum / values.length,\n      min: sorted[0],\n      max: sorted[sorted.length - 1],\n      p50: sorted[Math.floor(sorted.length * 0.5)],\n      p95: sorted[Math.floor(sorted.length * 0.95)],\n      p99: sorted[Math.floor(sorted.length * 0.99)],\n    };\n  }\n\n  /**\n   * Group errors by status\n   */\n  private groupErrorsByStatus(errorMetrics: Metric[]): { [key: string]: number } {\n    const statusCounts: { [key: string]: number } = {};\n\n    errorMetrics.forEach(metric => {\n      const status = metric.tags.status_code || 'unknown';\n      statusCounts[status] = (statusCounts[status] || 0) + metric.value;\n    });\n\n    return statusCounts;\n  }\n\n  /**\n   * Get resource usage\n   */\n  private async getResourceUsage(): Promise<{\n    cpu: number;\n    memory: number;\n    disk: number;\n    network: {\n      inbound: number;\n      outbound: number;\n    };\n  }> {\n    const usage = process.memoryUsage();\n    const cpuUsage = process.cpuUsage();\n\n    return {\n      cpu: cpuUsage.user,\n      memory: (usage.heapUsed / usage.heapTotal) * 100,\n      disk: 0, // Would need to implement disk usage monitoring\n      network: {\n        inbound: 0, // Would need to implement network monitoring\n        outbound: 0,\n      },\n    };\n  }\n\n  /**\n   * Get database metrics\n   */\n  private async getDatabaseMetrics(): Promise<{\n    connections: number;\n    queryTime: {\n      avg: number;\n      slow: number;\n    };\n    cacheHitRate: number;\n  }> {\n    try {\n      const queryTimeMetrics = await this.getMetricsInRange(\n        'db_query_time',\n        Date.now() - 60000,\n        Date.now(),\n      );\n      const queryTimes = queryTimeMetrics.map(m => m.value);\n      const slowQueries = queryTimeMetrics.filter(m => m.value > 1000).length;\n\n      return {\n        connections: 0, // Would need to implement connection monitoring\n        queryTime: {\n          avg:\n            queryTimes.length > 0\n              ? queryTimes.reduce((sum, t) => sum + t, 0) / queryTimes.length\n              : 0,\n          slow: slowQueries,\n        },\n        cacheHitRate: 0, // Would need to implement cache monitoring\n      };\n    } catch (error) {\n      return {\n        connections: 0,\n        queryTime: { avg: 0, slow: 0 },\n        cacheHitRate: 0,\n      };\n    }\n  }\n\n  /**\n   * Get default performance metrics\n   */\n  private getDefaultPerformanceMetrics(): PerformanceMetrics {\n    return {\n      responseTime: { avg: 0, min: 0, max: 0, p50: 0, p95: 0, p99: 0 },\n      throughput: { requestsPerSecond: 0, requestsPerMinute: 0, requestsPerHour: 0 },\n      errorRate: { total: 0, percentage: 0, byStatus: {} },\n      resourceUsage: { cpu: 0, memory: 0, disk: 0, network: { inbound: 0, outbound: 0 } },\n      database: { connections: 0, queryTime: { avg: 0, slow: 0 }, cacheHitRate: 0 },\n    };\n  }\n\n  /**\n   * Check metric alerts\n   */\n  private checkMetricAlerts(metric: Metric): void {\n    const alertRules = {\n      response_time: {\n        warning: 1000,\n        critical: 5000,\n      },\n      error_rate: {\n        warning: 5,\n        critical: 20,\n      },\n      memory_usage: {\n        warning: config.monitoring.memoryThreshold * 0.8,\n        critical: config.monitoring.memoryThreshold,\n      },\n      cpu_usage: {\n        warning: config.monitoring.cpuThreshold * 0.8,\n        critical: config.monitoring.cpuThreshold,\n      },\n    };\n\n    const rule = alertRules[metric.name as keyof typeof alertRules];\n    if (rule) {\n      // For CPU and Memory we now expect % or normalized values\n      const isResourceMetric = ['memory_usage', 'cpu_usage'].includes(metric.name);\n\n      if (metric.value >= rule.critical) {\n        this.createAlert({\n          name: `${metric.name} critical`,\n          severity: 'critical',\n          message: `${metric.name} is ${metric.value.toFixed(2)}${\n            metric.unit\n          } (critical threshold: ${rule.critical}${metric.unit})`,\n          metadata: {\n            metric: metric.name,\n            value: metric.value,\n            threshold: rule.critical,\n            tags: metric.tags,\n          },\n        });\n      } else if (metric.value >= rule.warning) {\n        this.createAlert({\n          name: `${metric.name} warning`,\n          severity: 'warning',\n          message: `${metric.name} is ${metric.value.toFixed(2)}${\n            metric.unit\n          } (warning threshold: ${rule.warning}${metric.unit})`,\n          metadata: {\n            metric: metric.name,\n            value: metric.value,\n            threshold: rule.warning,\n            tags: metric.tags,\n          },\n        });\n      }\n    }\n  }\n\n  /**\n   * Create alert\n   */\n  private createAlert(\n    alertData: Omit<Alert, 'id' | 'timestamp' | 'resolved' | 'resolvedAt'>,\n  ): void {\n    try {\n      const alert: Alert = {\n        ...alertData,\n        id: this.generateAlertId(),\n        timestamp: new Date(),\n        resolved: false,\n      };\n\n      this.alerts.push(alert);\n\n      // Keep only recent alerts\n      if (this.alerts.length > this.maxAlerts) {\n        this.alerts.splice(0, this.alerts.length - this.maxAlerts);\n      }\n\n      // Check Redis connection before using it\n      if (this.redis && this.redis.isOpen) {\n        try {\n          // Store in Redis\n          this.redis.setEx(`alert:${alert.id}`, this.alertRetention / 1000, JSON.stringify(alert));\n\n          // Add to recent alerts\n          this.redis.lPush('alerts:recent', JSON.stringify(alert));\n          this.redis.lTrim('alerts:recent', 0, 999);\n        } catch (redisError) {\n          logger.warn('Redis operation failed for alert, continuing without Redis:', redisError);\n        }\n      }\n\n      logger.warn('Alert created', {\n        id: alert.id,\n        name: alert.name,\n        severity: alert.severity,\n        message: alert.message,\n      });\n    } catch (error) {\n      logger.error('Failed to create alert:', error);\n    }\n  }\n\n  /**\n   * Get recent alerts\n   */\n  public async getRecentAlerts(limit: number = 100): Promise<Alert[]> {\n    try {\n      const alertData = await this.redis.lRange('alerts:recent', 0, limit - 1);\n      return alertData.map(data => JSON.parse(data));\n    } catch (error) {\n      logger.error('Failed to get recent alerts:', error);\n      return [];\n    }\n  }\n\n  /**\n   * Resolve alert\n   */\n  public async resolveAlert(alertId: string): Promise<boolean> {\n    try {\n      // Update in memory\n      const alert = this.alerts.find(a => a.id === alertId);\n      if (alert) {\n        alert.resolved = true;\n        alert.resolvedAt = new Date();\n      }\n\n      // Update in Redis\n      const cached = await this.redis.get(`alert:${alertId}`);\n      if (cached) {\n        const updatedAlert = JSON.parse(cached);\n        updatedAlert.resolved = true;\n        updatedAlert.resolvedAt = new Date();\n        await this.redis.setEx(\n          `alert:${alertId}`,\n          this.alertRetention / 1000,\n          JSON.stringify(updatedAlert),\n        );\n      }\n\n      logger.info('Alert resolved', { alertId });\n      return true;\n    } catch (error) {\n      logger.error('Failed to resolve alert:', { alertId, error });\n      return false;\n    }\n  }\n\n  /**\n   * Get metrics overview\n   */\n  public async getMetricsOverview(): Promise<{\n    totalMetrics: number;\n    activeAlerts: number;\n    systemHealth: 'healthy' | 'warning' | 'critical';\n    topMetrics: Array<{\n      name: string;\n      currentValue: number;\n      trend: 'up' | 'down' | 'stable';\n    }>;\n  }> {\n    try {\n      const totalMetrics = Array.from(this.metrics.values()).reduce(\n        (sum, metrics) => sum + metrics.length,\n        0,\n      );\n      const activeAlerts = this.alerts.filter(a => !a.resolved).length;\n\n      // Determine system health\n      let systemHealth: 'healthy' | 'warning' | 'critical' = 'healthy';\n      if (activeAlerts > 10) {\n        systemHealth = 'critical';\n      } else if (activeAlerts > 3) {\n        systemHealth = 'warning';\n      }\n\n      // Get top metrics\n      const topMetrics: Array<{\n        name: string;\n        currentValue: number;\n        trend: 'up' | 'down' | 'stable';\n      }> = [];\n\n      for (const [name, metrics] of this.metrics.entries()) {\n        if (metrics.length > 0) {\n          const latest = metrics[metrics.length - 1];\n          const previous = metrics[Math.max(0, metrics.length - 10)];\n\n          let trend: 'up' | 'down' | 'stable' = 'stable';\n          if (latest.value > previous.value * 1.1) {\n            trend = 'up';\n          } else if (latest.value < previous.value * 0.9) {\n            trend = 'down';\n          }\n\n          topMetrics.push({\n            name,\n            currentValue: latest.value,\n            trend,\n          });\n        }\n      }\n\n      // Sort by value and take top 10\n      topMetrics.sort((a, b) => b.currentValue - a.currentValue);\n      topMetrics.splice(10);\n\n      return {\n        totalMetrics,\n        activeAlerts,\n        systemHealth,\n        topMetrics,\n      };\n    } catch (error) {\n      logger.error('Failed to get metrics overview:', error);\n      return {\n        totalMetrics: 0,\n        activeAlerts: 0,\n        systemHealth: 'healthy',\n        topMetrics: [],\n      };\n    }\n  }\n\n  /**\n   * Generate alert ID\n   */\n  private generateAlertId(): string {\n    return `alert_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n  }\n\n  /**\n   * Start metrics collection\n   */\n  private startMetricsCollection(): void {\n    // Collect resource usage every 30 seconds\n    setInterval(() => {\n      this.recordResourceUsage();\n    }, 30000);\n  }\n\n  /**\n   * Start metrics cleanup\n   */\n  private startMetricsCleanup(): void {\n    // Clean old metrics every hour\n    setInterval(\n      () => {\n        this.cleanupOldMetrics();\n      },\n      60 * 60 * 1000,\n    );\n  }\n\n  /**\n   * Clean old metrics\n   */\n  private cleanupOldMetrics(): void {\n    try {\n      const cutoff = Date.now() - this.metricsRetention;\n\n      for (const [name, metrics] of this.metrics.entries()) {\n        const filtered = metrics.filter(metric => new Date(metric.timestamp).getTime() > cutoff);\n        this.metrics.set(name, filtered);\n      }\n\n      logger.debug('Old metrics cleaned up');\n    } catch (error) {\n      logger.error('Failed to cleanup old metrics:', error);\n    }\n  }\n}\n"],"version":3}