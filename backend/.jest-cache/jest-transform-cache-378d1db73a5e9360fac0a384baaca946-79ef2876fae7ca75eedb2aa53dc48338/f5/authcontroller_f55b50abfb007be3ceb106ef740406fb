b0136f6107299cf910e7771fe00cdbc7
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.updateSubscription = exports.updateUserRole = exports.verifyEmail = exports.verifyLogin2FA = exports.verify2FA = exports.enable2FA = exports.getMe = exports.logout = exports.refresh = exports.login = exports.register = void 0;
const response_builder_1 = require("../common/response-builder");
const config_1 = require("../config");
const inversify_config_1 = require("../config/inversify.config");
const types_1 = require("../types");
const errors_1 = require("../utils/errors");
const validation_middleware_1 = require("../middleware/validation.middleware");
// Helper to set refresh token cookie
const setRefreshTokenCookie = (res, token) => {
    res.cookie('refresh_token', token, {
        httpOnly: true,
        secure: config_1.config.nodeEnv === 'production',
        sameSite: 'strict',
        maxAge: 7 * 24 * 60 * 60 * 1000, // 7 days
    });
};
const register = async (req, res, next) => {
    try {
        const authService = inversify_config_1.container.get(types_1.TYPES.AuthService);
        const { user, token, refreshToken } = await authService.register(req.body);
        // No devolver la contraseña en la respuesta
        const userResponse = user.toObject();
        delete userResponse.password;
        delete userResponse.refreshTokens; // Don't send DB array to client
        setRefreshTokenCookie(res, refreshToken);
        res.status(201).json((0, response_builder_1.buildResponse)({ user: userResponse, token }, 201, req.requestId));
    }
    catch (error) {
        next(error);
    }
};
exports.register = register;
const login = async (req, res, next) => {
    try {
        const authService = inversify_config_1.container.get(types_1.TYPES.AuthService);
        const { email, password } = req.body;
        const ip = req.ip;
        const userAgent = req.headers['user-agent'];
        const { user, token, refreshToken, mfaRequired } = await authService.login({
            email,
            password,
            ip,
            userAgent,
        });
        if (mfaRequired) {
            res.status(200).json((0, response_builder_1.buildResponse)({
                mfaRequired: true,
                userId: user._id,
            }, 200, req.requestId));
            return;
        }
        // Ensure we have tokens before setting cookie (typescript guard)
        if (refreshToken && token) {
            const userResponse = user.toObject();
            delete userResponse.password;
            delete userResponse.refreshTokens;
            setRefreshTokenCookie(res, refreshToken);
            res
                .status(200)
                .json((0, response_builder_1.buildResponse)({ user: userResponse, token }, 200, req.requestId));
        }
        else {
            throw new errors_1.AppError('Login failed to generate tokens', 500, 'INTERNAL_ERROR');
        }
    }
    catch (error) {
        next(error);
    }
};
exports.login = login;
const refresh = async (req, res, next) => {
    try {
        const refreshToken = req.cookies['refresh_token'];
        if (!refreshToken) {
            throw new errors_1.AppError('Refresh Token Required', 401, 'REFRESH_TOKEN_REQUIRED');
        }
        const authService = inversify_config_1.container.get(types_1.TYPES.AuthService);
        const ip = req.ip || 'unknown';
        const userAgent = req.headers['user-agent'] || 'unknown';
        const { user, accessToken, refreshToken: newRefreshToken, } = await authService.refreshToken(refreshToken, ip, userAgent);
        setRefreshTokenCookie(res, newRefreshToken);
        res.status(200).json((0, response_builder_1.buildResponse)({ accessToken }, 200, req.requestId));
    }
    catch (error) {
        // If refresh fails (security reuse, expired), clear cookie
        res.clearCookie('refresh_token');
        next(error);
    }
};
exports.refresh = refresh;
const logout = async (req, res, next) => {
    try {
        const refreshToken = req.cookies['refresh_token'];
        if (refreshToken) {
            // @ts-ignore
            const authService = inversify_config_1.container.get(types_1.TYPES.AuthService);
            await authService.logout(refreshToken);
        }
        res.clearCookie('refresh_token');
        res
            .status(200)
            .json((0, response_builder_1.buildResponse)({ message: 'Logged out successfully' }, 200, req.requestId));
    }
    catch (error) {
        next(error);
    }
};
exports.logout = logout;
const getMe = async (req, res, next) => {
    try {
        if (!req.user) {
            return next(new errors_1.AppError('Usuario no autenticado', 401, 'UNAUTHORIZED'));
        }
        const authService = inversify_config_1.container.get(types_1.TYPES.AuthService);
        const user = await authService.getUserProfile(req.user.id);
        if (!user) {
            return next(new errors_1.AppError('Usuario no encontrado', 404, 'NOT_FOUND'));
        }
        res.status(200).json((0, response_builder_1.buildResponse)(user, 200, req.requestId));
    }
    catch (error) {
        next(error);
    }
};
exports.getMe = getMe;
// Enable 2FA
exports.enable2FA = [
    (0, validation_middleware_1.validate)({ body: validation_middleware_1.schemas.auth.enable2FA }),
    async (req, res, next) => {
        try {
            const enable2FAUseCase = inversify_config_1.container.get(types_1.TYPES.Enable2FAUseCase);
            const { userId } = req.body;
            const result = await enable2FAUseCase.execute(userId);
            res.status(200).json((0, response_builder_1.buildResponse)(result, 200, req.requestId));
        }
        catch (error) {
            next(error);
        }
    },
];
// Verify 2FA token
exports.verify2FA = [
    (0, validation_middleware_1.validate)({ body: validation_middleware_1.schemas.auth.verify2FA }),
    async (req, res, next) => {
        try {
            const verify2FAUseCase = inversify_config_1.container.get(types_1.TYPES.Verify2FAUseCase);
            const { userId, token } = req.body;
            await verify2FAUseCase.execute(userId, token);
            res.status(200).json((0, response_builder_1.buildResponse)({ success: true }, 200, req.requestId));
        }
        catch (error) {
            next(error);
        }
    },
];
// Verify Login 2FA (Step 2 of Login)
const verifyLogin2FA = async (req, res, next) => {
    try {
        const authService = inversify_config_1.container.get(types_1.TYPES.AuthService);
        const { userId, token } = req.body;
        const ip = req.ip;
        const userAgent = req.headers['user-agent'];
        const { user, token: accessToken, refreshToken, } = await authService.verifyLogin2FA({
            userId,
            token,
            ip,
            userAgent,
        });
        const userResponse = user.toObject();
        delete userResponse.password;
        delete userResponse.refreshTokens;
        setRefreshTokenCookie(res, refreshToken);
        res
            .status(200)
            .json((0, response_builder_1.buildResponse)({ user: userResponse, token: accessToken }, 200, req.requestId));
    }
    catch (error) {
        next(error);
    }
};
exports.verifyLogin2FA = verifyLogin2FA;
// Verify Email Code
const verifyEmail = async (req, res, next) => {
    try {
        const authService = inversify_config_1.container.get(types_1.TYPES.AuthService);
        const { userId, code } = req.body;
        await authService.verifyEmail(userId, code);
        res.status(200).json((0, response_builder_1.buildResponse)({ success: true, message: 'Email verificado correctamente' }, 200, req.requestId));
    }
    catch (error) {
        next(error);
    }
};
exports.verifyEmail = verifyEmail;
// Update User Role
const updateUserRole = async (req, res, next) => {
    try {
        const authService = inversify_config_1.container.get(types_1.TYPES.AuthService);
        const { userId, role } = req.body;
        // Validate role is 'family' or 'professional' ??
        // Ideally validate via middleware schema, but here for safety:
        if (!['family', 'professional'].includes(role)) {
            throw new errors_1.AppError('Rol inválido. Debe ser "family" o "professional"', 400, 'INVALID_ROLE');
        }
        const user = await authService.updateUserRole(userId, role);
        res.status(200).json((0, response_builder_1.buildResponse)({ success: true, user }, 200, req.requestId));
    }
    catch (error) {
        next(error);
    }
};
exports.updateUserRole = updateUserRole;
// Update Subscription Plan
const updateSubscription = async (req, res, next) => {
    try {
        const authService = inversify_config_1.container.get(types_1.TYPES.AuthService);
        const { userId, plan } = req.body;
        const user = await authService.updateSubscription(userId, plan);
        res.status(200).json((0, response_builder_1.buildResponse)({ success: true, user }, 200, req.requestId));
    }
    catch (error) {
        next(error);
    }
};
exports.updateSubscription = updateSubscription;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxjb250cm9sbGVyc1xcYXV0aC5jb250cm9sbGVyLnRzIiwibWFwcGluZ3MiOiI7OztBQUlBLGlFQUEyRDtBQUMzRCxzQ0FBbUM7QUFDbkMsaUVBQXVEO0FBS3ZELG9DQUFpQztBQUNqQyw0Q0FBMkM7QUFDM0MsK0VBQXdFO0FBRXhFLHFDQUFxQztBQUNyQyxNQUFNLHFCQUFxQixHQUFHLENBQUMsR0FBYSxFQUFFLEtBQWEsRUFBRSxFQUFFO0lBQzdELEdBQUcsQ0FBQyxNQUFNLENBQUMsZUFBZSxFQUFFLEtBQUssRUFBRTtRQUNqQyxRQUFRLEVBQUUsSUFBSTtRQUNkLE1BQU0sRUFBRSxlQUFNLENBQUMsT0FBTyxLQUFLLFlBQVk7UUFDdkMsUUFBUSxFQUFFLFFBQVE7UUFDbEIsTUFBTSxFQUFFLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLEVBQUUsU0FBUztLQUMzQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUM7QUFFSyxNQUFNLFFBQVEsR0FBRyxLQUFLLEVBQUUsR0FBWSxFQUFFLEdBQWEsRUFBRSxJQUFrQixFQUFpQixFQUFFO0lBQy9GLElBQUksQ0FBQztRQUNILE1BQU0sV0FBVyxHQUFHLDRCQUFTLENBQUMsR0FBRyxDQUFjLGFBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNsRSxNQUFNLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxZQUFZLEVBQUUsR0FBRyxNQUFNLFdBQVcsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRTNFLDRDQUE0QztRQUM1QyxNQUFNLFlBQVksR0FBUSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDMUMsT0FBTyxZQUFZLENBQUMsUUFBUSxDQUFDO1FBQzdCLE9BQU8sWUFBWSxDQUFDLGFBQWEsQ0FBQyxDQUFDLGdDQUFnQztRQUVuRSxxQkFBcUIsQ0FBQyxHQUFHLEVBQUUsWUFBWSxDQUFDLENBQUM7UUFFekMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBQSxnQ0FBYSxFQUFDLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUUsRUFBRSxHQUFHLEVBQUcsR0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7SUFDbEcsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDZCxDQUFDO0FBQ0gsQ0FBQyxDQUFDO0FBaEJXLFFBQUEsUUFBUSxZQWdCbkI7QUFFSyxNQUFNLEtBQUssR0FBRyxLQUFLLEVBQUUsR0FBWSxFQUFFLEdBQWEsRUFBRSxJQUFrQixFQUFpQixFQUFFO0lBQzVGLElBQUksQ0FBQztRQUNILE1BQU0sV0FBVyxHQUFHLDRCQUFTLENBQUMsR0FBRyxDQUFjLGFBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNsRSxNQUFNLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7UUFDckMsTUFBTSxFQUFFLEdBQUcsR0FBRyxDQUFDLEVBQUUsQ0FBQztRQUNsQixNQUFNLFNBQVMsR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBRTVDLE1BQU0sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLFlBQVksRUFBRSxXQUFXLEVBQUUsR0FBRyxNQUFNLFdBQVcsQ0FBQyxLQUFLLENBQUM7WUFDekUsS0FBSztZQUNMLFFBQVE7WUFDUixFQUFFO1lBQ0YsU0FBUztTQUNWLENBQUMsQ0FBQztRQUVILElBQUksV0FBVyxFQUFFLENBQUM7WUFDaEIsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQ2xCLElBQUEsZ0NBQWEsRUFDWDtnQkFDRSxXQUFXLEVBQUUsSUFBSTtnQkFDakIsTUFBTSxFQUFFLElBQUksQ0FBQyxHQUFHO2FBQ2pCLEVBQ0QsR0FBRyxFQUNGLEdBQVcsQ0FBQyxTQUFTLENBQ3ZCLENBQ0YsQ0FBQztZQUNGLE9BQU87UUFDVCxDQUFDO1FBRUQsaUVBQWlFO1FBQ2pFLElBQUksWUFBWSxJQUFJLEtBQUssRUFBRSxDQUFDO1lBQzFCLE1BQU0sWUFBWSxHQUFRLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUMxQyxPQUFPLFlBQVksQ0FBQyxRQUFRLENBQUM7WUFDN0IsT0FBTyxZQUFZLENBQUMsYUFBYSxDQUFDO1lBRWxDLHFCQUFxQixDQUFDLEdBQUcsRUFBRSxZQUFZLENBQUMsQ0FBQztZQUV6QyxHQUFHO2lCQUNBLE1BQU0sQ0FBQyxHQUFHLENBQUM7aUJBQ1gsSUFBSSxDQUFDLElBQUEsZ0NBQWEsRUFBQyxFQUFFLElBQUksRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFFLEVBQUUsR0FBRyxFQUFHLEdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1FBQ3JGLENBQUM7YUFBTSxDQUFDO1lBQ04sTUFBTSxJQUFJLGlCQUFRLENBQUMsaUNBQWlDLEVBQUUsR0FBRyxFQUFFLGdCQUFnQixDQUFDLENBQUM7UUFDL0UsQ0FBQztJQUNILENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2YsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ2QsQ0FBQztBQUNILENBQUMsQ0FBQztBQTdDVyxRQUFBLEtBQUssU0E2Q2hCO0FBRUssTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFhLEVBQUUsSUFBa0IsRUFBaUIsRUFBRTtJQUM5RixJQUFJLENBQUM7UUFDSCxNQUFNLFlBQVksR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQ2xELElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUNsQixNQUFNLElBQUksaUJBQVEsQ0FBQyx3QkFBd0IsRUFBRSxHQUFHLEVBQUUsd0JBQXdCLENBQUMsQ0FBQztRQUM5RSxDQUFDO1FBRUQsTUFBTSxXQUFXLEdBQUcsNEJBQVMsQ0FBQyxHQUFHLENBQWMsYUFBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ2xFLE1BQU0sRUFBRSxHQUFHLEdBQUcsQ0FBQyxFQUFFLElBQUksU0FBUyxDQUFDO1FBQy9CLE1BQU0sU0FBUyxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLElBQUksU0FBUyxDQUFDO1FBRXpELE1BQU0sRUFDSixJQUFJLEVBQ0osV0FBVyxFQUNYLFlBQVksRUFBRSxlQUFlLEdBQzlCLEdBQUcsTUFBTSxXQUFXLENBQUMsWUFBWSxDQUFDLFlBQVksRUFBRSxFQUFFLEVBQUUsU0FBUyxDQUFDLENBQUM7UUFFaEUscUJBQXFCLENBQUMsR0FBRyxFQUFFLGVBQWUsQ0FBQyxDQUFDO1FBRTVDLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUEsZ0NBQWEsRUFBQyxFQUFFLFdBQVcsRUFBRSxFQUFFLEdBQUcsRUFBRyxHQUFXLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztJQUNwRixDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLDJEQUEyRDtRQUMzRCxHQUFHLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQ2pDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNkLENBQUM7QUFDSCxDQUFDLENBQUM7QUF6QlcsUUFBQSxPQUFPLFdBeUJsQjtBQUVLLE1BQU0sTUFBTSxHQUFHLEtBQUssRUFBRSxHQUFZLEVBQUUsR0FBYSxFQUFFLElBQWtCLEVBQWlCLEVBQUU7SUFDN0YsSUFBSSxDQUFDO1FBQ0gsTUFBTSxZQUFZLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUNsRCxJQUFJLFlBQVksRUFBRSxDQUFDO1lBQ2pCLGFBQWE7WUFDYixNQUFNLFdBQVcsR0FBRyw0QkFBUyxDQUFDLEdBQUcsQ0FBYyxhQUFLLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDbEUsTUFBTSxXQUFXLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ3pDLENBQUM7UUFFRCxHQUFHLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQ2pDLEdBQUc7YUFDQSxNQUFNLENBQUMsR0FBRyxDQUFDO2FBQ1gsSUFBSSxDQUFDLElBQUEsZ0NBQWEsRUFBQyxFQUFFLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxFQUFFLEdBQUcsRUFBRyxHQUFXLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztJQUM5RixDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNkLENBQUM7QUFDSCxDQUFDLENBQUM7QUFoQlcsUUFBQSxNQUFNLFVBZ0JqQjtBQUVLLE1BQU0sS0FBSyxHQUFHLEtBQUssRUFBRSxHQUFZLEVBQUUsR0FBYSxFQUFFLElBQWtCLEVBQWlCLEVBQUU7SUFDNUYsSUFBSSxDQUFDO1FBQ0gsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNkLE9BQU8sSUFBSSxDQUFDLElBQUksaUJBQVEsQ0FBQyx3QkFBd0IsRUFBRSxHQUFHLEVBQUUsY0FBYyxDQUFDLENBQUMsQ0FBQztRQUMzRSxDQUFDO1FBQ0QsTUFBTSxXQUFXLEdBQUcsNEJBQVMsQ0FBQyxHQUFHLENBQWMsYUFBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ2xFLE1BQU0sSUFBSSxHQUFHLE1BQU0sV0FBVyxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRTNELElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNWLE9BQU8sSUFBSSxDQUFDLElBQUksaUJBQVEsQ0FBQyx1QkFBdUIsRUFBRSxHQUFHLEVBQUUsV0FBVyxDQUFDLENBQUMsQ0FBQztRQUN2RSxDQUFDO1FBRUQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBQSxnQ0FBYSxFQUFDLElBQUksRUFBRSxHQUFHLEVBQUcsR0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7SUFDekUsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDZCxDQUFDO0FBQ0gsQ0FBQyxDQUFDO0FBaEJXLFFBQUEsS0FBSyxTQWdCaEI7QUFFRixhQUFhO0FBQ0EsUUFBQSxTQUFTLEdBQUc7SUFDdkIsSUFBQSxnQ0FBUSxFQUFDLEVBQUUsSUFBSSxFQUFFLCtCQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO0lBQzFDLEtBQUssRUFBRSxHQUFZLEVBQUUsR0FBYSxFQUFFLElBQWtCLEVBQWlCLEVBQUU7UUFDdkUsSUFBSSxDQUFDO1lBQ0gsTUFBTSxnQkFBZ0IsR0FBRyw0QkFBUyxDQUFDLEdBQUcsQ0FBbUIsYUFBSyxDQUFDLGdCQUFnQixDQUFDLENBQUM7WUFDakYsTUFBTSxFQUFFLE1BQU0sRUFBRSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7WUFDNUIsTUFBTSxNQUFNLEdBQUcsTUFBTSxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDdEQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBQSxnQ0FBYSxFQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUcsR0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFDM0UsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDZCxDQUFDO0lBQ0gsQ0FBQztDQUNGLENBQUM7QUFFRixtQkFBbUI7QUFDTixRQUFBLFNBQVMsR0FBRztJQUN2QixJQUFBLGdDQUFRLEVBQUMsRUFBRSxJQUFJLEVBQUUsK0JBQU8sQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7SUFDMUMsS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFhLEVBQUUsSUFBa0IsRUFBaUIsRUFBRTtRQUN2RSxJQUFJLENBQUM7WUFDSCxNQUFNLGdCQUFnQixHQUFHLDRCQUFTLENBQUMsR0FBRyxDQUFtQixhQUFLLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztZQUNqRixNQUFNLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7WUFDbkMsTUFBTSxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQzlDLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUEsZ0NBQWEsRUFBQyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsRUFBRSxHQUFHLEVBQUcsR0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFDdEYsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDZCxDQUFDO0lBQ0gsQ0FBQztDQUNGLENBQUM7QUFFRixxQ0FBcUM7QUFDOUIsTUFBTSxjQUFjLEdBQUcsS0FBSyxFQUNqQyxHQUFZLEVBQ1osR0FBYSxFQUNiLElBQWtCLEVBQ0gsRUFBRTtJQUNqQixJQUFJLENBQUM7UUFDSCxNQUFNLFdBQVcsR0FBRyw0QkFBUyxDQUFDLEdBQUcsQ0FBYyxhQUFLLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDbEUsTUFBTSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBQ25DLE1BQU0sRUFBRSxHQUFHLEdBQUcsQ0FBQyxFQUFFLENBQUM7UUFDbEIsTUFBTSxTQUFTLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUU1QyxNQUFNLEVBQ0osSUFBSSxFQUNKLEtBQUssRUFBRSxXQUFXLEVBQ2xCLFlBQVksR0FDYixHQUFHLE1BQU0sV0FBVyxDQUFDLGNBQWMsQ0FBQztZQUNuQyxNQUFNO1lBQ04sS0FBSztZQUNMLEVBQUU7WUFDRixTQUFTO1NBQ1YsQ0FBQyxDQUFDO1FBRUgsTUFBTSxZQUFZLEdBQVEsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQzFDLE9BQU8sWUFBWSxDQUFDLFFBQVEsQ0FBQztRQUM3QixPQUFPLFlBQVksQ0FBQyxhQUFhLENBQUM7UUFFbEMscUJBQXFCLENBQUMsR0FBRyxFQUFFLFlBQVksQ0FBQyxDQUFDO1FBRXpDLEdBQUc7YUFDQSxNQUFNLENBQUMsR0FBRyxDQUFDO2FBQ1gsSUFBSSxDQUFDLElBQUEsZ0NBQWEsRUFBQyxFQUFFLElBQUksRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFFLFdBQVcsRUFBRSxFQUFFLEdBQUcsRUFBRyxHQUFXLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztJQUNsRyxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNkLENBQUM7QUFDSCxDQUFDLENBQUM7QUFsQ1csUUFBQSxjQUFjLGtCQWtDekI7QUFFRixvQkFBb0I7QUFDYixNQUFNLFdBQVcsR0FBRyxLQUFLLEVBQUUsR0FBWSxFQUFFLEdBQWEsRUFBRSxJQUFrQixFQUFpQixFQUFFO0lBQ2xHLElBQUksQ0FBQztRQUNILE1BQU0sV0FBVyxHQUFHLDRCQUFTLENBQUMsR0FBRyxDQUFjLGFBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNsRSxNQUFNLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7UUFDbEMsTUFBTSxXQUFXLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQztRQUM1QyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFBLGdDQUFhLEVBQUMsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxnQ0FBZ0MsRUFBRSxFQUFFLEdBQUcsRUFBRyxHQUFXLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztJQUNqSSxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNkLENBQUM7QUFDSCxDQUFDLENBQUM7QUFUVyxRQUFBLFdBQVcsZUFTdEI7QUFFRixtQkFBbUI7QUFDWixNQUFNLGNBQWMsR0FBRyxLQUFLLEVBQUUsR0FBWSxFQUFFLEdBQWEsRUFBRSxJQUFrQixFQUFpQixFQUFFO0lBQ3JHLElBQUksQ0FBQztRQUNILE1BQU0sV0FBVyxHQUFHLDRCQUFTLENBQUMsR0FBRyxDQUFjLGFBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNsRSxNQUFNLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7UUFDbEMsaURBQWlEO1FBQ2pELCtEQUErRDtRQUMvRCxJQUFJLENBQUMsQ0FBQyxRQUFRLEVBQUUsY0FBYyxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7WUFDN0MsTUFBTSxJQUFJLGlCQUFRLENBQUMsa0RBQWtELEVBQUUsR0FBRyxFQUFFLGNBQWMsQ0FBQyxDQUFDO1FBQ2hHLENBQUM7UUFFRCxNQUFNLElBQUksR0FBRyxNQUFNLFdBQVcsQ0FBQyxjQUFjLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzVELEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUEsZ0NBQWEsRUFBQyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEVBQUUsR0FBRyxFQUFHLEdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO0lBQzVGLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2YsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ2QsQ0FBQztBQUNILENBQUMsQ0FBQztBQWZXLFFBQUEsY0FBYyxrQkFlekI7QUFFRiwyQkFBMkI7QUFDcEIsTUFBTSxrQkFBa0IsR0FBRyxLQUFLLEVBQUUsR0FBWSxFQUFFLEdBQWEsRUFBRSxJQUFrQixFQUFpQixFQUFFO0lBQ3pHLElBQUksQ0FBQztRQUNILE1BQU0sV0FBVyxHQUFHLDRCQUFTLENBQUMsR0FBRyxDQUFjLGFBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNsRSxNQUFNLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7UUFFbEMsTUFBTSxJQUFJLEdBQUcsTUFBTSxXQUFXLENBQUMsa0JBQWtCLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ2hFLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUEsZ0NBQWEsRUFBQyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEVBQUUsR0FBRyxFQUFHLEdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO0lBQzVGLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2YsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ2QsQ0FBQztBQUNILENBQUMsQ0FBQztBQVZXLFFBQUEsa0JBQWtCLHNCQVU3QiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXEFsZWphbmRyb1xcQUlHZXN0aW9uXFxiYWNrZW5kXFxzcmNcXGNvbnRyb2xsZXJzXFxhdXRoLmNvbnRyb2xsZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGJjcnlwdCBmcm9tICdiY3J5cHRqcyc7XG5pbXBvcnQgdHlwZSB7IE5leHRGdW5jdGlvbiwgUmVxdWVzdCwgUmVzcG9uc2UgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCBqd3QgZnJvbSAnanNvbndlYnRva2VuJztcblxuaW1wb3J0IHsgYnVpbGRSZXNwb25zZSB9IGZyb20gJy4uL2NvbW1vbi9yZXNwb25zZS1idWlsZGVyJztcbmltcG9ydCB7IGNvbmZpZyB9IGZyb20gJy4uL2NvbmZpZyc7XG5pbXBvcnQgeyBjb250YWluZXIgfSBmcm9tICcuLi9jb25maWcvaW52ZXJzaWZ5LmNvbmZpZyc7XG5pbXBvcnQgeyBVc2VyIH0gZnJvbSAnLi4vbW9kZWxzL1VzZXInO1xuaW1wb3J0IHsgQXV0aFNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9hdXRoLnNlcnZpY2UnO1xuaW1wb3J0IHsgRW5hYmxlMkZBVXNlQ2FzZSB9IGZyb20gJy4uL2FwcGxpY2F0aW9uL3VzZWNhc2VzL0VuYWJsZTJGQVVzZUNhc2UnO1xuaW1wb3J0IHsgVmVyaWZ5MkZBVXNlQ2FzZSB9IGZyb20gJy4uL2FwcGxpY2F0aW9uL3VzZWNhc2VzL1ZlcmlmeTJGQVVzZUNhc2UnO1xuaW1wb3J0IHsgVFlQRVMgfSBmcm9tICcuLi90eXBlcyc7XG5pbXBvcnQgeyBBcHBFcnJvciB9IGZyb20gJy4uL3V0aWxzL2Vycm9ycyc7XG5pbXBvcnQgeyB2YWxpZGF0ZSwgc2NoZW1hcyB9IGZyb20gJy4uL21pZGRsZXdhcmUvdmFsaWRhdGlvbi5taWRkbGV3YXJlJztcblxuLy8gSGVscGVyIHRvIHNldCByZWZyZXNoIHRva2VuIGNvb2tpZVxuY29uc3Qgc2V0UmVmcmVzaFRva2VuQ29va2llID0gKHJlczogUmVzcG9uc2UsIHRva2VuOiBzdHJpbmcpID0+IHtcbiAgcmVzLmNvb2tpZSgncmVmcmVzaF90b2tlbicsIHRva2VuLCB7XG4gICAgaHR0cE9ubHk6IHRydWUsXG4gICAgc2VjdXJlOiBjb25maWcubm9kZUVudiA9PT0gJ3Byb2R1Y3Rpb24nLFxuICAgIHNhbWVTaXRlOiAnc3RyaWN0JyxcbiAgICBtYXhBZ2U6IDcgKiAyNCAqIDYwICogNjAgKiAxMDAwLCAvLyA3IGRheXNcbiAgfSk7XG59O1xuXG5leHBvcnQgY29uc3QgcmVnaXN0ZXIgPSBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBhdXRoU2VydmljZSA9IGNvbnRhaW5lci5nZXQ8QXV0aFNlcnZpY2U+KFRZUEVTLkF1dGhTZXJ2aWNlKTtcbiAgICBjb25zdCB7IHVzZXIsIHRva2VuLCByZWZyZXNoVG9rZW4gfSA9IGF3YWl0IGF1dGhTZXJ2aWNlLnJlZ2lzdGVyKHJlcS5ib2R5KTtcblxuICAgIC8vIE5vIGRldm9sdmVyIGxhIGNvbnRyYXNlw7FhIGVuIGxhIHJlc3B1ZXN0YVxuICAgIGNvbnN0IHVzZXJSZXNwb25zZTogYW55ID0gdXNlci50b09iamVjdCgpO1xuICAgIGRlbGV0ZSB1c2VyUmVzcG9uc2UucGFzc3dvcmQ7XG4gICAgZGVsZXRlIHVzZXJSZXNwb25zZS5yZWZyZXNoVG9rZW5zOyAvLyBEb24ndCBzZW5kIERCIGFycmF5IHRvIGNsaWVudFxuXG4gICAgc2V0UmVmcmVzaFRva2VuQ29va2llKHJlcywgcmVmcmVzaFRva2VuKTtcblxuICAgIHJlcy5zdGF0dXMoMjAxKS5qc29uKGJ1aWxkUmVzcG9uc2UoeyB1c2VyOiB1c2VyUmVzcG9uc2UsIHRva2VuIH0sIDIwMSwgKHJlcSBhcyBhbnkpLnJlcXVlc3RJZCkpO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIG5leHQoZXJyb3IpO1xuICB9XG59O1xuXG5leHBvcnQgY29uc3QgbG9naW4gPSBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBhdXRoU2VydmljZSA9IGNvbnRhaW5lci5nZXQ8QXV0aFNlcnZpY2U+KFRZUEVTLkF1dGhTZXJ2aWNlKTtcbiAgICBjb25zdCB7IGVtYWlsLCBwYXNzd29yZCB9ID0gcmVxLmJvZHk7XG4gICAgY29uc3QgaXAgPSByZXEuaXA7XG4gICAgY29uc3QgdXNlckFnZW50ID0gcmVxLmhlYWRlcnNbJ3VzZXItYWdlbnQnXTtcblxuICAgIGNvbnN0IHsgdXNlciwgdG9rZW4sIHJlZnJlc2hUb2tlbiwgbWZhUmVxdWlyZWQgfSA9IGF3YWl0IGF1dGhTZXJ2aWNlLmxvZ2luKHtcbiAgICAgIGVtYWlsLFxuICAgICAgcGFzc3dvcmQsXG4gICAgICBpcCxcbiAgICAgIHVzZXJBZ2VudCxcbiAgICB9KTtcblxuICAgIGlmIChtZmFSZXF1aXJlZCkge1xuICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24oXG4gICAgICAgIGJ1aWxkUmVzcG9uc2UoXG4gICAgICAgICAge1xuICAgICAgICAgICAgbWZhUmVxdWlyZWQ6IHRydWUsXG4gICAgICAgICAgICB1c2VySWQ6IHVzZXIuX2lkLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgMjAwLFxuICAgICAgICAgIChyZXEgYXMgYW55KS5yZXF1ZXN0SWQsXG4gICAgICAgICksXG4gICAgICApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIEVuc3VyZSB3ZSBoYXZlIHRva2VucyBiZWZvcmUgc2V0dGluZyBjb29raWUgKHR5cGVzY3JpcHQgZ3VhcmQpXG4gICAgaWYgKHJlZnJlc2hUb2tlbiAmJiB0b2tlbikge1xuICAgICAgY29uc3QgdXNlclJlc3BvbnNlOiBhbnkgPSB1c2VyLnRvT2JqZWN0KCk7XG4gICAgICBkZWxldGUgdXNlclJlc3BvbnNlLnBhc3N3b3JkO1xuICAgICAgZGVsZXRlIHVzZXJSZXNwb25zZS5yZWZyZXNoVG9rZW5zO1xuXG4gICAgICBzZXRSZWZyZXNoVG9rZW5Db29raWUocmVzLCByZWZyZXNoVG9rZW4pO1xuXG4gICAgICByZXNcbiAgICAgICAgLnN0YXR1cygyMDApXG4gICAgICAgIC5qc29uKGJ1aWxkUmVzcG9uc2UoeyB1c2VyOiB1c2VyUmVzcG9uc2UsIHRva2VuIH0sIDIwMCwgKHJlcSBhcyBhbnkpLnJlcXVlc3RJZCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgQXBwRXJyb3IoJ0xvZ2luIGZhaWxlZCB0byBnZW5lcmF0ZSB0b2tlbnMnLCA1MDAsICdJTlRFUk5BTF9FUlJPUicpO1xuICAgIH1cbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBuZXh0KGVycm9yKTtcbiAgfVxufTtcblxuZXhwb3J0IGNvbnN0IHJlZnJlc2ggPSBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCByZWZyZXNoVG9rZW4gPSByZXEuY29va2llc1sncmVmcmVzaF90b2tlbiddO1xuICAgIGlmICghcmVmcmVzaFRva2VuKSB7XG4gICAgICB0aHJvdyBuZXcgQXBwRXJyb3IoJ1JlZnJlc2ggVG9rZW4gUmVxdWlyZWQnLCA0MDEsICdSRUZSRVNIX1RPS0VOX1JFUVVJUkVEJyk7XG4gICAgfVxuXG4gICAgY29uc3QgYXV0aFNlcnZpY2UgPSBjb250YWluZXIuZ2V0PEF1dGhTZXJ2aWNlPihUWVBFUy5BdXRoU2VydmljZSk7XG4gICAgY29uc3QgaXAgPSByZXEuaXAgfHwgJ3Vua25vd24nO1xuICAgIGNvbnN0IHVzZXJBZ2VudCA9IHJlcS5oZWFkZXJzWyd1c2VyLWFnZW50J10gfHwgJ3Vua25vd24nO1xuXG4gICAgY29uc3Qge1xuICAgICAgdXNlcixcbiAgICAgIGFjY2Vzc1Rva2VuLFxuICAgICAgcmVmcmVzaFRva2VuOiBuZXdSZWZyZXNoVG9rZW4sXG4gICAgfSA9IGF3YWl0IGF1dGhTZXJ2aWNlLnJlZnJlc2hUb2tlbihyZWZyZXNoVG9rZW4sIGlwLCB1c2VyQWdlbnQpO1xuXG4gICAgc2V0UmVmcmVzaFRva2VuQ29va2llKHJlcywgbmV3UmVmcmVzaFRva2VuKTtcblxuICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKGJ1aWxkUmVzcG9uc2UoeyBhY2Nlc3NUb2tlbiB9LCAyMDAsIChyZXEgYXMgYW55KS5yZXF1ZXN0SWQpKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAvLyBJZiByZWZyZXNoIGZhaWxzIChzZWN1cml0eSByZXVzZSwgZXhwaXJlZCksIGNsZWFyIGNvb2tpZVxuICAgIHJlcy5jbGVhckNvb2tpZSgncmVmcmVzaF90b2tlbicpO1xuICAgIG5leHQoZXJyb3IpO1xuICB9XG59O1xuXG5leHBvcnQgY29uc3QgbG9nb3V0ID0gYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgcmVmcmVzaFRva2VuID0gcmVxLmNvb2tpZXNbJ3JlZnJlc2hfdG9rZW4nXTtcbiAgICBpZiAocmVmcmVzaFRva2VuKSB7XG4gICAgICAvLyBAdHMtaWdub3JlXG4gICAgICBjb25zdCBhdXRoU2VydmljZSA9IGNvbnRhaW5lci5nZXQ8QXV0aFNlcnZpY2U+KFRZUEVTLkF1dGhTZXJ2aWNlKTtcbiAgICAgIGF3YWl0IGF1dGhTZXJ2aWNlLmxvZ291dChyZWZyZXNoVG9rZW4pO1xuICAgIH1cblxuICAgIHJlcy5jbGVhckNvb2tpZSgncmVmcmVzaF90b2tlbicpO1xuICAgIHJlc1xuICAgICAgLnN0YXR1cygyMDApXG4gICAgICAuanNvbihidWlsZFJlc3BvbnNlKHsgbWVzc2FnZTogJ0xvZ2dlZCBvdXQgc3VjY2Vzc2Z1bGx5JyB9LCAyMDAsIChyZXEgYXMgYW55KS5yZXF1ZXN0SWQpKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBuZXh0KGVycm9yKTtcbiAgfVxufTtcblxuZXhwb3J0IGNvbnN0IGdldE1lID0gYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gIHRyeSB7XG4gICAgaWYgKCFyZXEudXNlcikge1xuICAgICAgcmV0dXJuIG5leHQobmV3IEFwcEVycm9yKCdVc3VhcmlvIG5vIGF1dGVudGljYWRvJywgNDAxLCAnVU5BVVRIT1JJWkVEJykpO1xuICAgIH1cbiAgICBjb25zdCBhdXRoU2VydmljZSA9IGNvbnRhaW5lci5nZXQ8QXV0aFNlcnZpY2U+KFRZUEVTLkF1dGhTZXJ2aWNlKTtcbiAgICBjb25zdCB1c2VyID0gYXdhaXQgYXV0aFNlcnZpY2UuZ2V0VXNlclByb2ZpbGUocmVxLnVzZXIuaWQpO1xuXG4gICAgaWYgKCF1c2VyKSB7XG4gICAgICByZXR1cm4gbmV4dChuZXcgQXBwRXJyb3IoJ1VzdWFyaW8gbm8gZW5jb250cmFkbycsIDQwNCwgJ05PVF9GT1VORCcpKTtcbiAgICB9XG5cbiAgICByZXMuc3RhdHVzKDIwMCkuanNvbihidWlsZFJlc3BvbnNlKHVzZXIsIDIwMCwgKHJlcSBhcyBhbnkpLnJlcXVlc3RJZCkpO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIG5leHQoZXJyb3IpO1xuICB9XG59O1xuXG4vLyBFbmFibGUgMkZBXG5leHBvcnQgY29uc3QgZW5hYmxlMkZBID0gW1xuICB2YWxpZGF0ZSh7IGJvZHk6IHNjaGVtYXMuYXV0aC5lbmFibGUyRkEgfSksXG4gIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbik6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBlbmFibGUyRkFVc2VDYXNlID0gY29udGFpbmVyLmdldDxFbmFibGUyRkFVc2VDYXNlPihUWVBFUy5FbmFibGUyRkFVc2VDYXNlKTtcbiAgICAgIGNvbnN0IHsgdXNlcklkIH0gPSByZXEuYm9keTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGVuYWJsZTJGQVVzZUNhc2UuZXhlY3V0ZSh1c2VySWQpO1xuICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24oYnVpbGRSZXNwb25zZShyZXN1bHQsIDIwMCwgKHJlcSBhcyBhbnkpLnJlcXVlc3RJZCkpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBuZXh0KGVycm9yKTtcbiAgICB9XG4gIH0sXG5dO1xuXG4vLyBWZXJpZnkgMkZBIHRva2VuXG5leHBvcnQgY29uc3QgdmVyaWZ5MkZBID0gW1xuICB2YWxpZGF0ZSh7IGJvZHk6IHNjaGVtYXMuYXV0aC52ZXJpZnkyRkEgfSksXG4gIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbik6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB2ZXJpZnkyRkFVc2VDYXNlID0gY29udGFpbmVyLmdldDxWZXJpZnkyRkFVc2VDYXNlPihUWVBFUy5WZXJpZnkyRkFVc2VDYXNlKTtcbiAgICAgIGNvbnN0IHsgdXNlcklkLCB0b2tlbiB9ID0gcmVxLmJvZHk7XG4gICAgICBhd2FpdCB2ZXJpZnkyRkFVc2VDYXNlLmV4ZWN1dGUodXNlcklkLCB0b2tlbik7XG4gICAgICByZXMuc3RhdHVzKDIwMCkuanNvbihidWlsZFJlc3BvbnNlKHsgc3VjY2VzczogdHJ1ZSB9LCAyMDAsIChyZXEgYXMgYW55KS5yZXF1ZXN0SWQpKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbmV4dChlcnJvcik7XG4gICAgfVxuICB9LFxuXTtcblxuLy8gVmVyaWZ5IExvZ2luIDJGQSAoU3RlcCAyIG9mIExvZ2luKVxuZXhwb3J0IGNvbnN0IHZlcmlmeUxvZ2luMkZBID0gYXN5bmMgKFxuICByZXE6IFJlcXVlc3QsXG4gIHJlczogUmVzcG9uc2UsXG4gIG5leHQ6IE5leHRGdW5jdGlvbixcbik6IFByb21pc2U8dm9pZD4gPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IGF1dGhTZXJ2aWNlID0gY29udGFpbmVyLmdldDxBdXRoU2VydmljZT4oVFlQRVMuQXV0aFNlcnZpY2UpO1xuICAgIGNvbnN0IHsgdXNlcklkLCB0b2tlbiB9ID0gcmVxLmJvZHk7XG4gICAgY29uc3QgaXAgPSByZXEuaXA7XG4gICAgY29uc3QgdXNlckFnZW50ID0gcmVxLmhlYWRlcnNbJ3VzZXItYWdlbnQnXTtcblxuICAgIGNvbnN0IHtcbiAgICAgIHVzZXIsXG4gICAgICB0b2tlbjogYWNjZXNzVG9rZW4sXG4gICAgICByZWZyZXNoVG9rZW4sXG4gICAgfSA9IGF3YWl0IGF1dGhTZXJ2aWNlLnZlcmlmeUxvZ2luMkZBKHtcbiAgICAgIHVzZXJJZCxcbiAgICAgIHRva2VuLFxuICAgICAgaXAsXG4gICAgICB1c2VyQWdlbnQsXG4gICAgfSk7XG5cbiAgICBjb25zdCB1c2VyUmVzcG9uc2U6IGFueSA9IHVzZXIudG9PYmplY3QoKTtcbiAgICBkZWxldGUgdXNlclJlc3BvbnNlLnBhc3N3b3JkO1xuICAgIGRlbGV0ZSB1c2VyUmVzcG9uc2UucmVmcmVzaFRva2VucztcblxuICAgIHNldFJlZnJlc2hUb2tlbkNvb2tpZShyZXMsIHJlZnJlc2hUb2tlbik7XG5cbiAgICByZXNcbiAgICAgIC5zdGF0dXMoMjAwKVxuICAgICAgLmpzb24oYnVpbGRSZXNwb25zZSh7IHVzZXI6IHVzZXJSZXNwb25zZSwgdG9rZW46IGFjY2Vzc1Rva2VuIH0sIDIwMCwgKHJlcSBhcyBhbnkpLnJlcXVlc3RJZCkpO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIG5leHQoZXJyb3IpO1xuICB9XG59O1xuXG4vLyBWZXJpZnkgRW1haWwgQ29kZVxuZXhwb3J0IGNvbnN0IHZlcmlmeUVtYWlsID0gYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgYXV0aFNlcnZpY2UgPSBjb250YWluZXIuZ2V0PEF1dGhTZXJ2aWNlPihUWVBFUy5BdXRoU2VydmljZSk7XG4gICAgY29uc3QgeyB1c2VySWQsIGNvZGUgfSA9IHJlcS5ib2R5O1xuICAgIGF3YWl0IGF1dGhTZXJ2aWNlLnZlcmlmeUVtYWlsKHVzZXJJZCwgY29kZSk7XG4gICAgcmVzLnN0YXR1cygyMDApLmpzb24oYnVpbGRSZXNwb25zZSh7IHN1Y2Nlc3M6IHRydWUsIG1lc3NhZ2U6ICdFbWFpbCB2ZXJpZmljYWRvIGNvcnJlY3RhbWVudGUnIH0sIDIwMCwgKHJlcSBhcyBhbnkpLnJlcXVlc3RJZCkpO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIG5leHQoZXJyb3IpO1xuICB9XG59O1xuXG4vLyBVcGRhdGUgVXNlciBSb2xlXG5leHBvcnQgY29uc3QgdXBkYXRlVXNlclJvbGUgPSBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBhdXRoU2VydmljZSA9IGNvbnRhaW5lci5nZXQ8QXV0aFNlcnZpY2U+KFRZUEVTLkF1dGhTZXJ2aWNlKTtcbiAgICBjb25zdCB7IHVzZXJJZCwgcm9sZSB9ID0gcmVxLmJvZHk7XG4gICAgLy8gVmFsaWRhdGUgcm9sZSBpcyAnZmFtaWx5JyBvciAncHJvZmVzc2lvbmFsJyA/P1xuICAgIC8vIElkZWFsbHkgdmFsaWRhdGUgdmlhIG1pZGRsZXdhcmUgc2NoZW1hLCBidXQgaGVyZSBmb3Igc2FmZXR5OlxuICAgIGlmICghWydmYW1pbHknLCAncHJvZmVzc2lvbmFsJ10uaW5jbHVkZXMocm9sZSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEFwcEVycm9yKCdSb2wgaW52w6FsaWRvLiBEZWJlIHNlciBcImZhbWlseVwiIG8gXCJwcm9mZXNzaW9uYWxcIicsIDQwMCwgJ0lOVkFMSURfUk9MRScpO1xuICAgIH1cblxuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBhdXRoU2VydmljZS51cGRhdGVVc2VyUm9sZSh1c2VySWQsIHJvbGUpO1xuICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKGJ1aWxkUmVzcG9uc2UoeyBzdWNjZXNzOiB0cnVlLCB1c2VyIH0sIDIwMCwgKHJlcSBhcyBhbnkpLnJlcXVlc3RJZCkpO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIG5leHQoZXJyb3IpO1xuICB9XG59O1xuXG4vLyBVcGRhdGUgU3Vic2NyaXB0aW9uIFBsYW5cbmV4cG9ydCBjb25zdCB1cGRhdGVTdWJzY3JpcHRpb24gPSBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBhdXRoU2VydmljZSA9IGNvbnRhaW5lci5nZXQ8QXV0aFNlcnZpY2U+KFRZUEVTLkF1dGhTZXJ2aWNlKTtcbiAgICBjb25zdCB7IHVzZXJJZCwgcGxhbiB9ID0gcmVxLmJvZHk7XG5cbiAgICBjb25zdCB1c2VyID0gYXdhaXQgYXV0aFNlcnZpY2UudXBkYXRlU3Vic2NyaXB0aW9uKHVzZXJJZCwgcGxhbik7XG4gICAgcmVzLnN0YXR1cygyMDApLmpzb24oYnVpbGRSZXNwb25zZSh7IHN1Y2Nlc3M6IHRydWUsIHVzZXIgfSwgMjAwLCAocmVxIGFzIGFueSkucmVxdWVzdElkKSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgbmV4dChlcnJvcik7XG4gIH1cbn07XG4iXSwidmVyc2lvbiI6M30=