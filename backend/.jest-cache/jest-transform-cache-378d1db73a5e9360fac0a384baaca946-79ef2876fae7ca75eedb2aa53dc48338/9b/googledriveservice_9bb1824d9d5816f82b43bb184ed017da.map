{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\google\\google-drive.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\google\\google-drive.service.ts"],"sourcesContent":["import fs from 'fs';\nimport { drive_v3, google } from 'googleapis';\nimport { injectable } from 'inversify';\n\nimport { logger } from '../../utils/logger';\n\n@injectable()\nexport class GoogleDriveService {\n  private drive: drive_v3.Drive | null = null;\n  private readonly DRIVE_SCOPES = ['https://www.googleapis.com/auth/drive'];\n  private initPromise: Promise<void> | null = null;\n\n  constructor() {\n    this.initPromise = this.initializeClient();\n  }\n\n  private async initializeClient() {\n    try {\n      if (!process.env.GOOGLE_APPLICATION_CREDENTIALS && !process.env.GOOGLE_SERVICE_ACCOUNT_JSON) {\n        logger.warn('Google Drive credentials not found. Skipping initialization.');\n        return;\n      }\n      const auth = new google.auth.GoogleAuth({\n        scopes: this.DRIVE_SCOPES,\n      });\n      const authClient = await auth.getClient();\n      this.drive = google.drive({ version: 'v3', auth: authClient as any });\n      logger.info('Google Drive client initialized');\n    } catch (error) {\n      logger.error('Failed to initialize Google Drive client:', error);\n      throw error;\n    }\n  }\n\n  private async getDriveClient(): Promise<drive_v3.Drive> {\n    if (this.initPromise) {\n      await this.initPromise;\n    }\n    if (!this.drive) {\n      throw new Error('Google Drive client not initialized');\n    }\n    return this.drive;\n  }\n\n  /**\n   * Ensures a folder path exists in Drive, creating missing folders.\n   * Path should be relative, e.g. \"Backups/Alejandro\"\n   * Returns the ID of the final folder.\n   */\n  async ensureFolder(folderPath: string, parentId = 'root'): Promise<string> {\n    await this.getDriveClient();\n\n    const parts = folderPath.split('/').filter(p => p.length > 0);\n    let currentParentId = parentId;\n\n    for (const part of parts) {\n      const foundId = await this.findFolder(part, currentParentId);\n      if (foundId) {\n        currentParentId = foundId;\n      } else {\n        currentParentId = await this.createFolder(part, currentParentId);\n      }\n    }\n\n    return currentParentId;\n  }\n\n  async findFolder(name: string, parentId: string): Promise<string | null> {\n    const drive = await this.getDriveClient();\n    try {\n      const query = `mimeType='application/vnd.google-apps.folder' and name='${name}' and '${parentId}' in parents and trashed=false`;\n      const res = await drive.files.list({\n        q: query,\n        fields: 'files(id, name)',\n        spaces: 'drive',\n      });\n      const files = res.data.files;\n      if (files && files.length > 0) {\n        return files[0].id || null;\n      }\n      return null;\n    } catch (error) {\n      logger.error(`Error finding folder ${name}:`, error);\n      throw error;\n    }\n  }\n\n  async createFolder(name: string, parentId: string): Promise<string> {\n    const drive = await this.getDriveClient();\n    try {\n      const fileMetadata = {\n        name: name,\n        mimeType: 'application/vnd.google-apps.folder',\n        parents: [parentId],\n      };\n      const file = await drive.files.create({\n        requestBody: fileMetadata,\n        fields: 'id',\n      });\n      logger.info(`Created folder ${name} (${file.data.id})`);\n      return file.data.id!;\n    } catch (error) {\n      logger.error(`Error creating folder ${name}:`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * Uploads a file to Drive.\n   * Checks for existing file with same name in parent.\n   * If exists, updates it (if we want versioning) or overwrites?\n   * For backup sync, usually we want to update content or replace.\n   * Here we will search for existing file by name.\n   */\n  async uploadFile(\n    localPath: string,\n    fileName: string,\n    parentId: string,\n    mimeType: string,\n    hash: string,\n  ): Promise<void> {\n    if (!this.drive) {\n      throw new Error('Drive client not initialized');\n    }\n\n    // Check if file exists\n    const existingFileId = await this.findFile(fileName, parentId);\n\n    const requestBody = {\n      name: fileName,\n      parents: existingFileId ? undefined : [parentId], // Only set parent on create\n      properties: {\n        localHash: hash,\n      },\n    };\n\n    const media = {\n      mimeType: mimeType,\n      body: fs.createReadStream(localPath),\n    };\n\n    try {\n      if (existingFileId) {\n        // Update\n        await this.drive.files.update({\n          fileId: existingFileId,\n          requestBody: {\n            properties: { localHash: hash }, // Update hash\n          },\n          media: media,\n        });\n        logger.info(`Updated file ${fileName} (${existingFileId})`);\n      } else {\n        // Create\n        await this.drive.files.create({\n          requestBody: requestBody,\n          media: media,\n          fields: 'id',\n        });\n        logger.info(`Uploaded new file ${fileName}`);\n      }\n    } catch (error) {\n      logger.error(`Error uploading file ${fileName}:`, error);\n      throw error;\n    }\n  }\n\n  async findFile(name: string, parentId: string): Promise<string | null> {\n    if (!this.drive) {\n      throw new Error('Drive client not initialized');\n    }\n    try {\n      // Note: we don't restrict mimeType here, just name and parent\n      const query = `name='${name}' and '${parentId}' in parents and trashed=false`;\n      const res = await this.drive.files.list({\n        q: query,\n        fields: 'files(id, name, properties)',\n      });\n      if (res.data.files && res.data.files.length > 0) {\n        return res.data.files[0].id || null;\n      }\n      return null;\n    } catch (error) {\n      // ignore or log\n      return null;\n    }\n  }\n\n  /**\n   * Gets specific custom property (hash) of a file\n   */\n  async getFileHash(name: string, parentId: string): Promise<string | null> {\n    if (!this.drive) {\n      throw new Error('Drive client not initialized');\n    }\n    try {\n      const query = `name='${name}' and '${parentId}' in parents and trashed=false`;\n      const res = await this.drive.files.list({\n        q: query,\n        fields: 'files(id, properties)',\n      });\n      if (res.data.files && res.data.files.length > 0) {\n        const file = res.data.files[0];\n        return file.properties?.localHash || null;\n      }\n      return null;\n    } catch (error) {\n      return null;\n    }\n  }\n\n  /**\n   * Lists contents of a folder for restore purposes\n   */\n  async listFolderContents(\n    folderId: string,\n  ): Promise<{ id: string; name: string; mimeType: string; localHash?: string }[]> {\n    if (!this.drive) {\n      throw new Error('Drive client not initialized');\n    }\n    try {\n      const query = `'${folderId}' in parents and trashed=false`;\n      const res = await this.drive.files.list({\n        q: query,\n        fields: 'files(id, name, mimeType, properties)',\n        pageSize: 1000,\n      });\n      return (res.data.files || []).map(f => ({\n        id: f.id!,\n        name: f.name!,\n        mimeType: f.mimeType!,\n        localHash: f.properties?.localHash,\n      }));\n    } catch (error) {\n      logger.error(`Error listing folder contents for ${folderId}:`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * Downloads a file from Drive to local destination\n   */\n  async downloadFile(fileId: string, destinationPath: string): Promise<void> {\n    if (!this.drive) {\n      throw new Error('Drive client not initialized');\n    }\n    return new Promise((resolve, reject) => {\n      this.drive!.files.get({ fileId, alt: 'media' }, { responseType: 'stream' })\n        .then(res => {\n          const dest = fs.createWriteStream(destinationPath);\n          res.data\n            .on('end', () => resolve())\n            .on('error', err => reject(err))\n            .pipe(dest);\n        })\n        .catch(err => reject(err));\n    });\n  }\n}\n"],"version":3}