{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\application\\usecases\\Verify2FAUseCase.ts","mappings":";;;;;;;;;;;;;;;;AAAA,yCAA+C;AAC/C,uCAAoC;AACpC,4CAAyC;AACzC,0EAAqE;AACrE,0EAAqE;AACrE,+CAA8C;AAGvC,IAAM,gBAAgB,GAAtB,MAAM,gBAAgB;IAEe;IACA;IAF1C,YAC0C,gBAAkC,EAClC,gBAAkC;QADlC,qBAAgB,GAAhB,gBAAgB,CAAkB;QAClC,qBAAgB,GAAhB,gBAAgB,CAAkB;IACzE,CAAC;IAEJ,KAAK,CAAC,OAAO,CAAC,MAAc,EAAE,KAAa;QACzC,wCAAwC;QACxC,MAAM,IAAI,CAAC,gBAAgB,CAAC,iBAAiB,CAAC,cAAc,MAAM,EAAE,EAAE,CAAC,EAAE,EAAE,GAAG,EAAE,CAAC,CAAC;QAElF,MAAM,IAAI,GAAG,MAAM,WAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;QACzC,IAAI,CAAC,IAAI,EAAE,CAAC;YACV,MAAM,IAAI,iBAAQ,CAAC,gBAAgB,EAAE,GAAG,EAAE,gBAAgB,CAAC,CAAC;QAC9D,CAAC;QACD,IAAI,CAAC,IAAI,CAAC,eAAe,EAAE,CAAC;YAC1B,MAAM,IAAI,iBAAQ,CAAC,+BAA+B,EAAE,GAAG,EAAE,iBAAiB,CAAC,CAAC;QAC9E,CAAC;QACD,MAAM,OAAO,GAAG,IAAI,CAAC,gBAAgB,CAAC,WAAW,CAAC,IAAI,CAAC,eAAe,EAAE,KAAK,CAAC,CAAC;QAC/E,IAAI,CAAC,OAAO,EAAE,CAAC;YACb,MAAM,IAAI,iBAAQ,CAAC,mBAAmB,EAAE,GAAG,EAAE,mBAAmB,CAAC,CAAC;QACpE,CAAC;QACD,oDAAoD;QACpD,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC;QACzB,+EAA+E;QAC/E,oCAAoC;QACpC,8BAA8B;QAC9B,MAAM,IAAI,CAAC,gBAAgB,CAAC,KAAK,CAAC,cAAc,MAAM,EAAE,CAAC,CAAC;QAC1D,MAAM,IAAI,CAAC,IAAI,EAAE,CAAC;IACpB,CAAC;CACF,CAAA;AA7BY,4CAAgB;2BAAhB,gBAAgB;IAD5B,IAAA,sBAAU,GAAE;IAGR,WAAA,IAAA,kBAAM,EAAC,aAAK,CAAC,gBAAgB,CAAC,CAAA;IAC9B,WAAA,IAAA,kBAAM,EAAC,aAAK,CAAC,gBAAgB,CAAC,CAAA;yDAD2B,qCAAgB,oBAAhB,qCAAgB,oDAChB,qCAAgB,oBAAhB,qCAAgB;GAHjE,gBAAgB,CA6B5B","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\application\\usecases\\Verify2FAUseCase.ts"],"sourcesContent":["import { injectable, inject } from 'inversify';\nimport { TYPES } from '../../types';\nimport { User } from '../../models/User';\nimport { TwoFactorService } from '../../services/two-factor.service';\nimport { RateLimitService } from '../../services/rate-limit.service';\nimport { AppError } from '../../utils/errors';\n\n@injectable()\nexport class Verify2FAUseCase {\n  constructor(\n    @inject(TYPES.TwoFactorService) private twoFactorService: TwoFactorService,\n    @inject(TYPES.RateLimitService) private rateLimitService: RateLimitService,\n  ) {}\n\n  async execute(userId: string, token: string): Promise<void> {\n    // Rate Limit: 5 attempts per 15 minutes\n    await this.rateLimitService.incrementAndCheck(`2fa_verify:${userId}`, 5, 15 * 60);\n\n    const user = await User.findById(userId);\n    if (!user) {\n      throw new AppError('User not found', 404, 'USER_NOT_FOUND');\n    }\n    if (!user.twoFactorSecret) {\n      throw new AppError('2FA not enabled for this user', 400, '2FA_NOT_ENABLED');\n    }\n    const isValid = this.twoFactorService.verifyToken(user.twoFactorSecret, token);\n    if (!isValid) {\n      throw new AppError('Invalid 2FA token', 401, 'INVALID_2FA_TOKEN');\n    }\n    // Mark MFA as enabled after successful verification\n    user.isMfaEnabled = true;\n    // Optionally, you could clear the secret after verification for added security\n    // user.twoFactorSecret = undefined;\n    // Clear rate limit on success\n    await this.rateLimitService.reset(`2fa_verify:${userId}`);\n    await user.save();\n  }\n}\n"],"version":3}