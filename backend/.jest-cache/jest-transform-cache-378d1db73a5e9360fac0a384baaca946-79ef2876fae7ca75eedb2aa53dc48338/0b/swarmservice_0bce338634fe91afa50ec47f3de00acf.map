{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\swarm.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\swarm.service.ts"],"sourcesContent":["import { inject, injectable } from 'inversify';\nimport { JobQueue } from '../infrastructure/jobs/JobQueue';\nimport { JobName } from '../infrastructure/jobs/job-definitions';\nimport { IMissionRepository } from '../infrastructure/repository/MissionRepository';\nimport { MissionStatus } from '../models/Mission';\nimport { TYPES } from '../types';\nimport { logger } from '../utils/logger';\nimport { AIService } from './ai.service';\nimport { DeFiStrategistService } from './defi-strategist.service';\nimport { InfraOptimizerService } from './infra-optimizer.service';\nimport { KnowledgeGraphService } from './knowledge-graph.service';\nimport { MetaverseService } from './metaverse.service';\nimport { RagService } from './rag.service';\n\n@injectable()\nexport class SwarmService {\n  constructor(\n    @inject(TYPES.AIService) private aiService: AIService,\n    @inject(TYPES.MetaverseService) private metaverseService: MetaverseService,\n    @inject(TYPES.DeFiStrategistService) private defiService: DeFiStrategistService,\n    @inject(TYPES.InfraOptimizerService) private infraService: InfraOptimizerService,\n    @inject(TYPES.RagService) private ragService: RagService,\n    @inject(TYPES.JobQueue) private jobQueue: JobQueue,\n    @inject(TYPES.MissionRepository) private missionRepo: IMissionRepository,\n    @inject(TYPES.KnowledgeGraphService) private kgService: KnowledgeGraphService,\n  ) {}\n\n  /**\n   * Launches a long-running autonomous mission.\n   */\n  async createMission(objective: string, userId: string): Promise<any> {\n    logger.info(`[SwarmService] Creating mission for user ${userId}: ${objective}`);\n\n    try {\n      // 1. Persist the mission in the database\n      const mission = await this.missionRepo.create({\n        objective,\n        userId,\n        status: MissionStatus.PENDING,\n      });\n\n      // 2. Enqueue the background job\n      await this.jobQueue.addJob(JobName.SWARM_MISSION, {\n        objective,\n        userId,\n        missionId: mission.id,\n        context: {\n          startedAt: new Date().toISOString(),\n        },\n      });\n\n      return {\n        status: 'success',\n        message: 'Mission launched successfully',\n        missionId: mission.id,\n        objective,\n      };\n    } catch (error) {\n      logger.error('[SwarmService] Failed to launch mission:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Retrieves the status and results of a mission.\n   */\n  async getMission(id: string): Promise<any> {\n    const mission = await this.missionRepo.findById(id);\n    if (!mission) {\n      throw new Error(`Mission not found: ${id}`);\n    }\n    return mission;\n  }\n\n  /**\n   * Provides a consolidated \"God State\" for the Python Swarm.\n   * This allows Python agents to know exactly what tools and data are available in Node.js.\n   */\n  async getGodState(): Promise<any> {\n    try {\n      const metaverse = await this.metaverseService.getStatus();\n      const defi = await this.defiService.getYieldAdvice();\n      const infra = await this.infraService.getInfraRecommendations();\n\n      return {\n        timestamp: new Date().toISOString(),\n        version: '1.0.0-godmode',\n        system_status: 'Sovereign',\n        realms: {\n          metaverse: {\n            coordinates: metaverse.coordinates,\n            status: metaverse.offline ? 'offline' : 'active',\n            events: metaverse.activeEvents,\n          },\n          finance: {\n            health_score: 85, // Meta-score placeholder\n            outlook: defi.marketSentiment,\n            strategy: defi.strategy,\n          },\n          infrastructure: {\n            optimization_level: 'pending',\n            top_recommendation: infra.recommendations[0]?.action || 'None',\n            potential_savings: infra.totalPotentialSavings,\n          },\n        },\n        available_tools: [\n          'query_document_brain',\n          'analyze_financial_yield',\n          'get_metaverse_office_status',\n          'deploy_infra_optimization',\n        ],\n      };\n    } catch (error) {\n      logger.error('[SwarmService] Failed to compile God State:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Gateway for the Python Swarm to execute Node.js tools.\n   */\n  async executeTool(toolName: string, args: any): Promise<any> {\n    logger.info(`[SwarmService] Python Swarm requesting tool: ${toolName}`, args);\n\n    try {\n      switch (toolName) {\n        case 'query_document_brain':\n          const results = await this.ragService.queryKnowledgeBase(args.query);\n          return { status: 'success', data: results };\n\n        case 'analyze_financial_yield':\n          const yieldData = await this.defiService.getYieldAdvice();\n          return { status: 'success', data: yieldData };\n\n        case 'get_metaverse_office_status':\n          const officeStatus = await this.metaverseService.getStatus();\n          return { status: 'success', data: officeStatus };\n\n        case 'deploy_infra_optimization':\n          const infraPlan = await this.infraService.optimize(args.target || 'all');\n          return { status: 'success', data: infraPlan };\n\n        default:\n          logger.warn(`[SwarmService] Unknown tool requested: ${toolName}`);\n          return { status: 'error', message: `Unknown tool: ${toolName}` };\n      }\n    } catch (error) {\n      logger.error(`[SwarmService] Tool execution failed: ${toolName}`, error);\n      return {\n        status: 'error',\n        message: error instanceof Error ? error.message : 'Execution failed',\n      };\n    }\n  }\n\n  /**\n   * [GOD MODE] Multi-Agent Orchestration Loop\n   * Recursively solves complex missions by spawning sub-agents.\n   */\n  async executeAutonomousLoop(missionId: string, depth: number = 0): Promise<void> {\n    if (depth > 5) {\n      logger.warn(`[Swarm] Max depth reached for mission ${missionId}`);\n      return;\n    }\n\n    const mission = await this.getMission(missionId);\n    logger.info(`[Swarm] Agent Active: Analyzing mission \"${mission.objective}\" (Depth: ${depth})`);\n\n    // 1. Consult Knowledge Graph for context\n    const contextNodes = await this.kgService.getRelated(mission.userId, 'focus_on');\n    const contextStr = contextNodes.map(n => n.label).join(', ');\n\n    // 2. Plan steps including context\n    const prompt = `Objective: ${mission.objective}. Context: ${contextStr}. Return a definition of 3 sub-tasks to achieve this.`;\n    const plan = await this.aiService.generateContent(prompt, mission.userId, 'system_architect');\n\n    logger.info(`[Swarm] Generated Plan: ${plan}`);\n\n    // 3. Execute or Delegate (Simplified simulation)\n    // In a full implementation, this would parse the 'plan' JSON and spawn concrete jobs.\n    // For now, we update the KG to reflect progress.\n    await this.kgService.addNode({ id: missionId, type: 'mission', label: mission.objective });\n    await this.kgService.addEdge({\n      source: mission.userId,\n      target: missionId,\n      relation: 'created',\n      weight: 1,\n    });\n\n    logger.info(`[Swarm] Mission ${missionId} graph nodes updated.`);\n  }\n}\n"],"version":3}