06edf11dfd4fd89a7fe3c8585dd7c350
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.addLog = addLog;
exports.getRecentLogs = getRecentLogs;
exports.clearLogs = clearLogs;
const response_builder_1 = require("../common/response-builder");
const Log_1 = __importDefault(require("../models/Log"));
/**
 * Add a log entry (Internal use)
 */
async function addLog(level, message, metadata, source = 'system') {
    try {
        const log = await Log_1.default.create({
            level,
            message,
            metadata,
            source,
            timestamp: new Date(),
        });
        return log;
    }
    catch (error) {
        console.error('Failed to write log to DB:', error);
        return null;
    }
}
/**
 * Get recent logs
 */
async function getRecentLogs(req, res) {
    try {
        const limit = parseInt(req.query.limit) || 100;
        const level = req.query.level || 'info';
        const source = req.query.source; // Keep this line from original
        const query = {};
        if (level) {
            query.level = level;
        }
        if (source) {
            query.source = source;
        }
        const logs = await Log_1.default.find(query).sort({ timestamp: -1 }).limit(limit);
        res.json((0, response_builder_1.buildResponse)(logs, 200, req.requestId));
    }
    catch (error) {
        console.error('Error getting logs:', error);
        res
            .status(500)
            .json((0, response_builder_1.buildError)('Failed to fetch logs', 'LOGS_ERROR', 500, req.requestId));
    }
}
/**
 * Clear logs (Admin only - ideally just drop collection or remove older)
 */
async function clearLogs(req, res) {
    try {
        await Log_1.default.deleteMany({});
        res.json({ success: true, message: 'Logs cleared' });
    }
    catch (error) {
        console.error('Error clearing logs:', error);
        res
            .status(500)
            .json((0, response_builder_1.buildError)('Failed to clear logs', 'LOGS_ERROR', 500, req.requestId));
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxjb250cm9sbGVyc1xcbG9ncy5jb250cm9sbGVyLnRzIiwibWFwcGluZ3MiOiI7Ozs7O0FBUUEsd0JBbUJDO0FBS0Qsc0NBdUJDO0FBS0QsOEJBVUM7QUFwRUQsaUVBQXVFO0FBQ3ZFLHdEQUFnQztBQUVoQzs7R0FFRztBQUNJLEtBQUssVUFBVSxNQUFNLENBQzFCLEtBQTBDLEVBQzFDLE9BQWUsRUFDZixRQUFjLEVBQ2QsTUFBTSxHQUFHLFFBQVE7SUFFakIsSUFBSSxDQUFDO1FBQ0gsTUFBTSxHQUFHLEdBQUcsTUFBTSxhQUFHLENBQUMsTUFBTSxDQUFDO1lBQzNCLEtBQUs7WUFDTCxPQUFPO1lBQ1AsUUFBUTtZQUNSLE1BQU07WUFDTixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUU7U0FDdEIsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxHQUFHLENBQUM7SUFDYixDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMsNEJBQTRCLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDbkQsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0FBQ0gsQ0FBQztBQUVEOztHQUVHO0FBQ0ksS0FBSyxVQUFVLGFBQWEsQ0FBQyxHQUFZLEVBQUUsR0FBYTtJQUM3RCxJQUFJLENBQUM7UUFDSCxNQUFNLEtBQUssR0FBRyxRQUFRLENBQUUsR0FBVyxDQUFDLEtBQUssQ0FBQyxLQUFlLENBQUMsSUFBSSxHQUFHLENBQUM7UUFDbEUsTUFBTSxLQUFLLEdBQUssR0FBVyxDQUFDLEtBQUssQ0FBQyxLQUFnQixJQUFJLE1BQU0sQ0FBQztRQUM3RCxNQUFNLE1BQU0sR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLE1BQWdCLENBQUMsQ0FBQywrQkFBK0I7UUFFMUUsTUFBTSxLQUFLLEdBQVEsRUFBRSxDQUFDO1FBQ3RCLElBQUksS0FBSyxFQUFFLENBQUM7WUFDVixLQUFLLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUN0QixDQUFDO1FBQ0QsSUFBSSxNQUFNLEVBQUUsQ0FBQztZQUNYLEtBQUssQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3hCLENBQUM7UUFFRCxNQUFNLElBQUksR0FBRyxNQUFNLGFBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFdkUsR0FBVyxDQUFDLElBQUksQ0FBQyxJQUFBLGdDQUFhLEVBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRyxHQUFXLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztJQUN0RSxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMscUJBQXFCLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDM0MsR0FBVzthQUNULE1BQU0sQ0FBQyxHQUFHLENBQUM7YUFDWCxJQUFJLENBQUMsSUFBQSw2QkFBVSxFQUFDLHNCQUFzQixFQUFFLFlBQVksRUFBRSxHQUFHLEVBQUcsR0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7SUFDekYsQ0FBQztBQUNILENBQUM7QUFFRDs7R0FFRztBQUNJLEtBQUssVUFBVSxTQUFTLENBQUMsR0FBWSxFQUFFLEdBQWE7SUFDekQsSUFBSSxDQUFDO1FBQ0gsTUFBTSxhQUFHLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3pCLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxjQUFjLEVBQUUsQ0FBQyxDQUFDO0lBQ3ZELENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyxzQkFBc0IsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUM1QyxHQUFXO2FBQ1QsTUFBTSxDQUFDLEdBQUcsQ0FBQzthQUNYLElBQUksQ0FBQyxJQUFBLDZCQUFVLEVBQUMsc0JBQXNCLEVBQUUsWUFBWSxFQUFFLEdBQUcsRUFBRyxHQUFXLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztJQUN6RixDQUFDO0FBQ0gsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXEFsZWphbmRyb1xcQUlHZXN0aW9uXFxiYWNrZW5kXFxzcmNcXGNvbnRyb2xsZXJzXFxsb2dzLmNvbnRyb2xsZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBSZXF1ZXN0LCBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnO1xuXG5pbXBvcnQgeyBidWlsZEVycm9yLCBidWlsZFJlc3BvbnNlIH0gZnJvbSAnLi4vY29tbW9uL3Jlc3BvbnNlLWJ1aWxkZXInO1xuaW1wb3J0IExvZyBmcm9tICcuLi9tb2RlbHMvTG9nJztcblxuLyoqXG4gKiBBZGQgYSBsb2cgZW50cnkgKEludGVybmFsIHVzZSlcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGFkZExvZyhcbiAgbGV2ZWw6ICdpbmZvJyB8ICd3YXJuJyB8ICdlcnJvcicgfCAnZGVidWcnLFxuICBtZXNzYWdlOiBzdHJpbmcsXG4gIG1ldGFkYXRhPzogYW55LFxuICBzb3VyY2UgPSAnc3lzdGVtJyxcbikge1xuICB0cnkge1xuICAgIGNvbnN0IGxvZyA9IGF3YWl0IExvZy5jcmVhdGUoe1xuICAgICAgbGV2ZWwsXG4gICAgICBtZXNzYWdlLFxuICAgICAgbWV0YWRhdGEsXG4gICAgICBzb3VyY2UsXG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgfSk7XG4gICAgcmV0dXJuIGxvZztcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gd3JpdGUgbG9nIHRvIERCOicsIGVycm9yKTtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxufVxuXG4vKipcbiAqIEdldCByZWNlbnQgbG9nc1xuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0UmVjZW50TG9ncyhyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpIHtcbiAgdHJ5IHtcbiAgICBjb25zdCBsaW1pdCA9IHBhcnNlSW50KChyZXEgYXMgYW55KS5xdWVyeS5saW1pdCBhcyBzdHJpbmcpIHx8IDEwMDtcbiAgICBjb25zdCBsZXZlbCA9ICgocmVxIGFzIGFueSkucXVlcnkubGV2ZWwgYXMgc3RyaW5nKSB8fCAnaW5mbyc7XG4gICAgY29uc3Qgc291cmNlID0gcmVxLnF1ZXJ5LnNvdXJjZSBhcyBzdHJpbmc7IC8vIEtlZXAgdGhpcyBsaW5lIGZyb20gb3JpZ2luYWxcblxuICAgIGNvbnN0IHF1ZXJ5OiBhbnkgPSB7fTtcbiAgICBpZiAobGV2ZWwpIHtcbiAgICAgIHF1ZXJ5LmxldmVsID0gbGV2ZWw7XG4gICAgfVxuICAgIGlmIChzb3VyY2UpIHtcbiAgICAgIHF1ZXJ5LnNvdXJjZSA9IHNvdXJjZTtcbiAgICB9XG5cbiAgICBjb25zdCBsb2dzID0gYXdhaXQgTG9nLmZpbmQocXVlcnkpLnNvcnQoeyB0aW1lc3RhbXA6IC0xIH0pLmxpbWl0KGxpbWl0KTtcblxuICAgIChyZXMgYXMgYW55KS5qc29uKGJ1aWxkUmVzcG9uc2UobG9ncywgMjAwLCAocmVxIGFzIGFueSkucmVxdWVzdElkKSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgZ2V0dGluZyBsb2dzOicsIGVycm9yKTtcbiAgICAocmVzIGFzIGFueSlcbiAgICAgIC5zdGF0dXMoNTAwKVxuICAgICAgLmpzb24oYnVpbGRFcnJvcignRmFpbGVkIHRvIGZldGNoIGxvZ3MnLCAnTE9HU19FUlJPUicsIDUwMCwgKHJlcSBhcyBhbnkpLnJlcXVlc3RJZCkpO1xuICB9XG59XG5cbi8qKlxuICogQ2xlYXIgbG9ncyAoQWRtaW4gb25seSAtIGlkZWFsbHkganVzdCBkcm9wIGNvbGxlY3Rpb24gb3IgcmVtb3ZlIG9sZGVyKVxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY2xlYXJMb2dzKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkge1xuICB0cnkge1xuICAgIGF3YWl0IExvZy5kZWxldGVNYW55KHt9KTtcbiAgICByZXMuanNvbih7IHN1Y2Nlc3M6IHRydWUsIG1lc3NhZ2U6ICdMb2dzIGNsZWFyZWQnIH0pO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGNsZWFyaW5nIGxvZ3M6JywgZXJyb3IpO1xuICAgIChyZXMgYXMgYW55KVxuICAgICAgLnN0YXR1cyg1MDApXG4gICAgICAuanNvbihidWlsZEVycm9yKCdGYWlsZWQgdG8gY2xlYXIgbG9ncycsICdMT0dTX0VSUk9SJywgNTAwLCAocmVxIGFzIGFueSkucmVxdWVzdElkKSk7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==