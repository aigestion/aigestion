{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\whatsapp.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\whatsapp.service.ts"],"sourcesContent":["import axios from 'axios';\nimport { injectable } from 'inversify';\nimport { env } from '../config/env.schema';\nimport { logger } from '../utils/logger';\n\n@injectable()\nexport class WhatsAppService {\n  private readonly baseUrl = env.WHATSAPP_API_URL || 'https://graph.facebook.com/v19.0';\n\n  /**\n   * Send a WhatsApp message using the Business API\n   */\n  async sendMessage(to: string, message: string): Promise<any> {\n    const phoneId = env.WHATSAPP_BUSINESS_PHONE_ID;\n    const token = env.WHATSAPP_TOKEN || env.FACEBOOK_PAGE_ACCESS_TOKEN || env.META_ACCESS_TOKEN;\n\n    if (!phoneId || !token) {\n      throw new Error('WhatsApp Business Phone ID or Token not configured');\n    }\n\n    try {\n      const response = await axios.post(\n        `${this.baseUrl}/${phoneId}/messages`,\n        {\n          messaging_product: 'whatsapp',\n          to: to,\n          type: 'text',\n          text: { body: message },\n        },\n        {\n          headers: {\n            Authorization: `Bearer ${token}`,\n            'Content-Type': 'application/json',\n          },\n        },\n      );\n\n      logger.info(`WhatsApp message sent to ${to}: ${response.data.messages[0].id}`);\n      return response.data;\n    } catch (error: any) {\n      logger.error(\n        { error: error.response?.data || error.message },\n        'Error sending WhatsApp message',\n      );\n      throw error;\n    }\n  }\n\n  /**\n   * Send a template message (required for initiating conversations)\n   */\n  async sendTemplate(to: string, templateName: string, languageCode: string = 'es'): Promise<any> {\n    const phoneId = env.WHATSAPP_BUSINESS_PHONE_ID;\n    const token = env.WHATSAPP_TOKEN || env.FACEBOOK_PAGE_ACCESS_TOKEN || env.META_ACCESS_TOKEN;\n\n    if (!phoneId || !token) {\n      throw new Error('WhatsApp Business Phone ID or Token not configured');\n    }\n\n    try {\n      const response = await axios.post(\n        `${this.baseUrl}/${phoneId}/messages`,\n        {\n          messaging_product: 'whatsapp',\n          to: to,\n          type: 'template',\n          template: {\n            name: templateName,\n            language: { code: languageCode },\n          },\n        },\n        {\n          headers: {\n            Authorization: `Bearer ${token}`,\n            'Content-Type': 'application/json',\n          },\n        },\n      );\n\n      logger.info(`WhatsApp template sent to ${to}: ${response.data.messages[0].id}`);\n      return response.data;\n    } catch (error: any) {\n      logger.error(\n        { error: error.response?.data || error.message },\n        'Error sending WhatsApp template',\n      );\n      throw error;\n    }\n  }\n}\n"],"version":3}