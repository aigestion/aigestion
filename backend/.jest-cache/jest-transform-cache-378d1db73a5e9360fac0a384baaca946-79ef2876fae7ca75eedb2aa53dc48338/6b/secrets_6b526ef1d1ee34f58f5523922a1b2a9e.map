{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\utils\\secrets.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\utils\\secrets.ts"],"sourcesContent":["import { SecretManagerServiceClient } from '@google-cloud/secret-manager';\nimport { hkdf } from 'node:crypto';\nimport { promisify } from 'node:util';\nimport { logger } from './logger';\n\nconst hkdfAsync = promisify(hkdf);\n\nexport async function loadSecrets(): Promise<void> {\n  // Only fetching secrets in production or if explicitly enabled\n  // We skip if we are in CI/CD (GITHUB_ACTIONS) unless specifically required\n  if (process.env.NODE_ENV !== 'production' && process.env.ENABLE_GCP_SECRETS !== 'true') {\n    logger.info('Skipping Google Secret Manager (Dev mode)');\n    return;\n  }\n\n  if (!process.env.GOOGLE_CLOUD_PROJECT_ID) {\n    logger.warn('Skipping Secret Manager: GOOGLE_CLOUD_PROJECT_ID not set');\n    return;\n  }\n\n  const client = new SecretManagerServiceClient();\n  const projectId = process.env.GOOGLE_CLOUD_PROJECT_ID;\n\n  // List of critical secrets to fetch\n  // Add new secrets here as needed\n  const secretNames = [\n    'MONGODB_URI',\n    'GEMINI_API_KEY',\n    'MONGO_ROOT_PASSWORD',\n    'JWT_SECRET',\n    'STRIPE_SECRET_KEY',\n    'STRIPE_WEBHOOK_SECRET',\n    'ML_SERVICE_API_KEY',\n  ];\n\n  logger.info(`Fetching ${secretNames.length} secrets from GCP Secret Manager...`);\n\n  const results = await Promise.allSettled(\n    secretNames.map(async name => {\n      try {\n        const [version] = await client.accessSecretVersion({\n          name: `projects/${projectId}/secrets/${name}/versions/latest`,\n        });\n        const payload = version.payload?.data?.toString();\n        if (payload) {\n          process.env[name] = payload;\n          return name;\n        } else {\n          throw new Error('Empty payload');\n        }\n      } catch (err: any) {\n        // Don't crash, just log warning. Some secrets might not exist yet.\n        // We throw so Promise.allSettled marks as rejected\n        throw new Error(`Failed to fetch ${name}: ${err.message}`);\n      }\n    }),\n  );\n\n  const loaded = results.filter(r => r.status === 'fulfilled').map((r: any) => r.value);\n  const failed = results.filter(r => r.status === 'rejected').map((r: any) => r.reason.message);\n\n  if (loaded.length > 0) {\n    logger.info(`✅ Successfully loaded secrets: ${loaded.join(', ')}`);\n  }\n  if (failed.length > 0) {\n    // We log warnings but don't crash - let env.schema validation catch missing required envs later\n    logger.warn(`⚠️  Failed to load some secrets:\\n${failed.join('\\n')}`);\n  }\n}\n\n/**\n * Derives a mission-specific sub-key from a Master Sovereign Seed using HKDF.\n * This ensures that even if one mission key is compromised, others remain secure.\n */\nexport async function deriveMissionKey(\n  masterSeed: string,\n  missionId: string,\n  userId: string,\n): Promise<Buffer> {\n  const salt = Buffer.from(userId);\n  const info = `AIG_SOVEREIGN_MISSION_${missionId}`;\n  const keyLength = 32; // AES-256\n\n  try {\n    const derivedKey = await hkdfAsync(\n      'sha256',\n      Buffer.from(masterSeed),\n      salt,\n      Buffer.from(info),\n      keyLength,\n    );\n    return Buffer.from(derivedKey);\n  } catch (error) {\n    logger.error('[Secrets] HKDF derivation failed:', error);\n    throw new Error('Failed to derive Sovereign mission key');\n  }\n}\n"],"version":3}