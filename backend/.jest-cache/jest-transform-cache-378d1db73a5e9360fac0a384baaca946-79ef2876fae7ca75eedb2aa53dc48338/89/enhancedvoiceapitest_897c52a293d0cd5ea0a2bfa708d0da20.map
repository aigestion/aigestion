{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\__tests__\\integration\\enhanced-voice.api.test.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\__tests__\\integration\\enhanced-voice.api.test.ts"],"sourcesContent":["import request from 'supertest';\nimport { app } from '../../app';\nimport { container } from '../../config/inversify.config';\nimport { EnhancedVoiceService } from '../../services/enhanced-voice.service';\nimport { RateLimitService } from '../../services/rate-limit.service';\nimport { TYPES } from '../../types';\nimport jwt from 'jsonwebtoken';\nimport { config } from '../../config/config';\nimport { User } from '../../models/User';\n\n// Mock the services\njest.mock('../../services/enhanced-voice.service');\njest.mock('../../services/rate-limit.service');\n\nconst SKIP_INTEGRATION = process.env.NODE_ENV === 'test' && !process.env.RUN_INTEGRATION_TESTS;\n\n(SKIP_INTEGRATION ? describe.skip : describe)('Enhanced Voice API Integration Tests', () => {\n  let mockEnhancedVoiceService: jest.Mocked<EnhancedVoiceService>;\n  let mockRateLimitService: jest.Mocked<RateLimitService>;\n  let authToken: string;\n\n  beforeAll(async () => {\n    // Generate valid JWT token for testing\n    const testUser = {\n      _id: '65c2a1b1e4b0a1b1e4b0a1b1',\n      id: '65c2a1b1e4b0a1b1e4b0a1b1',\n      email: 'test@example.com',\n      role: 'user',\n      tokenVersion: 0,\n      lastPasswordChange: new Date(Date.now() - 1000000), // In the past\n    };\n\n    authToken = `Bearer ${jwt.sign(\n      {\n        id: testUser.id,\n        email: testUser.email,\n        role: testUser.role,\n        tokenVersion: testUser.tokenVersion,\n      },\n      config.jwt.secret,\n      { expiresIn: '1h' },\n    )}`;\n\n    // Mock User.findById for middleware\n    jest.spyOn(User, 'findById').mockReturnValue({\n      select: jest.fn().mockResolvedValue(testUser as any),\n    } as any);\n\n    // Get mock services\n    mockEnhancedVoiceService = {\n      processConversation: jest.fn(),\n      getConversationHistory: jest.fn(),\n      clearConversation: jest.fn(),\n    } as any;\n\n    mockRateLimitService = {\n      incrementAndCheck: jest.fn().mockResolvedValue(undefined),\n      reset: jest.fn().mockResolvedValue(undefined),\n    } as any;\n\n    // Replace services in container\n    container.rebind(TYPES.EnhancedVoiceService).toConstantValue(mockEnhancedVoiceService);\n    container.rebind(TYPES.RateLimitService).toConstantValue(mockRateLimitService);\n  });\n\n  beforeEach(() => {\n    jest.clearAllMocks();\n  });\n\n  describe('POST /api/v1/enhanced-voice/process', () => {\n    const validPayload = {\n      sessionId: 'test_session_123',\n      userId: 'test_user_456',\n      text: 'Hola Daniela, ¿cómo estás?',\n    };\n\n    it('should process text conversation successfully', async () => {\n      const mockResponse = {\n        transcription: 'Hola Daniela, ¿cómo estás?',\n        response: '¡Hola! Estoy excelente, gracias por preguntar.',\n        suggestedActions: [],\n        context: {\n          messages: [],\n          emotionalHistory: [],\n          clientProfile: {\n            preferences: [],\n            previousTopics: [],\n            interactionStyle: 'professional',\n          },\n        },\n      };\n\n      mockEnhancedVoiceService.processConversation.mockResolvedValue(mockResponse);\n\n      const response = await request(app)\n        .post('/api/v1/enhanced-voice/process')\n        .set('Authorization', authToken)\n        .send(validPayload)\n        .expect(200);\n\n      expect(response.body.status).toBe(200);\n      expect(response.body.data).toEqual(mockResponse);\n      expect(response.body).toHaveProperty('requestId');\n    });\n\n    it('should process audio conversation successfully', async () => {\n      const audioPayload = {\n        ...validPayload,\n        audio: 'base64_encoded_audio_data',\n        text: undefined,\n      };\n\n      const mockResponse = {\n        transcription: 'Audio transcrito',\n        response: 'Entendido',\n        audioResponse: Buffer.from('audio_data'),\n        suggestedActions: [],\n        context: {\n          messages: [],\n          emotionalHistory: [],\n          clientProfile: {\n            preferences: [],\n            previousTopics: [],\n            interactionStyle: 'professional',\n          },\n        },\n      };\n\n      mockEnhancedVoiceService.processConversation.mockResolvedValue(mockResponse);\n\n      const response = await request(app)\n        .post('/api/v1/enhanced-voice/process')\n        .set('Authorization', authToken)\n        .send(audioPayload)\n        .expect(200);\n\n      expect(response.body.status).toBe(200);\n      expect(response.body.data.audioResponse).toBe(Buffer.from('audio_data').toString('base64'));\n    });\n\n    it('should return 401 for missing authorization', async () => {\n      await request(app)\n        .post('/api/v1/enhanced-voice/process')\n        .send(validPayload)\n        .expect(401);\n    });\n\n    it('should return 400 for invalid payload', async () => {\n      await request(app)\n        .post('/api/v1/enhanced-voice/process')\n        .set('Authorization', authToken)\n        .send({ sessionId: '' })\n        .expect(400);\n    });\n  });\n\n  describe('GET /api/v1/enhanced-voice/history', () => {\n    it('should retrieve history', async () => {\n      mockEnhancedVoiceService.getConversationHistory.mockResolvedValue({ messages: [] });\n\n      const response = await request(app)\n        .get('/api/v1/enhanced-voice/history?sessionId=123')\n        .set('Authorization', authToken)\n        .expect(200);\n\n      expect(response.body.status).toBe(200);\n    });\n  });\n\n  describe('POST /api/v1/enhanced-voice/clear', () => {\n    it('should clear session', async () => {\n      mockEnhancedVoiceService.clearConversation.mockResolvedValue(undefined);\n\n      const response = await request(app)\n        .post('/api/v1/enhanced-voice/clear')\n        .set('Authorization', authToken)\n        .send({ sessionId: '123' })\n        .expect(200);\n\n      expect(response.body.status).toBe(200);\n    });\n  });\n});\n"],"version":3}