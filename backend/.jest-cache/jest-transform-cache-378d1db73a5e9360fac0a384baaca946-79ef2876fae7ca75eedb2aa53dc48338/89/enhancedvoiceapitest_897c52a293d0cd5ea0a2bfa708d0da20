8b0032298be2ab309e36085a22f3ed2c
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
// Mock the services
jest.mock('../../services/enhanced-voice.service');
jest.mock('../../services/rate-limit.service');
const supertest_1 = __importDefault(require("supertest"));
const app_1 = require("../../app");
const inversify_config_1 = require("../../config/inversify.config");
const types_1 = require("../../types");
const jsonwebtoken_1 = __importDefault(require("jsonwebtoken"));
const config_1 = require("../../config/config");
const User_1 = require("../../models/User");
const SKIP_INTEGRATION = process.env.NODE_ENV === 'test' && !process.env.RUN_INTEGRATION_TESTS;
(SKIP_INTEGRATION ? describe.skip : describe)('Enhanced Voice API Integration Tests', () => {
    let mockEnhancedVoiceService;
    let mockRateLimitService;
    let authToken;
    beforeAll(async () => {
        // Generate valid JWT token for testing
        const testUser = {
            _id: '65c2a1b1e4b0a1b1e4b0a1b1',
            id: '65c2a1b1e4b0a1b1e4b0a1b1',
            email: 'test@example.com',
            role: 'user',
            tokenVersion: 0,
            lastPasswordChange: new Date(Date.now() - 1000000), // In the past
        };
        authToken = `Bearer ${jsonwebtoken_1.default.sign({
            id: testUser.id,
            email: testUser.email,
            role: testUser.role,
            tokenVersion: testUser.tokenVersion,
        }, config_1.config.jwt.secret, { expiresIn: '1h' })}`;
        // Mock User.findById for middleware
        jest.spyOn(User_1.User, 'findById').mockReturnValue({
            select: jest.fn().mockResolvedValue(testUser),
        });
        // Get mock services
        mockEnhancedVoiceService = {
            processConversation: jest.fn(),
            getConversationHistory: jest.fn(),
            clearConversation: jest.fn(),
        };
        mockRateLimitService = {
            incrementAndCheck: jest.fn().mockResolvedValue(undefined),
            reset: jest.fn().mockResolvedValue(undefined),
        };
        // Replace services in container
        inversify_config_1.container.rebind(types_1.TYPES.EnhancedVoiceService).toConstantValue(mockEnhancedVoiceService);
        inversify_config_1.container.rebind(types_1.TYPES.RateLimitService).toConstantValue(mockRateLimitService);
    });
    beforeEach(() => {
        jest.clearAllMocks();
    });
    describe('POST /api/v1/enhanced-voice/process', () => {
        const validPayload = {
            sessionId: 'test_session_123',
            userId: 'test_user_456',
            text: 'Hola Daniela, ¿cómo estás?',
        };
        it('should process text conversation successfully', async () => {
            const mockResponse = {
                transcription: 'Hola Daniela, ¿cómo estás?',
                response: '¡Hola! Estoy excelente, gracias por preguntar.',
                suggestedActions: [],
                context: {
                    messages: [],
                    emotionalHistory: [],
                    clientProfile: {
                        preferences: [],
                        previousTopics: [],
                        interactionStyle: 'professional',
                    },
                },
            };
            mockEnhancedVoiceService.processConversation.mockResolvedValue(mockResponse);
            const response = await (0, supertest_1.default)(app_1.app)
                .post('/api/v1/enhanced-voice/process')
                .set('Authorization', authToken)
                .send(validPayload)
                .expect(200);
            expect(response.body.status).toBe(200);
            expect(response.body.data).toEqual(mockResponse);
            expect(response.body).toHaveProperty('requestId');
        });
        it('should process audio conversation successfully', async () => {
            const audioPayload = {
                ...validPayload,
                audio: 'base64_encoded_audio_data',
                text: undefined,
            };
            const mockResponse = {
                transcription: 'Audio transcrito',
                response: 'Entendido',
                audioResponse: Buffer.from('audio_data'),
                suggestedActions: [],
                context: {
                    messages: [],
                    emotionalHistory: [],
                    clientProfile: {
                        preferences: [],
                        previousTopics: [],
                        interactionStyle: 'professional',
                    },
                },
            };
            mockEnhancedVoiceService.processConversation.mockResolvedValue(mockResponse);
            const response = await (0, supertest_1.default)(app_1.app)
                .post('/api/v1/enhanced-voice/process')
                .set('Authorization', authToken)
                .send(audioPayload)
                .expect(200);
            expect(response.body.status).toBe(200);
            expect(response.body.data.audioResponse).toBe(Buffer.from('audio_data').toString('base64'));
        });
        it('should return 401 for missing authorization', async () => {
            await (0, supertest_1.default)(app_1.app)
                .post('/api/v1/enhanced-voice/process')
                .send(validPayload)
                .expect(401);
        });
        it('should return 400 for invalid payload', async () => {
            await (0, supertest_1.default)(app_1.app)
                .post('/api/v1/enhanced-voice/process')
                .set('Authorization', authToken)
                .send({ sessionId: '' })
                .expect(400);
        });
    });
    describe('GET /api/v1/enhanced-voice/history', () => {
        it('should retrieve history', async () => {
            mockEnhancedVoiceService.getConversationHistory.mockResolvedValue({ messages: [] });
            const response = await (0, supertest_1.default)(app_1.app)
                .get('/api/v1/enhanced-voice/history?sessionId=123')
                .set('Authorization', authToken)
                .expect(200);
            expect(response.body.status).toBe(200);
        });
    });
    describe('POST /api/v1/enhanced-voice/clear', () => {
        it('should clear session', async () => {
            mockEnhancedVoiceService.clearConversation.mockResolvedValue(undefined);
            const response = await (0, supertest_1.default)(app_1.app)
                .post('/api/v1/enhanced-voice/clear')
                .set('Authorization', authToken)
                .send({ sessionId: '123' })
                .expect(200);
            expect(response.body.status).toBe(200);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxfX3Rlc3RzX19cXGludGVncmF0aW9uXFxlbmhhbmNlZC12b2ljZS5hcGkudGVzdC50cyIsIm1hcHBpbmdzIjoiOzs7OztBQVVBLG9CQUFvQjtBQUNwQixJQUFJLENBQUMsSUFBSSxDQUFDLHVDQUF1QyxDQUFDLENBQUM7QUFDbkQsSUFBSSxDQUFDLElBQUksQ0FBQyxtQ0FBbUMsQ0FBQyxDQUFDO0FBWi9DLDBEQUFnQztBQUNoQyxtQ0FBZ0M7QUFDaEMsb0VBQTBEO0FBRzFELHVDQUFvQztBQUNwQyxnRUFBK0I7QUFDL0IsZ0RBQTZDO0FBQzdDLDRDQUF5QztBQU16QyxNQUFNLGdCQUFnQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxLQUFLLE1BQU0sSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMscUJBQXFCLENBQUM7QUFFL0YsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsc0NBQXNDLEVBQUUsR0FBRyxFQUFFO0lBQ3pGLElBQUksd0JBQTJELENBQUM7SUFDaEUsSUFBSSxvQkFBbUQsQ0FBQztJQUN4RCxJQUFJLFNBQWlCLENBQUM7SUFFdEIsU0FBUyxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ25CLHVDQUF1QztRQUN2QyxNQUFNLFFBQVEsR0FBRztZQUNmLEdBQUcsRUFBRSwwQkFBMEI7WUFDL0IsRUFBRSxFQUFFLDBCQUEwQjtZQUM5QixLQUFLLEVBQUUsa0JBQWtCO1lBQ3pCLElBQUksRUFBRSxNQUFNO1lBQ1osWUFBWSxFQUFFLENBQUM7WUFDZixrQkFBa0IsRUFBRSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsT0FBTyxDQUFDLEVBQUUsY0FBYztTQUNuRSxDQUFDO1FBRUYsU0FBUyxHQUFHLFVBQVUsc0JBQUcsQ0FBQyxJQUFJLENBQzVCO1lBQ0UsRUFBRSxFQUFF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QUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLG1DQUFtQyxFQUFFLEdBQUcsRUFBRTtRQUNqRCxFQUFFLENBQUMsc0JBQXNCLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDcEMsd0JBQXdCLENBQUMsaUJBQWlCLENBQUMsaUJBQWlCLENBQUMsU0FBUyxDQUFDLENBQUM7WUFFeEUsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFBLG1CQUFPLEVBQUMsU0FBRyxDQUFDO2lCQUNoQyxJQUFJLENBQUMsOEJBQThCLENBQUM7aUJBQ3BDLEdBQUcsQ0FBQyxlQUFlLEVBQUUsU0FBUyxDQUFDO2lCQUMvQixJQUFJLENBQUMsRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLENBQUM7aUJBQzFCLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUVmLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN6QyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxfX3Rlc3RzX19cXGludGVncmF0aW9uXFxlbmhhbmNlZC12b2ljZS5hcGkudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcmVxdWVzdCBmcm9tICdzdXBlcnRlc3QnO1xuaW1wb3J0IHsgYXBwIH0gZnJvbSAnLi4vLi4vYXBwJztcbmltcG9ydCB7IGNvbnRhaW5lciB9IGZyb20gJy4uLy4uL2NvbmZpZy9pbnZlcnNpZnkuY29uZmlnJztcbmltcG9ydCB7IEVuaGFuY2VkVm9pY2VTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvZW5oYW5jZWQtdm9pY2Uuc2VydmljZSc7XG5pbXBvcnQgeyBSYXRlTGltaXRTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvcmF0ZS1saW1pdC5zZXJ2aWNlJztcbmltcG9ydCB7IFRZUEVTIH0gZnJvbSAnLi4vLi4vdHlwZXMnO1xuaW1wb3J0IGp3dCBmcm9tICdqc29ud2VidG9rZW4nO1xuaW1wb3J0IHsgY29uZmlnIH0gZnJvbSAnLi4vLi4vY29uZmlnL2NvbmZpZyc7XG5pbXBvcnQgeyBVc2VyIH0gZnJvbSAnLi4vLi4vbW9kZWxzL1VzZXInO1xuXG4vLyBNb2NrIHRoZSBzZXJ2aWNlc1xuamVzdC5tb2NrKCcuLi8uLi9zZXJ2aWNlcy9lbmhhbmNlZC12b2ljZS5zZXJ2aWNlJyk7XG5qZXN0Lm1vY2soJy4uLy4uL3NlcnZpY2VzL3JhdGUtbGltaXQuc2VydmljZScpO1xuXG5jb25zdCBTS0lQX0lOVEVHUkFUSU9OID0gcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICd0ZXN0JyAmJiAhcHJvY2Vzcy5lbnYuUlVOX0lOVEVHUkFUSU9OX1RFU1RTO1xuXG4oU0tJUF9JTlRFR1JBVElPTiA/IGRlc2NyaWJlLnNraXAgOiBkZXNjcmliZSkoJ0VuaGFuY2VkIFZvaWNlIEFQSSBJbnRlZ3JhdGlvbiBUZXN0cycsICgpID0+IHtcbiAgbGV0IG1vY2tFbmhhbmNlZFZvaWNlU2VydmljZTogamVzdC5Nb2NrZWQ8RW5oYW5jZWRWb2ljZVNlcnZpY2U+O1xuICBsZXQgbW9ja1JhdGVMaW1pdFNlcnZpY2U6IGplc3QuTW9ja2VkPFJhdGVMaW1pdFNlcnZpY2U+O1xuICBsZXQgYXV0aFRva2VuOiBzdHJpbmc7XG5cbiAgYmVmb3JlQWxsKGFzeW5jICgpID0+IHtcbiAgICAvLyBHZW5lcmF0ZSB2YWxpZCBKV1QgdG9rZW4gZm9yIHRlc3RpbmdcbiAgICBjb25zdCB0ZXN0VXNlciA9IHtcbiAgICAgIF9pZDogJzY1YzJhMWIxZTRiMGExYjFlNGIwYTFiMScsXG4gICAgICBpZDogJzY1YzJhMWIxZTRiMGExYjFlNGIwYTFiMScsXG4gICAgICBlbWFpbDogJ3Rlc3RAZXhhbXBsZS5jb20nLFxuICAgICAgcm9sZTogJ3VzZXInLFxuICAgICAgdG9rZW5WZXJzaW9uOiAwLFxuICAgICAgbGFzdFBhc3N3b3JkQ2hhbmdlOiBuZXcgRGF0ZShEYXRlLm5vdygpIC0gMTAwMDAwMCksIC8vIEluIHRoZSBwYXN0XG4gICAgfTtcblxuICAgIGF1dGhUb2tlbiA9IGBCZWFyZXIgJHtqd3Quc2lnbihcbiAgICAgIHtcbiAgICAgICAgaWQ6IHRlc3RVc2VyLmlkLFxuICAgICAgICBlbWFpbDogdGVzdFVzZXIuZW1haWwsXG4gICAgICAgIHJvbGU6IHRlc3RVc2VyLnJvbGUsXG4gICAgICAgIHRva2VuVmVyc2lvbjogdGVzdFVzZXIudG9rZW5WZXJzaW9uLFxuICAgICAgfSxcbiAgICAgIGNvbmZpZy5qd3Quc2VjcmV0LFxuICAgICAgeyBleHBpcmVzSW46ICcxaCcgfSxcbiAgICApfWA7XG5cbiAgICAvLyBNb2NrIFVzZXIuZmluZEJ5SWQgZm9yIG1pZGRsZXdhcmVcbiAgICBqZXN0LnNweU9uKFVzZXIsICdmaW5kQnlJZCcpLm1vY2tSZXR1cm5WYWx1ZSh7XG4gICAgICBzZWxlY3Q6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh0ZXN0VXNlciBhcyBhbnkpLFxuICAgIH0gYXMgYW55KTtcblxuICAgIC8vIEdldCBtb2NrIHNlcnZpY2VzXG4gICAgbW9ja0VuaGFuY2VkVm9pY2VTZXJ2aWNlID0ge1xuICAgICAgcHJvY2Vzc0NvbnZlcnNhdGlvbjogamVzdC5mbigpLFxuICAgICAgZ2V0Q29udmVyc2F0aW9uSGlzdG9yeTogamVzdC5mbigpLFxuICAgICAgY2xlYXJDb252ZXJzYXRpb246IGplc3QuZm4oKSxcbiAgICB9IGFzIGFueTtcblxuICAgIG1vY2tSYXRlTGltaXRTZXJ2aWNlID0ge1xuICAgICAgaW5jcmVtZW50QW5kQ2hlY2s6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpLFxuICAgICAgcmVzZXQ6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpLFxuICAgIH0gYXMgYW55O1xuXG4gICAgLy8gUmVwbGFjZSBzZXJ2aWNlcyBpbiBjb250YWluZXJcbiAgICBjb250YWluZXIucmViaW5kKFRZUEVTLkVuaGFuY2VkVm9pY2VTZXJ2aWNlKS50b0NvbnN0YW50VmFsdWUobW9ja0VuaGFuY2VkVm9pY2VTZXJ2aWNlKTtcbiAgICBjb250YWluZXIucmViaW5kKFRZUEVTLlJhdGVMaW1pdFNlcnZpY2UpLnRvQ29uc3RhbnRWYWx1ZShtb2NrUmF0ZUxpbWl0U2VydmljZSk7XG4gIH0pO1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xuICB9KTtcblxuICBkZXNjcmliZSgnUE9TVCAvYXBpL3YxL2VuaGFuY2VkLXZvaWNlL3Byb2Nlc3MnLCAoKSA9PiB7XG4gICAgY29uc3QgdmFsaWRQYXlsb2FkID0ge1xuICAgICAgc2Vzc2lvbklkOiAndGVzdF9zZXNzaW9uXzEyMycsXG4gICAgICB1c2VySWQ6ICd0ZXN0X3VzZXJfNDU2JyxcbiAgICAgIHRleHQ6ICdIb2xhIERhbmllbGEsIMK/Y8OzbW8gZXN0w6FzPycsXG4gICAgfTtcblxuICAgIGl0KCdzaG91bGQgcHJvY2VzcyB0ZXh0IGNvbnZlcnNhdGlvbiBzdWNjZXNzZnVsbHknLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBtb2NrUmVzcG9uc2UgPSB7XG4gICAgICAgIHRyYW5zY3JpcHRpb246ICdIb2xhIERhbmllbGEsIMK/Y8OzbW8gZXN0w6FzPycsXG4gICAgICAgIHJlc3BvbnNlOiAnwqFIb2xhISBFc3RveSBleGNlbGVudGUsIGdyYWNpYXMgcG9yIHByZWd1bnRhci4nLFxuICAgICAgICBzdWdnZXN0ZWRBY3Rpb25zOiBbXSxcbiAgICAgICAgY29udGV4dDoge1xuICAgICAgICAgIG1lc3NhZ2VzOiBbXSxcbiAgICAgICAgICBlbW90aW9uYWxIaXN0b3J5OiBbXSxcbiAgICAgICAgICBjbGllbnRQcm9maWxlOiB7XG4gICAgICAgICAgICBwcmVmZXJlbmNlczogW10sXG4gICAgICAgICAgICBwcmV2aW91c1RvcGljczogW10sXG4gICAgICAgICAgICBpbnRlcmFjdGlvblN0eWxlOiAncHJvZmVzc2lvbmFsJyxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfTtcblxuICAgICAgbW9ja0VuaGFuY2VkVm9pY2VTZXJ2aWNlLnByb2Nlc3NDb252ZXJzYXRpb24ubW9ja1Jlc29sdmVkVmFsdWUobW9ja1Jlc3BvbnNlKTtcblxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLnBvc3QoJy9hcGkvdjEvZW5oYW5jZWQtdm9pY2UvcHJvY2VzcycpXG4gICAgICAgIC5zZXQoJ0F1dGhvcml6YXRpb24nLCBhdXRoVG9rZW4pXG4gICAgICAgIC5zZW5kKHZhbGlkUGF5bG9hZClcbiAgICAgICAgLmV4cGVjdCgyMDApO1xuXG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5zdGF0dXMpLnRvQmUoMjAwKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5LmRhdGEpLnRvRXF1YWwobW9ja1Jlc3BvbnNlKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5KS50b0hhdmVQcm9wZXJ0eSgncmVxdWVzdElkJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHByb2Nlc3MgYXVkaW8gY29udmVyc2F0aW9uIHN1Y2Nlc3NmdWxseScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGF1ZGlvUGF5bG9hZCA9IHtcbiAgICAgICAgLi4udmFsaWRQYXlsb2FkLFxuICAgICAgICBhdWRpbzogJ2Jhc2U2NF9lbmNvZGVkX2F1ZGlvX2RhdGEnLFxuICAgICAgICB0ZXh0OiB1bmRlZmluZWQsXG4gICAgICB9O1xuXG4gICAgICBjb25zdCBtb2NrUmVzcG9uc2UgPSB7XG4gICAgICAgIHRyYW5zY3JpcHRpb246ICdBdWRpbyB0cmFuc2NyaXRvJyxcbiAgICAgICAgcmVzcG9uc2U6ICdFbnRlbmRpZG8nLFxuICAgICAgICBhdWRpb1Jlc3BvbnNlOiBCdWZmZXIuZnJvbSgnYXVkaW9fZGF0YScpLFxuICAgICAgICBzdWdnZXN0ZWRBY3Rpb25zOiBbXSxcbiAgICAgICAgY29udGV4dDoge1xuICAgICAgICAgIG1lc3NhZ2VzOiBbXSxcbiAgICAgICAgICBlbW90aW9uYWxIaXN0b3J5OiBbXSxcbiAgICAgICAgICBjbGllbnRQcm9maWxlOiB7XG4gICAgICAgICAgICBwcmVmZXJlbmNlczogW10sXG4gICAgICAgICAgICBwcmV2aW91c1RvcGljczogW10sXG4gICAgICAgICAgICBpbnRlcmFjdGlvblN0eWxlOiAncHJvZmVzc2lvbmFsJyxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfTtcblxuICAgICAgbW9ja0VuaGFuY2VkVm9pY2VTZXJ2aWNlLnByb2Nlc3NDb252ZXJzYXRpb24ubW9ja1Jlc29sdmVkVmFsdWUobW9ja1Jlc3BvbnNlKTtcblxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLnBvc3QoJy9hcGkvdjEvZW5oYW5jZWQtdm9pY2UvcHJvY2VzcycpXG4gICAgICAgIC5zZXQoJ0F1dGhvcml6YXRpb24nLCBhdXRoVG9rZW4pXG4gICAgICAgIC5zZW5kKGF1ZGlvUGF5bG9hZClcbiAgICAgICAgLmV4cGVjdCgyMDApO1xuXG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5zdGF0dXMpLnRvQmUoMjAwKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5LmRhdGEuYXVkaW9SZXNwb25zZSkudG9CZShCdWZmZXIuZnJvbSgnYXVkaW9fZGF0YScpLnRvU3RyaW5nKCdiYXNlNjQnKSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiA0MDEgZm9yIG1pc3NpbmcgYXV0aG9yaXphdGlvbicsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAucG9zdCgnL2FwaS92MS9lbmhhbmNlZC12b2ljZS9wcm9jZXNzJylcbiAgICAgICAgLnNlbmQodmFsaWRQYXlsb2FkKVxuICAgICAgICAuZXhwZWN0KDQwMSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiA0MDAgZm9yIGludmFsaWQgcGF5bG9hZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAucG9zdCgnL2FwaS92MS9lbmhhbmNlZC12b2ljZS9wcm9jZXNzJylcbiAgICAgICAgLnNldCgnQXV0aG9yaXphdGlvbicsIGF1dGhUb2tlbilcbiAgICAgICAgLnNlbmQoeyBzZXNzaW9uSWQ6ICcnIH0pXG4gICAgICAgIC5leHBlY3QoNDAwKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0dFVCAvYXBpL3YxL2VuaGFuY2VkLXZvaWNlL2hpc3RvcnknLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZXRyaWV2ZSBoaXN0b3J5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgbW9ja0VuaGFuY2VkVm9pY2VTZXJ2aWNlLmdldENvbnZlcnNhdGlvbkhpc3RvcnkubW9ja1Jlc29sdmVkVmFsdWUoeyBtZXNzYWdlczogW10gfSk7XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5nZXQoJy9hcGkvdjEvZW5oYW5jZWQtdm9pY2UvaGlzdG9yeT9zZXNzaW9uSWQ9MTIzJylcbiAgICAgICAgLnNldCgnQXV0aG9yaXphdGlvbicsIGF1dGhUb2tlbilcbiAgICAgICAgLmV4cGVjdCgyMDApO1xuXG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5zdGF0dXMpLnRvQmUoMjAwKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1BPU1QgL2FwaS92MS9lbmhhbmNlZC12b2ljZS9jbGVhcicsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGNsZWFyIHNlc3Npb24nLCBhc3luYyAoKSA9PiB7XG4gICAgICBtb2NrRW5oYW5jZWRWb2ljZVNlcnZpY2UuY2xlYXJDb252ZXJzYXRpb24ubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKTtcblxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLnBvc3QoJy9hcGkvdjEvZW5oYW5jZWQtdm9pY2UvY2xlYXInKVxuICAgICAgICAuc2V0KCdBdXRob3JpemF0aW9uJywgYXV0aFRva2VuKVxuICAgICAgICAuc2VuZCh7IHNlc3Npb25JZDogJzEyMycgfSlcbiAgICAgICAgLmV4cGVjdCgyMDApO1xuXG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5zdGF0dXMpLnRvQmUoMjAwKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==