9ecebf57b4733ad45301dabff5f84d8b
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.GodModeController = void 0;
const inversify_1 = require("inversify");
const types_1 = require("../types");
const supabase_service_1 = require("../services/supabase.service");
const god_notification_service_1 = require("../services/god-notification.service");
/**
 * ðŸŒŒ [GOD MODE] Controller
 * Sovereign management of AI assets: Projects, Documents, Prompts and Notifications.
 */
let GodModeController = class GodModeController {
    notificationService;
    constructor(notificationService) {
        this.notificationService = notificationService;
    }
    // PROJECTS
    async listProjects(req, res, next) {
        try {
            const client = supabase_service_1.SupabaseService.getInstance().getClient();
            const { data, error } = await client
                .from('projects')
                .select('*')
                .order('updated_at', { ascending: false });
            if (error)
                throw error;
            res.json({ success: true, data });
        }
        catch (error) {
            next(error);
        }
    }
    async createProject(req, res, next) {
        try {
            const { name, description } = req.body;
            const client = supabase_service_1.SupabaseService.getInstance().getClient();
            const { data, error } = await client
                .from('projects')
                .insert({ name, description })
                .select()
                .single();
            if (error)
                throw error;
            res.status(201).json({ success: true, data });
        }
        catch (error) {
            next(error);
        }
    }
    // DOCUMENTS / RAG
    async hybridSearch(req, res, next) {
        try {
            const query = typeof req.body.query === 'string' ? req.body.query : '';
            const { projectId, embedding, threshold, limit } = req.body;
            if (!query || !embedding) {
                return res.status(400).json({ error: 'Query and embedding are required' });
            }
            const results = await supabase_service_1.SupabaseService.getInstance().hybridSearch(projectId, query, embedding, threshold || 0.5, limit || 5);
            res.json({ success: true, data: results });
        }
        catch (error) {
            next(error);
        }
    }
    // PROMPTS
    async getPrompt(req, res, next) {
        try {
            const name = req.params.name;
            const template = await supabase_service_1.SupabaseService.getInstance().getPromptTemplate(name);
            if (!template) {
                return res.status(404).json({ error: `Prompt template [${name}] not found` });
            }
            res.json({ success: true, data: template });
        }
        catch (error) {
            next(error);
        }
    }
    async listPrompts(req, res, next) {
        try {
            const client = supabase_service_1.SupabaseService.getInstance().getClient();
            const { data, error } = await client
                .from('prompt_templates')
                .select('name, description, version, is_active')
                .order('name');
            if (error)
                throw error;
            res.json({ success: true, data });
        }
        catch (error) {
            next(error);
        }
    }
    // AUDIT
    async getAuditLogs(req, res, next) {
        try {
            const client = supabase_service_1.SupabaseService.getInstance().getClient();
            const { data, error } = await client
                .from('audit_logs')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(50);
            if (error)
                throw error;
            res.json({ success: true, data });
        }
        catch (error) {
            next(error);
        }
    }
    // NOTIFICATIONS
    async testNotification(req, res, next) {
        try {
            const { title, message, urgency } = req.body;
            await this.notificationService.broadcastGodAlert(title || 'Prueba de Sistema Soberano', message || 'Este es un mensaje de prueba verificado por Daniela.', urgency || 'medium');
            res.json({ success: true, message: 'Broadcast successful' });
        }
        catch (error) {
            next(error);
        }
    }
};
exports.GodModeController = GodModeController;
exports.GodModeController = GodModeController = __decorate([
    (0, inversify_1.injectable)(),
    __param(0, (0, inversify_1.inject)(types_1.TYPES.GodNotificationService)),
    __metadata("design:paramtypes", [typeof (_a = typeof god_notification_service_1.GodNotificationService !== "undefined" && god_notification_service_1.GodNotificationService) === "function" ? _a : Object])
], GodModeController);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxjb250cm9sbGVyc1xcZ29kbW9kZS5jb250cm9sbGVyLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7QUFDQSx5Q0FBK0M7QUFDL0Msb0NBQWlDO0FBQ2pDLG1FQUErRDtBQUMvRCxtRkFBOEU7QUFHOUU7OztHQUdHO0FBRUksSUFBTSxpQkFBaUIsR0FBdkIsTUFBTSxpQkFBaUI7SUFFb0I7SUFEaEQsWUFDZ0QsbUJBQTJDO1FBQTNDLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBd0I7SUFDeEYsQ0FBQztJQUVKLFdBQVc7SUFDSixLQUFLLENBQUMsWUFBWSxDQUFDLEdBQVksRUFBRSxHQUFhLEVBQUUsSUFBa0I7UUFDdkUsSUFBSSxDQUFDO1lBQ0gsTUFBTSxNQUFNLEdBQUcsa0NBQWUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUN6RCxNQUFNLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxHQUFHLE1BQU0sTUFBTTtpQkFDakMsSUFBSSxDQUFDLFVBQVUsQ0FBQztpQkFDaEIsTUFBTSxDQUFDLEdBQUcsQ0FBQztpQkFDWCxLQUFLLENBQUMsWUFBWSxFQUFFLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7WUFFN0MsSUFBSSxLQUFLO2dCQUFFLE1BQU0sS0FBSyxDQUFDO1lBQ3ZCLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7UUFDcEMsQ0FBQztRQUFDLE9BQU8sS0FBVSxFQUFFLENBQUM7WUFDcEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2QsQ0FBQztJQUNILENBQUM7SUFFTSxLQUFLLENBQUMsYUFBYSxDQUFDLEdBQVksRUFBRSxHQUFhLEVBQUUsSUFBa0I7UUFDeEUsSUFBSSxDQUFDO1lBQ0gsTUFBTSxFQUFFLElBQUksRUFBRSxXQUFXLEVBQUUsR0FBRyxHQUFHLENB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Q0FBQztJQUVELGdCQUFnQjtJQUNULEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFZLEVBQUUsR0FBYSxFQUFFLElBQWtCO1FBQzNFLElBQUksQ0FBQztZQUNILE1BQU0sRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7WUFFN0MsTUFBTSxJQUFJLENBQUMsbUJBQW1CLENBQUMsaUJBQWlCLENBQzlDLEtBQUssSUFBSSw0QkFBNEIsRUFDckMsT0FBTyxJQUFJLHNEQUFzRCxFQUNqRSxPQUFPLElBQUksUUFBUSxDQUNwQixDQUFDO1lBRUYsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLHNCQUFzQixFQUFFLENBQUMsQ0FBQztRQUMvRCxDQUFDO1FBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztZQUNwQixJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDZCxDQUFDO0lBQ0gsQ0FBQztDQUNGLENBQUE7QUEvSFksOENBQWlCOzRCQUFqQixpQkFBaUI7SUFEN0IsSUFBQSxzQkFBVSxHQUFFO0lBR1IsV0FBQSxJQUFBLGtCQUFNLEVBQUMsYUFBSyxDQUFDLHNCQUFzQixDQUFDLENBQUE7eURBQThCLGlEQUFzQixvQkFBdEIsaURBQXNCO0dBRmhGLGlCQUFpQixDQStIN0IiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxjb250cm9sbGVyc1xcZ29kbW9kZS5jb250cm9sbGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJlcXVlc3QsIFJlc3BvbnNlLCBOZXh0RnVuY3Rpb24gfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IGluamVjdGFibGUsIGluamVjdCB9IGZyb20gJ2ludmVyc2lmeSc7XG5pbXBvcnQgeyBUWVBFUyB9IGZyb20gJy4uL3R5cGVzJztcbmltcG9ydCB7IFN1cGFiYXNlU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL3N1cGFiYXNlLnNlcnZpY2UnO1xuaW1wb3J0IHsgR29kTm90aWZpY2F0aW9uU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL2dvZC1ub3RpZmljYXRpb24uc2VydmljZSc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuLi91dGlscy9sb2dnZXInO1xuXG4vKipcbiAqIPCfjIwgW0dPRCBNT0RFXSBDb250cm9sbGVyXG4gKiBTb3ZlcmVpZ24gbWFuYWdlbWVudCBvZiBBSSBhc3NldHM6IFByb2plY3RzLCBEb2N1bWVudHMsIFByb21wdHMgYW5kIE5vdGlmaWNhdGlvbnMuXG4gKi9cbkBpbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBHb2RNb2RlQ29udHJvbGxlciB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIEBpbmplY3QoVFlQRVMuR29kTm90aWZpY2F0aW9uU2VydmljZSkgcHJpdmF0ZSBub3RpZmljYXRpb25TZXJ2aWNlOiBHb2ROb3RpZmljYXRpb25TZXJ2aWNlLFxuICApIHt9XG5cbiAgLy8gUFJPSkVDVFNcbiAgcHVibGljIGFzeW5jIGxpc3RQcm9qZWN0cyhyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBjbGllbnQgPSBTdXBhYmFzZVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5nZXRDbGllbnQoKTtcbiAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IGNsaWVudFxuICAgICAgICAuZnJvbSgncHJvamVjdHMnKVxuICAgICAgICAuc2VsZWN0KCcqJylcbiAgICAgICAgLm9yZGVyKCd1cGRhdGVkX2F0JywgeyBhc2NlbmRpbmc6IGZhbHNlIH0pO1xuXG4gICAgICBpZiAoZXJyb3IpIHRocm93IGVycm9yO1xuICAgICAgcmVzLmpzb24oeyBzdWNjZXNzOiB0cnVlLCBkYXRhIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIG5leHQoZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBjcmVhdGVQcm9qZWN0KHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgbmFtZSwgZGVzY3JpcHRpb24gfSA9IHJlcS5ib2R5O1xuICAgICAgY29uc3QgY2xpZW50ID0gU3VwYWJhc2VTZXJ2aWNlLmdldEluc3RhbmNlKCkuZ2V0Q2xpZW50KCk7XG4gICAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBjbGllbnRcbiAgICAgICAgLmZyb20oJ3Byb2plY3RzJylcbiAgICAgICAgLmluc2VydCh7IG5hbWUsIGRlc2NyaXB0aW9uIH0pXG4gICAgICAgIC5zZWxlY3QoKVxuICAgICAgICAuc2luZ2xlKCk7XG5cbiAgICAgIGlmIChlcnJvcikgdGhyb3cgZXJyb3I7XG4gICAgICByZXMuc3RhdHVzKDIwMSkuanNvbih7IHN1Y2Nlc3M6IHRydWUsIGRhdGEgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgbmV4dChlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgLy8gRE9DVU1FTlRTIC8gUkFHXG4gIHB1YmxpYyBhc3luYyBoeWJyaWRTZWFyY2gocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcXVlcnkgPSB0eXBlb2YgcmVxLmJvZHkucXVlcnkgPT09ICdzdHJpbmcnID8gcmVxLmJvZHkucXVlcnkgOiAnJztcbiAgICAgIGNvbnN0IHsgcHJvamVjdElkLCBlbWJlZGRpbmcsIHRocmVzaG9sZCwgbGltaXQgfSA9IHJlcS5ib2R5O1xuXG4gICAgICBpZiAoIXF1ZXJ5IHx8ICFlbWJlZGRpbmcpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgZXJyb3I6ICdRdWVyeSBhbmQgZW1iZWRkaW5nIGFyZSByZXF1aXJlZCcgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBTdXBhYmFzZVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5oeWJyaWRTZWFyY2goXG4gICAgICAgIHByb2plY3RJZCxcbiAgICAgICAgcXVlcnksXG4gICAgICAgIGVtYmVkZGluZyxcbiAgICAgICAgdGhyZXNob2xkIHx8IDAuNSxcbiAgICAgICAgbGltaXQgfHwgNSxcbiAgICAgICk7XG5cbiAgICAgIHJlcy5qc29uKHsgc3VjY2VzczogdHJ1ZSwgZGF0YTogcmVzdWx0cyB9KTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBuZXh0KGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvLyBQUk9NUFRTXG4gIHB1YmxpYyBhc3luYyBnZXRQcm9tcHQocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgbmFtZSA9IHJlcS5wYXJhbXMubmFtZSBhcyBzdHJpbmc7XG4gICAgICBjb25zdCB0ZW1wbGF0ZSA9IGF3YWl0IFN1cGFiYXNlU2VydmljZS5nZXRJbnN0YW5jZSgpLmdldFByb21wdFRlbXBsYXRlKG5hbWUpO1xuXG4gICAgICBpZiAoIXRlbXBsYXRlKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IGVycm9yOiBgUHJvbXB0IHRlbXBsYXRlIFske25hbWV9XSBub3QgZm91bmRgIH0pO1xuICAgICAgfVxuXG4gICAgICByZXMuanNvbih7IHN1Y2Nlc3M6IHRydWUsIGRhdGE6IHRlbXBsYXRlIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIG5leHQoZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBsaXN0UHJvbXB0cyhyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBjbGllbnQgPSBTdXBhYmFzZVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5nZXRDbGllbnQoKTtcbiAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IGNsaWVudFxuICAgICAgICAuZnJvbSgncHJvbXB0X3RlbXBsYXRlcycpXG4gICAgICAgIC5zZWxlY3QoJ25hbWUsIGRlc2NyaXB0aW9uLCB2ZXJzaW9uLCBpc19hY3RpdmUnKVxuICAgICAgICAub3JkZXIoJ25hbWUnKTtcblxuICAgICAgaWYgKGVycm9yKSB0aHJvdyBlcnJvcjtcbiAgICAgIHJlcy5qc29uKHsgc3VjY2VzczogdHJ1ZSwgZGF0YSB9KTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBuZXh0KGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvLyBBVURJVFxuICBwdWJsaWMgYXN5bmMgZ2V0QXVkaXRMb2dzKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGNsaWVudCA9IFN1cGFiYXNlU2VydmljZS5nZXRJbnN0YW5jZSgpLmdldENsaWVudCgpO1xuICAgICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgY2xpZW50XG4gICAgICAgIC5mcm9tKCdhdWRpdF9sb2dzJylcbiAgICAgICAgLnNlbGVjdCgnKicpXG4gICAgICAgIC5vcmRlcignY3JlYXRlZF9hdCcsIHsgYXNjZW5kaW5nOiBmYWxzZSB9KVxuICAgICAgICAubGltaXQoNTApO1xuXG5cbiAgICAgIGlmIChlcnJvcikgdGhyb3cgZXJyb3I7XG4gICAgICByZXMuanNvbih7IHN1Y2Nlc3M6IHRydWUsIGRhdGEgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgbmV4dChlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgLy8gTk9USUZJQ0FUSU9OU1xuICBwdWJsaWMgYXN5bmMgdGVzdE5vdGlmaWNhdGlvbihyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IHRpdGxlLCBtZXNzYWdlLCB1cmdlbmN5IH0gPSByZXEuYm9keTtcblxuICAgICAgYXdhaXQgdGhpcy5ub3RpZmljYXRpb25TZXJ2aWNlLmJyb2FkY2FzdEdvZEFsZXJ0KFxuICAgICAgICB0aXRsZSB8fCAnUHJ1ZWJhIGRlIFNpc3RlbWEgU29iZXJhbm8nLFxuICAgICAgICBtZXNzYWdlIHx8ICdFc3RlIGVzIHVuIG1lbnNhamUgZGUgcHJ1ZWJhIHZlcmlmaWNhZG8gcG9yIERhbmllbGEuJyxcbiAgICAgICAgdXJnZW5jeSB8fCAnbWVkaXVtJyxcbiAgICAgICk7XG5cbiAgICAgIHJlcy5qc29uKHsgc3VjY2VzczogdHJ1ZSwgbWVzc2FnZTogJ0Jyb2FkY2FzdCBzdWNjZXNzZnVsJyB9KTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBuZXh0KGVycm9yKTtcbiAgICB9XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==