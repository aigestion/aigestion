ca962d56506e20dfa736cd9ca66a7a9e
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getCurrentUsage = void 0;
const errors_1 = require("../utils/errors");
const UsageRecord_1 = require("../models/UsageRecord");
const response_builder_1 = require("../common/response-builder");
const logger_1 = require("../utils/logger");
const getCurrentUsage = async (req, res, next) => {
    try {
        const userId = req.user?.id || req.headers['x-user-id']; // Fallback for dev/test
        if (!userId) {
            return next(new errors_1.AppError('User ID unknown', 401, 'UNAUTHORIZED'));
        }
        // 1. Fetch Aggregated Stats
        const now = new Date();
        const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const result = await UsageRecord_1.UsageRecord.aggregate([
            { $match: { userId: userId, createdAt: { $gte: firstDayOfMonth } } },
            {
                $group: {
                    _id: null,
                    totalTokens: { $sum: '$totalTokens' },
                    estimatedCost: { $sum: '$costEstimate' },
                    count: { $sum: 1 },
                },
            },
        ]);
        const stats = result[0] || { totalTokens: 0, estimatedCost: 0, count: 0 };
        const cost = typeof stats.estimatedCost === 'number' ? stats.estimatedCost.toFixed(4) : '0.00';
        // 2. Build Generative UI Schema
        const schema = {
            type: 'container',
            direction: 'column',
            children: [
                {
                    type: 'container',
                    direction: 'row',
                    children: [
                        { type: 'stat', label: 'Total Tokens (MTH)', value: stats.totalTokens, trend: 'up' },
                        { type: 'stat', label: 'Est. Cost', value: `$${cost}`, trend: 'neutral' },
                    ],
                },
                {
                    type: 'card',
                    title: 'Current Plan Status',
                    content: 'You are on the Metered Plan. Usage is calculated daily and billed at the end of the month.',
                    variant: 'glass',
                },
            ],
        };
        // 3. Return JSON
        res.json((0, response_builder_1.buildResponse)(schema, 200, req.requestId));
    }
    catch (err) {
        logger_1.logger.error(err, 'Error fetching current usage');
        next(err);
    }
};
exports.getCurrentUsage = getCurrentUsage;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxjb250cm9sbGVyc1xcdXNhZ2UuY29udHJvbGxlci50cyIsIm1hcHBpbmdzIjoiOzs7QUFFQSw0Q0FBMkM7QUFDM0MsdURBQW9EO0FBQ3BELGlFQUEyRDtBQUMzRCw0Q0FBeUM7QUFTbEMsTUFBTSxlQUFlLEdBQUcsS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFhLEVBQUUsSUFBa0IsRUFBRSxFQUFFO0lBQ3ZGLElBQUksQ0FBQztRQUNILE1BQU0sTUFBTSxHQUFJLEdBQVcsQ0FBQyxJQUFJLEVBQUUsRUFBRSxJQUFJLEdBQUcsQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyx3QkFBd0I7UUFFMUYsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ1osT0FBTyxJQUFJLENBQUMsSUFBSSxpQkFBUSxDQUFDLGlCQUFpQixFQUFFLEdBQUcsRUFBRSxjQUFjLENBQUMsQ0FBQyxDQUFDO1FBQ3BFLENBQUM7UUFFRCw0QkFBNEI7UUFDNUIsTUFBTSxHQUFHLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUN2QixNQUFNLGVBQWUsR0FBRyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLEVBQUUsR0FBRyxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBRXZFLE1BQU0sTUFBTSxHQUFHLE1BQU0seUJBQVcsQ0FBQyxTQUFTLENBQUM7WUFDekMsRUFBRSxNQUFNLEVBQUUsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxFQUFFLElBQUksRUFBRSxlQUFlLEVBQUUsRUFBRSxFQUFFO1lBQ3BFO2dCQUNFLE1BQU0sRUFBRTtvQkFDTixHQUFHLEVBQUUsSUFBSTtvQkFDVCxXQUFXLEVBQUUsRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFFO29CQUNyQyxhQUFhLEVBQUUsRUFBRSxJQUFJLEVBQUUsZUFBZSxFQUFFO29CQUN4QyxLQUFLLEVBQUUsRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFFO2lCQUNuQjthQUNGO1NBQ0YsQ0FBQyxDQUFDO1FBRUgsTUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsV0FBVyxFQUFFLENBQUMsRUFBRSxhQUFhLEVBQUUsQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsQ0FBQztRQUMxRSxNQUFNLElBQUksR0FBRyxPQUFPLEtBQUssQ0FBQyxhQUFhLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO1FBRS9GLGdDQUFnQztRQUNoQyxNQUFNLE1BQU0sR0FBdUI7WUFDakMsSUFBSSxFQUFFLFdBQVc7WUFDakIsU0FBUyxFQUFFLFFBQVE7WUFDbkIsUUFBUSxFQUFFO2dCQUNSO29CQUNFLElBQUksRUFBRSxXQUFXO29CQUNqQixTQUFTLEVBQUUsS0FBSztvQkFDaEIsUUFBUSxFQUFFO3dCQUNSLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsb0JBQW9CLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxXQUFXLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRTt3QkFDcEYsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxXQUFXLEVBQUUsS0FBSyxFQUFFLElBQUksSUFBSSxFQUFFLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRTtxQkFDMUU7aUJBQ0Y7Z0JBQ0Q7b0JBQ0UsSUFBSSxFQUFFLE1BQU07b0JBQ1osS0FBSyxFQUFFLHFCQUFxQjtvQkFDNUIsT0FBTyxFQUNMLDRGQUE0RjtvQkFDOUYsT0FBTyxFQUFFLE9BQU87aUJBQ2pCO2FBQ0Y7U0FDRixDQUFDO1FBRUYsaUJBQWlCO1FBQ2pCLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBQSxnQ0FBYSxFQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUcsR0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7SUFDL0QsQ0FBQztJQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7UUFDYixlQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSw4QkFBOEIsQ0FBQyxDQUFDO1FBQ2xELElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNaLENBQUM7QUFDSCxDQUFDLENBQUM7QUF4RFcsUUFBQSxlQUFlLG1CQXdEMUIiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxjb250cm9sbGVyc1xcdXNhZ2UuY29udHJvbGxlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IE5leHRGdW5jdGlvbiwgUmVxdWVzdCwgUmVzcG9uc2UgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IGluamVjdGFibGUgfSBmcm9tICdpbnZlcnNpZnknO1xuaW1wb3J0IHsgQXBwRXJyb3IgfSBmcm9tICcuLi91dGlscy9lcnJvcnMnO1xuaW1wb3J0IHsgVXNhZ2VSZWNvcmQgfSBmcm9tICcuLi9tb2RlbHMvVXNhZ2VSZWNvcmQnO1xuaW1wb3J0IHsgYnVpbGRSZXNwb25zZSB9IGZyb20gJy4uL2NvbW1vbi9yZXNwb25zZS1idWlsZGVyJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uL3V0aWxzL2xvZ2dlcic7XG5cbi8vIEdlbmVyYXRpdmUgVUkgU2NoZW1hIHNoYXJlZCB3aXRoIEZyb250ZW5kXG50eXBlIEdlbmVyYXRpdmVVSVNjaGVtYSA9XG4gIHwgeyB0eXBlOiAnY2FyZCc7IHRpdGxlPzogc3RyaW5nOyBjb250ZW50OiBzdHJpbmc7IHZhcmlhbnQ/OiAnZGVmYXVsdCcgfCAnZ2xhc3MnIHwgJ291dGxpbmUnIH1cbiAgfCB7IHR5cGU6ICdzdGF0JzsgbGFiZWw6IHN0cmluZzsgdmFsdWU6IHN0cmluZyB8IG51bWJlcjsgdHJlbmQ/OiAndXAnIHwgJ2Rvd24nIHwgJ25ldXRyYWwnIH1cbiAgfCB7IHR5cGU6ICdsaXN0JzsgaXRlbXM6IHN0cmluZ1tdOyB0aXRsZT86IHN0cmluZyB9XG4gIHwgeyB0eXBlOiAnY29udGFpbmVyJzsgZGlyZWN0aW9uOiAncm93JyB8ICdjb2x1bW4nOyBjaGlsZHJlbjogR2VuZXJhdGl2ZVVJU2NoZW1hW10gfTtcblxuZXhwb3J0IGNvbnN0IGdldEN1cnJlbnRVc2FnZSA9IGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHVzZXJJZCA9IChyZXEgYXMgYW55KS51c2VyPy5pZCB8fCByZXEuaGVhZGVyc1sneC11c2VyLWlkJ107IC8vIEZhbGxiYWNrIGZvciBkZXYvdGVzdFxuXG4gICAgaWYgKCF1c2VySWQpIHtcbiAgICAgIHJldHVybiBuZXh0KG5ldyBBcHBFcnJvcignVXNlciBJRCB1bmtub3duJywgNDAxLCAnVU5BVVRIT1JJWkVEJykpO1xuICAgIH1cblxuICAgIC8vIDEuIEZldGNoIEFnZ3JlZ2F0ZWQgU3RhdHNcbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgIGNvbnN0IGZpcnN0RGF5T2ZNb250aCA9IG5ldyBEYXRlKG5vdy5nZXRGdWxsWWVhcigpLCBub3cuZ2V0TW9udGgoKSwgMSk7XG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBVc2FnZVJlY29yZC5hZ2dyZWdhdGUoW1xuICAgICAgeyAkbWF0Y2g6IHsgdXNlcklkOiB1c2VySWQsIGNyZWF0ZWRBdDogeyAkZ3RlOiBmaXJzdERheU9mTW9udGggfSB9IH0sXG4gICAgICB7XG4gICAgICAgICRncm91cDoge1xuICAgICAgICAgIF9pZDogbnVsbCxcbiAgICAgICAgICB0b3RhbFRva2VuczogeyAkc3VtOiAnJHRvdGFsVG9rZW5zJyB9LFxuICAgICAgICAgIGVzdGltYXRlZENvc3Q6IHsgJHN1bTogJyRjb3N0RXN0aW1hdGUnIH0sXG4gICAgICAgICAgY291bnQ6IHsgJHN1bTogMSB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICBdKTtcblxuICAgIGNvbnN0IHN0YXRzID0gcmVzdWx0WzBdIHx8IHsgdG90YWxUb2tlbnM6IDAsIGVzdGltYXRlZENvc3Q6IDAsIGNvdW50OiAwIH07XG4gICAgY29uc3QgY29zdCA9IHR5cGVvZiBzdGF0cy5lc3RpbWF0ZWRDb3N0ID09PSAnbnVtYmVyJyA/IHN0YXRzLmVzdGltYXRlZENvc3QudG9GaXhlZCg0KSA6ICcwLjAwJztcblxuICAgIC8vIDIuIEJ1aWxkIEdlbmVyYXRpdmUgVUkgU2NoZW1hXG4gICAgY29uc3Qgc2NoZW1hOiBHZW5lcmF0aXZlVUlTY2hlbWEgPSB7XG4gICAgICB0eXBlOiAnY29udGFpbmVyJyxcbiAgICAgIGRpcmVjdGlvbjogJ2NvbHVtbicsXG4gICAgICBjaGlsZHJlbjogW1xuICAgICAgICB7XG4gICAgICAgICAgdHlwZTogJ2NvbnRhaW5lcicsXG4gICAgICAgICAgZGlyZWN0aW9uOiAncm93JyxcbiAgICAgICAgICBjaGlsZHJlbjogW1xuICAgICAgICAgICAgeyB0eXBlOiAnc3RhdCcsIGxhYmVsOiAnVG90YWwgVG9rZW5zIChNVEgpJywgdmFsdWU6IHN0YXRzLnRvdGFsVG9rZW5zLCB0cmVuZDogJ3VwJyB9LFxuICAgICAgICAgICAgeyB0eXBlOiAnc3RhdCcsIGxhYmVsOiAnRXN0LiBDb3N0JywgdmFsdWU6IGAkJHtjb3N0fWAsIHRyZW5kOiAnbmV1dHJhbCcgfSxcbiAgICAgICAgICBdLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgdHlwZTogJ2NhcmQnLFxuICAgICAgICAgIHRpdGxlOiAnQ3VycmVudCBQbGFuIFN0YXR1cycsXG4gICAgICAgICAgY29udGVudDpcbiAgICAgICAgICAgICdZb3UgYXJlIG9uIHRoZSBNZXRlcmVkIFBsYW4uIFVzYWdlIGlzIGNhbGN1bGF0ZWQgZGFpbHkgYW5kIGJpbGxlZCBhdCB0aGUgZW5kIG9mIHRoZSBtb250aC4nLFxuICAgICAgICAgIHZhcmlhbnQ6ICdnbGFzcycsXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH07XG5cbiAgICAvLyAzLiBSZXR1cm4gSlNPTlxuICAgIHJlcy5qc29uKGJ1aWxkUmVzcG9uc2Uoc2NoZW1hLCAyMDAsIChyZXEgYXMgYW55KS5yZXF1ZXN0SWQpKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nZ2VyLmVycm9yKGVyciwgJ0Vycm9yIGZldGNoaW5nIGN1cnJlbnQgdXNhZ2UnKTtcbiAgICBuZXh0KGVycik7XG4gIH1cbn07XG4iXSwidmVyc2lvbiI6M30=