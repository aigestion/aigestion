{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\two-factor.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\two-factor.service.ts"],"sourcesContent":["import crypto from 'crypto';\nimport { injectable } from 'inversify';\nimport type { RedisClientType } from 'redis';\nimport qrcode from 'qrcode';\nimport { authenticator } from 'otplib';\nimport { getRedisClient } from '../cache/redis';\nimport { logger } from '../utils/logger';\n\ninterface TOTPSetup {\n  secret: string;\n  qrCode: string;\n  backupCodes: string[];\n  manualEntryKey: string;\n}\n\ninterface TwoFactorVerification {\n  userId: string;\n  method: 'totp' | 'sms' | 'email' | 'backup';\n  code: string;\n  expiresAt: Date;\n  attempts: number;\n}\n\ninterface BackupCode {\n  code: string;\n  used: boolean;\n  usedAt?: Date;\n  createdAt: Date;\n}\n\n@injectable()\nexport class TwoFactorService {\n  private readonly redis: RedisClientType;\n  private readonly codeExpiry = 5 * 60 * 1000; // 5 minutes\n  private readonly maxAttempts = 3;\n  private readonly backupCodeCount = 10;\n\n  constructor() {\n    this.redis = getRedisClient();\n  }\n\n  /**\n   * Generate TOTP secret and QR code for user\n   */\n  public async generateTOTPSecret(userId: string, email: string): Promise<TOTPSetup> {\n    try {\n      // Generate secret\n      const secret = authenticator.generateSecret();\n      const otpauthUrl = authenticator.keyuri(email, 'AIGestion NEXUS V1', secret);\n\n      // Generate QR code\n      const qrCodeUrl = await this.generateQrCode(otpauthUrl);\n\n      // Generate backup codes\n      const backupCodes = this.generateBackupCodes();\n\n      // Store in Redis\n      await this.redis.setEx(\n        `2fa:totp:${userId}`,\n        24 * 60 * 60, // 24 hours\n        JSON.stringify({\n          secret: secret,\n          backupCodes: backupCodes.map(code => ({\n            code,\n            used: false,\n            createdAt: new Date(),\n          })),\n        }),\n      );\n\n      logger.info('TOTP secret generated', { userId, email });\n\n      return {\n        secret: secret,\n        qrCode: qrCodeUrl,\n        backupCodes,\n        manualEntryKey: secret,\n      };\n    } catch (error) {\n      logger.error('Error generating TOTP secret:', { userId, error });\n      throw new Error('Failed to generate TOTP secret');\n    }\n  }\n\n  /**\n   * Generate QR code from an otpauth URL\n   */\n  public async generateQrCode(otpauthUrl: string): Promise<string> {\n    return qrcode.toDataURL(otpauthUrl);\n  }\n\n  /**\n   * Verify token against secret (stateless)\n   */\n  public verifyToken(secret: string, token: string): boolean {\n    try {\n      return authenticator.check(token, secret);\n    } catch (error) {\n      logger.error('Error verifying token:', error);\n      return false;\n    }\n  }\n\n  /**\n   * Verify TOTP token\n   */\n  public async verifyTOTPToken(userId: string, token: string): Promise<boolean> {\n    try {\n      const storedData = await this.redis.get(`2fa:totp:${userId}`);\n      if (!storedData) {\n        return false;\n      }\n\n      const { secret } = JSON.parse(storedData);\n\n      const verified = authenticator.check(token, secret);\n\n      if (verified) {\n        logger.info('TOTP token verified successfully', { userId });\n      } else {\n        logger.warn('TOTP token verification failed', { userId });\n      }\n\n      return verified;\n    } catch (error) {\n      logger.error('Error verifying TOTP token:', { userId, error });\n      return false;\n    }\n  }\n\n  /**\n   * Verify backup code\n   */\n  public async verifyBackupCode(userId: string, code: string): Promise<boolean> {\n    try {\n      const storedData = await this.redis.get(`2fa:totp:${userId}`);\n      if (!storedData) {\n        return false;\n      }\n\n      const { backupCodes } = JSON.parse(storedData);\n\n      // Find matching unused backup code\n      const backupCode = backupCodes.find((bc: BackupCode) => bc.code === code && !bc.used);\n\n      if (!backupCode) {\n        logger.warn('Invalid or already used backup code', { userId });\n        return false;\n      }\n\n      // Mark backup code as used\n      backupCode.used = true;\n      backupCode.usedAt = new Date();\n\n      // Update stored data\n      await this.redis.setEx(\n        `2fa:totp:${userId}`,\n        24 * 60 * 60,\n        JSON.stringify({\n          secret: JSON.parse(storedData).secret,\n          backupCodes,\n        }),\n      );\n\n      logger.info('Backup code used successfully', { userId });\n      return true;\n    } catch (error) {\n      logger.error('Error verifying backup code:', { userId, error });\n      return false;\n    }\n  }\n\n  /**\n   * Send SMS verification code\n   */\n  public async sendSMSCode(userId: string, phoneNumber: string): Promise<boolean> {\n    try {\n      const code = this.generateVerificationCode();\n\n      // Store verification data\n      const verificationData: TwoFactorVerification = {\n        userId,\n        method: 'sms',\n        code,\n        expiresAt: new Date(Date.now() + this.codeExpiry),\n        attempts: 0,\n      };\n\n      await this.redis.setEx(\n        `2fa:sms:${userId}`,\n        this.codeExpiry / 1000,\n        JSON.stringify(verificationData),\n      );\n\n      // Send SMS (integrate with your SMS service)\n      const success = await this.sendSMS(phoneNumber, code);\n\n      if (success) {\n        logger.info('SMS verification code sent', { userId, phoneNumber });\n      } else {\n        logger.error('Failed to send SMS verification code', { userId, phoneNumber });\n      }\n\n      return success;\n    } catch (error) {\n      logger.error('Error sending SMS code:', { userId, error });\n      return false;\n    }\n  }\n\n  /**\n   * Send email verification code\n   */\n  public async sendEmailCode(userId: string, email: string): Promise<boolean> {\n    try {\n      const code = this.generateVerificationCode();\n\n      // Store verification data\n      const verificationData: TwoFactorVerification = {\n        userId,\n        method: 'email',\n        code,\n        expiresAt: new Date(Date.now() + this.codeExpiry),\n        attempts: 0,\n      };\n\n      await this.redis.setEx(\n        `2fa:email:${userId}`,\n        this.codeExpiry / 1000,\n        JSON.stringify(verificationData),\n      );\n\n      // Send email (integrate with your email service)\n      const success = await this.sendEmail(email, code);\n\n      if (success) {\n        logger.info('Email verification code sent', { userId, email });\n      } else {\n        logger.error('Failed to send email verification code', { userId, email });\n      }\n\n      return success;\n    } catch (error) {\n      logger.error('Error sending email code:', { userId, error });\n      return false;\n    }\n  }\n\n  /**\n   * Verify SMS/Email code\n   */\n  public async verifyCode(userId: string, method: 'sms' | 'email', code: string): Promise<boolean> {\n    try {\n      const key = `2fa:${method}:${userId}`;\n      const storedData = await this.redis.get(key);\n\n      if (!storedData) {\n        return false;\n      }\n\n      const verificationData: TwoFactorVerification = JSON.parse(storedData);\n\n      // Check if expired\n      if (new Date() > verificationData.expiresAt) {\n        await this.redis.del(key);\n        return false;\n      }\n\n      // Check attempts\n      if (verificationData.attempts >= this.maxAttempts) {\n        await this.redis.del(key);\n        logger.warn('Too many verification attempts', { userId, method });\n        return false;\n      }\n\n      // Verify code\n      const isValid = verificationData.code === code;\n\n      if (!isValid) {\n        verificationData.attempts++;\n        await this.redis.setEx(\n          key,\n          Math.ceil((verificationData.expiresAt.getTime() - Date.now()) / 1000),\n          JSON.stringify(verificationData),\n        );\n\n        logger.warn('Invalid verification code', {\n          userId,\n          method,\n          attempts: verificationData.attempts,\n        });\n        return false;\n      }\n\n      // Remove verification data after successful verification\n      await this.redis.del(key);\n\n      logger.info('Verification code verified successfully', { userId, method });\n      return true;\n    } catch (error) {\n      logger.error('Error verifying code:', { userId, method, error });\n      return false;\n    }\n  }\n\n  /**\n   * Enable 2FA for user\n   */\n  public async enableTwoFactor(\n    userId: string,\n    method: 'totp' | 'sms' | 'email',\n    details?: any,\n  ): Promise<boolean> {\n    try {\n      const twoFactorData = {\n        enabled: true,\n        method,\n        details: details || {},\n        enabledAt: new Date(),\n        lastUsed: new Date(),\n      };\n\n      await this.redis.setEx(\n        `2fa:user:${userId}`,\n        365 * 24 * 60 * 60, // 1 year\n        JSON.stringify(twoFactorData),\n      );\n\n      logger.info('2FA enabled for user', { userId, method });\n      return true;\n    } catch (error) {\n      logger.error('Error enabling 2FA:', { userId, method, error });\n      return false;\n    }\n  }\n\n  /**\n   * Disable 2FA for user\n   */\n  public async disableTwoFactor(userId: string): Promise<boolean> {\n    try {\n      await this.redis.del(`2fa:user:${userId}`);\n      await this.redis.del(`2fa:totp:${userId}`);\n\n      logger.info('2FA disabled for user', { userId });\n      return true;\n    } catch (error) {\n      logger.error('Error disabling 2FA:', { userId, error });\n      return false;\n    }\n  }\n\n  /**\n   * Check if 2FA is enabled for user\n   */\n  public async isTwoFactorEnabled(userId: string): Promise<boolean> {\n    try {\n      const data = await this.redis.get(`2fa:user:${userId}`);\n      return data ? JSON.parse(data).enabled : false;\n    } catch (error) {\n      logger.error('Error checking 2FA status:', { userId, error });\n      return false;\n    }\n  }\n\n  /**\n   * Get user's 2FA settings\n   */\n  public async getTwoFactorSettings(userId: string): Promise<any> {\n    try {\n      const userData = await this.redis.get(`2fa:user:${userId}`);\n      const totpData = await this.redis.get(`2fa:totp:${userId}`);\n\n      if (!userData) {\n        return null;\n      }\n\n      const userSettings = JSON.parse(userData);\n\n      if (totpData && userSettings.method === 'totp') {\n        const { backupCodes } = JSON.parse(totpData);\n        userSettings.backupCodes = backupCodes.filter((bc: BackupCode) => !bc.used).length;\n      }\n\n      return userSettings;\n    } catch (error) {\n      logger.error('Error getting 2FA settings:', { userId, error });\n      return null;\n    }\n  }\n\n  /**\n   * Regenerate backup codes\n   */\n  public async regenerateBackupCodes(userId: string): Promise<string[]> {\n    try {\n      const storedData = await this.redis.get(`2fa:totp:${userId}`);\n      if (!storedData) {\n        throw new Error('TOTP not set up for user');\n      }\n\n      const { secret } = JSON.parse(storedData);\n      const newBackupCodes = this.generateBackupCodes();\n\n      // Update stored data\n      await this.redis.setEx(\n        `2fa:totp:${userId}`,\n        24 * 60 * 60,\n        JSON.stringify({\n          secret,\n          backupCodes: newBackupCodes.map(code => ({\n            code,\n            used: false,\n            createdAt: new Date(),\n          })),\n        }),\n      );\n\n      logger.info('Backup codes regenerated', { userId });\n      return newBackupCodes;\n    } catch (error) {\n      logger.error('Error regenerating backup codes:', { userId, error });\n      throw error;\n    }\n  }\n\n  /**\n   * Generate backup codes\n   */\n  private generateBackupCodes(): string[] {\n    const codes: string[] = [];\n    for (let i = 0; i < this.backupCodeCount; i++) {\n      codes.push(crypto.randomBytes(4).toString('hex').toUpperCase());\n    }\n    return codes;\n  }\n\n  /**\n   * Generate verification code\n   */\n  private generateVerificationCode(): string {\n    return Math.floor(100000 + Math.random() * 900000).toString();\n  }\n\n  /**\n   * Send SMS (placeholder - integrate with your SMS service)\n   */\n  private async sendSMS(phoneNumber: string, code: string): Promise<boolean> {\n    try {\n      // Integrate with your SMS service (Twilio, AWS SNS, etc.)\n      // For now, just log the code\n      logger.info('SMS code (for development):', { phoneNumber, code });\n\n      // Example with Twilio:\n      /*\n      const twilio = require('twilio');\n      const client = twilio(process.env.TWILIO_ACCOUNT_SID, process.env.TWILIO_AUTH_TOKEN);\n\n      await client.messages.create({\n        body: `Your AIGestion verification code is: ${code}`,\n        from: process.env.TWILIO_PHONE_NUMBER,\n        to: phoneNumber\n      });\n      */\n\n      return true;\n    } catch (error) {\n      logger.error('Error sending SMS:', { phoneNumber, error });\n      return false;\n    }\n  }\n\n  /**\n   * Send email (placeholder - integrate with your email service)\n   */\n  private async sendEmail(email: string, code: string): Promise<boolean> {\n    try {\n      // Integrate with your email service (Nodemailer, SendGrid, etc.)\n      // For now, just log the code\n      logger.info('Email code (for development):', { email, code });\n\n      // Example with Nodemailer:\n      /*\n      const nodemailer = require('nodemailer');\n      const transporter = nodemailer.createTransporter({\n        service: 'gmail',\n        auth: {\n          user: process.env.EMAIL_USER,\n          pass: process.env.EMAIL_PASS\n        }\n      });\n\n      await transporter.sendMail({\n        from: process.env.EMAIL_USER,\n        to: email,\n        subject: 'AIGestion Verification Code',\n        text: `Your verification code is: ${code}`,\n        html: `<p>Your verification code is: <strong>${code}</strong></p>`\n      });\n      */\n\n      return true;\n    } catch (error) {\n      logger.error('Error sending email:', { email, error });\n      return false;\n    }\n  }\n\n  /**\n   * Cleanup expired verification codes\n   */\n  public async cleanupExpiredCodes(): Promise<void> {\n    try {\n      const smsKeys = await this.redis.keys('2fa:sms:*');\n      const emailKeys = await this.redis.keys('2fa:email:*');\n\n      for (const key of [...smsKeys, ...emailKeys]) {\n        const data = await this.redis.get(key);\n        if (data) {\n          const verificationData: TwoFactorVerification = JSON.parse(data);\n          if (new Date() > verificationData.expiresAt) {\n            await this.redis.del(key);\n          }\n        }\n      }\n\n      logger.info('Expired verification codes cleaned up');\n    } catch (error) {\n      logger.error('Error cleaning up expired codes:', error);\n    }\n  }\n\n  /**\n   * Get 2FA statistics\n   */\n  public async getStats(): Promise<{\n    totalUsers: number;\n    enabledUsers: number;\n    methodDistribution: { [key: string]: number };\n    recentVerifications: number;\n  }> {\n    try {\n      const userKeys = await this.redis.keys('2fa:user:*');\n      const totalUsers = userKeys.length;\n\n      let enabledUsers = 0;\n      const methodDistribution: { [key: string]: number } = {};\n\n      for (const key of userKeys) {\n        const data = await this.redis.get(key);\n        if (data) {\n          const settings = JSON.parse(data);\n          if (settings.enabled) {\n            enabledUsers++;\n            methodDistribution[settings.method] = (methodDistribution[settings.method] || 0) + 1;\n          }\n        }\n      }\n\n      // Count recent verifications (last hour)\n      const recentKeys = await this.redis.keys('2fa:*');\n      const recentVerifications = recentKeys.filter(\n        key => key.includes('sms:') || key.includes('email:'),\n      ).length;\n\n      return {\n        totalUsers,\n        enabledUsers,\n        methodDistribution,\n        recentVerifications,\n      };\n    } catch (error) {\n      logger.error('Error getting 2FA stats:', error);\n      return {\n        totalUsers: 0,\n        enabledUsers: 0,\n        methodDistribution: {},\n        recentVerifications: 0,\n      };\n    }\n  }\n}\n"],"version":3}