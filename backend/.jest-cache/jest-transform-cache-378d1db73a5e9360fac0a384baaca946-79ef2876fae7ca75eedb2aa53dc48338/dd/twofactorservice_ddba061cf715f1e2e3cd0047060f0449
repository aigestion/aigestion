1664995e905881355f00113829bb8e63
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.TwoFactorService = void 0;
const crypto_1 = __importDefault(require("crypto"));
const inversify_1 = require("inversify");
const qrcode_1 = __importDefault(require("qrcode"));
const otplib_1 = require("otplib");
const redis_1 = require("../cache/redis");
const logger_1 = require("../utils/logger");
let TwoFactorService = class TwoFactorService {
    redis;
    codeExpiry = 5 * 60 * 1000; // 5 minutes
    maxAttempts = 3;
    backupCodeCount = 10;
    constructor() {
        this.redis = (0, redis_1.getRedisClient)();
    }
    /**
     * Generate TOTP secret and QR code for user
     */
    async generateTOTPSecret(userId, email) {
        try {
            // Generate secret
            const secret = otplib_1.authenticator.generateSecret();
            const otpauthUrl = otplib_1.authenticator.keyuri(email, 'AIGestion NEXUS V1', secret);
            // Generate QR code
            const qrCodeUrl = await this.generateQrCode(otpauthUrl);
            // Generate backup codes
            const backupCodes = this.generateBackupCodes();
            // Store in Redis
            await this.redis.setEx(`2fa:totp:${userId}`, 24 * 60 * 60, // 24 hours
            JSON.stringify({
                secret: secret,
                backupCodes: backupCodes.map(code => ({
                    code,
                    used: false,
                    createdAt: new Date(),
                })),
            }));
            logger_1.logger.info('TOTP secret generated', { userId, email });
            return {
                secret: secret,
                qrCode: qrCodeUrl,
                backupCodes,
                manualEntryKey: secret,
            };
        }
        catch (error) {
            logger_1.logger.error('Error generating TOTP secret:', { userId, error });
            throw new Error('Failed to generate TOTP secret');
        }
    }
    /**
     * Generate QR code from an otpauth URL
     */
    async generateQrCode(otpauthUrl) {
        return qrcode_1.default.toDataURL(otpauthUrl);
    }
    /**
     * Verify token against secret (stateless)
     */
    verifyToken(secret, token) {
        try {
            return otplib_1.authenticator.check(token, secret);
        }
        catch (error) {
            logger_1.logger.error('Error verifying token:', error);
            return false;
        }
    }
    /**
     * Verify TOTP token
     */
    async verifyTOTPToken(userId, token) {
        try {
            const storedData = await this.redis.get(`2fa:totp:${userId}`);
            if (!storedData) {
                return false;
            }
            const { secret } = JSON.parse(storedData);
            const verified = otplib_1.authenticator.check(token, secret);
            if (verified) {
                logger_1.logger.info('TOTP token verified successfully', { userId });
            }
            else {
                logger_1.logger.warn('TOTP token verification failed', { userId });
            }
            return verified;
        }
        catch (error) {
            logger_1.logger.error('Error verifying TOTP token:', { userId, error });
            return false;
        }
    }
    /**
     * Verify backup code
     */
    async verifyBackupCode(userId, code) {
        try {
            const storedData = await this.redis.get(`2fa:totp:${userId}`);
            if (!storedData) {
                return false;
            }
            const { backupCodes } = JSON.parse(storedData);
            // Find matching unused backup code
            const backupCode = backupCodes.find((bc) => bc.code === code && !bc.used);
            if (!backupCode) {
                logger_1.logger.warn('Invalid or already used backup code', { userId });
                return false;
            }
            // Mark backup code as used
            backupCode.used = true;
            backupCode.usedAt = new Date();
            // Update stored data
            await this.redis.setEx(`2fa:totp:${userId}`, 24 * 60 * 60, JSON.stringify({
                secret: JSON.parse(storedData).secret,
                backupCodes,
            }));
            logger_1.logger.info('Backup code used successfully', { userId });
            return true;
        }
        catch (error) {
            logger_1.logger.error('Error verifying backup code:', { userId, error });
            return false;
        }
    }
    /**
     * Send SMS verification code
     */
    async sendSMSCode(userId, phoneNumber) {
        try {
            const code = this.generateVerificationCode();
            // Store verification data
            const verificationData = {
                userId,
                method: 'sms',
                code,
                expiresAt: new Date(Date.now() + this.codeExpiry),
                attempts: 0,
            };
            await this.redis.setEx(`2fa:sms:${userId}`, this.codeExpiry / 1000, JSON.stringify(verificationData));
            // Send SMS (integrate with your SMS service)
            const success = await this.sendSMS(phoneNumber, code);
            if (success) {
                logger_1.logger.info('SMS verification code sent', { userId, phoneNumber });
            }
            else {
                logger_1.logger.error('Failed to send SMS verification code', { userId, phoneNumber });
            }
            return success;
        }
        catch (error) {
            logger_1.logger.error('Error sending SMS code:', { userId, error });
            return false;
        }
    }
    /**
     * Send email verification code
     */
    async sendEmailCode(userId, email) {
        try {
            const code = this.generateVerificationCode();
            // Store verification data
            const verificationData = {
                userId,
                method: 'email',
                code,
                expiresAt: new Date(Date.now() + this.codeExpiry),
                attempts: 0,
            };
            await this.redis.setEx(`2fa:email:${userId}`, this.codeExpiry / 1000, JSON.stringify(verificationData));
            // Send email (integrate with your email service)
            const success = await this.sendEmail(email, code);
            if (success) {
                logger_1.logger.info('Email verification code sent', { userId, email });
            }
            else {
                logger_1.logger.error('Failed to send email verification code', { userId, email });
            }
            return success;
        }
        catch (error) {
            logger_1.logger.error('Error sending email code:', { userId, error });
            return false;
        }
    }
    /**
     * Verify SMS/Email code
     */
    async verifyCode(userId, method, code) {
        try {
            const key = `2fa:${method}:${userId}`;
            const storedData = await this.redis.get(key);
            if (!storedData) {
                return false;
            }
            const verificationData = JSON.parse(storedData);
            // Check if expired
            if (new Date() > verificationData.expiresAt) {
                await this.redis.del(key);
                return false;
            }
            // Check attempts
            if (verificationData.attempts >= this.maxAttempts) {
                await this.redis.del(key);
                logger_1.logger.warn('Too many verification attempts', { userId, method });
                return false;
            }
            // Verify code
            const isValid = verificationData.code === code;
            if (!isValid) {
                verificationData.attempts++;
                await this.redis.setEx(key, Math.ceil((verificationData.expiresAt.getTime() - Date.now()) / 1000), JSON.stringify(verificationData));
                logger_1.logger.warn('Invalid verification code', {
                    userId,
                    method,
                    attempts: verificationData.attempts,
                });
                return false;
            }
            // Remove verification data after successful verification
            await this.redis.del(key);
            logger_1.logger.info('Verification code verified successfully', { userId, method });
            return true;
        }
        catch (error) {
            logger_1.logger.error('Error verifying code:', { userId, method, error });
            return false;
        }
    }
    /**
     * Enable 2FA for user
     */
    async enableTwoFactor(userId, method, details) {
        try {
            const twoFactorData = {
                enabled: true,
                method,
                details: details || {},
                enabledAt: new Date(),
                lastUsed: new Date(),
            };
            await this.redis.setEx(`2fa:user:${userId}`, 365 * 24 * 60 * 60, // 1 year
            JSON.stringify(twoFactorData));
            logger_1.logger.info('2FA enabled for user', { userId, method });
            return true;
        }
        catch (error) {
            logger_1.logger.error('Error enabling 2FA:', { userId, method, error });
            return false;
        }
    }
    /**
     * Disable 2FA for user
     */
    async disableTwoFactor(userId) {
        try {
            await this.redis.del(`2fa:user:${userId}`);
            await this.redis.del(`2fa:totp:${userId}`);
            logger_1.logger.info('2FA disabled for user', { userId });
            return true;
        }
        catch (error) {
            logger_1.logger.error('Error disabling 2FA:', { userId, error });
            return false;
        }
    }
    /**
     * Check if 2FA is enabled for user
     */
    async isTwoFactorEnabled(userId) {
        try {
            const data = await this.redis.get(`2fa:user:${userId}`);
            return data ? JSON.parse(data).enabled : false;
        }
        catch (error) {
            logger_1.logger.error('Error checking 2FA status:', { userId, error });
            return false;
        }
    }
    /**
     * Get user's 2FA settings
     */
    async getTwoFactorSettings(userId) {
        try {
            const userData = await this.redis.get(`2fa:user:${userId}`);
            const totpData = await this.redis.get(`2fa:totp:${userId}`);
            if (!userData) {
                return null;
            }
            const userSettings = JSON.parse(userData);
            if (totpData && userSettings.method === 'totp') {
                const { backupCodes } = JSON.parse(totpData);
                userSettings.backupCodes = backupCodes.filter((bc) => !bc.used).length;
            }
            return userSettings;
        }
        catch (error) {
            logger_1.logger.error('Error getting 2FA settings:', { userId, error });
            return null;
        }
    }
    /**
     * Regenerate backup codes
     */
    async regenerateBackupCodes(userId) {
        try {
            const storedData = await this.redis.get(`2fa:totp:${userId}`);
            if (!storedData) {
                throw new Error('TOTP not set up for user');
            }
            const { secret } = JSON.parse(storedData);
            const newBackupCodes = this.generateBackupCodes();
            // Update stored data
            await this.redis.setEx(`2fa:totp:${userId}`, 24 * 60 * 60, JSON.stringify({
                secret,
                backupCodes: newBackupCodes.map(code => ({
                    code,
                    used: false,
                    createdAt: new Date(),
                })),
            }));
            logger_1.logger.info('Backup codes regenerated', { userId });
            return newBackupCodes;
        }
        catch (error) {
            logger_1.logger.error('Error regenerating backup codes:', { userId, error });
            throw error;
        }
    }
    /**
     * Generate backup codes
     */
    generateBackupCodes() {
        const codes = [];
        for (let i = 0; i < this.backupCodeCount; i++) {
            codes.push(crypto_1.default.randomBytes(4).toString('hex').toUpperCase());
        }
        return codes;
    }
    /**
     * Generate verification code
     */
    generateVerificationCode() {
        return Math.floor(100000 + Math.random() * 900000).toString();
    }
    /**
     * Send SMS (placeholder - integrate with your SMS service)
     */
    async sendSMS(phoneNumber, code) {
        try {
            // Integrate with your SMS service (Twilio, AWS SNS, etc.)
            // For now, just log the code
            logger_1.logger.info('SMS code (for development):', { phoneNumber, code });
            // Example with Twilio:
            /*
            const twilio = require('twilio');
            const client = twilio(process.env.TWILIO_ACCOUNT_SID, process.env.TWILIO_AUTH_TOKEN);
      
            await client.messages.create({
              body: `Your AIGestion verification code is: ${code}`,
              from: process.env.TWILIO_PHONE_NUMBER,
              to: phoneNumber
            });
            */
            return true;
        }
        catch (error) {
            logger_1.logger.error('Error sending SMS:', { phoneNumber, error });
            return false;
        }
    }
    /**
     * Send email (placeholder - integrate with your email service)
     */
    async sendEmail(email, code) {
        try {
            // Integrate with your email service (Nodemailer, SendGrid, etc.)
            // For now, just log the code
            logger_1.logger.info('Email code (for development):', { email, code });
            // Example with Nodemailer:
            /*
            const nodemailer = require('nodemailer');
            const transporter = nodemailer.createTransporter({
              service: 'gmail',
              auth: {
                user: process.env.EMAIL_USER,
                pass: process.env.EMAIL_PASS
              }
            });
      
            await transporter.sendMail({
              from: process.env.EMAIL_USER,
              to: email,
              subject: 'AIGestion Verification Code',
              text: `Your verification code is: ${code}`,
              html: `<p>Your verification code is: <strong>${code}</strong></p>`
            });
            */
            return true;
        }
        catch (error) {
            logger_1.logger.error('Error sending email:', { email, error });
            return false;
        }
    }
    /**
     * Cleanup expired verification codes
     */
    async cleanupExpiredCodes() {
        try {
            const smsKeys = await this.redis.keys('2fa:sms:*');
            const emailKeys = await this.redis.keys('2fa:email:*');
            for (const key of [...smsKeys, ...emailKeys]) {
                const data = await this.redis.get(key);
                if (data) {
                    const verificationData = JSON.parse(data);
                    if (new Date() > verificationData.expiresAt) {
                        await this.redis.del(key);
                    }
                }
            }
            logger_1.logger.info('Expired verification codes cleaned up');
        }
        catch (error) {
            logger_1.logger.error('Error cleaning up expired codes:', error);
        }
    }
    /**
     * Get 2FA statistics
     */
    async getStats() {
        try {
            const userKeys = await this.redis.keys('2fa:user:*');
            const totalUsers = userKeys.length;
            let enabledUsers = 0;
            const methodDistribution = {};
            for (const key of userKeys) {
                const data = await this.redis.get(key);
                if (data) {
                    const settings = JSON.parse(data);
                    if (settings.enabled) {
                        enabledUsers++;
                        methodDistribution[settings.method] = (methodDistribution[settings.method] || 0) + 1;
                    }
                }
            }
            // Count recent verifications (last hour)
            const recentKeys = await this.redis.keys('2fa:*');
            const recentVerifications = recentKeys.filter(key => key.includes('sms:') || key.includes('email:')).length;
            return {
                totalUsers,
                enabledUsers,
                methodDistribution,
                recentVerifications,
            };
        }
        catch (error) {
            logger_1.logger.error('Error getting 2FA stats:', error);
            return {
                totalUsers: 0,
                enabledUsers: 0,
                methodDistribution: {},
                recentVerifications: 0,
            };
        }
    }
};
exports.TwoFactorService = TwoFactorService;
exports.TwoFactorService = TwoFactorService = __decorate([
    (0, inversify_1.injectable)(),
    __metadata("design:paramtypes", [])
], TwoFactorService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxzZXJ2aWNlc1xcdHdvLWZhY3Rvci5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7OztBQUFBLG9EQUE0QjtBQUM1Qix5Q0FBdUM7QUFFdkMsb0RBQTRCO0FBQzVCLG1DQUF1QztBQUN2QywwQ0FBZ0Q7QUFDaEQsNENBQXlDO0FBeUJsQyxJQUFNLGdCQUFnQixHQUF0QixNQUFNLGdCQUFnQjtJQUNWLEtBQUssQ0FBa0I7SUFDdkIsVUFBVSxHQUFHLENBQUMsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUMsWUFBWTtJQUN4QyxXQUFXLEdBQUcsQ0FBQyxDQUFDO0lBQ2hCLGVBQWUsR0FBRyxFQUFFLENBQUM7SUFFdEM7UUFDRSxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUEsc0JBQWMsR0FBRSxDQUFDO0lBQ2hDLENBQUM7SUFFRDs7T0FFRztJQUNJLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxNQUFjLEVBQUUsS0FBYTtRQUMzRCxJQUFJLENBQUM7WUFDSCxrQkFBa0I7WUFDbEIsTUFBTSxNQUFNLEdBQUcsc0JBQWEsQ0FBQyxjQUFjLEVBQUUsQ0FBQztZQUM5QyxNQUFNLFVBQVUsR0FBRyxzQkFBYSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxDQUFDLENBQUM7WUFFN0UsbUJBQW1CO1lBQ25CLE1BQU0sU0FBUyxHQUFHLE1BQU0sSUFBSSxDQUFDLGNBQWMsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUV4RCx3QkFBd0I7WUFDeEIsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7WUFFL0MsaUJBQWlCO1lBQ2pCLE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQ3BCLFlBQVksTUFBTSxFQUFFLEVBQ3BCLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFLFdBQVc7WUFDekIsSUFBSSxDQUFDLFNBQVMsQ0FBQztnQkFD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USxDQUFDLFFBQVEsQ0FBQyxDQUN0RCxDQUFDLE1BQU0sQ0FBQztZQUVULE9BQU87Z0JBQ0wsVUFBVTtnQkFDVixZQUFZO2dCQUNaLGtCQUFrQjtnQkFDbEIsbUJBQW1CO2FBQ3BCLENBQUM7UUFDSixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLGVBQU0sQ0FBQyxLQUFLLENBQUMsMEJBQTBCLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDaEQsT0FBTztnQkFDTCxVQUFVLEVBQUUsQ0FBQztnQkFDYixZQUFZLEVBQUUsQ0FBQztnQkFDZixrQkFBa0IsRUFBRSxFQUFFO2dCQUN0QixtQkFBbUIsRUFBRSxDQUFDO2FBQ3ZCLENBQUM7UUFDSixDQUFDO0lBQ0gsQ0FBQztDQUNGLENBQUE7QUF0aUJZLDRDQUFnQjsyQkFBaEIsZ0JBQWdCO0lBRDVCLElBQUEsc0JBQVUsR0FBRTs7R0FDQSxnQkFBZ0IsQ0FzaUI1QiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXEFsZWphbmRyb1xcQUlHZXN0aW9uXFxiYWNrZW5kXFxzcmNcXHNlcnZpY2VzXFx0d28tZmFjdG9yLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNyeXB0byBmcm9tICdjcnlwdG8nO1xuaW1wb3J0IHsgaW5qZWN0YWJsZSB9IGZyb20gJ2ludmVyc2lmeSc7XG5pbXBvcnQgdHlwZSB7IFJlZGlzQ2xpZW50VHlwZSB9IGZyb20gJ3JlZGlzJztcbmltcG9ydCBxcmNvZGUgZnJvbSAncXJjb2RlJztcbmltcG9ydCB7IGF1dGhlbnRpY2F0b3IgfSBmcm9tICdvdHBsaWInO1xuaW1wb3J0IHsgZ2V0UmVkaXNDbGllbnQgfSBmcm9tICcuLi9jYWNoZS9yZWRpcyc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuLi91dGlscy9sb2dnZXInO1xuXG5pbnRlcmZhY2UgVE9UUFNldHVwIHtcbiAgc2VjcmV0OiBzdHJpbmc7XG4gIHFyQ29kZTogc3RyaW5nO1xuICBiYWNrdXBDb2Rlczogc3RyaW5nW107XG4gIG1hbnVhbEVudHJ5S2V5OiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBUd29GYWN0b3JWZXJpZmljYXRpb24ge1xuICB1c2VySWQ6IHN0cmluZztcbiAgbWV0aG9kOiAndG90cCcgfCAnc21zJyB8ICdlbWFpbCcgfCAnYmFja3VwJztcbiAgY29kZTogc3RyaW5nO1xuICBleHBpcmVzQXQ6IERhdGU7XG4gIGF0dGVtcHRzOiBudW1iZXI7XG59XG5cbmludGVyZmFjZSBCYWNrdXBDb2RlIHtcbiAgY29kZTogc3RyaW5nO1xuICB1c2VkOiBib29sZWFuO1xuICB1c2VkQXQ/OiBEYXRlO1xuICBjcmVhdGVkQXQ6IERhdGU7XG59XG5cbkBpbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBUd29GYWN0b3JTZXJ2aWNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSByZWRpczogUmVkaXNDbGllbnRUeXBlO1xuICBwcml2YXRlIHJlYWRvbmx5IGNvZGVFeHBpcnkgPSA1ICogNjAgKiAxMDAwOyAvLyA1IG1pbnV0ZXNcbiAgcHJpdmF0ZSByZWFkb25seSBtYXhBdHRlbXB0cyA9IDM7XG4gIHByaXZhdGUgcmVhZG9ubHkgYmFja3VwQ29kZUNvdW50ID0gMTA7XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5yZWRpcyA9IGdldFJlZGlzQ2xpZW50KCk7XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGUgVE9UUCBzZWNyZXQgYW5kIFFSIGNvZGUgZm9yIHVzZXJcbiAgICovXG4gIHB1YmxpYyBhc3luYyBnZW5lcmF0ZVRPVFBTZWNyZXQodXNlcklkOiBzdHJpbmcsIGVtYWlsOiBzdHJpbmcpOiBQcm9taXNlPFRPVFBTZXR1cD4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBHZW5lcmF0ZSBzZWNyZXRcbiAgICAgIGNvbnN0IHNlY3JldCA9IGF1dGhlbnRpY2F0b3IuZ2VuZXJhdGVTZWNyZXQoKTtcbiAgICAgIGNvbnN0IG90cGF1dGhVcmwgPSBhdXRoZW50aWNhdG9yLmtleXVyaShlbWFpbCwgJ0FJR2VzdGlvbiBORVhVUyBWMScsIHNlY3JldCk7XG5cbiAgICAgIC8vIEdlbmVyYXRlIFFSIGNvZGVcbiAgICAgIGNvbnN0IHFyQ29kZVVybCA9IGF3YWl0IHRoaXMuZ2VuZXJhdGVRckNvZGUob3RwYXV0aFVybCk7XG5cbiAgICAgIC8vIEdlbmVyYXRlIGJhY2t1cCBjb2Rlc1xuICAgICAgY29uc3QgYmFja3VwQ29kZXMgPSB0aGlzLmdlbmVyYXRlQmFja3VwQ29kZXMoKTtcblxuICAgICAgLy8gU3RvcmUgaW4gUmVkaXNcbiAgICAgIGF3YWl0IHRoaXMucmVkaXMuc2V0RXgoXG4gICAgICAgIGAyZmE6dG90cDoke3VzZXJJZH1gLFxuICAgICAgICAyNCAqIDYwICogNjAsIC8vIDI0IGhvdXJzXG4gICAgICAgIEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICBzZWNyZXQ6IHNlY3JldCxcbiAgICAgICAgICBiYWNrdXBDb2RlczogYmFja3VwQ29kZXMubWFwKGNvZGUgPT4gKHtcbiAgICAgICAgICAgIGNvZGUsXG4gICAgICAgICAgICB1c2VkOiBmYWxzZSxcbiAgICAgICAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgICAgICB9KSksXG4gICAgICAgIH0pLFxuICAgICAgKTtcblxuICAgICAgbG9nZ2VyLmluZm8oJ1RPVFAgc2VjcmV0IGdlbmVyYXRlZCcsIHsgdXNlcklkLCBlbWFpbCB9KTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc2VjcmV0OiBzZWNyZXQsXG4gICAgICAgIHFyQ29kZTogcXJDb2RlVXJsLFxuICAgICAgICBiYWNrdXBDb2RlcyxcbiAgICAgICAgbWFudWFsRW50cnlLZXk6IHNlY3JldCxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignRXJyb3IgZ2VuZXJhdGluZyBUT1RQIHNlY3JldDonLCB7IHVzZXJJZCwgZXJyb3IgfSk7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBnZW5lcmF0ZSBUT1RQIHNlY3JldCcpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZW5lcmF0ZSBRUiBjb2RlIGZyb20gYW4gb3RwYXV0aCBVUkxcbiAgICovXG4gIHB1YmxpYyBhc3luYyBnZW5lcmF0ZVFyQ29kZShvdHBhdXRoVXJsOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHJldHVybiBxcmNvZGUudG9EYXRhVVJMKG90cGF1dGhVcmwpO1xuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmeSB0b2tlbiBhZ2FpbnN0IHNlY3JldCAoc3RhdGVsZXNzKVxuICAgKi9cbiAgcHVibGljIHZlcmlmeVRva2VuKHNlY3JldDogc3RyaW5nLCB0b2tlbjogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhdXRoZW50aWNhdG9yLmNoZWNrKHRva2VuLCBzZWNyZXQpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIHZlcmlmeWluZyB0b2tlbjonLCBlcnJvcik7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmeSBUT1RQIHRva2VuXG4gICAqL1xuICBwdWJsaWMgYXN5bmMgdmVyaWZ5VE9UUFRva2VuKHVzZXJJZDogc3RyaW5nLCB0b2tlbjogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHN0b3JlZERhdGEgPSBhd2FpdCB0aGlzLnJlZGlzLmdldChgMmZhOnRvdHA6JHt1c2VySWR9YCk7XG4gICAgICBpZiAoIXN0b3JlZERhdGEpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB7IHNlY3JldCB9ID0gSlNPTi5wYXJzZShzdG9yZWREYXRhKTtcblxuICAgICAgY29uc3QgdmVyaWZpZWQgPSBhdXRoZW50aWNhdG9yLmNoZWNrKHRva2VuLCBzZWNyZXQpO1xuXG4gICAgICBpZiAodmVyaWZpZWQpIHtcbiAgICAgICAgbG9nZ2VyLmluZm8oJ1RPVFAgdG9rZW4gdmVyaWZpZWQgc3VjY2Vzc2Z1bGx5JywgeyB1c2VySWQgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2dnZXIud2FybignVE9UUCB0b2tlbiB2ZXJpZmljYXRpb24gZmFpbGVkJywgeyB1c2VySWQgfSk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB2ZXJpZmllZDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdFcnJvciB2ZXJpZnlpbmcgVE9UUCB0b2tlbjonLCB7IHVzZXJJZCwgZXJyb3IgfSk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmeSBiYWNrdXAgY29kZVxuICAgKi9cbiAgcHVibGljIGFzeW5jIHZlcmlmeUJhY2t1cENvZGUodXNlcklkOiBzdHJpbmcsIGNvZGU6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBzdG9yZWREYXRhID0gYXdhaXQgdGhpcy5yZWRpcy5nZXQoYDJmYTp0b3RwOiR7dXNlcklkfWApO1xuICAgICAgaWYgKCFzdG9yZWREYXRhKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgeyBiYWNrdXBDb2RlcyB9ID0gSlNPTi5wYXJzZShzdG9yZWREYXRhKTtcblxuICAgICAgLy8gRmluZCBtYXRjaGluZyB1bnVzZWQgYmFja3VwIGNvZGVcbiAgICAgIGNvbnN0IGJhY2t1cENvZGUgPSBiYWNrdXBDb2Rlcy5maW5kKChiYzogQmFja3VwQ29kZSkgPT4gYmMuY29kZSA9PT0gY29kZSAmJiAhYmMudXNlZCk7XG5cbiAgICAgIGlmICghYmFja3VwQ29kZSkge1xuICAgICAgICBsb2dnZXIud2FybignSW52YWxpZCBvciBhbHJlYWR5IHVzZWQgYmFja3VwIGNvZGUnLCB7IHVzZXJJZCB9KTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuXG4gICAgICAvLyBNYXJrIGJhY2t1cCBjb2RlIGFzIHVzZWRcbiAgICAgIGJhY2t1cENvZGUudXNlZCA9IHRydWU7XG4gICAgICBiYWNrdXBDb2RlLnVzZWRBdCA9IG5ldyBEYXRlKCk7XG5cbiAgICAgIC8vIFVwZGF0ZSBzdG9yZWQgZGF0YVxuICAgICAgYXdhaXQgdGhpcy5yZWRpcy5zZXRFeChcbiAgICAgICAgYDJmYTp0b3RwOiR7dXNlcklkfWAsXG4gICAgICAgIDI0ICogNjAgKiA2MCxcbiAgICAgICAgSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgIHNlY3JldDogSlNPTi5wYXJzZShzdG9yZWREYXRhKS5zZWNyZXQsXG4gICAgICAgICAgYmFja3VwQ29kZXMsXG4gICAgICAgIH0pLFxuICAgICAgKTtcblxuICAgICAgbG9nZ2VyLmluZm8oJ0JhY2t1cCBjb2RlIHVzZWQgc3VjY2Vzc2Z1bGx5JywgeyB1c2VySWQgfSk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdFcnJvciB2ZXJpZnlpbmcgYmFja3VwIGNvZGU6JywgeyB1c2VySWQsIGVycm9yIH0pO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTZW5kIFNNUyB2ZXJpZmljYXRpb24gY29kZVxuICAgKi9cbiAgcHVibGljIGFzeW5jIHNlbmRTTVNDb2RlKHVzZXJJZDogc3RyaW5nLCBwaG9uZU51bWJlcjogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGNvZGUgPSB0aGlzLmdlbmVyYXRlVmVyaWZpY2F0aW9uQ29kZSgpO1xuXG4gICAgICAvLyBTdG9yZSB2ZXJpZmljYXRpb24gZGF0YVxuICAgICAgY29uc3QgdmVyaWZpY2F0aW9uRGF0YTogVHdvRmFjdG9yVmVyaWZpY2F0aW9uID0ge1xuICAgICAgICB1c2VySWQsXG4gICAgICAgIG1ldGhvZDogJ3NtcycsXG4gICAgICAgIGNvZGUsXG4gICAgICAgIGV4cGlyZXNBdDogbmV3IERhdGUoRGF0ZS5ub3coKSArIHRoaXMuY29kZUV4cGlyeSksXG4gICAgICAgIGF0dGVtcHRzOiAwLFxuICAgICAgfTtcblxuICAgICAgYXdhaXQgdGhpcy5yZWRpcy5zZXRFeChcbiAgICAgICAgYDJmYTpzbXM6JHt1c2VySWR9YCxcbiAgICAgICAgdGhpcy5jb2RlRXhwaXJ5IC8gMTAwMCxcbiAgICAgICAgSlNPTi5zdHJpbmdpZnkodmVyaWZpY2F0aW9uRGF0YSksXG4gICAgICApO1xuXG4gICAgICAvLyBTZW5kIFNNUyAoaW50ZWdyYXRlIHdpdGggeW91ciBTTVMgc2VydmljZSlcbiAgICAgIGNvbnN0IHN1Y2Nlc3MgPSBhd2FpdCB0aGlzLnNlbmRTTVMocGhvbmVOdW1iZXIsIGNvZGUpO1xuXG4gICAgICBpZiAoc3VjY2Vzcykge1xuICAgICAgICBsb2dnZXIuaW5mbygnU01TIHZlcmlmaWNhdGlvbiBjb2RlIHNlbnQnLCB7IHVzZXJJZCwgcGhvbmVOdW1iZXIgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byBzZW5kIFNNUyB2ZXJpZmljYXRpb24gY29kZScsIHsgdXNlcklkLCBwaG9uZU51bWJlciB9KTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHN1Y2Nlc3M7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignRXJyb3Igc2VuZGluZyBTTVMgY29kZTonLCB7IHVzZXJJZCwgZXJyb3IgfSk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNlbmQgZW1haWwgdmVyaWZpY2F0aW9uIGNvZGVcbiAgICovXG4gIHB1YmxpYyBhc3luYyBzZW5kRW1haWxDb2RlKHVzZXJJZDogc3RyaW5nLCBlbWFpbDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGNvZGUgPSB0aGlzLmdlbmVyYXRlVmVyaWZpY2F0aW9uQ29kZSgpO1xuXG4gICAgICAvLyBTdG9yZSB2ZXJpZmljYXRpb24gZGF0YVxuICAgICAgY29uc3QgdmVyaWZpY2F0aW9uRGF0YTogVHdvRmFjdG9yVmVyaWZpY2F0aW9uID0ge1xuICAgICAgICB1c2VySWQsXG4gICAgICAgIG1ldGhvZDogJ2VtYWlsJyxcbiAgICAgICAgY29kZSxcbiAgICAgICAgZXhwaXJlc0F0OiBuZXcgRGF0ZShEYXRlLm5vdygpICsgdGhpcy5jb2RlRXhwaXJ5KSxcbiAgICAgICAgYXR0ZW1wdHM6IDAsXG4gICAgICB9O1xuXG4gICAgICBhd2FpdCB0aGlzLnJlZGlzLnNldEV4KFxuICAgICAgICBgMmZhOmVtYWlsOiR7dXNlcklkfWAsXG4gICAgICAgIHRoaXMuY29kZUV4cGlyeSAvIDEwMDAsXG4gICAgICAgIEpTT04uc3RyaW5naWZ5KHZlcmlmaWNhdGlvbkRhdGEpLFxuICAgICAgKTtcblxuICAgICAgLy8gU2VuZCBlbWFpbCAoaW50ZWdyYXRlIHdpdGggeW91ciBlbWFpbCBzZXJ2aWNlKVxuICAgICAgY29uc3Qgc3VjY2VzcyA9IGF3YWl0IHRoaXMuc2VuZEVtYWlsKGVtYWlsLCBjb2RlKTtcblxuICAgICAgaWYgKHN1Y2Nlc3MpIHtcbiAgICAgICAgbG9nZ2VyLmluZm8oJ0VtYWlsIHZlcmlmaWNhdGlvbiBjb2RlIHNlbnQnLCB7IHVzZXJJZCwgZW1haWwgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byBzZW5kIGVtYWlsIHZlcmlmaWNhdGlvbiBjb2RlJywgeyB1c2VySWQsIGVtYWlsIH0pO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gc3VjY2VzcztcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdFcnJvciBzZW5kaW5nIGVtYWlsIGNvZGU6JywgeyB1c2VySWQsIGVycm9yIH0pO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZnkgU01TL0VtYWlsIGNvZGVcbiAgICovXG4gIHB1YmxpYyBhc3luYyB2ZXJpZnlDb2RlKHVzZXJJZDogc3RyaW5nLCBtZXRob2Q6ICdzbXMnIHwgJ2VtYWlsJywgY29kZTogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGtleSA9IGAyZmE6JHttZXRob2R9OiR7dXNlcklkfWA7XG4gICAgICBjb25zdCBzdG9yZWREYXRhID0gYXdhaXQgdGhpcy5yZWRpcy5nZXQoa2V5KTtcblxuICAgICAgaWYgKCFzdG9yZWREYXRhKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgdmVyaWZpY2F0aW9uRGF0YTogVHdvRmFjdG9yVmVyaWZpY2F0aW9uID0gSlNPTi5wYXJzZShzdG9yZWREYXRhKTtcblxuICAgICAgLy8gQ2hlY2sgaWYgZXhwaXJlZFxuICAgICAgaWYgKG5ldyBEYXRlKCkgPiB2ZXJpZmljYXRpb25EYXRhLmV4cGlyZXNBdCkge1xuICAgICAgICBhd2FpdCB0aGlzLnJlZGlzLmRlbChrZXkpO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG5cbiAgICAgIC8vIENoZWNrIGF0dGVtcHRzXG4gICAgICBpZiAodmVyaWZpY2F0aW9uRGF0YS5hdHRlbXB0cyA+PSB0aGlzLm1heEF0dGVtcHRzKSB7XG4gICAgICAgIGF3YWl0IHRoaXMucmVkaXMuZGVsKGtleSk7XG4gICAgICAgIGxvZ2dlci53YXJuKCdUb28gbWFueSB2ZXJpZmljYXRpb24gYXR0ZW1wdHMnLCB7IHVzZXJJZCwgbWV0aG9kIH0pO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG5cbiAgICAgIC8vIFZlcmlmeSBjb2RlXG4gICAgICBjb25zdCBpc1ZhbGlkID0gdmVyaWZpY2F0aW9uRGF0YS5jb2RlID09PSBjb2RlO1xuXG4gICAgICBpZiAoIWlzVmFsaWQpIHtcbiAgICAgICAgdmVyaWZpY2F0aW9uRGF0YS5hdHRlbXB0cysrO1xuICAgICAgICBhd2FpdCB0aGlzLnJlZGlzLnNldEV4KFxuICAgICAgICAgIGtleSxcbiAgICAgICAgICBNYXRoLmNlaWwoKHZlcmlmaWNhdGlvbkRhdGEuZXhwaXJlc0F0LmdldFRpbWUoKSAtIERhdGUubm93KCkpIC8gMTAwMCksXG4gICAgICAgICAgSlNPTi5zdHJpbmdpZnkodmVyaWZpY2F0aW9uRGF0YSksXG4gICAgICAgICk7XG5cbiAgICAgICAgbG9nZ2VyLndhcm4oJ0ludmFsaWQgdmVyaWZpY2F0aW9uIGNvZGUnLCB7XG4gICAgICAgICAgdXNlcklkLFxuICAgICAgICAgIG1ldGhvZCxcbiAgICAgICAgICBhdHRlbXB0czogdmVyaWZpY2F0aW9uRGF0YS5hdHRlbXB0cyxcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cblxuICAgICAgLy8gUmVtb3ZlIHZlcmlmaWNhdGlvbiBkYXRhIGFmdGVyIHN1Y2Nlc3NmdWwgdmVyaWZpY2F0aW9uXG4gICAgICBhd2FpdCB0aGlzLnJlZGlzLmRlbChrZXkpO1xuXG4gICAgICBsb2dnZXIuaW5mbygnVmVyaWZpY2F0aW9uIGNvZGUgdmVyaWZpZWQgc3VjY2Vzc2Z1bGx5JywgeyB1c2VySWQsIG1ldGhvZCB9KTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIHZlcmlmeWluZyBjb2RlOicsIHsgdXNlcklkLCBtZXRob2QsIGVycm9yIH0pO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBFbmFibGUgMkZBIGZvciB1c2VyXG4gICAqL1xuICBwdWJsaWMgYXN5bmMgZW5hYmxlVHdvRmFjdG9yKFxuICAgIHVzZXJJZDogc3RyaW5nLFxuICAgIG1ldGhvZDogJ3RvdHAnIHwgJ3NtcycgfCAnZW1haWwnLFxuICAgIGRldGFpbHM/OiBhbnksXG4gICk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB0d29GYWN0b3JEYXRhID0ge1xuICAgICAgICBlbmFibGVkOiB0cnVlLFxuICAgICAgICBtZXRob2QsXG4gICAgICAgIGRldGFpbHM6IGRldGFpbHMgfHwge30sXG4gICAgICAgIGVuYWJsZWRBdDogbmV3IERhdGUoKSxcbiAgICAgICAgbGFzdFVzZWQ6IG5ldyBEYXRlKCksXG4gICAgICB9O1xuXG4gICAgICBhd2FpdCB0aGlzLnJlZGlzLnNldEV4KFxuICAgICAgICBgMmZhOnVzZXI6JHt1c2VySWR9YCxcbiAgICAgICAgMzY1ICogMjQgKiA2MCAqIDYwLCAvLyAxIHllYXJcbiAgICAgICAgSlNPTi5zdHJpbmdpZnkodHdvRmFjdG9yRGF0YSksXG4gICAgICApO1xuXG4gICAgICBsb2dnZXIuaW5mbygnMkZBIGVuYWJsZWQgZm9yIHVzZXInLCB7IHVzZXJJZCwgbWV0aG9kIH0pO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignRXJyb3IgZW5hYmxpbmcgMkZBOicsIHsgdXNlcklkLCBtZXRob2QsIGVycm9yIH0pO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBEaXNhYmxlIDJGQSBmb3IgdXNlclxuICAgKi9cbiAgcHVibGljIGFzeW5jIGRpc2FibGVUd29GYWN0b3IodXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5yZWRpcy5kZWwoYDJmYTp1c2VyOiR7dXNlcklkfWApO1xuICAgICAgYXdhaXQgdGhpcy5yZWRpcy5kZWwoYDJmYTp0b3RwOiR7dXNlcklkfWApO1xuXG4gICAgICBsb2dnZXIuaW5mbygnMkZBIGRpc2FibGVkIGZvciB1c2VyJywgeyB1c2VySWQgfSk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdFcnJvciBkaXNhYmxpbmcgMkZBOicsIHsgdXNlcklkLCBlcnJvciB9KTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2sgaWYgMkZBIGlzIGVuYWJsZWQgZm9yIHVzZXJcbiAgICovXG4gIHB1YmxpYyBhc3luYyBpc1R3b0ZhY3RvckVuYWJsZWQodXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHRoaXMucmVkaXMuZ2V0KGAyZmE6dXNlcjoke3VzZXJJZH1gKTtcbiAgICAgIHJldHVybiBkYXRhID8gSlNPTi5wYXJzZShkYXRhKS5lbmFibGVkIDogZmFsc2U7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignRXJyb3IgY2hlY2tpbmcgMkZBIHN0YXR1czonLCB7IHVzZXJJZCwgZXJyb3IgfSk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEdldCB1c2VyJ3MgMkZBIHNldHRpbmdzXG4gICAqL1xuICBwdWJsaWMgYXN5bmMgZ2V0VHdvRmFjdG9yU2V0dGluZ3ModXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPGFueT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB1c2VyRGF0YSA9IGF3YWl0IHRoaXMucmVkaXMuZ2V0KGAyZmE6dXNlcjoke3VzZXJJZH1gKTtcbiAgICAgIGNvbnN0IHRvdHBEYXRhID0gYXdhaXQgdGhpcy5yZWRpcy5nZXQoYDJmYTp0b3RwOiR7dXNlcklkfWApO1xuXG4gICAgICBpZiAoIXVzZXJEYXRhKSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB1c2VyU2V0dGluZ3MgPSBKU09OLnBhcnNlKHVzZXJEYXRhKTtcblxuICAgICAgaWYgKHRvdHBEYXRhICYmIHVzZXJTZXR0aW5ncy5tZXRob2QgPT09ICd0b3RwJykge1xuICAgICAgICBjb25zdCB7IGJhY2t1cENvZGVzIH0gPSBKU09OLnBhcnNlKHRvdHBEYXRhKTtcbiAgICAgICAgdXNlclNldHRpbmdzLmJhY2t1cENvZGVzID0gYmFja3VwQ29kZXMuZmlsdGVyKChiYzogQmFja3VwQ29kZSkgPT4gIWJjLnVzZWQpLmxlbmd0aDtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHVzZXJTZXR0aW5ncztcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdFcnJvciBnZXR0aW5nIDJGQSBzZXR0aW5nczonLCB7IHVzZXJJZCwgZXJyb3IgfSk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmVnZW5lcmF0ZSBiYWNrdXAgY29kZXNcbiAgICovXG4gIHB1YmxpYyBhc3luYyByZWdlbmVyYXRlQmFja3VwQ29kZXModXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHN0b3JlZERhdGEgPSBhd2FpdCB0aGlzLnJlZGlzLmdldChgMmZhOnRvdHA6JHt1c2VySWR9YCk7XG4gICAgICBpZiAoIXN0b3JlZERhdGEpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUT1RQIG5vdCBzZXQgdXAgZm9yIHVzZXInKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgeyBzZWNyZXQgfSA9IEpTT04ucGFyc2Uoc3RvcmVkRGF0YSk7XG4gICAgICBjb25zdCBuZXdCYWNrdXBDb2RlcyA9IHRoaXMuZ2VuZXJhdGVCYWNrdXBDb2RlcygpO1xuXG4gICAgICAvLyBVcGRhdGUgc3RvcmVkIGRhdGFcbiAgICAgIGF3YWl0IHRoaXMucmVkaXMuc2V0RXgoXG4gICAgICAgIGAyZmE6dG90cDoke3VzZXJJZH1gLFxuICAgICAgICAyNCAqIDYwICogNjAsXG4gICAgICAgIEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICBzZWNyZXQsXG4gICAgICAgICAgYmFja3VwQ29kZXM6IG5ld0JhY2t1cENvZGVzLm1hcChjb2RlID0+ICh7XG4gICAgICAgICAgICBjb2RlLFxuICAgICAgICAgICAgdXNlZDogZmFsc2UsXG4gICAgICAgICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgICAgfSkpLFxuICAgICAgICB9KSxcbiAgICAgICk7XG5cbiAgICAgIGxvZ2dlci5pbmZvKCdCYWNrdXAgY29kZXMgcmVnZW5lcmF0ZWQnLCB7IHVzZXJJZCB9KTtcbiAgICAgIHJldHVybiBuZXdCYWNrdXBDb2RlcztcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdFcnJvciByZWdlbmVyYXRpbmcgYmFja3VwIGNvZGVzOicsIHsgdXNlcklkLCBlcnJvciB9KTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZW5lcmF0ZSBiYWNrdXAgY29kZXNcbiAgICovXG4gIHByaXZhdGUgZ2VuZXJhdGVCYWNrdXBDb2RlcygpOiBzdHJpbmdbXSB7XG4gICAgY29uc3QgY29kZXM6IHN0cmluZ1tdID0gW107XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmJhY2t1cENvZGVDb3VudDsgaSsrKSB7XG4gICAgICBjb2Rlcy5wdXNoKGNyeXB0by5yYW5kb21CeXRlcyg0KS50b1N0cmluZygnaGV4JykudG9VcHBlckNhc2UoKSk7XG4gICAgfVxuICAgIHJldHVybiBjb2RlcztcbiAgfVxuXG4gIC8qKlxuICAgKiBHZW5lcmF0ZSB2ZXJpZmljYXRpb24gY29kZVxuICAgKi9cbiAgcHJpdmF0ZSBnZW5lcmF0ZVZlcmlmaWNhdGlvbkNvZGUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gTWF0aC5mbG9vcigxMDAwMDAgKyBNYXRoLnJhbmRvbSgpICogOTAwMDAwKS50b1N0cmluZygpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNlbmQgU01TIChwbGFjZWhvbGRlciAtIGludGVncmF0ZSB3aXRoIHlvdXIgU01TIHNlcnZpY2UpXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIHNlbmRTTVMocGhvbmVOdW1iZXI6IHN0cmluZywgY29kZTogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIEludGVncmF0ZSB3aXRoIHlvdXIgU01TIHNlcnZpY2UgKFR3aWxpbywgQVdTIFNOUywgZXRjLilcbiAgICAgIC8vIEZvciBub3csIGp1c3QgbG9nIHRoZSBjb2RlXG4gICAgICBsb2dnZXIuaW5mbygnU01TIGNvZGUgKGZvciBkZXZlbG9wbWVudCk6JywgeyBwaG9uZU51bWJlciwgY29kZSB9KTtcblxuICAgICAgLy8gRXhhbXBsZSB3aXRoIFR3aWxpbzpcbiAgICAgIC8qXG4gICAgICBjb25zdCB0d2lsaW8gPSByZXF1aXJlKCd0d2lsaW8nKTtcbiAgICAgIGNvbnN0IGNsaWVudCA9IHR3aWxpbyhwcm9jZXNzLmVudi5UV0lMSU9fQUNDT1VOVF9TSUQsIHByb2Nlc3MuZW52LlRXSUxJT19BVVRIX1RPS0VOKTtcblxuICAgICAgYXdhaXQgY2xpZW50Lm1lc3NhZ2VzLmNyZWF0ZSh7XG4gICAgICAgIGJvZHk6IGBZb3VyIEFJR2VzdGlvbiB2ZXJpZmljYXRpb24gY29kZSBpczogJHtjb2RlfWAsXG4gICAgICAgIGZyb206IHByb2Nlc3MuZW52LlRXSUxJT19QSE9ORV9OVU1CRVIsXG4gICAgICAgIHRvOiBwaG9uZU51bWJlclxuICAgICAgfSk7XG4gICAgICAqL1xuXG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdFcnJvciBzZW5kaW5nIFNNUzonLCB7IHBob25lTnVtYmVyLCBlcnJvciB9KTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU2VuZCBlbWFpbCAocGxhY2Vob2xkZXIgLSBpbnRlZ3JhdGUgd2l0aCB5b3VyIGVtYWlsIHNlcnZpY2UpXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIHNlbmRFbWFpbChlbWFpbDogc3RyaW5nLCBjb2RlOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICB0cnkge1xuICAgICAgLy8gSW50ZWdyYXRlIHdpdGggeW91ciBlbWFpbCBzZXJ2aWNlIChOb2RlbWFpbGVyLCBTZW5kR3JpZCwgZXRjLilcbiAgICAgIC8vIEZvciBub3csIGp1c3QgbG9nIHRoZSBjb2RlXG4gICAgICBsb2dnZXIuaW5mbygnRW1haWwgY29kZSAoZm9yIGRldmVsb3BtZW50KTonLCB7IGVtYWlsLCBjb2RlIH0pO1xuXG4gICAgICAvLyBFeGFtcGxlIHdpdGggTm9kZW1haWxlcjpcbiAgICAgIC8qXG4gICAgICBjb25zdCBub2RlbWFpbGVyID0gcmVxdWlyZSgnbm9kZW1haWxlcicpO1xuICAgICAgY29uc3QgdHJhbnNwb3J0ZXIgPSBub2RlbWFpbGVyLmNyZWF0ZVRyYW5zcG9ydGVyKHtcbiAgICAgICAgc2VydmljZTogJ2dtYWlsJyxcbiAgICAgICAgYXV0aDoge1xuICAgICAgICAgIHVzZXI6IHByb2Nlc3MuZW52LkVNQUlMX1VTRVIsXG4gICAgICAgICAgcGFzczogcHJvY2Vzcy5lbnYuRU1BSUxfUEFTU1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgYXdhaXQgdHJhbnNwb3J0ZXIuc2VuZE1haWwoe1xuICAgICAgICBmcm9tOiBwcm9jZXNzLmVudi5FTUFJTF9VU0VSLFxuICAgICAgICB0bzogZW1haWwsXG4gICAgICAgIHN1YmplY3Q6ICdBSUdlc3Rpb24gVmVyaWZpY2F0aW9uIENvZGUnLFxuICAgICAgICB0ZXh0OiBgWW91ciB2ZXJpZmljYXRpb24gY29kZSBpczogJHtjb2RlfWAsXG4gICAgICAgIGh0bWw6IGA8cD5Zb3VyIHZlcmlmaWNhdGlvbiBjb2RlIGlzOiA8c3Ryb25nPiR7Y29kZX08L3N0cm9uZz48L3A+YFxuICAgICAgfSk7XG4gICAgICAqL1xuXG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdFcnJvciBzZW5kaW5nIGVtYWlsOicsIHsgZW1haWwsIGVycm9yIH0pO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDbGVhbnVwIGV4cGlyZWQgdmVyaWZpY2F0aW9uIGNvZGVzXG4gICAqL1xuICBwdWJsaWMgYXN5bmMgY2xlYW51cEV4cGlyZWRDb2RlcygpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgc21zS2V5cyA9IGF3YWl0IHRoaXMucmVkaXMua2V5cygnMmZhOnNtczoqJyk7XG4gICAgICBjb25zdCBlbWFpbEtleXMgPSBhd2FpdCB0aGlzLnJlZGlzLmtleXMoJzJmYTplbWFpbDoqJyk7XG5cbiAgICAgIGZvciAoY29uc3Qga2V5IG9mIFsuLi5zbXNLZXlzLCAuLi5lbWFpbEtleXNdKSB7XG4gICAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCB0aGlzLnJlZGlzLmdldChrZXkpO1xuICAgICAgICBpZiAoZGF0YSkge1xuICAgICAgICAgIGNvbnN0IHZlcmlmaWNhdGlvbkRhdGE6IFR3b0ZhY3RvclZlcmlmaWNhdGlvbiA9IEpTT04ucGFyc2UoZGF0YSk7XG4gICAgICAgICAgaWYgKG5ldyBEYXRlKCkgPiB2ZXJpZmljYXRpb25EYXRhLmV4cGlyZXNBdCkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5yZWRpcy5kZWwoa2V5KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgbG9nZ2VyLmluZm8oJ0V4cGlyZWQgdmVyaWZpY2F0aW9uIGNvZGVzIGNsZWFuZWQgdXAnKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdFcnJvciBjbGVhbmluZyB1cCBleHBpcmVkIGNvZGVzOicsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IDJGQSBzdGF0aXN0aWNzXG4gICAqL1xuICBwdWJsaWMgYXN5bmMgZ2V0U3RhdHMoKTogUHJvbWlzZTx7XG4gICAgdG90YWxVc2VyczogbnVtYmVyO1xuICAgIGVuYWJsZWRVc2VyczogbnVtYmVyO1xuICAgIG1ldGhvZERpc3RyaWJ1dGlvbjogeyBba2V5OiBzdHJpbmddOiBudW1iZXIgfTtcbiAgICByZWNlbnRWZXJpZmljYXRpb25zOiBudW1iZXI7XG4gIH0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdXNlcktleXMgPSBhd2FpdCB0aGlzLnJlZGlzLmtleXMoJzJmYTp1c2VyOionKTtcbiAgICAgIGNvbnN0IHRvdGFsVXNlcnMgPSB1c2VyS2V5cy5sZW5ndGg7XG5cbiAgICAgIGxldCBlbmFibGVkVXNlcnMgPSAwO1xuICAgICAgY29uc3QgbWV0aG9kRGlzdHJpYnV0aW9uOiB7IFtrZXk6IHN0cmluZ106IG51bWJlciB9ID0ge307XG5cbiAgICAgIGZvciAoY29uc3Qga2V5IG9mIHVzZXJLZXlzKSB7XG4gICAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCB0aGlzLnJlZGlzLmdldChrZXkpO1xuICAgICAgICBpZiAoZGF0YSkge1xuICAgICAgICAgIGNvbnN0IHNldHRpbmdzID0gSlNPTi5wYXJzZShkYXRhKTtcbiAgICAgICAgICBpZiAoc2V0dGluZ3MuZW5hYmxlZCkge1xuICAgICAgICAgICAgZW5hYmxlZFVzZXJzKys7XG4gICAgICAgICAgICBtZXRob2REaXN0cmlidXRpb25bc2V0dGluZ3MubWV0aG9kXSA9IChtZXRob2REaXN0cmlidXRpb25bc2V0dGluZ3MubWV0aG9kXSB8fCAwKSArIDE7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIENvdW50IHJlY2VudCB2ZXJpZmljYXRpb25zIChsYXN0IGhvdXIpXG4gICAgICBjb25zdCByZWNlbnRLZXlzID0gYXdhaXQgdGhpcy5yZWRpcy5rZXlzKCcyZmE6KicpO1xuICAgICAgY29uc3QgcmVjZW50VmVyaWZpY2F0aW9ucyA9IHJlY2VudEtleXMuZmlsdGVyKFxuICAgICAgICBrZXkgPT4ga2V5LmluY2x1ZGVzKCdzbXM6JykgfHwga2V5LmluY2x1ZGVzKCdlbWFpbDonKSxcbiAgICAgICkubGVuZ3RoO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICB0b3RhbFVzZXJzLFxuICAgICAgICBlbmFibGVkVXNlcnMsXG4gICAgICAgIG1ldGhvZERpc3RyaWJ1dGlvbixcbiAgICAgICAgcmVjZW50VmVyaWZpY2F0aW9ucyxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignRXJyb3IgZ2V0dGluZyAyRkEgc3RhdHM6JywgZXJyb3IpO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdG90YWxVc2VyczogMCxcbiAgICAgICAgZW5hYmxlZFVzZXJzOiAwLFxuICAgICAgICBtZXRob2REaXN0cmlidXRpb246IHt9LFxuICAgICAgICByZWNlbnRWZXJpZmljYXRpb25zOiAwLFxuICAgICAgfTtcbiAgICB9XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==