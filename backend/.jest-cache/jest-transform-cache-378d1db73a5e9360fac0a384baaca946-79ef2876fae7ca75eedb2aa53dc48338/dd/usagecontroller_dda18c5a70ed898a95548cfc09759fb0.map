{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\controllers\\usage.controller.ts","mappings":";;;AAEA,4CAA2C;AAC3C,uDAAoD;AACpD,iEAA2D;AAC3D,4CAAyC;AASlC,MAAM,eAAe,GAAG,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,IAAkB,EAAE,EAAE;IACvF,IAAI,CAAC;QACH,MAAM,MAAM,GAAI,GAAW,CAAC,IAAI,EAAE,EAAE,IAAI,GAAG,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC,CAAC,wBAAwB;QAE1F,IAAI,CAAC,MAAM,EAAE,CAAC;YACZ,OAAO,IAAI,CAAC,IAAI,iBAAQ,CAAC,iBAAiB,EAAE,GAAG,EAAE,cAAc,CAAC,CAAC,CAAC;QACpE,CAAC;QAED,4BAA4B;QAC5B,MAAM,GAAG,GAAG,IAAI,IAAI,EAAE,CAAC;QACvB,MAAM,eAAe,GAAG,IAAI,IAAI,CAAC,GAAG,CAAC,WAAW,EAAE,EAAE,GAAG,CAAC,QAAQ,EAAE,EAAE,CAAC,CAAC,CAAC;QAEvE,MAAM,MAAM,GAAG,MAAM,yBAAW,CAAC,SAAS,CAAC;YACzC,EAAE,MAAM,EAAE,EAAE,MAAM,EAAE,MAAM,EAAE,SAAS,EAAE,EAAE,IAAI,EAAE,eAAe,EAAE,EAAE,EAAE;YACpE;gBACE,MAAM,EAAE;oBACN,GAAG,EAAE,IAAI;oBACT,WAAW,EAAE,EAAE,IAAI,EAAE,cAAc,EAAE;oBACrC,aAAa,EAAE,EAAE,IAAI,EAAE,eAAe,EAAE;oBACxC,KAAK,EAAE,EAAE,IAAI,EAAE,CAAC,EAAE;iBACnB;aACF;SACF,CAAC,CAAC;QAEH,MAAM,KAAK,GAAG,MAAM,CAAC,CAAC,CAAC,IAAI,EAAE,WAAW,EAAE,CAAC,EAAE,aAAa,EAAE,CAAC,EAAE,KAAK,EAAE,CAAC,EAAE,CAAC;QAC1E,MAAM,IAAI,GAAG,OAAO,KAAK,CAAC,aAAa,KAAK,QAAQ,CAAC,CAAC,CAAC,KAAK,CAAC,aAAa,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,MAAM,CAAC;QAE/F,gCAAgC;QAChC,MAAM,MAAM,GAAuB;YACjC,IAAI,EAAE,WAAW;YACjB,SAAS,EAAE,QAAQ;YACnB,QAAQ,EAAE;gBACR;oBACE,IAAI,EAAE,WAAW;oBACjB,SAAS,EAAE,KAAK;oBAChB,QAAQ,EAAE;wBACR,EAAE,IAAI,EAAE,MAAM,EAAE,KAAK,EAAE,oBAAoB,EAAE,KAAK,EAAE,KAAK,CAAC,WAAW,EAAE,KAAK,EAAE,IAAI,EAAE;wBACpF,EAAE,IAAI,EAAE,MAAM,EAAE,KAAK,EAAE,WAAW,EAAE,KAAK,EAAE,IAAI,IAAI,EAAE,EAAE,KAAK,EAAE,SAAS,EAAE;qBAC1E;iBACF;gBACD;oBACE,IAAI,EAAE,MAAM;oBACZ,KAAK,EAAE,qBAAqB;oBAC5B,OAAO,EACL,4FAA4F;oBAC9F,OAAO,EAAE,OAAO;iBACjB;aACF;SACF,CAAC;QAEF,iBAAiB;QACjB,GAAG,CAAC,IAAI,CAAC,IAAA,gCAAa,EAAC,MAAM,EAAE,GAAG,EAAG,GAAW,CAAC,SAAS,CAAC,CAAC,CAAC;IAC/D,CAAC;IAAC,OAAO,GAAG,EAAE,CAAC;QACb,eAAM,CAAC,KAAK,CAAC,GAAG,EAAE,8BAA8B,CAAC,CAAC;QAClD,IAAI,CAAC,GAAG,CAAC,CAAC;IACZ,CAAC;AACH,CAAC,CAAC;AAxDW,QAAA,eAAe,mBAwD1B","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\controllers\\usage.controller.ts"],"sourcesContent":["import type { NextFunction, Request, Response } from 'express';\nimport { injectable } from 'inversify';\nimport { AppError } from '../utils/errors';\nimport { UsageRecord } from '../models/UsageRecord';\nimport { buildResponse } from '../common/response-builder';\nimport { logger } from '../utils/logger';\n\n// Generative UI Schema shared with Frontend\ntype GenerativeUISchema =\n  | { type: 'card'; title?: string; content: string; variant?: 'default' | 'glass' | 'outline' }\n  | { type: 'stat'; label: string; value: string | number; trend?: 'up' | 'down' | 'neutral' }\n  | { type: 'list'; items: string[]; title?: string }\n  | { type: 'container'; direction: 'row' | 'column'; children: GenerativeUISchema[] };\n\nexport const getCurrentUsage = async (req: Request, res: Response, next: NextFunction) => {\n  try {\n    const userId = (req as any).user?.id || req.headers['x-user-id']; // Fallback for dev/test\n\n    if (!userId) {\n      return next(new AppError('User ID unknown', 401, 'UNAUTHORIZED'));\n    }\n\n    // 1. Fetch Aggregated Stats\n    const now = new Date();\n    const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);\n\n    const result = await UsageRecord.aggregate([\n      { $match: { userId: userId, createdAt: { $gte: firstDayOfMonth } } },\n      {\n        $group: {\n          _id: null,\n          totalTokens: { $sum: '$totalTokens' },\n          estimatedCost: { $sum: '$costEstimate' },\n          count: { $sum: 1 },\n        },\n      },\n    ]);\n\n    const stats = result[0] || { totalTokens: 0, estimatedCost: 0, count: 0 };\n    const cost = typeof stats.estimatedCost === 'number' ? stats.estimatedCost.toFixed(4) : '0.00';\n\n    // 2. Build Generative UI Schema\n    const schema: GenerativeUISchema = {\n      type: 'container',\n      direction: 'column',\n      children: [\n        {\n          type: 'container',\n          direction: 'row',\n          children: [\n            { type: 'stat', label: 'Total Tokens (MTH)', value: stats.totalTokens, trend: 'up' },\n            { type: 'stat', label: 'Est. Cost', value: `$${cost}`, trend: 'neutral' },\n          ],\n        },\n        {\n          type: 'card',\n          title: 'Current Plan Status',\n          content:\n            'You are on the Metered Plan. Usage is calculated daily and billed at the end of the month.',\n          variant: 'glass',\n        },\n      ],\n    };\n\n    // 3. Return JSON\n    res.json(buildResponse(schema, 200, (req as any).requestId));\n  } catch (err) {\n    logger.error(err, 'Error fetching current usage');\n    next(err);\n  }\n};\n"],"version":3}