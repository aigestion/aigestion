29d19fd101fd34efdf642a79ebbcb2a9
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
var _a, _b, _c, _d;
Object.defineProperty(exports, "__esModule", { value: true });
exports.SocialController = void 0;
const axios_1 = __importDefault(require("axios"));
const inversify_1 = require("inversify");
const response_builder_1 = require("../common/response-builder");
const index_1 = require("../config/index");
const instagram_service_1 = require("../services/instagram.service");
const linkedin_service_1 = require("../services/linkedin.service");
const tiktok_service_1 = require("../services/tiktok.service");
const x_service_1 = require("../services/x.service");
const types_1 = require("../types");
const FB_API_URL = index_1.config.whatsapp.apiUrl;
let SocialController = class SocialController {
    instagramService;
    linkedinService;
    tiktokService;
    xService;
    constructor(instagramService, linkedinService, tiktokService, xService) {
        this.instagramService = instagramService;
        this.linkedinService = linkedinService;
        this.tiktokService = tiktokService;
        this.xService = xService;
    }
    // Publicar en Facebook Page
    async publishPost(req, res) {
        try {
            const { message, link } = req.body;
            const pageId = process.env.FACEBOOK_PAGE_ID;
            const accessToken = process.env.FACEBOOK_ACCESS_TOKEN;
            if (!pageId || !accessToken) {
                res.status(500).json({ error: 'Facebook credentials not configured' });
                return;
            }
            console.log(`üöÄ Publishing to Facebook Page ${pageId}...`);
            const response = await axios_1.default.post(`${FB_API_URL}/${pageId}/feed`, {
                message,
                link,
                access_token: accessToken,
            });
            console.log('‚úÖ Published successfully:', response.data.id);
            res.json({ success: true, postId: response.data.id });
        }
        catch (error) {
            console.error('‚ùå Error publishing to Facebook:', error.response?.data || error.message);
            res
                .status(500)
                .json({ error: 'Failed to publish to Facebook', details: error.response?.data });
        }
    }
    // Obtener M√©tricas de la P√°gina
    async getPageStats(_req, res) {
        try {
            const pageId = process.env.FACEBOOK_PAGE_ID;
            const accessToken = process.env.FACEBOOK_ACCESS_TOKEN;
            if (!pageId || !accessToken) {
                // Mock data si no hay credenciales (para demo)
                res.json({
                    followers: 1250,
                    impressions: 4500,
                    engagement: 8.5,
                    mock: true,
                });
                return;
            }
            const response = await axios_1.default.get(`${FB_API_URL}/${pageId}`, {
                params: {
                    fields: 'fan_count,rating_count,new_like_count,talking_about_count',
                    access_token: accessToken,
                },
            });
            res.json(response.data);
        }
        catch (error) {
            console.error('‚ùå Error fetching FB stats:', error.response?.data || error.message);
            res
                .status(500)
                .json((0, response_builder_1.buildError)('Failed to get stats', 'SOCIAL_ERROR', 500, _req.requestId));
        }
    }
    // Enviar Mensaje Directo Instagram
    async sendInstagramDM(req, res) {
        try {
            const { recipientId, text } = req.body;
            const result = await this.instagramService.sendDM(recipientId, text);
            res.json({ success: true, result });
        }
        catch (error) {
            res.status(500).json({ error: 'Failed to send Instagram DM' });
        }
    }
    // Publicar Tweet en X
    async postTweet(req, res) {
        try {
            const { text } = req.body;
            // Ensure we have a string; if not, coerce to string or reject
            if (typeof text !== 'string' || text.trim() === '') {
                res.status(400).json({ error: 'Invalid tweet text' });
                return;
            }
            const result = await this.xService.postTweet(text);
            res.json({ success: true, result });
        }
        catch (error) {
            res.status(500).json({ error: 'Failed to post Tweet to X' });
        }
    }
    // Publicar Video en TikTok
    async publishTikTokVideo(req, res) {
        try {
            const { videoUrl, title } = req.body || {};
            const result = await this.tiktokService.publishVideo(videoUrl, title);
            res.json({ success: true, result });
        }
        catch (error) {
            res.status(500).json({ error: 'Failed to publish to TikTok' });
        }
    }
    // Publicar Post en LinkedIn
    async publishLinkedInPost(req, res) {
        try {
            const { text } = req.body || {};
            const result = await this.linkedinService.sharePost(text);
            res.json({ success: true, result });
        }
        catch (error) {
            res.status(500).json({ error: 'Failed to publish to LinkedIn' });
        }
    }
};
exports.SocialController = SocialController;
exports.SocialController = SocialController = __decorate([
    (0, inversify_1.injectable)(),
    __param(0, (0, inversify_1.inject)(types_1.TYPES.InstagramService)),
    __param(1, (0, inversify_1.inject)(types_1.TYPES.LinkedInService)),
    __param(2, (0, inversify_1.inject)(types_1.TYPES.TikTokService)),
    __param(3, (0, inversify_1.inject)(types_1.TYPES.XService)),
    __metadata("design:paramtypes", [typeof (_a = typeof instagram_service_1.InstagramService !== "undefined" && instagram_service_1.InstagramService) === "function" ? _a : Object, typeof (_b = typeof linkedin_service_1.LinkedInService !== "undefined" && linkedin_service_1.LinkedInService) === "function" ? _b : Object, typeof (_c = typeof tiktok_service_1.TikTokService !== "undefined" && tiktok_service_1.TikTokService) === "function" ? _c : Object, typeof (_d = typeof x_service_1.XService !== "undefined" && x_service_1.XService) === "function" ? _d : Object])
], SocialController);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxjb250cm9sbGVyc1xcc29jaWFsLmNvbnRyb2xsZXIudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLGtEQUEwQjtBQUUxQix5Q0FBK0M7QUFFL0MsaUVBQXdEO0FBQ3hELDJDQUF5QztBQUN6QyxxRUFBaUU7QUFDakUsbUVBQStEO0FBQy9ELCtEQUEyRDtBQUMzRCxxREFBaUQ7QUFDakQsb0NBQTBDO0FBRTFDLE1BQU0sVUFBVSxHQUFHLGNBQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDO0FBR25DLElBQU0sZ0JBQWdCLEdBQXRCLE1BQU0sZ0JBQWdCO0lBRWU7SUFDRDtJQUNGO0lBQ0w7SUFKbEMsWUFDMEMsZ0JBQWtDLEVBQ25DLGVBQWdDLEVBQ2xDLGFBQTRCLEVBQ2pDLFFBQWtCO1FBSFYscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNuQyxvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFDbEMsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDakMsYUFBUSxHQUFSLFFBQVEsQ0FBVTtJQUNqRCxDQUFDO0lBRUosNEJBQTRCO0lBQzVCLEtBQUssQ0FBQyxXQUFXLENBQUMsR0FBWSxFQUFFLEdBQWE7UUFDM0MsSUFBSSxDQUFDO1lBQ0gsTUFBTSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1lBQ25DLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUM7WUFDNUMsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsQ0FBQztZQUV0RCxJQUFJLENBQUMsTUFBTSxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7Z0JBQzVCLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLHFDQUFxQyxFQUFFLENBQUMsQ0FBQztnQkFDdkUs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QkFBTSxFQUFDLGFBQUssQ0FBQyxhQUFhLENBQUMsQ0FBQTtJQUMzQixXQUFBLElBQUEsa0JBQU0sRUFBQyxhQUFLLENBQUMsUUFBUSxDQUFDLENBQUE7eURBSG1DLG9DQUFnQixvQkFBaEIsb0NBQWdCLG9EQUNsQixrQ0FBZSxvQkFBZixrQ0FBZSxvREFDbkIsOEJBQWEsb0JBQWIsOEJBQWEsb0RBQ3ZCLG9CQUFRLG9CQUFSLG9CQUFRO0dBTHpDLGdCQUFnQixDQXVINUIiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxjb250cm9sbGVyc1xcc29jaWFsLmNvbnRyb2xsZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGF4aW9zIGZyb20gJ2F4aW9zJztcbmltcG9ydCB0eXBlIHsgUmVxdWVzdCwgUmVzcG9uc2UgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IGluamVjdCwgaW5qZWN0YWJsZSB9IGZyb20gJ2ludmVyc2lmeSc7XG5cbmltcG9ydCB7IGJ1aWxkRXJyb3IgfSBmcm9tICcuLi9jb21tb24vcmVzcG9uc2UtYnVpbGRlcic7XG5pbXBvcnQgeyBjb25maWcgfSBmcm9tICcuLi9jb25maWcvaW5kZXgnO1xuaW1wb3J0IHsgSW5zdGFncmFtU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL2luc3RhZ3JhbS5zZXJ2aWNlJztcbmltcG9ydCB7IExpbmtlZEluU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL2xpbmtlZGluLnNlcnZpY2UnO1xuaW1wb3J0IHsgVGlrVG9rU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL3Rpa3Rvay5zZXJ2aWNlJztcbmltcG9ydCB7IFhTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMveC5zZXJ2aWNlJztcbmltcG9ydCB7IFRZUEVfSUQsIFRZUEVTIH0gZnJvbSAnLi4vdHlwZXMnO1xuXG5jb25zdCBGQl9BUElfVVJMID0gY29uZmlnLndoYXRzYXBwLmFwaVVybDtcblxuQGluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFNvY2lhbENvbnRyb2xsZXIge1xuICBjb25zdHJ1Y3RvcihcbiAgICBAaW5qZWN0KFRZUEVTLkluc3RhZ3JhbVNlcnZpY2UpIHByaXZhdGUgaW5zdGFncmFtU2VydmljZTogSW5zdGFncmFtU2VydmljZSxcbiAgICBAaW5qZWN0KFRZUEVTLkxpbmtlZEluU2VydmljZSkgcHJpdmF0ZSBsaW5rZWRpblNlcnZpY2U6IExpbmtlZEluU2VydmljZSxcbiAgICBAaW5qZWN0KFRZUEVTLlRpa1Rva1NlcnZpY2UpIHByaXZhdGUgdGlrdG9rU2VydmljZTogVGlrVG9rU2VydmljZSxcbiAgICBAaW5qZWN0KFRZUEVTLlhTZXJ2aWNlKSBwcml2YXRlIHhTZXJ2aWNlOiBYU2VydmljZSxcbiAgKSB7fVxuXG4gIC8vIFB1YmxpY2FyIGVuIEZhY2Vib29rIFBhZ2VcbiAgYXN5bmMgcHVibGlzaFBvc3QocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgbWVzc2FnZSwgbGluayB9ID0gcmVxLmJvZHk7XG4gICAgICBjb25zdCBwYWdlSWQgPSBwcm9jZXNzLmVudi5GQUNFQk9PS19QQUdFX0lEO1xuICAgICAgY29uc3QgYWNjZXNzVG9rZW4gPSBwcm9jZXNzLmVudi5GQUNFQk9PS19BQ0NFU1NfVE9LRU47XG5cbiAgICAgIGlmICghcGFnZUlkIHx8ICFhY2Nlc3NUb2tlbikge1xuICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IGVycm9yOiAnRmFjZWJvb2sgY3JlZGVudGlhbHMgbm90IGNvbmZpZ3VyZWQnIH0pO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGNvbnNvbGUubG9nKGDwn5qAIFB1Ymxpc2hpbmcgdG8gRmFjZWJvb2sgUGFnZSAke3BhZ2VJZH0uLi5gKTtcblxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBheGlvcy5wb3N0KGAke0ZCX0FQSV9VUkx9LyR7cGFnZUlkfS9mZWVkYCwge1xuICAgICAgICBtZXNzYWdlLFxuICAgICAgICBsaW5rLFxuICAgICAgICBhY2Nlc3NfdG9rZW46IGFjY2Vzc1Rva2VuLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnNvbGUubG9nKCfinIUgUHVibGlzaGVkIHN1Y2Nlc3NmdWxseTonLCByZXNwb25zZS5kYXRhLmlkKTtcbiAgICAgIHJlcy5qc29uKHsgc3VjY2VzczogdHJ1ZSwgcG9zdElkOiByZXNwb25zZS5kYXRhLmlkIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvciBwdWJsaXNoaW5nIHRvIEZhY2Vib29rOicsIGVycm9yLnJlc3BvbnNlPy5kYXRhIHx8IGVycm9yLm1lc3NhZ2UpO1xuICAgICAgcmVzXG4gICAgICAgIC5zdGF0dXMoNTAwKVxuICAgICAgICAuanNvbih7IGVycm9yOiAnRmFpbGVkIHRvIHB1Ymxpc2ggdG8gRmFjZWJvb2snLCBkZXRhaWxzOiBlcnJvci5yZXNwb25zZT8uZGF0YSB9KTtcbiAgICB9XG4gIH1cblxuICAvLyBPYnRlbmVyIE3DqXRyaWNhcyBkZSBsYSBQw6FnaW5hXG4gIGFzeW5jIGdldFBhZ2VTdGF0cyhfcmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHBhZ2VJZCA9IHByb2Nlc3MuZW52LkZBQ0VCT09LX1BBR0VfSUQ7XG4gICAgICBjb25zdCBhY2Nlc3NUb2tlbiA9IHByb2Nlc3MuZW52LkZBQ0VCT09LX0FDQ0VTU19UT0tFTjtcblxuICAgICAgaWYgKCFwYWdlSWQgfHwgIWFjY2Vzc1Rva2VuKSB7XG4gICAgICAgIC8vIE1vY2sgZGF0YSBzaSBubyBoYXkgY3JlZGVuY2lhbGVzIChwYXJhIGRlbW8pXG4gICAgICAgIHJlcy5qc29uKHtcbiAgICAgICAgICBmb2xsb3dlcnM6IDEyNTAsXG4gICAgICAgICAgaW1wcmVzc2lvbnM6IDQ1MDAsXG4gICAgICAgICAgZW5nYWdlbWVudDogOC41LFxuICAgICAgICAgIG1vY2s6IHRydWUsXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgYXhpb3MuZ2V0KGAke0ZCX0FQSV9VUkx9LyR7cGFnZUlkfWAsIHtcbiAgICAgICAgcGFyYW1zOiB7XG4gICAgICAgICAgZmllbGRzOiAnZmFuX2NvdW50LHJhdGluZ19jb3VudCxuZXdfbGlrZV9jb3VudCx0YWxraW5nX2Fib3V0X2NvdW50JyxcbiAgICAgICAgICBhY2Nlc3NfdG9rZW46IGFjY2Vzc1Rva2VuLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIHJlcy5qc29uKHJlc3BvbnNlLmRhdGEpO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvciBmZXRjaGluZyBGQiBzdGF0czonLCBlcnJvci5yZXNwb25zZT8uZGF0YSB8fCBlcnJvci5tZXNzYWdlKTtcbiAgICAgIChyZXMgYXMgYW55KVxuICAgICAgICAuc3RhdHVzKDUwMClcbiAgICAgICAgLmpzb24oYnVpbGRFcnJvcignRmFpbGVkIHRvIGdldCBzdGF0cycsICdTT0NJQUxfRVJST1InLCA1MDAsIChfcmVxIGFzIGFueSkucmVxdWVzdElkKSk7XG4gICAgfVxuICB9XG5cbiAgLy8gRW52aWFyIE1lbnNhamUgRGlyZWN0byBJbnN0YWdyYW1cbiAgYXN5bmMgc2VuZEluc3RhZ3JhbURNKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IHJlY2lwaWVudElkLCB0ZXh0IH0gPSByZXEuYm9keTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuaW5zdGFncmFtU2VydmljZS5zZW5kRE0ocmVjaXBpZW50SWQsIHRleHQpO1xuICAgICAgcmVzLmpzb24oeyBzdWNjZXNzOiB0cnVlLCByZXN1bHQgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oeyBlcnJvcjogJ0ZhaWxlZCB0byBzZW5kIEluc3RhZ3JhbSBETScgfSk7XG4gICAgfVxuICB9XG5cbiAgLy8gUHVibGljYXIgVHdlZXQgZW4gWFxuICBhc3luYyBwb3N0VHdlZXQocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgdGV4dCB9ID0gcmVxLmJvZHkgYXMgeyB0ZXh0PzogdW5rbm93biB9O1xuICAgICAgLy8gRW5zdXJlIHdlIGhhdmUgYSBzdHJpbmc7IGlmIG5vdCwgY29lcmNlIHRvIHN0cmluZyBvciByZWplY3RcbiAgICAgIGlmICh0eXBlb2YgdGV4dCAhPT0gJ3N0cmluZycgfHwgdGV4dC50cmltKCkgPT09ICcnKSB7XG4gICAgICAgIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgZXJyb3I6ICdJbnZhbGlkIHR3ZWV0IHRleHQnIH0pO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLnhTZXJ2aWNlLnBvc3RUd2VldCh0ZXh0KTtcbiAgICAgIHJlcy5qc29uKHsgc3VjY2VzczogdHJ1ZSwgcmVzdWx0IH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgZXJyb3I6ICdGYWlsZWQgdG8gcG9zdCBUd2VldCB0byBYJyB9KTtcbiAgICB9XG4gIH1cblxuICAvLyBQdWJsaWNhciBWaWRlbyBlbiBUaWtUb2tcbiAgYXN5bmMgcHVibGlzaFRpa1Rva1ZpZGVvKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IHZpZGVvVXJsLCB0aXRsZSB9ID0gKHJlcSBhcyBhbnkpLmJvZHkgfHwge307XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLnRpa3Rva1NlcnZpY2UucHVibGlzaFZpZGVvKHZpZGVvVXJsLCB0aXRsZSk7XG4gICAgICByZXMuanNvbih7IHN1Y2Nlc3M6IHRydWUsIHJlc3VsdCB9KTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IGVycm9yOiAnRmFpbGVkIHRvIHB1Ymxpc2ggdG8gVGlrVG9rJyB9KTtcbiAgICB9XG4gIH1cblxuICAvLyBQdWJsaWNhciBQb3N0IGVuIExpbmtlZEluXG4gIGFzeW5jIHB1Ymxpc2hMaW5rZWRJblBvc3QocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgdGV4dCB9ID0gKHJlcSBhcyBhbnkpLmJvZHkgfHwge307XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmxpbmtlZGluU2VydmljZS5zaGFyZVBvc3QodGV4dCk7XG4gICAgICByZXMuanNvbih7IHN1Y2Nlc3M6IHRydWUsIHJlc3VsdCB9KTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IGVycm9yOiAnRmFpbGVkIHRvIHB1Ymxpc2ggdG8gTGlua2VkSW4nIH0pO1xuICAgIH1cbiAgfVxufVxuIl0sInZlcnNpb24iOjN9