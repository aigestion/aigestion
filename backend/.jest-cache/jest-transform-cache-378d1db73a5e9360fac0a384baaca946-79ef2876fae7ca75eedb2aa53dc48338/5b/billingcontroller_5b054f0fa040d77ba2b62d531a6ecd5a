0401357136b3e3d9323d492777ac16f8
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.capturePayPalOrder = exports.createPayPalOrder = exports.createPortalSession = exports.createCheckoutSession = exports.getBillingSnapshot = void 0;
const UsageRecord_1 = require("../models/UsageRecord");
const User_1 = require("../models/User");
const logger_1 = require("../utils/logger");
const inversify_config_1 = require("../config/inversify.config");
const stripe_service_1 = require("../services/stripe.service");
const paypal_service_1 = require("../services/paypal.service");
const env_schema_1 = require("../config/env.schema");
/**
 * Get a snapshot of the current billing status
 * Composes actual AI costs + estimated infra costs
 */
const getBillingSnapshot = async (req, res, next) => {
    try {
        const userId = req.user?.id;
        // 1. Calculate Actual AI Costs from UsageRecord
        const aiCostData = await UsageRecord_1.UsageRecord.aggregate([
            { $match: { userId: userId } },
            { $group: { _id: null, total: { $sum: '$costEstimate' } } },
        ]);
        const aiTotal = aiCostData[0]?.total || 0;
        // 2. Compose full snapshot
        // For GCP/GitHub, in a real env we might query APIs, but here we can derive from usage or constants
        const snapshot = {
            updatedAt: new Date().toISOString(),
            googleCloudUSD: parseFloat((aiTotal * 0.4).toFixed(2)), // Assume 40% of AI cost is infra overhead
            githubActionsUSD: 8.75, // Fixed baseline for CI/CD & deployment
            otherUSD: 5.0,
            ivaRate: 0.21,
            totalUSD: parseFloat(((aiTotal + 20) * 1.21).toFixed(2)),
            currency: 'EUR',
            totalEUR: parseFloat(((aiTotal + 20) * 1.21 * 0.92).toFixed(2)), // USD to EUR conversion
        };
        res.json(snapshot); // Frontend expects raw object based on fetchBillingData implementation
    }
    catch (err) {
        logger_1.logger.error(err, 'Error in billing snapshot');
        res.status(500).json({ error: 'Internal server error' });
    }
};
exports.getBillingSnapshot = getBillingSnapshot;
/**
 * Initiate a Stripe Checkout Session for subscription
 */
const createCheckoutSession = async (req, res) => {
    try {
        const { priceId } = req.body;
        const userId = req.user?.id;
        if (!priceId) {
            return res.status(400).json({ error: 'Price ID is required' });
        }
        const user = await User_1.User.findById(userId);
        if (!user) {
            return res.status(404).json({ error: 'User not found' });
        }
        const stripeService = inversify_config_1.container.get(stripe_service_1.StripeService);
        let customerId = user.stripeCustomerId;
        if (!customerId) {
            const customer = await stripeService.createCustomer(user.email, user.name);
            customerId = customer.id;
            user.stripeCustomerId = customerId;
            await user.save();
        }
        const session = await stripeService.createSubscriptionCheckoutSession(customerId, priceId, `${env_schema_1.env.FRONTEND_URL}/billing?success=true`, `${env_schema_1.env.FRONTEND_URL}/billing?canceled=true`);
        res.json({ sessionId: session.id, url: session.url });
    }
    catch (error) {
        logger_1.logger.error(error, 'Checkout session creation failed');
        res.status(500).json({ error: 'Failed to create checkout session' });
    }
};
exports.createCheckoutSession = createCheckoutSession;
/**
 * Create a Stripe Portal Session for managing subscriptions
 */
const createPortalSession = async (req, res) => {
    try {
        const userId = req.user?.id;
        const user = await User_1.User.findById(userId);
        if (!user?.stripeCustomerId) {
            return res.status(400).json({ error: 'No billing account linked to this user' });
        }
        const stripeService = inversify_config_1.container.get(stripe_service_1.StripeService);
        const session = await stripeService.createPortalSession(user.stripeCustomerId, `${env_schema_1.env.FRONTEND_URL}/billing`);
        res.json({ url: session.url });
    }
    catch (error) {
        logger_1.logger.error(error, 'Portal session creation failed');
        res.status(500).json({ error: 'Failed to create portal session' });
    }
};
exports.createPortalSession = createPortalSession;
/**
 * Create a PayPal Order
 */
const createPayPalOrder = async (req, res) => {
    try {
        const { amount, currency } = req.body;
        // In a real app, validate amount against a priceId or plan
        const payPalService = inversify_config_1.container.get(paypal_service_1.PayPalService);
        const order = await payPalService.createOrder(amount, currency || 'USD');
        res.json(order);
    }
    catch (error) {
        logger_1.logger.error(error, 'PayPal create order failed');
        res.status(500).json({ error: 'Failed to create PayPal order' });
    }
};
exports.createPayPalOrder = createPayPalOrder;
/**
 * Capture a PayPal Order
 */
const capturePayPalOrder = async (req, res) => {
    try {
        const { orderId } = req.body;
        const payPalService = inversify_config_1.container.get(paypal_service_1.PayPalService);
        const capture = await payPalService.captureOrder(orderId);
        // TODO: Update user subscription status here based on successful capture
        res.json(capture);
    }
    catch (error) {
        logger_1.logger.error(error, 'PayPal capture order failed');
        res.status(500).json({ error: 'Failed to capture PayPal order' });
    }
};
exports.capturePayPalOrder = capturePayPalOrder;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxjb250cm9sbGVyc1xcYmlsbGluZy5jb250cm9sbGVyLnRzIiwibWFwcGluZ3MiOiI7OztBQUNBLHVEQUFvRDtBQUNwRCx5Q0FBc0M7QUFFdEMsNENBQXlDO0FBQ3pDLGlFQUF1RDtBQUN2RCwrREFBMkQ7QUFDM0QsK0RBQTJEO0FBQzNELHFEQUEyQztBQUUzQzs7O0dBR0c7QUFDSSxNQUFNLGtCQUFrQixHQUFHLEtBQUssRUFBRSxHQUFZLEVBQUUsR0FBYSxFQUFFLElBQWtCLEVBQUUsRUFBRTtJQUMxRixJQUFJLENBQUM7UUFDSCxNQUFNLE1BQU0sR0FBSSxHQUFXLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQztRQUVyQyxnREFBZ0Q7UUFDaEQsTUFBTSxVQUFVLEdBQUcsTUFBTSx5QkFBVyxDQUFDLFNBQVMsQ0FBQztZQUM3QyxFQUFFLE1BQU0sRUFBRSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUM5QixFQUFFLE1BQU0sRUFBRSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLEVBQUUsSUFBSSxFQUFFLGVBQWUsRUFBRSxFQUFFLEVBQUU7U0FDNUQsQ0FBQyxDQUFDO1FBRUgsTUFBTSxPQUFPLEdBQUcsVUFBVSxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssSUFBSSxDQUFDLENBQUM7UUFFMUMsMkJBQTJCO1FBQzNCLG9HQUFvRztRQUNwRyxNQUFNLFFBQVEsR0FBRztZQUNmLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtZQUNuQyxjQUFjLEVBQUUsVUFBVSxDQUFDLENBQUMsT0FBTyxHQUFHLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLDBDQUEwQztZQUNsRyxnQkFBZ0IsRUFBRSxJQUFJLEVBQUUsd0NBQXdDO1lBQ2hFLFFBQVEsRUFBRSxHQUFHO1lBQ2IsT0FBTyxFQUFFLElBQUk7WUFDYixRQUFRLEVB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QUE2QixDQUFDLENBQUM7UUFDbkQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsZ0NBQWdDLEVBQUUsQ0FBQyxDQUFDO0lBQ3RFLENBQUM7QUFDTCxDQUFDLENBQUM7QUFiVyxRQUFBLGtCQUFrQixzQkFhN0IiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxjb250cm9sbGVyc1xcYmlsbGluZy5jb250cm9sbGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgUmVxdWVzdCwgUmVzcG9uc2UsIE5leHRGdW5jdGlvbiB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgVXNhZ2VSZWNvcmQgfSBmcm9tICcuLi9tb2RlbHMvVXNhZ2VSZWNvcmQnO1xuaW1wb3J0IHsgVXNlciB9IGZyb20gJy4uL21vZGVscy9Vc2VyJztcbmltcG9ydCB7IGJ1aWxkUmVzcG9uc2UgfSBmcm9tICcuLi9jb21tb24vcmVzcG9uc2UtYnVpbGRlcic7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuLi91dGlscy9sb2dnZXInO1xuaW1wb3J0IHsgY29udGFpbmVyIH0gZnJvbSAnLi4vY29uZmlnL2ludmVyc2lmeS5jb25maWcnO1xuaW1wb3J0IHsgU3RyaXBlU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL3N0cmlwZS5zZXJ2aWNlJztcbmltcG9ydCB7IFBheVBhbFNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9wYXlwYWwuc2VydmljZSc7XG5pbXBvcnQgeyBlbnYgfSBmcm9tICcuLi9jb25maWcvZW52LnNjaGVtYSc7XG5cbi8qKlxuICogR2V0IGEgc25hcHNob3Qgb2YgdGhlIGN1cnJlbnQgYmlsbGluZyBzdGF0dXNcbiAqIENvbXBvc2VzIGFjdHVhbCBBSSBjb3N0cyArIGVzdGltYXRlZCBpbmZyYSBjb3N0c1xuICovXG5leHBvcnQgY29uc3QgZ2V0QmlsbGluZ1NuYXBzaG90ID0gYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgdXNlcklkID0gKHJlcSBhcyBhbnkpLnVzZXI/LmlkO1xuXG4gICAgLy8gMS4gQ2FsY3VsYXRlIEFjdHVhbCBBSSBDb3N0cyBmcm9tIFVzYWdlUmVjb3JkXG4gICAgY29uc3QgYWlDb3N0RGF0YSA9IGF3YWl0IFVzYWdlUmVjb3JkLmFnZ3JlZ2F0ZShbXG4gICAgICB7ICRtYXRjaDogeyB1c2VySWQ6IHVzZXJJZCB9IH0sXG4gICAgICB7ICRncm91cDogeyBfaWQ6IG51bGwsIHRvdGFsOiB7ICRzdW06ICckY29zdEVzdGltYXRlJyB9IH0gfSxcbiAgICBdKTtcblxuICAgIGNvbnN0IGFpVG90YWwgPSBhaUNvc3REYXRhWzBdPy50b3RhbCB8fCAwO1xuXG4gICAgLy8gMi4gQ29tcG9zZSBmdWxsIHNuYXBzaG90XG4gICAgLy8gRm9yIEdDUC9HaXRIdWIsIGluIGEgcmVhbCBlbnYgd2UgbWlnaHQgcXVlcnkgQVBJcywgYnV0IGhlcmUgd2UgY2FuIGRlcml2ZSBmcm9tIHVzYWdlIG9yIGNvbnN0YW50c1xuICAgIGNvbnN0IHNuYXBzaG90ID0ge1xuICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICBnb29nbGVDbG91ZFVTRDogcGFyc2VGbG9hdCgoYWlUb3RhbCAqIDAuNCkudG9GaXhlZCgyKSksIC8vIEFzc3VtZSA0MCUgb2YgQUkgY29zdCBpcyBpbmZyYSBvdmVyaGVhZFxuICAgICAgZ2l0aHViQWN0aW9uc1VTRDogOC43NSwgLy8gRml4ZWQgYmFzZWxpbmUgZm9yIENJL0NEICYgZGVwbG95bWVudFxuICAgICAgb3RoZXJVU0Q6IDUuMCxcbiAgICAgIGl2YVJhdGU6IDAuMjEsXG4gICAgICB0b3RhbFVTRDogcGFyc2VGbG9hdCgoKGFpVG90YWwgKyAyMCkgKiAxLjIxKS50b0ZpeGVkKDIpKSxcbiAgICAgIGN1cnJlbmN5OiAnRVVSJyxcbiAgICAgIHRvdGFsRVVSOiBwYXJzZUZsb2F0KCgoYWlUb3RhbCArIDIwKSAqIDEuMjEgKiAwLjkyKS50b0ZpeGVkKDIpKSwgLy8gVVNEIHRvIEVVUiBjb252ZXJzaW9uXG4gICAgfTtcblxuICAgIHJlcy5qc29uKHNuYXBzaG90KTsgLy8gRnJvbnRlbmQgZXhwZWN0cyByYXcgb2JqZWN0IGJhc2VkIG9uIGZldGNoQmlsbGluZ0RhdGEgaW1wbGVtZW50YXRpb25cbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nZ2VyLmVycm9yKGVyciwgJ0Vycm9yIGluIGJpbGxpbmcgc25hcHNob3QnKTtcbiAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyB9KTtcbiAgfVxufTtcblxuLyoqXG4gKiBJbml0aWF0ZSBhIFN0cmlwZSBDaGVja291dCBTZXNzaW9uIGZvciBzdWJzY3JpcHRpb25cbiAqL1xuZXhwb3J0IGNvbnN0IGNyZWF0ZUNoZWNrb3V0U2Vzc2lvbiA9IGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB7IHByaWNlSWQgfSA9IHJlcS5ib2R5O1xuICAgIGNvbnN0IHVzZXJJZCA9IChyZXEgYXMgYW55KS51c2VyPy5pZDtcblxuICAgIGlmICghcHJpY2VJZCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgZXJyb3I6ICdQcmljZSBJRCBpcyByZXF1aXJlZCcgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZEJ5SWQodXNlcklkKTtcblxuICAgIGlmICghdXNlcikge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgZXJyb3I6ICdVc2VyIG5vdCBmb3VuZCcgfSk7XG4gICAgfVxuXG4gICAgY29uc3Qgc3RyaXBlU2VydmljZSA9IGNvbnRhaW5lci5nZXQoU3RyaXBlU2VydmljZSk7XG5cbiAgICBsZXQgY3VzdG9tZXJJZCA9IHVzZXIuc3RyaXBlQ3VzdG9tZXJJZDtcblxuICAgIGlmICghY3VzdG9tZXJJZCkge1xuICAgICAgY29uc3QgY3VzdG9tZXIgPSBhd2FpdCBzdHJpcGVTZXJ2aWNlLmNyZWF0ZUN1c3RvbWVyKHVzZXIuZW1haWwsIHVzZXIubmFtZSk7XG4gICAgICBjdXN0b21lcklkID0gY3VzdG9tZXIuaWQ7XG4gICAgICB1c2VyLnN0cmlwZUN1c3RvbWVySWQgPSBjdXN0b21lcklkO1xuICAgICAgYXdhaXQgdXNlci5zYXZlKCk7XG4gICAgfVxuXG4gICAgY29uc3Qgc2Vzc2lvbiA9IGF3YWl0IHN0cmlwZVNlcnZpY2UuY3JlYXRlU3Vic2NyaXB0aW9uQ2hlY2tvdXRTZXNzaW9uKFxuICAgICAgY3VzdG9tZXJJZCxcbiAgICAgIHByaWNlSWQsXG4gICAgICBgJHtlbnYuRlJPTlRFTkRfVVJMfS9iaWxsaW5nP3N1Y2Nlc3M9dHJ1ZWAsXG4gICAgICBgJHtlbnYuRlJPTlRFTkRfVVJMfS9iaWxsaW5nP2NhbmNlbGVkPXRydWVgLFxuICAgICk7XG5cbiAgICByZXMuanNvbih7IHNlc3Npb25JZDogc2Vzc2lvbi5pZCwgdXJsOiBzZXNzaW9uLnVybCB9KTtcbiAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgIGxvZ2dlci5lcnJvcihlcnJvciwgJ0NoZWNrb3V0IHNlc3Npb24gY3JlYXRpb24gZmFpbGVkJyk7XG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24oeyBlcnJvcjogJ0ZhaWxlZCB0byBjcmVhdGUgY2hlY2tvdXQgc2Vzc2lvbicgfSk7XG4gIH1cbn07XG5cbi8qKlxuICogQ3JlYXRlIGEgU3RyaXBlIFBvcnRhbCBTZXNzaW9uIGZvciBtYW5hZ2luZyBzdWJzY3JpcHRpb25zXG4gKi9cbmV4cG9ydCBjb25zdCBjcmVhdGVQb3J0YWxTZXNzaW9uID0gYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHVzZXJJZCA9IChyZXEgYXMgYW55KS51c2VyPy5pZDtcbiAgICBjb25zdCB1c2VyID0gYXdhaXQgVXNlci5maW5kQnlJZCh1c2VySWQpO1xuXG4gICAgaWYgKCF1c2VyPy5zdHJpcGVDdXN0b21lcklkKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ05vIGJpbGxpbmcgYWNjb3VudCBsaW5rZWQgdG8gdGhpcyB1c2VyJyB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBzdHJpcGVTZXJ2aWNlID0gY29udGFpbmVyLmdldChTdHJpcGVTZXJ2aWNlKTtcblxuICAgIGNvbnN0IHNlc3Npb24gPSBhd2FpdCBzdHJpcGVTZXJ2aWNlLmNyZWF0ZVBvcnRhbFNlc3Npb24oXG4gICAgICB1c2VyLnN0cmlwZUN1c3RvbWVySWQsXG4gICAgICBgJHtlbnYuRlJPTlRFTkRfVVJMfS9iaWxsaW5nYCxcbiAgICApO1xuXG4gICAgcmVzLmpzb24oeyB1cmw6IHNlc3Npb24udXJsIH0pO1xuICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgbG9nZ2VyLmVycm9yKGVycm9yLCAnUG9ydGFsIHNlc3Npb24gY3JlYXRpb24gZmFpbGVkJyk7XG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24oeyBlcnJvcjogJ0ZhaWxlZCB0byBjcmVhdGUgcG9ydGFsIHNlc3Npb24nIH0pO1xuICB9XG59O1xuXG4vKipcbiAqIENyZWF0ZSBhIFBheVBhbCBPcmRlclxuICovXG5leHBvcnQgY29uc3QgY3JlYXRlUGF5UGFsT3JkZXIgPSBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgICAgY29uc3QgeyBhbW91bnQsIGN1cnJlbmN5IH0gPSByZXEuYm9keTtcbiAgICAgICAgLy8gSW4gYSByZWFsIGFwcCwgdmFsaWRhdGUgYW1vdW50IGFnYWluc3QgYSBwcmljZUlkIG9yIHBsYW5cbiAgICAgICAgY29uc3QgcGF5UGFsU2VydmljZSA9IGNvbnRhaW5lci5nZXQoUGF5UGFsU2VydmljZSk7XG4gICAgICAgIGNvbnN0IG9yZGVyID0gYXdhaXQgcGF5UGFsU2VydmljZS5jcmVhdGVPcmRlcihhbW91bnQsIGN1cnJlbmN5IHx8ICdVU0QnKTtcbiAgICAgICAgcmVzLmpzb24ob3JkZXIpO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKGVycm9yLCAnUGF5UGFsIGNyZWF0ZSBvcmRlciBmYWlsZWQnKTtcbiAgICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oeyBlcnJvcjogJ0ZhaWxlZCB0byBjcmVhdGUgUGF5UGFsIG9yZGVyJyB9KTtcbiAgICB9XG59O1xuXG4vKipcbiAqIENhcHR1cmUgYSBQYXlQYWwgT3JkZXJcbiAqL1xuZXhwb3J0IGNvbnN0IGNhcHR1cmVQYXlQYWxPcmRlciA9IGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgICB0cnkge1xuICAgICAgICBjb25zdCB7IG9yZGVySWQgfSA9IHJlcS5ib2R5O1xuICAgICAgICBjb25zdCBwYXlQYWxTZXJ2aWNlID0gY29udGFpbmVyLmdldChQYXlQYWxTZXJ2aWNlKTtcbiAgICAgICAgY29uc3QgY2FwdHVyZSA9IGF3YWl0IHBheVBhbFNlcnZpY2UuY2FwdHVyZU9yZGVyKG9yZGVySWQpO1xuXG4gICAgICAgIC8vIFRPRE86IFVwZGF0ZSB1c2VyIHN1YnNjcmlwdGlvbiBzdGF0dXMgaGVyZSBiYXNlZCBvbiBzdWNjZXNzZnVsIGNhcHR1cmVcblxuICAgICAgICByZXMuanNvbihjYXB0dXJlKTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICAgIGxvZ2dlci5lcnJvcihlcnJvciwgJ1BheVBhbCBjYXB0dXJlIG9yZGVyIGZhaWxlZCcpO1xuICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IGVycm9yOiAnRmFpbGVkIHRvIGNhcHR1cmUgUGF5UGFsIG9yZGVyJyB9KTtcbiAgICB9XG59O1xuIl0sInZlcnNpb24iOjN9