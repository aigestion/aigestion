8b320abd6136607a9c85f1676ea26f36
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.RegisterUserUseCase = void 0;
const inversify_1 = require("inversify");
const bcryptjs_1 = __importDefault(require("bcryptjs"));
const crypto_1 = __importDefault(require("crypto"));
const jsonwebtoken_1 = __importDefault(require("jsonwebtoken"));
const types_1 = require("../../types");
const errors_1 = require("../../utils/errors");
const config_1 = require("../../config");
let RegisterUserUseCase = class RegisterUserUseCase {
    userRepository;
    constructor(userRepository) {
        this.userRepository = userRepository;
    }
    async execute(data) {
        const { name, email, password } = data;
        const existingUser = await this.userRepository.findByEmail(email);
        if (existingUser) {
            throw new errors_1.AppError('El correo electrónico ya está registrado', 400, 'AUTH_ERROR');
        }
        const salt = await bcryptjs_1.default.genSalt(10);
        const hashedPassword = await bcryptjs_1.default.hash(password, salt);
        // Generate Verification Code
        const verificationCode = Math.floor(100000 + Math.random() * 900000).toString();
        const verificationExpires = new Date(Date.now() + 15 * 60 * 1000); // 15 minutes
        console.log(`[GOD MODE AUTH] Verification Code for ${email}: ${verificationCode}`);
        // Create the user via repository
        const user = await this.userRepository.create('', {
            name,
            email,
            password: hashedPassword,
            role: 'user', // Default role, user selects Family/Pro later
            emailVerificationCode: verificationCode,
            emailVerificationExpires: verificationExpires,
            isEmailVerified: false,
        });
        const token = this.generateToken(user);
        const refreshToken = this.generateRefreshTokenString(user);
        user.refreshTokens = [
            {
                token: refreshToken,
                expires: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),
                familyId: crypto_1.default.randomUUID(),
                ip: '127.0.0.1',
                userAgent: 'unknown',
                createdAt: new Date(),
            },
        ];
        // Use repository to update the user with tokens
        await this.userRepository.update(user.id, { refreshTokens: user.refreshTokens });
        return { user, token, refreshToken };
    }
    generateToken(user, fingerprint) {
        const payload = { id: user._id, email: user.email, role: user.role };
        if (fingerprint) {
            payload.fingerprint = {
                ip: fingerprint.ip ?? 'unknown',
                userAgent: fingerprint.userAgent ?? 'unknown',
            };
        }
        return jsonwebtoken_1.default.sign(payload, config_1.config.jwt.secret, { expiresIn: config_1.config.jwt.expiresIn });
    }
    generateRefreshTokenString(user, familyId) {
        const payload = { id: user._id, familyId: familyId ?? crypto_1.default.randomUUID(), type: 'refresh' };
        return jsonwebtoken_1.default.sign(payload, config_1.config.jwt.secret, { expiresIn: '7d' });
    }
};
exports.RegisterUserUseCase = RegisterUserUseCase;
exports.RegisterUserUseCase = RegisterUserUseCase = __decorate([
    (0, inversify_1.injectable)(),
    __param(0, (0, inversify_1.inject)(types_1.TYPES.UserRepository)),
    __metadata("design:paramtypes", [Object])
], RegisterUserUseCase);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxhcHBsaWNhdGlvblxcdXNlY2FzZXNcXFJlZ2lzdGVyVXNlclVzZUNhc2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEseUNBQStDO0FBQy9DLHdEQUE4QjtBQUM5QixvREFBNEI7QUFDNUIsZ0VBQStCO0FBRS9CLHVDQUFvQztBQUNwQywrQ0FBOEM7QUFDOUMseUNBQXNDO0FBRy9CLElBQU0sbUJBQW1CLEdBQXpCLE1BQU0sbUJBQW1CO0lBQ29CO0lBQWxELFlBQWtELGNBQStCO1FBQS9CLG1CQUFjLEdBQWQsY0FBYyxDQUFpQjtJQUFHLENBQUM7SUFFckYsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUF1RDtRQUNuRSxNQUFNLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsR0FBRyxJQUFJLENBQUM7UUFDdkMsTUFBTSxZQUFZLEdBQUcsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNsRSxJQUFJLFlBQVksRUFBRSxDQUFDO1lBQ2pCLE1BQU0sSUFBSSxpQkFBUSxDQUFDLDBDQUEwQyxFQUFFLEdBQUcsRUFBRSxZQUFZLENBQUMsQ0FBQztRQUNwRixDQUFDO1FBQ0QsTUFBTSxJQUFJLEdBQUcsTUFBTSxrQkFBTSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUN0QyxNQUFNLGNBQWMsR0FBRyxNQUFNLGtCQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUV6RCw2QkFBNkI7UUFDN0IsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsTUFBTSxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDaEYsTUFBTSxtQkFBbUIsR0FBRyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLEdB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W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxhcHBsaWNhdGlvblxcdXNlY2FzZXNcXFJlZ2lzdGVyVXNlclVzZUNhc2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaW5qZWN0YWJsZSwgaW5qZWN0IH0gZnJvbSAnaW52ZXJzaWZ5JztcbmltcG9ydCBiY3J5cHQgZnJvbSAnYmNyeXB0anMnO1xuaW1wb3J0IGNyeXB0byBmcm9tICdjcnlwdG8nO1xuaW1wb3J0IGp3dCBmcm9tICdqc29ud2VidG9rZW4nO1xuaW1wb3J0IHR5cGUgeyBJVXNlclJlcG9zaXRvcnkgfSBmcm9tICcuLi8uLi9pbmZyYXN0cnVjdHVyZS9yZXBvc2l0b3J5L1VzZXJSZXBvc2l0b3J5JztcbmltcG9ydCB7IFRZUEVTIH0gZnJvbSAnLi4vLi4vdHlwZXMnO1xuaW1wb3J0IHsgQXBwRXJyb3IgfSBmcm9tICcuLi8uLi91dGlscy9lcnJvcnMnO1xuaW1wb3J0IHsgY29uZmlnIH0gZnJvbSAnLi4vLi4vY29uZmlnJztcblxuQGluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFJlZ2lzdGVyVXNlclVzZUNhc2Uge1xuICBjb25zdHJ1Y3RvcihAaW5qZWN0KFRZUEVTLlVzZXJSZXBvc2l0b3J5KSBwcml2YXRlIHVzZXJSZXBvc2l0b3J5OiBJVXNlclJlcG9zaXRvcnkpIHt9XG5cbiAgYXN5bmMgZXhlY3V0ZShkYXRhOiB7IG5hbWU6IHN0cmluZzsgZW1haWw6IHN0cmluZzsgcGFzc3dvcmQ6IHN0cmluZyB9KSB7XG4gICAgY29uc3QgeyBuYW1lLCBlbWFpbCwgcGFzc3dvcmQgfSA9IGRhdGE7XG4gICAgY29uc3QgZXhpc3RpbmdVc2VyID0gYXdhaXQgdGhpcy51c2VyUmVwb3NpdG9yeS5maW5kQnlFbWFpbChlbWFpbCk7XG4gICAgaWYgKGV4aXN0aW5nVXNlcikge1xuICAgICAgdGhyb3cgbmV3IEFwcEVycm9yKCdFbCBjb3JyZW8gZWxlY3Ryw7NuaWNvIHlhIGVzdMOhIHJlZ2lzdHJhZG8nLCA0MDAsICdBVVRIX0VSUk9SJyk7XG4gICAgfVxuICAgIGNvbnN0IHNhbHQgPSBhd2FpdCBiY3J5cHQuZ2VuU2FsdCgxMCk7XG4gICAgY29uc3QgaGFzaGVkUGFzc3dvcmQgPSBhd2FpdCBiY3J5cHQuaGFzaChwYXNzd29yZCwgc2FsdCk7XG5cbiAgICAvLyBHZW5lcmF0ZSBWZXJpZmljYXRpb24gQ29kZVxuICAgIGNvbnN0IHZlcmlmaWNhdGlvbkNvZGUgPSBNYXRoLmZsb29yKDEwMDAwMCArIE1hdGgucmFuZG9tKCkgKiA5MDAwMDApLnRvU3RyaW5nKCk7XG4gICAgY29uc3QgdmVyaWZpY2F0aW9uRXhwaXJlcyA9IG5ldyBEYXRlKERhdGUubm93KCkgKyAxNSAqIDYwICogMTAwMCk7IC8vIDE1IG1pbnV0ZXNcblxuICAgIGNvbnNvbGUubG9nKGBbR09EIE1PREUgQVVUSF0gVmVyaWZpY2F0aW9uIENvZGUgZm9yICR7ZW1haWx9OiAke3ZlcmlmaWNhdGlvbkNvZGV9YCk7XG5cbiAgICAvLyBDcmVhdGUgdGhlIHVzZXIgdmlhIHJlcG9zaXRvcnlcbiAgICBjb25zdCB1c2VyID0gYXdhaXQgdGhpcy51c2VyUmVwb3NpdG9yeS5jcmVhdGUoJycsIHtcbiAgICAgIG5hbWUsXG4gICAgICBlbWFpbCxcbiAgICAgIHBhc3N3b3JkOiBoYXNoZWRQYXNzd29yZCxcbiAgICAgIHJvbGU6ICd1c2VyJywgLy8gRGVmYXVsdCByb2xlLCB1c2VyIHNlbGVjdHMgRmFtaWx5L1BybyBsYXRlclxuICAgICAgZW1haWxWZXJpZmljYXRpb25Db2RlOiB2ZXJpZmljYXRpb25Db2RlLFxuICAgICAgZW1haWxWZXJpZmljYXRpb25FeHBpcmVzOiB2ZXJpZmljYXRpb25FeHBpcmVzLFxuICAgICAgaXNFbWFpbFZlcmlmaWVkOiBmYWxzZSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHRva2VuID0gdGhpcy5nZW5lcmF0ZVRva2VuKHVzZXIpO1xuICAgIGNvbnN0IHJlZnJlc2hUb2tlbiA9IHRoaXMuZ2VuZXJhdGVSZWZyZXNoVG9rZW5TdHJpbmcodXNlcik7XG5cbiAgICB1c2VyLnJlZnJlc2hUb2tlbnMgPSBbXG4gICAgICB7XG4gICAgICAgIHRva2VuOiByZWZyZXNoVG9rZW4sXG4gICAgICAgIGV4cGlyZXM6IG5ldyBEYXRlKERhdGUubm93KCkgKyA3ICogMjQgKiA2MCAqIDYwICogMTAwMCksXG4gICAgICAgIGZhbWlseUlkOiBjcnlwdG8ucmFuZG9tVVVJRCgpLFxuICAgICAgICBpcDogJzEyNy4wLjAuMScsXG4gICAgICAgIHVzZXJBZ2VudDogJ3Vua25vd24nLFxuICAgICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICB9LFxuICAgIF07XG5cbiAgICAvLyBVc2UgcmVwb3NpdG9yeSB0byB1cGRhdGUgdGhlIHVzZXIgd2l0aCB0b2tlbnNcbiAgICBhd2FpdCB0aGlzLnVzZXJSZXBvc2l0b3J5LnVwZGF0ZSh1c2VyLmlkLCB7IHJlZnJlc2hUb2tlbnM6IHVzZXIucmVmcmVzaFRva2VucyB9KTtcblxuICAgIHJldHVybiB7IHVzZXIsIHRva2VuLCByZWZyZXNoVG9rZW4gfTtcbiAgfVxuXG4gIHByaXZhdGUgZ2VuZXJhdGVUb2tlbih1c2VyOiBhbnksIGZpbmdlcnByaW50PzogeyBpcD86IHN0cmluZzsgdXNlckFnZW50Pzogc3RyaW5nIH0pOiBzdHJpbmcge1xuICAgIGNvbnN0IHBheWxvYWQ6IGFueSA9IHsgaWQ6IHVzZXIuX2lkLCBlbWFpbDogdXNlci5lbWFpbCwgcm9sZTogdXNlci5yb2xlIH07XG4gICAgaWYgKGZpbmdlcnByaW50KSB7XG4gICAgICBwYXlsb2FkLmZpbmdlcnByaW50ID0ge1xuICAgICAgICBpcDogZmluZ2VycHJpbnQuaXAgPz8gJ3Vua25vd24nLFxuICAgICAgICB1c2VyQWdlbnQ6IGZpbmdlcnByaW50LnVzZXJBZ2VudCA/PyAndW5rbm93bicsXG4gICAgICB9O1xuICAgIH1cbiAgICByZXR1cm4gand0LnNpZ24ocGF5bG9hZCwgY29uZmlnLmp3dC5zZWNyZXQsIHsgZXhwaXJlc0luOiBjb25maWcuand0LmV4cGlyZXNJbiBhcyBhbnkgfSk7XG4gIH1cblxuICBwcml2YXRlIGdlbmVyYXRlUmVmcmVzaFRva2VuU3RyaW5nKHVzZXI6IGFueSwgZmFtaWx5SWQ/OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGNvbnN0IHBheWxvYWQgPSB7IGlkOiB1c2VyLl9pZCwgZmFtaWx5SWQ6IGZhbWlseUlkID8/IGNyeXB0by5yYW5kb21VVUlEKCksIHR5cGU6ICdyZWZyZXNoJyB9O1xuICAgIHJldHVybiBqd3Quc2lnbihwYXlsb2FkLCBjb25maWcuand0LnNlY3JldCwgeyBleHBpcmVzSW46ICc3ZCcgfSk7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==