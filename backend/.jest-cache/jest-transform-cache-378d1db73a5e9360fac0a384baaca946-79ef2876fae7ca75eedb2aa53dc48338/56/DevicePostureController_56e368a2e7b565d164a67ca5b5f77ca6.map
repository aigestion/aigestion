{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\controllers\\DevicePostureController.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\controllers\\DevicePostureController.ts"],"sourcesContent":["import { NextFunction, Request, Response } from 'express';\nimport { injectable, inject } from 'inversify';\nimport { buildResponse } from '../common/response-builder';\nimport { TYPES } from '../types';\nimport { DevicePostureService } from '../services/device-posture.service';\nimport { AppError } from '../utils/errors';\nimport { User } from '../models/User';\n\n@injectable()\nexport class DevicePostureController {\n  constructor(\n    @inject(TYPES.DevicePostureService)\n    private devicePostureService: DevicePostureService,\n  ) {}\n\n  /**\n   * List trusted devices for the current user\n   */\n  public getMyDevices = async (req: Request, res: Response, next: NextFunction): Promise<void> => {\n    try {\n      if (!req.user) throw new AppError('Unauthorized', 401);\n\n      const user = await User.findById(req.user.id).select('trustedDevices');\n      if (!user) throw new AppError('User not found', 404);\n\n      res.status(200).json(buildResponse(user.trustedDevices, 200, (req as any).requestId));\n    } catch (error) {\n      next(error);\n    }\n  };\n\n  /**\n   * Register a new device as trusted\n   */\n  public registerDevice = async (\n    req: Request,\n    res: Response,\n    next: NextFunction,\n  ): Promise<void> => {\n    try {\n      if (!req.user) throw new AppError('Unauthorized', 401);\n\n      const { deviceId, name, deviceInfo } = req.body;\n      if (!deviceId) throw new AppError('Device ID is required', 400);\n\n      await this.devicePostureService.registerDevice(req.user.id, {\n        deviceId,\n        name: name || 'New Device',\n        deviceInfo: deviceInfo || {},\n      });\n\n      res\n        .status(201)\n        .json(\n          buildResponse({ message: 'Device registered successfully' }, 201, (req as any).requestId),\n        );\n    } catch (error) {\n      next(error);\n    }\n  };\n\n  /**\n   * Manual posture check for a device\n   */\n  public verifyCurrentDevice = async (\n    req: Request,\n    res: Response,\n    next: NextFunction,\n  ): Promise<void> => {\n    try {\n      if (!req.user) throw new AppError('Unauthorized', 401);\n\n      const deviceId = req.headers['x-device-id'] as string;\n      if (!deviceId) throw new AppError('Device ID header (x-device-id) missing', 400);\n\n      const check = await this.devicePostureService.verifyDevice(req.user.id, {\n        deviceId,\n        os: (req.headers['x-os'] as string) || 'unknown',\n        browser: req.headers['user-agent'] || 'unknown',\n      });\n\n      res.status(200).json(buildResponse(check, 200, (req as any).requestId));\n    } catch (error) {\n      next(error);\n    }\n  };\n\n  /**\n   * Remove a trusted device\n   */\n  public revokeDevice = async (req: Request, res: Response, next: NextFunction): Promise<void> => {\n    try {\n      if (!req.user) throw new AppError('Unauthorized', 401);\n\n      const { deviceId } = req.params;\n      await User.findByIdAndUpdate(req.user.id, {\n        $pull: { trustedDevices: { deviceId } },\n      });\n\n      res\n        .status(200)\n        .json(buildResponse({ message: 'Device revoked' }, 200, (req as any).requestId));\n    } catch (error) {\n      next(error);\n    }\n  };\n}\n"],"version":3}