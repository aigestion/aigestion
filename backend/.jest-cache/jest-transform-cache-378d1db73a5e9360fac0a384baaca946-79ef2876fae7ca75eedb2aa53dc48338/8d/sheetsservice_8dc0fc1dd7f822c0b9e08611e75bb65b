27494bd88cad51c225c56f0f344215ae
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.SheetsService = void 0;
const googleapis_1 = require("googleapis");
const inversify_1 = require("inversify");
const daniela_ai_service_1 = require("./daniela-ai.service");
/**
 * Google Sheets Service
 * Integraci칩n con Google Sheets para an치lisis y reportes autom치ticos
 */
let SheetsService = class SheetsService {
    daniela;
    sheets;
    auth;
    constructor(daniela) {
        this.daniela = daniela;
    }
    async initialize() {
        this.auth = new googleapis_1.google.auth.GoogleAuth({
            keyFile: process.env.GOOGLE_APPLICATION_CREDENTIALS,
            scopes: [
                'https://www.googleapis.com/auth/spreadsheets',
                'https://www.googleapis.com/auth/drive.readonly',
            ],
        });
        this.sheets = googleapis_1.google.sheets({ version: 'v4', auth: this.auth });
    }
    async readData(spreadsheetId, range = 'Sheet1!A:Z') {
        try {
            const response = await this.sheets.spreadsheets.values.get({
                spreadsheetId,
                range,
            });
            return response.data.values || [];
        }
        catch (error) {
            console.error('Error reading sheet data:', error);
            throw error;
        }
    }
    async writeData(spreadsheetId, range, values) {
        try {
            const response = await this.sheets.spreadsheets.values.update({
                spreadsheetId,
                range,
                valueInputOption: 'USER_ENTERED',
                requestBody: { values },
            });
            return response.data;
        }
        catch (error) {
            console.error('Error writing sheet data:', error);
            throw error;
        }
    }
    async appendData(spreadsheetId, range, values) {
        try {
            const response = await this.sheets.spreadsheets.values.append({
                spreadsheetId,
                range,
                valueInputOption: 'USER_ENTERED',
                requestBody: { values },
            });
            return response.data;
        }
        catch (error) {
            console.error('Error appending sheet data:', error);
            throw error;
        }
    }
    async analyzeSheet(spreadsheetId, range = 'Sheet1!A:Z') {
        try {
            const data = await this.readData(spreadsheetId, range);
            // Convertir a formato estructura
            const headers = data[0];
            const rows = data.slice(1);
            const records = rows.map((row) => Object.fromEntries(headers.map((h, i) => [h, row[i]])));
            // Usar Daniela AI para an치lisis
            const analysis = {
                totalRows: rows.length,
                totalColumns: headers.length,
                insights: await this.daniela.processMessage(0, JSON.stringify(records), 'sheet-analysis', 'system', 'user'),
                summary: {
                    dataPoints: rows.length,
                    timestamp: new Date(),
                },
            };
            return analysis;
        }
        catch (error) {
            console.error('Error analyzing sheet:', error);
            throw error;
        }
    }
    async createReport(spreadsheetId) {
        try {
            const analysis = await this.analyzeSheet(spreadsheetId);
            const report = [
                ['Generated Report'],
                [''],
                ['Timestamp', new Date().toISOString()],
                ['Total Rows', analysis.totalRows],
                ['Total Columns', analysis.totalColumns],
                [''],
                ['Analysis', analysis.insights],
                [''],
            ];
            await this.appendData(spreadsheetId, 'Sheet1!A100:B110', report);
            return {
                status: 'success',
                report: analysis,
                timestamp: new Date(),
            };
        }
        catch (error) {
            console.error('Error creating report:', error);
            throw error;
        }
    }
    async addChart(spreadsheetId, chartData) {
        try {
            const request = {
                spreadsheetId,
                resource: {
                    requests: [
                        {
                            addChart: {
                                chart: {
                                    spec: {
                                        title: chartData.title,
                                        basicChart: {
                                            chartType: chartData.type,
                                            series: chartData.series,
                                            axis: chartData.axis,
                                        },
                                    },
                                },
                            },
                        },
                    ],
                },
            };
            return await this.sheets.spreadsheets.batchUpdate(request);
        }
        catch (error) {
            console.error('Error adding chart:', error);
            throw error;
        }
    }
    async autoFormatData(spreadsheetId, range) {
        try {
            const request = {
                spreadsheetId,
                resource: {
                    requests: [
                        {
                            autoResizeDimensions: {
                                dimensions: {
                                    sheetId: 0,
                                    dimension: 'COLUMNS',
                                },
                            },
                        },
                    ],
                },
            };
            return await this.sheets.spreadsheets.batchUpdate(request);
        }
        catch (error) {
            console.error('Error auto-formatting:', error);
            throw error;
        }
    }
};
exports.SheetsService = SheetsService;
exports.SheetsService = SheetsService = __decorate([
    (0, inversify_1.injectable)(),
    __param(0, (0, inversify_1.inject)(daniela_ai_service_1.DanielaAIService)),
    __metadata("design:paramtypes", [typeof (_a = typeof daniela_ai_service_1.DanielaAIService !== "undefined" && daniela_ai_service_1.DanielaAIService) === "function" ? _a : Object])
], SheetsService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxzZXJ2aWNlc1xcc2hlZXRzLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUFvQztBQUNwQyx5Q0FBK0M7QUFDL0MsNkRBQXdEO0FBRXhEOzs7R0FHRztBQUVJLElBQU0sYUFBYSxHQUFuQixNQUFNLGFBQWE7SUFJc0I7SUFIdEMsTUFBTSxDQUFNO0lBQ1osSUFBSSxDQUFNO0lBRWxCLFlBQThDLE9BQXlCO1FBQXpCLFlBQU8sR0FBUCxPQUFPLENBQWtCO0lBQUcsQ0FBQztJQUUzRSxLQUFLLENBQUMsVUFBVTtRQUNkLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxtQkFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUM7WUFDckMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsOEJBQThCO1lBQ25ELE1BQU0sRUFBRTtnQkFDTiw4Q0FBOEM7Z0JBQzlDLGdEQUFnRDthQUNqRDtTQUNGLENBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxNQUFNLEdBQUcsbUJBQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztJQUNsRSxDQUFDO0lBRUQsS0FBSyxDQUFDLFFBQVEsQ0FBQyxhQUFxQixFQUFFLFFBQWdCLFlBQVk7UUFDaEUsSUFBSSxDQUFDO1lBQ0gsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDO2dCQUN6RCxhQUFhO2dCQUNiLEtBQUs7YUFDTixDQUFDLENBQUM7WUFDSCxPQUFPLFFBQVEsQ0FBQyxJQUFJLENBQUMsTUFBTSxJQUFJLEVBQUUsQ0FBQztRQUNwQyxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMsMkJBQTJCLEVBQUUsS0FB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QUFnQjtHQUo1RCxhQUFhLENBa0x6QiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXEFsZWphbmRyb1xcQUlHZXN0aW9uXFxiYWNrZW5kXFxzcmNcXHNlcnZpY2VzXFxzaGVldHMuc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBnb29nbGUgfSBmcm9tICdnb29nbGVhcGlzJztcbmltcG9ydCB7IGluamVjdGFibGUsIGluamVjdCB9IGZyb20gJ2ludmVyc2lmeSc7XG5pbXBvcnQgeyBEYW5pZWxhQUlTZXJ2aWNlIH0gZnJvbSAnLi9kYW5pZWxhLWFpLnNlcnZpY2UnO1xuXG4vKipcbiAqIEdvb2dsZSBTaGVldHMgU2VydmljZVxuICogSW50ZWdyYWNpw7NuIGNvbiBHb29nbGUgU2hlZXRzIHBhcmEgYW7DoWxpc2lzIHkgcmVwb3J0ZXMgYXV0b23DoXRpY29zXG4gKi9cbkBpbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBTaGVldHNTZXJ2aWNlIHtcbiAgcHJpdmF0ZSBzaGVldHM6IGFueTtcbiAgcHJpdmF0ZSBhdXRoOiBhbnk7XG5cbiAgY29uc3RydWN0b3IoQGluamVjdChEYW5pZWxhQUlTZXJ2aWNlKSBwcml2YXRlIGRhbmllbGE6IERhbmllbGFBSVNlcnZpY2UpIHt9XG5cbiAgYXN5bmMgaW5pdGlhbGl6ZSgpIHtcbiAgICB0aGlzLmF1dGggPSBuZXcgZ29vZ2xlLmF1dGguR29vZ2xlQXV0aCh7XG4gICAgICBrZXlGaWxlOiBwcm9jZXNzLmVudi5HT09HTEVfQVBQTElDQVRJT05fQ1JFREVOVElBTFMsXG4gICAgICBzY29wZXM6IFtcbiAgICAgICAgJ2h0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL2F1dGgvc3ByZWFkc2hlZXRzJyxcbiAgICAgICAgJ2h0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL2F1dGgvZHJpdmUucmVhZG9ubHknLFxuICAgICAgXSxcbiAgICB9KTtcbiAgICB0aGlzLnNoZWV0cyA9IGdvb2dsZS5zaGVldHMoeyB2ZXJzaW9uOiAndjQnLCBhdXRoOiB0aGlzLmF1dGggfSk7XG4gIH1cblxuICBhc3luYyByZWFkRGF0YShzcHJlYWRzaGVldElkOiBzdHJpbmcsIHJhbmdlOiBzdHJpbmcgPSAnU2hlZXQxIUE6WicpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLnNoZWV0cy5zcHJlYWRzaGVldHMudmFsdWVzLmdldCh7XG4gICAgICAgIHNwcmVhZHNoZWV0SWQsXG4gICAgICAgIHJhbmdlLFxuICAgICAgfSk7XG4gICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YS52YWx1ZXMgfHwgW107XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHJlYWRpbmcgc2hlZXQgZGF0YTonLCBlcnJvcik7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICBhc3luYyB3cml0ZURhdGEoc3ByZWFkc2hlZXRJZDogc3RyaW5nLCByYW5nZTogc3RyaW5nLCB2YWx1ZXM6IGFueVtdKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5zaGVldHMuc3ByZWFkc2hlZXRzLnZhbHVlcy51cGRhdGUoe1xuICAgICAgICBzcHJlYWRzaGVldElkLFxuICAgICAgICByYW5nZSxcbiAgICAgICAgdmFsdWVJbnB1dE9wdGlvbjogJ1VTRVJfRU5URVJFRCcsXG4gICAgICAgIHJlcXVlc3RCb2R5OiB7IHZhbHVlcyB9LFxuICAgICAgfSk7XG4gICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignRXJyb3Igd3JpdGluZyBzaGVldCBkYXRhOicsIGVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGFwcGVuZERhdGEoc3ByZWFkc2hlZXRJZDogc3RyaW5nLCByYW5nZTogc3RyaW5nLCB2YWx1ZXM6IGFueVtdKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5zaGVldHMuc3ByZWFkc2hlZXRzLnZhbHVlcy5hcHBlbmQoe1xuICAgICAgICBzcHJlYWRzaGVldElkLFxuICAgICAgICByYW5nZSxcbiAgICAgICAgdmFsdWVJbnB1dE9wdGlvbjogJ1VTRVJfRU5URVJFRCcsXG4gICAgICAgIHJlcXVlc3RCb2R5OiB7IHZhbHVlcyB9LFxuICAgICAgfSk7XG4gICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgYXBwZW5kaW5nIHNoZWV0IGRhdGE6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgYW5hbHl6ZVNoZWV0KHNwcmVhZHNoZWV0SWQ6IHN0cmluZywgcmFuZ2U6IHN0cmluZyA9ICdTaGVldDEhQTpaJykge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBkYXRhID0gYXdhaXQgdGhpcy5yZWFkRGF0YShzcHJlYWRzaGVldElkLCByYW5nZSk7XG5cbiAgICAgIC8vIENvbnZlcnRpciBhIGZvcm1hdG8gZXN0cnVjdHVyYVxuICAgICAgY29uc3QgaGVhZGVycyA9IGRhdGFbMF07XG4gICAgICBjb25zdCByb3dzID0gZGF0YS5zbGljZSgxKTtcbiAgICAgIGNvbnN0IHJlY29yZHMgPSByb3dzLm1hcCgocm93OiBhbnlbXSkgPT5cbiAgICAgICAgT2JqZWN0LmZyb21FbnRyaWVzKGhlYWRlcnMubWFwKChoLCBpKSA9PiBbaCwgcm93W2ldXSkpLFxuICAgICAgKTtcblxuICAgICAgLy8gVXNhciBEYW5pZWxhIEFJIHBhcmEgYW7DoWxpc2lzXG4gICAgICBjb25zdCBhbmFseXNpcyA9IHtcbiAgICAgICAgdG90YWxSb3dzOiByb3dzLmxlbmd0aCxcbiAgICAgICAgdG90YWxDb2x1bW5zOiBoZWFkZXJzLmxlbmd0aCxcbiAgICAgICAgaW5zaWdodHM6IGF3YWl0IHRoaXMuZGFuaWVsYS5wcm9jZXNzTWVzc2FnZShcbiAgICAgICAgICAwLFxuICAgICAgICAgIEpTT04uc3RyaW5naWZ5KHJlY29yZHMpLFxuICAgICAgICAgICdzaGVldC1hbmFseXNpcycsXG4gICAgICAgICAgJ3N5c3RlbScsXG4gICAgICAgICAgJ3VzZXInLFxuICAgICAgICApLFxuICAgICAgICBzdW1tYXJ5OiB7XG4gICAgICAgICAgZGF0YVBvaW50czogcm93cy5sZW5ndGgsXG4gICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgICB9LFxuICAgICAgfTtcblxuICAgICAgcmV0dXJuIGFuYWx5c2lzO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBhbmFseXppbmcgc2hlZXQ6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgY3JlYXRlUmVwb3J0KHNwcmVhZHNoZWV0SWQ6IHN0cmluZykge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBhbmFseXNpcyA9IGF3YWl0IHRoaXMuYW5hbHl6ZVNoZWV0KHNwcmVhZHNoZWV0SWQpO1xuXG4gICAgICBjb25zdCByZXBvcnQgPSBbXG4gICAgICAgIFsnR2VuZXJhdGVkIFJlcG9ydCddLFxuICAgICAgICBbJyddLFxuICAgICAgICBbJ1RpbWVzdGFtcCcsIG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKV0sXG4gICAgICAgIFsnVG90YWwgUm93cycsIGFuYWx5c2lzLnRvdGFsUm93c10sXG4gICAgICAgIFsnVG90YWwgQ29sdW1ucycsIGFuYWx5c2lzLnRvdGFsQ29sdW1uc10sXG4gICAgICAgIFsnJ10sXG4gICAgICAgIFsnQW5hbHlzaXMnLCBhbmFseXNpcy5pbnNpZ2h0c10sXG4gICAgICAgIFsnJ10sXG4gICAgICBdO1xuXG4gICAgICBhd2FpdCB0aGlzLmFwcGVuZERhdGEoc3ByZWFkc2hlZXRJZCwgJ1NoZWV0MSFBMTAwOkIxMTAnLCByZXBvcnQpO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdGF0dXM6ICdzdWNjZXNzJyxcbiAgICAgICAgcmVwb3J0OiBhbmFseXNpcyxcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgY3JlYXRpbmcgcmVwb3J0OicsIGVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGFkZENoYXJ0KHNwcmVhZHNoZWV0SWQ6IHN0cmluZywgY2hhcnREYXRhOiBhbnkpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVxdWVzdCA9IHtcbiAgICAgICAgc3ByZWFkc2hlZXRJZCxcbiAgICAgICAgcmVzb3VyY2U6IHtcbiAgICAgICAgICByZXF1ZXN0czogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBhZGRDaGFydDoge1xuICAgICAgICAgICAgICAgIGNoYXJ0OiB7XG4gICAgICAgICAgICAgICAgICBzcGVjOiB7XG4gICAgICAgICAgICAgICAgICAgIHRpdGxlOiBjaGFydERhdGEudGl0bGUsXG4gICAgICAgICAgICAgICAgICAgIGJhc2ljQ2hhcnQ6IHtcbiAgICAgICAgICAgICAgICAgICAgICBjaGFydFR5cGU6IGNoYXJ0RGF0YS50eXBlLFxuICAgICAgICAgICAgICAgICAgICAgIHNlcmllczogY2hhcnREYXRhLnNlcmllcyxcbiAgICAgICAgICAgICAgICAgICAgICBheGlzOiBjaGFydERhdGEuYXhpcyxcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgXSxcbiAgICAgICAgfSxcbiAgICAgIH07XG5cbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnNoZWV0cy5zcHJlYWRzaGVldHMuYmF0Y2hVcGRhdGUocmVxdWVzdCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGFkZGluZyBjaGFydDonLCBlcnJvcik7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICBhc3luYyBhdXRvRm9ybWF0RGF0YShzcHJlYWRzaGVldElkOiBzdHJpbmcsIHJhbmdlOiBzdHJpbmcpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVxdWVzdCA9IHtcbiAgICAgICAgc3ByZWFkc2hlZXRJZCxcbiAgICAgICAgcmVzb3VyY2U6IHtcbiAgICAgICAgICByZXF1ZXN0czogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBhdXRvUmVzaXplRGltZW5zaW9uczoge1xuICAgICAgICAgICAgICAgIGRpbWVuc2lvbnM6IHtcbiAgICAgICAgICAgICAgICAgIHNoZWV0SWQ6IDAsXG4gICAgICAgICAgICAgICAgICBkaW1lbnNpb246ICdDT0xVTU5TJyxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICBdLFxuICAgICAgICB9LFxuICAgICAgfTtcblxuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuc2hlZXRzLnNwcmVhZHNoZWV0cy5iYXRjaFVwZGF0ZShyZXF1ZXN0KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgYXV0by1mb3JtYXR0aW5nOicsIGVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxufVxuIl0sInZlcnNpb24iOjN9