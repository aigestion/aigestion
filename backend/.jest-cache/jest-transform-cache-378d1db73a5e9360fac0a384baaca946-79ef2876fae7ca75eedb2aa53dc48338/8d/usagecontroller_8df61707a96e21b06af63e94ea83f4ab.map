{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\controllers\\usage.controller.ts","mappings":";;;;;;;;;AACA,yCAAuC;AACvC,4CAA2C;AAC3C,uDAAoD;AACpD,iEAA2D;AAC3D,4CAAyC;AAUlC,IAAM,eAAe,GAArB,MAAM,eAAe;IACnB,KAAK,CAAC,eAAe,CAAC,GAAY,EAAE,GAAa,EAAE,IAAkB;QAC1E,IAAI,CAAC;YACH,MAAM,MAAM,GAAI,GAAW,CAAC,IAAI,EAAE,EAAE,IAAI,GAAG,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC;YAEjE,IAAI,CAAC,MAAM,EAAE,CAAC;gBACZ,OAAO,IAAI,CAAC,IAAI,iBAAQ,CAAC,iBAAiB,EAAE,GAAG,EAAE,cAAc,CAAC,CAAC,CAAC;YACpE,CAAC;YAED,MAAM,GAAG,GAAG,IAAI,IAAI,EAAE,CAAC;YACvB,MAAM,eAAe,GAAG,IAAI,IAAI,CAAC,GAAG,CAAC,WAAW,EAAE,EAAE,GAAG,CAAC,QAAQ,EAAE,EAAE,CAAC,CAAC,CAAC;YAEvE,MAAM,MAAM,GAAG,MAAM,yBAAW,CAAC,SAAS,CAAC;gBACzC,EAAE,MAAM,EAAE,EAAE,MAAM,EAAE,MAAM,EAAE,SAAS,EAAE,EAAE,IAAI,EAAE,eAAe,EAAE,EAAE,EAAE;gBACpE;oBACE,MAAM,EAAE;wBACN,GAAG,EAAE,IAAI;wBACT,WAAW,EAAE,EAAE,IAAI,EAAE,cAAc,EAAE;wBACrC,aAAa,EAAE,EAAE,IAAI,EAAE,eAAe,EAAE;wBACxC,KAAK,EAAE,EAAE,IAAI,EAAE,CAAC,EAAE;qBACnB;iBACF;aACF,CAAC,CAAC;YAEH,MAAM,KAAK,GAAG,MAAM,CAAC,CAAC,CAAC,IAAI,EAAE,WAAW,EAAE,CAAC,EAAE,aAAa,EAAE,CAAC,EAAE,KAAK,EAAE,CAAC,EAAE,CAAC;YAC1E,MAAM,IAAI,GACR,OAAO,KAAK,CAAC,aAAa,KAAK,QAAQ,CAAC,CAAC,CAAC,KAAK,CAAC,aAAa,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,MAAM,CAAC;YAEpF,MAAM,MAAM,GAAuB;gBACjC,IAAI,EAAE,WAAW;gBACjB,SAAS,EAAE,QAAQ;gBACnB,QAAQ,EAAE;oBACR;wBACE,IAAI,EAAE,WAAW;wBACjB,SAAS,EAAE,KAAK;wBAChB,QAAQ,EAAE;4BACR,EAAE,IAAI,EAAE,MAAM,EAAE,KAAK,EAAE,oBAAoB,EAAE,KAAK,EAAE,KAAK,CAAC,WAAW,EAAE,KAAK,EAAE,IAAI,EAAE;4BACpF,EAAE,IAAI,EAAE,MAAM,EAAE,KAAK,EAAE,WAAW,EAAE,KAAK,EAAE,IAAI,IAAI,EAAE,EAAE,KAAK,EAAE,SAAS,EAAE;yBAC1E;qBACF;oBACD;wBACE,IAAI,EAAE,MAAM;wBACZ,KAAK,EAAE,qBAAqB;wBAC5B,OAAO,EACL,4FAA4F;wBAC9F,OAAO,EAAE,OAAO;qBACjB;iBACF;aACF,CAAC;YAEF,GAAG,CAAC,IAAI,CAAC,IAAA,gCAAa,EAAC,MAAM,EAAE,GAAG,EAAG,GAAW,CAAC,SAAS,CAAC,CAAC,CAAC;QAC/D,CAAC;QAAC,OAAO,GAAG,EAAE,CAAC;YACb,eAAM,CAAC,KAAK,CAAC,GAAG,EAAE,8BAA8B,CAAC,CAAC;YAClD,IAAI,CAAC,GAAG,CAAC,CAAC;QACZ,CAAC;IACH,CAAC;CACF,CAAA;AAxDY,0CAAe;0BAAf,eAAe;IAD3B,IAAA,sBAAU,GAAE;GACA,eAAe,CAwD3B","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\controllers\\usage.controller.ts"],"sourcesContent":["import { NextFunction, Request, Response } from 'express';\nimport { injectable } from 'inversify';\nimport { AppError } from '../utils/errors';\nimport { UsageRecord } from '../models/UsageRecord';\nimport { buildResponse } from '../common/response-builder';\nimport { logger } from '../utils/logger';\n\n// Generative UI Schema shared with Frontend\ntype GenerativeUISchema =\n  | { type: 'card'; title?: string; content: string; variant?: 'default' | 'glass' | 'outline' }\n  | { type: 'stat'; label: string; value: string | number; trend?: 'up' | 'down' | 'neutral' }\n  | { type: 'list'; items: string[]; title?: string }\n  | { type: 'container'; direction: 'row' | 'column'; children: GenerativeUISchema[] };\n\n@injectable()\nexport class UsageController {\n  public async getCurrentUsage(req: Request, res: Response, next: NextFunction) {\n    try {\n      const userId = (req as any).user?.id || req.headers['x-user-id'];\n\n      if (!userId) {\n        return next(new AppError('User ID unknown', 401, 'UNAUTHORIZED'));\n      }\n\n      const now = new Date();\n      const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);\n\n      const result = await UsageRecord.aggregate([\n        { $match: { userId: userId, createdAt: { $gte: firstDayOfMonth } } },\n        {\n          $group: {\n            _id: null,\n            totalTokens: { $sum: '$totalTokens' },\n            estimatedCost: { $sum: '$costEstimate' },\n            count: { $sum: 1 },\n          },\n        },\n      ]);\n\n      const stats = result[0] || { totalTokens: 0, estimatedCost: 0, count: 0 };\n      const cost =\n        typeof stats.estimatedCost === 'number' ? stats.estimatedCost.toFixed(4) : '0.00';\n\n      const schema: GenerativeUISchema = {\n        type: 'container',\n        direction: 'column',\n        children: [\n          {\n            type: 'container',\n            direction: 'row',\n            children: [\n              { type: 'stat', label: 'Total Tokens (MTH)', value: stats.totalTokens, trend: 'up' },\n              { type: 'stat', label: 'Est. Cost', value: `$${cost}`, trend: 'neutral' },\n            ],\n          },\n          {\n            type: 'card',\n            title: 'Current Plan Status',\n            content:\n              'You are on the Metered Plan. Usage is calculated daily and billed at the end of the month.',\n            variant: 'glass',\n          },\n        ],\n      };\n\n      res.json(buildResponse(schema, 200, (req as any).requestId));\n    } catch (err) {\n      logger.error(err, 'Error fetching current usage');\n      next(err);\n    }\n  }\n}\n"],"version":3}