{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\controllers\\SovereignBiometricsController.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\controllers\\SovereignBiometricsController.ts"],"sourcesContent":["import { Request, Response } from 'express';\r\nimport { inject } from 'inversify';\r\nimport { controller, httpPost, request, response } from 'inversify-express-utils';\r\nimport { TYPES } from '../types';\r\nimport { VoiceBiometricsService } from '../services/VoiceBiometricsService';\r\nimport { logger } from '../utils/logger';\r\nimport { setCache, getCache } from '../cache/redis';\r\n\r\n@controller('/auth/sovereign/biometrics')\r\nexport class SovereignBiometricsController {\r\n  constructor(\r\n    @inject(TYPES.VoiceBiometricsService) private voiceService: VoiceBiometricsService\r\n  ) {}\r\n\r\n  /**\r\n   * Enrolls a user's voiceprint.\r\n   * Expects a base64 encoded audio buffer in the body.\r\n   */\r\n  @httpPost('/enroll-voice')\r\n  public async enrollVoice(@request() req: Request, @response() res: Response) {\r\n    try {\r\n      const { audio, userId } = req.body;\r\n      if (!audio) return res.status(400).json({ error: 'Missing audio data' });\r\n\r\n      const audioBuffer = Buffer.from(audio, 'base64');\r\n      const voiceHash = await this.voiceService.generateVoiceHash(audioBuffer);\r\n\r\n      // Store the voiceprint in a persistent way (mocked with Redis for now, should be in User DB)\r\n      // In a real implementation, we'd associate this with the Sovereign Identity.\r\n      await setCache(`sovereign:voiceprint:${userId || 'default'}`, voiceHash);\r\n\r\n      logger.info({ userId }, '[SovereignBiometrics] Voice enrolled successfully');\r\n\r\n      return res.json({\r\n        success: true,\r\n        message: 'Voiceprint enrolled and locked in vault.',\r\n        voiceHash: voiceHash.substring(0, 10) + '...'\r\n      });\r\n    } catch (error) {\r\n      logger.error('[SovereignBiometrics] Enrollment failed:', error);\r\n      return res.status(500).json({ error: 'Biometric enrollment failed' });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Verifies a voice challenge.\r\n   */\r\n  @httpPost('/verify-voice')\r\n  public async verifyVoice(@request() req: Request, @response() res: Response) {\r\n    try {\r\n      const { audio, userId } = req.body;\r\n      if (!audio) return res.status(400).json({ error: 'Missing audio data' });\r\n\r\n      const storedHash = await getCache(`sovereign:voiceprint:${userId || 'default'}`);\r\n      if (!storedHash) {\r\n        return res.status(404).json({ error: 'No voiceprint found for this user' });\r\n      }\r\n\r\n      const audioBuffer = Buffer.from(audio, 'base64');\r\n      const isValid = await this.voiceService.verifyVoiceprint(storedHash, audioBuffer);\r\n\r\n      if (!isValid) {\r\n        return res.status(401).json({ error: 'Biometric mismatch' });\r\n      }\r\n\r\n      return res.json({\r\n        success: true,\r\n        message: 'Voice identity verified.'\r\n      });\r\n    } catch (error) {\r\n      logger.error('[SovereignBiometrics] Verification failed:', error);\r\n      return res.status(500).json({ error: 'Biometric verification failed' });\r\n    }\r\n  }\r\n}\r\n"],"version":3}