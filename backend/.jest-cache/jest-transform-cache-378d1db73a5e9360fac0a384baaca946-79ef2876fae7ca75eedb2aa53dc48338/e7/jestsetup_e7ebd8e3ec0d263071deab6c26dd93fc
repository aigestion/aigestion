54ff3709d1d7f01af717735e284f20a7
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
// ============================================
// Global module mocks (prevent external service init)
// ============================================
jest.mock('@supabase/supabase-js', () => ({
    createClient: jest.fn(() => ({
        from: jest.fn(() => ({
            select: jest.fn().mockReturnThis(),
            insert: jest.fn().mockReturnThis(),
            update: jest.fn().mockReturnThis(),
            upsert: jest.fn().mockReturnThis(),
            delete: jest.fn().mockReturnThis(),
            eq: jest.fn().mockReturnThis(),
            neq: jest.fn().mockReturnThis(),
            limit: jest.fn().mockReturnThis(),
            single: jest.fn().mockResolvedValue({ data: null, error: null }),
            maybeSingle: jest.fn().mockResolvedValue({ data: null, error: null }),
        })),
        rpc: jest.fn().mockResolvedValue({ data: [], error: null }),
        auth: {
            getSession: jest.fn().mockResolvedValue({ data: { session: null }, error: null }),
            getUser: jest.fn().mockResolvedValue({ data: { user: null }, error: null }),
        },
        storage: {
            from: jest.fn(() => ({
                upload: jest.fn().mockResolvedValue({ data: { path: 'mock' }, error: null }),
                download: jest.fn().mockResolvedValue({ data: null, error: null }),
            })),
        },
    })),
}));
// Mock whatwg-url to avoid the TypeError
jest.mock('whatwg-url', () => ({
    URL: class MockURL {
        constructor(url, base) {
            this.href = url;
            this.origin = base || '';
            this.protocol = 'https:';
            this.host = 'localhost';
            this.hostname = 'localhost';
            this.port = '';
            this.pathname = '/';
            this.search = '';
            this.hash = '';
        }
        href;
        origin;
        protocol;
        host;
        hostname;
        port;
        pathname;
        search;
        hash;
        toString() {
            return this.href;
        }
    },
    URLSearchParams: class MockURLSearchParams {
        constructor(init) {
            // Simple mock implementation
        }
        append(name, value) { }
        delete(name) { }
        get(name) {
            return null;
        }
        has(name) {
            return false;
        }
        set(name, value) { }
        toString() {
            return '';
        }
    },
}));
// ============================================
// CRITICAL: Set NODE_ENV before ANY imports
// ============================================
process.env.NODE_ENV = 'test';
// ============================================
// SECURITY: Override DB URIs to NEVER use production
// ============================================
process.env.MONGODB_URI = 'mongodb://127.0.0.1:27017/aigestion-test-jest';
process.env.DATABASE_URL = 'mongodb://127.0.0.1:27017/aigestion-test-jest';
// ============================================
// Auth env vars (required by jsonwebtoken.sign)
// ============================================
process.env.JWT_SECRET = 'test-jwt-secret-at-least-32-chars-long-for-security-check';
process.env.JWT_EXPIRES_IN = '7d';
process.env.JWT_COOKIE_EXPIRES_IN = '7';
process.env.REFRESH_TOKEN_SECRET = 'test-refresh-secret-test-refresh-secret';
// ============================================
// Service mocks
// ============================================
process.env.SUPABASE_URL = 'https://mock-project.supabase.co';
process.env.SUPABASE_KEY =
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vY2siLCJyb2xlIjoiYW5vbiIsImlhdCI6MTYwMDAwMDAwMCwiZXhwIjoxOTAwMDAwMDAwfQ.mock-signature';
process.env.REDIS_URL = 'redis://localhost:6379';
process.env.ENABLE_REDIS = 'false'; // Use mock Redis in tests
process.env.SKIP_ENV_VALIDATION = 'true';
process.env.MONGOMS_DOWNLOAD_DIR = './.mongodb-binaries';
jest.setTimeout(120000);
const testDatabase_1 = require("./src/testDatabase");
const mongoose_1 = __importDefault(require("mongoose"));
require("ts-node/register");
require("tsconfig-paths/register");
const util_1 = require("util");
// Fix for whatwg-url global issue
global.TextEncoder = util_1.TextEncoder;
global.TextDecoder = util_1.TextDecoder;
// Setup and teardown
beforeAll(async () => {
    console.log('ðŸ” [DEBUG] Pre-loading mongoose...');
    try {
        await (0, testDatabase_1.startInMemoryMongo)();
        console.log('âœ… [DEBUG] Mongoose loaded successfully in jest.setup.ts');
    }
    catch (error) {
        console.log('âŒ [DEBUG] Mongoose loading failed:', error);
    }
});
afterAll(async () => {
    try {
        await (0, testDatabase_1.stopInMemoryMongo)();
    }
    catch (e) {
        // Ignore â€” some test suites mock mongoose
    }
    try {
        if (mongoose_1.default.connection && typeof mongoose_1.default.connection.close === 'function') {
            await mongoose_1.default.connection.close();
        }
    }
    catch (e) {
        // Ignore â€” connection may already be closed or mocked
    }
});
// Environment variables set at the top
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcamVzdC5zZXR1cC50cyIsIm1hcHBpbmdzIjoiOzs7OztBQThCQSwrQ0FBK0M7QUFDL0Msc0RBQXNEO0FBQ3RELCtDQUErQztBQUMvQyxJQUFJLENBQUMsSUFBSSxDQUFDLHVCQUF1QixFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDeEMsWUFBWSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUMzQixJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBQ25CLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsY0FBYyxFQUFFO1lBQ2xDLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsY0FBYyxFQUFFO1lBQ2xDLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsY0FBYyxFQUFFO1lBQ2xDLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsY0FBYyxFQUFFO1lBQ2xDLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsY0FBYyxFQUFFO1lBQ2xDLEVBQUUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsY0FBYyxFQUFFO1lBQzlCLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsY0FBYyxFQUFFO1lBQy9CLEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsY0FBYyxFQUFFO1lBQ2pDLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQztZQUNoRSxXQUFXLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUM7U0FDdEUsQ0FBQyxDQUFDO1FBQ0gsR0FBRyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDO1FBQzNELElBQUksRUFBRTtZQUNKLFVBQVUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsRUFBRSxJQUFJLEVBQUUsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDO1lBQ2pGLE9BQU8sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsRUFBRSxJQUFJLEVBQUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDO1NBQzVFO1FBQ0QsT0FBTyxFQUFFO1lBQ1AsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztnQkFDbkIsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLElBQUksRUFBRSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUM7Z0JBQzVFLFFBQVEsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQzthQUNuRSxDQUFDLENBQUM7U0FDSjtLQUNGLENBQUMsQ0FBQztDQUNKLENBQUMsQ0FBQyxDQUFDO0FBY0oseUNBQXlDO0FBQ3pDLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDN0IsR0FBRyxFQUFFLE1BQU0sT0FBTztRQUNoQixZQUFZLEdBQVcsRUFBRSxJQUFhO1lBQ3BDLElBQUksQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDO1lBQ2hCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztZQUN6QixJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztZQUN6QixJQUFJLENBQUMsSUFBSSxHQUFHLFdBQVcsQ0FBQztZQUN4QixJQUFJLENBQUMsUUFBUSxHQUFHLFdBQVcsQ0FBQztZQUM1QixJQUFJLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztZQUNmLElBQUksQ0FBQyxRQUFRLEdBQUcsR0FBRyxDQUFDO1lBQ3BCLElBQUksQ0FBQyxNQUFNLEdBQUcsRUFBRSxDQUFDO1lBQ2pCLElBQUksQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ2pCLENBQUM7UUFDRCxJQUFJLENBQVM7UUFDYixNQUFNLENBQVM7UUFDZixRQUFRLENBQVM7UUFDakIsSUFBSSxDQUFTO1FBQ2IsUUFBUSxDQUFTO1FBQ2pCLElBQUksQ0FBUztRQUNiLFFBQVEsQ0FBUztRQUNqQixNQUFNLENBQVM7UUFDZixJQUFJLENBQVM7UUFDYixRQUFRO1lBQ04sT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBQ25CLENBQUM7S0FDRjtJQUNELGVBQWUsRUFBRSxNQUFNLG1CQUFtQjtRQUN4QyxZQUFZLElBQWdGO1lBQzFGLDZCQUE2QjtRQUMvQixDQUFDO1FBQ0QsTUFBTSxDQUFDLElBQVksRUFBRSxLQUFhLElBQUcsQ0FBQztRQUN0QyxNQUFNLENBQUMsSUFBWSxJQUFHLENBQUM7UUFDdkIsR0FBRyxDQUFDLElBQVk7WUFDZCxPQUFPLElBQUksQ0FBQztRQUNkLENBQUM7UUFDRCxHQUFHLENBQUMsSUFBWTtZQUNkLE9BQU8sS0FBSyxDQUFDO1FBQ2YsQ0FBQztRQUNELEdBQUcsQ0FBQyxJQUFZLEVBQUUsS0FBYSxJQUFHLENBQUM7UUFDbkMsUUFBUTtZQUNOLE9BQU8sRUFBRSxDQUFDO1FBQ1osQ0FBQztLQUNGO0NBQ0YsQ0FBQyxDQUFDLENBQUM7QUFySEosK0NBQStDO0FBQy9DLDRDQUE0QztBQUM1QywrQ0FBK0M7QUFDL0MsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDO0FBRTlCLCtDQUErQztBQUMvQyxxREFBcUQ7QUFDckQsK0NBQStDO0FBQy9DLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxHQUFHLCtDQUErQyxDQUFDO0FBQzFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxHQUFHLCtDQUErQyxDQUFDO0FBRTNFLCtDQUErQztBQUMvQyxnREFBZ0Q7QUFDaEQsK0NBQStDO0FBQy9DLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxHQUFHLDJEQUEyRCxDQUFDO0FBQ3JGLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQztBQUNsQyxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFxQixHQUFHLEdBQUcsQ0FBQztBQUN4QyxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixHQUFHLHlDQUF5QyxDQUFDO0FBRTdFLCtDQUErQztBQUMvQyxnQkFBZ0I7QUFDaEIsK0NBQStDO0FBQy9DLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxHQUFHLGtDQUFrQyxDQUFDO0FBQzlELE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWTtJQUN0QixnS0FBZ0ssQ0FBQztBQUNuSyxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsR0FBRyx3QkFBd0IsQ0FBQztBQUNqRCxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksR0FBRyxPQUFPLENBQUMsQ0FBQywwQkFBMEI7QUFDOUQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsR0FBRyxNQUFNLENBQUM7QUFDekMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsR0FBRyxxQkFBcUIsQ0FBQztBQWlDekQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUV4QixxREFBMkU7QUFDM0Usd0RBQWdDO0FBQ2hDLDRCQUEwQjtBQUMxQixtQ0FBaUM7QUFDakMsK0JBQWdEO0FBRWhELGtDQUFrQztBQUNsQyxNQUFNLENBQUMsV0FBVyxHQUFHLGtCQUF1RCxDQUFDO0FBQzdFLE1BQU0sQ0FBQyxXQUFXLEdBQUcsa0JBQXVELENBQUM7QUFnRDdFLHFCQUFxQjtBQUNyQixTQUFTLENBQUMsS0FBSyxJQUFJLEVBQUU7SUFDbkIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO0lBQ2xELElBQUksQ0FBQztRQUNILE1BQU0sSUFBQSxpQ0FBa0IsR0FBRSxDQUFDO1FBQzNCLE9BQU8sQ0FBQyxHQUFHLENBQUMseURBQXlELENBQUMsQ0FBQztJQUN6RSxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0NBQW9DLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDM0QsQ0FBQztBQUNILENBQUMsQ0FBQyxDQUFDO0FBRUgsUUFBUSxDQUFDLEtBQUssSUFBSSxFQUFFO0lBQ2xCLElBQUksQ0FBQztRQUNILE1BQU0sSUFBQSxnQ0FBaUIsR0FBRSxDQUFDO0lBQzVCLENBQUM7SUFBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1FBQ1gsMENBQTBDO0lBQzVDLENBQUM7SUFDRCxJQUFJLENBQUM7UUFDSCxJQUFJLGtCQUFRLENBQUMsVUFBVSxJQUFJLE9BQU8sa0JBQVEsQ0FBQyxVQUFVLENBQUMsS0FBSyxLQUFLLFVBQVUsRUFBRSxDQUFDO1lBQzNFLE1BQU0sa0JBQVEsQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDcEMsQ0FBQztJQUNILENBQUM7SUFBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1FBQ1gsc0RBQXNEO0lBQ3hELENBQUM7QUFDSCxDQUFDLENBQUMsQ0FBQztBQUVILHVDQUF1QyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXEFsZWphbmRyb1xcQUlHZXN0aW9uXFxiYWNrZW5kXFxqZXN0LnNldHVwLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBDUklUSUNBTDogU2V0IE5PREVfRU5WIGJlZm9yZSBBTlkgaW1wb3J0c1xuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbnByb2Nlc3MuZW52Lk5PREVfRU5WID0gJ3Rlc3QnO1xuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gU0VDVVJJVFk6IE92ZXJyaWRlIERCIFVSSXMgdG8gTkVWRVIgdXNlIHByb2R1Y3Rpb25cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5wcm9jZXNzLmVudi5NT05HT0RCX1VSSSA9ICdtb25nb2RiOi8vMTI3LjAuMC4xOjI3MDE3L2FpZ2VzdGlvbi10ZXN0LWplc3QnO1xucHJvY2Vzcy5lbnYuREFUQUJBU0VfVVJMID0gJ21vbmdvZGI6Ly8xMjcuMC4wLjE6MjcwMTcvYWlnZXN0aW9uLXRlc3QtamVzdCc7XG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBBdXRoIGVudiB2YXJzIChyZXF1aXJlZCBieSBqc29ud2VidG9rZW4uc2lnbilcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5wcm9jZXNzLmVudi5KV1RfU0VDUkVUID0gJ3Rlc3Qtand0LXNlY3JldC1hdC1sZWFzdC0zMi1jaGFycy1sb25nLWZvci1zZWN1cml0eS1jaGVjayc7XG5wcm9jZXNzLmVudi5KV1RfRVhQSVJFU19JTiA9ICc3ZCc7XG5wcm9jZXNzLmVudi5KV1RfQ09PS0lFX0VYUElSRVNfSU4gPSAnNyc7XG5wcm9jZXNzLmVudi5SRUZSRVNIX1RPS0VOX1NFQ1JFVCA9ICd0ZXN0LXJlZnJlc2gtc2VjcmV0LXRlc3QtcmVmcmVzaC1zZWNyZXQnO1xuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gU2VydmljZSBtb2Nrc1xuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbnByb2Nlc3MuZW52LlNVUEFCQVNFX1VSTCA9ICdodHRwczovL21vY2stcHJvamVjdC5zdXBhYmFzZS5jbyc7XG5wcm9jZXNzLmVudi5TVVBBQkFTRV9LRVkgPVxuICAnZXlKaGJHY2lPaUpJVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKemRYQmhZbUZ6WlNJc0luSmxaaUk2SW0xdlkyc2lMQ0p5YjJ4bElqb2lZVzV2YmlJc0ltbGhkQ0k2TVRZd01EQXdNREF3TUN3aVpYaHdJam94T1RBd01EQXdNREF3ZlEubW9jay1zaWduYXR1cmUnO1xucHJvY2Vzcy5lbnYuUkVESVNfVVJMID0gJ3JlZGlzOi8vbG9jYWxob3N0OjYzNzknO1xucHJvY2Vzcy5lbnYuRU5BQkxFX1JFRElTID0gJ2ZhbHNlJzsgLy8gVXNlIG1vY2sgUmVkaXMgaW4gdGVzdHNcbnByb2Nlc3MuZW52LlNLSVBfRU5WX1ZBTElEQVRJT04gPSAndHJ1ZSc7XG5wcm9jZXNzLmVudi5NT05HT01TX0RPV05MT0FEX0RJUiA9ICcuLy5tb25nb2RiLWJpbmFyaWVzJztcblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIEdsb2JhbCBtb2R1bGUgbW9ja3MgKHByZXZlbnQgZXh0ZXJuYWwgc2VydmljZSBpbml0KVxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbmplc3QubW9jaygnQHN1cGFiYXNlL3N1cGFiYXNlLWpzJywgKCkgPT4gKHtcbiAgY3JlYXRlQ2xpZW50OiBqZXN0LmZuKCgpID0+ICh7XG4gICAgZnJvbTogamVzdC5mbigoKSA9PiAoe1xuICAgICAgc2VsZWN0OiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgICAgIGluc2VydDogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgICB1cGRhdGU6IGplc3QuZm4oKS5tb2NrUmV0dXJuVGhpcygpLFxuICAgICAgdXBzZXJ0OiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgICAgIGRlbGV0ZTogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgICBlcTogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgICBuZXE6IGplc3QuZm4oKS5tb2NrUmV0dXJuVGhpcygpLFxuICAgICAgbGltaXQ6IGplc3QuZm4oKS5tb2NrUmV0dXJuVGhpcygpLFxuICAgICAgc2luZ2xlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoeyBkYXRhOiBudWxsLCBlcnJvcjogbnVsbCB9KSxcbiAgICAgIG1heWJlU2luZ2xlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoeyBkYXRhOiBudWxsLCBlcnJvcjogbnVsbCB9KSxcbiAgICB9KSksXG4gICAgcnBjOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoeyBkYXRhOiBbXSwgZXJyb3I6IG51bGwgfSksXG4gICAgYXV0aDoge1xuICAgICAgZ2V0U2Vzc2lvbjogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHsgZGF0YTogeyBzZXNzaW9uOiBudWxsIH0sIGVycm9yOiBudWxsIH0pLFxuICAgICAgZ2V0VXNlcjogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHsgZGF0YTogeyB1c2VyOiBudWxsIH0sIGVycm9yOiBudWxsIH0pLFxuICAgIH0sXG4gICAgc3RvcmFnZToge1xuICAgICAgZnJvbTogamVzdC5mbigoKSA9PiAoe1xuICAgICAgICB1cGxvYWQ6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IGRhdGE6IHsgcGF0aDogJ21vY2snIH0sIGVycm9yOiBudWxsIH0pLFxuICAgICAgICBkb3dubG9hZDogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHsgZGF0YTogbnVsbCwgZXJyb3I6IG51bGwgfSksXG4gICAgICB9KSksXG4gICAgfSxcbiAgfSkpLFxufSkpO1xuXG5qZXN0LnNldFRpbWVvdXQoMTIwMDAwKTtcblxuaW1wb3J0IHsgc3RhcnRJbk1lbW9yeU1vbmdvLCBzdG9wSW5NZW1vcnlNb25nbyB9IGZyb20gJy4vc3JjL3Rlc3REYXRhYmFzZSc7XG5pbXBvcnQgbW9uZ29vc2UgZnJvbSAnbW9uZ29vc2UnO1xuaW1wb3J0ICd0cy1ub2RlL3JlZ2lzdGVyJztcbmltcG9ydCAndHNjb25maWctcGF0aHMvcmVnaXN0ZXInO1xuaW1wb3J0IHsgVGV4dEVuY29kZXIsIFRleHREZWNvZGVyIH0gZnJvbSAndXRpbCc7XG5cbi8vIEZpeCBmb3Igd2hhdHdnLXVybCBnbG9iYWwgaXNzdWVcbmdsb2JhbC5UZXh0RW5jb2RlciA9IFRleHRFbmNvZGVyIGFzIHVua25vd24gYXMgdHlwZW9mIGdsb2JhbFRoaXMuVGV4dEVuY29kZXI7XG5nbG9iYWwuVGV4dERlY29kZXIgPSBUZXh0RGVjb2RlciBhcyB1bmtub3duIGFzIHR5cGVvZiBnbG9iYWxUaGlzLlRleHREZWNvZGVyO1xuXG4vLyBNb2NrIHdoYXR3Zy11cmwgdG8gYXZvaWQgdGhlIFR5cGVFcnJvclxuamVzdC5tb2NrKCd3aGF0d2ctdXJsJywgKCkgPT4gKHtcbiAgVVJMOiBjbGFzcyBNb2NrVVJMIHtcbiAgICBjb25zdHJ1Y3Rvcih1cmw6IHN0cmluZywgYmFzZT86IHN0cmluZykge1xuICAgICAgdGhpcy5ocmVmID0gdXJsO1xuICAgICAgdGhpcy5vcmlnaW4gPSBiYXNlIHx8ICcnO1xuICAgICAgdGhpcy5wcm90b2NvbCA9ICdodHRwczonO1xuICAgICAgdGhpcy5ob3N0ID0gJ2xvY2FsaG9zdCc7XG4gICAgICB0aGlzLmhvc3RuYW1lID0gJ2xvY2FsaG9zdCc7XG4gICAgICB0aGlzLnBvcnQgPSAnJztcbiAgICAgIHRoaXMucGF0aG5hbWUgPSAnLyc7XG4gICAgICB0aGlzLnNlYXJjaCA9ICcnO1xuICAgICAgdGhpcy5oYXNoID0gJyc7XG4gICAgfVxuICAgIGhyZWY6IHN0cmluZztcbiAgICBvcmlnaW46IHN0cmluZztcbiAgICBwcm90b2NvbDogc3RyaW5nO1xuICAgIGhvc3Q6IHN0cmluZztcbiAgICBob3N0bmFtZTogc3RyaW5nO1xuICAgIHBvcnQ6IHN0cmluZztcbiAgICBwYXRobmFtZTogc3RyaW5nO1xuICAgIHNlYXJjaDogc3RyaW5nO1xuICAgIGhhc2g6IHN0cmluZztcbiAgICB0b1N0cmluZygpIHtcbiAgICAgIHJldHVybiB0aGlzLmhyZWY7XG4gICAgfVxuICB9LFxuICBVUkxTZWFyY2hQYXJhbXM6IGNsYXNzIE1vY2tVUkxTZWFyY2hQYXJhbXMge1xuICAgIGNvbnN0cnVjdG9yKGluaXQ/OiBzdHJpbmcgfCBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+IHwgc3RyaW5nW11bXSB8IEl0ZXJhYmxlPFtzdHJpbmcsIHN0cmluZ10+KSB7XG4gICAgICAvLyBTaW1wbGUgbW9jayBpbXBsZW1lbnRhdGlvblxuICAgIH1cbiAgICBhcHBlbmQobmFtZTogc3RyaW5nLCB2YWx1ZTogc3RyaW5nKSB7fVxuICAgIGRlbGV0ZShuYW1lOiBzdHJpbmcpIHt9XG4gICAgZ2V0KG5hbWU6IHN0cmluZykge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIGhhcyhuYW1lOiBzdHJpbmcpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgc2V0KG5hbWU6IHN0cmluZywgdmFsdWU6IHN0cmluZykge31cbiAgICB0b1N0cmluZygpIHtcbiAgICAgIHJldHVybiAnJztcbiAgICB9XG4gIH0sXG59KSk7XG5cbi8vIFNldHVwIGFuZCB0ZWFyZG93blxuYmVmb3JlQWxsKGFzeW5jICgpID0+IHtcbiAgY29uc29sZS5sb2coJ/CflI0gW0RFQlVHXSBQcmUtbG9hZGluZyBtb25nb29zZS4uLicpO1xuICB0cnkge1xuICAgIGF3YWl0IHN0YXJ0SW5NZW1vcnlNb25nbygpO1xuICAgIGNvbnNvbGUubG9nKCfinIUgW0RFQlVHXSBNb25nb29zZSBsb2FkZWQgc3VjY2Vzc2Z1bGx5IGluIGplc3Quc2V0dXAudHMnKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmxvZygn4p2MIFtERUJVR10gTW9uZ29vc2UgbG9hZGluZyBmYWlsZWQ6JywgZXJyb3IpO1xuICB9XG59KTtcblxuYWZ0ZXJBbGwoYXN5bmMgKCkgPT4ge1xuICB0cnkge1xuICAgIGF3YWl0IHN0b3BJbk1lbW9yeU1vbmdvKCk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICAvLyBJZ25vcmUg4oCUIHNvbWUgdGVzdCBzdWl0ZXMgbW9jayBtb25nb29zZVxuICB9XG4gIHRyeSB7XG4gICAgaWYgKG1vbmdvb3NlLmNvbm5lY3Rpb24gJiYgdHlwZW9mIG1vbmdvb3NlLmNvbm5lY3Rpb24uY2xvc2UgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIGF3YWl0IG1vbmdvb3NlLmNvbm5lY3Rpb24uY2xvc2UoKTtcbiAgICB9XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICAvLyBJZ25vcmUg4oCUIGNvbm5lY3Rpb24gbWF5IGFscmVhZHkgYmUgY2xvc2VkIG9yIG1vY2tlZFxuICB9XG59KTtcblxuLy8gRW52aXJvbm1lbnQgdmFyaWFibGVzIHNldCBhdCB0aGUgdG9wXG4iXSwidmVyc2lvbiI6M30=