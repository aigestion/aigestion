{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\controllers\\webauthn.controller.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\controllers\\webauthn.controller.ts"],"sourcesContent":["import { Request, Response } from 'express';\r\nimport { controller, httpGet, httpPost, request, response } from 'inversify-express-utils';\r\nimport { inject } from 'inversify';\r\nimport {\r\n  generateRegistrationOptions,\r\n  verifyRegistrationResponse,\r\n  generateAuthenticationOptions,\r\n  verifyAuthenticationResponse,\r\n} from '@simplewebauthn/server';\r\nimport { TYPES } from '../types';\r\nimport { IUserRepository } from '../infrastructure/repository/UserRepository';\r\nimport { logger } from '../utils/logger';\r\nimport { config } from '../config';\r\nimport { setCache, getCache } from '../cache/redis';\r\n\r\nconst sovereignConfig = config as any; // Cast to bypass lint/sync issues with new properties\r\n\r\n@controller('/auth/webauthn')\r\nexport class WebAuthnController {\r\n  constructor(@inject(TYPES.UserRepository) private userRepository: IUserRepository) {}\r\n\r\n  @httpGet('/register-options')\r\n  async getRegisterOptions(@request() req: Request, @response() res: Response) {\r\n    try {\r\n      const user = await this.userRepository.findById(req.user?.id);\r\n      if (!user) return res.status(404).json({ error: 'User not found' });\r\n\r\n      const options = await generateRegistrationOptions({\r\n        rpName: 'AIGestion Sovereign Registry',\r\n        rpID: sovereignConfig.webauthn.rpID,\r\n        userID: Buffer.from(user.id),\r\n        userName: user.email,\r\n        attestationType: 'none',\r\n        authenticatorSelection: {\r\n          residentKey: 'preferred',\r\n          userVerification: 'preferred',\r\n        },\r\n      });\r\n\r\n      // Save challenge to Redis instead of session\r\n      const challengeKey = `webauthn:challenge:${user.id}`;\r\n      await setCache(challengeKey, options.challenge, 300); // 5 minutes\r\n\r\n      return res.json(options);\r\n    } catch (error) {\r\n      logger.error('[WebAuthn] Failed to generate reg options:', error);\r\n      return res.status(500).json({ error: 'System error' });\r\n    }\r\n  }\r\n\r\n  @httpPost('/register-verify')\r\n  async verifyRegistration(@request() req: Request, @response() res: Response) {\r\n    try {\r\n      const { body } = req;\r\n      const user = await this.userRepository.findById(req.user?.id);\r\n      if (!user) return res.status(404).json({ error: 'User not found' });\r\n\r\n      const challengeKey = `webauthn:challenge:${user.id}`;\r\n      const expectedChallenge = await getCache(challengeKey);\r\n\r\n      if (!expectedChallenge) {\r\n        return res.status(400).json({ error: 'Challenge expired or not found' });\r\n      }\r\n\r\n      const verification = await verifyRegistrationResponse({\r\n        response: body,\r\n        expectedChallenge,\r\n        expectedOrigin: sovereignConfig.webauthn.origin,\r\n        expectedRPID: sovereignConfig.webauthn.rpID,\r\n      });\r\n\r\n      if (verification.verified && verification.registrationInfo) {\r\n        const { credentialPublicKey, credentialID, counter } = verification.registrationInfo;\r\n\r\n        const newAuthenticator = {\r\n          credentialID: Buffer.from(credentialID),\r\n          credentialPublicKey: Buffer.from(credentialPublicKey),\r\n          counter,\r\n          credentialDeviceType: verification.registrationInfo.credentialDeviceType,\r\n          credentialBackedUp: verification.registrationInfo.credentialBackedUp,\r\n        };\r\n\r\n        user!.authenticators.push(newAuthenticator);\r\n        await this.userRepository.update(user!.id, { authenticators: user!.authenticators });\r\n\r\n        return res.json({ verified: true });\r\n      }\r\n\r\n      return res.status(400).json({ verified: false });\r\n    } catch (error) {\r\n      logger.error('[WebAuthn] Verification failed:', error);\r\n      return res.status(500).json({ error: 'Verification failed' });\r\n    }\r\n  }\r\n\r\n  @httpGet('/login-options')\r\n  async getLoginOptions(@request() req: Request, @response() res: Response) {\r\n    try {\r\n      const user = await this.userRepository.findById(req.user?.id);\r\n\r\n      const options = await generateAuthenticationOptions({\r\n        rpID: sovereignConfig.webauthn.rpID,\r\n        allowCredentials: user?.authenticators.map(auth => ({\r\n          id: auth.credentialID,\r\n          type: 'public-key',\r\n          transports: auth.transports as any,\r\n        })),\r\n        userVerification: 'preferred',\r\n      });\r\n\r\n      if (user) {\r\n        const challengeKey = `webauthn:challenge:${user.id}`;\r\n        await setCache(challengeKey, options.challenge, 300);\r\n      }\r\n\r\n      return res.json(options);\r\n    } catch (error) {\r\n      logger.error('[WebAuthn] Failed to generate login options:', error);\r\n      return res.status(500).json({ error: 'System error' });\r\n    }\r\n  }\r\n\r\n  @httpPost('/login-verify')\r\n  async verifyLogin(@request() req: Request, @response() res: Response) {\r\n    try {\r\n      const { body, user: sessionUser } = req;\r\n      const user = await this.userRepository.findById(sessionUser?.id || body.userId);\r\n\r\n      if (!user || !user.authenticators || user.authenticators.length === 0) {\r\n        return res.status(404).json({ error: 'User or authenticators not found' });\r\n      }\r\n\r\n      const challengeKey = `webauthn:challenge:${user.id}`;\r\n      const expectedChallenge = await getCache(challengeKey);\r\n\r\n      if (!expectedChallenge) {\r\n        return res.status(400).json({ error: 'Challenge expired or not found' });\r\n      }\r\n\r\n      // Find the authenticator used\r\n      const authenticator = user.authenticators.find(\r\n        auth => Buffer.from(auth.credentialID).toString('base64url') === body.id,\r\n      );\r\n\r\n      if (!authenticator) {\r\n        return res.status(400).json({ error: 'Authenticator not found for this user' });\r\n      }\r\n\r\n      const verification = await verifyAuthenticationResponse({\r\n        response: body,\r\n        expectedChallenge,\r\n        expectedOrigin: sovereignConfig.webauthn.origin,\r\n        expectedRPID: sovereignConfig.webauthn.rpID,\r\n        authenticator: {\r\n          credentialID: authenticator.credentialID,\r\n          credentialPublicKey: authenticator.credentialPublicKey,\r\n          counter: authenticator.counter,\r\n          transports: authenticator.transports as any,\r\n        },\r\n      });\r\n\r\n      if (verification.verified) {\r\n        // Update counter\r\n        authenticator.counter = verification.authenticationInfo.newCounter;\r\n        await this.userRepository.update(user.id, { authenticators: user.authenticators });\r\n\r\n        // Logic for \"Sovereign\" session elevation\r\n        // In a real scenario, we might issue a special JWT or set a session flag\r\n        return res.json({\r\n          verified: true,\r\n          sovereignToken: 'SOVEREIGN_' + Buffer.from(crypto.randomUUID()).toString('base64'),\r\n        });\r\n      }\r\n\r\n      return res.status(400).json({ verified: false });\r\n    } catch (error) {\r\n      logger.error('[WebAuthn] Login verification failed:', error);\r\n      return res.status(500).json({ error: 'Login verification failed' });\r\n    }\r\n  }\r\n}\r\n"],"version":3}