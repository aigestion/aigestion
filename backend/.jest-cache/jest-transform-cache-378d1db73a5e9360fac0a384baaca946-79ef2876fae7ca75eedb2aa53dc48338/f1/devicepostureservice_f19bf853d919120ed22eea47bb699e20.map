{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\device-posture.service.ts","mappings":";;;;;;;;;;;;;;;;AAAA,yCAA+C;AAC/C,gFAA8E;AAC9E,oCAAiC;AACjC,yCAAsC;AACtC,4CAAyC;AAWlC,IAAM,oBAAoB,GAA1B,MAAM,oBAAoB;IACmB;IAAlD,YAAkD,cAA+B;QAA/B,mBAAc,GAAd,cAAc,CAAiB;IAAG,CAAC;IAErF;;OAEG;IACH,KAAK,CAAC,YAAY,CAChB,MAAc,EACd,WAA8B;QAM9B,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;QACxD,IAAI,CAAC,IAAI,EAAE,CAAC;YACV,OAAO,EAAE,SAAS,EAAE,KAAK,EAAE,WAAW,EAAE,KAAK,EAAE,MAAM,EAAE,gBAAgB,EAAE,CAAC;QAC5E,CAAC;QAED,MAAM,MAAM,GAAG,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,QAAQ,KAAK,WAAW,CAAC,QAAQ,CAAC,CAAC;QAElF,IAAI,CAAC,MAAM,EAAE,CAAC;YACZ,OAAO,EAAE,SAAS,EAAE,KAAK,EAAE,WAAW,EAAE,KAAK,EAAE,MAAM,EAAE,uBAAuB,EAAE,CAAC;QACnF,CAAC;QAED,sCAAsC;QACtC,IAAI,WAAW,GAAG,IAAI,CAAC;QACvB,MAAM,OAAO,GAAa,EAAE,CAAC;QAE7B,IAAI,WAAW,CAAC,SAAS,KAAK,KAAK,IAAI,IAAI,CAAC,IAAI,KAAK,KAAK,EAAE,CAAC;YAC3D,WAAW,GAAG,KAAK,CAAC;YACpB,OAAO,CAAC,IAAI,CAAC,2CAA2C,CAAC,CAAC;QAC5D,CAAC;QAED,oBAAoB;QACpB,4GAA4G;QAC5G,iDAAiD;QACjD,MAAM,WAAI,CAAC,iBAAiB,CAC1B,MAAM,EACN;YACE,IAAI,EAAE;gBACJ,yCAAyC,EAAE,IAAI,IAAI,EAAE;gBACrD,oCAAoC,EAAE,WAAW;aAClD;SACF,EACD;YACE,YAAY,EAAE,CAAC,EAAE,eAAe,EAAE,WAAW,CAAC,QAAQ,EAAE,CAAC;SAC1D,CACF,CAAC;QAEF,OAAO;YACL,SAAS,EAAE,IAAI;YACf,WAAW;YACX,MAAM,EAAE,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC;SAC3B,CAAC;IACJ,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,cAAc,CAClB,MAAc,EACd,UAIC;QAED,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;QACxD,IAAI,CAAC,IAAI;YAAE,MAAM,IAAI,KAAK,CAAC,gBAAgB,CAAC,CAAC;QAE7C,MAAM,MAAM,GAAG,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,QAAQ,KAAK,UAAU,CAAC,QAAQ,CAAC,CAAC;QACjF,IAAI,MAAM;YAAE,OAAO;QAEnB,MAAM,SAAS,GAAG;YAChB,QAAQ,EAAE,UAAU,CAAC,QAAQ;YAC7B,IAAI,EAAE,UAAU,CAAC,IAAI;YACrB,gBAAgB,EAAE,IAAI,IAAI,EAAE;YAC5B,WAAW,EAAE,IAAI;YACjB,UAAU,EAAE,UAAU,CAAC,UAAU;SAClC,CAAC;QAEF,MAAM,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,MAAM,EAAE;YACvC,KAAK,EAAE,EAAE,cAAc,EAAE,SAAS,EAAE;SAC9B,CAAC,CAAC;QAEV,eAAM,CAAC,IAAI,CAAC,kCAAkC,MAAM,KAAK,UAAU,CAAC,IAAI,EAAE,CAAC,CAAC;IAC9E,CAAC;CACF,CAAA;AAxFY,oDAAoB;+BAApB,oBAAoB;IADhC,IAAA,sBAAU,GAAE;IAEE,WAAA,IAAA,kBAAM,EAAC,aAAK,CAAC,cAAc,CAAC,CAAA;yDAAyB,gCAAe,oBAAf,gCAAe;GADtE,oBAAoB,CAwFhC","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\device-posture.service.ts"],"sourcesContent":["import { injectable, inject } from 'inversify';\nimport { IUserRepository } from '../infrastructure/repository/UserRepository';\nimport { TYPES } from '../types';\nimport { User } from '../models/User';\nimport { logger } from '../utils/logger';\n\nexport interface DevicePostureData {\n  deviceId: string;\n  os: string;\n  browser: string;\n  isManaged?: boolean;\n  hasSecuritySoftware?: boolean;\n}\n\n@injectable()\nexport class DevicePostureService {\n  constructor(@inject(TYPES.UserRepository) private userRepository: IUserRepository) {}\n\n  /**\n   * Verify if a device is trusted and compliant\n   */\n  async verifyDevice(\n    userId: string,\n    postureData: DevicePostureData,\n  ): Promise<{\n    isTrusted: boolean;\n    isCompliant: boolean;\n    reason?: string;\n  }> {\n    const user = await this.userRepository.findById(userId);\n    if (!user) {\n      return { isTrusted: false, isCompliant: false, reason: 'User not found' };\n    }\n\n    const device = user.trustedDevices.find(d => d.deviceId === postureData.deviceId);\n\n    if (!device) {\n      return { isTrusted: false, isCompliant: false, reason: 'Device not registered' };\n    }\n\n    // Basic compliance check (extendable)\n    let isCompliant = true;\n    const reasons: string[] = [];\n\n    if (postureData.isManaged === false && user.role === 'god') {\n      isCompliant = false;\n      reasons.push('Unmanaged device not allowed for GOD role');\n    }\n\n    // Update last check\n    // Since BaseRepository.update is simple, we might need a custom method in UserRepository for array filters,\n    // or use User model directly for now to unblock.\n    await User.findByIdAndUpdate(\n      userId,\n      {\n        $set: {\n          'trustedDevices.$[elem].lastPostureCheck': new Date(),\n          'trustedDevices.$[elem].isCompliant': isCompliant,\n        },\n      },\n      {\n        arrayFilters: [{ 'elem.deviceId': postureData.deviceId }],\n      },\n    );\n\n    return {\n      isTrusted: true,\n      isCompliant,\n      reason: reasons.join(', '),\n    };\n  }\n\n  /**\n   * Register a new trusted device for a user\n   */\n  async registerDevice(\n    userId: string,\n    deviceData: {\n      deviceId: string;\n      name: string;\n      deviceInfo: any;\n    },\n  ): Promise<void> {\n    const user = await this.userRepository.findById(userId);\n    if (!user) throw new Error('User not found');\n\n    const exists = user.trustedDevices.some(d => d.deviceId === deviceData.deviceId);\n    if (exists) return;\n\n    const newDevice = {\n      deviceId: deviceData.deviceId,\n      name: deviceData.name,\n      lastPostureCheck: new Date(),\n      isCompliant: true,\n      deviceInfo: deviceData.deviceInfo,\n    };\n\n    await this.userRepository.update(userId, {\n      $push: { trustedDevices: newDevice },\n    } as any);\n\n    logger.info(`New device registered for user ${userId}: ${deviceData.name}`);\n  }\n}\n"],"version":3}