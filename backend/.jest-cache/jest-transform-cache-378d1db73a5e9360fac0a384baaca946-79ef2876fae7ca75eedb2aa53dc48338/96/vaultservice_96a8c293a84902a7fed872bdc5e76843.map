{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\vault.service.ts","mappings":";;;;;;;;;;;;AAAA,yCAAuC;AACvC,8DAAiC;AACjC,4CAAyC;AAGlC,IAAM,YAAY,GAAlB,MAAM,YAAY;IACN,SAAS,GAAG,aAAa,CAAC;IAE3C;;OAEG;IACH,KAAK,CAAC,OAAO,CACX,IAAY,EACZ,MAAc;QAEd,IAAI,CAAC;YACH,kFAAkF;YAClF,MAAM,GAAG,GAAG,qBAAM,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,MAAM,EAAE,CAAC;YAChE,MAAM,EAAE,GAAG,qBAAM,CAAC,WAAW,CAAC,EAAE,CAAC,CAAC;YAClC,MAAM,MAAM,GAAG,qBAAM,CAAC,cAAc,CAAC,IAAI,CAAC,SAAS,EAAE,GAAG,EAAE,EAAE,CAAC,CAAC;YAE9D,IAAI,UAAU,GAAG,MAAM,CAAC,MAAM,CAAC,IAAI,EAAE,MAAM,EAAE,KAAK,CAAC,CAAC;YACpD,UAAU,IAAI,MAAM,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;YAClC,MAAM,GAAG,GAAG,MAAM,CAAC,UAAU,EAAE,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;YAEhD,OAAO;gBACL,EAAE,EAAE,EAAE,CAAC,QAAQ,CAAC,KAAK,CAAC;gBACtB,UAAU;gBACV,GAAG;aACJ,CAAC;QACJ,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,mCAAmC,EAAE,KAAK,CAAC,CAAC;YACzD,MAAM,IAAI,KAAK,CAAC,mBAAmB,CAAC,CAAC;QACvC,CAAC;IACH,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,OAAO,CACX,KAAa,EACb,UAAkB,EAClB,MAAc,EACd,MAAc;QAEd,IAAI,CAAC;YACH,MAAM,GAAG,GAAG,qBAAM,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,MAAM,EAAE,CAAC;YAChE,MAAM,EAAE,GAAG,MAAM,CAAC,IAAI,CAAC,KAAK,EAAE,KAAK,CAAC,CAAC;YACrC,MAAM,GAAG,GAAG,MAAM,CAAC,IAAI,CAAC,MAAM,EAAE,KAAK,CAAC,CAAC;YACvC,MAAM,QAAQ,GAAG,qBAAM,CAAC,gBAAgB,CAAC,IAAI,CAAC,SAAS,EAAE,GAAG,EAAE,EAAE,CAAC,CAAC;YAElE,QAAQ,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC;YAEzB,IAAI,SAAS,GAAG,QAAQ,CAAC,MAAM,CAAC,UAAU,EAAE,KAAK,EAAE,MAAM,CAAC,CAAC;YAC3D,SAAS,IAAI,QAAQ,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;YAEpC,OAAO,SAAS,CAAC;QACnB,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,mCAAmC,EAAE,KAAK,CAAC,CAAC;YACzD,MAAM,IAAI,KAAK,CAAC,2BAA2B,CAAC,CAAC;QAC/C,CAAC;IACH,CAAC;IAED;;;OAGG;IACH,KAAK,CAAC,uBAAuB,CAC3B,KAAa,EACb,UAAkB,EAClB,MAAc,EACd,qBAA6B;QAE7B,MAAM,EAAE,QAAQ,EAAE,GAAG,OAAO,CAAC,gBAAgB,CAAC,CAAC;QAC/C,MAAM,MAAM,GAAG,MAAM,QAAQ,CAAC,qBAAqB,qBAAqB,EAAE,CAAC,CAAC;QAE5E,IAAI,CAAC,MAAM,EAAE,CAAC;YACZ,MAAM,IAAI,KAAK,CAAC,2BAA2B,CAAC,CAAC;QAC/C,CAAC;QAED,OAAO,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,UAAU,EAAE,MAAM,EAAE,MAAM,CAAC,CAAC;IACzD,CAAC;CACF,CAAA;AA7EY,oCAAY;uBAAZ,YAAY;IADxB,IAAA,sBAAU,GAAE;GACA,YAAY,CA6ExB","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\vault.service.ts"],"sourcesContent":["import { injectable } from 'inversify';\r\nimport crypto from 'node:crypto';\r\nimport { logger } from '../utils/logger';\r\n\r\n@injectable()\r\nexport class VaultService {\r\n  private readonly algorithm = 'aes-256-gcm';\r\n\r\n  /**\r\n   * Encrypts sensitive findings using AES-256-GCM.\r\n   */\r\n  async encrypt(\r\n    data: string,\r\n    secret: string,\r\n  ): Promise<{ iv: string; ciphertext: string; tag: string }> {\r\n    try {\r\n      // Derive a 32-byte key from the secret (e.g., user hardware key or system secret)\r\n      const key = crypto.createHash('sha256').update(secret).digest();\r\n      const iv = crypto.randomBytes(12);\r\n      const cipher = crypto.createCipheriv(this.algorithm, key, iv);\r\n\r\n      let ciphertext = cipher.update(data, 'utf8', 'hex');\r\n      ciphertext += cipher.final('hex');\r\n      const tag = cipher.getAuthTag().toString('hex');\r\n\r\n      return {\r\n        iv: iv.toString('hex'),\r\n        ciphertext,\r\n        tag,\r\n      };\r\n    } catch (error) {\r\n      logger.error('[VaultService] Encryption failed:', error);\r\n      throw new Error('FAILED_ENCRYPTION');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Decrypts vault data.\r\n   */\r\n  async decrypt(\r\n    ivHex: string,\r\n    ciphertext: string,\r\n    tagHex: string,\r\n    secret: string,\r\n  ): Promise<string> {\r\n    try {\r\n      const key = crypto.createHash('sha256').update(secret).digest();\r\n      const iv = Buffer.from(ivHex, 'hex');\r\n      const tag = Buffer.from(tagHex, 'hex');\r\n      const decipher = crypto.createDecipheriv(this.algorithm, key, iv);\r\n\r\n      decipher.setAuthTag(tag);\r\n\r\n      let decrypted = decipher.update(ciphertext, 'hex', 'utf8');\r\n      decrypted += decipher.final('utf8');\r\n\r\n      return decrypted;\r\n    } catch (error) {\r\n      logger.error('[VaultService] Decryption failed:', error);\r\n      throw new Error('INVALID_DECRYPTION_SECRET');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * ðŸŒŒ Sovereign Decryption\r\n   * Uses a session-bound symmetric key derived from the PQC handshake.\r\n   */\r\n  async decryptWithSovereignKey(\r\n    ivHex: string,\r\n    ciphertext: string,\r\n    tagHex: string,\r\n    sovereignSessionToken: string,\r\n  ): Promise<string> {\r\n    const { getCache } = require('../cache/redis');\r\n    const secret = await getCache(`sovereign:session:${sovereignSessionToken}`);\r\n\r\n    if (!secret) {\r\n      throw new Error('SOVEREIGN_SESSION_EXPIRED');\r\n    }\r\n\r\n    return this.decrypt(ivHex, ciphertext, tagHex, secret);\r\n  }\r\n}\r\n"],"version":3}