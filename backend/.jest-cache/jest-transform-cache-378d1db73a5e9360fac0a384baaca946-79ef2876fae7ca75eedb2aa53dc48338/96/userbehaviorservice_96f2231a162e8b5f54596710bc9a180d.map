{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\user-behavior.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\user-behavior.service.ts"],"sourcesContent":["import { injectable } from 'inversify';\nimport type { RedisClientType } from 'redis';\nimport { getRedisClient } from '../cache/redis';\nimport { logger } from '../utils/logger';\n\ninterface UserBehaviorEvent {\n  userId: string;\n  eventType:\n    | 'login'\n    | 'logout'\n    | 'file_upload'\n    | 'api_call'\n    | 'page_view'\n    | 'error'\n    | 'permission_denied'\n    | 'data_access'\n    | 'malware_detected';\n  timestamp: Date;\n  ipAddress: string;\n  userAgent: string;\n  sessionId: string;\n  metadata: {\n    [key: string]: any;\n  };\n}\n\ninterface UserBehaviorProfile {\n  userId: string;\n  baseline: {\n    typicalIPs: string[];\n    typicalUserAgents: string[];\n    typicalHours: number[];\n    typicalDays: number[];\n    apiCallFrequency: number;\n    errorRate: number;\n    sessionDuration: number;\n    dataAccessPatterns: string[];\n  };\n  currentSession: {\n    startTime: Date;\n    ipAddress: string;\n    userAgent: string;\n    apiCalls: number;\n    errors: number;\n    dataAccess: string[];\n    unusualEvents: string[];\n  };\n  riskScore: number;\n  lastUpdated: Date;\n}\n\ninterface BehaviorAnomaly {\n  id: string;\n  userId: string;\n  type:\n    | 'new_ip'\n    | 'new_user_agent'\n    | 'unusual_time'\n    | 'high_error_rate'\n    | 'excessive_api_calls'\n    | 'unusual_data_access'\n    | 'session_anomaly';\n  severity: 'low' | 'medium' | 'high' | 'critical';\n  description: string;\n  detectedAt: Date;\n  metadata: {\n    [key: string]: any;\n  };\n  resolved: boolean;\n}\n\n@injectable()\nexport class UserBehaviorService {\n  private readonly redis: RedisClientType;\n  private readonly profileCache = new Map<string, UserBehaviorProfile>();\n  private readonly cacheTimeout = 30 * 60; // 30 minutes\n  private readonly baselinePeriod = 30 * 24 * 60 * 60 * 1000; // 30 days\n  private readonly anomalies: BehaviorAnomaly[] = [];\n  private readonly maxAnomalies = 10000;\n\n  constructor() {\n    this.redis = getRedisClient();\n  }\n\n  /**\n   * Track user behavior event\n   */\n  public async trackEvent(event: UserBehaviorEvent): Promise<void> {\n    try {\n      // Store event in Redis\n      const eventKey = `behavior:event:${event.userId}:${Date.now()}`;\n      await this.redis.setEx(eventKey, 7 * 24 * 60 * 60, JSON.stringify(event)); // 7 days\n\n      // Update user profile\n      await this.updateUserProfile(event);\n\n      // Check for anomalies\n      await this.detectAnomalies(event);\n\n      logger.debug('User behavior event tracked', {\n        userId: event.userId,\n        eventType: event.eventType,\n        timestamp: event.timestamp,\n      });\n    } catch (error) {\n      logger.error('Error tracking user behavior event:', error);\n    }\n  }\n\n  /**\n   * Update user behavior profile\n   */\n  private async updateUserProfile(event: UserBehaviorEvent): Promise<void> {\n    try {\n      let profile = await this.getUserProfile(event.userId);\n\n      if (!profile) {\n        profile = this.createInitialProfile(event.userId);\n      }\n\n      // Update current session\n      this.updateCurrentSession(profile, event);\n\n      // Update baseline with new data\n      this.updateBaseline(profile, event);\n\n      // Calculate risk score\n      profile.riskScore = this.calculateRiskScore(profile);\n      profile.lastUpdated = new Date();\n\n      // Cache profile\n      this.profileCache.set(event.userId, profile);\n      await this.redis.setEx(\n        `behavior:profile:${event.userId}`,\n        this.cacheTimeout,\n        JSON.stringify(profile),\n      );\n\n      logger.debug('User behavior profile updated', {\n        userId: event.userId,\n        riskScore: profile.riskScore,\n      });\n    } catch (error) {\n      logger.error('Error updating user profile:', error);\n    }\n  }\n\n  /**\n   * Specifically track malware detection events\n   */\n  public async trackThreat(\n    userId: string,\n    filename: string,\n    threats: string[],\n    ipAddress: string,\n  ): Promise<void> {\n    const event: UserBehaviorEvent = {\n      userId,\n      eventType: 'malware_detected',\n      timestamp: new Date(),\n      ipAddress,\n      userAgent: 'system-scanner',\n      sessionId: 'security-alert',\n      metadata: {\n        filename,\n        threats,\n        priority: 'critical',\n      },\n    };\n    await this.trackEvent(event);\n  }\n\n  /**\n   * Get user behavior profile\n   */\n  public async getUserProfile(userId: string): Promise<UserBehaviorProfile | null> {\n    try {\n      // Check cache first\n      if (this.profileCache.has(userId)) {\n        return this.profileCache.get(userId)!;\n      }\n\n      // Get from Redis\n      const cached = await this.redis.get(`behavior:profile:${userId}`);\n      if (cached) {\n        const profile = JSON.parse(cached);\n        this.profileCache.set(userId, profile);\n        return profile;\n      }\n\n      return null;\n    } catch (error) {\n      logger.error('Error getting user profile:', { userId, error });\n      return null;\n    }\n  }\n\n  /**\n   * Create initial user profile\n   */\n  private createInitialProfile(userId: string): UserBehaviorProfile {\n    return {\n      userId,\n      baseline: {\n        typicalIPs: [],\n        typicalUserAgents: [],\n        typicalHours: [],\n        typicalDays: [],\n        apiCallFrequency: 0,\n        errorRate: 0,\n        sessionDuration: 0,\n        dataAccessPatterns: [],\n      },\n      currentSession: {\n        startTime: new Date(),\n        ipAddress: '',\n        userAgent: '',\n        apiCalls: 0,\n        errors: 0,\n        dataAccess: [],\n        unusualEvents: [],\n      },\n      riskScore: 0,\n      lastUpdated: new Date(),\n    };\n  }\n\n  /**\n   * Update current session data\n   */\n  private updateCurrentSession(profile: UserBehaviorProfile, event: UserBehaviorEvent): void {\n    const session = profile.currentSession;\n\n    // Update session basics\n    if (event.eventType === 'login') {\n      session.startTime = event.timestamp;\n      session.ipAddress = event.ipAddress;\n      session.userAgent = event.userAgent;\n      session.apiCalls = 0;\n      session.errors = 0;\n      session.dataAccess = [];\n      session.unusualEvents = [];\n    }\n\n    // Update session counters\n    switch (event.eventType) {\n      case 'api_call':\n        session.apiCalls++;\n        break;\n      case 'error':\n      case 'permission_denied':\n        session.errors++;\n        break;\n      case 'data_access':\n        if (event.metadata.resource) {\n          session.dataAccess.push(event.metadata.resource);\n        }\n        break;\n    }\n\n    // Add unusual events\n    if (event.metadata.unusual) {\n      session.unusualEvents.push(event.eventType);\n    }\n  }\n\n  /**\n   * Update baseline with new data\n   */\n  private updateBaseline(profile: UserBehaviorProfile, event: UserBehaviorEvent): void {\n    const baseline = profile.baseline;\n\n    // Update typical IPs\n    if (!baseline.typicalIPs.includes(event.ipAddress)) {\n      baseline.typicalIPs.push(event.ipAddress);\n      // Keep only last 20 IPs\n      if (baseline.typicalIPs.length > 20) {\n        baseline.typicalIPs = baseline.typicalIPs.slice(-20);\n      }\n    }\n\n    // Update typical user agents\n    if (!baseline.typicalUserAgents.includes(event.userAgent)) {\n      baseline.typicalUserAgents.push(event.userAgent);\n      // Keep only last 10 user agents\n      if (baseline.typicalUserAgents.length > 10) {\n        baseline.typicalUserAgents = baseline.typicalUserAgents.slice(-10);\n      }\n    }\n\n    // Update typical hours\n    const hour = event.timestamp.getHours();\n    if (!baseline.typicalHours.includes(hour)) {\n      baseline.typicalHours.push(hour);\n      baseline.typicalHours.sort((a, b) => a - b);\n    }\n\n    // Update typical days\n    const day = event.timestamp.getDay();\n    if (!baseline.typicalDays.includes(day)) {\n      baseline.typicalDays.push(day);\n      baseline.typicalDays.sort((a, b) => a - b);\n    }\n\n    // Update data access patterns\n    if (event.eventType === 'data_access' && event.metadata.resource) {\n      if (!baseline.dataAccessPatterns.includes(event.metadata.resource)) {\n        baseline.dataAccessPatterns.push(event.metadata.resource);\n        // Keep only last 50 patterns\n        if (baseline.dataAccessPatterns.length > 50) {\n          baseline.dataAccessPatterns = baseline.dataAccessPatterns.slice(-50);\n        }\n      }\n    }\n  }\n\n  /**\n   * Detect anomalies in user behavior\n   */\n  private async detectAnomalies(event: UserBehaviorEvent): Promise<void> {\n    try {\n      const profile = await this.getUserProfile(event.userId);\n      if (!profile || profile.baseline.typicalIPs.length < 3) {\n        // Not enough baseline data\n        return;\n      }\n\n      const anomalies: BehaviorAnomaly[] = [];\n\n      // Check for new IP\n      if (!profile.baseline.typicalIPs.includes(event.ipAddress)) {\n        anomalies.push({\n          id: this.generateAnomalyId(),\n          userId: event.userId,\n          type: 'new_ip',\n          severity: 'medium',\n          description: `Login from new IP address: ${event.ipAddress}`,\n          detectedAt: new Date(),\n          metadata: {\n            newIP: event.ipAddress,\n            typicalIPs: profile.baseline.typicalIPs.slice(0, 5),\n          },\n          resolved: false,\n        });\n      }\n\n      // Check for new user agent\n      if (!profile.baseline.typicalUserAgents.includes(event.userAgent)) {\n        anomalies.push({\n          id: this.generateAnomalyId(),\n          userId: event.userId,\n          type: 'new_user_agent',\n          severity: 'low',\n          description: 'Login from new user agent',\n          detectedAt: new Date(),\n          metadata: {\n            newUserAgent: event.userAgent,\n            typicalUserAgents: profile.baseline.typicalUserAgents.slice(0, 3),\n          },\n          resolved: false,\n        });\n      }\n\n      // Check for unusual time\n      const hour = event.timestamp.getHours();\n      if (!profile.baseline.typicalHours.includes(hour) && event.eventType === 'login') {\n        anomalies.push({\n          id: this.generateAnomalyId(),\n          userId: event.userId,\n          type: 'unusual_time',\n          severity: 'low',\n          description: `Login at unusual hour: ${hour}:00`,\n          detectedAt: new Date(),\n          metadata: {\n            hour,\n            typicalHours: profile.baseline.typicalHours,\n          },\n          resolved: false,\n        });\n      }\n\n      // Check for high error rate\n      if (profile.currentSession.errors > 5 && profile.currentSession.apiCalls > 0) {\n        const errorRate = profile.currentSession.errors / profile.currentSession.apiCalls;\n        if (errorRate > 0.2) {\n          // More than 20% errors\n          anomalies.push({\n            id: this.generateAnomalyId(),\n            userId: event.userId,\n            type: 'high_error_rate',\n            severity: 'high',\n            description: `High error rate: ${Math.round(errorRate * 100)}%`,\n            detectedAt: new Date(),\n            metadata: {\n              errorRate,\n              errors: profile.currentSession.errors,\n              apiCalls: profile.currentSession.apiCalls,\n            },\n            resolved: false,\n          });\n        }\n      }\n\n      // Check for excessive API calls\n      if (profile.currentSession.apiCalls > 1000) {\n        anomalies.push({\n          id: this.generateAnomalyId(),\n          userId: event.userId,\n          type: 'excessive_api_calls',\n          severity: 'medium',\n          description: `Excessive API calls: ${profile.currentSession.apiCalls}`,\n          detectedAt: new Date(),\n          metadata: {\n            apiCalls: profile.currentSession.apiCalls,\n            sessionDuration: Date.now() - profile.currentSession.startTime.getTime(),\n          },\n          resolved: false,\n        });\n      }\n\n      // Check for unusual data access\n      if (event.eventType === 'data_access' && event.metadata.resource) {\n        if (!profile.baseline.dataAccessPatterns.includes(event.metadata.resource)) {\n          anomalies.push({\n            id: this.generateAnomalyId(),\n            userId: event.userId,\n            type: 'unusual_data_access',\n            severity: 'medium',\n            description: `Access to unusual resource: ${event.metadata.resource}`,\n            detectedAt: new Date(),\n            metadata: {\n              resource: event.metadata.resource,\n              typicalPatterns: profile.baseline.dataAccessPatterns.slice(0, 5),\n            },\n            resolved: false,\n          });\n        }\n      }\n\n      // Store anomalies\n      for (const anomaly of anomalies) {\n        await this.storeAnomaly(anomaly);\n      }\n    } catch (error) {\n      logger.error('Error detecting anomalies:', error);\n    }\n  }\n\n  /**\n   * Store anomaly\n   */\n  private async storeAnomaly(anomaly: BehaviorAnomaly): Promise<void> {\n    try {\n      // Add to memory\n      this.anomalies.push(anomaly);\n\n      // Keep only recent anomalies\n      if (this.anomalies.length > this.maxAnomalies) {\n        this.anomalies.splice(0, this.anomalies.length - this.maxAnomalies);\n      }\n\n      // Store in Redis\n      await this.redis.setEx(\n        `behavior:anomaly:${anomaly.id}`,\n        7 * 24 * 60 * 60, // 7 days\n        JSON.stringify(anomaly),\n      );\n\n      // Add to user anomalies list\n      await this.redis.lPush(`behavior:anomalies:${anomaly.userId}`, JSON.stringify(anomaly));\n      await this.redis.lTrim(`behavior:anomalies:${anomaly.userId}`, 0, 99); // Keep last 100\n\n      // Log anomaly\n      logger.warn('User behavior anomaly detected', {\n        userId: anomaly.userId,\n        type: anomaly.type,\n        severity: anomaly.severity,\n        description: anomaly.description,\n      });\n    } catch (error) {\n      logger.error('Error storing anomaly:', error);\n    }\n  }\n\n  /**\n   * Calculate risk score\n   */\n  private calculateRiskScore(profile: UserBehaviorProfile): number {\n    let score = 0;\n\n    // Base score\n    score += 10;\n\n    // Current session factors\n    const session = profile.currentSession;\n\n    // Error rate impact\n    if (session.apiCalls > 0) {\n      const errorRate = session.errors / session.apiCalls;\n      score += errorRate * 30;\n    }\n\n    // Unusual events impact\n    score += session.unusualEvents.length * 5;\n\n    // API call frequency impact\n    if (session.apiCalls > 500) {\n      score += Math.min(session.apiCalls / 100, 20);\n    }\n\n    // Recent anomalies impact\n    // Malware detections add 50 points immediately\n    if (session.unusualEvents.includes('malware_detected')) {\n      score += 50;\n    }\n\n    return Math.min(Math.round(score), 100);\n  }\n\n  /**\n   * Get user anomalies\n   */\n  public async getUserAnomalies(userId: string, limit: number = 50): Promise<BehaviorAnomaly[]> {\n    try {\n      const anomalyData = await this.redis.lRange(`behavior:anomalies:${userId}`, 0, limit - 1);\n      return anomalyData.map(data => JSON.parse(data));\n    } catch (error) {\n      logger.error('Error getting user anomalies:', { userId, error });\n      return [];\n    }\n  }\n\n  /**\n   * Get recent anomalies\n   */\n  public async getRecentAnomalies(limit: number = 100): Promise<BehaviorAnomaly[]> {\n    try {\n      return this.anomalies\n        .sort((a, b) => b.detectedAt.getTime() - a.detectedAt.getTime())\n        .slice(0, limit);\n    } catch (error) {\n      logger.error('Error getting recent anomalies:', error);\n      return [];\n    }\n  }\n\n  /**\n   * Resolve anomaly\n   */\n  public async resolveAnomaly(anomalyId: string): Promise<boolean> {\n    try {\n      // Update in memory\n      const anomaly = this.anomalies.find(a => a.id === anomalyId);\n      if (anomaly) {\n        anomaly.resolved = true;\n      }\n\n      // Update in Redis\n      const cached = await this.redis.get(`behavior:anomaly:${anomalyId}`);\n      if (cached) {\n        const updatedAnomaly = JSON.parse(cached);\n        updatedAnomaly.resolved = true;\n        await this.redis.setEx(\n          `behavior:anomaly:${anomalyId}`,\n          7 * 24 * 60 * 60,\n          JSON.stringify(updatedAnomaly),\n        );\n      }\n\n      logger.info('Anomaly resolved', { anomalyId });\n      return true;\n    } catch (error) {\n      logger.error('Error resolving anomaly:', { anomalyId, error });\n      return false;\n    }\n  }\n\n  /**\n   * Get behavior statistics\n   */\n  public async getStats(): Promise<{\n    totalProfiles: number;\n    totalAnomalies: number;\n    anomaliesByType: { [key: string]: number };\n    anomaliesBySeverity: { [key: string]: number };\n    averageRiskScore: number;\n    highRiskUsers: number;\n  }> {\n    try {\n      const totalProfiles = this.profileCache.size;\n      const totalAnomalies = this.anomalies.length;\n\n      const anomaliesByType: { [key: string]: number } = {};\n      const anomaliesBySeverity: { [key: string]: number } = {};\n\n      this.anomalies.forEach(anomaly => {\n        anomaliesByType[anomaly.type] = (anomaliesByType[anomaly.type] || 0) + 1;\n        anomaliesBySeverity[anomaly.severity] = (anomaliesBySeverity[anomaly.severity] || 0) + 1;\n      });\n\n      const riskScores = Array.from(this.profileCache.values()).map(p => p.riskScore);\n      const averageRiskScore =\n        riskScores.length > 0\n          ? riskScores.reduce((sum, score) => sum + score, 0) / riskScores.length\n          : 0;\n\n      const highRiskUsers = riskScores.filter(score => score > 70).length;\n\n      return {\n        totalProfiles,\n        totalAnomalies,\n        anomaliesByType,\n        anomaliesBySeverity,\n        averageRiskScore: Math.round(averageRiskScore),\n        highRiskUsers,\n      };\n    } catch (error) {\n      logger.error('Error getting behavior stats:', error);\n      return {\n        totalProfiles: 0,\n        totalAnomalies: 0,\n        anomaliesByType: {},\n        anomaliesBySeverity: {},\n        averageRiskScore: 0,\n        highRiskUsers: 0,\n      };\n    }\n  }\n\n  /**\n   * Generate anomaly ID\n   */\n  private generateAnomalyId(): string {\n    return `anomaly_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n  }\n\n  /**\n   * Cleanup old data\n   */\n  public async cleanup(): Promise<void> {\n    try {\n      // Clean old profiles from cache\n      const now = Date.now();\n      for (const [userId, profile] of this.profileCache.entries()) {\n        if (now - profile.lastUpdated.getTime() > this.cacheTimeout * 1000) {\n          this.profileCache.delete(userId);\n        }\n      }\n\n      // Clean old anomalies from memory\n      const cutoff = new Date(now - 7 * 24 * 60 * 60 * 1000); // 7 days ago\n      this.anomalies.filter(anomaly => anomaly.detectedAt > cutoff);\n\n      logger.info('User behavior cleanup completed');\n    } catch (error) {\n      logger.error('Error during cleanup:', error);\n    }\n  }\n}\n"],"version":3}