259d1e8f2ebf79a96b63187ee7b914a8
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.User = void 0;
const mongoose_1 = __importStar(require("mongoose"));
const userSchema = new mongoose_1.Schema({
    name: {
        type: String,
        required: [true, 'El nombre es obligatorio'],
        trim: true,
        maxlength: [50, 'El nombre no puede tener más de 50 caracteres'],
    },
    email: {
        type: String,
        required: [true, 'El correo electrónico es obligatorio'],
        unique: true,
        lowercase: true,
        trim: true,
        match: [/^\S+@\S+\.\S+$/, 'Por favor ingrese un correo electrónico válido'],
    },
    password: {
        type: String,
        required: false,
        minlength: [8, 'La contraseña debe tener al menos 8 caracteres'],
        select: false, // No devolver la contraseña por defecto
    },
    role: {
        type: String,
        enum: ['user', 'admin', 'dev', 'sales', 'god', 'family', 'professional'],
        default: 'user',
    },
    emailVerificationCode: { type: String, select: false },
    emailVerificationExpires: { type: Date, select: false },
    isEmailVerified: {
        type: Boolean,
        default: false,
    },
    refreshTokens: [
        {
            token: { type: String, required: true },
            expires: { type: Date, required: true },
            familyId: { type: String, required: true },
            ip: { type: String, required: true },
            userAgent: { type: String, required: true },
            createdAt: { type: Date, default: Date.now },
        },
    ],
    tokenVersion: {
        type: Number,
        default: 0,
    },
    lastPasswordChange: {
        type: Date,
        default: Date.now,
    },
    lastLogin: {
        type: Date,
    },
    twoFactorSecret: { type: String, select: false },
    isMfaEnabled: {
        type: Boolean,
        default: false,
    },
    loginAttempts: {
        type: Number,
        required: true,
        default: 0,
    },
    lockUntil: {
        type: Date,
    },
    // Stripe Fields
    stripeCustomerId: { type: String, select: false },
    subscriptionId: { type: String, select: false },
    stripeSubscriptionItemId: { type: String, select: false },
    subscriptionStatus: {
        type: String,
        enum: ['active', 'past_due', 'canceled', 'incomplete', 'trialing'],
    },
    subscriptionPlan: { type: String },
    // Zero Trust Security
    trustedDevices: [
        {
            deviceId: { type: String, required: true },
            name: { type: String, required: true },
            lastPostureCheck: { type: Date, default: Date.now },
            isCompliant: { type: Boolean, default: true },
            deviceInfo: { type: mongoose_1.Schema.Types.Mixed },
        },
    ],
    lastSecurityAudit: { type: Date },
    // IoT / Home Assistant (encrypted/hidden by default)
    haBaseUrl: { type: String },
    haAccessToken: { type: String, select: false },
    // WebAuthn / Sovereign Hardware Keys
    authenticators: [
        {
            credentialID: { type: Buffer, required: true },
            credentialPublicKey: { type: Buffer, required: true },
            counter: { type: Number, required: true },
            credentialDeviceType: { type: String, required: true },
            credentialBackedUp: { type: Boolean, required: true },
            transports: [{ type: String }],
        },
    ],
}, {
    timestamps: true,
    toJSON: {
        virtuals: true,
        transform: function (_doc, ret) {
            delete ret.password; // No incluir la contraseña en las respuestas JSON
            return ret;
        },
    },
});
// Método para comparar contraseñas
userSchema.methods.comparePassword = async function (candidatePassword) {
    const bcrypt = require('bcryptjs');
    return await bcrypt.compare(candidatePassword, this.password);
};
// Middleware para hashear la contraseña antes de guardar
userSchema.pre('save', async function (next) {
    // Solo hashear la contraseña si ha sido modificada (o es nueva)
    if (!this.isModified('password')) {
        return next();
    }
    try {
        const salt = await require('bcryptjs').genSalt(12);
        this.password = await require('bcryptjs').hash(this.password, salt);
        next();
    }
    catch (error) {
        next(error);
    }
});
const User = mongoose_1.default.model('User', userSchema);
exports.User = User;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxtb2RlbHNcXFVzZXIudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEscURBQXNEO0FBb0V0RCxNQUFNLFVBQVUsR0FBRyxJQUFJLGlCQUFNLENBQzNCO0lBQ0UsSUFBSSxFQUFFO1FBQ0osSUFBSSxFQUFFLE1BQU07UUFDWixRQUFRLEVBQUUsQ0FBQyxJQUFJLEVBQUUsMEJBQTBCLENBQUM7UUFDNUMsSUFBSSxFQUFFLElBQUk7UUFDVixTQUFTLEVBQUUsQ0FBQyxFQUFFLEVBQUUsK0NBQStDLENBQUM7S0FDakU7SUFDRCxLQUFLLEVBQUU7UUFDTCxJQUFJLEVBQUUsTUFBTTtRQUNaLFFBQVEsRUFBRSxDQUFDLElBQUksRUFBRSxzQ0FBc0MsQ0FBQztRQUN4RCxNQUFNLEVBQUUsSUFBSTtRQUNaLFNBQVMsRUFBRSxJQUFJO1FBQ2YsSUFBSSxFQUFFLElBQUk7UUFDVixLQUFLLEVBQUUsQ0FBQyxnQkFBZ0IsRUFBRSxnREFBZ0QsQ0FBQztLQUM1RTtJQUNELFFBQVEsRUFBRTtRQUNSLElBQUksRUFBRSxNQUFNO1FBQ1osUUFBUSxFQUFFLEtBQUs7UUFDZixTQUFTLEVBQUUsQ0FBQyxDQUFDLEVBQUUsZ0RBQWdELENBQUM7UUFDaEUsTUFBTSxFQUFFLEtBQUssRUFBRSx3Q0FBd0M7S0FDeEQ7SUFDRCxJQUFJLEVBQUU7UUFDSixJQUFJLEVBQUUsTUFBTTtRQUNaLElBQUksRUFBRSxDQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLGNBQWMsQ0FBQztRQUN4RSxPQUFPLEVBQUUsTUFBTTtLQUNoQjtJQUNELHFCQUFxQixFQUFFLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFO0lBQ3RELHdCQUF3QixFQUFFLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxN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QUFFLENBQUM7UUFDakMsT0FBTyxJQUFJLEVBQUUsQ0FBQztJQUNoQixDQUFDO0lBRUQsSUFBSSxDQUFDO1FBQ0gsTUFBTSxJQUFJLEdBQUcsTUFBTSxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ25ELElBQUksQ0FBQyxRQUFRLEdBQUcsTUFBTSxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDcEUsSUFBSSxFQUFFLENBQUM7SUFDVCxDQUFDO0lBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztRQUNwQixJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDZCxDQUFDO0FBQ0gsQ0FBQyxDQUFDLENBQUM7QUFFSCxNQUFNLElBQUksR0FBRyxrQkFBUSxDQUFDLEtBQUssQ0FBUSxNQUFNLEVBQUUsVUFBVSxDQUFDLENBQUM7QUFFOUMsb0JBQUkiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxtb2RlbHNcXFVzZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IG1vbmdvb3NlLCB7IERvY3VtZW50LCBTY2hlbWEgfSBmcm9tICdtb25nb29zZSc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVVzZXIgZXh0ZW5kcyBEb2N1bWVudCB7XG4gIGlkOiBzdHJpbmc7XG4gIG5hbWU6IHN0cmluZztcbiAgZW1haWw6IHN0cmluZztcbiAgdHdvRmFjdG9yU2VjcmV0Pzogc3RyaW5nO1xuICBwYXNzd29yZDogc3RyaW5nO1xuXG4gIGxhc3RMb2dpbj86IERhdGU7XG4gIGlzTWZhRW5hYmxlZDogYm9vbGVhbjtcbiAgaXNUd29GYWN0b3JFbmFibGVkPzogYm9vbGVhbjsgLy8gQWxpYXMgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHlcbiAgbG9naW5BdHRlbXB0czogbnVtYmVyO1xuICBsb2NrVW50aWw/OiBEYXRlO1xuICB0b2tlblZlcnNpb246IG51bWJlcjtcbiAgbGFzdFBhc3N3b3JkQ2hhbmdlOiBEYXRlO1xuICBjcmVhdGVkQXQ6IERhdGU7XG4gIHVwZGF0ZWRBdDogRGF0ZTtcbiAgY29tcGFyZVBhc3N3b3JkKGNhbmRpZGF0ZVBhc3N3b3JkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+O1xuXG4gIC8vIEVtYWlsIFZlcmlmaWNhdGlvblxuICBlbWFpbFZlcmlmaWNhdGlvbkNvZGU/OiBzdHJpbmc7XG4gIGVtYWlsVmVyaWZpY2F0aW9uRXhwaXJlcz86IERhdGU7XG4gIGlzRW1haWxWZXJpZmllZDogYm9vbGVhbjtcblxuICAvLyBSb2xlc1xuICByb2xlOiAndXNlcicgfCAnYWRtaW4nIHwgJ2RldicgfCAnc2FsZXMnIHwgJ2dvZCcgfCAnZmFtaWx5JyB8ICdwcm9mZXNzaW9uYWwnO1xuICBzdHJpcGVDdXN0b21lcklkPzogc3RyaW5nO1xuICBzdWJzY3JpcHRpb25JZD86IHN0cmluZztcbiAgc3RyaXBlU3Vic2NyaXB0aW9uSXRlbUlkPzogc3RyaW5nOyAvLyBOZXc6IGZvciBtZXRlcmVkIGJpbGxpbmcgaXRlbXNcbiAgc3Vic2NyaXB0aW9uU3RhdHVzPzogJ2FjdGl2ZScgfCAncGFzdF9kdWUnIHwgJ2NhbmNlbGVkJyB8ICdpbmNvbXBsZXRlJyB8ICd0cmlhbGluZyc7XG4gIHN1YnNjcmlwdGlvblBsYW4/OiBzdHJpbmc7XG5cbiAgLy8gUmVmcmVzaCBUb2tlbnNcbiAgcmVmcmVzaFRva2Vuczoge1xuICAgIHRva2VuOiBzdHJpbmc7IC8vIEhhc2hlZCBpbiBEQiBpZGVhbGx5LCBvciBqdXN0IHN0b3JlZCBpZiBoYW5kbGVkIGJ5IHNlcnZpY2VcbiAgICBleHBpcmVzOiBEYXRlO1xuICAgIGZhbWlseUlkOiBzdHJpbmc7XG4gICAgaXA6IHN0cmluZztcbiAgICB1c2VyQWdlbnQ6IHN0cmluZztcbiAgICBjcmVhdGVkQXQ6IERhdGU7XG4gIH1bXTtcblxuICAvLyBaZXJvIFRydXN0IFNlY3VyaXR5XG4gIHRydXN0ZWREZXZpY2VzOiB7XG4gICAgZGV2aWNlSWQ6IHN0cmluZztcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgbGFzdFBvc3R1cmVDaGVjazogRGF0ZTtcbiAgICBpc0NvbXBsaWFudDogYm9vbGVhbjtcbiAgICBkZXZpY2VJbmZvOiBhbnk7XG4gIH1bXTtcbiAgbGFzdFNlY3VyaXR5QXVkaXQ/OiBEYXRlO1xuXG4gIC8vIElvVCAvIEhvbWUgQXNzaXN0YW50XG4gIGhhQmFzZVVybD86IHN0cmluZztcbiAgaGFBY2Nlc3NUb2tlbj86IHN0cmluZztcblxuICAvLyBXZWJBdXRobiAvIFNvdmVyZWlnbiBIYXJkd2FyZSBLZXlzXG4gIGF1dGhlbnRpY2F0b3JzOiB7XG4gICAgY3JlZGVudGlhbElEOiBCdWZmZXI7XG4gICAgY3JlZGVudGlhbFB1YmxpY0tleTogQnVmZmVyO1xuICAgIGNvdW50ZXI6IG51bWJlcjtcbiAgICBjcmVkZW50aWFsRGV2aWNlVHlwZTogc3RyaW5nO1xuICAgIGNyZWRlbnRpYWxCYWNrZWRVcDogYm9vbGVhbjtcbiAgICB0cmFuc3BvcnRzPzogc3RyaW5nW107XG4gIH1bXTtcbn1cblxuY29uc3QgdXNlclNjaGVtYSA9IG5ldyBTY2hlbWE8SVVzZXI+KFxuICB7XG4gICAgbmFtZToge1xuICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgcmVxdWlyZWQ6IFt0cnVlLCAnRWwgbm9tYnJlIGVzIG9ibGlnYXRvcmlvJ10sXG4gICAgICB0cmltOiB0cnVlLFxuICAgICAgbWF4bGVuZ3RoOiBbNTAsICdFbCBub21icmUgbm8gcHVlZGUgdGVuZXIgbcOhcyBkZSA1MCBjYXJhY3RlcmVzJ10sXG4gICAgfSxcbiAgICBlbWFpbDoge1xuICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgcmVxdWlyZWQ6IFt0cnVlLCAnRWwgY29ycmVvIGVsZWN0csOzbmljbyBlcyBvYmxpZ2F0b3JpbyddLFxuICAgICAgdW5pcXVlOiB0cnVlLFxuICAgICAgbG93ZXJjYXNlOiB0cnVlLFxuICAgICAgdHJpbTogdHJ1ZSxcbiAgICAgIG1hdGNoOiBbL15cXFMrQFxcUytcXC5cXFMrJC8sICdQb3IgZmF2b3IgaW5ncmVzZSB1biBjb3JyZW8gZWxlY3Ryw7NuaWNvIHbDoWxpZG8nXSxcbiAgICB9LFxuICAgIHBhc3N3b3JkOiB7XG4gICAgICB0eXBlOiBTdHJpbmcsXG4gICAgICByZXF1aXJlZDogZmFsc2UsXG4gICAgICBtaW5sZW5ndGg6IFs4LCAnTGEgY29udHJhc2XDsWEgZGViZSB0ZW5lciBhbCBtZW5vcyA4IGNhcmFjdGVyZXMnXSxcbiAgICAgIHNlbGVjdDogZmFsc2UsIC8vIE5vIGRldm9sdmVyIGxhIGNvbnRyYXNlw7FhIHBvciBkZWZlY3RvXG4gICAgfSxcbiAgICByb2xlOiB7XG4gICAgICB0eXBlOiBTdHJpbmcsXG4gICAgICBlbnVtOiBbJ3VzZXInLCAnYWRtaW4nLCAnZGV2JywgJ3NhbGVzJywgJ2dvZCcsICdmYW1pbHknLCAncHJvZmVzc2lvbmFsJ10sXG4gICAgICBkZWZhdWx0OiAndXNlcicsXG4gICAgfSxcbiAgICBlbWFpbFZlcmlmaWNhdGlvbkNvZGU6IHsgdHlwZTogU3RyaW5nLCBzZWxlY3Q6IGZhbHNlIH0sXG4gICAgZW1haWxWZXJpZmljYXRpb25FeHBpcmVzOiB7IHR5cGU6IERhdGUsIHNlbGVjdDogZmFsc2UgfSxcbiAgICBpc0VtYWlsVmVyaWZpZWQ6IHtcbiAgICAgIHR5cGU6IEJvb2xlYW4sXG4gICAgICBkZWZhdWx0OiBmYWxzZSxcbiAgICB9LFxuICAgIHJlZnJlc2hUb2tlbnM6IFtcbiAgICAgIHtcbiAgICAgICAgdG9rZW46IHsgdHlwZTogU3RyaW5nLCByZXF1aXJlZDogdHJ1ZSB9LFxuICAgICAgICBleHBpcmVzOiB7IHR5cGU6IERhdGUsIHJlcXVpcmVkOiB0cnVlIH0sXG4gICAgICAgIGZhbWlseUlkOiB7IHR5cGU6IFN0cmluZywgcmVxdWlyZWQ6IHRydWUgfSxcbiAgICAgICAgaXA6IHsgdHlwZTogU3RyaW5nLCByZXF1aXJlZDogdHJ1ZSB9LFxuICAgICAgICB1c2VyQWdlbnQ6IHsgdHlwZTogU3RyaW5nLCByZXF1aXJlZDogdHJ1ZSB9LFxuICAgICAgICBjcmVhdGVkQXQ6IHsgdHlwZTogRGF0ZSwgZGVmYXVsdDogRGF0ZS5ub3cgfSxcbiAgICAgIH0sXG4gICAgXSxcbiAgICB0b2tlblZlcnNpb246IHtcbiAgICAgIHR5cGU6IE51bWJlcixcbiAgICAgIGRlZmF1bHQ6IDAsXG4gICAgfSxcbiAgICBsYXN0UGFzc3dvcmRDaGFuZ2U6IHtcbiAgICAgIHR5cGU6IERhdGUsXG4gICAgICBkZWZhdWx0OiBEYXRlLm5vdyxcbiAgICB9LFxuICAgIGxhc3RMb2dpbjoge1xuICAgICAgdHlwZTogRGF0ZSxcbiAgICB9LFxuICAgIHR3b0ZhY3RvclNlY3JldDogeyB0eXBlOiBTdHJpbmcsIHNlbGVjdDogZmFsc2UgfSxcbiAgICBpc01mYUVuYWJsZWQ6IHtcbiAgICAgIHR5cGU6IEJvb2xlYW4sXG4gICAgICBkZWZhdWx0OiBmYWxzZSxcbiAgICB9LFxuICAgIGxvZ2luQXR0ZW1wdHM6IHtcbiAgICAgIHR5cGU6IE51bWJlcixcbiAgICAgIHJlcXVpcmVkOiB0cnVlLFxuICAgICAgZGVmYXVsdDogMCxcbiAgICB9LFxuICAgIGxvY2tVbnRpbDoge1xuICAgICAgdHlwZTogRGF0ZSxcbiAgICB9LFxuICAgIC8vIFN0cmlwZSBGaWVsZHNcbiAgICBzdHJpcGVDdXN0b21lcklkOiB7IHR5cGU6IFN0cmluZywgc2VsZWN0OiBmYWxzZSB9LFxuICAgIHN1YnNjcmlwdGlvbklkOiB7IHR5cGU6IFN0cmluZywgc2VsZWN0OiBmYWxzZSB9LFxuICAgIHN0cmlwZVN1YnNjcmlwdGlvbkl0ZW1JZDogeyB0eXBlOiBTdHJpbmcsIHNlbGVjdDogZmFsc2UgfSxcbiAgICBzdWJzY3JpcHRpb25TdGF0dXM6IHtcbiAgICAgIHR5cGU6IFN0cmluZyxcbiAgICAgIGVudW06IFsnYWN0aXZlJywgJ3Bhc3RfZHVlJywgJ2NhbmNlbGVkJywgJ2luY29tcGxldGUnLCAndHJpYWxpbmcnXSxcbiAgICB9LFxuICAgIHN1YnNjcmlwdGlvblBsYW46IHsgdHlwZTogU3RyaW5nIH0sXG5cbiAgICAvLyBaZXJvIFRydXN0IFNlY3VyaXR5XG4gICAgdHJ1c3RlZERldmljZXM6IFtcbiAgICAgIHtcbiAgICAgICAgZGV2aWNlSWQ6IHsgdHlwZTogU3RyaW5nLCByZXF1aXJlZDogdHJ1ZSB9LFxuICAgICAgICBuYW1lOiB7IHR5cGU6IFN0cmluZywgcmVxdWlyZWQ6IHRydWUgfSxcbiAgICAgICAgbGFzdFBvc3R1cmVDaGVjazogeyB0eXBlOiBEYXRlLCBkZWZhdWx0OiBEYXRlLm5vdyB9LFxuICAgICAgICBpc0NvbXBsaWFudDogeyB0eXBlOiBCb29sZWFuLCBkZWZhdWx0OiB0cnVlIH0sXG4gICAgICAgIGRldmljZUluZm86IHsgdHlwZTogU2NoZW1hLlR5cGVzLk1peGVkIH0sXG4gICAgICB9LFxuICAgIF0sXG4gICAgbGFzdFNlY3VyaXR5QXVkaXQ6IHsgdHlwZTogRGF0ZSB9LFxuXG4gICAgLy8gSW9UIC8gSG9tZSBBc3Npc3RhbnQgKGVuY3J5cHRlZC9oaWRkZW4gYnkgZGVmYXVsdClcbiAgICBoYUJhc2VVcmw6IHsgdHlwZTogU3RyaW5nIH0sXG4gICAgaGFBY2Nlc3NUb2tlbjogeyB0eXBlOiBTdHJpbmcsIHNlbGVjdDogZmFsc2UgfSxcblxuICAgIC8vIFdlYkF1dGhuIC8gU292ZXJlaWduIEhhcmR3YXJlIEtleXNcbiAgICBhdXRoZW50aWNhdG9yczogW1xuICAgICAge1xuICAgICAgICBjcmVkZW50aWFsSUQ6IHsgdHlwZTogQnVmZmVyLCByZXF1aXJlZDogdHJ1ZSB9LFxuICAgICAgICBjcmVkZW50aWFsUHVibGljS2V5OiB7IHR5cGU6IEJ1ZmZlciwgcmVxdWlyZWQ6IHRydWUgfSxcbiAgICAgICAgY291bnRlcjogeyB0eXBlOiBOdW1iZXIsIHJlcXVpcmVkOiB0cnVlIH0sXG4gICAgICAgIGNyZWRlbnRpYWxEZXZpY2VUeXBlOiB7IHR5cGU6IFN0cmluZywgcmVxdWlyZWQ6IHRydWUgfSxcbiAgICAgICAgY3JlZGVudGlhbEJhY2tlZFVwOiB7IHR5cGU6IEJvb2xlYW4sIHJlcXVpcmVkOiB0cnVlIH0sXG4gICAgICAgIHRyYW5zcG9ydHM6IFt7IHR5cGU6IFN0cmluZyB9XSxcbiAgICAgIH0sXG4gICAgXSxcbiAgfSxcbiAge1xuICAgIHRpbWVzdGFtcHM6IHRydWUsXG4gICAgdG9KU09OOiB7XG4gICAgICB2aXJ0dWFsczogdHJ1ZSxcbiAgICAgIHRyYW5zZm9ybTogZnVuY3Rpb24gKF9kb2MsIHJldCkge1xuICAgICAgICBkZWxldGUgKHJldCBhcyBhbnkpLnBhc3N3b3JkOyAvLyBObyBpbmNsdWlyIGxhIGNvbnRyYXNlw7FhIGVuIGxhcyByZXNwdWVzdGFzIEpTT05cbiAgICAgICAgcmV0dXJuIHJldDtcbiAgICAgIH0sXG4gICAgfSxcbiAgfSxcbik7XG5cbi8vIE3DqXRvZG8gcGFyYSBjb21wYXJhciBjb250cmFzZcOxYXNcbnVzZXJTY2hlbWEubWV0aG9kcy5jb21wYXJlUGFzc3dvcmQgPSBhc3luYyBmdW5jdGlvbiAoY2FuZGlkYXRlUGFzc3dvcmQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICBjb25zdCBiY3J5cHQgPSByZXF1aXJlKCdiY3J5cHRqcycpO1xuICByZXR1cm4gYXdhaXQgYmNyeXB0LmNvbXBhcmUoY2FuZGlkYXRlUGFzc3dvcmQsIHRoaXMucGFzc3dvcmQpO1xufTtcblxuLy8gTWlkZGxld2FyZSBwYXJhIGhhc2hlYXIgbGEgY29udHJhc2XDsWEgYW50ZXMgZGUgZ3VhcmRhclxudXNlclNjaGVtYS5wcmUoJ3NhdmUnLCBhc3luYyBmdW5jdGlvbiAobmV4dCkge1xuICAvLyBTb2xvIGhhc2hlYXIgbGEgY29udHJhc2XDsWEgc2kgaGEgc2lkbyBtb2RpZmljYWRhIChvIGVzIG51ZXZhKVxuICBpZiAoIXRoaXMuaXNNb2RpZmllZCgncGFzc3dvcmQnKSkge1xuICAgIHJldHVybiBuZXh0KCk7XG4gIH1cblxuICB0cnkge1xuICAgIGNvbnN0IHNhbHQgPSBhd2FpdCByZXF1aXJlKCdiY3J5cHRqcycpLmdlblNhbHQoMTIpO1xuICAgIHRoaXMucGFzc3dvcmQgPSBhd2FpdCByZXF1aXJlKCdiY3J5cHRqcycpLmhhc2godGhpcy5wYXNzd29yZCwgc2FsdCk7XG4gICAgbmV4dCgpO1xuICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgbmV4dChlcnJvcik7XG4gIH1cbn0pO1xuXG5jb25zdCBVc2VyID0gbW9uZ29vc2UubW9kZWw8SVVzZXI+KCdVc2VyJywgdXNlclNjaGVtYSk7XG5cbmV4cG9ydCB7IFVzZXIgfTtcbiJdLCJ2ZXJzaW9uIjozfQ==