fc1d3b5c6780d64e12b0641ad9637d9f
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.HttpError = exports.errorHandler = void 0;
const logger_1 = require("../utils/logger");
const errors_1 = require("../utils/errors");
Object.defineProperty(exports, "HttpError", { enumerable: true, get: function () { return errors_1.AppError; } });
/**
 * Central error-handling middleware for Express.
 *
 * It catches synchronous and asynchronous errors. Operational errors (AppError)
 * are sent to the client with their status code and code. External errors
 * (Zod, Mongoose, JWT) are transformed into operational AppErrors for consistency.
 */
const errorHandler = (err, req, res, _next) => {
    let error = { ...err };
    error.message = err.message;
    // 1. Handle specific error types
    // Zod Validation Errors
    if (err.name === 'ZodError') {
        const message = 'Validation Failed';
        const details = err.issues.map((i) => ({
            path: i.path.join('.'),
            message: i.message,
        }));
        error = new errors_1.AppError(message, errors_1.HttpStatusCode.BAD_REQUEST, 'VALIDATION_ERROR', details);
    }
    // Mongoose Cast Error (e.g., invalid ObjectId)
    if (err.name === 'CastError') {
        const message = `Invalid ${err.path}: ${err.value}`;
        error = new errors_1.AppError(message, errors_1.HttpStatusCode.BAD_REQUEST, 'CAST_ERROR');
    }
    // Mongoose Duplicate Key Error
    if (err.code === 11000) {
        const value = err.errmsg.match(/(["'])(\\?.)*?\1/)[0];
        const message = `Duplicate field value: ${value}. Please use another value!`;
        error = new errors_1.AppError(message, errors_1.HttpStatusCode.CONFLICT, 'DUPLICATE_KEY_ERROR');
    }
    // Mongoose Validation Error
    if (err.name === 'ValidationError') {
        const errors = Object.values(err.errors).map((el) => el.message);
        const message = `Invalid input data. ${errors.join('. ')}`;
        error = new errors_1.AppError(message, errors_1.HttpStatusCode.BAD_REQUEST, 'VALIDATION_ERROR');
    }
    // JWT Errors
    if (err.name === 'JsonWebTokenError') {
        error = new errors_1.AppError('Invalid token. Please log in again!', errors_1.HttpStatusCode.UNAUTHORIZED, 'INVALID_TOKEN');
    }
    if (err.name === 'TokenExpiredError') {
        error = new errors_1.AppError('Your token has expired! Please log in again.', errors_1.HttpStatusCode.UNAUTHORIZED, 'TOKEN_EXPIRED');
    }
    // 2. Final Error Response
    const statusCode = err.status || error.statusCode || errors_1.HttpStatusCode.INTERNAL_SERVER_ERROR;
    const isDevelopment = process.env.NODE_ENV === 'development';
    const requestId = req.requestId || '';
    // Log non-operational (unexpected) errors
    if (!error.isOperational) {
        logger_1.logger.error('ERROR ðŸ’¥:', err);
        // Phase 5: Report to Google Cloud in production
        try {
            const { container, TYPES } = require('../config/inversify.config');
            const { ErrorReportingService } = require('../services/google/error-reporting.service');
            const errorReporting = container.get(TYPES.ErrorReportingService);
            errorReporting.report(err, req);
        }
        catch (reportErr) {
            logger_1.logger.error('Failed to report error to Google Cloud', reportErr);
        }
    }
    else {
        logger_1.logger.warn(`Operational Error: ${error.message} [${error.code}]`);
    }
    // Use standardized builder for consistent error format
    const { buildError } = require('../common/response-builder');
    const response = buildError(error.message || 'Something went wrong!', error.code || 'INTERNAL_ERROR', statusCode, requestId, error.details);
    // Add stack trace in development
    if (isDevelopment && !error.isOperational) {
        response.error.stack = err.stack;
    }
    res.status(statusCode).json(response);
};
exports.errorHandler = errorHandler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxtaWRkbGV3YXJlXFxlcnJvckhhbmRsZXIudHMiLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsNENBQXlDO0FBQ3pDLDRDQUEyRDtBQXNHdEMsMEZBdEdaLGlCQUFRLE9Bc0dhO0FBcEc5Qjs7Ozs7O0dBTUc7QUFDSSxNQUFNLFlBQVksR0FBRyxDQUFDLEdBQVEsRUFBRSxHQUFZLEVBQUUsR0FBYSxFQUFFLEtBQW1CLEVBQUUsRUFBRTtJQUN6RixJQUFJLEtBQUssR0FBRyxFQUFFLEdBQUcsR0FBRyxFQUFFLENBQUM7SUFDdkIsS0FBSyxDQUFDLE9BQU8sR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDO0lBRTVCLGlDQUFpQztJQUVqQyx3QkFBd0I7SUFDeEIsSUFBSSxHQUFHLENBQUMsSUFBSSxLQUFLLFVBQVUsRUFBRSxDQUFDO1FBQzVCLE1BQU0sT0FBTyxHQUFHLG1CQUFtQixDQUFDO1FBQ3BDLE1BQU0sT0FBTyxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQzFDLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUM7WUFDdEIsT0FBTyxFQUFFLENBQUMsQ0FBQyxPQUFPO1NBQ25CLENBQUMsQ0FBQyxDQUFDO1FBQ0osS0FBSyxHQUFHLElBQUksaUJBQVEsQ0FBQyxPQUFPLEVBQUUsdUJBQWMsQ0FBQyxXQUFXLEVBQUUsa0JBQWtCLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDekYsQ0FBQztJQUVELCtDQUErQztJQUMvQyxJQUFJLEdBQUcsQ0FBQyxJQUFJLEtBQUssV0FBVyxFQUFFLENBQUM7UUFDN0IsTUFBTSxPQUFPLEdBQUcsV0FBVyxHQUFHLENBQUMsSUFBSSxLQUFLLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNwRCxLQUFLLEdBQUcsSUFBSSxpQkFBUSxDQUFDLE9BQU8sRUFBRSx1QkFB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LE9BQU8sQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO0lBQzdELE1BQU0sUUFBUSxHQUFHLFVBQVUsQ0FDekIsS0FBSyxDQUFDLE9BQU8sSUFBSSx1QkFBdUIsRUFDeEMsS0FBSyxDQUFDLElBQUksSUFBSSxnQkFBZ0IsRUFDOUIsVUFBVSxFQUNWLFNBQVMsRUFDVCxLQUFLLENBQUMsT0FBTyxDQUNkLENBQUM7SUFFRixpQ0FBaUM7SUFDakMsSUFBSSxhQUFhLElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDMUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQztJQUNuQyxDQUFDO0lBRUQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDeEMsQ0FBQyxDQUFDO0FBMUZXLFFBQUEsWUFBWSxnQkEwRnZCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcQWxlamFuZHJvXFxBSUdlc3Rpb25cXGJhY2tlbmRcXHNyY1xcbWlkZGxld2FyZVxcZXJyb3JIYW5kbGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgTmV4dEZ1bmN0aW9uLCBSZXF1ZXN0LCBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi4vdXRpbHMvbG9nZ2VyJztcbmltcG9ydCB7IEFwcEVycm9yLCBIdHRwU3RhdHVzQ29kZSB9IGZyb20gJy4uL3V0aWxzL2Vycm9ycyc7XG5cbi8qKlxuICogQ2VudHJhbCBlcnJvci1oYW5kbGluZyBtaWRkbGV3YXJlIGZvciBFeHByZXNzLlxuICpcbiAqIEl0IGNhdGNoZXMgc3luY2hyb25vdXMgYW5kIGFzeW5jaHJvbm91cyBlcnJvcnMuIE9wZXJhdGlvbmFsIGVycm9ycyAoQXBwRXJyb3IpXG4gKiBhcmUgc2VudCB0byB0aGUgY2xpZW50IHdpdGggdGhlaXIgc3RhdHVzIGNvZGUgYW5kIGNvZGUuIEV4dGVybmFsIGVycm9yc1xuICogKFpvZCwgTW9uZ29vc2UsIEpXVCkgYXJlIHRyYW5zZm9ybWVkIGludG8gb3BlcmF0aW9uYWwgQXBwRXJyb3JzIGZvciBjb25zaXN0ZW5jeS5cbiAqL1xuZXhwb3J0IGNvbnN0IGVycm9ySGFuZGxlciA9IChlcnI6IGFueSwgcmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBfbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG4gIGxldCBlcnJvciA9IHsgLi4uZXJyIH07XG4gIGVycm9yLm1lc3NhZ2UgPSBlcnIubWVzc2FnZTtcblxuICAvLyAxLiBIYW5kbGUgc3BlY2lmaWMgZXJyb3IgdHlwZXNcblxuICAvLyBab2QgVmFsaWRhdGlvbiBFcnJvcnNcbiAgaWYgKGVyci5uYW1lID09PSAnWm9kRXJyb3InKSB7XG4gICAgY29uc3QgbWVzc2FnZSA9ICdWYWxpZGF0aW9uIEZhaWxlZCc7XG4gICAgY29uc3QgZGV0YWlscyA9IGVyci5pc3N1ZXMubWFwKChpOiBhbnkpID0+ICh7XG4gICAgICBwYXRoOiBpLnBhdGguam9pbignLicpLFxuICAgICAgbWVzc2FnZTogaS5tZXNzYWdlLFxuICAgIH0pKTtcbiAgICBlcnJvciA9IG5ldyBBcHBFcnJvcihtZXNzYWdlLCBIdHRwU3RhdHVzQ29kZS5CQURfUkVRVUVTVCwgJ1ZBTElEQVRJT05fRVJST1InLCBkZXRhaWxzKTtcbiAgfVxuXG4gIC8vIE1vbmdvb3NlIENhc3QgRXJyb3IgKGUuZy4sIGludmFsaWQgT2JqZWN0SWQpXG4gIGlmIChlcnIubmFtZSA9PT0gJ0Nhc3RFcnJvcicpIHtcbiAgICBjb25zdCBtZXNzYWdlID0gYEludmFsaWQgJHtlcnIucGF0aH06ICR7ZXJyLnZhbHVlfWA7XG4gICAgZXJyb3IgPSBuZXcgQXBwRXJyb3IobWVzc2FnZSwgSHR0cFN0YXR1c0NvZGUuQkFEX1JFUVVFU1QsICdDQVNUX0VSUk9SJyk7XG4gIH1cblxuICAvLyBNb25nb29zZSBEdXBsaWNhdGUgS2V5IEVycm9yXG4gIGlmIChlcnIuY29kZSA9PT0gMTEwMDApIHtcbiAgICBjb25zdCB2YWx1ZSA9IGVyci5lcnJtc2cubWF0Y2goLyhbXCInXSkoXFxcXD8uKSo/XFwxLylbMF07XG4gICAgY29uc3QgbWVzc2FnZSA9IGBEdXBsaWNhdGUgZmllbGQgdmFsdWU6ICR7dmFsdWV9LiBQbGVhc2UgdXNlIGFub3RoZXIgdmFsdWUhYDtcbiAgICBlcnJvciA9IG5ldyBBcHBFcnJvcihtZXNzYWdlLCBIdHRwU3RhdHVzQ29kZS5DT05GTElDVCwgJ0RVUExJQ0FURV9LRVlfRVJST1InKTtcbiAgfVxuXG4gIC8vIE1vbmdvb3NlIFZhbGlkYXRpb24gRXJyb3JcbiAgaWYgKGVyci5uYW1lID09PSAnVmFsaWRhdGlvbkVycm9yJykge1xuICAgIGNvbnN0IGVycm9ycyA9IE9iamVjdC52YWx1ZXMoZXJyLmVycm9ycykubWFwKChlbDogYW55KSA9PiBlbC5tZXNzYWdlKTtcbiAgICBjb25zdCBtZXNzYWdlID0gYEludmFsaWQgaW5wdXQgZGF0YS4gJHtlcnJvcnMuam9pbignLiAnKX1gO1xuICAgIGVycm9yID0gbmV3IEFwcEVycm9yKG1lc3NhZ2UsIEh0dHBTdGF0dXNDb2RlLkJBRF9SRVFVRVNULCAnVkFMSURBVElPTl9FUlJPUicpO1xuICB9XG5cbiAgLy8gSldUIEVycm9yc1xuICBpZiAoZXJyLm5hbWUgPT09ICdKc29uV2ViVG9rZW5FcnJvcicpIHtcbiAgICBlcnJvciA9IG5ldyBBcHBFcnJvcihcbiAgICAgICdJbnZhbGlkIHRva2VuLiBQbGVhc2UgbG9nIGluIGFnYWluIScsXG4gICAgICBIdHRwU3RhdHVzQ29kZS5VTkFVVEhPUklaRUQsXG4gICAgICAnSU5WQUxJRF9UT0tFTicsXG4gICAgKTtcbiAgfVxuICBpZiAoZXJyLm5hbWUgPT09ICdUb2tlbkV4cGlyZWRFcnJvcicpIHtcbiAgICBlcnJvciA9IG5ldyBBcHBFcnJvcihcbiAgICAgICdZb3VyIHRva2VuIGhhcyBleHBpcmVkISBQbGVhc2UgbG9nIGluIGFnYWluLicsXG4gICAgICBIdHRwU3RhdHVzQ29kZS5VTkFVVEhPUklaRUQsXG4gICAgICAnVE9LRU5fRVhQSVJFRCcsXG4gICAgKTtcbiAgfVxuXG4gIC8vIDIuIEZpbmFsIEVycm9yIFJlc3BvbnNlXG4gIGNvbnN0IHN0YXR1c0NvZGUgPSBlcnIuc3RhdHVzIHx8IGVycm9yLnN0YXR1c0NvZGUgfHwgSHR0cFN0YXR1c0NvZGUuSU5URVJOQUxfU0VSVkVSX0VSUk9SO1xuICBjb25zdCBpc0RldmVsb3BtZW50ID0gcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICdkZXZlbG9wbWVudCc7XG4gIGNvbnN0IHJlcXVlc3RJZCA9IChyZXEgYXMgYW55KS5yZXF1ZXN0SWQgfHwgJyc7XG5cbiAgLy8gTG9nIG5vbi1vcGVyYXRpb25hbCAodW5leHBlY3RlZCkgZXJyb3JzXG4gIGlmICghZXJyb3IuaXNPcGVyYXRpb25hbCkge1xuICAgIGxvZ2dlci5lcnJvcignRVJST1Ig8J+SpTonLCBlcnIpO1xuXG4gICAgLy8gUGhhc2UgNTogUmVwb3J0IHRvIEdvb2dsZSBDbG91ZCBpbiBwcm9kdWN0aW9uXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgY29udGFpbmVyLCBUWVBFUyB9ID0gcmVxdWlyZSgnLi4vY29uZmlnL2ludmVyc2lmeS5jb25maWcnKTtcbiAgICAgIGNvbnN0IHsgRXJyb3JSZXBvcnRpbmdTZXJ2aWNlIH0gPSByZXF1aXJlKCcuLi9zZXJ2aWNlcy9nb29nbGUvZXJyb3ItcmVwb3J0aW5nLnNlcnZpY2UnKTtcbiAgICAgIGNvbnN0IGVycm9yUmVwb3J0aW5nID0gY29udGFpbmVyLmdldChUWVBFUy5FcnJvclJlcG9ydGluZ1NlcnZpY2UpO1xuICAgICAgZXJyb3JSZXBvcnRpbmcucmVwb3J0KGVyciwgcmVxKTtcbiAgICB9IGNhdGNoIChyZXBvcnRFcnIpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignRmFpbGVkIHRvIHJlcG9ydCBlcnJvciB0byBHb29nbGUgQ2xvdWQnLCByZXBvcnRFcnIpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBsb2dnZXIud2FybihgT3BlcmF0aW9uYWwgRXJyb3I6ICR7ZXJyb3IubWVzc2FnZX0gWyR7ZXJyb3IuY29kZX1dYCk7XG4gIH1cblxuICAvLyBVc2Ugc3RhbmRhcmRpemVkIGJ1aWxkZXIgZm9yIGNvbnNpc3RlbnQgZXJyb3IgZm9ybWF0XG4gIGNvbnN0IHsgYnVpbGRFcnJvciB9ID0gcmVxdWlyZSgnLi4vY29tbW9uL3Jlc3BvbnNlLWJ1aWxkZXInKTtcbiAgY29uc3QgcmVzcG9uc2UgPSBidWlsZEVycm9yKFxuICAgIGVycm9yLm1lc3NhZ2UgfHwgJ1NvbWV0aGluZyB3ZW50IHdyb25nIScsXG4gICAgZXJyb3IuY29kZSB8fCAnSU5URVJOQUxfRVJST1InLFxuICAgIHN0YXR1c0NvZGUsXG4gICAgcmVxdWVzdElkLFxuICAgIGVycm9yLmRldGFpbHMsXG4gICk7XG5cbiAgLy8gQWRkIHN0YWNrIHRyYWNlIGluIGRldmVsb3BtZW50XG4gIGlmIChpc0RldmVsb3BtZW50ICYmICFlcnJvci5pc09wZXJhdGlvbmFsKSB7XG4gICAgcmVzcG9uc2UuZXJyb3Iuc3RhY2sgPSBlcnIuc3RhY2s7XG4gIH1cblxuICByZXMuc3RhdHVzKHN0YXR1c0NvZGUpLmpzb24ocmVzcG9uc2UpO1xufTtcblxuLy8gRXhwb3J0aW5nIEh0dHBFcnJvciBmb3IgbGVnYWN5IGNvbXBhdGliaWxpdHkgaWYgbmVlZGVkLCBidXQgQXBwRXJyb3IgaXMgcHJlZmVycmVkLlxuZXhwb3J0IHsgQXBwRXJyb3IgYXMgSHR0cEVycm9yIH07XG4iXSwidmVyc2lvbiI6M30=