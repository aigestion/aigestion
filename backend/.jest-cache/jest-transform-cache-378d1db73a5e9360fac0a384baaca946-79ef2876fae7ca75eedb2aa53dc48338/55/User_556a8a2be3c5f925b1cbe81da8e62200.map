{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\models\\User.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\models\\User.ts"],"sourcesContent":["import mongoose, { Document, Schema } from 'mongoose';\n\nexport interface IUser extends Document {\n  id: string;\n  name: string;\n  email: string;\n  twoFactorSecret?: string;\n  password: string;\n\n  lastLogin?: Date;\n  isMfaEnabled: boolean;\n  isTwoFactorEnabled?: boolean; // Alias for backward compatibility\n  loginAttempts: number;\n  lockUntil?: Date;\n  tokenVersion: number;\n  lastPasswordChange: Date;\n  createdAt: Date;\n  updatedAt: Date;\n  comparePassword(candidatePassword: string): Promise<boolean>;\n\n  // Email Verification\n  emailVerificationCode?: string;\n  emailVerificationExpires?: Date;\n  isEmailVerified: boolean;\n\n  // Roles\n  role: 'user' | 'admin' | 'dev' | 'sales' | 'god' | 'family' | 'professional';\n  stripeCustomerId?: string;\n  subscriptionId?: string;\n  stripeSubscriptionItemId?: string; // New: for metered billing items\n  subscriptionStatus?: 'active' | 'past_due' | 'canceled' | 'incomplete' | 'trialing';\n  subscriptionPlan?: string;\n\n  // Refresh Tokens\n  refreshTokens: {\n    token: string; // Hashed in DB ideally, or just stored if handled by service\n    expires: Date;\n    familyId: string;\n    ip: string;\n    userAgent: string;\n    createdAt: Date;\n  }[];\n\n  // Zero Trust Security\n  trustedDevices: {\n    deviceId: string;\n    name: string;\n    lastPostureCheck: Date;\n    isCompliant: boolean;\n    deviceInfo: any;\n  }[];\n  lastSecurityAudit?: Date;\n\n  // IoT / Home Assistant\n  haBaseUrl?: string;\n  haAccessToken?: string;\n\n  // WebAuthn / Sovereign Hardware Keys\n  authenticators: {\n    credentialID: Buffer;\n    credentialPublicKey: Buffer;\n    counter: number;\n    credentialDeviceType: string;\n    credentialBackedUp: boolean;\n    transports?: string[];\n  }[];\n}\n\nconst userSchema = new Schema<IUser>(\n  {\n    name: {\n      type: String,\n      required: [true, 'El nombre es obligatorio'],\n      trim: true,\n      maxlength: [50, 'El nombre no puede tener más de 50 caracteres'],\n    },\n    email: {\n      type: String,\n      required: [true, 'El correo electrónico es obligatorio'],\n      unique: true,\n      lowercase: true,\n      trim: true,\n      match: [/^\\S+@\\S+\\.\\S+$/, 'Por favor ingrese un correo electrónico válido'],\n    },\n    password: {\n      type: String,\n      required: false,\n      minlength: [8, 'La contraseña debe tener al menos 8 caracteres'],\n      select: false, // No devolver la contraseña por defecto\n    },\n    role: {\n      type: String,\n      enum: ['user', 'admin', 'dev', 'sales', 'god', 'family', 'professional'],\n      default: 'user',\n    },\n    emailVerificationCode: { type: String, select: false },\n    emailVerificationExpires: { type: Date, select: false },\n    isEmailVerified: {\n      type: Boolean,\n      default: false,\n    },\n    refreshTokens: [\n      {\n        token: { type: String, required: true },\n        expires: { type: Date, required: true },\n        familyId: { type: String, required: true },\n        ip: { type: String, required: true },\n        userAgent: { type: String, required: true },\n        createdAt: { type: Date, default: Date.now },\n      },\n    ],\n    tokenVersion: {\n      type: Number,\n      default: 0,\n    },\n    lastPasswordChange: {\n      type: Date,\n      default: Date.now,\n    },\n    lastLogin: {\n      type: Date,\n    },\n    twoFactorSecret: { type: String, select: false },\n    isMfaEnabled: {\n      type: Boolean,\n      default: false,\n    },\n    loginAttempts: {\n      type: Number,\n      required: true,\n      default: 0,\n    },\n    lockUntil: {\n      type: Date,\n    },\n    // Stripe Fields\n    stripeCustomerId: { type: String, select: false },\n    subscriptionId: { type: String, select: false },\n    stripeSubscriptionItemId: { type: String, select: false },\n    subscriptionStatus: {\n      type: String,\n      enum: ['active', 'past_due', 'canceled', 'incomplete', 'trialing'],\n    },\n    subscriptionPlan: { type: String },\n\n    // Zero Trust Security\n    trustedDevices: [\n      {\n        deviceId: { type: String, required: true },\n        name: { type: String, required: true },\n        lastPostureCheck: { type: Date, default: Date.now },\n        isCompliant: { type: Boolean, default: true },\n        deviceInfo: { type: Schema.Types.Mixed },\n      },\n    ],\n    lastSecurityAudit: { type: Date },\n\n    // IoT / Home Assistant (encrypted/hidden by default)\n    haBaseUrl: { type: String },\n    haAccessToken: { type: String, select: false },\n\n    // WebAuthn / Sovereign Hardware Keys\n    authenticators: [\n      {\n        credentialID: { type: Buffer, required: true },\n        credentialPublicKey: { type: Buffer, required: true },\n        counter: { type: Number, required: true },\n        credentialDeviceType: { type: String, required: true },\n        credentialBackedUp: { type: Boolean, required: true },\n        transports: [{ type: String }],\n      },\n    ],\n  },\n  {\n    timestamps: true,\n    toJSON: {\n      virtuals: true,\n      transform: function (_doc, ret) {\n        delete (ret as any).password; // No incluir la contraseña en las respuestas JSON\n        return ret;\n      },\n    },\n  },\n);\n\n// Método para comparar contraseñas\nuserSchema.methods.comparePassword = async function (candidatePassword: string): Promise<boolean> {\n  const bcrypt = require('bcryptjs');\n  return await bcrypt.compare(candidatePassword, this.password);\n};\n\n// Middleware para hashear la contraseña antes de guardar\nuserSchema.pre('save', async function (next) {\n  // Solo hashear la contraseña si ha sido modificada (o es nueva)\n  if (!this.isModified('password')) {\n    return next();\n  }\n\n  try {\n    const salt = await require('bcryptjs').genSalt(12);\n    this.password = await require('bcryptjs').hash(this.password, salt);\n    next();\n  } catch (error: any) {\n    next(error);\n  }\n});\n\nconst User = mongoose.model<IUser>('User', userSchema);\n\nexport { User };\n"],"version":3}