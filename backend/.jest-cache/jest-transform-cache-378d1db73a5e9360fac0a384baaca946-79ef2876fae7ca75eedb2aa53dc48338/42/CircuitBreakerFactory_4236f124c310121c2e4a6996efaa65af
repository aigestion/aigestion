ec497904dcdcf049a44c70cbc8eec791
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.CircuitBreakerFactory = void 0;
const CircuitBreaker = require("opossum");
const logger_1 = require("../../utils/logger");
class CircuitBreakerFactory {
    static DEFAULT_CONFIG = {
        timeout: 20000, // 20 seconds
        errorThresholdPercentage: 50,
        resetTimeout: 30000, // 30 seconds
    };
    /**
     * Creates a new Circuit Breaker for a given function.
     * @param action The function to wrap
     * @param config Configuration overrides
     */
    static create(action, config = {}) {
        const options = {
            ...this.DEFAULT_CONFIG,
            ...config,
        };
        const breaker = new CircuitBreaker(action, options);
        breaker.on('open', () => {
            logger_1.logger.warn(`[CircuitBreaker] OPEN: ${options.name || 'Anonymous'}`);
        });
        breaker.on('halfOpen', () => {
            logger_1.logger.info(`[CircuitBreaker] HALF-OPEN: ${options.name || 'Anonymous'}`);
        });
        breaker.on('close', () => {
            logger_1.logger.info(`[CircuitBreaker] CLOSE: ${options.name || 'Anonymous'}`);
        });
        breaker.on('fallback', (_result) => {
            logger_1.logger.warn(`[CircuitBreaker] FALLBACK: ${options.name || 'Anonymous'}`);
        });
        // Don't log every failure to avoid noise, let the caller handle errors.
        // However, if the breaker is open, future calls fail fast.
        return breaker;
    }
}
exports.CircuitBreakerFactory = CircuitBreakerFactory;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxpbmZyYXN0cnVjdHVyZVxccmVzaWxpZW5jZVxcQ2lyY3VpdEJyZWFrZXJGYWN0b3J5LnRzIiwibWFwcGluZ3MiOiI7OztBQUFBLDBDQUEyQztBQUMzQywrQ0FBNEM7QUFXNUMsTUFBYSxxQkFBcUI7SUFDeEIsTUFBTSxDQUFVLGNBQWMsR0FBRztRQUN2QyxPQUFPLEVBQUUsS0FBSyxFQUFFLGFBQWE7UUFDN0Isd0JBQXdCLEVBQUUsRUFBRTtRQUM1QixZQUFZLEVBQUUsS0FBSyxFQUFFLGFBQWE7S0FDbkMsQ0FBQztJQUVGOzs7O09BSUc7SUFDSSxNQUFNLENBQUMsTUFBTSxDQUNsQixNQUFvQyxFQUNwQyxTQUErQixFQUFFO1FBRWpDLE1BQU0sT0FBTyxHQUFHO1lBQ2QsR0FBRyxJQUFJLENBQUMsY0FBYztZQUN0QixHQUFHLE1BQU07U0FDVixDQUFDO1FBRUYsTUFBTSxPQUFPLEdBQUcsSUFBSSxjQUFjLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBRXBELE9BQU8sQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRTtZQUN0QixlQUFNLENBQUMsSUFBSSxDQUFDLDBCQUEwQixPQUFPLENBQUMsSUFBSSxJQUFJLFdBQVcsRUFBRSxDQUFDLENBQUM7UUFDdkUsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLENBQUMsRUFBRSxDQUFDLFVBQVUsRUFBRSxHQUFHLEVBQUU7WUFDMUIsZUFBTSxDQUFDLElBQUksQ0FBQywrQkFBK0IsT0FBTyxDQUFDLElBQUksSUFBSSxXQUFXLEVBQUUsQ0FBQyxDQUFDO1FBQzVFLENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFO1lBQ3ZCLGVBQU0sQ0FBQyxJQUFJLENBQUMsMkJBQTJCLE9BQU8sQ0FBQyxJQUFJLElBQUksV0FBVyxFQUFFLENBQUMsQ0FBQztRQUN4RSxDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sQ0FBQyxFQUFFLENBQUMsVUFBVSxFQUFFLENBQUMsT0FBWSxFQUFFLEVBQUU7WUFDdEMsZUFBTSxDQUFDLElBQUksQ0FBQyw4QkFBOEIsT0FBTyxDQUFDLElBQUksSUFBSSxXQUFXLEVBQUUsQ0FBQyxDQUFDO1FBQzNFLENBQUMsQ0FBQyxDQUFDO1FBRUgsd0VBQXdFO1FBQ3hFLDJEQUEyRDtRQUUzRCxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDOztBQTNDSCxzREE0Q0MiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxpbmZyYXN0cnVjdHVyZVxccmVzaWxpZW5jZVxcQ2lyY3VpdEJyZWFrZXJGYWN0b3J5LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBDaXJjdWl0QnJlYWtlciA9IHJlcXVpcmUoJ29wb3NzdW0nKTtcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uLy4uL3V0aWxzL2xvZ2dlcic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ2lyY3VpdEJyZWFrZXJDb25maWcge1xuICB0aW1lb3V0PzogbnVtYmVyO1xuICBlcnJvclRocmVzaG9sZFBlcmNlbnRhZ2U/OiBudW1iZXI7XG4gIHJlc2V0VGltZW91dD86IG51bWJlcjtcbiAgbmFtZT86IHN0cmluZztcbiAgcm9sbGluZ0NvdW50VGltZW91dD86IG51bWJlcjtcbiAgdm9sdW1lVGhyZXNob2xkPzogbnVtYmVyO1xufVxuXG5leHBvcnQgY2xhc3MgQ2lyY3VpdEJyZWFrZXJGYWN0b3J5IHtcbiAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgREVGQVVMVF9DT05GSUcgPSB7XG4gICAgdGltZW91dDogMjAwMDAsIC8vIDIwIHNlY29uZHNcbiAgICBlcnJvclRocmVzaG9sZFBlcmNlbnRhZ2U6IDUwLFxuICAgIHJlc2V0VGltZW91dDogMzAwMDAsIC8vIDMwIHNlY29uZHNcbiAgfTtcblxuICAvKipcbiAgICogQ3JlYXRlcyBhIG5ldyBDaXJjdWl0IEJyZWFrZXIgZm9yIGEgZ2l2ZW4gZnVuY3Rpb24uXG4gICAqIEBwYXJhbSBhY3Rpb24gVGhlIGZ1bmN0aW9uIHRvIHdyYXBcbiAgICogQHBhcmFtIGNvbmZpZyBDb25maWd1cmF0aW9uIG92ZXJyaWRlc1xuICAgKi9cbiAgcHVibGljIHN0YXRpYyBjcmVhdGU8VEkgZXh0ZW5kcyB1bmtub3duW10sIFRSPihcbiAgICBhY3Rpb246ICguLi5hcmdzOiBUSSkgPT4gUHJvbWlzZTxUUj4sXG4gICAgY29uZmlnOiBDaXJjdWl0QnJlYWtlckNvbmZpZyA9IHt9LFxuICApOiBhbnkge1xuICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICAuLi50aGlzLkRFRkFVTFRfQ09ORklHLFxuICAgICAgLi4uY29uZmlnLFxuICAgIH07XG5cbiAgICBjb25zdCBicmVha2VyID0gbmV3IENpcmN1aXRCcmVha2VyKGFjdGlvbiwgb3B0aW9ucyk7XG5cbiAgICBicmVha2VyLm9uKCdvcGVuJywgKCkgPT4ge1xuICAgICAgbG9nZ2VyLndhcm4oYFtDaXJjdWl0QnJlYWtlcl0gT1BFTjogJHtvcHRpb25zLm5hbWUgfHwgJ0Fub255bW91cyd9YCk7XG4gICAgfSk7XG5cbiAgICBicmVha2VyLm9uKCdoYWxmT3BlbicsICgpID0+IHtcbiAgICAgIGxvZ2dlci5pbmZvKGBbQ2lyY3VpdEJyZWFrZXJdIEhBTEYtT1BFTjogJHtvcHRpb25zLm5hbWUgfHwgJ0Fub255bW91cyd9YCk7XG4gICAgfSk7XG5cbiAgICBicmVha2VyLm9uKCdjbG9zZScsICgpID0+IHtcbiAgICAgIGxvZ2dlci5pbmZvKGBbQ2lyY3VpdEJyZWFrZXJdIENMT1NFOiAke29wdGlvbnMubmFtZSB8fCAnQW5vbnltb3VzJ31gKTtcbiAgICB9KTtcblxuICAgIGJyZWFrZXIub24oJ2ZhbGxiYWNrJywgKF9yZXN1bHQ6IGFueSkgPT4ge1xuICAgICAgbG9nZ2VyLndhcm4oYFtDaXJjdWl0QnJlYWtlcl0gRkFMTEJBQ0s6ICR7b3B0aW9ucy5uYW1lIHx8ICdBbm9ueW1vdXMnfWApO1xuICAgIH0pO1xuXG4gICAgLy8gRG9uJ3QgbG9nIGV2ZXJ5IGZhaWx1cmUgdG8gYXZvaWQgbm9pc2UsIGxldCB0aGUgY2FsbGVyIGhhbmRsZSBlcnJvcnMuXG4gICAgLy8gSG93ZXZlciwgaWYgdGhlIGJyZWFrZXIgaXMgb3BlbiwgZnV0dXJlIGNhbGxzIGZhaWwgZmFzdC5cblxuICAgIHJldHVybiBicmVha2VyO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=