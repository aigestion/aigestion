f8bb3a1ae4c0c3976b8f74b2748bf6bf
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.Enable2FAUseCase = void 0;
const inversify_1 = require("inversify");
const types_1 = require("../../types");
const User_1 = require("../../models/User");
const two_factor_service_1 = require("../../services/two-factor.service");
const errors_1 = require("../../utils/errors");
let Enable2FAUseCase = class Enable2FAUseCase {
    twoFactorService;
    constructor(twoFactorService) {
        this.twoFactorService = twoFactorService;
    }
    async execute(userId) {
        const user = await User_1.User.findById(userId).exec();
        if (!user) {
            throw new errors_1.AppError('User not found', 404, 'USER_NOT_FOUND');
        }
        if (!user.email) {
            throw new errors_1.AppError('User email not found', 400, 'USER_EMAIL_MISSING');
        }
        const { secret, qrCode } = await this.twoFactorService.generateTOTPSecret(user.id, user.email);
        user.twoFactorSecret = secret;
        user.isMfaEnabled = false; // will be true after verification
        await user.save();
        return { secret, qrCode };
    }
};
exports.Enable2FAUseCase = Enable2FAUseCase;
exports.Enable2FAUseCase = Enable2FAUseCase = __decorate([
    (0, inversify_1.injectable)(),
    __param(0, (0, inversify_1.inject)(types_1.TYPES.TwoFactorService)),
    __metadata("design:paramtypes", [typeof (_a = typeof two_factor_service_1.TwoFactorService !== "undefined" && two_factor_service_1.TwoFactorService) === "function" ? _a : Object])
], Enable2FAUseCase);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxhcHBsaWNhdGlvblxcdXNlY2FzZXNcXEVuYWJsZTJGQVVzZUNhc2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLHlDQUErQztBQUMvQyx1Q0FBb0M7QUFDcEMsNENBQXlDO0FBQ3pDLDBFQUFxRTtBQUNyRSwrQ0FBOEM7QUFHdkMsSUFBTSxnQkFBZ0IsR0FBdEIsTUFBTSxnQkFBZ0I7SUFDeUI7SUFBcEQsWUFBb0QsZ0JBQWtDO1FBQWxDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7SUFBRyxDQUFDO0lBRTFGLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBYztRQUMxQixNQUFNLElBQUksR0FBRyxNQUFPLFdBQVksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDekQsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ1YsTUFBTSxJQUFJLGlCQUFRLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFLGdCQUFnQixDQUFDLENBQUM7UUFDOUQsQ0FBQztRQUNELElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDaEIsTUFBTSxJQUFJLGlCQUFRLENBQUMsc0JBQXNCLEVBQUUsR0FBRyxFQUFFLG9CQUFvQixDQUFDLENBQUM7UUFDeEUsQ0FBQztRQUVELE1BQU0sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLEdBQUcsTUFBTSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsa0JBQWtCLENBQ3ZFLElBQUksQ0FBQyxFQUFZLEVBQ2pCLElBQUksQ0FBQyxLQUFLLENBQ1gsQ0FBQztRQUNGLElBQUksQ0FBQyxlQUFlLEdBQUcsTUFBTSxDQUFDO1FBQzlCLElBQUksQ0FBQyxZQUFZLEdBQUcsS0FBSyxDQUFDLENBQUMsa0NBQWtDO1FBQzdELE1BQU0sSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ2xCLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLENBQUM7SUFDNUIsQ0FBQztDQUNGLENBQUE7QUFyQlksNENBQWdCOzJCQUFoQixnQkFBZ0I7SUFENUIsSUFBQSxzQkFBVSxHQUFFO0lBRUUsV0FBQSxJQUFBLGtCQUFNLEVBQUMsYUFBSyxDQUFDLGdCQUFnQixDQUFDLENBQUE7eURBQTJCLHFDQUFnQixvQkFBaEIscUNBQWdCO0dBRDNFLGdCQUFnQixDQXFCNUIiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxhcHBsaWNhdGlvblxcdXNlY2FzZXNcXEVuYWJsZTJGQVVzZUNhc2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaW5qZWN0YWJsZSwgaW5qZWN0IH0gZnJvbSAnaW52ZXJzaWZ5JztcbmltcG9ydCB7IFRZUEVTIH0gZnJvbSAnLi4vLi4vdHlwZXMnO1xuaW1wb3J0IHsgVXNlciB9IGZyb20gJy4uLy4uL21vZGVscy9Vc2VyJztcbmltcG9ydCB7IFR3b0ZhY3RvclNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy90d28tZmFjdG9yLnNlcnZpY2UnO1xuaW1wb3J0IHsgQXBwRXJyb3IgfSBmcm9tICcuLi8uLi91dGlscy9lcnJvcnMnO1xuXG5AaW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgRW5hYmxlMkZBVXNlQ2FzZSB7XG4gIGNvbnN0cnVjdG9yKEBpbmplY3QoVFlQRVMuVHdvRmFjdG9yU2VydmljZSkgcHJpdmF0ZSB0d29GYWN0b3JTZXJ2aWNlOiBUd29GYWN0b3JTZXJ2aWNlKSB7fVxuXG4gIGFzeW5jIGV4ZWN1dGUodXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPHsgc2VjcmV0OiBzdHJpbmc7IHFyQ29kZTogc3RyaW5nIH0+IHtcbiAgICBjb25zdCB1c2VyID0gYXdhaXQgKFVzZXIgYXMgYW55KS5maW5kQnlJZCh1c2VySWQpLmV4ZWMoKTtcbiAgICBpZiAoIXVzZXIpIHtcbiAgICAgIHRocm93IG5ldyBBcHBFcnJvcignVXNlciBub3QgZm91bmQnLCA0MDQsICdVU0VSX05PVF9GT1VORCcpO1xuICAgIH1cbiAgICBpZiAoIXVzZXIuZW1haWwpIHtcbiAgICAgIHRocm93IG5ldyBBcHBFcnJvcignVXNlciBlbWFpbCBub3QgZm91bmQnLCA0MDAsICdVU0VSX0VNQUlMX01JU1NJTkcnKTtcbiAgICB9XG5cbiAgICBjb25zdCB7IHNlY3JldCwgcXJDb2RlIH0gPSBhd2FpdCB0aGlzLnR3b0ZhY3RvclNlcnZpY2UuZ2VuZXJhdGVUT1RQU2VjcmV0KFxuICAgICAgdXNlci5pZCBhcyBzdHJpbmcsXG4gICAgICB1c2VyLmVtYWlsLFxuICAgICk7XG4gICAgdXNlci50d29GYWN0b3JTZWNyZXQgPSBzZWNyZXQ7XG4gICAgdXNlci5pc01mYUVuYWJsZWQgPSBmYWxzZTsgLy8gd2lsbCBiZSB0cnVlIGFmdGVyIHZlcmlmaWNhdGlvblxuICAgIGF3YWl0IHVzZXIuc2F2ZSgpO1xuICAgIHJldHVybiB7IHNlY3JldCwgcXJDb2RlIH07XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==