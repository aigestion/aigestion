07a32e492568decf128cdc246f14d776
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.scanUploadedFiles = exports.uploadMultiple = exports.uploadSingle = exports.malwareScanner = exports.MalwareScannerMiddleware = void 0;
const multer_1 = __importDefault(require("multer"));
const path_1 = __importDefault(require("path"));
const inversify_config_1 = require("../config/inversify.config");
const logger_1 = require("../utils/logger");
const user_behavior_service_1 = require("../services/user-behavior.service");
const promises_1 = __importDefault(require("fs/promises"));
const malware_scanner_config_1 = require("../config/malware-scanner.config");
/**
 * Middleware for scanning uploaded files for malware
 */
class MalwareScannerMiddleware {
    _scanner;
    uploadDir = malware_scanner_config_1.malwareScannerConfig.uploadDir;
    get scanner() {
        return (this._scanner ??= inversify_config_1.container.get(inversify_config_1.TYPES.MalwareScannerService));
    }
    get behaviorService() {
        return inversify_config_1.container.get(user_behavior_service_1.UserBehaviorService);
    }
    constructor() {
        this.initializeUploadDir();
    }
    async initializeUploadDir() {
        try {
            await promises_1.default.mkdir(this.uploadDir, { recursive: true });
            logger_1.logger.info('Upload directory initialized');
        }
        catch (error) {
            logger_1.logger.error('Failed to initialize upload directory:', error);
        }
    }
    /**
     * Multer configuration for file uploads
     */
    getMulterConfig() {
        const storage = multer_1.default.diskStorage({
            destination: (req, file, cb) => {
                cb(null, this.uploadDir);
            },
            filename: (req, file, cb) => {
                const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1e9);
                const ext = path_1.default.extname(file.originalname);
                cb(null, `${file.fieldname}-${uniqueSuffix}${ext}`);
            },
        });
        const fileFilter = (req, file, cb) => {
            // Check file size limit from config
            if (file.size > malware_scanner_config_1.malwareScannerConfig.maxFileSize) {
                return cb(new Error(`File size exceeds ${malware_scanner_config_1.malwareScannerConfig.maxFileSize / (1024 * 1024)}MB limit`));
            }
            // Check allowed MIME types from config
            if (malware_scanner_config_1.malwareScannerConfig.allowedMimeTypes.includes(file.mimetype)) {
                cb(null, true);
            }
            else {
                cb(new Error(`File type ${file.mimetype} is not allowed`));
            }
        };
        return (0, multer_1.default)({
            storage,
            fileFilter,
            limits: {
                fileSize: malware_scanner_config_1.malwareScannerConfig.maxFileSize,
                files: malware_scanner_config_1.malwareScannerConfig.maxFiles,
            },
        });
    }
    /**
     * Middleware to scan uploaded files
     */
    scanFiles = async (req, res, next) => {
        const files = req.files;
        if (!files || !Array.isArray(files) || files.length === 0) {
            return next();
        }
        const scanResults = [];
        const userId = req.user?.id;
        try {
            // Scan each file
            for (const file of files) {
                logger_1.logger.info('Scanning uploaded file', {
                    filename: file.filename,
                    originalname: file.originalname,
                    size: file.size,
                    mimetype: file.mimetype,
                });
                try {
                    const scanResult = await this.scanner.scanFile(file.path, userId);
                    const fileScanResult = {
                        originalname: file.originalname,
                        filename: file.filename,
                        path: file.path,
                        size: file.size,
                        mimetype: file.mimetype,
                        scanResult,
                        isClean: !scanResult.isInfected,
                    };
                    scanResults.push(fileScanResult);
                    // If file is infected, remove it from uploads
                    if (scanResult.isInfected) {
                        // Track threat event
                        if (userId) {
                            await this.behaviorService.trackThreat(userId, file.originalname, scanResult.threats, this.getClientIP(req));
                        }
                        try {
                            await promises_1.default.unlink(file.path);
                            logger_1.logger.warn('Infected file removed from uploads', {
                                filename: file.filename,
                                threats: scanResult.threats,
                            });
                        }
                        catch (unlinkErr) {
                            logger_1.logger.error('Failed to remove infected file:', unlinkErr);
                        }
                    }
                }
                catch (error) {
                    logger_1.logger.error('Error scanning file:', {
                        filename: file.filename,
                        error,
                    });
                    // Remove file if scan failed
                    try {
                        await promises_1.default.unlink(file.path);
                    }
                    catch (unlinkErr) {
                        logger_1.logger.error('Failed to remove file after scan error:', unlinkErr);
                    }
                    return res.status(500).json({
                        success: false,
                        error: 'File scan failed',
                        details: error instanceof Error ? error.message : 'Unknown error',
                    });
                }
            }
            // Check if any files were infected
            const infectedFiles = scanResults.filter(result => !result.isClean);
            if (infectedFiles.length > 0) {
                logger_1.logger.warn('Malware detected in uploaded files, cleaning up all files in request', {
                    totalFiles: scanResults.length,
                    infectedFiles: infectedFiles.length,
                });
                // Cleanup ALL files for this request to prevent leaks
                for (const fileItem of files) {
                    try {
                        await promises_1.default.unlink(fileItem.path);
                    }
                    catch (unlinkErr) {
                        // File might already be unlinked if it was the infected one
                    }
                }
                return res.status(422).json({
                    success: false,
                    error: 'Malware detected',
                    message: `${infectedFiles.length} file(s) contained malware. All uploaded files for this request have been removed.`,
                    infectedFiles: infectedFiles.map(f => ({
                        originalname: f.originalname,
                        threats: f.scanResult.threats,
                    })),
                });
            }
            // Attach scan results to request
            req.fileScanResults = scanResults;
            logger_1.logger.info('All files scanned successfully', {
                totalFiles: scanResults.length,
                totalSize: scanResults.reduce((sum, f) => sum + f.size, 0),
            });
            next();
        }
        catch (error) {
            logger_1.logger.error('Error in malware scan middleware:', error);
            // Clean up all files if middleware fails
            const uploadedFiles = req.files;
            if (uploadedFiles && Array.isArray(uploadedFiles)) {
                for (const fileItem of uploadedFiles) {
                    try {
                        await promises_1.default.unlink(fileItem.path);
                    }
                    catch (unlinkErr) {
                        logger_1.logger.error('Failed to cleanup file:', unlinkErr);
                    }
                }
            }
            return res.status(500).json({
                success: false,
                error: 'File scan process failed',
                details: error instanceof Error ? error.message : 'Unknown error',
            });
        }
    };
    /**
     * Middleware for single file upload with scanning
     */
    uploadSingle(field) {
        const upload = this.getMulterConfig().single(field);
        return async (req, res, next) => {
            // First, handle the upload
            upload(req, res, async (err) => {
                if (err) {
                    logger_1.logger.error('File upload error:', err);
                    return res.status(400).json({
                        success: false,
                        error: 'File upload failed',
                        details: err.message,
                    });
                }
                // Then scan the file if it exists
                const file = req.file;
                if (file) {
                    const userId = req.user?.id;
                    try {
                        const scanResult = await this.scanner.scanFile(file.path, userId);
                        if (scanResult.isInfected) {
                            // Track threat event
                            if (userId) {
                                await this.behaviorService.trackThreat(userId, file.originalname, scanResult.threats, this.getClientIP(req));
                            }
                            // Remove infected file
                            try {
                                await promises_1.default.unlink(file.path);
                            }
                            catch (unlinkErr) {
                                logger_1.logger.error('Failed to remove infected file:', unlinkErr);
                            }
                            return res.status(422).json({
                                success: false,
                                error: 'Malware detected',
                                message: 'Uploaded file contains malware and was removed',
                                threats: scanResult.threats,
                            });
                        }
                        // Attach scan result
                        req.fileScanResult = scanResult;
                        logger_1.logger.info('File scanned successfully', {
                            filename: file.filename,
                            scanTime: scanResult.scanTime,
                        });
                    }
                    catch (error) {
                        logger_1.logger.error('Error scanning uploaded file:', error);
                        // Remove file if scan failed
                        try {
                            if (file) {
                                await promises_1.default.unlink(file.path);
                            }
                        }
                        catch (unlinkErr) {
                            logger_1.logger.error('Failed to remove file after scan error:', unlinkErr);
                        }
                        return res.status(500).json({
                            success: false,
                            error: 'File scan failed',
                            details: error instanceof Error ? error.message : 'Unknown error',
                        });
                    }
                }
                next();
            });
        };
    }
    /**
     * Middleware for multiple file upload with scanning
     */
    uploadMultiple(field, maxCount = 5) {
        const upload = this.getMulterConfig().array(field, maxCount);
        return async (req, res, next) => {
            // First, handle the upload
            upload(req, res, async (err) => {
                if (err) {
                    logger_1.logger.error('File upload error:', err);
                    return res.status(400).json({
                        success: false,
                        error: 'File upload failed',
                        details: err.message,
                    });
                }
                // Then scan files using the scanFiles middleware
                this.scanFiles(req, res, next);
            });
        };
    }
    /**
     * Get scanner statistics
     */
    getScannerStats() {
        return this.scanner.getScanStats();
    }
    /**
     * Clear scanner cache
     */
    clearCache() {
        this.scanner.clearCache();
    }
    /**
     * Get client IP address
     */
    getClientIP(req) {
        return req.ip || req.connection?.remoteAddress || req.socket?.remoteAddress || 'unknown';
    }
}
exports.MalwareScannerMiddleware = MalwareScannerMiddleware;
// Export singleton instance
exports.malwareScanner = new MalwareScannerMiddleware();
// Export convenience methods
const uploadSingle = (field) => exports.malwareScanner.uploadSingle(field);
exports.uploadSingle = uploadSingle;
const uploadMultiple = (field, maxCount) => exports.malwareScanner.uploadMultiple(field, maxCount);
exports.uploadMultiple = uploadMultiple;
exports.scanUploadedFiles = exports.malwareScanner.scanFiles;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxtaWRkbGV3YXJlXFxtYWx3YXJlLXNjYW5uZXIubWlkZGxld2FyZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7QUFDQSxvREFBNEI7QUFDNUIsZ0RBQXdCO0FBQ3hCLGlFQUE4RDtBQUU5RCw0Q0FBeUM7QUFDekMsNkVBQXdFO0FBQ3hFLDJEQUE2QjtBQUM3Qiw2RUFBd0U7QUFheEU7O0dBRUc7QUFDSCxNQUFhLHdCQUF3QjtJQUMzQixRQUFRLENBQW9DO0lBQzVDLFNBQVMsR0FBRyw2Q0FBb0IsQ0FBQyxTQUFTLENBQUM7SUFFbkQsSUFBWSxPQUFPO1FBQ2pCLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxLQUFLLDRCQUFTLENBQUMsR0FBRyxDQUF3Qix3QkFBSyxDQUFDLHFCQUFxQixDQUFDLENBQUMsQ0FBQztJQUMvRixDQUFDO0lBRUQsSUFBWSxlQUFlO1FBQ3pCLE9BQU8sNEJBQVMsQ0FBQyxHQUFHLENBQXNCLDJDQUFtQixDQUFDLENBQUM7SUFDakUsQ0FBQztJQUVEO1FBQ0UsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7SUFDN0IsQ0FBQztJQUVPLEtBQUssQ0FBQyxtQkFBbUI7UUFDL0IsSUFBSSxDQUFDO1lBQ0gsTUFBTSxrQkFBRSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7WUFDcEQsZUFBTSxDQUFDLElBQUksQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO1FBQzlDLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsZUFBTSxDQUFDLEtBQUssQ0FBQyx3Q0FBd0MsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNoRSxDQUFDO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0ksZUFBZTtRQUNwQixNQUFNLE9BQU8sR0FBRyxnQkFBTSxDQUFDLFdBQVcsQ0FBQztZQUNqQyxXQUFXLEVBQUUsQ0FBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxFQUFFO2dCQUM3QixFQUFFLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUMzQixDQUFDO1lBQ0QsUUFBUSxFQUFFLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsRUFBRTtnQkFDMUIsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxHQUFHLENBQUMsQ0FBQztnQkFDeEUsTUFBTSxHQUFHLEdBQUcsY0FBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7Z0JBQzVDLEVBQUUsQ0FBQyxJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUMsU0FBUyxJQUFJLFlBQVksR0FBRyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBQ3RELENBQUM7U0FDRixDQUFDLENBQUM7UUFFSCxNQUFNLFVBQVUsR0FBRyxDQUFDLEdBQVEsRUFBRSxJQUFTLEVBQUUsRUFBTyxFQUFFLEVBQUU7WUFDbEQsb0NBQW9DO1lBQ3BDLElBQUksSUFBSSxDQUFDLElBQUksR0FBRyw2Q0FBb0IsQ0FBQyxXQUFXLEVBQUUsQ0FBQztnQkFDakQsT0FBTyxFQUFFLENBQ1AsSUFBSSxLQUFLLENBQ1AscUJBQXFCLDZDQUFvQixDQUFDLFdBQVcsR0FBRyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsVUFBVSxDQUNoRixDQUNGLENBQUM7WUFDSixDQUFDO1lBRUQsdUNBQXVDO1lBQ3ZDLElBQUksNkNBQW9CLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDO2dCQUNsRSxFQUFFLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQ2pCLENBQUM7aUJBQU0sQ0FBQztnQkFDTixFQUFFLENBQUMsSUFBSSxLQUFLLENBQUMsYUFBYSxJQUFJLENBQUMsUUFBUSxpQkFBaUIsQ0FBQyxDQUFDLENBQUM7WUFDN0QsQ0FBQztRQUNILENBQUMsQ0FBQztRQUVGLE9BQU8sSUFBQSxnQkFBTSxFQUFDO1lBQ1osT0FBTztZQUNQLFVBQVU7WUFDVixNQUFNLEVBQUU7Z0JBQ04sUUFBUSxFQUFFLDZDQUFvQixDQUFDLFdBQVc7Z0JBQzFDLEtBQUssRUFBRSw2Q0FBb0IsQ0FBQyxRQUFRO2FBQ3JDO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOztPQUVHO0lBQ0ksU0FBUyxHQUFHLEtBQUssRUFBRSxHQUFRLEVBQUUsR0FBUSxFQUFFLElBQWtCLEVBQUUsRUFBRTtRQUNsRSxNQUFNLEtBQUssR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDO1FBQ3hCLElBQUksQ0FBQyxLQUFLLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLEtBQUssQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDMUQsT0FBTyxJQUFJLEVBQUUsQ0FBQztRQUNoQixDQUFDO1FBRUQsTUFBTSxXQUFXLEdBQXFCLEVBQUUsQ0FBQztRQUN6QyxNQUFNLE1BQU0sR0FBRyxHQUFHLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQztRQUU1QixJQUFJLENBQUM7WUFDSCxpQkFBaUI7WUFDakIsS0FBSyxNQUFNLElBQUksSUFBSSxLQUFLLEVBQUUsQ0FBQztnQkFDekIsZUFBTSxDQUFDLElBQUksQ0FBQyx3QkFBd0IsRUFBRTtvQkFDcEMsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRO29CQUN2QixZQUFZLEVBQUUsSUFBSSxDQUFDLFlBQVk7b0JBQy9CLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSTtvQkFDZixRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVE7aUJBQ3hCLENBQUMsQ0FBQztnQkFFSCxJQUFJLENBQUM7b0JBQ0gsTUFBTSxVQUFVLEdBQUcsTUFBTSxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO29CQUVsRSxNQUFNLGNBQWMsR0FBbUI7d0JBQ3JDLFlBQVksRUFBRSxJQUFJLENBQUMsWUFBWTt3QkFDL0IsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRO3dCQUN2QixJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7d0JBQ2YsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJO3dCQUNmLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTt3QkFDdkIsVUFBVTt3QkFDVixPQUFPLEVBQUUsQ0FBQyxVQUFVLENBQUMsVUFBVTtxQkFDaEMsQ0FBQztvQkFFRixXQUFXLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO29CQUVqQyw4Q0FBOEM7b0JBQzlDLElBQUksVUFBVSxDQUFDLFVBQVUsRUFBRSxDQUFDO3dCQUMxQixxQkFBcUI7d0JBQ3JCLElBQUksTUFBTSxFQUFFLENBQUM7NEJBQ1gsTUFBTSxJQUFJLENBQUMsZUFBZSxDQUFDLFdBQVcsQ0FDcEMsTUFBTSxFQUNOLElBQUksQ0FBQyxZQUFZLEVBQ2pCLFVBQVUsQ0FBQyxPQUFPLEVBQ2xCLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQ3RCLENBQUM7d0JBQ0osQ0FBQzt3QkFFRCxJQUFJLENBQUM7NEJBQ0gsTUFBTSxrQkFBRSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7NEJBQzNCLGVBQU0sQ0FBQyxJQUFJLENBQUMsb0NBQW9DLEVBQUU7Z0NBQ2hELFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTtnQ0FDdkIsT0FBTyxFQUFFLFVBQVUsQ0FBQyxPQUFPOzZCQUM1QixDQUFDLENBQUM7d0JBQ0wsQ0FBQzt3QkFBQyxPQUFPLFNBQVMsRUFBRSxDQUFDOzRCQUNuQixlQUFNLENBQUMsS0FBSyxDQUFDLGlDQUFpQyxFQUFFLFNBQVMsQ0FBQyxDQUFDO3dCQUM3RCxDQUFDO29CQUNILENBQUM7Z0JBQ0gsQ0FBQztnQkFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO29CQUNmLGVBQU0sQ0FBQyxLQUFLLENBQUMsc0JBQXNCLEVBQUU7d0JBQ25DLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTt3QkFDdkIsS0FBSztxQkFDTixDQUFDLENBQUM7b0JBRUgsNkJBQTZCO29CQUM3QixJQUFJLENBQUM7d0JBQ0gsTUFBTSxrQkFBRSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7b0JBQzdCLENBQUM7b0JBQUMsT0FBTyxTQUFTLEVBQUUsQ0FBQzt3QkFDbkIsZUFBTSxDQUFDLEtBQUssQ0FBQyx5Q0FBeUMsRUFBRSxTQUFTLENBQUMsQ0FBQztvQkFDckUsQ0FBQztvQkFFRCxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO3dCQUMxQixPQUFPLEVBQUUsS0FBSzt3QkFDZCxLQUFLLEVBQUUsa0JBQWtCO3dCQUN6QixPQUFPLEVBQUUsS0FBSyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsZUFBZTtxQkFDbEUsQ0FBQyxDQUFDO2dCQUNMLENBQUM7WUFDSCxDQUFDO1lBRUQsbUNBQW1DO1lBQ25DLE1BQU0sYUFBYSxHQUFHLFdBQVcsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUVwRSxJQUFJLGFBQWEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7Z0JBQzdCLGVBQU0sQ0FBQyxJQUFJLENBQUMsc0VBQXNFLEVBQUU7b0JBQ2xGLFVBQVUsRUFBRSxXQUFXLENBQUMsTUFBTTtvQkFDOUIsYUFBYSxFQUFFLGFBQWEsQ0FBQyxNQUFNO2lCQUNwQyxDQUFDLENBQUM7Z0JBRUgsc0RBQXNEO2dCQUN0RCxLQUFLLE1BQU0sUUFBUSxJQUFJLEtBQUssRUFBRSxDQUFDO29CQUM3QixJQUFJLENBQUM7d0JBQ0gsTUFBTSxrQkFBRSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7b0JBQ2pDLENBQUM7b0JBQUMsT0FBTyxTQUFTLEVBQUUsQ0FBQzt3QkFDbkIsNERBQTREO29CQUM5RCxDQUFDO2dCQUNILENBQUM7Z0JBRUQsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDMUIsT0FBTyxFQUFFLEtBQUs7b0JBQ2QsS0FBSyxFQUFFLGtCQUFrQjtvQkFDekIsT0FBTyxFQUFFLEdBQUcsYUFBYSxDQUFDLE1BQU0sb0ZBQW9GO29CQUNwSCxhQUFhLEVBQUUsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7d0JBQ3JDLFlBQVksRUFBRSxDQUFDLENBQUMsWUFBWTt3QkFDNUIsT0FBTyxFQUFFLENBQUMsQ0FBQyxVQUFVLENBQUMsT0FBTztxQkFDOUIsQ0FBQyxDQUFDO2lCQUNKLENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCxpQ0FBaUM7WUFDakMsR0FBRyxDQUFDLGVBQWUsR0FBRyxXQUFXLENBQUM7WUFFbEMsZUFBTSxDQUFDLElBQUksQ0FBQyxnQ0FBZ0MsRUFBRTtnQkFDNUMsVUFBVSxFQUFFLFdBQVcsQ0FBQyxNQUFNO2dCQUM5QixTQUFTLEVBQUUsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQzthQUMzRCxDQUFDLENBQUM7WUFFSCxJQUFJLEVBQUUsQ0FBQztRQUNULENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsZUFBTSxDQUFDLEtBQUssQ0FBQyxtQ0FBbUMsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUV6RCx5Q0FBeUM7WUFDekMsTUFBTSxhQUFhLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQztZQUNoQyxJQUFJLGFBQWEsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUM7Z0JBQ2xELEtBQUssTUFBTSxRQUFRLElBQUksYUFBYSxFQUFFLENBQUM7b0JBQ3JDLElBQUksQ0FBQzt3QkFDSCxNQUFNLGtCQUFFLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDakMsQ0FBQztvQkFBQyxPQUFPLFNBQVMsRUFBRSxDQUFDO3dCQUNuQixlQUFNLENBQUMsS0FBSyxDQUFDLHlCQUF5QixFQUFFLFNBQVMsQ0FBQyxDQUFDO29CQUNyRCxDQUFDO2dCQUNILENBQUM7WUFDSCxDQUFDO1lBRUQsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDMUIsT0FBTyxFQUFFLEtBQUs7Z0JBQ2QsS0FBSyxFQUFFLDBCQUEwQjtnQkFDakMsT0FBTyxFQUFFLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLGVBQWU7YUFDbEUsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztJQUNILENBQUMsQ0FBQztJQUVGOztPQUVHO0lBQ0ksWUFBWSxDQUFDLEtBQWE7UUFDL0IsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUVwRCxPQUFPLEtBQUssRUFBRSxHQUFRLEVBQUUsR0FBUSxFQUFFLElBQWtCLEVBQUUsRUFBRTtZQUN0RCwyQkFBMkI7WUFDM0IsTUFBTSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFDLEdBQUcsRUFBQyxFQUFFO2dCQUMzQixJQUFJLEdBQUcsRUFBRSxDQUFDO29CQUNSLGVBQU0sQ0FBQyxLQUFLLENBQUMsb0JBQW9CLEVBQUUsR0FBRyxDQUFDLENBQUM7b0JBQ3hDLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7d0JBQzFCLE9BQU8sRUFBRSxLQUFLO3dCQUNkLEtBQUssRUFBRSxvQkFBb0I7d0JBQzNCLE9BQU8sRUFBRSxHQUFHLENBQUMsT0FBTztxQkFDckIsQ0FBQyxDQUFDO2dCQUNMLENBQUM7Z0JBRUQsa0NBQWtDO2dCQUNsQyxNQUFNLElBQUksR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO2dCQUN0QixJQUFJLElBQUksRUFBRSxDQUFDO29CQUNULE1BQU0sTUFBTSxHQUFHLEdBQUcsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDO29CQUU1QixJQUFJLENBQUM7d0JBQ0gsTUFBTSxVQUFVLEdBQUcsTUFBTSxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO3dCQUVsRSxJQUFJLFVBQVUsQ0FBQyxVQUFVLEVBQUUsQ0FBQzs0QkFDMUIscUJBQXFCOzRCQUNyQixJQUFJLE1BQU0sRUFBRSxDQUFDO2dDQUNYLE1BQU0sSUFBSSxDQUFDLGVBQWUsQ0FBQyxXQUFXLENBQ3BDLE1BQU0sRUFDTixJQUFJLENBQUMsWUFBWSxFQUNqQixVQUFVLENBQUMsT0FBTyxFQUNsQixJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUN0QixDQUFDOzRCQUNKLENBQUM7NEJBRUQsdUJBQXVCOzRCQUN2QixJQUFJLENBQUM7Z0NBQ0gsTUFBTSxrQkFBRSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7NEJBQzdCLENBQUM7NEJBQUMsT0FBTyxTQUFTLEVBQUUsQ0FBQztnQ0FDbkIsZUFBTSxDQUFDLEtBQUssQ0FBQyxpQ0FBaUMsRUFBRSxTQUFTLENBQUMsQ0FBQzs0QkFDN0QsQ0FBQzs0QkFFRCxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2dDQUMxQixPQUFPLEVBQUUsS0FBSztnQ0FDZCxLQUFLLEVBQUUsa0JBQWtCO2dDQUN6QixPQUFPLEVBQUUsZ0RBQWdEO2dDQUN6RCxPQUFPLEVBQUUsVUFBVSxDQUFDLE9BQU87NkJBQzVCLENBQUMsQ0FBQzt3QkFDTCxDQUFDO3dCQUVELHFCQUFxQjt3QkFDckIsR0FBRyxDQUFDLGNBQWMsR0FBRyxVQUFVLENBQUM7d0JBQ2hDLGVBQU0sQ0FBQyxJQUFJLENBQUMsMkJBQTJCLEVBQUU7NEJBQ3ZDLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTs0QkFDdkIsUUFBUSxFQUFFLFVBQVUsQ0FBQyxRQUFRO3lCQUM5QixDQUFDLENBQUM7b0JBQ0wsQ0FBQztvQkFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO3dCQUNmLGVBQU0sQ0FBQyxLQUFLLENBQUMsK0JBQStCLEVBQUUsS0FBSyxDQUFDLENBQUM7d0JBRXJELDZCQUE2Qjt3QkFDN0IsSUFBSSxDQUFDOzRCQUNILElBQUksSUFBSSxFQUFFLENBQUM7Z0NBQ1QsTUFBTSxrQkFBRSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7NEJBQzdCLENBQUM7d0JBQ0gsQ0FBQzt3QkFBQyxPQUFPLFNBQVMsRUFBRSxDQUFDOzRCQUNuQixlQUFNLENBQUMsS0FBSyxDQUFDLHlDQUF5QyxFQUFFLFNBQVMsQ0FBQyxDQUFDO3dCQUNyRSxDQUFDO3dCQUVELE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7NEJBQzFCLE9BQU8sRUFBRSxLQUFLOzRCQUNkLEtBQUssRUFBRSxrQkFBa0I7NEJBQ3pCLE9BQU8sRUFBRSxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxlQUFlO3lCQUNsRSxDQUFDLENBQUM7b0JBQ0wsQ0FBQztnQkFDSCxDQUFDO2dCQUVELElBQUksRUFBRSxDQUFDO1lBQ1QsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSSxjQUFjLENBQUMsS0FBYSxFQUFFLFdBQW1CLENBQUM7UUFDdkQsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFFN0QsT0FBTyxLQUFLLEVBQUUsR0FBUSxFQUFFLEdBQVEsRUFBRSxJQUFrQixFQUFFLEVBQUU7WUFDdEQsMkJBQTJCO1lBQzNCLE1BQU0sQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBQyxHQUFHLEVBQUMsRUFBRTtnQkFDM0IsSUFBSSxHQUFHLEVBQUUsQ0FBQztvQkFDUixlQUFNLENBQUMsS0FBSyxDQUFDLG9CQUFvQixFQUFFLEdBQUcsQ0FBQyxDQUFDO29CQUN4QyxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO3dCQUMxQixPQUFPLEVBQUUsS0FBSzt3QkFDZCxLQUFLLEVBQUUsb0JBQW9CO3dCQUMzQixPQUFPLEVBQUUsR0FBRyxDQUFDLE9BQU87cUJBQ3JCLENBQUMsQ0FBQztnQkFDTCxDQUFDO2dCQUVELGlEQUFpRDtnQkFDakQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQ2pDLENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDO0lBQ0osQ0FBQztJQUVEOztPQUVHO0lBQ0ksZUFBZTtRQUNwQixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDckMsQ0FBQztJQUVEOztPQUVHO0lBQ0ksVUFBVTtRQUNmLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLENBQUM7SUFDNUIsQ0FBQztJQUVEOztPQUVHO0lBQ0ssV0FBVyxDQUFDLEdBQVE7UUFDMUIsT0FBTyxHQUFHLENBQUMsRUFBRSxJQUFJLEdBQUcsQ0FBQyxVQUFVLEVBQUUsYUFBYSxJQUFJLEdBQUcsQ0FBQyxNQUFNLEVBQUUsYUFBYSxJQUFJLFNBQVMsQ0FBQztJQUMzRixDQUFDO0NBQ0Y7QUFoVkQsNERBZ1ZDO0FBRUQsNEJBQTRCO0FBQ2YsUUFBQSxjQUFjLEdBQUcsSUFBSSx3QkFBd0IsRUFBRSxDQUFDO0FBRTdELDZCQUE2QjtBQUN0QixNQUFNLFlBQVksR0FBRyxDQUFDLEtBQWEsRUFBRSxFQUFFLENBQUMsc0JBQWMsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUM7QUFBckUsUUFBQSxZQUFZLGdCQUF5RDtBQUMzRSxNQUFNLGNBQWMsR0FBRyxDQUFDLEtBQWEsRUFBRSxRQUFpQixFQUFFLEVBQUUsQ0FDakUsc0JBQWMsQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0FBRHBDLFFBQUEsY0FBYyxrQkFDc0I7QUFDcEMsUUFBQSxpQkFBaUIsR0FBRyxzQkFBYyxDQUFDLFNBQVMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXEFsZWphbmRyb1xcQUlHZXN0aW9uXFxiYWNrZW5kXFxzcmNcXG1pZGRsZXdhcmVcXG1hbHdhcmUtc2Nhbm5lci5taWRkbGV3YXJlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE5leHRGdW5jdGlvbiwgUmVxdWVzdCwgUmVzcG9uc2UgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCBtdWx0ZXIgZnJvbSAnbXVsdGVyJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgY29udGFpbmVyLCBUWVBFUyB9IGZyb20gJy4uL2NvbmZpZy9pbnZlcnNpZnkuY29uZmlnJztcbmltcG9ydCB7IE1hbHdhcmVTY2FubmVyU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL21hbHdhcmUtc2Nhbm5lci5zZXJ2aWNlJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uL3V0aWxzL2xvZ2dlcic7XG5pbXBvcnQgeyBVc2VyQmVoYXZpb3JTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvdXNlci1iZWhhdmlvci5zZXJ2aWNlJztcbmltcG9ydCBmcyBmcm9tICdmcy9wcm9taXNlcyc7XG5pbXBvcnQgeyBtYWx3YXJlU2Nhbm5lckNvbmZpZyB9IGZyb20gJy4uL2NvbmZpZy9tYWx3YXJlLXNjYW5uZXIuY29uZmlnJztcblxuLy8gSW50ZXJmYWNlIGZvciBpbnRlcm5hbCB1c2UgaW5zdGVhZCBvZiBleHRlbmRpbmcgZXhwcmVzcyBHbG9iYWwgUmVxdWVzdFxuaW50ZXJmYWNlIEZpbGVTY2FuUmVzdWx0IHtcbiAgb3JpZ2luYWxuYW1lOiBzdHJpbmc7XG4gIGZpbGVuYW1lOiBzdHJpbmc7XG4gIHBhdGg6IHN0cmluZztcbiAgc2l6ZTogbnVtYmVyO1xuICBtaW1ldHlwZTogc3RyaW5nO1xuICBzY2FuUmVzdWx0OiBhbnk7XG4gIGlzQ2xlYW46IGJvb2xlYW47XG59XG5cbi8qKlxuICogTWlkZGxld2FyZSBmb3Igc2Nhbm5pbmcgdXBsb2FkZWQgZmlsZXMgZm9yIG1hbHdhcmVcbiAqL1xuZXhwb3J0IGNsYXNzIE1hbHdhcmVTY2FubmVyTWlkZGxld2FyZSB7XG4gIHByaXZhdGUgX3NjYW5uZXI6IE1hbHdhcmVTY2FubmVyU2VydmljZSB8IHVuZGVmaW5lZDtcbiAgcHJpdmF0ZSB1cGxvYWREaXIgPSBtYWx3YXJlU2Nhbm5lckNvbmZpZy51cGxvYWREaXI7XG5cbiAgcHJpdmF0ZSBnZXQgc2Nhbm5lcigpOiBNYWx3YXJlU2Nhbm5lclNlcnZpY2Uge1xuICAgIHJldHVybiAodGhpcy5fc2Nhbm5lciA/Pz0gY29udGFpbmVyLmdldDxNYWx3YXJlU2Nhbm5lclNlcnZpY2U+KFRZUEVTLk1hbHdhcmVTY2FubmVyU2VydmljZSkpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXQgYmVoYXZpb3JTZXJ2aWNlKCk6IFVzZXJCZWhhdmlvclNlcnZpY2Uge1xuICAgIHJldHVybiBjb250YWluZXIuZ2V0PFVzZXJCZWhhdmlvclNlcnZpY2U+KFVzZXJCZWhhdmlvclNlcnZpY2UpO1xuICB9XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5pbml0aWFsaXplVXBsb2FkRGlyKCk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGluaXRpYWxpemVVcGxvYWREaXIoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGZzLm1rZGlyKHRoaXMudXBsb2FkRGlyLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcbiAgICAgIGxvZ2dlci5pbmZvKCdVcGxvYWQgZGlyZWN0b3J5IGluaXRpYWxpemVkJyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignRmFpbGVkIHRvIGluaXRpYWxpemUgdXBsb2FkIGRpcmVjdG9yeTonLCBlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIE11bHRlciBjb25maWd1cmF0aW9uIGZvciBmaWxlIHVwbG9hZHNcbiAgICovXG4gIHB1YmxpYyBnZXRNdWx0ZXJDb25maWcoKSB7XG4gICAgY29uc3Qgc3RvcmFnZSA9IG11bHRlci5kaXNrU3RvcmFnZSh7XG4gICAgICBkZXN0aW5hdGlvbjogKHJlcSwgZmlsZSwgY2IpID0+IHtcbiAgICAgICAgY2IobnVsbCwgdGhpcy51cGxvYWREaXIpO1xuICAgICAgfSxcbiAgICAgIGZpbGVuYW1lOiAocmVxLCBmaWxlLCBjYikgPT4ge1xuICAgICAgICBjb25zdCB1bmlxdWVTdWZmaXggPSBEYXRlLm5vdygpICsgJy0nICsgTWF0aC5yb3VuZChNYXRoLnJhbmRvbSgpICogMWU5KTtcbiAgICAgICAgY29uc3QgZXh0ID0gcGF0aC5leHRuYW1lKGZpbGUub3JpZ2luYWxuYW1lKTtcbiAgICAgICAgY2IobnVsbCwgYCR7ZmlsZS5maWVsZG5hbWV9LSR7dW5pcXVlU3VmZml4fSR7ZXh0fWApO1xuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGNvbnN0IGZpbGVGaWx0ZXIgPSAocmVxOiBhbnksIGZpbGU6IGFueSwgY2I6IGFueSkgPT4ge1xuICAgICAgLy8gQ2hlY2sgZmlsZSBzaXplIGxpbWl0IGZyb20gY29uZmlnXG4gICAgICBpZiAoZmlsZS5zaXplID4gbWFsd2FyZVNjYW5uZXJDb25maWcubWF4RmlsZVNpemUpIHtcbiAgICAgICAgcmV0dXJuIGNiKFxuICAgICAgICAgIG5ldyBFcnJvcihcbiAgICAgICAgICAgIGBGaWxlIHNpemUgZXhjZWVkcyAke21hbHdhcmVTY2FubmVyQ29uZmlnLm1heEZpbGVTaXplIC8gKDEwMjQgKiAxMDI0KX1NQiBsaW1pdGAsXG4gICAgICAgICAgKSxcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgLy8gQ2hlY2sgYWxsb3dlZCBNSU1FIHR5cGVzIGZyb20gY29uZmlnXG4gICAgICBpZiAobWFsd2FyZVNjYW5uZXJDb25maWcuYWxsb3dlZE1pbWVUeXBlcy5pbmNsdWRlcyhmaWxlLm1pbWV0eXBlKSkge1xuICAgICAgICBjYihudWxsLCB0cnVlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNiKG5ldyBFcnJvcihgRmlsZSB0eXBlICR7ZmlsZS5taW1ldHlwZX0gaXMgbm90IGFsbG93ZWRgKSk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIHJldHVybiBtdWx0ZXIoe1xuICAgICAgc3RvcmFnZSxcbiAgICAgIGZpbGVGaWx0ZXIsXG4gICAgICBsaW1pdHM6IHtcbiAgICAgICAgZmlsZVNpemU6IG1hbHdhcmVTY2FubmVyQ29uZmlnLm1heEZpbGVTaXplLFxuICAgICAgICBmaWxlczogbWFsd2FyZVNjYW5uZXJDb25maWcubWF4RmlsZXMsXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIE1pZGRsZXdhcmUgdG8gc2NhbiB1cGxvYWRlZCBmaWxlc1xuICAgKi9cbiAgcHVibGljIHNjYW5GaWxlcyA9IGFzeW5jIChyZXE6IGFueSwgcmVzOiBhbnksIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xuICAgIGNvbnN0IGZpbGVzID0gcmVxLmZpbGVzO1xuICAgIGlmICghZmlsZXMgfHwgIUFycmF5LmlzQXJyYXkoZmlsZXMpIHx8IGZpbGVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICB9XG5cbiAgICBjb25zdCBzY2FuUmVzdWx0czogRmlsZVNjYW5SZXN1bHRbXSA9IFtdO1xuICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyPy5pZDtcblxuICAgIHRyeSB7XG4gICAgICAvLyBTY2FuIGVhY2ggZmlsZVxuICAgICAgZm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7XG4gICAgICAgIGxvZ2dlci5pbmZvKCdTY2FubmluZyB1cGxvYWRlZCBmaWxlJywge1xuICAgICAgICAgIGZpbGVuYW1lOiBmaWxlLmZpbGVuYW1lLFxuICAgICAgICAgIG9yaWdpbmFsbmFtZTogZmlsZS5vcmlnaW5hbG5hbWUsXG4gICAgICAgICAgc2l6ZTogZmlsZS5zaXplLFxuICAgICAgICAgIG1pbWV0eXBlOiBmaWxlLm1pbWV0eXBlLFxuICAgICAgICB9KTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IHNjYW5SZXN1bHQgPSBhd2FpdCB0aGlzLnNjYW5uZXIuc2NhbkZpbGUoZmlsZS5wYXRoLCB1c2VySWQpO1xuXG4gICAgICAgICAgY29uc3QgZmlsZVNjYW5SZXN1bHQ6IEZpbGVTY2FuUmVzdWx0ID0ge1xuICAgICAgICAgICAgb3JpZ2luYWxuYW1lOiBmaWxlLm9yaWdpbmFsbmFtZSxcbiAgICAgICAgICAgIGZpbGVuYW1lOiBmaWxlLmZpbGVuYW1lLFxuICAgICAgICAgICAgcGF0aDogZmlsZS5wYXRoLFxuICAgICAgICAgICAgc2l6ZTogZmlsZS5zaXplLFxuICAgICAgICAgICAgbWltZXR5cGU6IGZpbGUubWltZXR5cGUsXG4gICAgICAgICAgICBzY2FuUmVzdWx0LFxuICAgICAgICAgICAgaXNDbGVhbjogIXNjYW5SZXN1bHQuaXNJbmZlY3RlZCxcbiAgICAgICAgICB9O1xuXG4gICAgICAgICAgc2NhblJlc3VsdHMucHVzaChmaWxlU2NhblJlc3VsdCk7XG5cbiAgICAgICAgICAvLyBJZiBmaWxlIGlzIGluZmVjdGVkLCByZW1vdmUgaXQgZnJvbSB1cGxvYWRzXG4gICAgICAgICAgaWYgKHNjYW5SZXN1bHQuaXNJbmZlY3RlZCkge1xuICAgICAgICAgICAgLy8gVHJhY2sgdGhyZWF0IGV2ZW50XG4gICAgICAgICAgICBpZiAodXNlcklkKSB7XG4gICAgICAgICAgICAgIGF3YWl0IHRoaXMuYmVoYXZpb3JTZXJ2aWNlLnRyYWNrVGhyZWF0KFxuICAgICAgICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICAgICAgICBmaWxlLm9yaWdpbmFsbmFtZSxcbiAgICAgICAgICAgICAgICBzY2FuUmVzdWx0LnRocmVhdHMsXG4gICAgICAgICAgICAgICAgdGhpcy5nZXRDbGllbnRJUChyZXEpLFxuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICBhd2FpdCBmcy51bmxpbmsoZmlsZS5wYXRoKTtcbiAgICAgICAgICAgICAgbG9nZ2VyLndhcm4oJ0luZmVjdGVkIGZpbGUgcmVtb3ZlZCBmcm9tIHVwbG9hZHMnLCB7XG4gICAgICAgICAgICAgICAgZmlsZW5hbWU6IGZpbGUuZmlsZW5hbWUsXG4gICAgICAgICAgICAgICAgdGhyZWF0czogc2NhblJlc3VsdC50aHJlYXRzLFxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKHVubGlua0Vycikge1xuICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byByZW1vdmUgaW5mZWN0ZWQgZmlsZTonLCB1bmxpbmtFcnIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIHNjYW5uaW5nIGZpbGU6Jywge1xuICAgICAgICAgICAgZmlsZW5hbWU6IGZpbGUuZmlsZW5hbWUsXG4gICAgICAgICAgICBlcnJvcixcbiAgICAgICAgICB9KTtcblxuICAgICAgICAgIC8vIFJlbW92ZSBmaWxlIGlmIHNjYW4gZmFpbGVkXG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IGZzLnVubGluayhmaWxlLnBhdGgpO1xuICAgICAgICAgIH0gY2F0Y2ggKHVubGlua0Vycikge1xuICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gcmVtb3ZlIGZpbGUgYWZ0ZXIgc2NhbiBlcnJvcjonLCB1bmxpbmtFcnIpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICAgIGVycm9yOiAnRmlsZSBzY2FuIGZhaWxlZCcsXG4gICAgICAgICAgICBkZXRhaWxzOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJyxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBpZiBhbnkgZmlsZXMgd2VyZSBpbmZlY3RlZFxuICAgICAgY29uc3QgaW5mZWN0ZWRGaWxlcyA9IHNjYW5SZXN1bHRzLmZpbHRlcihyZXN1bHQgPT4gIXJlc3VsdC5pc0NsZWFuKTtcblxuICAgICAgaWYgKGluZmVjdGVkRmlsZXMubGVuZ3RoID4gMCkge1xuICAgICAgICBsb2dnZXIud2FybignTWFsd2FyZSBkZXRlY3RlZCBpbiB1cGxvYWRlZCBmaWxlcywgY2xlYW5pbmcgdXAgYWxsIGZpbGVzIGluIHJlcXVlc3QnLCB7XG4gICAgICAgICAgdG90YWxGaWxlczogc2NhblJlc3VsdHMubGVuZ3RoLFxuICAgICAgICAgIGluZmVjdGVkRmlsZXM6IGluZmVjdGVkRmlsZXMubGVuZ3RoLFxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBDbGVhbnVwIEFMTCBmaWxlcyBmb3IgdGhpcyByZXF1ZXN0IHRvIHByZXZlbnQgbGVha3NcbiAgICAgICAgZm9yIChjb25zdCBmaWxlSXRlbSBvZiBmaWxlcykge1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCBmcy51bmxpbmsoZmlsZUl0ZW0ucGF0aCk7XG4gICAgICAgICAgfSBjYXRjaCAodW5saW5rRXJyKSB7XG4gICAgICAgICAgICAvLyBGaWxlIG1pZ2h0IGFscmVhZHkgYmUgdW5saW5rZWQgaWYgaXQgd2FzIHRoZSBpbmZlY3RlZCBvbmVcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MjIpLmpzb24oe1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIGVycm9yOiAnTWFsd2FyZSBkZXRlY3RlZCcsXG4gICAgICAgICAgbWVzc2FnZTogYCR7aW5mZWN0ZWRGaWxlcy5sZW5ndGh9IGZpbGUocykgY29udGFpbmVkIG1hbHdhcmUuIEFsbCB1cGxvYWRlZCBmaWxlcyBmb3IgdGhpcyByZXF1ZXN0IGhhdmUgYmVlbiByZW1vdmVkLmAsXG4gICAgICAgICAgaW5mZWN0ZWRGaWxlczogaW5mZWN0ZWRGaWxlcy5tYXAoZiA9PiAoe1xuICAgICAgICAgICAgb3JpZ2luYWxuYW1lOiBmLm9yaWdpbmFsbmFtZSxcbiAgICAgICAgICAgIHRocmVhdHM6IGYuc2NhblJlc3VsdC50aHJlYXRzLFxuICAgICAgICAgIH0pKSxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIEF0dGFjaCBzY2FuIHJlc3VsdHMgdG8gcmVxdWVzdFxuICAgICAgcmVxLmZpbGVTY2FuUmVzdWx0cyA9IHNjYW5SZXN1bHRzO1xuXG4gICAgICBsb2dnZXIuaW5mbygnQWxsIGZpbGVzIHNjYW5uZWQgc3VjY2Vzc2Z1bGx5Jywge1xuICAgICAgICB0b3RhbEZpbGVzOiBzY2FuUmVzdWx0cy5sZW5ndGgsXG4gICAgICAgIHRvdGFsU2l6ZTogc2NhblJlc3VsdHMucmVkdWNlKChzdW0sIGYpID0+IHN1bSArIGYuc2l6ZSwgMCksXG4gICAgICB9KTtcblxuICAgICAgbmV4dCgpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGluIG1hbHdhcmUgc2NhbiBtaWRkbGV3YXJlOicsIGVycm9yKTtcblxuICAgICAgLy8gQ2xlYW4gdXAgYWxsIGZpbGVzIGlmIG1pZGRsZXdhcmUgZmFpbHNcbiAgICAgIGNvbnN0IHVwbG9hZGVkRmlsZXMgPSByZXEuZmlsZXM7XG4gICAgICBpZiAodXBsb2FkZWRGaWxlcyAmJiBBcnJheS5pc0FycmF5KHVwbG9hZGVkRmlsZXMpKSB7XG4gICAgICAgIGZvciAoY29uc3QgZmlsZUl0ZW0gb2YgdXBsb2FkZWRGaWxlcykge1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCBmcy51bmxpbmsoZmlsZUl0ZW0ucGF0aCk7XG4gICAgICAgICAgfSBjYXRjaCAodW5saW5rRXJyKSB7XG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byBjbGVhbnVwIGZpbGU6JywgdW5saW5rRXJyKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOiAnRmlsZSBzY2FuIHByb2Nlc3MgZmFpbGVkJyxcbiAgICAgICAgZGV0YWlsczogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcicsXG4gICAgICB9KTtcbiAgICB9XG4gIH07XG5cbiAgLyoqXG4gICAqIE1pZGRsZXdhcmUgZm9yIHNpbmdsZSBmaWxlIHVwbG9hZCB3aXRoIHNjYW5uaW5nXG4gICAqL1xuICBwdWJsaWMgdXBsb2FkU2luZ2xlKGZpZWxkOiBzdHJpbmcpIHtcbiAgICBjb25zdCB1cGxvYWQgPSB0aGlzLmdldE11bHRlckNvbmZpZygpLnNpbmdsZShmaWVsZCk7XG5cbiAgICByZXR1cm4gYXN5bmMgKHJlcTogYW55LCByZXM6IGFueSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG4gICAgICAvLyBGaXJzdCwgaGFuZGxlIHRoZSB1cGxvYWRcbiAgICAgIHVwbG9hZChyZXEsIHJlcywgYXN5bmMgZXJyID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIGxvZ2dlci5lcnJvcignRmlsZSB1cGxvYWQgZXJyb3I6JywgZXJyKTtcbiAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgICBlcnJvcjogJ0ZpbGUgdXBsb2FkIGZhaWxlZCcsXG4gICAgICAgICAgICBkZXRhaWxzOiBlcnIubWVzc2FnZSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFRoZW4gc2NhbiB0aGUgZmlsZSBpZiBpdCBleGlzdHNcbiAgICAgICAgY29uc3QgZmlsZSA9IHJlcS5maWxlO1xuICAgICAgICBpZiAoZmlsZSkge1xuICAgICAgICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyPy5pZDtcblxuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBzY2FuUmVzdWx0ID0gYXdhaXQgdGhpcy5zY2FubmVyLnNjYW5GaWxlKGZpbGUucGF0aCwgdXNlcklkKTtcblxuICAgICAgICAgICAgaWYgKHNjYW5SZXN1bHQuaXNJbmZlY3RlZCkge1xuICAgICAgICAgICAgICAvLyBUcmFjayB0aHJlYXQgZXZlbnRcbiAgICAgICAgICAgICAgaWYgKHVzZXJJZCkge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuYmVoYXZpb3JTZXJ2aWNlLnRyYWNrVGhyZWF0KFxuICAgICAgICAgICAgICAgICAgdXNlcklkLFxuICAgICAgICAgICAgICAgICAgZmlsZS5vcmlnaW5hbG5hbWUsXG4gICAgICAgICAgICAgICAgICBzY2FuUmVzdWx0LnRocmVhdHMsXG4gICAgICAgICAgICAgICAgICB0aGlzLmdldENsaWVudElQKHJlcSksXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgIC8vIFJlbW92ZSBpbmZlY3RlZCBmaWxlXG4gICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgZnMudW5saW5rKGZpbGUucGF0aCk7XG4gICAgICAgICAgICAgIH0gY2F0Y2ggKHVubGlua0Vycikge1xuICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcignRmFpbGVkIHRvIHJlbW92ZSBpbmZlY3RlZCBmaWxlOicsIHVubGlua0Vycik7XG4gICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MjIpLmpzb24oe1xuICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgICAgICAgIGVycm9yOiAnTWFsd2FyZSBkZXRlY3RlZCcsXG4gICAgICAgICAgICAgICAgbWVzc2FnZTogJ1VwbG9hZGVkIGZpbGUgY29udGFpbnMgbWFsd2FyZSBhbmQgd2FzIHJlbW92ZWQnLFxuICAgICAgICAgICAgICAgIHRocmVhdHM6IHNjYW5SZXN1bHQudGhyZWF0cyxcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIEF0dGFjaCBzY2FuIHJlc3VsdFxuICAgICAgICAgICAgcmVxLmZpbGVTY2FuUmVzdWx0ID0gc2NhblJlc3VsdDtcbiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCdGaWxlIHNjYW5uZWQgc3VjY2Vzc2Z1bGx5Jywge1xuICAgICAgICAgICAgICBmaWxlbmFtZTogZmlsZS5maWxlbmFtZSxcbiAgICAgICAgICAgICAgc2NhblRpbWU6IHNjYW5SZXN1bHQuc2NhblRpbWUsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCdFcnJvciBzY2FubmluZyB1cGxvYWRlZCBmaWxlOicsIGVycm9yKTtcblxuICAgICAgICAgICAgLy8gUmVtb3ZlIGZpbGUgaWYgc2NhbiBmYWlsZWRcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgIGlmIChmaWxlKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgZnMudW5saW5rKGZpbGUucGF0aCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gY2F0Y2ggKHVubGlua0Vycikge1xuICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byByZW1vdmUgZmlsZSBhZnRlciBzY2FuIGVycm9yOicsIHVubGlua0Vycik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgICAgICBlcnJvcjogJ0ZpbGUgc2NhbiBmYWlsZWQnLFxuICAgICAgICAgICAgICBkZXRhaWxzOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJyxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIG5leHQoKTtcbiAgICAgIH0pO1xuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogTWlkZGxld2FyZSBmb3IgbXVsdGlwbGUgZmlsZSB1cGxvYWQgd2l0aCBzY2FubmluZ1xuICAgKi9cbiAgcHVibGljIHVwbG9hZE11bHRpcGxlKGZpZWxkOiBzdHJpbmcsIG1heENvdW50OiBudW1iZXIgPSA1KSB7XG4gICAgY29uc3QgdXBsb2FkID0gdGhpcy5nZXRNdWx0ZXJDb25maWcoKS5hcnJheShmaWVsZCwgbWF4Q291bnQpO1xuXG4gICAgcmV0dXJuIGFzeW5jIChyZXE6IGFueSwgcmVzOiBhbnksIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xuICAgICAgLy8gRmlyc3QsIGhhbmRsZSB0aGUgdXBsb2FkXG4gICAgICB1cGxvYWQocmVxLCByZXMsIGFzeW5jIGVyciA9PiB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICBsb2dnZXIuZXJyb3IoJ0ZpbGUgdXBsb2FkIGVycm9yOicsIGVycik7XG4gICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgICAgZXJyb3I6ICdGaWxlIHVwbG9hZCBmYWlsZWQnLFxuICAgICAgICAgICAgZGV0YWlsczogZXJyLm1lc3NhZ2UsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBUaGVuIHNjYW4gZmlsZXMgdXNpbmcgdGhlIHNjYW5GaWxlcyBtaWRkbGV3YXJlXG4gICAgICAgIHRoaXMuc2NhbkZpbGVzKHJlcSwgcmVzLCBuZXh0KTtcbiAgICAgIH0pO1xuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogR2V0IHNjYW5uZXIgc3RhdGlzdGljc1xuICAgKi9cbiAgcHVibGljIGdldFNjYW5uZXJTdGF0cygpIHtcbiAgICByZXR1cm4gdGhpcy5zY2FubmVyLmdldFNjYW5TdGF0cygpO1xuICB9XG5cbiAgLyoqXG4gICAqIENsZWFyIHNjYW5uZXIgY2FjaGVcbiAgICovXG4gIHB1YmxpYyBjbGVhckNhY2hlKCkge1xuICAgIHRoaXMuc2Nhbm5lci5jbGVhckNhY2hlKCk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGNsaWVudCBJUCBhZGRyZXNzXG4gICAqL1xuICBwcml2YXRlIGdldENsaWVudElQKHJlcTogYW55KTogc3RyaW5nIHtcbiAgICByZXR1cm4gcmVxLmlwIHx8IHJlcS5jb25uZWN0aW9uPy5yZW1vdGVBZGRyZXNzIHx8IHJlcS5zb2NrZXQ/LnJlbW90ZUFkZHJlc3MgfHwgJ3Vua25vd24nO1xuICB9XG59XG5cbi8vIEV4cG9ydCBzaW5nbGV0b24gaW5zdGFuY2VcbmV4cG9ydCBjb25zdCBtYWx3YXJlU2Nhbm5lciA9IG5ldyBNYWx3YXJlU2Nhbm5lck1pZGRsZXdhcmUoKTtcblxuLy8gRXhwb3J0IGNvbnZlbmllbmNlIG1ldGhvZHNcbmV4cG9ydCBjb25zdCB1cGxvYWRTaW5nbGUgPSAoZmllbGQ6IHN0cmluZykgPT4gbWFsd2FyZVNjYW5uZXIudXBsb2FkU2luZ2xlKGZpZWxkKTtcbmV4cG9ydCBjb25zdCB1cGxvYWRNdWx0aXBsZSA9IChmaWVsZDogc3RyaW5nLCBtYXhDb3VudD86IG51bWJlcikgPT5cbiAgbWFsd2FyZVNjYW5uZXIudXBsb2FkTXVsdGlwbGUoZmllbGQsIG1heENvdW50KTtcbmV4cG9ydCBjb25zdCBzY2FuVXBsb2FkZWRGaWxlcyA9IG1hbHdhcmVTY2FubmVyLnNjYW5GaWxlcztcbiJdLCJ2ZXJzaW9uIjozfQ==