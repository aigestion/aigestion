{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\app.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\app.ts"],"sourcesContent":["import compression from 'compression';\nimport cookieParser from 'cookie-parser';\nimport cors from 'cors';\nimport express from 'express';\nimport rateLimit from 'express-rate-limit';\nimport type { Request, Response } from 'express';\nimport helmet from 'helmet';\nimport hpp from 'hpp';\nimport morgan from 'morgan';\nimport RateLimitRedisStore from 'rate-limit-redis';\n// @ts-ignore\n// import responseTime from 'response-time';\nimport xssClean from 'xss-clean';\n\n// Middleware to ensure every JSON response follows the standard API for\nimport { config } from './config/config';\nimport { setupSwagger } from './docs/swagger';\nimport { createGraphQLRouter } from './graphql/router';\nimport { errorHandler, notFoundHandler } from './middleware/error.middleware';\nimport { requestIdMiddleware } from './middleware/requestId.middleware';\nimport routes from './routes';\nimport mcpRouter from './routes/mcp.routes';\nimport { logger } from './utils/logger';\n\nimport { buildResponse } from './common/response-builder';\nimport { cdnCache } from './middleware/cdn-cache.middleware';\nimport getRedisClient from './utils/redis';\n\nconst app = express();\n\n// Request Traceability\napp.use(requestIdMiddleware);\n\n// Security Middleware\napp.use(\n  helmet({\n    contentSecurityPolicy: {\n      directives: {\n        defaultSrc: [\"'self'\"],\n        scriptSrc: [\"'self'\", \"'unsafe-inline'\"],\n        styleSrc: [\"'self'\", \"'unsafe-inline'\"],\n        imgSrc: [\"'self'\", 'data:', 'https:'],\n        connectSrc: [\"'self'\", 'ws:', 'wss:'],\n      },\n    },\n  }),\n);\napp.use(\n  cors({\n    origin: (\n      origin: string | undefined,\n      callback: (err: Error | null, allow?: boolean) => void,\n    ) => {\n      const allowedOrigins = config.cors.origin;\n      const isAllowed =\n        !origin ||\n        allowedOrigins === '*' ||\n        (Array.isArray(allowedOrigins) && allowedOrigins.includes(origin));\n\n      if (isAllowed) {\n        callback(null, true);\n      } else {\n        callback(new Error('Not allowed by CORS'));\n      }\n    },\n    credentials: true,\n  }),\n);\n\n// Rate limiting middleware (15 min window, 100 requests per IP)\nconst isTest = process.env.NODE_ENV === 'test' || !!process.env.JEST_WORKER_ID;\n\n// Redis client for rate limiting store (Reusing unified client)\nlet redisClient: any;\nif (!isTest) {\n  // getRedisClient handles connection internally or returns existing one\n  redisClient = getRedisClient();\n}\n\nconst useRedis = !isTest && process.env.ENABLE_REDIS !== 'false';\n\nconst apiLimiter = rateLimit({\n  store: !useRedis\n    ? undefined // Use default MemoryStore for tests or if Redis is disabled\n    : new RateLimitRedisStore({\n        sendCommand: (...args) => redisClient.sendCommand(args),\n      }),\n  windowMs: 15 * 60 * 1000,\n  max: config.rateLimit.max,\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\n// Apply rate limiter to all API routes\nif (!isTest) {\n  app.use('/api/v1', apiLimiter);\n}\n\n// Security middlewares\napp.use(hpp() as any);\napp.use(xssClean() as any);\n\n// app.use(responseTime());\n\n// Performance Middleware\napp.use(\n  compression({\n    level: 7, // Slightly higher compression\n    threshold: 512, // Compress smaller payloads for mobile speed\n  }) as any,\n);\n\n// Logging Middleware\napp.use(\n  morgan('combined', {\n    stream: {\n      write: (message: string) => logger.info(message.trim()),\n    },\n    skip: (req: Request) => req.url === '/api/v1/health',\n  }),\n);\n\n// Request Parsing\napp.use(\n  express.json({\n    limit: '10mb',\n    verify: (req: any, _res: Response, buf: Buffer) => {\n      if (req.originalUrl.includes('/stripe/webhook')) {\n        req.rawBody = buf;\n      }\n    },\n  }),\n);\napp.use(cookieParser());\n\n// Mount Routes\nsetupSwagger(app);\n\n// Health checks are now handled in api-v1.routes.ts\napp.use('/api/v1', routes);\napp.use('/mcp', mcpRouter);\napp.use('/graphql', createGraphQLRouter());\n\n// Error handling\napp.use(notFoundHandler);\napp.use(errorHandler);\n\n// Graceful shutdown\nprocess.on('SIGINT', async () => {\n  logger.info('Shutting down gracefully...');\n  await redisClient.disconnect();\n  process.exit(0);\n});\nprocess.on('SIGTERM', async () => {\n  logger.info('Shutting down gracefully...');\n  await redisClient.disconnect();\n  process.exit(0);\n});\n\nexport { app };\n"],"version":3}