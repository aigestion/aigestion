f3c281d8baa06ff34ada74c70cdbf302
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = require("express");
const inversify_config_1 = require("../config/inversify.config");
const User_1 = require("../models/User");
const types_1 = require("../types");
const logger_1 = require("../utils/logger");
const stripeRouter = (0, express_1.Router)();
const stripeService = inversify_config_1.container.get(types_1.TYPES.StripeService);
/**
 * @openapi
 * /api/v1/stripe/checkout:
 *   post:
 *     summary: Create a Stripe Checkout Session
 *     tags: [Stripe]
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             properties:
 *               priceId:
 *                 type: string
 *               successUrl:
 *                 type: string
 *               cancelUrl:
 *                 type: string
 *               userId:
 *                 type: string
 *                 description: Optional user ID for testing
 *     responses:
 *       200:
 *         description: Checkout session created
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 sessionId:
 *                   type: string
 *                 url:
 *                   type: string
 *       400:
 *         description: Validation error
 *       500:
 *         description: Server error
 */
stripeRouter.post('/checkout', async (req, res) => {
    const requestId = req.requestId;
    try {
        const { priceId, successUrl, cancelUrl, userId } = req.body;
        // In a real app, userId comes from auth middleware: (req as any).user.id
        if (!priceId || !successUrl || !cancelUrl) {
            return res
                .status(400)
                .json(buildError('Missing required fields', 'VALIDATION_ERROR', 400, requestId));
        }
        // Default to a test user if auth is missing in this context
        const userToCharge = userId ? await User_1.User.findById(userId) : null;
        // Create customer if needed (simplified logic)
        let customerId = userToCharge?.stripeCustomerId;
        if (userToCharge && !customerId) {
            const customer = await stripeService.createCustomer(userToCharge.email, userToCharge.name);
            customerId = customer.id;
            userToCharge.stripeCustomerId = customerId;
            await userToCharge.save();
        }
        // Fallback for testing without DB
        if (!customerId) {
            // Create a guest customer just for the session if we don't have a user
            // Or throw error in strict mode. For now, we'll assume we need a user.
            return res
                .status(400)
                .json(buildError('User not found or no customer ID', 'USER_ERROR', 400, requestId));
        }
        const session = await stripeService.createSubscriptionCheckoutSession(customerId, priceId, successUrl, cancelUrl);
        return res.json(buildResponse({ sessionId: session.id, url: session.url }, 200, requestId));
    }
    catch (error) {
        logger_1.logger.error(error, 'Checkout session creation failed');
        return res.status(500).json(buildError(error.message, 'STRIPE_ERROR', 500, requestId));
    }
});
/**
 * @openapi
 * /api/v1/stripe/webhook:
 *   post:
 *     summary: Stripe webhook endpoint
 *     tags: [Stripe]
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *     responses:
 *       200:
 *         description: Webhook processed
 *       400:
 *         description: Bad request
 */
stripeRouter.post('/webhook', async (req, res) => {
    const sig = req.headers['stripe-signature'];
    const rawBody = req.rawBody;
    if (!sig || !rawBody) {
        return res.status(400).send('Webhook Error: Missing signature or body');
    }
    try {
        const event = stripeService.constructEvent(rawBody, sig); // Cast req.body to buffer? No, use rawBody string/buffer
        logger_1.logger.info(`Stripe event received: ${event.type}`);
        // Handle the event
        switch (event.type) {
            case 'checkout.session.completed':
                const session = event.data.object;
                logger_1.logger.info(`Checkout session completed for ${session.customer}`);
                // TODO: Update user subscription status
                if (session.customer) {
                    const user = await User_1.User.findOne({ stripeCustomerId: session.customer });
                    if (user) {
                        user.subscriptionStatus = 'active';
                        if (session.subscription) {
                            user.subscriptionId = session.subscription;
                        }
                        await user.save();
                        logger_1.logger.info(`User ${user.email} subscription activated`);
                    }
                }
                break;
            case 'customer.subscription.deleted':
                const subscription = event.data.object;
                const user = await User_1.User.findOne({ subscriptionId: subscription.id });
                if (user) {
                    user.subscriptionStatus = 'canceled';
                    await user.save();
                    logger_1.logger.info(`User ${user.email} subscription canceled`);
                }
                break;
            default:
            // logger.info(`Unhandled event type ${event.type}`);
        }
        return res.json({ received: true });
    }
    catch (err) {
        logger_1.logger.error(`Webhook Error: ${err.message}`);
        return res.status(400).send(`Webhook Error: ${err.message}`);
    }
});
exports.default = stripeRouter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxyb3V0ZXNcXHN0cmlwZS5yb3V0ZXMudHMiLCJtYXBwaW5ncyI6Ijs7QUFBQSxxQ0FBaUM7QUFFakMsaUVBQXVEO0FBQ3ZELHlDQUFzQztBQUV0QyxvQ0FBaUM7QUFDakMsNENBQXlDO0FBRXpDLE1BQU0sWUFBWSxHQUFHLElBQUEsZ0JBQU0sR0FBRSxDQUFDO0FBQzlCLE1BQU0sYUFBYSxHQUFHLDRCQUFTLENBQUMsR0FBRyxDQUFnQixhQUFLLENBQUMsYUFBYSxDQUFDLENBQUM7QUFFeEU7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBc0NHO0FBQ0gsWUFBWSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsS0FBSyxFQUFFLEdBQVEsRUFBRSxHQUFRLEVBQUUsRUFBRTtJQUMxRCxNQUFNLFNBQVMsR0FBRyxHQUFHLENBQUMsU0FBUyxDQUFDO0lBQ2hDLElBQUksQ0FBQztRQUNILE1BQU0sRUFBRSxPQUFPLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBQzVELHlFQUF5RTtRQUV6RSxJQUFJLENBQUMsT0FBTyxJQUFJLENBQUMsVUFBVSxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7WUFDMUMsT0FBTyxHQUFHO2lCQUNQLE1BQU0sQ0FBQyxHQUFHLENBQUM7aUJBQ1gsSUFBSSxDQUFDLFVBQVUsQ0FBQyx5QkFBeUIsRUFBRSxrQkFBa0IsRUFBRSxHQUFHLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQztRQUNyRixDQUFDO1FBRUQsNERBQTREO1FBQzVELE1BQU0sWUFBWSxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsTUFBTSxXQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFFakUsK0NBQStDO1FBQy9DLElBQUksVUFBVSxHQUFHLFlBQVksRUFBRSxnQkFBZ0IsQ0FB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Q0FBQyxDQUFDO0FBRUgsa0JBQWUsWUFBWSxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcQWxlamFuZHJvXFxBSUdlc3Rpb25cXGJhY2tlbmRcXHNyY1xccm91dGVzXFxzdHJpcGUucm91dGVzLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJvdXRlciB9IGZyb20gJ2V4cHJlc3MnO1xuXG5pbXBvcnQgeyBjb250YWluZXIgfSBmcm9tICcuLi9jb25maWcvaW52ZXJzaWZ5LmNvbmZpZyc7XG5pbXBvcnQgeyBVc2VyIH0gZnJvbSAnLi4vbW9kZWxzL1VzZXInO1xuaW1wb3J0IHsgU3RyaXBlU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL3N0cmlwZS5zZXJ2aWNlJztcbmltcG9ydCB7IFRZUEVTIH0gZnJvbSAnLi4vdHlwZXMnO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi4vdXRpbHMvbG9nZ2VyJztcblxuY29uc3Qgc3RyaXBlUm91dGVyID0gUm91dGVyKCk7XG5jb25zdCBzdHJpcGVTZXJ2aWNlID0gY29udGFpbmVyLmdldDxTdHJpcGVTZXJ2aWNlPihUWVBFUy5TdHJpcGVTZXJ2aWNlKTtcblxuLyoqXG4gKiBAb3BlbmFwaVxuICogL2FwaS92MS9zdHJpcGUvY2hlY2tvdXQ6XG4gKiAgIHBvc3Q6XG4gKiAgICAgc3VtbWFyeTogQ3JlYXRlIGEgU3RyaXBlIENoZWNrb3V0IFNlc3Npb25cbiAqICAgICB0YWdzOiBbU3RyaXBlXVxuICogICAgIHJlcXVlc3RCb2R5OlxuICogICAgICAgcmVxdWlyZWQ6IHRydWVcbiAqICAgICAgIGNvbnRlbnQ6XG4gKiAgICAgICAgIGFwcGxpY2F0aW9uL2pzb246XG4gKiAgICAgICAgICAgc2NoZW1hOlxuICogICAgICAgICAgICAgdHlwZTogb2JqZWN0XG4gKiAgICAgICAgICAgICBwcm9wZXJ0aWVzOlxuICogICAgICAgICAgICAgICBwcmljZUlkOlxuICogICAgICAgICAgICAgICAgIHR5cGU6IHN0cmluZ1xuICogICAgICAgICAgICAgICBzdWNjZXNzVXJsOlxuICogICAgICAgICAgICAgICAgIHR5cGU6IHN0cmluZ1xuICogICAgICAgICAgICAgICBjYW5jZWxVcmw6XG4gKiAgICAgICAgICAgICAgICAgdHlwZTogc3RyaW5nXG4gKiAgICAgICAgICAgICAgIHVzZXJJZDpcbiAqICAgICAgICAgICAgICAgICB0eXBlOiBzdHJpbmdcbiAqICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogT3B0aW9uYWwgdXNlciBJRCBmb3IgdGVzdGluZ1xuICogICAgIHJlc3BvbnNlczpcbiAqICAgICAgIDIwMDpcbiAqICAgICAgICAgZGVzY3JpcHRpb246IENoZWNrb3V0IHNlc3Npb24gY3JlYXRlZFxuICogICAgICAgICBjb250ZW50OlxuICogICAgICAgICAgIGFwcGxpY2F0aW9uL2pzb246XG4gKiAgICAgICAgICAgICBzY2hlbWE6XG4gKiAgICAgICAgICAgICAgIHR5cGU6IG9iamVjdFxuICogICAgICAgICAgICAgICBwcm9wZXJ0aWVzOlxuICogICAgICAgICAgICAgICAgIHNlc3Npb25JZDpcbiAqICAgICAgICAgICAgICAgICAgIHR5cGU6IHN0cmluZ1xuICogICAgICAgICAgICAgICAgIHVybDpcbiAqICAgICAgICAgICAgICAgICAgIHR5cGU6IHN0cmluZ1xuICogICAgICAgNDAwOlxuICogICAgICAgICBkZXNjcmlwdGlvbjogVmFsaWRhdGlvbiBlcnJvclxuICogICAgICAgNTAwOlxuICogICAgICAgICBkZXNjcmlwdGlvbjogU2VydmVyIGVycm9yXG4gKi9cbnN0cmlwZVJvdXRlci5wb3N0KCcvY2hlY2tvdXQnLCBhc3luYyAocmVxOiBhbnksIHJlczogYW55KSA9PiB7XG4gIGNvbnN0IHJlcXVlc3RJZCA9IHJlcS5yZXF1ZXN0SWQ7XG4gIHRyeSB7XG4gICAgY29uc3QgeyBwcmljZUlkLCBzdWNjZXNzVXJsLCBjYW5jZWxVcmwsIHVzZXJJZCB9ID0gcmVxLmJvZHk7XG4gICAgLy8gSW4gYSByZWFsIGFwcCwgdXNlcklkIGNvbWVzIGZyb20gYXV0aCBtaWRkbGV3YXJlOiAocmVxIGFzIGFueSkudXNlci5pZFxuXG4gICAgaWYgKCFwcmljZUlkIHx8ICFzdWNjZXNzVXJsIHx8ICFjYW5jZWxVcmwpIHtcbiAgICAgIHJldHVybiByZXNcbiAgICAgICAgLnN0YXR1cyg0MDApXG4gICAgICAgIC5qc29uKGJ1aWxkRXJyb3IoJ01pc3NpbmcgcmVxdWlyZWQgZmllbGRzJywgJ1ZBTElEQVRJT05fRVJST1InLCA0MDAsIHJlcXVlc3RJZCkpO1xuICAgIH1cblxuICAgIC8vIERlZmF1bHQgdG8gYSB0ZXN0IHVzZXIgaWYgYXV0aCBpcyBtaXNzaW5nIGluIHRoaXMgY29udGV4dFxuICAgIGNvbnN0IHVzZXJUb0NoYXJnZSA9IHVzZXJJZCA/IGF3YWl0IFVzZXIuZmluZEJ5SWQodXNlcklkKSA6IG51bGw7XG5cbiAgICAvLyBDcmVhdGUgY3VzdG9tZXIgaWYgbmVlZGVkIChzaW1wbGlmaWVkIGxvZ2ljKVxuICAgIGxldCBjdXN0b21lcklkID0gdXNlclRvQ2hhcmdlPy5zdHJpcGVDdXN0b21lcklkO1xuICAgIGlmICh1c2VyVG9DaGFyZ2UgJiYgIWN1c3RvbWVySWQpIHtcbiAgICAgIGNvbnN0IGN1c3RvbWVyID0gYXdhaXQgc3RyaXBlU2VydmljZS5jcmVhdGVDdXN0b21lcih1c2VyVG9DaGFyZ2UuZW1haWwsIHVzZXJUb0NoYXJnZS5uYW1lKTtcbiAgICAgIGN1c3RvbWVySWQgPSBjdXN0b21lci5pZDtcbiAgICAgIHVzZXJUb0NoYXJnZS5zdHJpcGVDdXN0b21lcklkID0gY3VzdG9tZXJJZDtcbiAgICAgIGF3YWl0IHVzZXJUb0NoYXJnZS5zYXZlKCk7XG4gICAgfVxuXG4gICAgLy8gRmFsbGJhY2sgZm9yIHRlc3Rpbmcgd2l0aG91dCBEQlxuICAgIGlmICghY3VzdG9tZXJJZCkge1xuICAgICAgLy8gQ3JlYXRlIGEgZ3Vlc3QgY3VzdG9tZXIganVzdCBmb3IgdGhlIHNlc3Npb24gaWYgd2UgZG9uJ3QgaGF2ZSBhIHVzZXJcbiAgICAgIC8vIE9yIHRocm93IGVycm9yIGluIHN0cmljdCBtb2RlLiBGb3Igbm93LCB3ZSdsbCBhc3N1bWUgd2UgbmVlZCBhIHVzZXIuXG4gICAgICByZXR1cm4gcmVzXG4gICAgICAgIC5zdGF0dXMoNDAwKVxuICAgICAgICAuanNvbihidWlsZEVycm9yKCdVc2VyIG5vdCBmb3VuZCBvciBubyBjdXN0b21lciBJRCcsICdVU0VSX0VSUk9SJywgNDAwLCByZXF1ZXN0SWQpKTtcbiAgICB9XG5cbiAgICBjb25zdCBzZXNzaW9uID0gYXdhaXQgc3RyaXBlU2VydmljZS5jcmVhdGVTdWJzY3JpcHRpb25DaGVja291dFNlc3Npb24oXG4gICAgICBjdXN0b21lcklkLFxuICAgICAgcHJpY2VJZCxcbiAgICAgIHN1Y2Nlc3NVcmwsXG4gICAgICBjYW5jZWxVcmwsXG4gICAgKTtcblxuICAgIHJldHVybiByZXMuanNvbihidWlsZFJlc3BvbnNlKHsgc2Vzc2lvbklkOiBzZXNzaW9uLmlkLCB1cmw6IHNlc3Npb24udXJsIH0sIDIwMCwgcmVxdWVzdElkKSk7XG4gIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICBsb2dnZXIuZXJyb3IoZXJyb3IsICdDaGVja291dCBzZXNzaW9uIGNyZWF0aW9uIGZhaWxlZCcpO1xuICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbihidWlsZEVycm9yKGVycm9yLm1lc3NhZ2UsICdTVFJJUEVfRVJST1InLCA1MDAsIHJlcXVlc3RJZCkpO1xuICB9XG59KTtcblxuLyoqXG4gKiBAb3BlbmFwaVxuICogL2FwaS92MS9zdHJpcGUvd2ViaG9vazpcbiAqICAgcG9zdDpcbiAqICAgICBzdW1tYXJ5OiBTdHJpcGUgd2ViaG9vayBlbmRwb2ludFxuICogICAgIHRhZ3M6IFtTdHJpcGVdXG4gKiAgICAgcmVxdWVzdEJvZHk6XG4gKiAgICAgICByZXF1aXJlZDogdHJ1ZVxuICogICAgICAgY29udGVudDpcbiAqICAgICAgICAgYXBwbGljYXRpb24vanNvbjpcbiAqICAgICAgICAgICBzY2hlbWE6XG4gKiAgICAgICAgICAgICB0eXBlOiBvYmplY3RcbiAqICAgICByZXNwb25zZXM6XG4gKiAgICAgICAyMDA6XG4gKiAgICAgICAgIGRlc2NyaXB0aW9uOiBXZWJob29rIHByb2Nlc3NlZFxuICogICAgICAgNDAwOlxuICogICAgICAgICBkZXNjcmlwdGlvbjogQmFkIHJlcXVlc3RcbiAqL1xuc3RyaXBlUm91dGVyLnBvc3QoJy93ZWJob29rJywgYXN5bmMgKHJlcTogYW55LCByZXM6IGFueSkgPT4ge1xuICBjb25zdCBzaWcgPSByZXEuaGVhZGVyc1snc3RyaXBlLXNpZ25hdHVyZSddO1xuICBjb25zdCByYXdCb2R5ID0gcmVxLnJhd0JvZHk7XG5cbiAgaWYgKCFzaWcgfHwgIXJhd0JvZHkpIHtcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLnNlbmQoJ1dlYmhvb2sgRXJyb3I6IE1pc3Npbmcgc2lnbmF0dXJlIG9yIGJvZHknKTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgY29uc3QgZXZlbnQgPSBzdHJpcGVTZXJ2aWNlLmNvbnN0cnVjdEV2ZW50KHJhd0JvZHksIHNpZyBhcyBzdHJpbmcpOyAvLyBDYXN0IHJlcS5ib2R5IHRvIGJ1ZmZlcj8gTm8sIHVzZSByYXdCb2R5IHN0cmluZy9idWZmZXJcblxuICAgIGxvZ2dlci5pbmZvKGBTdHJpcGUgZXZlbnQgcmVjZWl2ZWQ6ICR7ZXZlbnQudHlwZX1gKTtcblxuICAgIC8vIEhhbmRsZSB0aGUgZXZlbnRcbiAgICBzd2l0Y2ggKGV2ZW50LnR5cGUpIHtcbiAgICAgIGNhc2UgJ2NoZWNrb3V0LnNlc3Npb24uY29tcGxldGVkJzpcbiAgICAgICAgY29uc3Qgc2Vzc2lvbiA9IGV2ZW50LmRhdGEub2JqZWN0IGFzIGFueTtcbiAgICAgICAgbG9nZ2VyLmluZm8oYENoZWNrb3V0IHNlc3Npb24gY29tcGxldGVkIGZvciAke3Nlc3Npb24uY3VzdG9tZXJ9YCk7XG4gICAgICAgIC8vIFRPRE86IFVwZGF0ZSB1c2VyIHN1YnNjcmlwdGlvbiBzdGF0dXNcbiAgICAgICAgaWYgKHNlc3Npb24uY3VzdG9tZXIpIHtcbiAgICAgICAgICBjb25zdCB1c2VyID0gYXdhaXQgVXNlci5maW5kT25lKHsgc3RyaXBlQ3VzdG9tZXJJZDogc2Vzc2lvbi5jdXN0b21lciB9KTtcbiAgICAgICAgICBpZiAodXNlcikge1xuICAgICAgICAgICAgdXNlci5zdWJzY3JpcHRpb25TdGF0dXMgPSAnYWN0aXZlJztcbiAgICAgICAgICAgIGlmIChzZXNzaW9uLnN1YnNjcmlwdGlvbikge1xuICAgICAgICAgICAgICB1c2VyLnN1YnNjcmlwdGlvbklkID0gc2Vzc2lvbi5zdWJzY3JpcHRpb24gYXMgc3RyaW5nO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYXdhaXQgdXNlci5zYXZlKCk7XG4gICAgICAgICAgICBsb2dnZXIuaW5mbyhgVXNlciAke3VzZXIuZW1haWx9IHN1YnNjcmlwdGlvbiBhY3RpdmF0ZWRgKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgJ2N1c3RvbWVyLnN1YnNjcmlwdGlvbi5kZWxldGVkJzpcbiAgICAgICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gZXZlbnQuZGF0YS5vYmplY3QgYXMgYW55O1xuICAgICAgICBjb25zdCB1c2VyID0gYXdhaXQgVXNlci5maW5kT25lKHsgc3Vic2NyaXB0aW9uSWQ6IHN1YnNjcmlwdGlvbi5pZCB9KTtcbiAgICAgICAgaWYgKHVzZXIpIHtcbiAgICAgICAgICB1c2VyLnN1YnNjcmlwdGlvblN0YXR1cyA9ICdjYW5jZWxlZCc7XG4gICAgICAgICAgYXdhaXQgdXNlci5zYXZlKCk7XG4gICAgICAgICAgbG9nZ2VyLmluZm8oYFVzZXIgJHt1c2VyLmVtYWlsfSBzdWJzY3JpcHRpb24gY2FuY2VsZWRgKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcblxuICAgICAgZGVmYXVsdDpcbiAgICAgIC8vIGxvZ2dlci5pbmZvKGBVbmhhbmRsZWQgZXZlbnQgdHlwZSAke2V2ZW50LnR5cGV9YCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlcy5qc29uKHsgcmVjZWl2ZWQ6IHRydWUgfSk7XG4gIH0gY2F0Y2ggKGVycjogYW55KSB7XG4gICAgbG9nZ2VyLmVycm9yKGBXZWJob29rIEVycm9yOiAke2Vyci5tZXNzYWdlfWApO1xuICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuc2VuZChgV2ViaG9vayBFcnJvcjogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxufSk7XG5cbmV4cG9ydCBkZWZhdWx0IHN0cmlwZVJvdXRlcjtcbiJdLCJ2ZXJzaW9uIjozfQ==