{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\middleware\\rateLimiter.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\middleware\\rateLimiter.ts"],"sourcesContent":["import rateLimit from 'express-rate-limit';\nimport type { NextFunction, Request, Response } from 'express';\nimport RedisStore from 'rate-limit-redis';\n\nimport { getRedisClient } from '../cache/redis';\nimport { config } from '../config/index';\nimport { logger } from '../utils/logger';\n\n// User role type from auth context\ninterface AuthenticatedRequest extends Request {\n  user?: {\n    id: string;\n    email: string;\n    role: 'guest' | 'authenticated' | 'premium' | 'admin';\n  };\n}\n\n/**\n * Create a rate limiter with memory store\n * (Redis disabled for local development - use memory store always)\n */\nconst createRateLimiter = (\n  windowMs: number,\n  max: number,\n  message = 'Too many requests, please try again later.',\n) => {\n  // Use memory store for development (simpler, no Redis dependency)\n  // In production, Redis store can be enabled via environment variable\n  const useRedis = process.env.USE_REDIS_RATE_LIMIT === 'true';\n\n  let store;\n  if (useRedis) {\n    try {\n      const redisClient = getRedisClient();\n      if (redisClient && redisClient.isOpen) {\n        store = new RedisStore({\n          sendCommand: (...args: string[]) => redisClient.sendCommand(args),\n          prefix: 'rl:',\n        });\n        logger.info('Rate limiter using Redis store');\n      }\n    } catch (error) {\n      logger.warn('Redis not available, using memory store for rate limiting');\n    }\n  }\n\n  if (!store) {\n    logger.info('Rate limiter using memory store (local development mode)');\n  }\n\n  return rateLimit({\n    windowMs,\n    max,\n    message,\n    standardHeaders: true,\n    legacyHeaders: false,\n    store, // undefined = memory store\n    skipSuccessfulRequests: false,\n    skipFailedRequests: false,\n    skip: () => process.env.NODE_ENV === 'test' || !!process.env.JEST_WORKER_ID,\n    keyGenerator: (req: any) => {\n      const authReq = req as AuthenticatedRequest;\n      return authReq.user?.id || req.ip || 'unknown';\n    },\n  });\n};\n\n/**\n * General API rate limiter\n * Default: 100 requests per 15 minutes\n */\nexport const generalLimiter = createRateLimiter(\n  config.rateLimit.windowMs,\n  config.rateLimit.max,\n  'Too many requests from this IP, please try again later.',\n);\n\n/**\n * Strict limiter for sensitive endpoints (auth, admin)\n * 5 requests per 15 minutes\n */\nexport const strictLimiter = createRateLimiter(\n  15 * 60 * 1000, // 15 minutes\n  1000000,\n  'Too many attempts, please try again in 15 minutes.',\n);\n\n/**\n * Auth limiter for login/register endpoints\n * 10 requests per hour to prevent brute force\n */\nexport const authLimiter = createRateLimiter(\n  60 * 60 * 1000, // 1 hour\n  1000000,\n  'Too many authentication attempts, please try again in an hour.',\n);\n\n/**\n * File upload limiter\n * 20 uploads per hour\n */\nexport const uploadLimiter = createRateLimiter(\n  60 * 60 * 1000, // 1 hour\n  1000000,\n  'Upload limit exceeded, please try again later.',\n);\n\n/**\n * AI/Gemini API limiter\n * 30 requests per 10 minutes\n */\nexport const aiLimiter = createRateLimiter(\n  10 * 60 * 1000, // 10 minutes\n  1000000,\n  'AI request limit exceeded, please try again in 10 minutes.',\n);\n\n/**\n * Dynamic rate limiter based on user role\n * - Guest: 30 requests per 15 minutes\n * - Authenticated: 100 requests per 15 minutes\n * - Premium: 300 requests per 15 minutes\n * - Admin: no limit\n */\n// Define limiters per role outside the request handler to persist state\nconst roleLimiters: Record<string, any> = {\n  guest: createRateLimiter(\n    15 * 60 * 1000, // 15 minutes\n    1000000,\n    'Rate limit exceeded for guest users. Please try again later.',\n  ),\n  authenticated: createRateLimiter(\n    15 * 60 * 1000, // 15 minutes\n    1000000,\n    'Rate limit exceeded for authenticated users. Please try again later.',\n  ),\n  premium: createRateLimiter(\n    15 * 60 * 1000, // 15 minutes\n    1000000,\n    'Rate limit exceeded for premium users. Please try again later.',\n  ),\n};\n\nexport const dynamicRoleLimiter = (req: Request, res: Response, next: NextFunction) => {\n  const authReq = req as AuthenticatedRequest;\n  const userRole = authReq.user?.role || 'guest';\n\n  // Admin users bypass rate limiting\n  if (userRole === 'admin') {\n    return next();\n  }\n\n  const limiter = roleLimiters[userRole] || roleLimiters.guest;\n\n  // Apply the limiter and then call next if the limiter didn't end the response\n  return limiter(req, res, (err?: any) => {\n    if (err) {\n      return next(err);\n    }\n    // Call next only if response not already sent by the limiter\n    if (!res.headersSent) {\n      return next();\n    }\n    // otherwise do nothing (response already handled)\n  });\n};\n\n/**\n * WebSocket connection rate limiter\n * 10 connections per minute per IP\n */\nexport const websocketLimiter = createRateLimiter(\n  60 * 1000, // 1 minute\n  1000000,\n  'Too many WebSocket connection attempts, please try again later.',\n);\n\nexport default {\n  generalLimiter,\n  strictLimiter,\n  authLimiter,\n  uploadLimiter,\n  aiLimiter,\n  dynamicRoleLimiter,\n  websocketLimiter,\n};\n"],"version":3}