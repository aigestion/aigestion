0b84e502f4e4c8cc527c9c2399d9cfc3
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const globals_1 = require("@jest/globals");
// Mock axios
globals_1.jest.mock('axios');
require("reflect-metadata");
const axios_1 = __importDefault(require("axios"));
const inversify_config_1 = require("../../config/inversify.config");
const env_schema_1 = require("../../config/env.schema");
const mockedAxios = axios_1.default;
describe('Social Media Services', () => {
    beforeEach(() => {
        globals_1.jest.clearAllMocks();
    });
    describe('InstagramService', () => {
        let service;
        beforeEach(() => {
            service = inversify_config_1.container.get(inversify_config_1.TYPES.InstagramService);
            // Mock env vars
            env_schema_1.env.INSTAGRAM_ACCESS_TOKEN = 'test-token';
            env_schema_1.env.INSTAGRAM_BUSINESS_ACCOUNT_ID = 'test-id';
        });
        it('should send DM', async () => {
            mockedAxios.post.mockResolvedValueOnce({ data: { success: true } });
            const result = await service.sendDM('recipient', 'message');
            expect(result).toEqual({ success: true });
            expect(mockedAxios.post).toHaveBeenCalledWith(expect.stringContaining('/messages'), expect.objectContaining({
                recipient: { id: 'recipient' },
                message: { text: 'message' },
            }), expect.anything());
        });
        it('should publish photo', async () => {
            // Mock container creation
            mockedAxios.post.mockResolvedValueOnce({ data: { id: 'container-id' } });
            // Mock publish
            mockedAxios.post.mockResolvedValueOnce({ data: { id: 'media-id' } });
            const result = await service.publishPhoto('http://image.jpg', 'caption');
            expect(result).toBe('media-id');
            expect(mockedAxios.post).toHaveBeenCalledTimes(2);
        });
    });
    describe('LinkedInService', () => {
        let service;
        beforeEach(() => {
            service = inversify_config_1.container.get(inversify_config_1.TYPES.LinkedInService);
            env_schema_1.env.LINKEDIN_ACCESS_TOKEN = 'test-token';
            env_schema_1.env.LINKEDIN_ORGANIZATION_URN = '12345';
        });
        it('should share post', async () => {
            mockedAxios.post.mockResolvedValueOnce({ data: { id: 'urn:li:share:123' } });
            const result = await service.sharePost('Hello LinkedIn');
            expect(result.id).toBe('urn:li:share:123');
            expect(mockedAxios.post).toHaveBeenCalledWith(expect.stringContaining('/ugcPosts'), expect.objectContaining({
                author: 'urn:li:organization:12345',
                specificContent: expect.objectContaining({
                    'com.linkedin.ugc.ShareContent': expect.objectContaining({
                        shareCommentary: { text: 'Hello LinkedIn' },
                    }),
                }),
            }), expect.anything());
        });
    });
    describe('TikTokService', () => {
        let service;
        beforeEach(() => {
            service = inversify_config_1.container.get(inversify_config_1.TYPES.TikTokService);
            env_schema_1.env.TIKTOK_ACCESS_TOKEN = 'test-token';
        });
        it('should initialize video upload', async () => {
            mockedAxios.post.mockResolvedValueOnce({ data: { data: { upload_url: 'http://upload' } } });
            const result = await service.publishVideo('http://video.mp4', 'Title');
            expect(result).toBeDefined();
            expect(mockedAxios.post).toHaveBeenCalledWith(expect.stringContaining('/post/publish/video/init/'), expect.objectContaining({
                post_info: expect.objectContaining({ title: 'Title' }),
            }), expect.anything());
        });
    });
    describe('XService', () => {
        let service;
        beforeEach(() => {
            service = inversify_config_1.container.get(inversify_config_1.TYPES.XService);
            env_schema_1.env.X_ACCESS_TOKEN = 'test-token';
        });
        it('should post tweet', async () => {
            mockedAxios.post.mockResolvedValueOnce({ data: { data: { id: 'tweet-id' } } });
            const result = await service.postTweet('Hello X');
            expect(result.data.id).toBe('tweet-id');
            expect(mockedAxios.post).toHaveBeenCalledWith(expect.stringContaining('/tweets'), expect.objectContaining({
                text: 'Hello X',
            }), expect.anything());
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxfX3Rlc3RzX19cXHNlcnZpY2VzXFxzb2NpYWwtbWVkaWEudGVzdC50cyIsIm1hcHBpbmdzIjoiOzs7OztBQUVBLDJDQUFxQztBQVVyQyxhQUFhO0FBQ2IsY0FBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztBQWJuQiw0QkFBMEI7QUFHMUIsa0RBQTBCO0FBQzFCLG9FQUFpRTtBQUVqRSx3REFBOEM7QUFROUMsTUFBTSxXQUFXLEdBQUcsZUFBa0MsQ0FBQztBQUV2RCxRQUFRLENBQUMsdUJBQXVCLEVBQUUsR0FBRyxFQUFFO0lBQ3JDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZCxjQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDdkIsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsa0JBQWtCLEVBQUUsR0FBRyxFQUFFO1FBQ2hDLElBQUksT0FBeUIsQ0FBQztRQUU5QixVQUFVLENBQUMsR0FBRyxFQUFFO1lBQ2QsT0FBTyxHQUFHLDRCQUFTLENBQUMsR0FBRyxDQUFtQix3QkFBSyxDQUFDLGdCQUFnQixDQUFDLENBQUM7WUFDbEUsZ0JBQWdCO1lBQ2YsZ0JBQVcsQ0FBQyxzQkFBc0IsR0FBRyxZQUFZLENBQUM7WUFDbEQsZ0JBQVcsQ0FBQyw2QkFBNkIsR0FBRyxTQUFTLENBQUM7UUFDekQsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsZ0JBQWdCLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDOUIsV0FBVyxDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxFQUFFLElBQUksRUFBRSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDcEUsTUFBTSxNQUFNLEdBQUcsTUFBTSxPQUFPLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFBRSxTQUFTLENBQUMsQ0FBQztZQUM1RCxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLEVBQUUsT0FBTyxFQUFF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LElBQUksRUFBRSxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsRUFBRSxVQUFVLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUMvRSxNQUFNLE1BQU0sR0FBRyxNQUFNLE9BQU8sQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDbEQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ3hDLE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsb0JBQW9CLENBQzNDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsRUFDbEMsTUFBTSxDQUFDLGdCQUFnQixDQUFDO2dCQUN0QixJQUFJLEVBQUUsU0FBUzthQUNoQixDQUFDLEVBQ0YsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUNsQixDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcQWxlamFuZHJvXFxBSUdlc3Rpb25cXGJhY2tlbmRcXHNyY1xcX190ZXN0c19fXFxzZXJ2aWNlc1xcc29jaWFsLW1lZGlhLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICdyZWZsZWN0LW1ldGFkYXRhJztcblxuaW1wb3J0IHsgamVzdCB9IGZyb20gJ0BqZXN0L2dsb2JhbHMnO1xuaW1wb3J0IGF4aW9zIGZyb20gJ2F4aW9zJztcbmltcG9ydCB7IGNvbnRhaW5lciwgVFlQRVMgfSBmcm9tICcuLi8uLi9jb25maWcvaW52ZXJzaWZ5LmNvbmZpZyc7XG5cbmltcG9ydCB7IGVudiB9IGZyb20gJy4uLy4uL2NvbmZpZy9lbnYuc2NoZW1hJztcbmltcG9ydCB7IEluc3RhZ3JhbVNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9pbnN0YWdyYW0uc2VydmljZSc7XG5pbXBvcnQgeyBMaW5rZWRJblNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9saW5rZWRpbi5zZXJ2aWNlJztcbmltcG9ydCB7IFRpa1Rva1NlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy90aWt0b2suc2VydmljZSc7XG5pbXBvcnQgeyBYU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3guc2VydmljZSc7XG5cbi8vIE1vY2sgYXhpb3Ncbmplc3QubW9jaygnYXhpb3MnKTtcbmNvbnN0IG1vY2tlZEF4aW9zID0gYXhpb3MgYXMgamVzdC5Nb2NrZWQ8dHlwZW9mIGF4aW9zPjtcblxuZGVzY3JpYmUoJ1NvY2lhbCBNZWRpYSBTZXJ2aWNlcycsICgpID0+IHtcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgamVzdC5jbGVhckFsbE1vY2tzKCk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdJbnN0YWdyYW1TZXJ2aWNlJywgKCkgPT4ge1xuICAgIGxldCBzZXJ2aWNlOiBJbnN0YWdyYW1TZXJ2aWNlO1xuXG4gICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICBzZXJ2aWNlID0gY29udGFpbmVyLmdldDxJbnN0YWdyYW1TZXJ2aWNlPihUWVBFUy5JbnN0YWdyYW1TZXJ2aWNlKTtcbiAgICAgIC8vIE1vY2sgZW52IHZhcnNcbiAgICAgIChlbnYgYXMgYW55KS5JTlNUQUdSQU1fQUNDRVNTX1RPS0VOID0gJ3Rlc3QtdG9rZW4nO1xuICAgICAgKGVudiBhcyBhbnkpLklOU1RBR1JBTV9CVVNJTkVTU19BQ0NPVU5UX0lEID0gJ3Rlc3QtaWQnO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBzZW5kIERNJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbW9ja2VkQXhpb3MucG9zdC5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UoeyBkYXRhOiB7IHN1Y2Nlc3M6IHRydWUgfSB9KTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2Uuc2VuZERNKCdyZWNpcGllbnQnLCAnbWVzc2FnZScpO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbCh7IHN1Y2Nlc3M6IHRydWUgfSk7XG4gICAgICBleHBlY3QobW9ja2VkQXhpb3MucG9zdCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCcvbWVzc2FnZXMnKSxcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIHJlY2lwaWVudDogeyBpZDogJ3JlY2lwaWVudCcgfSxcbiAgICAgICAgICBtZXNzYWdlOiB7IHRleHQ6ICdtZXNzYWdlJyB9LFxuICAgICAgICB9KSxcbiAgICAgICAgZXhwZWN0LmFueXRoaW5nKCksXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBwdWJsaXNoIHBob3RvJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gTW9jayBjb250YWluZXIgY3JlYXRpb25cbiAgICAgIG1vY2tlZEF4aW9zLnBvc3QubW9ja1Jlc29sdmVkVmFsdWVPbmNlKHsgZGF0YTogeyBpZDogJ2NvbnRhaW5lci1pZCcgfSB9KTtcbiAgICAgIC8vIE1vY2sgcHVibGlzaFxuICAgICAgbW9ja2VkQXhpb3MucG9zdC5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UoeyBkYXRhOiB7IGlkOiAnbWVkaWEtaWQnIH0gfSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UucHVibGlzaFBob3RvKCdodHRwOi8vaW1hZ2UuanBnJywgJ2NhcHRpb24nKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoJ21lZGlhLWlkJyk7XG4gICAgICBleHBlY3QobW9ja2VkQXhpb3MucG9zdCkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDIpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnTGlua2VkSW5TZXJ2aWNlJywgKCkgPT4ge1xuICAgIGxldCBzZXJ2aWNlOiBMaW5rZWRJblNlcnZpY2U7XG5cbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgIHNlcnZpY2UgPSBjb250YWluZXIuZ2V0PExpbmtlZEluU2VydmljZT4oVFlQRVMuTGlua2VkSW5TZXJ2aWNlKTtcbiAgICAgIChlbnYgYXMgYW55KS5MSU5LRURJTl9BQ0NFU1NfVE9LRU4gPSAndGVzdC10b2tlbic7XG4gICAgICAoZW52IGFzIGFueSkuTElOS0VESU5fT1JHQU5JWkFUSU9OX1VSTiA9ICcxMjM0NSc7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHNoYXJlIHBvc3QnLCBhc3luYyAoKSA9PiB7XG4gICAgICBtb2NrZWRBeGlvcy5wb3N0Lm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7IGRhdGE6IHsgaWQ6ICd1cm46bGk6c2hhcmU6MTIzJyB9IH0pO1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS5zaGFyZVBvc3QoJ0hlbGxvIExpbmtlZEluJyk7XG4gICAgICBleHBlY3QocmVzdWx0LmlkKS50b0JlKCd1cm46bGk6c2hhcmU6MTIzJyk7XG4gICAgICBleHBlY3QobW9ja2VkQXhpb3MucG9zdCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCcvdWdjUG9zdHMnKSxcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIGF1dGhvcjogJ3VybjpsaTpvcmdhbml6YXRpb246MTIzNDUnLFxuICAgICAgICAgIHNwZWNpZmljQ29udGVudDogZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgICAgJ2NvbS5saW5rZWRpbi51Z2MuU2hhcmVDb250ZW50JzogZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgICAgICBzaGFyZUNvbW1lbnRhcnk6IHsgdGV4dDogJ0hlbGxvIExpbmtlZEluJyB9LFxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgfSksXG4gICAgICAgIH0pLFxuICAgICAgICBleHBlY3QuYW55dGhpbmcoKSxcbiAgICAgICk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdUaWtUb2tTZXJ2aWNlJywgKCkgPT4ge1xuICAgIGxldCBzZXJ2aWNlOiBUaWtUb2tTZXJ2aWNlO1xuXG4gICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICBzZXJ2aWNlID0gY29udGFpbmVyLmdldDxUaWtUb2tTZXJ2aWNlPihUWVBFUy5UaWtUb2tTZXJ2aWNlKTtcbiAgICAgIChlbnYgYXMgYW55KS5USUtUT0tfQUNDRVNTX1RPS0VOID0gJ3Rlc3QtdG9rZW4nO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHZpZGVvIHVwbG9hZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIG1vY2tlZEF4aW9zLnBvc3QubW9ja1Jlc29sdmVkVmFsdWVPbmNlKHsgZGF0YTogeyBkYXRhOiB7IHVwbG9hZF91cmw6ICdodHRwOi8vdXBsb2FkJyB9IH0gfSk7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLnB1Ymxpc2hWaWRlbygnaHR0cDovL3ZpZGVvLm1wNCcsICdUaXRsZScpO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChtb2NrZWRBeGlvcy5wb3N0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJy9wb3N0L3B1Ymxpc2gvdmlkZW8vaW5pdC8nKSxcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIHBvc3RfaW5mbzogZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoeyB0aXRsZTogJ1RpdGxlJyB9KSxcbiAgICAgICAgfSksXG4gICAgICAgIGV4cGVjdC5hbnl0aGluZygpLFxuICAgICAgKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1hTZXJ2aWNlJywgKCkgPT4ge1xuICAgIGxldCBzZXJ2aWNlOiBYU2VydmljZTtcblxuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgc2VydmljZSA9IGNvbnRhaW5lci5nZXQ8WFNlcnZpY2U+KFRZUEVTLlhTZXJ2aWNlKTtcbiAgICAgIChlbnYgYXMgYW55KS5YX0FDQ0VTU19UT0tFTiA9ICd0ZXN0LXRva2VuJztcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcG9zdCB0d2VldCcsIGFzeW5jICgpID0+IHtcbiAgICAgIG1vY2tlZEF4aW9zLnBvc3QubW9ja1Jlc29sdmVkVmFsdWVPbmNlKHsgZGF0YTogeyBkYXRhOiB7IGlkOiAndHdlZXQtaWQnIH0gfSB9KTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UucG9zdFR3ZWV0KCdIZWxsbyBYJyk7XG4gICAgICBleHBlY3QocmVzdWx0LmRhdGEuaWQpLnRvQmUoJ3R3ZWV0LWlkJyk7XG4gICAgICBleHBlY3QobW9ja2VkQXhpb3MucG9zdCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCcvdHdlZXRzJyksXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICB0ZXh0OiAnSGVsbG8gWCcsXG4gICAgICAgIH0pLFxuICAgICAgICBleHBlY3QuYW55dGhpbmcoKSxcbiAgICAgICk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=