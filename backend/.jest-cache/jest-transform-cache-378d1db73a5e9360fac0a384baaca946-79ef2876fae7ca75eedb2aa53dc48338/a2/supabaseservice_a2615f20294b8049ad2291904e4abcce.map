{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\supabase.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\supabase.service.ts"],"sourcesContent":["import { createClient, SupabaseClient } from '@supabase/supabase-js';\nimport { env } from '../config/env.schema';\nimport { logger } from '../utils/logger';\n\n/**\n * üåå [GOD MODE] SupabaseService\n * High-performance, singleton client for Supabase integration.\n * Features: Automatic instance management, health checks, and secure config validation.\n */\nexport class SupabaseService {\n  private static instance: SupabaseService;\n  private readonly client: SupabaseClient;\n\n  private constructor() {\n    this.validateConfig();\n\n    const url = env.SUPABASE_URL;\n    const key = env.SUPABASE_KEY;\n\n    if (url && key) {\n      this.client = createClient(url, key, {\n        auth: {\n          persistSession: false,\n          autoRefreshToken: false,\n        },\n        global: {\n          headers: { 'x-application-name': 'aigestion-backend' },\n        },\n        db: {\n          schema: 'public',\n        },\n      });\n      logger.info('[SupabaseService] üöÄ Sovereign Client initialized');\n    } else {\n      logger.warn(\n        '[SupabaseService] ‚ö†Ô∏è Supabase credentials missing. Client is running in DISABLED mode.',\n      );\n      this.client = null as any;\n    }\n  }\n\n  private validateConfig() {\n    if (!env.SUPABASE_URL || !env.SUPABASE_KEY) {\n      logger.error('‚ùå Critical: SUPABASE_URL or SUPABASE_KEY missing from environment.');\n      logger.warn(\n        '‚ö†Ô∏è [SupabaseService] Running without valid credentials. Some features will be disabled.',\n      );\n    }\n  }\n\n  public static getInstance(): SupabaseService {\n    if (!SupabaseService.instance) {\n      SupabaseService.instance = new SupabaseService();\n    }\n    return SupabaseService.instance;\n  }\n\n  public getClient(): SupabaseClient {\n    return this.client;\n  }\n\n  /**\n   * Test connection and schema health (GOD MODE)\n   * Performs an optimized health check against the new Sovereign Schema.\n   */\n  public async testConnection(): Promise<boolean> {\n    try {\n      if (!this.client) return false;\n      // Check for profiles table\n      const { error: profileError } = await this.client\n        .from('profiles')\n        .select('id')\n        .limit(1)\n        .maybeSingle();\n\n      if (profileError) {\n        logger.error(`[SupabaseService] ‚ùå Profiles check failed: ${profileError.message}`);\n        return false;\n      }\n\n      // Check for documents table (RAG Support)\n      const { error: docError } = await this.client\n        .from('documents')\n        .select('id')\n        .limit(1)\n        .maybeSingle();\n      if (docError) {\n        logger.warn(`[SupabaseService] ‚ö†Ô∏è Documents table (RAG) check failed: ${docError.message}`);\n      }\n\n      logger.info('[SupabaseService] ‚úÖ Sovereign Schema health check successful');\n      return true;\n    } catch (err: any) {\n      logger.error(\n        `[SupabaseService] üí• Catastrophic failure during God Mode health check: ${err.message}`,\n      );\n      return false;\n    }\n  }\n\n  /**\n   * üåå Hybrid Search (Vector + Full Text)\n   * Advanced RAG capability for backend operations.\n   */\n  public async hybridSearch(\n    projectId: string | undefined,\n    queryText: string,\n    embedding: number[],\n    threshold: number = 0.5,\n    count: number = 5,\n  ) {\n    if (!this.client) throw new Error('Supabase client not initialized');\n    const { data, error } = await this.client.rpc('hybrid_search', {\n      query_text: queryText,\n      query_embedding: embedding,\n      match_threshold: threshold,\n      match_count: count,\n      p_project_id: projectId,\n    });\n\n    if (error) {\n      logger.error(`[SupabaseService] ‚ùå Hybrid search failed: ${error.message}`);\n      throw error;\n    }\n    return data;\n  }\n\n  /**\n   * üìú Prompt Template Management\n   * Retrieve versioned system prompts.\n   */\n  public async getPromptTemplate(name: string) {\n    if (!this.client) throw new Error('Supabase client not initialized');\n    const { data, error } = await this.client\n      .from('prompt_templates')\n      .select('*')\n      .eq('name', name)\n      .eq('is_active', true)\n      .maybeSingle();\n\n    if (error) {\n      logger.error(\n        `[SupabaseService] ‚ùå Failed to fetch prompt template [${name}]: ${error.message}`,\n      );\n      throw error;\n    }\n    return data;\n  }\n\n  /**\n   * üìÇ Knowledge Base Operations\n   */\n  public async upsertDocument(document: any) {\n    if (!this.client) throw new Error('Supabase client not initialized');\n    const { data, error } = await this.client\n      .from('documents')\n      .upsert(document, { onConflict: 'id' })\n      .select()\n      .single();\n\n    if (error) {\n      logger.error(`[SupabaseService] ‚ùå Failed to upsert document: ${error.message}`);\n      throw error;\n    }\n    return data;\n  }\n}\n\n\n// REMOVED top-level singleton initialization to prevent circular dependency issues during module loading.\n// Services should use SupabaseService.getInstance() or better, rely on Inversify injection.\n\n"],"version":3}