44e6598709fb87a9e523301a09de9c0d
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.requireApiKey = exports.validateApiKey = exports.securityMonitor = exports.requestSizeLimit = exports.ipSecurity = exports.securityHeaders = exports.dynamicRateLimit = exports.rateLimiters = exports.createRateLimiter = void 0;
const express_rate_limit_1 = __importDefault(require("express-rate-limit"));
const helmet_1 = __importDefault(require("helmet"));
/**
 * Enhanced Rate Limiting Configuration
 * Different limits for different user tiers and endpoints
 */
const createRateLimiter = (windowMs, max, message) => {
    return (0, express_rate_limit_1.default)({
        windowMs,
        max,
        message: {
            error: 'Too many requests',
            message: message || `Rate limit exceeded. Maximum ${max} requests per ${windowMs}ms.`,
            retryAfter: Math.ceil(windowMs / 1000),
        },
        standardHeaders: true,
        legacyHeaders: false,
    });
};
exports.createRateLimiter = createRateLimiter;
/**
 * Tier-based rate limiting
 */
exports.rateLimiters = {
    // Free tier - 100 requests per 15 minutes
    free: (0, exports.createRateLimiter)(15 * 60 * 1000, // 15 minutes
    100, 'Free tier limit exceeded. Upgrade to Pro for higher limits.'),
    // Pro tier - 1000 requests per 15 minutes
    pro: (0, exports.createRateLimiter)(15 * 60 * 1000, // 15 minutes
    1000, 'Pro tier rate limit exceeded.'),
    // Enterprise tier - 10000 requests per 15 minutes
    enterprise: (0, exports.createRateLimiter)(15 * 60 * 1000, // 15 minutes
    10000, 'Enterprise tier rate limit exceeded.'),
    // Authentication endpoints - stricter limits
    auth: (0, exports.createRateLimiter)(15 * 60 * 1000, // 15 minutes
    5, 'Too many authentication attempts. Please try again later.'),
    // AI endpoints - moderate limits
    ai: (0, exports.createRateLimiter)(1 * 60 * 1000, // 1 minute
    10, 'AI service rate limit exceeded. Please wait before making another request.'),
    // File upload endpoints - very strict limits
    upload: (0, exports.createRateLimiter)(60 * 60 * 1000, // 1 hour
    10, 'Upload rate limit exceeded. Please wait before uploading more files.'),
};
/**
 * Dynamic rate limiting based on user tier
 */
const dynamicRateLimit = (req, res, next) => {
    // Get user tier from request (would be set by auth middleware)
    const userTier = req.user?.tier || 'free';
    // Apply appropriate rate limiter
    const limiter = exports.rateLimiters[userTier] || exports.rateLimiters.free;
    return limiter(req, res, next);
};
exports.dynamicRateLimit = dynamicRateLimit;
/**
 * Enhanced Security Headers
 */
exports.securityHeaders = (0, helmet_1.default)({
    // Content Security Policy
    contentSecurityPolicy: {
        directives: {
            defaultSrc: ["'self'"],
            scriptSrc: ["'self'", "'unsafe-eval'"],
            styleSrc: ["'self'", "'unsafe-inline'", 'fonts.googleapis.com'],
            imgSrc: ["'self'", 'data:', 'https:', 'blob:'],
            connectSrc: [
                "'self'",
                'ws:',
                'wss:',
                'api.openai.com',
                'api.anthropic.com',
                'googleapis.com',
                'vertexai.googleapis.com',
                'pinecone.io',
            ],
            fontSrc: ["'self'", 'fonts.gstatic.com', 'data:'],
            objectSrc: ["'none'"],
            mediaSrc: ["'self'"],
            frameSrc: ["'none'"],
            childSrc: ["'none'"],
            workerSrc: ["'self'", 'blob:'],
            manifestSrc: ["'self'"],
            upgradeInsecureRequests: [],
        },
    },
    // Other security headers
    crossOriginEmbedderPolicy: false,
    crossOriginOpenerPolicy: { policy: 'same-origin' },
    crossOriginResourcePolicy: { policy: 'cross-origin' },
    dnsPrefetchControl: { allow: false },
    frameguard: { action: 'deny' },
    hidePoweredBy: true,
    hsts: {
        maxAge: 31536000,
        includeSubDomains: true,
        preload: true,
    },
    ieNoOpen: true,
    noSniff: true,
    originAgentCluster: true,
    permittedCrossDomainPolicies: false,
    referrerPolicy: { policy: 'no-referrer' },
    xssFilter: true,
});
/**
 * IP-based security middleware
 */
const ipSecurity = (req, res, next) => {
    const clientIP = (req.ip || req.connection.remoteAddress || 'unknown');
    // Block known malicious IPs (would be populated from threat intelligence)
    const blockedIPs = new Set();
    if (blockedIPs.has(clientIP)) {
        return res.status(403).json({
            error: 'Forbidden',
            message: 'Access denied from this IP address.',
        });
    }
    // Check for suspicious patterns
    const userAgent = req.get('User-Agent') || '';
    const suspiciousPatterns = [/bot/i, /crawler/i, /scanner/i, /sqlmap/i, /nikto/i];
    const isSuspicious = suspiciousPatterns.some(pattern => pattern.test(userAgent));
    if (isSuspicious) {
        console.warn('Suspicious request detected:', {
            ip: clientIP,
            userAgent,
            path: req.path,
            timestamp: new Date().toISOString(),
        });
        // Apply stricter rate limiting for suspicious requests
        return exports.rateLimiters.auth(req, res, next);
    }
    next();
};
exports.ipSecurity = ipSecurity;
/**
 * Request size limiting middleware
 */
const requestSizeLimit = (maxSize = '10mb') => {
    return (req, res, next) => {
        const contentLength = req.get('Content-Length');
        if (contentLength) {
            const sizeInBytes = parseInt(contentLength);
            const maxSizeInBytes = parseSize(maxSize);
            if (sizeInBytes > maxSizeInBytes) {
                return res.status(413).json({
                    error: 'Payload Too Large',
                    message: `Request size exceeds maximum allowed size of ${maxSize}.`,
                });
            }
        }
        next();
    };
};
exports.requestSizeLimit = requestSizeLimit;
/**
 * Helper function to parse size strings (e.g., '10mb' -> bytes)
 */
function parseSize(size) {
    const units = {
        b: 1,
        kb: 1024,
        mb: 1024 * 1024,
        gb: 1024 * 1024 * 1024,
    };
    const match = size.toLowerCase().match(/^(\d+)(b|kb|mb|gb)$/);
    if (!match) {
        throw new Error(`Invalid size format: ${size}`);
    }
    const [, value, unit] = match;
    return parseInt(value) * units[unit];
}
/**
 * Security monitoring middleware
 */
const securityMonitor = (req, res, next) => {
    const startTime = Date.now();
    res.on('finish', () => {
        const duration = Date.now() - startTime;
        if (duration > 5000) {
            console.warn('Slow request detected:', {
                method: req.method,
                path: req.path,
                duration,
                ip: req.ip,
                userAgent: req.get('User-Agent'),
            });
        }
        if (res.statusCode >= 400) {
            console.warn('Error response:', {
                method: req.method,
                path: req.path,
                statusCode: res.statusCode,
                ip: req.ip,
                userAgent: req.get('User-Agent'),
            });
        }
    });
    next();
};
exports.securityMonitor = securityMonitor;
/**
 * API key validation middleware
 */
const validateApiKey = (req, res, next) => {
    const apiKey = req.get('X-API-Key');
    const publicPaths = ['/health', '/metrics', '/docs', '/api/v1/auth/login'];
    const isPublicPath = publicPaths.some(path => req.path.startsWith(path));
    if (isPublicPath) {
        return next();
    }
    if (!apiKey) {
        return res.status(401).json({
            error: 'Unauthorized',
            message: 'API key is required.',
        });
    }
    if (!apiKey.startsWith('nexus_') || apiKey.length !== 40) {
        return res.status(401).json({
            error: 'Unauthorized',
            message: 'Invalid API key format.',
        });
    }
    next();
};
exports.validateApiKey = validateApiKey;
exports.requireApiKey = exports.validateApiKey;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxtaWRkbGV3YXJlXFxzZWN1cml0eS5taWRkbGV3YXJlLnRzIiwibWFwcGluZ3MiOiI7Ozs7OztBQUNBLDRFQUEyQztBQUMzQyxvREFBNEI7QUFFNUI7OztHQUdHO0FBQ0ksTUFBTSxpQkFBaUIsR0FBRyxDQUFDLFFBQWdCLEVBQUUsR0FBVyxFQUFFLE9BQWdCLEVBQUUsRUFBRTtJQUNuRixPQUFPLElBQUEsNEJBQVMsRUFBQztRQUNmLFFBQVE7UUFDUixHQUFHO1FBQ0gsT0FBTyxFQUFFO1lBQ1AsS0FBSyxFQUFFLG1CQUFtQjtZQUMxQixPQUFPLEVBQUUsT0FBTyxJQUFJLGdDQUFnQyxHQUFHLGlCQUFpQixRQUFRLEtBQUs7WUFDckYsVUFBVSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztTQUN2QztRQUNELGVBQWUsRUFBRSxJQUFJO1FBQ3JCLGFBQWEsRUFBRSxLQUFLO0tBQ3JCLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQztBQVpXLFFBQUEsaUJBQWlCLHFCQVk1QjtBQUVGOztHQUVHO0FBQ1UsUUFBQSxZQUFZLEdBQUc7SUFDMUIsMENBQTBDO0lBQzFDLElBQUksRUFBRSxJQUFBLHlCQUFpQixFQUNyQixFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksRUFBRSxhQUFhO0lBQzdCLEdBQUcsRUFDSCw2REFBNkQsQ0FDOUQ7SUFFRCwwQ0FBMEM7SUFDMUMsR0FBRyxFQUFFLElBQUEseUJBQWlCLEVBQ3BCLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxFQUFFLGFBQWE7SUFDN0IsSUFBSSxFQUNKLCtCQUErQixDQUNoQztJQUVELGtEQUFrRDtJQUNsRCxVQUFVLEVBQUUsSUFBQSx5QkFBaUIsRUFDM0IsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLEVBQUUsYUFBYTtJQUM3QixLQUFLLEVBQ0wsc0NBQXNDLENBQ3ZDO0lBRUQsNkNBQTZDO0lBQzdDLElBQUksRUFBRSxJ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QUFDO0FBQ1QsQ0FBQyxDQUFDO0FBeEJXLFFBQUEsY0FBYyxrQkF3QnpCO0FBRVcsUUFBQSxhQUFhLEdBQUcsc0JBQWMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXEFsZWphbmRyb1xcQUlHZXN0aW9uXFxiYWNrZW5kXFxzcmNcXG1pZGRsZXdhcmVcXHNlY3VyaXR5Lm1pZGRsZXdhcmUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBOZXh0RnVuY3Rpb24sIFJlcXVlc3QsIFJlc3BvbnNlIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgcmF0ZUxpbWl0IGZyb20gJ2V4cHJlc3MtcmF0ZS1saW1pdCc7XG5pbXBvcnQgaGVsbWV0IGZyb20gJ2hlbG1ldCc7XG5cbi8qKlxuICogRW5oYW5jZWQgUmF0ZSBMaW1pdGluZyBDb25maWd1cmF0aW9uXG4gKiBEaWZmZXJlbnQgbGltaXRzIGZvciBkaWZmZXJlbnQgdXNlciB0aWVycyBhbmQgZW5kcG9pbnRzXG4gKi9cbmV4cG9ydCBjb25zdCBjcmVhdGVSYXRlTGltaXRlciA9ICh3aW5kb3dNczogbnVtYmVyLCBtYXg6IG51bWJlciwgbWVzc2FnZT86IHN0cmluZykgPT4ge1xuICByZXR1cm4gcmF0ZUxpbWl0KHtcbiAgICB3aW5kb3dNcyxcbiAgICBtYXgsXG4gICAgbWVzc2FnZToge1xuICAgICAgZXJyb3I6ICdUb28gbWFueSByZXF1ZXN0cycsXG4gICAgICBtZXNzYWdlOiBtZXNzYWdlIHx8IGBSYXRlIGxpbWl0IGV4Y2VlZGVkLiBNYXhpbXVtICR7bWF4fSByZXF1ZXN0cyBwZXIgJHt3aW5kb3dNc31tcy5gLFxuICAgICAgcmV0cnlBZnRlcjogTWF0aC5jZWlsKHdpbmRvd01zIC8gMTAwMCksXG4gICAgfSxcbiAgICBzdGFuZGFyZEhlYWRlcnM6IHRydWUsXG4gICAgbGVnYWN5SGVhZGVyczogZmFsc2UsXG4gIH0pO1xufTtcblxuLyoqXG4gKiBUaWVyLWJhc2VkIHJhdGUgbGltaXRpbmdcbiAqL1xuZXhwb3J0IGNvbnN0IHJhdGVMaW1pdGVycyA9IHtcbiAgLy8gRnJlZSB0aWVyIC0gMTAwIHJlcXVlc3RzIHBlciAxNSBtaW51dGVzXG4gIGZyZWU6IGNyZWF0ZVJhdGVMaW1pdGVyKFxuICAgIDE1ICogNjAgKiAxMDAwLCAvLyAxNSBtaW51dGVzXG4gICAgMTAwLFxuICAgICdGcmVlIHRpZXIgbGltaXQgZXhjZWVkZWQuIFVwZ3JhZGUgdG8gUHJvIGZvciBoaWdoZXIgbGltaXRzLicsXG4gICksXG5cbiAgLy8gUHJvIHRpZXIgLSAxMDAwIHJlcXVlc3RzIHBlciAxNSBtaW51dGVzXG4gIHBybzogY3JlYXRlUmF0ZUxpbWl0ZXIoXG4gICAgMTUgKiA2MCAqIDEwMDAsIC8vIDE1IG1pbnV0ZXNcbiAgICAxMDAwLFxuICAgICdQcm8gdGllciByYXRlIGxpbWl0IGV4Y2VlZGVkLicsXG4gICksXG5cbiAgLy8gRW50ZXJwcmlzZSB0aWVyIC0gMTAwMDAgcmVxdWVzdHMgcGVyIDE1IG1pbnV0ZXNcbiAgZW50ZXJwcmlzZTogY3JlYXRlUmF0ZUxpbWl0ZXIoXG4gICAgMTUgKiA2MCAqIDEwMDAsIC8vIDE1IG1pbnV0ZXNcbiAgICAxMDAwMCxcbiAgICAnRW50ZXJwcmlzZSB0aWVyIHJhdGUgbGltaXQgZXhjZWVkZWQuJyxcbiAgKSxcblxuICAvLyBBdXRoZW50aWNhdGlvbiBlbmRwb2ludHMgLSBzdHJpY3RlciBsaW1pdHNcbiAgYXV0aDogY3JlYXRlUmF0ZUxpbWl0ZXIoXG4gICAgMTUgKiA2MCAqIDEwMDAsIC8vIDE1IG1pbnV0ZXNcbiAgICA1LFxuICAgICdUb28gbWFueSBhdXRoZW50aWNhdGlvbiBhdHRlbXB0cy4gUGxlYXNlIHRyeSBhZ2FpbiBsYXRlci4nLFxuICApLFxuXG4gIC8vIEFJIGVuZHBvaW50cyAtIG1vZGVyYXRlIGxpbWl0c1xuICBhaTogY3JlYXRlUmF0ZUxpbWl0ZXIoXG4gICAgMSAqIDYwICogMTAwMCwgLy8gMSBtaW51dGVcbiAgICAxMCxcbiAgICAnQUkgc2VydmljZSByYXRlIGxpbWl0IGV4Y2VlZGVkLiBQbGVhc2Ugd2FpdCBiZWZvcmUgbWFraW5nIGFub3RoZXIgcmVxdWVzdC4nLFxuICApLFxuXG4gIC8vIEZpbGUgdXBsb2FkIGVuZHBvaW50cyAtIHZlcnkgc3RyaWN0IGxpbWl0c1xuICB1cGxvYWQ6IGNyZWF0ZVJhdGVMaW1pdGVyKFxuICAgIDYwICogNjAgKiAxMDAwLCAvLyAxIGhvdXJcbiAgICAxMCxcbiAgICAnVXBsb2FkIHJhdGUgbGltaXQgZXhjZWVkZWQuIFBsZWFzZSB3YWl0IGJlZm9yZSB1cGxvYWRpbmcgbW9yZSBmaWxlcy4nLFxuICApLFxufTtcblxuLyoqXG4gKiBEeW5hbWljIHJhdGUgbGltaXRpbmcgYmFzZWQgb24gdXNlciB0aWVyXG4gKi9cbmV4cG9ydCBjb25zdCBkeW5hbWljUmF0ZUxpbWl0ID0gKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG4gIC8vIEdldCB1c2VyIHRpZXIgZnJvbSByZXF1ZXN0ICh3b3VsZCBiZSBzZXQgYnkgYXV0aCBtaWRkbGV3YXJlKVxuICBjb25zdCB1c2VyVGllciA9IChyZXEgYXMgYW55KS51c2VyPy50aWVyIHx8ICdmcmVlJztcblxuICAvLyBBcHBseSBhcHByb3ByaWF0ZSByYXRlIGxpbWl0ZXJcbiAgY29uc3QgbGltaXRlciA9IHJhdGVMaW1pdGVyc1t1c2VyVGllcl0gfHwgcmF0ZUxpbWl0ZXJzLmZyZWU7XG4gIHJldHVybiBsaW1pdGVyKHJlcSwgcmVzLCBuZXh0KTtcbn07XG5cbi8qKlxuICogRW5oYW5jZWQgU2VjdXJpdHkgSGVhZGVyc1xuICovXG5leHBvcnQgY29uc3Qgc2VjdXJpdHlIZWFkZXJzID0gaGVsbWV0KHtcbiAgLy8gQ29udGVudCBTZWN1cml0eSBQb2xpY3lcbiAgY29udGVudFNlY3VyaXR5UG9saWN5OiB7XG4gICAgZGlyZWN0aXZlczoge1xuICAgICAgZGVmYXVsdFNyYzogW1wiJ3NlbGYnXCJdLFxuICAgICAgc2NyaXB0U3JjOiBbXCInc2VsZidcIiwgXCIndW5zYWZlLWV2YWwnXCJdLFxuICAgICAgc3R5bGVTcmM6IFtcIidzZWxmJ1wiLCBcIid1bnNhZmUtaW5saW5lJ1wiLCAnZm9udHMuZ29vZ2xlYXBpcy5jb20nXSxcbiAgICAgIGltZ1NyYzogW1wiJ3NlbGYnXCIsICdkYXRhOicsICdodHRwczonLCAnYmxvYjonXSxcbiAgICAgIGNvbm5lY3RTcmM6IFtcbiAgICAgICAgXCInc2VsZidcIixcbiAgICAgICAgJ3dzOicsXG4gICAgICAgICd3c3M6JyxcbiAgICAgICAgJ2FwaS5vcGVuYWkuY29tJyxcbiAgICAgICAgJ2FwaS5hbnRocm9waWMuY29tJyxcbiAgICAgICAgJ2dvb2dsZWFwaXMuY29tJyxcbiAgICAgICAgJ3ZlcnRleGFpLmdvb2dsZWFwaXMuY29tJyxcbiAgICAgICAgJ3BpbmVjb25lLmlvJyxcbiAgICAgIF0sXG4gICAgICBmb250U3JjOiBbXCInc2VsZidcIiwgJ2ZvbnRzLmdzdGF0aWMuY29tJywgJ2RhdGE6J10sXG4gICAgICBvYmplY3RTcmM6IFtcIidub25lJ1wiXSxcbiAgICAgIG1lZGlhU3JjOiBbXCInc2VsZidcIl0sXG4gICAgICBmcmFtZVNyYzogW1wiJ25vbmUnXCJdLFxuICAgICAgY2hpbGRTcmM6IFtcIidub25lJ1wiXSxcbiAgICAgIHdvcmtlclNyYzogW1wiJ3NlbGYnXCIsICdibG9iOiddLFxuICAgICAgbWFuaWZlc3RTcmM6IFtcIidzZWxmJ1wiXSxcbiAgICAgIHVwZ3JhZGVJbnNlY3VyZVJlcXVlc3RzOiBbXSxcbiAgICB9LFxuICB9LFxuXG4gIC8vIE90aGVyIHNlY3VyaXR5IGhlYWRlcnNcbiAgY3Jvc3NPcmlnaW5FbWJlZGRlclBvbGljeTogZmFsc2UsXG4gIGNyb3NzT3JpZ2luT3BlbmVyUG9saWN5OiB7IHBvbGljeTogJ3NhbWUtb3JpZ2luJyB9LFxuICBjcm9zc09yaWdpblJlc291cmNlUG9saWN5OiB7IHBvbGljeTogJ2Nyb3NzLW9yaWdpbicgfSxcbiAgZG5zUHJlZmV0Y2hDb250cm9sOiB7IGFsbG93OiBmYWxzZSB9LFxuICBmcmFtZWd1YXJkOiB7IGFjdGlvbjogJ2RlbnknIH0sXG4gIGhpZGVQb3dlcmVkQnk6IHRydWUsXG4gIGhzdHM6IHtcbiAgICBtYXhBZ2U6IDMxNTM2MDAwLFxuICAgIGluY2x1ZGVTdWJEb21haW5zOiB0cnVlLFxuICAgIHByZWxvYWQ6IHRydWUsXG4gIH0sXG4gIGllTm9PcGVuOiB0cnVlLFxuICBub1NuaWZmOiB0cnVlLFxuICBvcmlnaW5BZ2VudENsdXN0ZXI6IHRydWUsXG4gIHBlcm1pdHRlZENyb3NzRG9tYWluUG9saWNpZXM6IGZhbHNlLFxuICByZWZlcnJlclBvbGljeTogeyBwb2xpY3k6ICduby1yZWZlcnJlcicgfSxcbiAgeHNzRmlsdGVyOiB0cnVlLFxufSk7XG5cbi8qKlxuICogSVAtYmFzZWQgc2VjdXJpdHkgbWlkZGxld2FyZVxuICovXG5leHBvcnQgY29uc3QgaXBTZWN1cml0eSA9IChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xuICBjb25zdCBjbGllbnRJUCA9IChyZXEuaXAgfHwgcmVxLmNvbm5lY3Rpb24ucmVtb3RlQWRkcmVzcyB8fCAndW5rbm93bicpIGFzIHN0cmluZztcblxuICAvLyBCbG9jayBrbm93biBtYWxpY2lvdXMgSVBzICh3b3VsZCBiZSBwb3B1bGF0ZWQgZnJvbSB0aHJlYXQgaW50ZWxsaWdlbmNlKVxuICBjb25zdCBibG9ja2VkSVBzID0gbmV3IFNldDxzdHJpbmc+KCk7XG5cbiAgaWYgKGJsb2NrZWRJUHMuaGFzKGNsaWVudElQKSkge1xuICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7XG4gICAgICBlcnJvcjogJ0ZvcmJpZGRlbicsXG4gICAgICBtZXNzYWdlOiAnQWNjZXNzIGRlbmllZCBmcm9tIHRoaXMgSVAgYWRkcmVzcy4nLFxuICAgIH0pO1xuICB9XG5cbiAgLy8gQ2hlY2sgZm9yIHN1c3BpY2lvdXMgcGF0dGVybnNcbiAgY29uc3QgdXNlckFnZW50ID0gcmVxLmdldCgnVXNlci1BZ2VudCcpIHx8ICcnO1xuICBjb25zdCBzdXNwaWNpb3VzUGF0dGVybnMgPSBbL2JvdC9pLCAvY3Jhd2xlci9pLCAvc2Nhbm5lci9pLCAvc3FsbWFwL2ksIC9uaWt0by9pXTtcbiAgY29uc3QgaXNTdXNwaWNpb3VzID0gc3VzcGljaW91c1BhdHRlcm5zLnNvbWUocGF0dGVybiA9PiBwYXR0ZXJuLnRlc3QodXNlckFnZW50KSk7XG5cbiAgaWYgKGlzU3VzcGljaW91cykge1xuICAgIGNvbnNvbGUud2FybignU3VzcGljaW91cyByZXF1ZXN0IGRldGVjdGVkOicsIHtcbiAgICAgIGlwOiBjbGllbnRJUCxcbiAgICAgIHVzZXJBZ2VudCxcbiAgICAgIHBhdGg6IHJlcS5wYXRoLFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgfSk7XG5cbiAgICAvLyBBcHBseSBzdHJpY3RlciByYXRlIGxpbWl0aW5nIGZvciBzdXNwaWNpb3VzIHJlcXVlc3RzXG4gICAgcmV0dXJuIHJhdGVMaW1pdGVycy5hdXRoKHJlcSwgcmVzLCBuZXh0KTtcbiAgfVxuXG4gIG5leHQoKTtcbn07XG5cbi8qKlxuICogUmVxdWVzdCBzaXplIGxpbWl0aW5nIG1pZGRsZXdhcmVcbiAqL1xuZXhwb3J0IGNvbnN0IHJlcXVlc3RTaXplTGltaXQgPSAobWF4U2l6ZTogc3RyaW5nID0gJzEwbWInKSA9PiB7XG4gIHJldHVybiAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcbiAgICBjb25zdCBjb250ZW50TGVuZ3RoID0gcmVxLmdldCgnQ29udGVudC1MZW5ndGgnKTtcblxuICAgIGlmIChjb250ZW50TGVuZ3RoKSB7XG4gICAgICBjb25zdCBzaXplSW5CeXRlcyA9IHBhcnNlSW50KGNvbnRlbnRMZW5ndGgpO1xuICAgICAgY29uc3QgbWF4U2l6ZUluQnl0ZXMgPSBwYXJzZVNpemUobWF4U2l6ZSk7XG5cbiAgICAgIGlmIChzaXplSW5CeXRlcyA+IG1heFNpemVJbkJ5dGVzKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQxMykuanNvbih7XG4gICAgICAgICAgZXJyb3I6ICdQYXlsb2FkIFRvbyBMYXJnZScsXG4gICAgICAgICAgbWVzc2FnZTogYFJlcXVlc3Qgc2l6ZSBleGNlZWRzIG1heGltdW0gYWxsb3dlZCBzaXplIG9mICR7bWF4U2l6ZX0uYCxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgbmV4dCgpO1xuICB9O1xufTtcblxuLyoqXG4gKiBIZWxwZXIgZnVuY3Rpb24gdG8gcGFyc2Ugc2l6ZSBzdHJpbmdzIChlLmcuLCAnMTBtYicgLT4gYnl0ZXMpXG4gKi9cbmZ1bmN0aW9uIHBhcnNlU2l6ZShzaXplOiBzdHJpbmcpOiBudW1iZXIge1xuICBjb25zdCB1bml0czogeyBba2V5OiBzdHJpbmddOiBudW1iZXIgfSA9IHtcbiAgICBiOiAxLFxuICAgIGtiOiAxMDI0LFxuICAgIG1iOiAxMDI0ICogMTAyNCxcbiAgICBnYjogMTAyNCAqIDEwMjQgKiAxMDI0LFxuICB9O1xuXG4gIGNvbnN0IG1hdGNoID0gc2l6ZS50b0xvd2VyQ2FzZSgpLm1hdGNoKC9eKFxcZCspKGJ8a2J8bWJ8Z2IpJC8pO1xuICBpZiAoIW1hdGNoKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHNpemUgZm9ybWF0OiAke3NpemV9YCk7XG4gIH1cblxuICBjb25zdCBbLCB2YWx1ZSwgdW5pdF0gPSBtYXRjaDtcbiAgcmV0dXJuIHBhcnNlSW50KHZhbHVlKSAqIHVuaXRzW3VuaXRdO1xufVxuXG4vKipcbiAqIFNlY3VyaXR5IG1vbml0b3JpbmcgbWlkZGxld2FyZVxuICovXG5leHBvcnQgY29uc3Qgc2VjdXJpdHlNb25pdG9yID0gKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG4gIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7XG5cbiAgcmVzLm9uKCdmaW5pc2gnLCAoKSA9PiB7XG4gICAgY29uc3QgZHVyYXRpb24gPSBEYXRlLm5vdygpIC0gc3RhcnRUaW1lO1xuXG4gICAgaWYgKGR1cmF0aW9uID4gNTAwMCkge1xuICAgICAgY29uc29sZS53YXJuKCdTbG93IHJlcXVlc3QgZGV0ZWN0ZWQ6Jywge1xuICAgICAgICBtZXRob2Q6IHJlcS5tZXRob2QsXG4gICAgICAgIHBhdGg6IHJlcS5wYXRoLFxuICAgICAgICBkdXJhdGlvbixcbiAgICAgICAgaXA6IHJlcS5pcCxcbiAgICAgICAgdXNlckFnZW50OiByZXEuZ2V0KCdVc2VyLUFnZW50JyksXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAocmVzLnN0YXR1c0NvZGUgPj0gNDAwKSB7XG4gICAgICBjb25zb2xlLndhcm4oJ0Vycm9yIHJlc3BvbnNlOicsIHtcbiAgICAgICAgbWV0aG9kOiByZXEubWV0aG9kLFxuICAgICAgICBwYXRoOiByZXEucGF0aCxcbiAgICAgICAgc3RhdHVzQ29kZTogcmVzLnN0YXR1c0NvZGUsXG4gICAgICAgIGlwOiByZXEuaXAsXG4gICAgICAgIHVzZXJBZ2VudDogcmVxLmdldCgnVXNlci1BZ2VudCcpLFxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcblxuICBuZXh0KCk7XG59O1xuXG4vKipcbiAqIEFQSSBrZXkgdmFsaWRhdGlvbiBtaWRkbGV3YXJlXG4gKi9cbmV4cG9ydCBjb25zdCB2YWxpZGF0ZUFwaUtleSA9IChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xuICBjb25zdCBhcGlLZXkgPSByZXEuZ2V0KCdYLUFQSS1LZXknKTtcblxuICBjb25zdCBwdWJsaWNQYXRocyA9IFsnL2hlYWx0aCcsICcvbWV0cmljcycsICcvZG9jcycsICcvYXBpL3YxL2F1dGgvbG9naW4nXTtcbiAgY29uc3QgaXNQdWJsaWNQYXRoID0gcHVibGljUGF0aHMuc29tZShwYXRoID0+IHJlcS5wYXRoLnN0YXJ0c1dpdGgocGF0aCkpO1xuICBpZiAoaXNQdWJsaWNQYXRoKSB7XG4gICAgcmV0dXJuIG5leHQoKTtcbiAgfVxuXG4gIGlmICghYXBpS2V5KSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgIGVycm9yOiAnVW5hdXRob3JpemVkJyxcbiAgICAgIG1lc3NhZ2U6ICdBUEkga2V5IGlzIHJlcXVpcmVkLicsXG4gICAgfSk7XG4gIH1cblxuICBpZiAoIWFwaUtleS5zdGFydHNXaXRoKCduZXh1c18nKSB8fCBhcGlLZXkubGVuZ3RoICE9PSA0MCkge1xuICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICBlcnJvcjogJ1VuYXV0aG9yaXplZCcsXG4gICAgICBtZXNzYWdlOiAnSW52YWxpZCBBUEkga2V5IGZvcm1hdC4nLFxuICAgIH0pO1xuICB9XG5cbiAgbmV4dCgpO1xufTtcblxuZXhwb3J0IGNvbnN0IHJlcXVpcmVBcGlLZXkgPSB2YWxpZGF0ZUFwaUtleTtcbiJdLCJ2ZXJzaW9uIjozfQ==