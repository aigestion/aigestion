f23753fc1e990e4e4c68935ced30ccdd
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.app = void 0;
const compression_1 = __importDefault(require("compression"));
const cookie_parser_1 = __importDefault(require("cookie-parser"));
const cors_1 = __importDefault(require("cors"));
const express_1 = __importDefault(require("express"));
const express_rate_limit_1 = __importDefault(require("express-rate-limit"));
const helmet_1 = __importDefault(require("helmet"));
const hpp_1 = __importDefault(require("hpp"));
const morgan_1 = __importDefault(require("morgan"));
const rate_limit_redis_1 = __importDefault(require("rate-limit-redis"));
// @ts-ignore
// import responseTime from 'response-time';
const xss_clean_1 = __importDefault(require("xss-clean"));
// Middleware to ensure every JSON response follows the standard API for
const config_1 = require("./config/config");
const swagger_1 = require("./docs/swagger");
const router_1 = require("./graphql/router");
const error_middleware_1 = require("./middleware/error.middleware");
const requestId_middleware_1 = require("./middleware/requestId.middleware");
const routes_1 = __importDefault(require("./routes"));
const mcp_routes_1 = __importDefault(require("./routes/mcp.routes"));
const logger_1 = require("./utils/logger");
const redis_1 = __importDefault(require("./utils/redis"));
const app = (0, express_1.default)();
exports.app = app;
// Request Traceability
app.use(requestId_middleware_1.requestIdMiddleware);
// Security Middleware
app.use((0, helmet_1.default)({
    contentSecurityPolicy: {
        directives: {
            defaultSrc: ["'self'"],
            scriptSrc: ["'self'", "'unsafe-inline'"],
            styleSrc: ["'self'", "'unsafe-inline'"],
            imgSrc: ["'self'", 'data:', 'https:'],
            connectSrc: ["'self'", 'ws:', 'wss:'],
        },
    },
}));
app.use((0, cors_1.default)({
    origin: (origin, callback) => {
        const allowedOrigins = config_1.config.cors.origin;
        const isAllowed = !origin ||
            allowedOrigins === '*' ||
            (Array.isArray(allowedOrigins) && allowedOrigins.includes(origin));
        if (isAllowed) {
            callback(null, true);
        }
        else {
            callback(new Error('Not allowed by CORS'));
        }
    },
    credentials: true,
}));
// Rate limiting middleware (15 min window, 100 requests per IP)
const isTest = process.env.NODE_ENV === 'test' || !!process.env.JEST_WORKER_ID;
// Redis client for rate limiting store (Reusing unified client)
let redisClient;
if (!isTest) {
    // getRedisClient handles connection internally or returns existing one
    redisClient = (0, redis_1.default)();
}
const useRedis = !isTest && process.env.ENABLE_REDIS !== 'false';
const apiLimiter = (0, express_rate_limit_1.default)({
    store: !useRedis
        ? undefined // Use default MemoryStore for tests or if Redis is disabled
        : new rate_limit_redis_1.default({
            sendCommand: (...args) => redisClient.sendCommand(args),
        }),
    windowMs: 15 * 60 * 1000,
    max: config_1.config.rateLimit.max,
    standardHeaders: true,
    legacyHeaders: false,
});
// Apply rate limiter to all API routes
if (!isTest) {
    app.use('/api/v1', apiLimiter);
}
// Security middlewares
app.use((0, hpp_1.default)());
app.use((0, xss_clean_1.default)());
// app.use(responseTime());
// Performance Middleware
app.use((0, compression_1.default)({
    level: 7, // Slightly higher compression
    threshold: 512, // Compress smaller payloads for mobile speed
}));
// Logging Middleware
app.use((0, morgan_1.default)('combined', {
    stream: {
        write: (message) => logger_1.logger.info(message.trim()),
    },
    skip: (req) => req.url === '/api/v1/health',
}));
// Request Parsing
app.use(express_1.default.json({
    limit: '10mb',
    verify: (req, _res, buf) => {
        if (req.originalUrl.includes('/stripe/webhook')) {
            req.rawBody = buf;
        }
    },
}));
app.use((0, cookie_parser_1.default)());
// Mount Routes
(0, swagger_1.setupSwagger)(app);
// Health checks are now handled in api-v1.routes.ts
app.use('/api/v1', routes_1.default);
app.use('/mcp', mcp_routes_1.default);
app.use('/graphql', (0, router_1.createGraphQLRouter)());
// Error handling
app.use(error_middleware_1.notFoundHandler);
app.use(error_middleware_1.errorHandler);
// Graceful shutdown
process.on('SIGINT', async () => {
    logger_1.logger.info('Shutting down gracefully...');
    await redisClient.disconnect();
    process.exit(0);
});
process.on('SIGTERM', async () => {
    logger_1.logger.info('Shutting down gracefully...');
    await redisClient.disconnect();
    process.exit(0);
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxhcHAudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsOERBQXNDO0FBQ3RDLGtFQUF5QztBQUN6QyxnREFBd0I7QUFDeEIsc0RBQThCO0FBQzlCLDRFQUEyQztBQUUzQyxvREFBNEI7QUFDNUIsOENBQXNCO0FBQ3RCLG9EQUE0QjtBQUM1Qix3RUFBbUQ7QUFDbkQsYUFBYTtBQUNiLDRDQUE0QztBQUM1QywwREFBaUM7QUFFakMsd0VBQXdFO0FBQ3hFLDRDQUF5QztBQUN6Qyw0Q0FBOEM7QUFDOUMsNkNBQXVEO0FBQ3ZELG9FQUE4RTtBQUM5RSw0RUFBd0U7QUFDeEUsc0RBQThCO0FBQzlCLHFFQUE0QztBQUM1QywyQ0FBd0M7QUFJeEMsMERBQTJDO0FBRTNDLE1BQU0sR0FBRyxHQUFHLElBQUEsaUJBQU8sR0FBRSxDQUFDO0FBbUliLGtCQUFHO0FBaklaLHVCQUF1QjtBQUN2QixHQUFHLENBQUMsR0FBRyxDQUFDLDBDQUFtQixDQUFDLENBQUM7QUFFN0Isc0JBQXNCO0FBQ3RCLEdBQUcsQ0FBQyxHQUFHLENBQ0wsSUFBQSxnQkFBTSxFQUFDO0lBQ0wscUJBQXFCLEVBQUU7UUFDckIsVUFBVSxFQUFFO1lBQ1YsVUFBVSxFQUFFLENBQUMsUUFBUSxDQUFDO1lBQ3RCLFNBQVMsRUFBRSxDQUFDLFFBQVEsRUFBRSxpQkFBaUIsQ0FBQztZQUN4QyxRQUFRLEVBQUUsQ0FBQyxRQUFRLEVBQUUsaUJBQWlCLENBQUM7WUFDdkMsTUFBTSxFQUFFLENBQUMsUUFBUSxFQUFFLE9BQU8sRUFBRSxRQUFRLENBQUM7WUFDckMsVUFBVSxFQUFFLENBQUMsUUFBUSxFQUFFLEtBQUssRUFBRSxNQUFNLENBQUM7U0FDdEM7S0FDRjtDQUNGLENBQUMsQ0FDSCxDQUFDO0FBQ0YsR0FBRyxDQUFDLEdBQUcsQ0FDTCxJQUFBLGNBQUksRUFBQztJQUNILE1BQU0sRUFBRSxDQUNOLE1BQTBCLEVBQzFCLFFBQXNELEVBQ3RELEVBQUU7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LENBQUMsQ0FBQztBQUNsQixDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXEFsZWphbmRyb1xcQUlHZXN0aW9uXFxiYWNrZW5kXFxzcmNcXGFwcC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY29tcHJlc3Npb24gZnJvbSAnY29tcHJlc3Npb24nO1xuaW1wb3J0IGNvb2tpZVBhcnNlciBmcm9tICdjb29raWUtcGFyc2VyJztcbmltcG9ydCBjb3JzIGZyb20gJ2NvcnMnO1xuaW1wb3J0IGV4cHJlc3MgZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgcmF0ZUxpbWl0IGZyb20gJ2V4cHJlc3MtcmF0ZS1saW1pdCc7XG5pbXBvcnQgdHlwZSB7IFJlcXVlc3QsIFJlc3BvbnNlIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgaGVsbWV0IGZyb20gJ2hlbG1ldCc7XG5pbXBvcnQgaHBwIGZyb20gJ2hwcCc7XG5pbXBvcnQgbW9yZ2FuIGZyb20gJ21vcmdhbic7XG5pbXBvcnQgUmF0ZUxpbWl0UmVkaXNTdG9yZSBmcm9tICdyYXRlLWxpbWl0LXJlZGlzJztcbi8vIEB0cy1pZ25vcmVcbi8vIGltcG9ydCByZXNwb25zZVRpbWUgZnJvbSAncmVzcG9uc2UtdGltZSc7XG5pbXBvcnQgeHNzQ2xlYW4gZnJvbSAneHNzLWNsZWFuJztcblxuLy8gTWlkZGxld2FyZSB0byBlbnN1cmUgZXZlcnkgSlNPTiByZXNwb25zZSBmb2xsb3dzIHRoZSBzdGFuZGFyZCBBUEkgZm9yXG5pbXBvcnQgeyBjb25maWcgfSBmcm9tICcuL2NvbmZpZy9jb25maWcnO1xuaW1wb3J0IHsgc2V0dXBTd2FnZ2VyIH0gZnJvbSAnLi9kb2NzL3N3YWdnZXInO1xuaW1wb3J0IHsgY3JlYXRlR3JhcGhRTFJvdXRlciB9IGZyb20gJy4vZ3JhcGhxbC9yb3V0ZXInO1xuaW1wb3J0IHsgZXJyb3JIYW5kbGVyLCBub3RGb3VuZEhhbmRsZXIgfSBmcm9tICcuL21pZGRsZXdhcmUvZXJyb3IubWlkZGxld2FyZSc7XG5pbXBvcnQgeyByZXF1ZXN0SWRNaWRkbGV3YXJlIH0gZnJvbSAnLi9taWRkbGV3YXJlL3JlcXVlc3RJZC5taWRkbGV3YXJlJztcbmltcG9ydCByb3V0ZXMgZnJvbSAnLi9yb3V0ZXMnO1xuaW1wb3J0IG1jcFJvdXRlciBmcm9tICcuL3JvdXRlcy9tY3Aucm91dGVzJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4vdXRpbHMvbG9nZ2VyJztcblxuaW1wb3J0IHsgYnVpbGRSZXNwb25zZSB9IGZyb20gJy4vY29tbW9uL3Jlc3BvbnNlLWJ1aWxkZXInO1xuaW1wb3J0IHsgY2RuQ2FjaGUgfSBmcm9tICcuL21pZGRsZXdhcmUvY2RuLWNhY2hlLm1pZGRsZXdhcmUnO1xuaW1wb3J0IGdldFJlZGlzQ2xpZW50IGZyb20gJy4vdXRpbHMvcmVkaXMnO1xuXG5jb25zdCBhcHAgPSBleHByZXNzKCk7XG5cbi8vIFJlcXVlc3QgVHJhY2VhYmlsaXR5XG5hcHAudXNlKHJlcXVlc3RJZE1pZGRsZXdhcmUpO1xuXG4vLyBTZWN1cml0eSBNaWRkbGV3YXJlXG5hcHAudXNlKFxuICBoZWxtZXQoe1xuICAgIGNvbnRlbnRTZWN1cml0eVBvbGljeToge1xuICAgICAgZGlyZWN0aXZlczoge1xuICAgICAgICBkZWZhdWx0U3JjOiBbXCInc2VsZidcIl0sXG4gICAgICAgIHNjcmlwdFNyYzogW1wiJ3NlbGYnXCIsIFwiJ3Vuc2FmZS1pbmxpbmUnXCJdLFxuICAgICAgICBzdHlsZVNyYzogW1wiJ3NlbGYnXCIsIFwiJ3Vuc2FmZS1pbmxpbmUnXCJdLFxuICAgICAgICBpbWdTcmM6IFtcIidzZWxmJ1wiLCAnZGF0YTonLCAnaHR0cHM6J10sXG4gICAgICAgIGNvbm5lY3RTcmM6IFtcIidzZWxmJ1wiLCAnd3M6JywgJ3dzczonXSxcbiAgICAgIH0sXG4gICAgfSxcbiAgfSksXG4pO1xuYXBwLnVzZShcbiAgY29ycyh7XG4gICAgb3JpZ2luOiAoXG4gICAgICBvcmlnaW46IHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgICAgIGNhbGxiYWNrOiAoZXJyOiBFcnJvciB8IG51bGwsIGFsbG93PzogYm9vbGVhbikgPT4gdm9pZCxcbiAgICApID0+IHtcbiAgICAgIGNvbnN0IGFsbG93ZWRPcmlnaW5zID0gY29uZmlnLmNvcnMub3JpZ2luO1xuICAgICAgY29uc3QgaXNBbGxvd2VkID1cbiAgICAgICAgIW9yaWdpbiB8fFxuICAgICAgICBhbGxvd2VkT3JpZ2lucyA9PT0gJyonIHx8XG4gICAgICAgIChBcnJheS5pc0FycmF5KGFsbG93ZWRPcmlnaW5zKSAmJiBhbGxvd2VkT3JpZ2lucy5pbmNsdWRlcyhvcmlnaW4pKTtcblxuICAgICAgaWYgKGlzQWxsb3dlZCkge1xuICAgICAgICBjYWxsYmFjayhudWxsLCB0cnVlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNhbGxiYWNrKG5ldyBFcnJvcignTm90IGFsbG93ZWQgYnkgQ09SUycpKTtcbiAgICAgIH1cbiAgICB9LFxuICAgIGNyZWRlbnRpYWxzOiB0cnVlLFxuICB9KSxcbik7XG5cbi8vIFJhdGUgbGltaXRpbmcgbWlkZGxld2FyZSAoMTUgbWluIHdpbmRvdywgMTAwIHJlcXVlc3RzIHBlciBJUClcbmNvbnN0IGlzVGVzdCA9IHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAndGVzdCcgfHwgISFwcm9jZXNzLmVudi5KRVNUX1dPUktFUl9JRDtcblxuLy8gUmVkaXMgY2xpZW50IGZvciByYXRlIGxpbWl0aW5nIHN0b3JlIChSZXVzaW5nIHVuaWZpZWQgY2xpZW50KVxubGV0IHJlZGlzQ2xpZW50OiBhbnk7XG5pZiAoIWlzVGVzdCkge1xuICAvLyBnZXRSZWRpc0NsaWVudCBoYW5kbGVzIGNvbm5lY3Rpb24gaW50ZXJuYWxseSBvciByZXR1cm5zIGV4aXN0aW5nIG9uZVxuICByZWRpc0NsaWVudCA9IGdldFJlZGlzQ2xpZW50KCk7XG59XG5cbmNvbnN0IHVzZVJlZGlzID0gIWlzVGVzdCAmJiBwcm9jZXNzLmVudi5FTkFCTEVfUkVESVMgIT09ICdmYWxzZSc7XG5cbmNvbnN0IGFwaUxpbWl0ZXIgPSByYXRlTGltaXQoe1xuICBzdG9yZTogIXVzZVJlZGlzXG4gICAgPyB1bmRlZmluZWQgLy8gVXNlIGRlZmF1bHQgTWVtb3J5U3RvcmUgZm9yIHRlc3RzIG9yIGlmIFJlZGlzIGlzIGRpc2FibGVkXG4gICAgOiBuZXcgUmF0ZUxpbWl0UmVkaXNTdG9yZSh7XG4gICAgICAgIHNlbmRDb21tYW5kOiAoLi4uYXJncykgPT4gcmVkaXNDbGllbnQuc2VuZENvbW1hbmQoYXJncyksXG4gICAgICB9KSxcbiAgd2luZG93TXM6IDE1ICogNjAgKiAxMDAwLFxuICBtYXg6IGNvbmZpZy5yYXRlTGltaXQubWF4LFxuICBzdGFuZGFyZEhlYWRlcnM6IHRydWUsXG4gIGxlZ2FjeUhlYWRlcnM6IGZhbHNlLFxufSk7XG5cbi8vIEFwcGx5IHJhdGUgbGltaXRlciB0byBhbGwgQVBJIHJvdXRlc1xuaWYgKCFpc1Rlc3QpIHtcbiAgYXBwLnVzZSgnL2FwaS92MScsIGFwaUxpbWl0ZXIpO1xufVxuXG4vLyBTZWN1cml0eSBtaWRkbGV3YXJlc1xuYXBwLnVzZShocHAoKSBhcyBhbnkpO1xuYXBwLnVzZSh4c3NDbGVhbigpIGFzIGFueSk7XG5cbi8vIGFwcC51c2UocmVzcG9uc2VUaW1lKCkpO1xuXG4vLyBQZXJmb3JtYW5jZSBNaWRkbGV3YXJlXG5hcHAudXNlKFxuICBjb21wcmVzc2lvbih7XG4gICAgbGV2ZWw6IDcsIC8vIFNsaWdodGx5IGhpZ2hlciBjb21wcmVzc2lvblxuICAgIHRocmVzaG9sZDogNTEyLCAvLyBDb21wcmVzcyBzbWFsbGVyIHBheWxvYWRzIGZvciBtb2JpbGUgc3BlZWRcbiAgfSkgYXMgYW55LFxuKTtcblxuLy8gTG9nZ2luZyBNaWRkbGV3YXJlXG5hcHAudXNlKFxuICBtb3JnYW4oJ2NvbWJpbmVkJywge1xuICAgIHN0cmVhbToge1xuICAgICAgd3JpdGU6IChtZXNzYWdlOiBzdHJpbmcpID0+IGxvZ2dlci5pbmZvKG1lc3NhZ2UudHJpbSgpKSxcbiAgICB9LFxuICAgIHNraXA6IChyZXE6IFJlcXVlc3QpID0+IHJlcS51cmwgPT09ICcvYXBpL3YxL2hlYWx0aCcsXG4gIH0pLFxuKTtcblxuLy8gUmVxdWVzdCBQYXJzaW5nXG5hcHAudXNlKFxuICBleHByZXNzLmpzb24oe1xuICAgIGxpbWl0OiAnMTBtYicsXG4gICAgdmVyaWZ5OiAocmVxOiBhbnksIF9yZXM6IFJlc3BvbnNlLCBidWY6IEJ1ZmZlcikgPT4ge1xuICAgICAgaWYgKHJlcS5vcmlnaW5hbFVybC5pbmNsdWRlcygnL3N0cmlwZS93ZWJob29rJykpIHtcbiAgICAgICAgcmVxLnJhd0JvZHkgPSBidWY7XG4gICAgICB9XG4gICAgfSxcbiAgfSksXG4pO1xuYXBwLnVzZShjb29raWVQYXJzZXIoKSk7XG5cbi8vIE1vdW50IFJvdXRlc1xuc2V0dXBTd2FnZ2VyKGFwcCk7XG5cbi8vIEhlYWx0aCBjaGVja3MgYXJlIG5vdyBoYW5kbGVkIGluIGFwaS12MS5yb3V0ZXMudHNcbmFwcC51c2UoJy9hcGkvdjEnLCByb3V0ZXMpO1xuYXBwLnVzZSgnL21jcCcsIG1jcFJvdXRlcik7XG5hcHAudXNlKCcvZ3JhcGhxbCcsIGNyZWF0ZUdyYXBoUUxSb3V0ZXIoKSk7XG5cbi8vIEVycm9yIGhhbmRsaW5nXG5hcHAudXNlKG5vdEZvdW5kSGFuZGxlcik7XG5hcHAudXNlKGVycm9ySGFuZGxlcik7XG5cbi8vIEdyYWNlZnVsIHNodXRkb3duXG5wcm9jZXNzLm9uKCdTSUdJTlQnLCBhc3luYyAoKSA9PiB7XG4gIGxvZ2dlci5pbmZvKCdTaHV0dGluZyBkb3duIGdyYWNlZnVsbHkuLi4nKTtcbiAgYXdhaXQgcmVkaXNDbGllbnQuZGlzY29ubmVjdCgpO1xuICBwcm9jZXNzLmV4aXQoMCk7XG59KTtcbnByb2Nlc3Mub24oJ1NJR1RFUk0nLCBhc3luYyAoKSA9PiB7XG4gIGxvZ2dlci5pbmZvKCdTaHV0dGluZyBkb3duIGdyYWNlZnVsbHkuLi4nKTtcbiAgYXdhaXQgcmVkaXNDbGllbnQuZGlzY29ubmVjdCgpO1xuICBwcm9jZXNzLmV4aXQoMCk7XG59KTtcblxuZXhwb3J0IHsgYXBwIH07XG4iXSwidmVyc2lvbiI6M30=