{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\qwen-tts.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\qwen-tts.service.ts"],"sourcesContent":["import axios from 'axios';\nimport { injectable } from 'inversify';\nimport { env } from '../config/env.schema';\nimport { logger } from '../utils/logger';\nimport fs from 'fs/promises';\nimport path from 'path';\n\n/**\n * Interface for Qwen TTS parameters\n */\nexport interface QwenTTSOptions {\n  model?: string;\n  voice?: string;\n  format?: 'mp3' | 'wav' | 'pcm';\n  sample_rate?: number;\n  volume?: number;\n  rate?: number;\n  pitch?: number;\n}\n\n@injectable()\nexport class QwenTTSService {\n  private readonly apiKey: string;\n  private readonly baseUrl = 'https://dashscope-intl.aliyuncs.com/api/v1'; // International endpoint\n\n  constructor() {\n    this.apiKey = env.DASHSCOPE_API_KEY || '';\n  }\n\n  /**\n   * Generates audio from text using Qwen3-TTS and saves it to a file\n   * @param text The text to synthesize\n   * @param outputPath Full path where the audio file will be saved\n   * @param options Optional synthesis parameters\n   */\n  async textToSpeech(\n    text: string,\n    outputPath: string,\n    options: QwenTTSOptions = {},\n  ): Promise<string> {\n    try {\n      if (!this.apiKey) {\n        throw new Error('DASHSCOPE_API_KEY is not configured.');\n      }\n\n      logger.info(\n        `[QwenTTSService] Synthesizing voice (Qwen3-TTS) for: \"${text.substring(0, 30)}...\"`,\n      );\n\n      const model = options.model || 'qwen3-tts-1.7b';\n      const voice = options.voice || env.QWEN_TTS_VOICE_ID || 'longxiaomiao';\n      const format = options.format || 'mp3';\n\n      const response = await axios.post(\n        `${this.baseUrl}/services/aigc/text-to-speech/synthesis`,\n        {\n          model,\n          input: {\n            text,\n          },\n          parameters: {\n            voice,\n            format,\n            sample_rate: options.sample_rate || 16000,\n            volume: options.volume || 50,\n            rate: options.rate || 1.0,\n            pitch: options.pitch || 1.0,\n          },\n        },\n        {\n          headers: {\n            Authorization: `Bearer ${this.apiKey}`,\n            'Content-Type': 'application/json',\n            'X-DashScope-SSE': 'disable',\n          },\n          responseType: 'arraybuffer',\n        },\n      );\n\n      const buffer = Buffer.from(response.data);\n\n      // Ensure directory exists\n      const dir = path.dirname(outputPath);\n      await fs.mkdir(dir, { recursive: true });\n\n      await fs.writeFile(outputPath, buffer);\n\n      logger.info(`[QwenTTSService] Audio saved to: ${outputPath}`);\n      return outputPath;\n    } catch (error: any) {\n      const errorMessage = error.response?.data\n        ? Buffer.from(error.response.data).toString()\n        : error.message;\n\n      logger.error('[QwenTTSService] Synthesis failed:', errorMessage);\n      throw new Error(`Qwen3 TTS failed: ${error.message}`);\n    }\n  }\n\n  /**\n   * List available voices (Note: DashScope might not have a direct endpoint for this via public API,\n   * usually it's documented in their console. This is a placeholder for future extension.)\n   */\n  async getVoices(): Promise<string[]> {\n    // Standard voices: longxiaomiao, longxiaolan, longxiaoying, etc.\n    return ['longxiaomiao', 'longxiaolan', 'longxiaoying', 'longxiaoxia', 'longxiaomeng'];\n  }\n}\n"],"version":3}