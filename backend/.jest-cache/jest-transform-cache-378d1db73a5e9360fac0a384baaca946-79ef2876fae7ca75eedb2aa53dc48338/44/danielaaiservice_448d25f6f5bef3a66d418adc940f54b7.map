{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\daniela-ai.service.ts","mappings":";;;;;;;;;;;;AAAA,yCAAuC;AAEvC,4CAAyC;AAkBzC;;;GAGG;AAEI,IAAM,gBAAgB,GAAtB,MAAM,gBAAgB;IACnB,QAAQ,GAAG,IAAI,GAAG,EAA0B,CAAC;IAC7C,SAAS,GAAqB,IAAI,CAAC;IACnC,gBAAgB,GAA4B,IAAI,CAAC;IACjD,WAAW,GAAuB,IAAI,CAAC;IACvC,eAAe,GAA+B,IAAI,CAAC;IACnD,UAAU,GAAsB,IAAI,CAAC;IACrC,cAAc,GAA0B,IAAI,CAAC;IAErD;QACE,IAAI,CAAC,UAAU,EAAE,CAAC;IACpB,CAAC;IAEO,UAAU;QAChB,IAAI,CAAC;YACH,+DAA+D;YAC/D,eAAM,CAAC,IAAI,CAAC,mCAAmC,CAAC,CAAC;QACnD,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,IAAI,CAAC,2CAA2C,EAAE,KAAK,CAAC,CAAC;QAClE,CAAC;IACH,CAAC;IAED;;OAEG;IACK,kBAAkB,CACxB,MAAc,EACd,QAAgB,EAChB,MAAc,EACd,QAAgB;QAEhB,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,MAAM,CAAC,EAAE,CAAC;YAC/B,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,MAAM,EAAE;gBACxB,MAAM;gBACN,MAAM;gBACN,QAAQ;gBACR,QAAQ;gBACR,mBAAmB,EAAE,EAAE;gBACvB,UAAU,EAAE,IAAI,IAAI,EAAE;gBACtB,IAAI,EAAE,WAAW;aAClB,CAAC,CAAC;QACL,CAAC;QACD,OAAO,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,MAAM,CAAE,CAAC;IACpC,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,cAAc,CAClB,MAAc,EACd,OAAe,EACf,QAAgB,EAChB,MAAc,EACd,WAAmB,MAAM;QAEzB,IAAI,CAAC;YACH,MAAM,OAAO,GAAG,IAAI,CAAC,kBAAkB,CAAC,MAAM,EAAE,QAAQ,EAAE,MAAM,EAAE,QAAQ,CAAC,CAAC;YAC5E,OAAO,CAAC,UAAU,GAAG,IAAI,IAAI,EAAE,CAAC;YAEhC,8BAA8B;YAC9B,OAAO,CAAC,mBAAmB,CAAC,IAAI,CAAC;gBAC/B,IAAI,EAAE,MAAM;gBACZ,OAAO,EAAE,OAAO;aACjB,CAAC,CAAC;YAEH,4CAA4C;YAC5C,OAAO,CAAC,IAAI,GAAG,IAAI,CAAC,aAAa,CAAC,OAAO,CAAC,CAAC;YAE3C,4DAA4D;YAC5D,MAAM,WAAW,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,CAAC;YAEtD,2BAA2B;YAC3B,MAAM,QAAQ,GAAG,MAAM,IAAI,CAAC,gBAAgB,CAAC,OAAO,EAAE,OAAO,EAAE,WAAW,CAAC,CAAC;YAE5E,iCAAiC;YACjC,OAAO,CAAC,mBAAmB,CAAC,IAAI,CAAC;gBAC/B,IAAI,EAAE,SAAS;gBACf,OAAO,EAAE,QAAQ;aAClB,CAAC,CAAC;YAEH,8BAA8B;YAC9B,IAAI,OAAO,CAAC,mBAAmB,CAAC,MAAM,GAAG,EAAE,EAAE,CAAC;gBAC5C,OAAO,CAAC,mBAAmB,GAAG,OAAO,CAAC,mBAAmB,CAAC,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC;YACvE,CAAC;YAED,wBAAwB;YACxB,MAAM,IAAI,CAAC,cAAc,CAAC,MAAM,EAAE,OAAO,EAAE,QAAQ,CAAC,CAAC;YAErD,OAAO,QAAQ,CAAC;QAClB,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,sCAAsC,EAAE,KAAK,CAAC,CAAC;YAC5D,OAAO,6EAA6E,CAAC;QACvF,CAAC;IACH,CAAC;IAED;;OAEG;IACK,KAAK,CAAC,gBAAgB,CAC5B,OAAuB,EACvB,OAAe,EACf,WAAgB;QAEhB,MAAM,YAAY,GAAG,IAAI,CAAC,iBAAiB,CAAC,OAAO,EAAE,WAAW,CAAC,CAAC;QAClE,MAAM,mBAAmB,GAAG,IAAI,CAAC,wBAAwB,CAAC,OAAO,CAAC,CAAC;QAEnE,iCAAiC;QACjC,MAAM,MAAM,GAAG,IAAI,CAAC,YAAY,CAAC,OAAO,CAAC,CAAC;QAE1C,QAAQ,MAAM,EAAE,CAAC;YACf,KAAK,WAAW;gBACd,OAAO,MAAM,IAAI,CAAC,sBAAsB,CAAC,OAAO,EAAE,OAAO,EAAE,WAAW,CAAC,CAAC;YAC1E,KAAK,SAAS;gBACZ,OAAO,MAAM,IAAI,CAAC,oBAAoB,CAAC,OAAO,EAAE,OAAO,EAAE,WAAW,CAAC,CAAC;YACxE,KAAK,QAAQ;gBACX,OAAO,MAAM,IAAI,CAAC,mBAAmB,CAAC,OAAO,EAAE,OAAO,EAAE,WAAW,CAAC,CAAC;YACvE,KAAK,MAAM;gBACT,OAAO,MAAM,IAAI,CAAC,iBAAiB,CAAC,OAAO,EAAE,OAAO,EAAE,WAAW,CAAC,CAAC;YACrE,KAAK,SAAS;gBACZ,OAAO,MAAM,IAAI,CAAC,oBAAoB,CAAC,OAAO,EAAE,OAAO,EAAE,WAAW,CAAC,CAAC;YACxE,KAAK,UAAU;gBACb,OAAO,IAAI,CAAC,gBAAgB,CAAC,OAAO,CAAC,CAAC;YACxC;gBACE,OAAO,MAAM,IAAI,CAAC,uBAAuB,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;QAChE,CAAC;IACH,CAAC;IAED;;OAEG;IACK,iBAAiB,CAAC,OAAuB,EAAE,WAAgB;QACjE,OAAO;;;;kBAIO,OAAO,CAAC,IAAI;;;YAGlB,OAAO,CAAC,QAAQ;SACnB,OAAO,CAAC,QAAQ;uBACF,WAAW,EAAE,cAAc,IAAI,CAAC;uBAChC,WAAW,EAAE,YAAY,IAAI,CAAC;gBACrC,WAAW,EAAE,UAAU,IAAI,KAAK;;;;;;;;;;;cAY1C,OAAO,CAAC,mBAAmB,CAAC,MAAM,GAAG,CAAC;YACpC,CAAC,CAAC,8BAA8B;YAChC,CAAC,CAAC,wBACN,GAAG,CAAC;IACN,CAAC;IAED;;OAEG;IACK,wBAAwB,CAAC,OAAuB;QACtD,IAAI,OAAO,CAAC,mBAAmB,CAAC,MAAM,KAAK,CAAC;YAAE,OAAO,EAAE,CAAC;QAExD,OAAO,OAAO,CAAC,mBAAmB;aAC/B,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,qBAAqB;aAC/B,GAAG,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,GAAG,CAAC,IAAI,KAAK,MAAM,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,IAAI,KAAK,GAAG,CAAC,OAAO,EAAE,CAAC;aAClE,IAAI,CAAC,IAAI,CAAC,CAAC;IAChB,CAAC;IAED;;OAEG;IACK,YAAY,CAAC,OAAe;QAClC,MAAM,YAAY,GAAG,OAAO,CAAC,WAAW,EAAE,CAAC;QAE3C,IACE,YAAY,CAAC,QAAQ,CAAC,WAAW,CAAC;YAClC,YAAY,CAAC,QAAQ,CAAC,OAAO,CAAC;YAC9B,YAAY,CAAC,QAAQ,CAAC,UAAU,CAAC;YACjC,YAAY,CAAC,QAAQ,CAAC,cAAc,CAAC,EACrC,CAAC;YACD,OAAO,WAAW,CAAC;QACrB,CAAC;QAED,IACE,YAAY,CAAC,QAAQ,CAAC,KAAK,CAAC;YAC5B,YAAY,CAAC,QAAQ,CAAC,KAAK,CAAC;YAC5B,YAAY,CAAC,QAAQ,CAAC,QAAQ,CAAC;YAC/B,YAAY,CAAC,QAAQ,CAAC,QAAQ,CAAC;YAC/B,YAAY,CAAC,QAAQ,CAAC,UAAU,CAAC;YACjC,YAAY,CAAC,QAAQ,CAAC,UAAU,CAAC;YACjC,YAAY,CAAC,QAAQ,CAAC,QAAQ,CAAC;YAC/B,YAAY,CAAC,QAAQ,CAAC,SAAS,CAAC,EAChC,CAAC;YACD,OAAO,SAAS,CAAC;QACnB,CAAC;QAED,IACE,YAAY,CAAC,QAAQ,CAAC,SAAS,CAAC;YAChC,YAAY,CAAC,QAAQ,CAAC,OAAO,CAAC;YAC9B,YAAY,CAAC,QAAQ,CAAC,YAAY,CAAC;YACnC,YAAY,CAAC,QAAQ,CAAC,SAAS,CAAC,EAChC,CAAC;YACD,OAAO,QAAQ,CAAC;QAClB,CAAC;QAED,IACE,YAAY,CAAC,QAAQ,CAAC,OAAO,CAAC;YAC9B,YAAY,CAAC,QAAQ,CAAC,OAAO,CAAC;YAC9B,YAAY,CAAC,QAAQ,CAAC,SAAS,CAAC;YAChC,YAAY,CAAC,QAAQ,CAAC,WAAW,CAAC,EAClC,CAAC;YACD,OAAO,MAAM,CAAC;QAChB,CAAC;QAED,IACE,YAAY,CAAC,QAAQ,CAAC,SAAS,CAAC;YAChC,YAAY,CAAC,QAAQ,CAAC,WAAW,CAAC;YAClC,YAAY,CAAC,QAAQ,CAAC,QAAQ,CAAC;YAC/B,YAAY,CAAC,QAAQ,CAAC,SAAS,CAAC,EAChC,CAAC;YACD,OAAO,SAAS,CAAC;QACnB,CAAC;QAED,IACE,YAAY,CAAC,QAAQ,CAAC,MAAM,CAAC;YAC7B,YAAY,CAAC,QAAQ,CAAC,aAAa,CAAC;YACpC,YAAY,CAAC,QAAQ,CAAC,eAAe,CAAC,EACtC,CAAC;YACD,OAAO,UAAU,CAAC;QACpB,CAAC;QAED,OAAO,SAAS,CAAC;IACnB,CAAC;IAED;;OAEG;IACK,KAAK,CAAC,sBAAsB,CAClC,OAAuB,EACvB,OAAe,EACf,WAAgB;QAEhB,MAAM,KAAK,GAAG,IAAI,CAAC;QACnB,OAAO,CACL,GAAG,KAAK,mBAAmB,OAAO,CAAC,QAAQ,OAAO;YAClD,oBAAoB;YACpB,iBAAiB,WAAW,EAAE,UAAU,IAAI,KAAK,IAAI;YACrD,wBAAwB,WAAW,EAAE,cAAc,IAAI,CAAC,IAAI;YAC5D,yBAAyB,WAAW,EAAE,cAAc,IAAI,EAAE,IAAI;YAC9D,2BAA2B,WAAW,EAAE,cAAc,IAAI,KAAK,MAAM;YACrE,wBAAwB;YACxB,uDAAuD;YACvD,+CAA+C;YAC/C,2CAA2C;YAC3C,wCAAwC,CACzC,CAAC;IACJ,CAAC;IAED;;OAEG;IACK,KAAK,CAAC,oBAAoB,CAChC,OAAuB,EACvB,OAAe,EACf,WAAgB;QAEhB,MAAM,MAAM,GAAG,IAAI,CAAC,cAAc;YAChC,CAAC,CAAC,MAAM,IAAI,CAAC,cAAc,CAAC,uBAAuB,EAAE;YACrD,CAAC,CAAC,wEAAwE,CAAC;QAE7E,MAAM,MAAM,GAAG,IAAI,CAAC,cAAc;YAChC,CAAC,CAAC,CAAC,MAAM,IAAI,CAAC,cAAc,CAAC,mBAAmB,EAAE,CAAC,CAAC,MAAM;YAC1D,CAAC,CAAC,6DAA6D,CAAC;QAElE,OAAO,CACL,gCAAgC,OAAO,CAAC,QAAQ,OAAO;YACvD,MAAM;YACN,OAAO,MAAM,MAAM;YACnB,qDAAqD,CACtD,CAAC;IACJ,CAAC;IACO,KAAK,CAAC,mBAAmB,CAC/B,OAAuB,EACvB,OAAe,EACf,WAAgB;QAEhB,MAAM,KAAK,GAAG,IAAI,CAAC;QACnB,OAAO,CACL,GAAG,KAAK,8BAA8B,OAAO,CAAC,QAAQ,OAAO;YAC7D,qCAAqC;YACrC,uFAAuF;YACvF,qEAAqE;YACrE,uFAAuF;YACvF,+EAA+E;YAC/E,0BAA0B;YAC1B,0DAA0D;YAC1D,2CAA2C,CAC5C,CAAC;IACJ,CAAC;IAED;;OAEG;IACK,KAAK,CAAC,iBAAiB,CAC7B,OAAuB,EACvB,OAAe,EACf,WAAgB;QAEhB,OAAO,CACL,2BAA2B;YAC3B,+BAA+B;YAC/B,yCAAyC;YACzC,0CAA0C;YAC1C,iDAAiD;YACjD,wBAAwB;YACxB,oCAAoC;YACpC,sCAAsC;YACtC,oBAAoB;YACpB,0BAA0B;YAC1B,gCAAgC;YAChC,iCAAiC;YACjC,+BAA+B,CAChC,CAAC;IACJ,CAAC;IAED;;OAEG;IACK,KAAK,CAAC,oBAAoB,CAChC,OAAuB,EACvB,OAAe,EACf,WAAgB;QAEhB,OAAO,CACL,gCAAgC;YAChC,+BAA+B;YAC/B,2CAA2C;YAC3C,sDAAsD;YACtD,6CAA6C;YAC7C,0DAA0D;YAC1D,uBAAuB;YACvB,+CAA+C;YAC/C,wCAAwC;YACxC,6CAA6C;YAC7C,wCAAwC,CACzC,CAAC;IACJ,CAAC;IAED;;OAEG;IACK,gBAAgB,CAAC,OAAuB;QAC9C,MAAM,IAAI,GAAG,IAAI,IAAI,EAAE,CAAC,QAAQ,EAAE,CAAC;QACnC,MAAM,QAAQ,GACZ,IAAI,GAAG,EAAE,CAAC,CAAC,CAAC,eAAe,CAAC,CAAC,CAAC,IAAI,GAAG,EAAE,CAAC,CAAC,CAAC,iBAAiB,CAAC,CAAC,CAAC,iBAAiB,CAAC;QAElF,OAAO,CACL,MAAM,QAAQ,IAAI,OAAO,CAAC,QAAQ,MAAM;YACxC,sCAAsC;YACtC,kBAAkB;YAClB,yBAAyB;YACzB,0BAA0B;YAC1B,yBAAyB;YACzB,4BAA4B,CAC7B,CAAC;IACJ,CAAC;IAED;;OAEG;IACK,KAAK,CAAC,uBAAuB,CAAC,OAAuB,EAAE,OAAe;QAC5E,6CAA6C;QAC7C,0DAA0D;QAC1D,OAAO,CACL,iBAAiB,OAAO,MAAM;YAC9B,iDAAiD;YACjD,mBAAmB;YACnB,oBAAoB;YACpB,2BAA2B;YAC3B,qBAAqB;YACrB,8BAA8B;YAC9B,oCAAoC,CACrC,CAAC;IACJ,CAAC;IAED;;OAEG;IACK,aAAa,CAAC,OAAe;QACnC,MAAM,YAAY,GAAG,OAAO,CAAC,WAAW,EAAE,CAAC;QAE3C,IAAI,YAAY,CAAC,QAAQ,CAAC,OAAO,CAAC,IAAI,YAAY,CAAC,QAAQ,CAAC,SAAS,CAAC;YAAE,OAAO,YAAY,CAAC;QAC5F,IAAI,YAAY,CAAC,QAAQ,CAAC,OAAO,CAAC,IAAI,YAAY,CAAC,QAAQ,CAAC,UAAU,CAAC;YAAE,OAAO,YAAY,CAAC;QAC7F,IAAI,YAAY,CAAC,QAAQ,CAAC,MAAM,CAAC,IAAI,YAAY,CAAC,QAAQ,CAAC,YAAY,CAAC;YAAE,OAAO,WAAW,CAAC;QAC7F,IAAI,YAAY,CAAC,QAAQ,CAAC,MAAM,CAAC,IAAI,YAAY,CAAC,QAAQ,CAAC,OAAO,CAAC;YAAE,OAAO,UAAU,CAAC;QAEvF,OAAO,WAAW,CAAC;IACrB,CAAC;IAED;;OAEG;IACK,KAAK,CAAC,cAAc,CAAC,MAAc;QACzC,IAAI,CAAC;YACH,IAAI,IAAI,CAAC,WAAW,EAAE,CAAC;gBACrB,wDAAwD;gBACxD,eAAe;YACjB,CAAC;QACH,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,IAAI,CAAC,6BAA6B,EAAE,KAAK,CAAC,CAAC;QACpD,CAAC;QAED,OAAO;YACL,cAAc,EAAE,CAAC;YACjB,YAAY,EAAE,EAAE;YAChB,cAAc,EAAE,EAAE;YAClB,UAAU,EAAE,KAAK;YACjB,cAAc,EAAE,KAAK;SACtB,CAAC;IACJ,CAAC;IAED;;OAEG;IACK,KAAK,CAAC,cAAc,CAC1B,MAAc,EACd,WAAmB,EACnB,eAAuB;QAEvB,IAAI,CAAC;YACH,eAAM,CAAC,IAAI,CACT,mBAAmB,WAAW,CAAC,SAAS,CAAC,CAAC,EAAE,EAAE,CAAC,mBAAmB,eAAe,CAAC,SAAS,CACzF,CAAC,EACD,EAAE,CACH,KAAK,CACP,CAAC;QACJ,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,IAAI,CAAC,4BAA4B,EAAE,KAAK,CAAC,CAAC;QACnD,CAAC;IACH,CAAC;IAED;;OAEG;IACI,OAAO;QACZ,MAAM,GAAG,GAAG,IAAI,IAAI,EAAE,CAAC;QACvB,MAAM,UAAU,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC,CAAC,WAAW;QAEnD,KAAK,MAAM,CAAC,MAAM,EAAE,OAAO,CAAC,IAAI,IAAI,CAAC,QAAQ,CAAC,OAAO,EAAE,EAAE,CAAC;YACxD,IAAI,GAAG,CAAC,OAAO,EAAE,GAAG,OAAO,CAAC,UAAU,CAAC,OAAO,EAAE,GAAG,UAAU,EAAE,CAAC;gBAC9D,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC;YAC/B,CAAC;QACH,CAAC;IACH,CAAC;IAED;;OAEG;IACI,KAAK,CAAC,WAAW,CAAC,MAAc;QACrC,MAAM,WAAW,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,CAAC;QAEtD,wFAAwF;QACxF,OAAO;YACL;gBACE,OAAO,EAAE,4DACP,WAAW,CAAC,UAAU,IAAI,KAC5B,EAAE;gBACF,MAAM,EAAE,iBAAiB;gBACzB,MAAM,EAAE,2CAA2C;gBACnD,KAAK,EAAE,iBAAiB;gBACxB,EAAE,EAAE,kBAAkB;aACvB;YACD;gBACE,OAAO,EAAE,aAAa,WAAW,CAAC,YAAY,IAAI,EAAE,kCAAkC;gBACtF,MAAM,EAAE,iBAAiB;gBACzB,MAAM,EAAE,sCAAsC;gBAC9C,KAAK,EAAE,eAAe;gBACtB,EAAE,EAAE,gBAAgB;aACrB;YACD;gBACE,OAAO,EAAE,4CAA4C;gBACrD,MAAM,EAAE,oBAAoB;gBAC5B,MAAM,EAAE,2BAA2B;gBACnC,KAAK,EAAE,gBAAgB;gBACvB,EAAE,EAAE,iBAAiB;aACtB;YACD;gBACE,OAAO,EAAE,4CAA4C;gBACrD,MAAM,EAAE,iBAAiB;gBACzB,MAAM,EAAE,2BAA2B;gBACnC,KAAK,EAAE,iBAAiB;gBACxB,EAAE,EAAE,kBAAkB;aACvB;SACF,CAAC;IACJ,CAAC;IAED;;OAEG;IACI,cAAc;QACnB,OAAO,CACL,2BAA2B;YAC3B,+CAA+C;YAC/C,0DAA0D;YAC1D,sDAAsD;YACtD,oDAAoD;YACpD,kDAAkD;YAClD,mDAAmD;YACnD,yDAAyD;YACzD,kCAAkC;YAClC,6BAA6B,CAC9B,CAAC;IACJ,CAAC;CACF,CAAA;AArgBY,4CAAgB;2BAAhB,gBAAgB;IAD5B,IAAA,sBAAU,GAAE;;GACA,gBAAgB,CAqgB5B","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\daniela-ai.service.ts"],"sourcesContent":["import { injectable } from 'inversify';\n\nimport { logger } from '../utils/logger';\nimport { AIService } from './ai.service';\nimport { AnalyticsService } from './analytics.service';\nimport { EconomyService } from './economy.service';\nimport { RagService } from './rag.service';\nimport { UserBehaviorService } from './user-behavior.service';\nimport { UserService } from './user.service';\n\ninterface DanielaContext {\n  userId: string;\n  chatId: number;\n  userName: string;\n  userRole: string;\n  conversationHistory: Array<{ role: string; content: string }>;\n  lastUpdate: Date;\n  mood: 'analytical' | 'supportive' | 'strategic' | 'creative';\n}\n\n/**\n * üíú DANIELA - IA Asistente Avanzada\n * Inteligencia artificial con personalidad y capacidades profesionales\n */\n@injectable()\nexport class DanielaAIService {\n  private contexts = new Map<number, DanielaContext>();\n  private aiService: AIService | null = null;\n  private analyticsService: AnalyticsService | null = null;\n  private userService: UserService | null = null;\n  private behaviorService: UserBehaviorService | null = null;\n  private ragService: RagService | null = null;\n  private economyService: EconomyService | null = null;\n\n  constructor() {\n    this.initialize();\n  }\n\n  private initialize() {\n    try {\n      // Services are optional and can be initialized later if needed\n      logger.info('üíú Daniela AI Service initialized');\n    } catch (error) {\n      logger.warn('Daniela AI Service partial initialization', error);\n    }\n  }\n\n  /**\n   * Obtener contexto del usuario\n   */\n  private getOrCreateContext(\n    chatId: number,\n    userName: string,\n    userId: string,\n    userRole: string,\n  ): DanielaContext {\n    if (!this.contexts.has(chatId)) {\n      this.contexts.set(chatId, {\n        userId,\n        chatId,\n        userName,\n        userRole,\n        conversationHistory: [],\n        lastUpdate: new Date(),\n        mood: 'strategic',\n      });\n    }\n    return this.contexts.get(chatId)!;\n  }\n\n  /**\n   * Procesar mensaje con Daniela\n   */\n  async processMessage(\n    chatId: number,\n    message: string,\n    userName: string,\n    userId: string,\n    userRole: string = 'user',\n  ): Promise<string> {\n    try {\n      const context = this.getOrCreateContext(chatId, userName, userId, userRole);\n      context.lastUpdate = new Date();\n\n      // Agregar mensaje a historial\n      context.conversationHistory.push({\n        role: 'user',\n        content: message,\n      });\n\n      // Determinar el mood basado en el contenido\n      context.mood = this.determineMood(message);\n\n      // Obtener contexto del usuario para respuesta personalizada\n      const userContext = await this.getUserContext(userId);\n\n      // Generar respuesta con IA\n      const response = await this.generateResponse(context, message, userContext);\n\n      // Agregar respuesta al historial\n      context.conversationHistory.push({\n        role: 'daniela',\n        content: response,\n      });\n\n      // Mantener historial limitado\n      if (context.conversationHistory.length > 20) {\n        context.conversationHistory = context.conversationHistory.slice(-20);\n      }\n\n      // Registrar interacci√≥n\n      await this.logInteraction(userId, message, response);\n\n      return response;\n    } catch (error) {\n      logger.error('Error processing message in Daniela:', error);\n      return 'üíú Disculpa, tuve un peque√±o inconveniente. ¬øPuedes reformular tu pregunta?';\n    }\n  }\n\n  /**\n   * Generar respuesta inteligente\n   */\n  private async generateResponse(\n    context: DanielaContext,\n    message: string,\n    userContext: any,\n  ): Promise<string> {\n    const systemPrompt = this.buildSystemPrompt(context, userContext);\n    const conversationContext = this.buildConversationContext(context);\n\n    // Detectar intenci√≥n del usuario\n    const intent = this.detectIntent(message);\n\n    switch (intent) {\n      case 'analytics':\n        return await this.handleAnalyticsRequest(context, message, userContext);\n      case 'economy':\n        return await this.handleEconomyRequest(context, message, userContext);\n      case 'advice':\n        return await this.handleAdviceRequest(context, message, userContext);\n      case 'task':\n        return await this.handleTaskRequest(context, message, userContext);\n      case 'insight':\n        return await this.handleInsightRequest(context, message, userContext);\n      case 'greeting':\n        return this.generateGreeting(context);\n      default:\n        return await this.generateGeneralResponse(context, message);\n    }\n  }\n\n  /**\n   * Construir prompt del sistema\n   */\n  private buildSystemPrompt(context: DanielaContext, userContext: any): string {\n    return `Eres Daniela, una asistente de IA profesional con personalidad c√°lida.\n\nTu nombre: Daniela üíú\nTu rol: Asistente estrat√©gica de IA para AIGesti√≥n.net\nTu modo actual: ${context.mood}\n\nInformaci√≥n del usuario:\n- Nombre: ${context.userName}\n- Rol: ${context.userRole}\n- Proyectos activos: ${userContext?.activeProjects || 0}\n- Tareas pendientes: ${userContext?.pendingTasks || 0}\n- Eficiencia: ${userContext?.efficiency || 'N/A'}\n\nDirectivas:\n1. S√© profesional pero c√°lida\n2. Proporciona insights accionables\n3. Usa emojis cuando sea apropiado\n4. Adapta tu tono al mood: analytical/supportive/strategic/creative\n5. S√© concisa pero completa\n6. Ofrece sugerencias proactivas\n7. Respeta el contexto de la conversaci√≥n\n\nResponde en ${\n      context.conversationHistory.length > 0\n        ? 'continuidad con el historial'\n        : 'forma breve y efectiva'\n    }.`;\n  }\n\n  /**\n   * Construir contexto de conversaci√≥n\n   */\n  private buildConversationContext(context: DanielaContext): string {\n    if (context.conversationHistory.length === 0) return '';\n\n    return context.conversationHistory\n      .slice(-6) // √öltimos 6 mensajes\n      .map(msg => `${msg.role === 'user' ? 'üë§' : 'üíú'}: ${msg.content}`)\n      .join('\\n');\n  }\n\n  /**\n   * Detectar intenci√≥n del usuario\n   */\n  private detectIntent(message: string): string {\n    const lowerMessage = message.toLowerCase();\n\n    if (\n      lowerMessage.includes('analytics') ||\n      lowerMessage.includes('datos') ||\n      lowerMessage.includes('m√©tricas') ||\n      lowerMessage.includes('estad√≠sticas')\n    ) {\n      return 'analytics';\n    }\n\n    if (\n      lowerMessage.includes('oro') ||\n      lowerMessage.includes('xrp') ||\n      lowerMessage.includes('nvidia') ||\n      lowerMessage.includes('google') ||\n      lowerMessage.includes('palantir') ||\n      lowerMessage.includes('econom√≠a') ||\n      lowerMessage.includes('precio') ||\n      lowerMessage.includes('mercado')\n    ) {\n      return 'economy';\n    }\n\n    if (\n      lowerMessage.includes('consejo') ||\n      lowerMessage.includes('ayuda') ||\n      lowerMessage.includes('recomienda') ||\n      lowerMessage.includes('deber√≠a')\n    ) {\n      return 'advice';\n    }\n\n    if (\n      lowerMessage.includes('tarea') ||\n      lowerMessage.includes('crear') ||\n      lowerMessage.includes('asignar') ||\n      lowerMessage.includes('completar')\n    ) {\n      return 'task';\n    }\n\n    if (\n      lowerMessage.includes('insight') ||\n      lowerMessage.includes('tendencia') ||\n      lowerMessage.includes('patr√≥n') ||\n      lowerMessage.includes('analiza')\n    ) {\n      return 'insight';\n    }\n\n    if (\n      lowerMessage.includes('hola') ||\n      lowerMessage.includes('buenos d√≠as') ||\n      lowerMessage.includes('buenas noches')\n    ) {\n      return 'greeting';\n    }\n\n    return 'general';\n  }\n\n  /**\n   * Manejar solicitudes de analytics\n   */\n  private async handleAnalyticsRequest(\n    context: DanielaContext,\n    message: string,\n    userContext: any,\n  ): Promise<string> {\n    const emoji = 'üìä';\n    return (\n      `${emoji} *An√°lisis para ${context.userName}*\\n\\n` +\n      `üìà *Rendimiento*\\n` +\n      `‚Ä¢ Eficiencia: ${userContext?.efficiency || '87%'}\\n` +\n      `‚Ä¢ Proyectos activos: ${userContext?.activeProjects || 5}\\n` +\n      `‚Ä¢ Tareas completadas: ${userContext?.completedTasks || 42}\\n` +\n      `‚Ä¢ Tasa de finalizaci√≥n: ${userContext?.completionRate || '92%'}\\n\\n` +\n      `üí° *Recomendaciones*\\n` +\n      `‚Ä¢ Mant√©n el ritmo actual ¬°Lo est√°s haciendo genial!\\n` +\n      `‚Ä¢ Enf√≥cate en las 3 tareas de mayor impacto\\n` +\n      `‚Ä¢ Dedica tiempo a mentor√≠a del equipo\\n\\n` +\n      `¬øTe gustar√≠a un an√°lisis m√°s profundo?`\n    );\n  }\n\n  /**\n   * Manejar solicitudes de econom√≠a\n   */\n  private async handleEconomyRequest(\n    context: DanielaContext,\n    message: string,\n    userContext: any,\n  ): Promise<string> {\n    const report = this.economyService\n      ? await this.economyService.generateFormattedReport()\n      : 'üìä Actualmente no tengo acceso a los datos del mercado en tiempo real.';\n\n    const advice = this.economyService\n      ? (await this.economyService.getInvestmentAdvice()).advice\n      : 'Estrategia God Mode: Diversificaci√≥n y paciencia son clave.';\n\n    return (\n      `üíú *An√°lisis de Mercado para ${context.userName}*\\n\\n` +\n      report +\n      `\\n\\n${advice}\\n\\n` +\n      `¬øQuieres que profundice en alg√∫n activo espec√≠fico?`\n    );\n  }\n  private async handleAdviceRequest(\n    context: DanielaContext,\n    message: string,\n    userContext: any,\n  ): Promise<string> {\n    const emoji = 'üí°';\n    return (\n      `${emoji} *Consejo estrat√©gico para ${context.userName}*\\n\\n` +\n      `Basado en tu actividad y datos:\\n\\n` +\n      `1Ô∏è‚É£ *Prioriza impacto* - Las tareas de alto valor impacto generan 80% del resultado\\n` +\n      `2Ô∏è‚É£ *Automatiza procesos repetitivos* - Ahorra 5+ horas semanales\\n` +\n      `3Ô∏è‚É£ *Invierte en capacitaci√≥n* - El equipo est√° listo para nuevas responsabilidades\\n` +\n      `4Ô∏è‚É£ *Delega estrat√©gicamente* - Libera tu tiempo para decisiones cr√≠ticas\\n\\n` +\n      `üìå *Acci√≥n inmediata:*\\n` +\n      `Implementa dos de estas recomendaciones esta semana.\\n\\n` +\n      `¬øNecesitas ayuda para implementar alguna?`\n    );\n  }\n\n  /**\n   * Manejar solicitudes de tareas\n   */\n  private async handleTaskRequest(\n    context: DanielaContext,\n    message: string,\n    userContext: any,\n  ): Promise<string> {\n    return (\n      `‚úÖ *Gesti√≥n de Tareas*\\n\\n` +\n      `üìã *Tus tareas pendientes:*\\n` +\n      `1. Revisar propuesta de cliente (Hoy)\\n` +\n      `2. Reuni√≥n de sprint planning (Ma√±ana)\\n` +\n      `3. Documentaci√≥n del proyecto (Esta semana)\\n\\n` +\n      `‚ö° *Tareas urgentes:*\\n` +\n      `‚Ä¢ Responder feedback de revisi√≥n\\n` +\n      `‚Ä¢ Actualizar status del proyecto\\n\\n` +\n      `üí¨ ¬øQuieres que:\\n` +\n      `‚ñ° Cree una nueva tarea\\n` +\n      `‚ñ° Asigne una tarea a alguien\\n` +\n      `‚ñ° Marque algo como completado\\n` +\n      `‚ñ° Analice la carga de trabajo`\n    );\n  }\n\n  /**\n   * Manejar solicitudes de insights\n   */\n  private async handleInsightRequest(\n    context: DanielaContext,\n    message: string,\n    userContext: any,\n  ): Promise<string> {\n    return (\n      `üîç *Insights Estrat√©gicos*\\n\\n` +\n      `üìä *Descubrimientos clave:*\\n` +\n      `‚Ä¢ Tu productividad pico es entre 9-11am\\n` +\n      `‚Ä¢ El 60% de tareas se completan antes del deadline\\n` +\n      `‚Ä¢ Colaboras mejor en sprints de 2 semanas\\n` +\n      `‚Ä¢ Necesitas ~30 min de enfoque para tareas complejas\\n\\n` +\n      `üéØ *Oportunidades:*\\n` +\n      `‚Ä¢ Agrupar reuniones en ventanas espec√≠ficas\\n` +\n      `‚Ä¢ Bloques de enfoque en horario pico\\n` +\n      `‚Ä¢ Microlearning para nuevas habilidades\\n\\n` +\n      `¬øQuieres profundizar en alg√∫n insight?`\n    );\n  }\n\n  /**\n   * Generar saludo personalizado\n   */\n  private generateGreeting(context: DanielaContext): string {\n    const hour = new Date().getHours();\n    const greeting =\n      hour < 12 ? '¬°Buenos d√≠as!' : hour < 18 ? '¬°Buenas tardes!' : '¬°Buenas noches!';\n\n    return (\n      `üíú ${greeting} ${context.userName}\\n\\n` +\n      `Soy Daniela, tu asistente de IA.\\n\\n` +\n      `üìä Hoy tienes:\\n` +\n      `‚Ä¢ 3 tareas pendientes\\n` +\n      `‚Ä¢ 1 reuni√≥n en 2 horas\\n` +\n      `‚Ä¢ Eficiencia al 87%\\n\\n` +\n      `¬øEn qu√© puedo ayudarte? ü§î`\n    );\n  }\n\n  /**\n   * Generar respuesta general\n   */\n  private async generateGeneralResponse(context: DanielaContext, message: string): Promise<string> {\n    // Aqu√≠ ir√≠an llamadas a un modelo de IA real\n    // Por ahora, una respuesta inteligente basada en patrones\n    return (\n      `üíú *Daniela:* ${message}\\n\\n` +\n      `Entiendo tu punto. D√©jame ayudarte con eso.\\n\\n` +\n      `¬øNecesitas que:\\n` +\n      `üìä Analice datos\\n` +\n      `üí° D√© una recomendaci√≥n\\n` +\n      `‚úÖ Gestione tareas\\n` +\n      `üéØ Trabaje en estrategia\\n\\n` +\n      `Dime c√≥mo puedo asistirte mejor üöÄ`\n    );\n  }\n\n  /**\n   * Determinar el mood basado en el contenido\n   */\n  private determineMood(message: string): 'analytical' | 'supportive' | 'strategic' | 'creative' {\n    const lowerMessage = message.toLowerCase();\n\n    if (lowerMessage.includes('ayuda') || lowerMessage.includes('dif√≠cil')) return 'supportive';\n    if (lowerMessage.includes('datos') || lowerMessage.includes('an√°lisis')) return 'analytical';\n    if (lowerMessage.includes('plan') || lowerMessage.includes('estrategia')) return 'strategic';\n    if (lowerMessage.includes('idea') || lowerMessage.includes('crear')) return 'creative';\n\n    return 'strategic';\n  }\n\n  /**\n   * Obtener contexto del usuario\n   */\n  private async getUserContext(userId: string): Promise<any> {\n    try {\n      if (this.userService) {\n        // const user = await this.userService.findById(userId);\n        // return user;\n      }\n    } catch (error) {\n      logger.warn('Error getting user context:', error);\n    }\n\n    return {\n      activeProjects: 5,\n      pendingTasks: 12,\n      completedTasks: 42,\n      efficiency: '87%',\n      completionRate: '92%',\n    };\n  }\n\n  /**\n   * Registrar interacci√≥n\n   */\n  private async logInteraction(\n    userId: string,\n    userMessage: string,\n    danielaResponse: string,\n  ): Promise<void> {\n    try {\n      logger.info(\n        `[DANIELA] User: ${userMessage.substring(0, 50)}... | Response: ${danielaResponse.substring(\n          0,\n          50,\n        )}...`,\n      );\n    } catch (error) {\n      logger.warn('Error logging interaction:', error);\n    }\n  }\n\n  /**\n   * Limpiar contextos antiguos\n   */\n  public cleanup() {\n    const now = new Date();\n    const MAX_AGE_MS = 24 * 60 * 60 * 1000; // 24 horas\n\n    for (const [chatId, context] of this.contexts.entries()) {\n      if (now.getTime() - context.lastUpdate.getTime() > MAX_AGE_MS) {\n        this.contexts.delete(chatId);\n      }\n    }\n  }\n\n  /**\n   * Obtener insights estrat√©gicos para el dashboard\n   */\n  public async getInsights(userId: string): Promise<any[]> {\n    const userContext = await this.getUserContext(userId);\n\n    // Generar insights basados en el contexto real (o simulado por ahora pero estructurado)\n    return [\n      {\n        insight: `üöÄ Detect√© una forma de optimizar tu productividad en un ${\n          userContext.efficiency || '87%'\n        }`,\n        impact: 'üî• Impacto Alto',\n        action: 'Bloquea ventanas de enfoque por la ma√±ana',\n        color: 'text-yellow-400',\n        bg: 'bg-yellow-500/10',\n      },\n      {\n        insight: `ü§ñ Tienes ${userContext.pendingTasks || 12} tareas que pueden automatizarse`,\n        impact: '‚ö° Impacto Medio',\n        action: 'Usa herramientas de flujo de trabajo',\n        color: 'text-blue-400',\n        bg: 'bg-blue-500/10',\n      },\n      {\n        insight: 'üìà Tu tasa de finalizaci√≥n ha subido un 5%',\n        impact: '‚úÖ Impacto Positivo',\n        action: 'Sigue con el ritmo actual',\n        color: 'text-green-400',\n        bg: 'bg-green-500/10',\n      },\n      {\n        insight: 'üë• El equipo rinde mejor en sprints cortos',\n        impact: 'üìö Impacto Bajo',\n        action: 'Prueba ciclos de 1 semana',\n        color: 'text-purple-400',\n        bg: 'bg-purple-500/10',\n      },\n    ];\n  }\n\n  /**\n   * Obtener informaci√≥n sobre Daniela\n   */\n  public getDanielaInfo(): string {\n    return (\n      `üíú *Conoce a Daniela*\\n\\n` +\n      `Soy una asistente de IA especializada en:\\n\\n` +\n      `üéØ *Estrategia* - Ayudo a definir y ejecutar objetivos\\n` +\n      `üìä *Analytics* - Analizo datos y presento insights\\n` +\n      `‚úÖ *Productividad* - Optimizo tu flujo de trabajo\\n` +\n      `üë• *Colaboraci√≥n* - Facilito trabajo en equipo\\n` +\n      `üí° *Innovaci√≥n* - Propongo soluciones creativas\\n` +\n      `üöÄ *Escalabilidad* - Preparo tu negocio para crecer\\n\\n` +\n      `Disponible 24/7 para ayudarte.\\n` +\n      `Powered by AIGesti√≥n.net üåü`\n    );\n  }\n}\n"],"version":3}