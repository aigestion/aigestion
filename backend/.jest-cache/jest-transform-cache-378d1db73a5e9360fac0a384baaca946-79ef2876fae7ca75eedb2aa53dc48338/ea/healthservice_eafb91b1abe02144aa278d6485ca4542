2db0fdaf94aaa81c1da62bbe607565a6
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.HealthService = void 0;
const inversify_1 = require("inversify");
const axios_1 = __importDefault(require("axios"));
const mongoose_1 = __importDefault(require("mongoose"));
const types_1 = require("../types");
const pinecone_service_1 = require("./pinecone.service");
const redis_1 = require("../cache/redis");
const inversify_config_1 = require("../config/inversify.config");
let HealthService = class HealthService {
    pineconeService;
    constructor(pineconeService) {
        this.pineconeService = pineconeService;
    }
    async getDetailedHealth() {
        const results = {
            timestamp: new Date().toISOString(),
            status: 'healthy',
            checks: [],
        };
        // 1. MongoDB Check
        const mongoStatus = mongoose_1.default.connection.readyState === 1 ? 'up' : 'down';
        results.checks.push({ name: 'mongodb', status: mongoStatus });
        if (mongoStatus === 'down')
            results.status = 'degraded';
        // 2. Redis Check
        try {
            const redisClient = (0, redis_1.getRedisClient)();
            const ping = await redisClient.ping();
            results.checks.push({ name: 'redis', status: ping === 'PONG' ? 'up' : 'down' });
        }
        catch (err) {
            results.checks.push({ name: 'redis', status: 'down', error: err.message });
            results.status = 'degraded';
        }
        // 3. Pinecone Check
        try {
            // Simple check to see if Pinecone can be reached
            const index = this.pineconeService.index;
            results.checks.push({ name: 'pinecone', status: index ? 'up' : 'down' });
        }
        catch (err) {
            results.checks.push({ name: 'pinecone', status: 'down', error: err.message });
            results.status = 'degraded';
        }
        // 4. NeuroCore (ML Service) Check
        try {
            const mlServiceUrl = process.env.ML_SERVICE_URL || 'http://ml-service:5000';
            const mlResp = await axios_1.default.get(`${mlServiceUrl}/health`, { timeout: 2000 });
            results.checks.push({
                name: 'neurocore',
                status: mlResp.status === 200 ? 'up' : 'down',
                version: mlResp.data?.version || 'unknown',
            });
        }
        catch (err) {
            results.checks.push({ name: 'neurocore', status: 'down', error: err.message });
            results.status = 'degraded';
        }
        // 5. Malware Engines Check
        try {
            const scanner = inversify_config_1.container.get(types_1.TYPES.MalwareScannerService);
            results.checks.push({
                name: 'malware-scanner',
                status: 'up',
                engines: {
                    clamav: scanner.isClamAVAvailable ? 'active' : 'inactive',
                    yara: scanner.isYARAAvailable ? 'active' : 'inactive',
                },
            });
        }
        catch (err) {
            results.checks.push({ name: 'malware-scanner', status: 'down' });
        }
        // 6. Memory Usage
        const memory = process.memoryUsage();
        results.metrics = {
            rss: `${Math.round(memory.rss / 1024 / 1024)}MB`,
            heapUsed: `${Math.round(memory.heapUsed / 1024 / 1024)}MB`,
        };
        return results;
    }
};
exports.HealthService = HealthService;
exports.HealthService = HealthService = __decorate([
    (0, inversify_1.injectable)(),
    __param(0, (0, inversify_1.inject)(types_1.TYPES.PineconeService)),
    __metadata("design:paramtypes", [typeof (_a = typeof pinecone_service_1.PineconeService !== "undefined" && pinecone_service_1.PineconeService) === "function" ? _a : Object])
], HealthService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxzZXJ2aWNlc1xcaGVhbHRoLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLHlDQUErQztBQUMvQyxrREFBMEI7QUFDMUIsd0RBQWdDO0FBQ2hDLG9DQUFpQztBQUNqQyx5REFBcUQ7QUFDckQsMENBQWdEO0FBQ2hELGlFQUF1RDtBQUloRCxJQUFNLGFBQWEsR0FBbkIsTUFBTSxhQUFhO0lBQzJCO0lBQW5ELFlBQW1ELGVBQWdDO1FBQWhDLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtJQUFHLENBQUM7SUFFaEYsS0FBSyxDQUFDLGlCQUFpQjtRQUM1QixNQUFNLE9BQU8sR0FBUTtZQUNuQixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7WUFDbkMsTUFBTSxFQUFFLFNBQVM7WUFDakIsTUFBTSxFQUFFLEVBQUU7U0FDWCxDQUFDO1FBRUYsbUJBQW1CO1FBQ25CLE1BQU0sV0FBVyxHQUFHLGtCQUFRLENBQUMsVUFBVSxDQUFDLFVBQVUsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO1FBQ3pFLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQztRQUM5RCxJQUFJLFdBQVcsS0FBSyxNQUFNO1lBQUUsT0FBTyxDQUFDLE1BQU0sR0FBRyxVQUFVLENBQUM7UUFFeEQsaUJBQWlCO1FBQ2pCLElBQUksQ0FBQztZQUNILE1BQU0sV0FBVyxHQUFHLElBQUEsc0JBQWMsR0FBRSxDQUFDO1lBQ3JDLE1BQU0sSUFBSSxHQUFHLE1BQU0sV0FBVyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ3RDLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUs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UUFFRCxrQkFBa0I7UUFDbEIsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ3JDLE9BQU8sQ0FBQyxPQUFPLEdBQUc7WUFDaEIsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxHQUFHLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSTtZQUNoRCxRQUFRLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxRQUFRLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJO1NBQzNELENBQUM7UUFFRixPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDO0NBQ0YsQ0FBQTtBQXpFWSxzQ0FBYTt3QkFBYixhQUFhO0lBRHpCLElBQUEsc0JBQVUsR0FBRTtJQUVFLFdBQUEsSUFBQSxrQkFBTSxFQUFDLGFBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQTt5REFBMEIsa0NBQWUsb0JBQWYsa0NBQWU7R0FEeEUsYUFBYSxDQXlFekIiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxzZXJ2aWNlc1xcaGVhbHRoLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaW5qZWN0YWJsZSwgaW5qZWN0IH0gZnJvbSAnaW52ZXJzaWZ5JztcbmltcG9ydCBheGlvcyBmcm9tICdheGlvcyc7XG5pbXBvcnQgbW9uZ29vc2UgZnJvbSAnbW9uZ29vc2UnO1xuaW1wb3J0IHsgVFlQRVMgfSBmcm9tICcuLi90eXBlcyc7XG5pbXBvcnQgeyBQaW5lY29uZVNlcnZpY2UgfSBmcm9tICcuL3BpbmVjb25lLnNlcnZpY2UnO1xuaW1wb3J0IHsgZ2V0UmVkaXNDbGllbnQgfSBmcm9tICcuLi9jYWNoZS9yZWRpcyc7XG5pbXBvcnQgeyBjb250YWluZXIgfSBmcm9tICcuLi9jb25maWcvaW52ZXJzaWZ5LmNvbmZpZyc7XG5pbXBvcnQgeyBNYWx3YXJlU2Nhbm5lclNlcnZpY2UgfSBmcm9tICcuL21hbHdhcmUtc2Nhbm5lci5zZXJ2aWNlJztcblxuQGluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEhlYWx0aFNlcnZpY2Uge1xuICBjb25zdHJ1Y3RvcihAaW5qZWN0KFRZUEVTLlBpbmVjb25lU2VydmljZSkgcHJpdmF0ZSBwaW5lY29uZVNlcnZpY2U6IFBpbmVjb25lU2VydmljZSkge31cblxuICBwdWJsaWMgYXN5bmMgZ2V0RGV0YWlsZWRIZWFsdGgoKSB7XG4gICAgY29uc3QgcmVzdWx0czogYW55ID0ge1xuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICBzdGF0dXM6ICdoZWFsdGh5JyxcbiAgICAgIGNoZWNrczogW10sXG4gICAgfTtcblxuICAgIC8vIDEuIE1vbmdvREIgQ2hlY2tcbiAgICBjb25zdCBtb25nb1N0YXR1cyA9IG1vbmdvb3NlLmNvbm5lY3Rpb24ucmVhZHlTdGF0ZSA9PT0gMSA/ICd1cCcgOiAnZG93bic7XG4gICAgcmVzdWx0cy5jaGVja3MucHVzaCh7IG5hbWU6ICdtb25nb2RiJywgc3RhdHVzOiBtb25nb1N0YXR1cyB9KTtcbiAgICBpZiAobW9uZ29TdGF0dXMgPT09ICdkb3duJykgcmVzdWx0cy5zdGF0dXMgPSAnZGVncmFkZWQnO1xuXG4gICAgLy8gMi4gUmVkaXMgQ2hlY2tcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVkaXNDbGllbnQgPSBnZXRSZWRpc0NsaWVudCgpO1xuICAgICAgY29uc3QgcGluZyA9IGF3YWl0IHJlZGlzQ2xpZW50LnBpbmcoKTtcbiAgICAgIHJlc3VsdHMuY2hlY2tzLnB1c2goeyBuYW1lOiAncmVkaXMnLCBzdGF0dXM6IHBpbmcgPT09ICdQT05HJyA/ICd1cCcgOiAnZG93bicgfSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICByZXN1bHRzLmNoZWNrcy5wdXNoKHsgbmFtZTogJ3JlZGlzJywgc3RhdHVzOiAnZG93bicsIGVycm9yOiAoZXJyIGFzIGFueSkubWVzc2FnZSB9KTtcbiAgICAgIHJlc3VsdHMuc3RhdHVzID0gJ2RlZ3JhZGVkJztcbiAgICB9XG5cbiAgICAvLyAzLiBQaW5lY29uZSBDaGVja1xuICAgIHRyeSB7XG4gICAgICAvLyBTaW1wbGUgY2hlY2sgdG8gc2VlIGlmIFBpbmVjb25lIGNhbiBiZSByZWFjaGVkXG4gICAgICBjb25zdCBpbmRleCA9ICh0aGlzLnBpbmVjb25lU2VydmljZSBhcyBhbnkpLmluZGV4O1xuICAgICAgcmVzdWx0cy5jaGVja3MucHVzaCh7IG5hbWU6ICdwaW5lY29uZScsIHN0YXR1czogaW5kZXggPyAndXAnIDogJ2Rvd24nIH0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgcmVzdWx0cy5jaGVja3MucHVzaCh7IG5hbWU6ICdwaW5lY29uZScsIHN0YXR1czogJ2Rvd24nLCBlcnJvcjogKGVyciBhcyBhbnkpLm1lc3NhZ2UgfSk7XG4gICAgICByZXN1bHRzLnN0YXR1cyA9ICdkZWdyYWRlZCc7XG4gICAgfVxuXG4gICAgLy8gNC4gTmV1cm9Db3JlIChNTCBTZXJ2aWNlKSBDaGVja1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBtbFNlcnZpY2VVcmwgPSBwcm9jZXNzLmVudi5NTF9TRVJWSUNFX1VSTCB8fCAnaHR0cDovL21sLXNlcnZpY2U6NTAwMCc7XG4gICAgICBjb25zdCBtbFJlc3AgPSBhd2FpdCBheGlvcy5nZXQoYCR7bWxTZXJ2aWNlVXJsfS9oZWFsdGhgLCB7IHRpbWVvdXQ6IDIwMDAgfSk7XG4gICAgICByZXN1bHRzLmNoZWNrcy5wdXNoKHtcbiAgICAgICAgbmFtZTogJ25ldXJvY29yZScsXG4gICAgICAgIHN0YXR1czogbWxSZXNwLnN0YXR1cyA9PT0gMjAwID8gJ3VwJyA6ICdkb3duJyxcbiAgICAgICAgdmVyc2lvbjogbWxSZXNwLmRhdGE/LnZlcnNpb24gfHwgJ3Vua25vd24nLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICByZXN1bHRzLmNoZWNrcy5wdXNoKHsgbmFtZTogJ25ldXJvY29yZScsIHN0YXR1czogJ2Rvd24nLCBlcnJvcjogKGVyciBhcyBhbnkpLm1lc3NhZ2UgfSk7XG4gICAgICByZXN1bHRzLnN0YXR1cyA9ICdkZWdyYWRlZCc7XG4gICAgfVxuXG4gICAgLy8gNS4gTWFsd2FyZSBFbmdpbmVzIENoZWNrXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHNjYW5uZXIgPSBjb250YWluZXIuZ2V0PE1hbHdhcmVTY2FubmVyU2VydmljZT4oVFlQRVMuTWFsd2FyZVNjYW5uZXJTZXJ2aWNlKTtcbiAgICAgIHJlc3VsdHMuY2hlY2tzLnB1c2goe1xuICAgICAgICBuYW1lOiAnbWFsd2FyZS1zY2FubmVyJyxcbiAgICAgICAgc3RhdHVzOiAndXAnLFxuICAgICAgICBlbmdpbmVzOiB7XG4gICAgICAgICAgY2xhbWF2OiAoc2Nhbm5lciBhcyBhbnkpLmlzQ2xhbUFWQXZhaWxhYmxlID8gJ2FjdGl2ZScgOiAnaW5hY3RpdmUnLFxuICAgICAgICAgIHlhcmE6IChzY2FubmVyIGFzIGFueSkuaXNZQVJBQXZhaWxhYmxlID8gJ2FjdGl2ZScgOiAnaW5hY3RpdmUnLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICByZXN1bHRzLmNoZWNrcy5wdXNoKHsgbmFtZTogJ21hbHdhcmUtc2Nhbm5lcicsIHN0YXR1czogJ2Rvd24nIH0pO1xuICAgIH1cblxuICAgIC8vIDYuIE1lbW9yeSBVc2FnZVxuICAgIGNvbnN0IG1lbW9yeSA9IHByb2Nlc3MubWVtb3J5VXNhZ2UoKTtcbiAgICByZXN1bHRzLm1ldHJpY3MgPSB7XG4gICAgICByc3M6IGAke01hdGgucm91bmQobWVtb3J5LnJzcyAvIDEwMjQgLyAxMDI0KX1NQmAsXG4gICAgICBoZWFwVXNlZDogYCR7TWF0aC5yb3VuZChtZW1vcnkuaGVhcFVzZWQgLyAxMDI0IC8gMTAyNCl9TUJgLFxuICAgIH07XG5cbiAgICByZXR1cm4gcmVzdWx0cztcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9