380356fe116e13e6cce0373f629e3dca
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.MalwareScannerService = void 0;
const axios_1 = __importDefault(require("axios"));
const child_process_1 = require("child_process");
const crypto_1 = __importDefault(require("crypto"));
const promises_1 = __importDefault(require("fs/promises"));
const inversify_1 = require("inversify");
const path_1 = __importDefault(require("path"));
const util_1 = require("util");
const logger_1 = require("../utils/logger");
const malware_scanner_config_1 = require("../config/malware-scanner.config");
const execAsync = (0, util_1.promisify)(child_process_1.exec);
let MalwareScannerService = class MalwareScannerService {
    quarantineDir = malware_scanner_config_1.malwareScannerConfig.quarantineDir;
    scanCache = new Map();
    cacheTimeout = malware_scanner_config_1.malwareScannerConfig.cacheTimeout;
    isClamAVAvailable = false;
    isYARAAvailable = false;
    constructor() {
        this.initializeQuarantine();
        this.checkEngines();
    }
    async checkEngines() {
        try {
            await execAsync('clamscan --version');
            this.isClamAVAvailable = true;
            logger_1.logger.info('ClamAV engine detected and ready');
        }
        catch (error) {
            logger_1.logger.warn('ClamAV engine not found, ClamAV scanning will be skipped');
        }
        try {
            await execAsync('yara --version');
            this.isYARAAvailable = true;
            logger_1.logger.info('YARA engine detected and ready');
        }
        catch (error) {
            logger_1.logger.warn('YARA engine not found, YARA scanning will be skipped');
        }
    }
    async initializeQuarantine() {
        try {
            await promises_1.default.mkdir(this.quarantineDir, { recursive: true });
            logger_1.logger.info('Malware scanner quarantine directory initialized');
        }
        catch (error) {
            logger_1.logger.error('Failed to initialize quarantine directory:', error);
        }
    }
    async scanFile(filePath, userId) {
        const startTime = Date.now();
        try {
            // Check file exists
            const stats = await promises_1.default.stat(filePath);
            const fileBuffer = await promises_1.default.readFile(filePath);
            const hash = this.calculateHash(fileBuffer);
            // Check cache first
            const cached = this.scanCache.get(hash);
            if (cached && Date.now() - cached.timestamp.getTime() < this.cacheTimeout) {
                logger_1.logger.info('Using cached scan result', { file: filePath, hash });
                return cached;
            }
            // Determine file type
            const mimeType = await this.detectMimeType(fileBuffer);
            // Scan with multiple engines
            const scanResults = await Promise.allSettled([
                this.scanWithClamAV(filePath),
                this.scanWithYARA(filePath),
                this.scanWithCustomRules(fileBuffer, mimeType),
                this.scanWithVirusTotal(hash),
            ]);
            // Aggregate results
            const threats = [];
            let isInfected = false;
            scanResults.forEach((result, index) => {
                if (result.status === 'fulfilled') {
                    if (result.value.isInfected) {
                        isInfected = true;
                        threats.push(...result.value.threats);
                    }
                    logger_1.logger.debug(`Scan engine ${index} result:`, result.value);
                }
                else {
                    logger_1.logger.warn(`Scan engine ${index} failed:`, result.reason);
                }
            });
            const scanResult = {
                file: filePath,
                hash,
                size: stats.size,
                mimeType,
                isInfected,
                threats: [...new Set(threats)], // Remove duplicates
                scanTime: Date.now() - startTime,
                engine: 'multi-engine',
                timestamp: new Date(),
            };
            // Cache result
            this.scanCache.set(hash, scanResult);
            // Quarantine if infected
            if (isInfected) {
                await this.quarantineFile(filePath, scanResult, userId);
                logger_1.logger.warn('Malware detected and quarantined', {
                    file: filePath,
                    hash,
                    threats: scanResult.threats,
                    userId,
                });
            }
            else {
                logger_1.logger.info('File scan completed - clean', {
                    file: filePath,
                    hash,
                    scanTime: scanResult.scanTime,
                });
            }
            return scanResult;
        }
        catch (error) {
            logger_1.logger.error('Error scanning file:', { filePath, error });
            throw new Error(`Failed to scan file: ${error}`);
        }
    }
    async scanWithClamAV(filePath) {
        if (!this.isClamAVAvailable) {
            return { isInfected: false, threats: [] };
        }
        try {
            const { stdout } = await execAsync(`clamscan --no-summary "${filePath}"`);
            if (stdout.includes('FOUND')) {
                const threats = stdout
                    .split('\n')
                    .filter(line => line.includes('FOUND'))
                    .map(line => line.split(':')[0].trim());
                return { isInfected: true, threats };
            }
            return { isInfected: false, threats: [] };
        }
        catch (error) {
            logger_1.logger.warn('ClamAV scan failed:', error);
            return { isInfected: false, threats: [] };
        }
    }
    async scanWithYARA(filePath) {
        if (!this.isYARAAvailable) {
            return { isInfected: false, threats: [] };
        }
        try {
            const { stdout } = await execAsync(`yara ${malware_scanner_config_1.malwareScannerConfig.yaraRulesPath} "${filePath}"`);
            if (stdout.trim()) {
                const threats = stdout.split('\n').filter(line => line.trim());
                return { isInfected: true, threats };
            }
            return { isInfected: false, threats: [] };
        }
        catch (error) {
            logger_1.logger.warn('YARA scan failed:', error);
            return { isInfected: false, threats: [] };
        }
    }
    async scanWithCustomRules(buffer, mimeType) {
        const threats = [];
        // Check for suspicious patterns
        const suspiciousPatterns = [
            { pattern: /eval\s*\(/i, threat: 'JavaScript/PHP eval function' },
            { pattern: /<script[^>]*>/i, threat: 'Embedded script tag' },
            { pattern: /javascript:/i, threat: 'JavaScript protocol' },
            { pattern: /vbscript:/i, threat: 'VBScript protocol' },
            { pattern: /data:text\/html/i, threat: 'Data URI HTML' },
            { pattern: /PK\x03\x04/, threat: 'ZIP archive (potential payload)' },
            { pattern: /MZ\x90\x00/, threat: 'PE executable' },
            { pattern: /\x7fELF/, threat: 'ELF executable' },
            { pattern: /exec\s*\(/i, threat: 'System command execution' },
            { pattern: /passthru\s*\(/i, threat: 'PHP passthru' },
            { pattern: /shell_exec\s*\(/i, threat: 'PHP shell_exec' },
            { pattern: /system\s*\(/i, threat: 'System call' },
            { pattern: /base64_decode\s*\(/i, threat: 'Base64 decoding (potential obfuscation)' },
            { pattern: /unescape\s*\(|decodeURIComponent\s*\(/i, threat: 'JavaScript de-obfuscation' },
            { pattern: /document\.write\s*\(/i, threat: 'Suspicious DOM manipulation' },
            { pattern: /String\.fromCharCode/i, threat: 'JavaScript character code obfuscation' },
            // Advanced Heuristics
            { pattern: /Invoke-Expression|IEX/i, threat: 'PowerShell remote execution' },
            { pattern: /WScript\.Shell|WshShell/i, threat: 'Windows Script Host manipulation' },
            {
                pattern: /AutoOpen|AutoExec|Document_Open|Workbook_Open/i,
                threat: 'Office Macro Auto-execution',
            },
            { pattern: /vbaProject\.bin/i, threat: 'Embedded VBA Project' },
            { pattern: /python\s+-c|base64\s+-d\s*\|\s*sh/i, threat: 'In-place script execution' },
        ];
        const content = buffer.toString('binary');
        for (const { pattern, threat } of suspiciousPatterns) {
            if (pattern.test(content)) {
                threats.push(threat);
            }
        }
        // Check file extension vs MIME type mismatch
        const suspiciousExtensions = [
            '.exe',
            '.scr',
            '.bat',
            '.cmd',
            '.com',
            '.pif',
            '.vbs',
            '.js',
            '.jar',
        ];
        const hasSuspiciousExtension = suspiciousExtensions.some(ext => content.toLowerCase().includes(ext));
        if (hasSuspiciousExtension && !mimeType.startsWith('application/octet-stream')) {
            threats.push('Suspicious file extension');
        }
        // Check for encrypted/obfuscated content
        const entropy = this.calculateEntropy(buffer);
        if (entropy > 7.0) {
            threats.push('High entropy (possible encryption/obfuscation)');
        }
        // Check for large base64 strings (potential encoded payloads)
        const base64Matches = content.match(/[A-Za-z0-9+/]{100,}={0,2}/g);
        if (base64Matches && base64Matches.length > 0) {
            threats.push('Large base64 strings detected');
        }
        return {
            isInfected: threats.length > 0,
            threats,
        };
    }
    async scanWithVirusTotal(hash) {
        try {
            const apiKey = process.env.VIRUSTOTAL_API_KEY;
            if (!apiKey) {
                logger_1.logger.debug('VirusTotal API key not found, skipping scan', { hash });
                return { isInfected: false, threats: [] };
            }
            const response = await axios_1.default.get(`https://www.virustotal.com/api/v3/files/${hash}`, {
                headers: {
                    'x-apikey': apiKey,
                },
                validateStatus: (status) => status === 200 || status === 404,
            });
            if (response.status === 404) {
                logger_1.logger.debug('File hash not found in VirusTotal database', { hash });
                return { isInfected: false, threats: [] };
            }
            const { data } = response.data;
            const lastAnalysisStats = data.attributes.last_analysis_stats;
            const maliciousCount = lastAnalysisStats.malicious || 0;
            const suspiciousCount = lastAnalysisStats.suspicious || 0;
            if (maliciousCount > 0 || suspiciousCount > 2) {
                const maliciousThreats = Object.values(data.attributes.last_analysis_results)
                    .filter(r => r.category === 'malicious')
                    .map(r => r.result)
                    .filter(Boolean);
                return {
                    isInfected: true,
                    threats: [
                        `VirusTotal: ${maliciousCount} engines detected threats`,
                        ...maliciousThreats.slice(0, 3),
                    ],
                };
            }
            return { isInfected: false, threats: [] };
        }
        catch (error) {
            logger_1.logger.warn('VirusTotal scan failed:', error);
            return { isInfected: false, threats: [] };
        }
    }
    async quarantineFile(filePath, scanResult, userId) {
        try {
            const fileName = path_1.default.basename(filePath);
            const quarantineFileName = `${Date.now()}_${fileName}`;
            const quarantinePath = path_1.default.join(this.quarantineDir, quarantineFileName);
            // Move file to quarantine
            await promises_1.default.copyFile(filePath, quarantinePath);
            await promises_1.default.unlink(filePath); // Remove original
            // Store quarantine info
            const quarantineInfo = {
                originalPath: filePath,
                quarantinePath,
                hash: scanResult.hash,
                threat: scanResult.threats.join(', '),
                quarantinedAt: new Date(),
                userId,
            };
            const infoPath = `${quarantinePath}.info`;
            await promises_1.default.writeFile(infoPath, JSON.stringify(quarantineInfo, null, 2));
            logger_1.logger.info('File quarantined successfully', {
                originalPath: filePath,
                quarantinePath,
                threats: scanResult.threats,
            });
        }
        catch (error) {
            logger_1.logger.error('Failed to quarantine file:', { filePath, error });
            throw error;
        }
    }
    async releaseFromQuarantine(quarantinePath, targetPath) {
        try {
            const infoPath = `${quarantinePath}.info`;
            const infoContent = await promises_1.default.readFile(infoPath, 'utf-8');
            const quarantineInfo = JSON.parse(infoContent);
            // Move file back
            await promises_1.default.copyFile(quarantinePath, targetPath);
            await promises_1.default.unlink(quarantinePath);
            await promises_1.default.unlink(infoPath);
            logger_1.logger.info('File released from quarantine', {
                quarantinePath,
                targetPath,
                originalHash: quarantineInfo.hash,
            });
        }
        catch (error) {
            logger_1.logger.error('Failed to release file from quarantine:', { quarantinePath, error });
            throw error;
        }
    }
    async getQuarantinedFiles() {
        try {
            const files = await promises_1.default.readdir(this.quarantineDir);
            const quarantineFiles = [];
            for (const file of files) {
                if (file.endsWith('.info')) {
                    const infoPath = path_1.default.join(this.quarantineDir, file);
                    const infoContent = await promises_1.default.readFile(infoPath, 'utf-8');
                    const quarantineInfo = JSON.parse(infoContent);
                    quarantineFiles.push(quarantineInfo);
                }
            }
            return quarantineFiles.sort((a, b) => b.quarantinedAt.getTime() - a.quarantinedAt.getTime());
        }
        catch (error) {
            logger_1.logger.error('Failed to get quarantined files:', error);
            return [];
        }
    }
    async deleteQuarantinedFile(quarantinePath) {
        try {
            const infoPath = `${quarantinePath}.info`;
            await promises_1.default.unlink(quarantinePath);
            await promises_1.default.unlink(infoPath);
            logger_1.logger.info('Quarantined file deleted', { quarantinePath });
        }
        catch (error) {
            logger_1.logger.error('Failed to delete quarantined file:', { quarantinePath, error });
            throw error;
        }
    }
    /**
     * Cleans up old files from the quarantine directory
     * @param days Number of days to retain files
     */
    async cleanupQuarantine(days = malware_scanner_config_1.malwareScannerConfig.quarantineRetentionDays) {
        try {
            const files = await promises_1.default.readdir(this.quarantineDir);
            const now = Date.now();
            const retentionMs = days * 24 * 60 * 60 * 1000;
            let count = 0;
            for (const file of files) {
                if (file.endsWith('.info')) {
                    const infoPath = path_1.default.join(this.quarantineDir, file);
                    const stats = await promises_1.default.stat(infoPath);
                    if (now - stats.mtimeMs > retentionMs) {
                        const quarantinePath = infoPath.replace('.info', '');
                        await this.deleteQuarantinedFile(quarantinePath);
                        count++;
                    }
                }
            }
            if (count > 0) {
                logger_1.logger.info(`Quarantine cleanup completed. Removed ${count} old entries.`);
            }
        }
        catch (error) {
            logger_1.logger.error('Failed to cleanup quarantine:', error);
        }
    }
    calculateHash(buffer) {
        return crypto_1.default.createHash('sha256').update(buffer).digest('hex');
    }
    async detectMimeType(buffer) {
        // Simple MIME type detection based on file signatures
        const signatures = [
            { pattern: /^\x89PNG\r\n\x1a\n/, mime: 'image/png' },
            { pattern: /^\xff\xd8\xff/, mime: 'image/jpeg' },
            { pattern: /^GIF87a/, mime: 'image/gif' },
            { pattern: /^GIF89a/, mime: 'image/gif' },
            { pattern: /^%PDF-/, mime: 'application/pdf' },
            { pattern: /^PK\x03\x04/, mime: 'application/zip' },
            { pattern: /^MZ\x90\x00/, mime: 'application/x-msdownload' },
            { pattern: /^\x7fELF/, mime: 'application/x-executable' },
        ];
        const content = buffer.toString('binary', 0, Math.min(buffer.length, 100));
        for (const { pattern, mime } of signatures) {
            if (pattern.test(content)) {
                return mime;
            }
        }
        // Default to octet-stream if no signature matches
        return 'application/octet-stream';
    }
    calculateEntropy(buffer) {
        const frequency = new Map();
        // Count byte frequencies
        for (const byte of buffer) {
            frequency.set(byte, (frequency.get(byte) || 0) + 1);
        }
        // Calculate Shannon entropy
        let entropy = 0;
        const length = buffer.length;
        for (const count of frequency.values()) {
            const probability = count / length;
            entropy -= probability * Math.log2(probability);
        }
        return entropy;
    }
    getScanStats() {
        const scans = Array.from(this.scanCache.values());
        const totalScans = scans.length;
        const infectedFiles = scans.filter(s => s.isInfected).length;
        const averageScanTime = totalScans > 0 ? scans.reduce((sum, s) => sum + s.scanTime, 0) / totalScans : 0;
        // Count top threats
        const threatCounts = new Map();
        scans.forEach(scan => {
            scan.threats.forEach(threat => {
                threatCounts.set(threat, (threatCounts.get(threat) || 0) + 1);
            });
        });
        const topThreats = Array.from(threatCounts.entries())
            .map(([threat, count]) => ({ threat, count }))
            .sort((a, b) => b.count - a.count)
            .slice(0, 10);
        return {
            totalScans,
            infectedFiles,
            quarantinedFiles: scans.filter(s => s.isInfected).length,
            averageScanTime,
            topThreats,
        };
    }
    clearCache() {
        this.scanCache.clear();
        logger_1.logger.info('Malware scan cache cleared');
    }
};
exports.MalwareScannerService = MalwareScannerService;
exports.MalwareScannerService = MalwareScannerService = __decorate([
    (0, inversify_1.injectable)(),
    __metadata("design:paramtypes", [])
], MalwareScannerService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxzZXJ2aWNlc1xcbWFsd2FyZS1zY2FubmVyLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsa0RBQTBCO0FBQzFCLGlEQUFxQztBQUNyQyxvREFBNEI7QUFDNUIsMkRBQTZCO0FBQzdCLHlDQUF1QztBQUN2QyxnREFBd0I7QUFDeEIsK0JBQWlDO0FBQ2pDLDRDQUF5QztBQUN6Qyw2RUFBd0U7QUFFeEUsTUFBTSxTQUFTLEdBQUcsSUFBQSxnQkFBUyxFQUFDLG9CQUFJLENBQUMsQ0FBQztBQXdCM0IsSUFBTSxxQkFBcUIsR0FBM0IsTUFBTSxxQkFBcUI7SUFDZixhQUFhLEdBQUcsNkNBQW9CLENBQUMsYUFBYSxDQUFDO0lBQ25ELFNBQVMsR0FBRyxJQUFJLEdBQUcsRUFBc0IsQ0FBQztJQUMxQyxZQUFZLEdBQUcsNkNBQW9CLENBQUMsWUFBWSxDQUFDO0lBRTFELGlCQUFpQixHQUFHLEtBQUssQ0FBQztJQUMxQixlQUFlLEdBQUcsS0FBSyxDQUFDO0lBRWhDO1FBQ0UsSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUM7UUFDNUIsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ3RCLENBQUM7SUFFTyxLQUFLLENBQUMsWUFBWTtRQUN4QixJQUFJLENBQUM7WUFDSCxNQUFNLFNBQVMsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO1lBQ3RDLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLENBQUM7WUFDOUIsZUFBTSxDQUFDLElBQUksQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFDO1FBQ2xELENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsZUFBTSxDQUFDLElBQUksQ0FBQywwREFBMEQsQ0FBQyxDQUFDO1FBQzFFLENBQUM7UUFFRCxJQUFJLENBQUM7WUFDSCxNQUFNLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1lBQ2xDLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxD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QyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWhCLE9BQU87WUFDTCxVQUFVO1lBQ1YsYUFBYTtZQUNiLGdCQUFnQixFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsTUFBTTtZQUN4RCxlQUFlO1lBQ2YsVUFBVTtTQUNYLENBQUM7SUFDSixDQUFDO0lBRU0sVUFBVTtRQUNmLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDdkIsZUFBTSxDQUFDLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO0lBQzVDLENBQUM7Q0FDRixDQUFBO0FBdGdCWSxzREFBcUI7Z0NBQXJCLHFCQUFxQjtJQURqQyxJQUFBLHNCQUFVLEdBQUU7O0dBQ0EscUJBQXFCLENBc2dCakMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxzZXJ2aWNlc1xcbWFsd2FyZS1zY2FubmVyLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGF4aW9zIGZyb20gJ2F4aW9zJztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcbmltcG9ydCBjcnlwdG8gZnJvbSAnY3J5cHRvJztcbmltcG9ydCBmcyBmcm9tICdmcy9wcm9taXNlcyc7XG5pbXBvcnQgeyBpbmplY3RhYmxlIH0gZnJvbSAnaW52ZXJzaWZ5JztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgcHJvbWlzaWZ5IH0gZnJvbSAndXRpbCc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuLi91dGlscy9sb2dnZXInO1xuaW1wb3J0IHsgbWFsd2FyZVNjYW5uZXJDb25maWcgfSBmcm9tICcuLi9jb25maWcvbWFsd2FyZS1zY2FubmVyLmNvbmZpZyc7XG5cbmNvbnN0IGV4ZWNBc3luYyA9IHByb21pc2lmeShleGVjKTtcblxuaW50ZXJmYWNlIFNjYW5SZXN1bHQge1xuICBmaWxlOiBzdHJpbmc7XG4gIGhhc2g6IHN0cmluZztcbiAgc2l6ZTogbnVtYmVyO1xuICBtaW1lVHlwZTogc3RyaW5nO1xuICBpc0luZmVjdGVkOiBib29sZWFuO1xuICB0aHJlYXRzOiBzdHJpbmdbXTtcbiAgc2NhblRpbWU6IG51bWJlcjtcbiAgZW5naW5lOiBzdHJpbmc7XG4gIHRpbWVzdGFtcDogRGF0ZTtcbn1cblxuaW50ZXJmYWNlIFF1YXJhbnRpbmVJbmZvIHtcbiAgb3JpZ2luYWxQYXRoOiBzdHJpbmc7XG4gIHF1YXJhbnRpbmVQYXRoOiBzdHJpbmc7XG4gIGhhc2g6IHN0cmluZztcbiAgdGhyZWF0OiBzdHJpbmc7XG4gIHF1YXJhbnRpbmVkQXQ6IERhdGU7XG4gIHVzZXJJZD86IHN0cmluZztcbn1cblxuQGluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE1hbHdhcmVTY2FubmVyU2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgcXVhcmFudGluZURpciA9IG1hbHdhcmVTY2FubmVyQ29uZmlnLnF1YXJhbnRpbmVEaXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgc2NhbkNhY2hlID0gbmV3IE1hcDxzdHJpbmcsIFNjYW5SZXN1bHQ+KCk7XG4gIHByaXZhdGUgcmVhZG9ubHkgY2FjaGVUaW1lb3V0ID0gbWFsd2FyZVNjYW5uZXJDb25maWcuY2FjaGVUaW1lb3V0O1xuXG4gIHByaXZhdGUgaXNDbGFtQVZBdmFpbGFibGUgPSBmYWxzZTtcbiAgcHJpdmF0ZSBpc1lBUkFBdmFpbGFibGUgPSBmYWxzZTtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLmluaXRpYWxpemVRdWFyYW50aW5lKCk7XG4gICAgdGhpcy5jaGVja0VuZ2luZXMoKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgY2hlY2tFbmdpbmVzKCkge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBleGVjQXN5bmMoJ2NsYW1zY2FuIC0tdmVyc2lvbicpO1xuICAgICAgdGhpcy5pc0NsYW1BVkF2YWlsYWJsZSA9IHRydWU7XG4gICAgICBsb2dnZXIuaW5mbygnQ2xhbUFWIGVuZ2luZSBkZXRlY3RlZCBhbmQgcmVhZHknKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLndhcm4oJ0NsYW1BViBlbmdpbmUgbm90IGZvdW5kLCBDbGFtQVYgc2Nhbm5pbmcgd2lsbCBiZSBza2lwcGVkJyk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGV4ZWNBc3luYygneWFyYSAtLXZlcnNpb24nKTtcbiAgICAgIHRoaXMuaXNZQVJBQXZhaWxhYmxlID0gdHJ1ZTtcbiAgICAgIGxvZ2dlci5pbmZvKCdZQVJBIGVuZ2luZSBkZXRlY3RlZCBhbmQgcmVhZHknKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLndhcm4oJ1lBUkEgZW5naW5lIG5vdCBmb3VuZCwgWUFSQSBzY2FubmluZyB3aWxsIGJlIHNraXBwZWQnKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGluaXRpYWxpemVRdWFyYW50aW5lKCkge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBmcy5ta2Rpcih0aGlzLnF1YXJhbnRpbmVEaXIsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuICAgICAgbG9nZ2VyLmluZm8oJ01hbHdhcmUgc2Nhbm5lciBxdWFyYW50aW5lIGRpcmVjdG9yeSBpbml0aWFsaXplZCcpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byBpbml0aWFsaXplIHF1YXJhbnRpbmUgZGlyZWN0b3J5OicsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc2NhbkZpbGUoZmlsZVBhdGg6IHN0cmluZywgdXNlcklkPzogc3RyaW5nKTogUHJvbWlzZTxTY2FuUmVzdWx0PiB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcblxuICAgIHRyeSB7XG4gICAgICAvLyBDaGVjayBmaWxlIGV4aXN0c1xuICAgICAgY29uc3Qgc3RhdHMgPSBhd2FpdCBmcy5zdGF0KGZpbGVQYXRoKTtcbiAgICAgIGNvbnN0IGZpbGVCdWZmZXIgPSBhd2FpdCBmcy5yZWFkRmlsZShmaWxlUGF0aCk7XG4gICAgICBjb25zdCBoYXNoID0gdGhpcy5jYWxjdWxhdGVIYXNoKGZpbGVCdWZmZXIpO1xuXG4gICAgICAvLyBDaGVjayBjYWNoZSBmaXJzdFxuICAgICAgY29uc3QgY2FjaGVkID0gdGhpcy5zY2FuQ2FjaGUuZ2V0KGhhc2gpO1xuICAgICAgaWYgKGNhY2hlZCAmJiBEYXRlLm5vdygpIC0gY2FjaGVkLnRpbWVzdGFtcC5nZXRUaW1lKCkgPCB0aGlzLmNhY2hlVGltZW91dCkge1xuICAgICAgICBsb2dnZXIuaW5mbygnVXNpbmcgY2FjaGVkIHNjYW4gcmVzdWx0JywgeyBmaWxlOiBmaWxlUGF0aCwgaGFzaCB9KTtcbiAgICAgICAgcmV0dXJuIGNhY2hlZDtcbiAgICAgIH1cblxuICAgICAgLy8gRGV0ZXJtaW5lIGZpbGUgdHlwZVxuICAgICAgY29uc3QgbWltZVR5cGUgPSBhd2FpdCB0aGlzLmRldGVjdE1pbWVUeXBlKGZpbGVCdWZmZXIpO1xuXG4gICAgICAvLyBTY2FuIHdpdGggbXVsdGlwbGUgZW5naW5lc1xuICAgICAgY29uc3Qgc2NhblJlc3VsdHMgPSBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoW1xuICAgICAgICB0aGlzLnNjYW5XaXRoQ2xhbUFWKGZpbGVQYXRoKSxcbiAgICAgICAgdGhpcy5zY2FuV2l0aFlBUkEoZmlsZVBhdGgpLFxuICAgICAgICB0aGlzLnNjYW5XaXRoQ3VzdG9tUnVsZXMoZmlsZUJ1ZmZlciwgbWltZVR5cGUpLFxuICAgICAgICB0aGlzLnNjYW5XaXRoVmlydXNUb3RhbChoYXNoKSxcbiAgICAgIF0pO1xuXG4gICAgICAvLyBBZ2dyZWdhdGUgcmVzdWx0c1xuICAgICAgY29uc3QgdGhyZWF0czogc3RyaW5nW10gPSBbXTtcbiAgICAgIGxldCBpc0luZmVjdGVkID0gZmFsc2U7XG5cbiAgICAgIHNjYW5SZXN1bHRzLmZvckVhY2goKHJlc3VsdCwgaW5kZXgpID0+IHtcbiAgICAgICAgaWYgKHJlc3VsdC5zdGF0dXMgPT09ICdmdWxmaWxsZWQnKSB7XG4gICAgICAgICAgaWYgKHJlc3VsdC52YWx1ZS5pc0luZmVjdGVkKSB7XG4gICAgICAgICAgICBpc0luZmVjdGVkID0gdHJ1ZTtcbiAgICAgICAgICAgIHRocmVhdHMucHVzaCguLi5yZXN1bHQudmFsdWUudGhyZWF0cyk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhgU2NhbiBlbmdpbmUgJHtpbmRleH0gcmVzdWx0OmAsIHJlc3VsdC52YWx1ZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbG9nZ2VyLndhcm4oYFNjYW4gZW5naW5lICR7aW5kZXh9IGZhaWxlZDpgLCByZXN1bHQucmVhc29uKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHNjYW5SZXN1bHQ6IFNjYW5SZXN1bHQgPSB7XG4gICAgICAgIGZpbGU6IGZpbGVQYXRoLFxuICAgICAgICBoYXNoLFxuICAgICAgICBzaXplOiBzdGF0cy5zaXplLFxuICAgICAgICBtaW1lVHlwZSxcbiAgICAgICAgaXNJbmZlY3RlZCxcbiAgICAgICAgdGhyZWF0czogWy4uLm5ldyBTZXQodGhyZWF0cyldLCAvLyBSZW1vdmUgZHVwbGljYXRlc1xuICAgICAgICBzY2FuVGltZTogRGF0ZS5ub3coKSAtIHN0YXJ0VGltZSxcbiAgICAgICAgZW5naW5lOiAnbXVsdGktZW5naW5lJyxcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgfTtcblxuICAgICAgLy8gQ2FjaGUgcmVzdWx0XG4gICAgICB0aGlzLnNjYW5DYWNoZS5zZXQoaGFzaCwgc2NhblJlc3VsdCk7XG5cbiAgICAgIC8vIFF1YXJhbnRpbmUgaWYgaW5mZWN0ZWRcbiAgICAgIGlmIChpc0luZmVjdGVkKSB7XG4gICAgICAgIGF3YWl0IHRoaXMucXVhcmFudGluZUZpbGUoZmlsZVBhdGgsIHNjYW5SZXN1bHQsIHVzZXJJZCk7XG4gICAgICAgIGxvZ2dlci53YXJuKCdNYWx3YXJlIGRldGVjdGVkIGFuZCBxdWFyYW50aW5lZCcsIHtcbiAgICAgICAgICBmaWxlOiBmaWxlUGF0aCxcbiAgICAgICAgICBoYXNoLFxuICAgICAgICAgIHRocmVhdHM6IHNjYW5SZXN1bHQudGhyZWF0cyxcbiAgICAgICAgICB1c2VySWQsXG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nZ2VyLmluZm8oJ0ZpbGUgc2NhbiBjb21wbGV0ZWQgLSBjbGVhbicsIHtcbiAgICAgICAgICBmaWxlOiBmaWxlUGF0aCxcbiAgICAgICAgICBoYXNoLFxuICAgICAgICAgIHNjYW5UaW1lOiBzY2FuUmVzdWx0LnNjYW5UaW1lLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHNjYW5SZXN1bHQ7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignRXJyb3Igc2Nhbm5pbmcgZmlsZTonLCB7IGZpbGVQYXRoLCBlcnJvciB9KTtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIHNjYW4gZmlsZTogJHtlcnJvcn1gKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHNjYW5XaXRoQ2xhbUFWKFxuICAgIGZpbGVQYXRoOiBzdHJpbmcsXG4gICk6IFByb21pc2U8eyBpc0luZmVjdGVkOiBib29sZWFuOyB0aHJlYXRzOiBzdHJpbmdbXSB9PiB7XG4gICAgaWYgKCF0aGlzLmlzQ2xhbUFWQXZhaWxhYmxlKSB7XG4gICAgICByZXR1cm4geyBpc0luZmVjdGVkOiBmYWxzZSwgdGhyZWF0czogW10gfTtcbiAgICB9XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgc3Rkb3V0IH0gPSBhd2FpdCBleGVjQXN5bmMoYGNsYW1zY2FuIC0tbm8tc3VtbWFyeSBcIiR7ZmlsZVBhdGh9XCJgKTtcblxuICAgICAgaWYgKHN0ZG91dC5pbmNsdWRlcygnRk9VTkQnKSkge1xuICAgICAgICBjb25zdCB0aHJlYXRzID0gc3Rkb3V0XG4gICAgICAgICAgLnNwbGl0KCdcXG4nKVxuICAgICAgICAgIC5maWx0ZXIobGluZSA9PiBsaW5lLmluY2x1ZGVzKCdGT1VORCcpKVxuICAgICAgICAgIC5tYXAobGluZSA9PiBsaW5lLnNwbGl0KCc6JylbMF0udHJpbSgpKTtcblxuICAgICAgICByZXR1cm4geyBpc0luZmVjdGVkOiB0cnVlLCB0aHJlYXRzIH07XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB7IGlzSW5mZWN0ZWQ6IGZhbHNlLCB0aHJlYXRzOiBbXSB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIud2FybignQ2xhbUFWIHNjYW4gZmFpbGVkOicsIGVycm9yKTtcbiAgICAgIHJldHVybiB7IGlzSW5mZWN0ZWQ6IGZhbHNlLCB0aHJlYXRzOiBbXSB9O1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc2NhbldpdGhZQVJBKFxuICAgIGZpbGVQYXRoOiBzdHJpbmcsXG4gICk6IFByb21pc2U8eyBpc0luZmVjdGVkOiBib29sZWFuOyB0aHJlYXRzOiBzdHJpbmdbXSB9PiB7XG4gICAgaWYgKCF0aGlzLmlzWUFSQUF2YWlsYWJsZSkge1xuICAgICAgcmV0dXJuIHsgaXNJbmZlY3RlZDogZmFsc2UsIHRocmVhdHM6IFtdIH07XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IHN0ZG91dCB9ID0gYXdhaXQgZXhlY0FzeW5jKFxuICAgICAgICBgeWFyYSAke21hbHdhcmVTY2FubmVyQ29uZmlnLnlhcmFSdWxlc1BhdGh9IFwiJHtmaWxlUGF0aH1cImAsXG4gICAgICApO1xuXG4gICAgICBpZiAoc3Rkb3V0LnRyaW0oKSkge1xuICAgICAgICBjb25zdCB0aHJlYXRzID0gc3Rkb3V0LnNwbGl0KCdcXG4nKS5maWx0ZXIobGluZSA9PiBsaW5lLnRyaW0oKSk7XG4gICAgICAgIHJldHVybiB7IGlzSW5mZWN0ZWQ6IHRydWUsIHRocmVhdHMgfTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHsgaXNJbmZlY3RlZDogZmFsc2UsIHRocmVhdHM6IFtdIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci53YXJuKCdZQVJBIHNjYW4gZmFpbGVkOicsIGVycm9yKTtcbiAgICAgIHJldHVybiB7IGlzSW5mZWN0ZWQ6IGZhbHNlLCB0aHJlYXRzOiBbXSB9O1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc2NhbldpdGhDdXN0b21SdWxlcyhcbiAgICBidWZmZXI6IEJ1ZmZlcixcbiAgICBtaW1lVHlwZTogc3RyaW5nLFxuICApOiBQcm9taXNlPHsgaXNJbmZlY3RlZDogYm9vbGVhbjsgdGhyZWF0czogc3RyaW5nW10gfT4ge1xuICAgIGNvbnN0IHRocmVhdHM6IHN0cmluZ1tdID0gW107XG5cbiAgICAvLyBDaGVjayBmb3Igc3VzcGljaW91cyBwYXR0ZXJuc1xuICAgIGNvbnN0IHN1c3BpY2lvdXNQYXR0ZXJucyA9IFtcbiAgICAgIHsgcGF0dGVybjogL2V2YWxcXHMqXFwoL2ksIHRocmVhdDogJ0phdmFTY3JpcHQvUEhQIGV2YWwgZnVuY3Rpb24nIH0sXG4gICAgICB7IHBhdHRlcm46IC88c2NyaXB0W14+XSo+L2ksIHRocmVhdDogJ0VtYmVkZGVkIHNjcmlwdCB0YWcnIH0sXG4gICAgICB7IHBhdHRlcm46IC9qYXZhc2NyaXB0Oi9pLCB0aHJlYXQ6ICdKYXZhU2NyaXB0IHByb3RvY29sJyB9LFxuICAgICAgeyBwYXR0ZXJuOiAvdmJzY3JpcHQ6L2ksIHRocmVhdDogJ1ZCU2NyaXB0IHByb3RvY29sJyB9LFxuICAgICAgeyBwYXR0ZXJuOiAvZGF0YTp0ZXh0XFwvaHRtbC9pLCB0aHJlYXQ6ICdEYXRhIFVSSSBIVE1MJyB9LFxuICAgICAgeyBwYXR0ZXJuOiAvUEtcXHgwM1xceDA0LywgdGhyZWF0OiAnWklQIGFyY2hpdmUgKHBvdGVudGlhbCBwYXlsb2FkKScgfSxcbiAgICAgIHsgcGF0dGVybjogL01aXFx4OTBcXHgwMC8sIHRocmVhdDogJ1BFIGV4ZWN1dGFibGUnIH0sXG4gICAgICB7IHBhdHRlcm46IC9cXHg3ZkVMRi8sIHRocmVhdDogJ0VMRiBleGVjdXRhYmxlJyB9LFxuICAgICAgeyBwYXR0ZXJuOiAvZXhlY1xccypcXCgvaSwgdGhyZWF0OiAnU3lzdGVtIGNvbW1hbmQgZXhlY3V0aW9uJyB9LFxuICAgICAgeyBwYXR0ZXJuOiAvcGFzc3RocnVcXHMqXFwoL2ksIHRocmVhdDogJ1BIUCBwYXNzdGhydScgfSxcbiAgICAgIHsgcGF0dGVybjogL3NoZWxsX2V4ZWNcXHMqXFwoL2ksIHRocmVhdDogJ1BIUCBzaGVsbF9leGVjJyB9LFxuICAgICAgeyBwYXR0ZXJuOiAvc3lzdGVtXFxzKlxcKC9pLCB0aHJlYXQ6ICdTeXN0ZW0gY2FsbCcgfSxcbiAgICAgIHsgcGF0dGVybjogL2Jhc2U2NF9kZWNvZGVcXHMqXFwoL2ksIHRocmVhdDogJ0Jhc2U2NCBkZWNvZGluZyAocG90ZW50aWFsIG9iZnVzY2F0aW9uKScgfSxcbiAgICAgIHsgcGF0dGVybjogL3VuZXNjYXBlXFxzKlxcKHxkZWNvZGVVUklDb21wb25lbnRcXHMqXFwoL2ksIHRocmVhdDogJ0phdmFTY3JpcHQgZGUtb2JmdXNjYXRpb24nIH0sXG4gICAgICB7IHBhdHRlcm46IC9kb2N1bWVudFxcLndyaXRlXFxzKlxcKC9pLCB0aHJlYXQ6ICdTdXNwaWNpb3VzIERPTSBtYW5pcHVsYXRpb24nIH0sXG4gICAgICB7IHBhdHRlcm46IC9TdHJpbmdcXC5mcm9tQ2hhckNvZGUvaSwgdGhyZWF0OiAnSmF2YVNjcmlwdCBjaGFyYWN0ZXIgY29kZSBvYmZ1c2NhdGlvbicgfSxcbiAgICAgIC8vIEFkdmFuY2VkIEhldXJpc3RpY3NcbiAgICAgIHsgcGF0dGVybjogL0ludm9rZS1FeHByZXNzaW9ufElFWC9pLCB0aHJlYXQ6ICdQb3dlclNoZWxsIHJlbW90ZSBleGVjdXRpb24nIH0sXG4gICAgICB7IHBhdHRlcm46IC9XU2NyaXB0XFwuU2hlbGx8V3NoU2hlbGwvaSwgdGhyZWF0OiAnV2luZG93cyBTY3JpcHQgSG9zdCBtYW5pcHVsYXRpb24nIH0sXG4gICAgICB7XG4gICAgICAgIHBhdHRlcm46IC9BdXRvT3BlbnxBdXRvRXhlY3xEb2N1bWVudF9PcGVufFdvcmtib29rX09wZW4vaSxcbiAgICAgICAgdGhyZWF0OiAnT2ZmaWNlIE1hY3JvIEF1dG8tZXhlY3V0aW9uJyxcbiAgICAgIH0sXG4gICAgICB7IHBhdHRlcm46IC92YmFQcm9qZWN0XFwuYmluL2ksIHRocmVhdDogJ0VtYmVkZGVkIFZCQSBQcm9qZWN0JyB9LFxuICAgICAgeyBwYXR0ZXJuOiAvcHl0aG9uXFxzKy1jfGJhc2U2NFxccystZFxccypcXHxcXHMqc2gvaSwgdGhyZWF0OiAnSW4tcGxhY2Ugc2NyaXB0IGV4ZWN1dGlvbicgfSxcbiAgICBdO1xuXG4gICAgY29uc3QgY29udGVudCA9IGJ1ZmZlci50b1N0cmluZygnYmluYXJ5Jyk7XG5cbiAgICBmb3IgKGNvbnN0IHsgcGF0dGVybiwgdGhyZWF0IH0gb2Ygc3VzcGljaW91c1BhdHRlcm5zKSB7XG4gICAgICBpZiAocGF0dGVybi50ZXN0KGNvbnRlbnQpKSB7XG4gICAgICAgIHRocmVhdHMucHVzaCh0aHJlYXQpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIENoZWNrIGZpbGUgZXh0ZW5zaW9uIHZzIE1JTUUgdHlwZSBtaXNtYXRjaFxuICAgIGNvbnN0IHN1c3BpY2lvdXNFeHRlbnNpb25zID0gW1xuICAgICAgJy5leGUnLFxuICAgICAgJy5zY3InLFxuICAgICAgJy5iYXQnLFxuICAgICAgJy5jbWQnLFxuICAgICAgJy5jb20nLFxuICAgICAgJy5waWYnLFxuICAgICAgJy52YnMnLFxuICAgICAgJy5qcycsXG4gICAgICAnLmphcicsXG4gICAgXTtcbiAgICBjb25zdCBoYXNTdXNwaWNpb3VzRXh0ZW5zaW9uID0gc3VzcGljaW91c0V4dGVuc2lvbnMuc29tZShleHQgPT5cbiAgICAgIGNvbnRlbnQudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhleHQpLFxuICAgICk7XG5cbiAgICBpZiAoaGFzU3VzcGljaW91c0V4dGVuc2lvbiAmJiAhbWltZVR5cGUuc3RhcnRzV2l0aCgnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJykpIHtcbiAgICAgIHRocmVhdHMucHVzaCgnU3VzcGljaW91cyBmaWxlIGV4dGVuc2lvbicpO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGZvciBlbmNyeXB0ZWQvb2JmdXNjYXRlZCBjb250ZW50XG4gICAgY29uc3QgZW50cm9weSA9IHRoaXMuY2FsY3VsYXRlRW50cm9weShidWZmZXIpO1xuICAgIGlmIChlbnRyb3B5ID4gNy4wKSB7XG4gICAgICB0aHJlYXRzLnB1c2goJ0hpZ2ggZW50cm9weSAocG9zc2libGUgZW5jcnlwdGlvbi9vYmZ1c2NhdGlvbiknKTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBmb3IgbGFyZ2UgYmFzZTY0IHN0cmluZ3MgKHBvdGVudGlhbCBlbmNvZGVkIHBheWxvYWRzKVxuICAgIGNvbnN0IGJhc2U2NE1hdGNoZXMgPSBjb250ZW50Lm1hdGNoKC9bQS1aYS16MC05Ky9dezEwMCx9PXswLDJ9L2cpO1xuICAgIGlmIChiYXNlNjRNYXRjaGVzICYmIGJhc2U2NE1hdGNoZXMubGVuZ3RoID4gMCkge1xuICAgICAgdGhyZWF0cy5wdXNoKCdMYXJnZSBiYXNlNjQgc3RyaW5ncyBkZXRlY3RlZCcpO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBpc0luZmVjdGVkOiB0aHJlYXRzLmxlbmd0aCA+IDAsXG4gICAgICB0aHJlYXRzLFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHNjYW5XaXRoVmlydXNUb3RhbChcbiAgICBoYXNoOiBzdHJpbmcsXG4gICk6IFByb21pc2U8eyBpc0luZmVjdGVkOiBib29sZWFuOyB0aHJlYXRzOiBzdHJpbmdbXSB9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGFwaUtleSA9IHByb2Nlc3MuZW52LlZJUlVTVE9UQUxfQVBJX0tFWTtcbiAgICAgIGlmICghYXBpS2V5KSB7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZygnVmlydXNUb3RhbCBBUEkga2V5IG5vdCBmb3VuZCwgc2tpcHBpbmcgc2NhbicsIHsgaGFzaCB9KTtcbiAgICAgICAgcmV0dXJuIHsgaXNJbmZlY3RlZDogZmFsc2UsIHRocmVhdHM6IFtdIH07XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgYXhpb3MuZ2V0KGBodHRwczovL3d3dy52aXJ1c3RvdGFsLmNvbS9hcGkvdjMvZmlsZXMvJHtoYXNofWAsIHtcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICd4LWFwaWtleSc6IGFwaUtleSxcbiAgICAgICAgfSxcbiAgICAgICAgdmFsaWRhdGVTdGF0dXM6IChzdGF0dXM6IG51bWJlcikgPT4gc3RhdHVzID09PSAyMDAgfHwgc3RhdHVzID09PSA0MDQsXG4gICAgICB9KTtcblxuICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gNDA0KSB7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZygnRmlsZSBoYXNoIG5vdCBmb3VuZCBpbiBWaXJ1c1RvdGFsIGRhdGFiYXNlJywgeyBoYXNoIH0pO1xuICAgICAgICByZXR1cm4geyBpc0luZmVjdGVkOiBmYWxzZSwgdGhyZWF0czogW10gfTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgeyBkYXRhIH0gPSByZXNwb25zZS5kYXRhO1xuICAgICAgY29uc3QgbGFzdEFuYWx5c2lzU3RhdHMgPSBkYXRhLmF0dHJpYnV0ZXMubGFzdF9hbmFseXNpc19zdGF0cztcbiAgICAgIGNvbnN0IG1hbGljaW91c0NvdW50ID0gbGFzdEFuYWx5c2lzU3RhdHMubWFsaWNpb3VzIHx8IDA7XG4gICAgICBjb25zdCBzdXNwaWNpb3VzQ291bnQgPSBsYXN0QW5hbHlzaXNTdGF0cy5zdXNwaWNpb3VzIHx8IDA7XG5cbiAgICAgIGlmIChtYWxpY2lvdXNDb3VudCA+IDAgfHwgc3VzcGljaW91c0NvdW50ID4gMikge1xuICAgICAgICBjb25zdCBtYWxpY2lvdXNUaHJlYXRzID0gT2JqZWN0LnZhbHVlcyhcbiAgICAgICAgICBkYXRhLmF0dHJpYnV0ZXMubGFzdF9hbmFseXNpc19yZXN1bHRzIGFzIFJlY29yZDxzdHJpbmcsIGFueT4sXG4gICAgICAgIClcbiAgICAgICAgICAuZmlsdGVyKHIgPT4gci5jYXRlZ29yeSA9PT0gJ21hbGljaW91cycpXG4gICAgICAgICAgLm1hcChyID0+IHIucmVzdWx0KVxuICAgICAgICAgIC5maWx0ZXIoQm9vbGVhbik7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBpc0luZmVjdGVkOiB0cnVlLFxuICAgICAgICAgIHRocmVhdHM6IFtcbiAgICAgICAgICAgIGBWaXJ1c1RvdGFsOiAke21hbGljaW91c0NvdW50fSBlbmdpbmVzIGRldGVjdGVkIHRocmVhdHNgLFxuICAgICAgICAgICAgLi4ubWFsaWNpb3VzVGhyZWF0cy5zbGljZSgwLCAzKSxcbiAgICAgICAgICBdLFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICByZXR1cm4geyBpc0luZmVjdGVkOiBmYWxzZSwgdGhyZWF0czogW10gfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLndhcm4oJ1ZpcnVzVG90YWwgc2NhbiBmYWlsZWQ6JywgZXJyb3IpO1xuICAgICAgcmV0dXJuIHsgaXNJbmZlY3RlZDogZmFsc2UsIHRocmVhdHM6IFtdIH07XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBxdWFyYW50aW5lRmlsZShcbiAgICBmaWxlUGF0aDogc3RyaW5nLFxuICAgIHNjYW5SZXN1bHQ6IFNjYW5SZXN1bHQsXG4gICAgdXNlcklkPzogc3RyaW5nLFxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZmlsZU5hbWUgPSBwYXRoLmJhc2VuYW1lKGZpbGVQYXRoKTtcbiAgICAgIGNvbnN0IHF1YXJhbnRpbmVGaWxlTmFtZSA9IGAke0RhdGUubm93KCl9XyR7ZmlsZU5hbWV9YDtcbiAgICAgIGNvbnN0IHF1YXJhbnRpbmVQYXRoID0gcGF0aC5qb2luKHRoaXMucXVhcmFudGluZURpciwgcXVhcmFudGluZUZpbGVOYW1lKTtcblxuICAgICAgLy8gTW92ZSBmaWxlIHRvIHF1YXJhbnRpbmVcbiAgICAgIGF3YWl0IGZzLmNvcHlGaWxlKGZpbGVQYXRoLCBxdWFyYW50aW5lUGF0aCk7XG4gICAgICBhd2FpdCBmcy51bmxpbmsoZmlsZVBhdGgpOyAvLyBSZW1vdmUgb3JpZ2luYWxcblxuICAgICAgLy8gU3RvcmUgcXVhcmFudGluZSBpbmZvXG4gICAgICBjb25zdCBxdWFyYW50aW5lSW5mbzogUXVhcmFudGluZUluZm8gPSB7XG4gICAgICAgIG9yaWdpbmFsUGF0aDogZmlsZVBhdGgsXG4gICAgICAgIHF1YXJhbnRpbmVQYXRoLFxuICAgICAgICBoYXNoOiBzY2FuUmVzdWx0Lmhhc2gsXG4gICAgICAgIHRocmVhdDogc2NhblJlc3VsdC50aHJlYXRzLmpvaW4oJywgJyksXG4gICAgICAgIHF1YXJhbnRpbmVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgIHVzZXJJZCxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IGluZm9QYXRoID0gYCR7cXVhcmFudGluZVBhdGh9LmluZm9gO1xuICAgICAgYXdhaXQgZnMud3JpdGVGaWxlKGluZm9QYXRoLCBKU09OLnN0cmluZ2lmeShxdWFyYW50aW5lSW5mbywgbnVsbCwgMikpO1xuXG4gICAgICBsb2dnZXIuaW5mbygnRmlsZSBxdWFyYW50aW5lZCBzdWNjZXNzZnVsbHknLCB7XG4gICAgICAgIG9yaWdpbmFsUGF0aDogZmlsZVBhdGgsXG4gICAgICAgIHF1YXJhbnRpbmVQYXRoLFxuICAgICAgICB0aHJlYXRzOiBzY2FuUmVzdWx0LnRocmVhdHMsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gcXVhcmFudGluZSBmaWxlOicsIHsgZmlsZVBhdGgsIGVycm9yIH0pO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHJlbGVhc2VGcm9tUXVhcmFudGluZShxdWFyYW50aW5lUGF0aDogc3RyaW5nLCB0YXJnZXRQYXRoOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgaW5mb1BhdGggPSBgJHtxdWFyYW50aW5lUGF0aH0uaW5mb2A7XG4gICAgICBjb25zdCBpbmZvQ29udGVudCA9IGF3YWl0IGZzLnJlYWRGaWxlKGluZm9QYXRoLCAndXRmLTgnKTtcbiAgICAgIGNvbnN0IHF1YXJhbnRpbmVJbmZvOiBRdWFyYW50aW5lSW5mbyA9IEpTT04ucGFyc2UoaW5mb0NvbnRlbnQpO1xuXG4gICAgICAvLyBNb3ZlIGZpbGUgYmFja1xuICAgICAgYXdhaXQgZnMuY29weUZpbGUocXVhcmFudGluZVBhdGgsIHRhcmdldFBhdGgpO1xuICAgICAgYXdhaXQgZnMudW5saW5rKHF1YXJhbnRpbmVQYXRoKTtcbiAgICAgIGF3YWl0IGZzLnVubGluayhpbmZvUGF0aCk7XG5cbiAgICAgIGxvZ2dlci5pbmZvKCdGaWxlIHJlbGVhc2VkIGZyb20gcXVhcmFudGluZScsIHtcbiAgICAgICAgcXVhcmFudGluZVBhdGgsXG4gICAgICAgIHRhcmdldFBhdGgsXG4gICAgICAgIG9yaWdpbmFsSGFzaDogcXVhcmFudGluZUluZm8uaGFzaCxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byByZWxlYXNlIGZpbGUgZnJvbSBxdWFyYW50aW5lOicsIHsgcXVhcmFudGluZVBhdGgsIGVycm9yIH0pO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGdldFF1YXJhbnRpbmVkRmlsZXMoKTogUHJvbWlzZTxRdWFyYW50aW5lSW5mb1tdPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGZpbGVzID0gYXdhaXQgZnMucmVhZGRpcih0aGlzLnF1YXJhbnRpbmVEaXIpO1xuICAgICAgY29uc3QgcXVhcmFudGluZUZpbGVzOiBRdWFyYW50aW5lSW5mb1tdID0gW107XG5cbiAgICAgIGZvciAoY29uc3QgZmlsZSBvZiBmaWxlcykge1xuICAgICAgICBpZiAoZmlsZS5lbmRzV2l0aCgnLmluZm8nKSkge1xuICAgICAgICAgIGNvbnN0IGluZm9QYXRoID0gcGF0aC5qb2luKHRoaXMucXVhcmFudGluZURpciwgZmlsZSk7XG4gICAgICAgICAgY29uc3QgaW5mb0NvbnRlbnQgPSBhd2FpdCBmcy5yZWFkRmlsZShpbmZvUGF0aCwgJ3V0Zi04Jyk7XG4gICAgICAgICAgY29uc3QgcXVhcmFudGluZUluZm86IFF1YXJhbnRpbmVJbmZvID0gSlNPTi5wYXJzZShpbmZvQ29udGVudCk7XG4gICAgICAgICAgcXVhcmFudGluZUZpbGVzLnB1c2gocXVhcmFudGluZUluZm8pO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBxdWFyYW50aW5lRmlsZXMuc29ydCgoYSwgYikgPT4gYi5xdWFyYW50aW5lZEF0LmdldFRpbWUoKSAtIGEucXVhcmFudGluZWRBdC5nZXRUaW1lKCkpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byBnZXQgcXVhcmFudGluZWQgZmlsZXM6JywgZXJyb3IpO1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBkZWxldGVRdWFyYW50aW5lZEZpbGUocXVhcmFudGluZVBhdGg6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBpbmZvUGF0aCA9IGAke3F1YXJhbnRpbmVQYXRofS5pbmZvYDtcbiAgICAgIGF3YWl0IGZzLnVubGluayhxdWFyYW50aW5lUGF0aCk7XG4gICAgICBhd2FpdCBmcy51bmxpbmsoaW5mb1BhdGgpO1xuXG4gICAgICBsb2dnZXIuaW5mbygnUXVhcmFudGluZWQgZmlsZSBkZWxldGVkJywgeyBxdWFyYW50aW5lUGF0aCB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gZGVsZXRlIHF1YXJhbnRpbmVkIGZpbGU6JywgeyBxdWFyYW50aW5lUGF0aCwgZXJyb3IgfSk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ2xlYW5zIHVwIG9sZCBmaWxlcyBmcm9tIHRoZSBxdWFyYW50aW5lIGRpcmVjdG9yeVxuICAgKiBAcGFyYW0gZGF5cyBOdW1iZXIgb2YgZGF5cyB0byByZXRhaW4gZmlsZXNcbiAgICovXG4gIHB1YmxpYyBhc3luYyBjbGVhbnVwUXVhcmFudGluZShcbiAgICBkYXlzOiBudW1iZXIgPSBtYWx3YXJlU2Nhbm5lckNvbmZpZy5xdWFyYW50aW5lUmV0ZW50aW9uRGF5cyxcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGZpbGVzID0gYXdhaXQgZnMucmVhZGRpcih0aGlzLnF1YXJhbnRpbmVEaXIpO1xuICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICAgIGNvbnN0IHJldGVudGlvbk1zID0gZGF5cyAqIDI0ICogNjAgKiA2MCAqIDEwMDA7XG4gICAgICBsZXQgY291bnQgPSAwO1xuXG4gICAgICBmb3IgKGNvbnN0IGZpbGUgb2YgZmlsZXMpIHtcbiAgICAgICAgaWYgKGZpbGUuZW5kc1dpdGgoJy5pbmZvJykpIHtcbiAgICAgICAgICBjb25zdCBpbmZvUGF0aCA9IHBhdGguam9pbih0aGlzLnF1YXJhbnRpbmVEaXIsIGZpbGUpO1xuICAgICAgICAgIGNvbnN0IHN0YXRzID0gYXdhaXQgZnMuc3RhdChpbmZvUGF0aCk7XG5cbiAgICAgICAgICBpZiAobm93IC0gc3RhdHMubXRpbWVNcyA+IHJldGVudGlvbk1zKSB7XG4gICAgICAgICAgICBjb25zdCBxdWFyYW50aW5lUGF0aCA9IGluZm9QYXRoLnJlcGxhY2UoJy5pbmZvJywgJycpO1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5kZWxldGVRdWFyYW50aW5lZEZpbGUocXVhcmFudGluZVBhdGgpO1xuICAgICAgICAgICAgY291bnQrKztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKGNvdW50ID4gMCkge1xuICAgICAgICBsb2dnZXIuaW5mbyhgUXVhcmFudGluZSBjbGVhbnVwIGNvbXBsZXRlZC4gUmVtb3ZlZCAke2NvdW50fSBvbGQgZW50cmllcy5gKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gY2xlYW51cCBxdWFyYW50aW5lOicsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNhbGN1bGF0ZUhhc2goYnVmZmVyOiBCdWZmZXIpOiBzdHJpbmcge1xuICAgIHJldHVybiBjcnlwdG8uY3JlYXRlSGFzaCgnc2hhMjU2JykudXBkYXRlKGJ1ZmZlcikuZGlnZXN0KCdoZXgnKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZGV0ZWN0TWltZVR5cGUoYnVmZmVyOiBCdWZmZXIpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIC8vIFNpbXBsZSBNSU1FIHR5cGUgZGV0ZWN0aW9uIGJhc2VkIG9uIGZpbGUgc2lnbmF0dXJlc1xuICAgIGNvbnN0IHNpZ25hdHVyZXMgPSBbXG4gICAgICB7IHBhdHRlcm46IC9eXFx4ODlQTkdcXHJcXG5cXHgxYVxcbi8sIG1pbWU6ICdpbWFnZS9wbmcnIH0sXG4gICAgICB7IHBhdHRlcm46IC9eXFx4ZmZcXHhkOFxceGZmLywgbWltZTogJ2ltYWdlL2pwZWcnIH0sXG4gICAgICB7IHBhdHRlcm46IC9eR0lGODdhLywgbWltZTogJ2ltYWdlL2dpZicgfSxcbiAgICAgIHsgcGF0dGVybjogL15HSUY4OWEvLCBtaW1lOiAnaW1hZ2UvZ2lmJyB9LFxuICAgICAgeyBwYXR0ZXJuOiAvXiVQREYtLywgbWltZTogJ2FwcGxpY2F0aW9uL3BkZicgfSxcbiAgICAgIHsgcGF0dGVybjogL15QS1xceDAzXFx4MDQvLCBtaW1lOiAnYXBwbGljYXRpb24vemlwJyB9LFxuICAgICAgeyBwYXR0ZXJuOiAvXk1aXFx4OTBcXHgwMC8sIG1pbWU6ICdhcHBsaWNhdGlvbi94LW1zZG93bmxvYWQnIH0sXG4gICAgICB7IHBhdHRlcm46IC9eXFx4N2ZFTEYvLCBtaW1lOiAnYXBwbGljYXRpb24veC1leGVjdXRhYmxlJyB9LFxuICAgIF07XG5cbiAgICBjb25zdCBjb250ZW50ID0gYnVmZmVyLnRvU3RyaW5nKCdiaW5hcnknLCAwLCBNYXRoLm1pbihidWZmZXIubGVuZ3RoLCAxMDApKTtcblxuICAgIGZvciAoY29uc3QgeyBwYXR0ZXJuLCBtaW1lIH0gb2Ygc2lnbmF0dXJlcykge1xuICAgICAgaWYgKHBhdHRlcm4udGVzdChjb250ZW50KSkge1xuICAgICAgICByZXR1cm4gbWltZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBEZWZhdWx0IHRvIG9jdGV0LXN0cmVhbSBpZiBubyBzaWduYXR1cmUgbWF0Y2hlc1xuICAgIHJldHVybiAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJztcbiAgfVxuXG4gIHByaXZhdGUgY2FsY3VsYXRlRW50cm9weShidWZmZXI6IEJ1ZmZlcik6IG51bWJlciB7XG4gICAgY29uc3QgZnJlcXVlbmN5ID0gbmV3IE1hcDxudW1iZXIsIG51bWJlcj4oKTtcblxuICAgIC8vIENvdW50IGJ5dGUgZnJlcXVlbmNpZXNcbiAgICBmb3IgKGNvbnN0IGJ5dGUgb2YgYnVmZmVyKSB7XG4gICAgICBmcmVxdWVuY3kuc2V0KGJ5dGUsIChmcmVxdWVuY3kuZ2V0KGJ5dGUpIHx8IDApICsgMSk7XG4gICAgfVxuXG4gICAgLy8gQ2FsY3VsYXRlIFNoYW5ub24gZW50cm9weVxuICAgIGxldCBlbnRyb3B5ID0gMDtcbiAgICBjb25zdCBsZW5ndGggPSBidWZmZXIubGVuZ3RoO1xuXG4gICAgZm9yIChjb25zdCBjb3VudCBvZiBmcmVxdWVuY3kudmFsdWVzKCkpIHtcbiAgICAgIGNvbnN0IHByb2JhYmlsaXR5ID0gY291bnQgLyBsZW5ndGg7XG4gICAgICBlbnRyb3B5IC09IHByb2JhYmlsaXR5ICogTWF0aC5sb2cyKHByb2JhYmlsaXR5KTtcbiAgICB9XG5cbiAgICByZXR1cm4gZW50cm9weTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRTY2FuU3RhdHMoKToge1xuICAgIHRvdGFsU2NhbnM6IG51bWJlcjtcbiAgICBpbmZlY3RlZEZpbGVzOiBudW1iZXI7XG4gICAgcXVhcmFudGluZWRGaWxlczogbnVtYmVyO1xuICAgIGF2ZXJhZ2VTY2FuVGltZTogbnVtYmVyO1xuICAgIHRvcFRocmVhdHM6IEFycmF5PHsgdGhyZWF0OiBzdHJpbmc7IGNvdW50OiBudW1iZXIgfT47XG4gIH0ge1xuICAgIGNvbnN0IHNjYW5zID0gQXJyYXkuZnJvbSh0aGlzLnNjYW5DYWNoZS52YWx1ZXMoKSk7XG4gICAgY29uc3QgdG90YWxTY2FucyA9IHNjYW5zLmxlbmd0aDtcbiAgICBjb25zdCBpbmZlY3RlZEZpbGVzID0gc2NhbnMuZmlsdGVyKHMgPT4gcy5pc0luZmVjdGVkKS5sZW5ndGg7XG4gICAgY29uc3QgYXZlcmFnZVNjYW5UaW1lID1cbiAgICAgIHRvdGFsU2NhbnMgPiAwID8gc2NhbnMucmVkdWNlKChzdW0sIHMpID0+IHN1bSArIHMuc2NhblRpbWUsIDApIC8gdG90YWxTY2FucyA6IDA7XG5cbiAgICAvLyBDb3VudCB0b3AgdGhyZWF0c1xuICAgIGNvbnN0IHRocmVhdENvdW50cyA9IG5ldyBNYXA8c3RyaW5nLCBudW1iZXI+KCk7XG4gICAgc2NhbnMuZm9yRWFjaChzY2FuID0+IHtcbiAgICAgIHNjYW4udGhyZWF0cy5mb3JFYWNoKHRocmVhdCA9PiB7XG4gICAgICAgIHRocmVhdENvdW50cy5zZXQodGhyZWF0LCAodGhyZWF0Q291bnRzLmdldCh0aHJlYXQpIHx8IDApICsgMSk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGNvbnN0IHRvcFRocmVhdHMgPSBBcnJheS5mcm9tKHRocmVhdENvdW50cy5lbnRyaWVzKCkpXG4gICAgICAubWFwKChbdGhyZWF0LCBjb3VudF0pID0+ICh7IHRocmVhdCwgY291bnQgfSkpXG4gICAgICAuc29ydCgoYSwgYikgPT4gYi5jb3VudCAtIGEuY291bnQpXG4gICAgICAuc2xpY2UoMCwgMTApO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHRvdGFsU2NhbnMsXG4gICAgICBpbmZlY3RlZEZpbGVzLFxuICAgICAgcXVhcmFudGluZWRGaWxlczogc2NhbnMuZmlsdGVyKHMgPT4gcy5pc0luZmVjdGVkKS5sZW5ndGgsXG4gICAgICBhdmVyYWdlU2NhblRpbWUsXG4gICAgICB0b3BUaHJlYXRzLFxuICAgIH07XG4gIH1cblxuICBwdWJsaWMgY2xlYXJDYWNoZSgpOiB2b2lkIHtcbiAgICB0aGlzLnNjYW5DYWNoZS5jbGVhcigpO1xuICAgIGxvZ2dlci5pbmZvKCdNYWx3YXJlIHNjYW4gY2FjaGUgY2xlYXJlZCcpO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=