615e250e0f74c06ef2d1e0b9039c8ca6
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.requireAuth = exports.authorize = exports.protect = void 0;
const jsonwebtoken_1 = __importDefault(require("jsonwebtoken"));
const config_1 = require("../config");
const User_1 = require("../models/User");
const logger_1 = require("../utils/logger");
const inversify_config_1 = require("../config/inversify.config");
const types_1 = require("../types");
const protect = async (req, res, next) => {
    let token;
    // Obtener el token del encabezado Authorization
    if (req.headers.authorization?.startsWith('Bearer')) {
        token = req.headers.authorization.split(' ')[1];
    }
    // Obtener el token de las cookies (opcional)
    else if (req.cookies?.token) {
        token = req.cookies.token;
    }
    // Verificar si existe el token
    if (!token) {
        res.status(401).json({
            success: false,
            message: 'No autorizado. Por favor inicie sesión para continuar.',
        });
        return;
    }
    try {
        // 1. Verificar firma del token
        const decoded = jsonwebtoken_1.default.verify(token, config_1.config.jwt.secret);
        // 2. Verificar fingerprint y Device Posture (Zero Trust)
        if (decoded.fingerprint) {
            const currentUserAgent = req.headers['user-agent'] || 'unknown';
            // UA Mismatch check
            if (process.env.NODE_ENV === 'production' &&
                decoded.fingerprint.userAgent !== currentUserAgent) {
                logger_1.logger.warn(`UA Mismatch: ${decoded.id}. Token: ${decoded.fingerprint.userAgent} vs Req: ${currentUserAgent}`);
                res.status(401).json({ success: false, message: 'Sesión inválida.' });
                return;
            }
            // Device Posture Check
            if (decoded.fingerprint.deviceId) {
                const devicePostureService = inversify_config_1.container.get(types_1.TYPES.DevicePostureService);
                const postureCheck = await devicePostureService.verifyDevice(decoded.id, {
                    deviceId: decoded.fingerprint.deviceId,
                    os: 'unknown', // Would extract from UA or other headers
                    browser: currentUserAgent,
                });
                if (!postureCheck.isCompliant && (decoded.role === 'god' || decoded.role === 'admin')) {
                    logger_1.logger.warn(`Security Breach attempt: Non-compliant device for role ${decoded.role}`, {
                        userId: decoded.id,
                        reason: postureCheck.reason,
                    });
                    res.status(403).json({
                        success: false,
                        message: `Acceso denegado: Dispositivo no cumple con las políticas de seguridad (${postureCheck.reason}).`,
                    });
                    return;
                }
            }
        }
        // 3. Verificar persistencia en DB (CRÍTICO)
        const user = await User_1.User.findById(decoded.id).select('+tokenVersion +lastPasswordChange');
        if (!user) {
            res.status(401).json({ success: false, message: 'El usuario ya no existe.' });
            return;
        }
        // 4. Verificar versión del token (Revocación Instantánea)
        // Si el usuario incrementó su versión (logout global), tokens viejos mueren.
        if (user.tokenVersion && decoded.tokenVersion !== undefined) {
            if (decoded.tokenVersion !== user.tokenVersion) {
                res
                    .status(401)
                    .json({ success: false, message: 'Token revocado. Inicie sesión nuevamente.' });
                return;
            }
        }
        // 5. Verificar cambio de contraseña reciente
        // Si la contraseña cambió después de emitir el token, revocar.
        if (user.lastPasswordChange) {
            const changedTimestamp = Math.floor(user.lastPasswordChange.getTime() / 1000);
            if (decoded.iat < changedTimestamp) {
                res.status(401).json({
                    success: false,
                    message: 'Contraseña cambiada recientemente. Inicie sesión nuevamente.',
                });
                return;
            }
        }
        // Añadir usuario al objeto request
        req.user = {
            id: user._id.toString(),
            email: user.email,
            role: user.role,
        };
        next();
    }
    catch (error) {
        logger_1.logger.error({
            error: error.message,
            name: error.name,
            stack: error.stack,
            token: token?.substring(0, 10) + '...', // Log only start of token for security
        }, 'Auth Middleware Error');
        res.status(401).json({
            success: false,
            message: 'Sesión inválida o expirada.',
        });
        return;
    }
};
exports.protect = protect;
// Middleware para verificar roles de usuario
const authorize = (...roles) => {
    return (req, res, next) => {
        if (!req.user || !roles.includes(req.user.role)) {
            res.status(403).json({
                success: false,
                message: `El rol ${req.user?.role} no tiene permiso para realizar esta acción.`,
            });
            return;
        }
        next();
    };
};
exports.authorize = authorize;
exports.requireAuth = exports.protect;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxtaWRkbGV3YXJlXFxhdXRoLm1pZGRsZXdhcmUudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQ0EsZ0VBQStCO0FBQy9CLHNDQUFtQztBQUNuQyx5Q0FBc0M7QUFDdEMsNENBQXlDO0FBQ3pDLGlFQUF1RDtBQUN2RCxvQ0FBaUM7QUFnQjFCLE1BQU0sT0FBTyxHQUFHLEtBQUssRUFBRSxHQUFZLEVBQUUsR0FBYSxFQUFFLElBQWtCLEVBQUUsRUFBRTtJQUMvRSxJQUFJLEtBQXlCLENBQUM7SUFFOUIsZ0RBQWdEO0lBQ2hELElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxhQUFhLEVBQUUsVUFBVSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUM7UUFDcEQsS0FBSyxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNsRCxDQUFDO0lBQ0QsNkNBQTZDO1NBQ3hDLElBQUksR0FBRyxDQUFDLE9BQU8sRUFBRSxLQUFLLEVBQUUsQ0FBQztRQUM1QixLQUFLLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUM7SUFDNUIsQ0FBQztJQUVELCtCQUErQjtJQUMvQixJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDVixHQUFXLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUM1QixPQUFPLEVBQUUsS0FBSztZQUNkLE9BQU8sRUFBRSx3REFBd0Q7U0FDbEUsQ0FBQyxDQUFDO1FBQ0gsT0FBTztJQUNULENBQUM7SUFFRCxJQUFJLENBQUM7UUFDSCwrQkFBK0I7UUFDL0IsTUFBTSxPQUFPLEdBQUcsc0JBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLGVBQU0sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQVdsRCxDQUFDO1FBRUYseURBQXlEO1FBQ3pELElBQUksT0FBTyxDQUFDLFdBQVcsRUFBRSxD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TSxTQUFTLEdBQUcsQ0FBQyxHQUFHLEtBQWUsRUFBRSxFQUFFO0lBQzlDLE9BQU8sQ0FBQyxHQUFZLEVBQUUsR0FBYSxFQUFFLElBQWtCLEVBQUUsRUFBRTtRQUN6RCxJQUFJLENBQUUsR0FBVyxDQUFDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUUsR0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO1lBQ2pFLEdBQVcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUM1QixPQUFPLEVBQUUsS0FBSztnQkFDZCxPQUFPLEVBQUUsVUFBVyxHQUFXLENBQUMsSUFBSSxFQUFFLElBQUksOENBQThDO2FBQ3pGLENBQUMsQ0FBQztZQUNILE9BQU87UUFDVCxDQUFDO1FBQ0QsSUFBSSxFQUFFLENBQUM7SUFDVCxDQUFDLENBQUM7QUFDSixDQUFDLENBQUM7QUFYVyxRQUFBLFNBQVMsYUFXcEI7QUFDVyxRQUFBLFdBQVcsR0FBRyxlQUFPLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxtaWRkbGV3YXJlXFxhdXRoLm1pZGRsZXdhcmUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBOZXh0RnVuY3Rpb24sIFJlcXVlc3QsIFJlc3BvbnNlIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgand0IGZyb20gJ2pzb253ZWJ0b2tlbic7XG5pbXBvcnQgeyBjb25maWcgfSBmcm9tICcuLi9jb25maWcnO1xuaW1wb3J0IHsgVXNlciB9IGZyb20gJy4uL21vZGVscy9Vc2VyJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uL3V0aWxzL2xvZ2dlcic7XG5pbXBvcnQgeyBjb250YWluZXIgfSBmcm9tICcuLi9jb25maWcvaW52ZXJzaWZ5LmNvbmZpZyc7XG5pbXBvcnQgeyBUWVBFUyB9IGZyb20gJy4uL3R5cGVzJztcbmltcG9ydCB7IERldmljZVBvc3R1cmVTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvZGV2aWNlLXBvc3R1cmUuc2VydmljZSc7XG5cbi8vIEV4dGVuZGVyIGxhIGludGVyZmF6IFJlcXVlc3QgcGFyYSBpbmNsdWlyIGxhIHByb3BpZWRhZCB1c2VyXG5kZWNsYXJlIGdsb2JhbCB7XG4gIG5hbWVzcGFjZSBFeHByZXNzIHtcbiAgICBpbnRlcmZhY2UgUmVxdWVzdCB7XG4gICAgICB1c2VyPzoge1xuICAgICAgICBpZDogc3RyaW5nO1xuICAgICAgICBlbWFpbDogc3RyaW5nO1xuICAgICAgICByb2xlOiBzdHJpbmc7XG4gICAgICB9O1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgY29uc3QgcHJvdGVjdCA9IGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xuICBsZXQgdG9rZW46IHN0cmluZyB8IHVuZGVmaW5lZDtcblxuICAvLyBPYnRlbmVyIGVsIHRva2VuIGRlbCBlbmNhYmV6YWRvIEF1dGhvcml6YXRpb25cbiAgaWYgKHJlcS5oZWFkZXJzLmF1dGhvcml6YXRpb24/LnN0YXJ0c1dpdGgoJ0JlYXJlcicpKSB7XG4gICAgdG9rZW4gPSByZXEuaGVhZGVycy5hdXRob3JpemF0aW9uLnNwbGl0KCcgJylbMV07XG4gIH1cbiAgLy8gT2J0ZW5lciBlbCB0b2tlbiBkZSBsYXMgY29va2llcyAob3BjaW9uYWwpXG4gIGVsc2UgaWYgKHJlcS5jb29raWVzPy50b2tlbikge1xuICAgIHRva2VuID0gcmVxLmNvb2tpZXMudG9rZW47XG4gIH1cblxuICAvLyBWZXJpZmljYXIgc2kgZXhpc3RlIGVsIHRva2VuXG4gIGlmICghdG9rZW4pIHtcbiAgICAocmVzIGFzIGFueSkuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgIG1lc3NhZ2U6ICdObyBhdXRvcml6YWRvLiBQb3IgZmF2b3IgaW5pY2llIHNlc2nDs24gcGFyYSBjb250aW51YXIuJyxcbiAgICB9KTtcbiAgICByZXR1cm47XG4gIH1cblxuICB0cnkge1xuICAgIC8vIDEuIFZlcmlmaWNhciBmaXJtYSBkZWwgdG9rZW5cbiAgICBjb25zdCBkZWNvZGVkID0gand0LnZlcmlmeSh0b2tlbiwgY29uZmlnLmp3dC5zZWNyZXQpIGFzIHtcbiAgICAgIGlkOiBzdHJpbmc7XG4gICAgICBlbWFpbDogc3RyaW5nO1xuICAgICAgcm9sZTogc3RyaW5nO1xuICAgICAgaWF0OiBudW1iZXI7XG4gICAgICB0b2tlblZlcnNpb24/OiBudW1iZXI7XG4gICAgICBmaW5nZXJwcmludD86IHtcbiAgICAgICAgaXA6IHN0cmluZztcbiAgICAgICAgdXNlckFnZW50OiBzdHJpbmc7XG4gICAgICAgIGRldmljZUlkPzogc3RyaW5nO1xuICAgICAgfTtcbiAgICB9O1xuXG4gICAgLy8gMi4gVmVyaWZpY2FyIGZpbmdlcnByaW50IHkgRGV2aWNlIFBvc3R1cmUgKFplcm8gVHJ1c3QpXG4gICAgaWYgKGRlY29kZWQuZmluZ2VycHJpbnQpIHtcbiAgICAgIGNvbnN0IGN1cnJlbnRVc2VyQWdlbnQgPSByZXEuaGVhZGVyc1sndXNlci1hZ2VudCddIHx8ICd1bmtub3duJztcblxuICAgICAgLy8gVUEgTWlzbWF0Y2ggY2hlY2tcbiAgICAgIGlmIChcbiAgICAgICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICdwcm9kdWN0aW9uJyAmJlxuICAgICAgICBkZWNvZGVkLmZpbmdlcnByaW50LnVzZXJBZ2VudCAhPT0gY3VycmVudFVzZXJBZ2VudFxuICAgICAgKSB7XG4gICAgICAgIGxvZ2dlci53YXJuKFxuICAgICAgICAgIGBVQSBNaXNtYXRjaDogJHtkZWNvZGVkLmlkfS4gVG9rZW46ICR7ZGVjb2RlZC5maW5nZXJwcmludC51c2VyQWdlbnR9IHZzIFJlcTogJHtjdXJyZW50VXNlckFnZW50fWAsXG4gICAgICAgICk7XG4gICAgICAgIChyZXMgYXMgYW55KS5zdGF0dXMoNDAxKS5qc29uKHsgc3VjY2VzczogZmFsc2UsIG1lc3NhZ2U6ICdTZXNpw7NuIGludsOhbGlkYS4nIH0pO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIC8vIERldmljZSBQb3N0dXJlIENoZWNrXG4gICAgICBpZiAoZGVjb2RlZC5maW5nZXJwcmludC5kZXZpY2VJZCkge1xuICAgICAgICBjb25zdCBkZXZpY2VQb3N0dXJlU2VydmljZSA9IGNvbnRhaW5lci5nZXQ8RGV2aWNlUG9zdHVyZVNlcnZpY2U+KFxuICAgICAgICAgIFRZUEVTLkRldmljZVBvc3R1cmVTZXJ2aWNlLFxuICAgICAgICApO1xuICAgICAgICBjb25zdCBwb3N0dXJlQ2hlY2sgPSBhd2FpdCBkZXZpY2VQb3N0dXJlU2VydmljZS52ZXJpZnlEZXZpY2UoZGVjb2RlZC5pZCwge1xuICAgICAgICAgIGRldmljZUlkOiBkZWNvZGVkLmZpbmdlcnByaW50LmRldmljZUlkLFxuICAgICAgICAgIG9zOiAndW5rbm93bicsIC8vIFdvdWxkIGV4dHJhY3QgZnJvbSBVQSBvciBvdGhlciBoZWFkZXJzXG4gICAgICAgICAgYnJvd3NlcjogY3VycmVudFVzZXJBZ2VudCxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKCFwb3N0dXJlQ2hlY2suaXNDb21wbGlhbnQgJiYgKGRlY29kZWQucm9sZSA9PT0gJ2dvZCcgfHwgZGVjb2RlZC5yb2xlID09PSAnYWRtaW4nKSkge1xuICAgICAgICAgIGxvZ2dlci53YXJuKGBTZWN1cml0eSBCcmVhY2ggYXR0ZW1wdDogTm9uLWNvbXBsaWFudCBkZXZpY2UgZm9yIHJvbGUgJHtkZWNvZGVkLnJvbGV9YCwge1xuICAgICAgICAgICAgdXNlcklkOiBkZWNvZGVkLmlkLFxuICAgICAgICAgICAgcmVhc29uOiBwb3N0dXJlQ2hlY2sucmVhc29uLFxuICAgICAgICAgIH0pO1xuICAgICAgICAgIChyZXMgYXMgYW55KS5zdGF0dXMoNDAzKS5qc29uKHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgICAgbWVzc2FnZTogYEFjY2VzbyBkZW5lZ2FkbzogRGlzcG9zaXRpdm8gbm8gY3VtcGxlIGNvbiBsYXMgcG9sw610aWNhcyBkZSBzZWd1cmlkYWQgKCR7cG9zdHVyZUNoZWNrLnJlYXNvbn0pLmAsXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gMy4gVmVyaWZpY2FyIHBlcnNpc3RlbmNpYSBlbiBEQiAoQ1LDjVRJQ08pXG4gICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZEJ5SWQoZGVjb2RlZC5pZCkuc2VsZWN0KCcrdG9rZW5WZXJzaW9uICtsYXN0UGFzc3dvcmRDaGFuZ2UnKTtcblxuICAgIGlmICghdXNlcikge1xuICAgICAgKHJlcyBhcyBhbnkpLnN0YXR1cyg0MDEpLmpzb24oeyBzdWNjZXNzOiBmYWxzZSwgbWVzc2FnZTogJ0VsIHVzdWFyaW8geWEgbm8gZXhpc3RlLicgfSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gNC4gVmVyaWZpY2FyIHZlcnNpw7NuIGRlbCB0b2tlbiAoUmV2b2NhY2nDs24gSW5zdGFudMOhbmVhKVxuICAgIC8vIFNpIGVsIHVzdWFyaW8gaW5jcmVtZW50w7Mgc3UgdmVyc2nDs24gKGxvZ291dCBnbG9iYWwpLCB0b2tlbnMgdmllam9zIG11ZXJlbi5cbiAgICBpZiAodXNlci50b2tlblZlcnNpb24gJiYgZGVjb2RlZC50b2tlblZlcnNpb24gIT09IHVuZGVmaW5lZCkge1xuICAgICAgaWYgKGRlY29kZWQudG9rZW5WZXJzaW9uICE9PSB1c2VyLnRva2VuVmVyc2lvbikge1xuICAgICAgICAocmVzIGFzIGFueSlcbiAgICAgICAgICAuc3RhdHVzKDQwMSlcbiAgICAgICAgICAuanNvbih7IHN1Y2Nlc3M6IGZhbHNlLCBtZXNzYWdlOiAnVG9rZW4gcmV2b2NhZG8uIEluaWNpZSBzZXNpw7NuIG51ZXZhbWVudGUuJyB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIDUuIFZlcmlmaWNhciBjYW1iaW8gZGUgY29udHJhc2XDsWEgcmVjaWVudGVcbiAgICAvLyBTaSBsYSBjb250cmFzZcOxYSBjYW1iacOzIGRlc3B1w6lzIGRlIGVtaXRpciBlbCB0b2tlbiwgcmV2b2Nhci5cbiAgICBpZiAodXNlci5sYXN0UGFzc3dvcmRDaGFuZ2UpIHtcbiAgICAgIGNvbnN0IGNoYW5nZWRUaW1lc3RhbXAgPSBNYXRoLmZsb29yKHVzZXIubGFzdFBhc3N3b3JkQ2hhbmdlLmdldFRpbWUoKSAvIDEwMDApO1xuICAgICAgaWYgKGRlY29kZWQuaWF0IDwgY2hhbmdlZFRpbWVzdGFtcCkge1xuICAgICAgICAocmVzIGFzIGFueSkuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgbWVzc2FnZTogJ0NvbnRyYXNlw7FhIGNhbWJpYWRhIHJlY2llbnRlbWVudGUuIEluaWNpZSBzZXNpw7NuIG51ZXZhbWVudGUuJyxcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBBw7FhZGlyIHVzdWFyaW8gYWwgb2JqZXRvIHJlcXVlc3RcbiAgICAocmVxIGFzIGFueSkudXNlciA9IHtcbiAgICAgIGlkOiB1c2VyLl9pZC50b1N0cmluZygpLFxuICAgICAgZW1haWw6IHVzZXIuZW1haWwsXG4gICAgICByb2xlOiB1c2VyLnJvbGUsXG4gICAgfTtcblxuICAgIG5leHQoKTtcbiAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgIGxvZ2dlci5lcnJvcihcbiAgICAgIHtcbiAgICAgICAgZXJyb3I6IGVycm9yLm1lc3NhZ2UsXG4gICAgICAgIG5hbWU6IGVycm9yLm5hbWUsXG4gICAgICAgIHN0YWNrOiBlcnJvci5zdGFjayxcbiAgICAgICAgdG9rZW46IHRva2VuPy5zdWJzdHJpbmcoMCwgMTApICsgJy4uLicsIC8vIExvZyBvbmx5IHN0YXJ0IG9mIHRva2VuIGZvciBzZWN1cml0eVxuICAgICAgfSxcbiAgICAgICdBdXRoIE1pZGRsZXdhcmUgRXJyb3InLFxuICAgICk7XG4gICAgKHJlcyBhcyBhbnkpLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICBtZXNzYWdlOiAnU2VzacOzbiBpbnbDoWxpZGEgbyBleHBpcmFkYS4nLFxuICAgIH0pO1xuICAgIHJldHVybjtcbiAgfVxufTtcblxuLy8gTWlkZGxld2FyZSBwYXJhIHZlcmlmaWNhciByb2xlcyBkZSB1c3VhcmlvXG5leHBvcnQgY29uc3QgYXV0aG9yaXplID0gKC4uLnJvbGVzOiBzdHJpbmdbXSkgPT4ge1xuICByZXR1cm4gKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG4gICAgaWYgKCEocmVxIGFzIGFueSkudXNlciB8fCAhcm9sZXMuaW5jbHVkZXMoKHJlcSBhcyBhbnkpLnVzZXIucm9sZSkpIHtcbiAgICAgIChyZXMgYXMgYW55KS5zdGF0dXMoNDAzKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIG1lc3NhZ2U6IGBFbCByb2wgJHsocmVxIGFzIGFueSkudXNlcj8ucm9sZX0gbm8gdGllbmUgcGVybWlzbyBwYXJhIHJlYWxpemFyIGVzdGEgYWNjacOzbi5gLFxuICAgICAgfSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIG5leHQoKTtcbiAgfTtcbn07XG5leHBvcnQgY29uc3QgcmVxdWlyZUF1dGggPSBwcm90ZWN0O1xuIl0sInZlcnNpb24iOjN9