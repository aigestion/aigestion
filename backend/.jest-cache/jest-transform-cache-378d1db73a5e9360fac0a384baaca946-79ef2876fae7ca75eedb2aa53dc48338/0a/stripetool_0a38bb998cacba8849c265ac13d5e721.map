{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\tools\\stripe.tool.ts","mappings":";;;AAAA,6BAAwB;AAExB,yCAAsC;AACtC,+DAA2D;AAC3D,4CAAyC;AACzC,2CAAuC;AAEvC,MAAa,UAAW,SAAQ,oBAA8D;IAC5F,IAAI,GAAG,qBAAqB,CAAC;IAC7B,WAAW,GACT,oKAAoK,CAAC;IACvK,MAAM,GAAG,OAAC,CAAC,MAAM,CAAC;QAChB,MAAM,EAAE,OAAC;aACN,IAAI,CAAC,CAAC,YAAY,EAAE,iBAAiB,EAAE,eAAe,CAAC,CAAC;aACxD,QAAQ,CAAC,wBAAwB,CAAC;QACrC,MAAM,EAAE,OAAC,CAAC,MAAM,EAAE,CAAC,QAAQ,CAAC,6BAA6B,CAAC;QAC1D,OAAO,EAAE,OAAC;aACP,MAAM,EAAE;aACR,QAAQ,EAAE;aACV,QAAQ,CAAC,2EAA2E,CAAC;KACzF,CAAC,CAAC;IAEH,KAAK,CAAC,OAAO,CAAC,KAA2D;QACvE,MAAM,EAAE,MAAM,EAAE,MAAM,EAAE,OAAO,EAAE,GAAG,KAAK,CAAC;QAC1C,eAAM,CAAC,IAAI,CAAC,kCAAkC,MAAM,cAAc,MAAM,EAAE,CAAC,CAAC;QAE5E,IAAI,CAAC;YACH,MAAM,IAAI,GAAG,MAAM,WAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;YACzC,IAAI,CAAC,IAAI,EAAE,CAAC;gBACV,MAAM,IAAI,KAAK,CAAC,mBAAmB,MAAM,EAAE,CAAC,CAAC;YAC/C,CAAC;YAED,IAAI,MAAM,KAAK,YAAY,EAAE,CAAC;gBAC5B,OAAO;oBACL,MAAM,EAAE,IAAI,CAAC,kBAAkB,IAAI,MAAM;oBACzC,IAAI,EAAE,IAAI,CAAC,gBAAgB,IAAI,MAAM;oBACrC,UAAU,EAAE,IAAI,CAAC,gBAAgB;iBAClC,CAAC;YACJ,CAAC;YAED,IAAI,MAAM,KAAK,iBAAiB,EAAE,CAAC;gBACjC,IAAI,CAAC,IAAI,CAAC,gBAAgB,EAAE,CAAC;oBAC3B,kCAAkC;oBAClC,MAAM,QAAQ,GAAG,MAAM,8BAAa,CAAC,cAAc,CAAC,IAAI,CAAC,KAAK,EAAE,IAAI,CAAC,IAAI,CAAC,CAAC;oBAC3E,IAAI,CAAC,gBAAgB,GAAG,QAAQ,CAAC,EAAE,CAAC;oBACpC,MAAM,IAAI,CAAC,IAAI,EAAE,CAAC;gBACpB,CAAC;gBAED,IAAI,CAAC,OAAO,EAAE,CAAC;oBACb,MAAM,IAAI,KAAK,CAAC,gDAAgD,CAAC,CAAC;gBACpE,CAAC;gBAED,gEAAgE;gBAChE,MAAM,UAAU,GACd,OAAO,CAAC,GAAG,CAAC,kBAAkB,IAAI,8CAA8C,CAAC;gBACnF,MAAM,SAAS,GACb,OAAO,CAAC,GAAG,CAAC,iBAAiB,IAAI,+CAA+C,CAAC;gBAEnF,MAAM,OAAO,GAAG,MAAM,8BAAa,CAAC,iCAAiC,CACnE,IAAI,CAAC,gBAAgB,EACrB,OAAO,EACP,UAAU,EACV,SAAS,CACV,CAAC;gBACF,OAAO,EAAE,GAAG,EAAE,OAAO,CAAC,GAAG,EAAE,CAAC;YAC9B,CAAC;YAED,IAAI,MAAM,KAAK,eAAe,EAAE,CAAC;gBAC/B,IAAI,CAAC,IAAI,CAAC,gBAAgB,EAAE,CAAC;oBAC3B,MAAM,IAAI,KAAK,CAAC,+DAA+D,CAAC,CAAC;gBACnF,CAAC;gBAED,MAAM,SAAS,GAAG,OAAO,CAAC,GAAG,CAAC,iBAAiB,IAAI,iCAAiC,CAAC;gBACrF,MAAM,OAAO,GAAG,MAAM,8BAAa,CAAC,mBAAmB,CAAC,IAAI,CAAC,gBAAgB,EAAE,SAAS,CAAC,CAAC;gBAC1F,OAAO,EAAE,GAAG,EAAE,OAAO,CAAC,GAAG,EAAE,CAAC;YAC9B,CAAC;YAED,MAAM,IAAI,KAAK,CAAC,mBAAmB,MAAM,EAAE,CAAC,CAAC;QAC/C,CAAC;QAAC,OAAO,KAAU,EAAE,CAAC;YACpB,eAAM,CAAC,KAAK,CAAC,wBAAwB,KAAK,CAAC,OAAO,EAAE,CAAC,CAAC;YACtD,MAAM,IAAI,KAAK,CAAC,yBAAyB,KAAK,CAAC,OAAO,EAAE,CAAC,CAAC;QAC5D,CAAC;IACH,CAAC;CACF;AA5ED,gCA4EC","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\tools\\stripe.tool.ts"],"sourcesContent":["import { z } from 'zod';\n\nimport { User } from '../models/User';\nimport { stripeService } from '../services/stripe.service';\nimport { logger } from '../utils/logger';\nimport { BaseTool } from './base.tool';\n\nexport class StripeTool extends BaseTool<{ action: string; userId: string; priceId?: string }> {\n  name = 'manage_subscription';\n  description =\n    'Manage user subscriptions, check status, or generate checkout/portal links. Use this tool when the user asks about their billing, subscription, or upgrading plan.';\n  schema = z.object({\n    action: z\n      .enum(['get_status', 'create_checkout', 'create_portal'])\n      .describe('The action to perform.'),\n    userId: z.string().describe('The ID of the user context.'),\n    priceId: z\n      .string()\n      .optional()\n      .describe('The Stripe Price ID for checkout (required if action is create_checkout).'),\n  });\n\n  async execute(input: { action: string; userId: string; priceId?: string }): Promise<any> {\n    const { action, userId, priceId } = input;\n    logger.info(`[StripeTool] Executing action: ${action} for user: ${userId}`);\n\n    try {\n      const user = await User.findById(userId);\n      if (!user) {\n        throw new Error(`User not found: ${userId}`);\n      }\n\n      if (action === 'get_status') {\n        return {\n          status: user.subscriptionStatus || 'none',\n          plan: user.subscriptionPlan || 'free',\n          customerId: user.stripeCustomerId,\n        };\n      }\n\n      if (action === 'create_checkout') {\n        if (!user.stripeCustomerId) {\n          // Auto-create customer if missing\n          const customer = await stripeService.createCustomer(user.email, user.name);\n          user.stripeCustomerId = customer.id;\n          await user.save();\n        }\n\n        if (!priceId) {\n          throw new Error('priceId is required for create_checkout action');\n        }\n\n        // Hardcoded return/cancel URLs for now - should be configurable\n        const successUrl =\n          process.env.STRIPE_SUCCESS_URL || 'http://localhost:3000/dashboard?success=true';\n        const cancelUrl =\n          process.env.STRIPE_CANCEL_URL || 'http://localhost:3000/dashboard?canceled=true';\n\n        const session = await stripeService.createSubscriptionCheckoutSession(\n          user.stripeCustomerId,\n          priceId,\n          successUrl,\n          cancelUrl,\n        );\n        return { url: session.url };\n      }\n\n      if (action === 'create_portal') {\n        if (!user.stripeCustomerId) {\n          throw new Error('User has no Stripe Customer ID, cannot create portal session.');\n        }\n\n        const returnUrl = process.env.STRIPE_RETURN_URL || 'http://localhost:3000/dashboard';\n        const session = await stripeService.createPortalSession(user.stripeCustomerId, returnUrl);\n        return { url: session.url };\n      }\n\n      throw new Error(`Invalid action: ${action}`);\n    } catch (error: any) {\n      logger.error(`[StripeTool] Failed: ${error.message}`);\n      throw new Error(`Stripe action failed: ${error.message}`);\n    }\n  }\n}\n"],"version":3}