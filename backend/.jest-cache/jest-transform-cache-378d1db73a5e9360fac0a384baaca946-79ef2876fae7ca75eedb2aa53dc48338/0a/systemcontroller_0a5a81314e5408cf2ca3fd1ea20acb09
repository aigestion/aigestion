f51bafba0f49ca48ae4a9a32173542a5
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.SystemController = void 0;
const os_1 = __importDefault(require("os"));
const inversify_1 = require("inversify");
const system_metrics_service_1 = require("../services/system-metrics.service");
const redis_1 = require("../utils/redis");
const types_1 = require("../types");
let SystemController = class SystemController {
    metricsService;
    constructor(metricsService) {
        this.metricsService = metricsService;
    }
    /**
     * Get system metrics (CPU, Memory, Disk, Network)
     */
    async getSystemMetrics(_req, res, next) {
        try {
            const cacheKey = 'system:metrics:real';
            const cachedData = await (0, redis_1.getCache)(cacheKey);
            if (cachedData) {
                res.json(JSON.parse(cachedData));
                return;
            }
            const metrics = await this.metricsService.getSystemMetrics();
            await (0, redis_1.setCache)(cacheKey, JSON.stringify(metrics), 2);
            res.json(metrics);
        }
        catch (error) {
            next(error);
        }
    }
    /**
     * Get CPU usage
     */
    async getCPUUsage(_req, res, next) {
        try {
            const cpuUsage = await this.metricsService.getCPUUsage();
            const cpus = os_1.default.cpus();
            res.json({
                usage: cpuUsage,
                cores: cpus.length,
                model: cpus[0]?.model || 'Unknown',
            });
        }
        catch (error) {
            next(error);
        }
    }
    /**
     * Get memory usage
     */
    async getMemoryUsage(_req, res, next) {
        try {
            const usagePercent = await this.metricsService.getMemoryUsage();
            const totalMem = os_1.default.totalmem();
            const freeMem = os_1.default.freemem();
            const usedMem = totalMem - freeMem;
            res.json({
                total: totalMem,
                used: usedMem,
                free: freeMem,
                usagePercent: usagePercent,
            });
        }
        catch (error) {
            next(error);
        }
    }
    /**
     * Get disk usage
     */
    async getDiskUsage(_req, res, next) {
        try {
            const usage = await this.metricsService.getDiskUsage();
            res.json({ usage });
        }
        catch (error) {
            next(error);
        }
    }
    /**
     * Get network stats
     */
    async getNetworkStats(_req, res, next) {
        try {
            const networkInterfaces = os_1.default.networkInterfaces();
            const interfaces = Object.entries(networkInterfaces).map(([name, addrs]) => ({
                name,
                addresses: addrs?.map(addr => ({
                    address: addr.address,
                    family: addr.family,
                    internal: addr.internal,
                })),
            }));
            res.json({ interfaces });
        }
        catch (error) {
            next(error);
        }
    }
};
exports.SystemController = SystemController;
exports.SystemController = SystemController = __decorate([
    (0, inversify_1.injectable)(),
    __param(0, (0, inversify_1.inject)(types_1.TYPES.SystemMetricsService)),
    __metadata("design:paramtypes", [typeof (_a = typeof system_metrics_service_1.SystemMetricsService !== "undefined" && system_metrics_service_1.SystemMetricsService) === "function" ? _a : Object])
], SystemController);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxjb250cm9sbGVyc1xcc3lzdGVtLmNvbnRyb2xsZXIudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUNBLDRDQUFvQjtBQUNwQix5Q0FBK0M7QUFFL0MsK0VBQTBFO0FBRTFFLDBDQUFvRDtBQUNwRCxvQ0FBaUM7QUFHMUIsSUFBTSxnQkFBZ0IsR0FBdEIsTUFBTSxnQkFBZ0I7SUFDNkI7SUFBeEQsWUFBd0QsY0FBb0M7UUFBcEMsbUJBQWMsR0FBZCxjQUFjLENBQXNCO0lBQUcsQ0FBQztJQUVoRzs7T0FFRztJQUNILEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFhLEVBQUUsR0FBYSxFQUFFLElBQVM7UUFDNUQsSUFBSSxDQUFDO1lBQ0gsTUFBTSxRQUFRLEdBQUcscUJBQXFCLENBQUM7WUFDdkMsTUFBTSxVQUFVLEdBQUcsTUFBTSxJQUFBLGdCQUFRLEVBQUMsUUFBUSxDQUFDLENBQUM7WUFFNUMsSUFBSSxVQUFVLEVBQUUsQ0FBQztnQkFDZixHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztnQkFDakMsT0FBTztZQUNULENBQUM7WUFFRCxNQUFNLE9BQU8sR0FBRyxNQUFNLElBQUksQ0FBQyxjQUFjLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUU3RCxNQUFNLElBQUEsZ0JBQVEsRUFBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUNyRCxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3BCLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2QsQ0FBQztJQUNILENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxXQUFXLENBQUMsSUFBYSxFQUFFLEdBQWEsRUFBRSxJ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QUFvQixDQUFDLENBQUE7eURBQXlCLDZDQUFvQixvQkFBcEIsNkNBQW9CO0dBRGpGLGdCQUFnQixDQWdHNUIiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxjb250cm9sbGVyc1xcc3lzdGVtLmNvbnRyb2xsZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBSZXF1ZXN0LCBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IG9zIGZyb20gJ29zJztcbmltcG9ydCB7IGluamVjdCwgaW5qZWN0YWJsZSB9IGZyb20gJ2ludmVyc2lmeSc7XG5cbmltcG9ydCB7IFN5c3RlbU1ldHJpY3NTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvc3lzdGVtLW1ldHJpY3Muc2VydmljZSc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuLi91dGlscy9sb2dnZXInO1xuaW1wb3J0IHsgZ2V0Q2FjaGUsIHNldENhY2hlIH0gZnJvbSAnLi4vdXRpbHMvcmVkaXMnO1xuaW1wb3J0IHsgVFlQRVMgfSBmcm9tICcuLi90eXBlcyc7XG5cbkBpbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBTeXN0ZW1Db250cm9sbGVyIHtcbiAgY29uc3RydWN0b3IoQGluamVjdChUWVBFUy5TeXN0ZW1NZXRyaWNzU2VydmljZSkgcHJpdmF0ZSBtZXRyaWNzU2VydmljZTogU3lzdGVtTWV0cmljc1NlcnZpY2UpIHt9XG5cbiAgLyoqXG4gICAqIEdldCBzeXN0ZW0gbWV0cmljcyAoQ1BVLCBNZW1vcnksIERpc2ssIE5ldHdvcmspXG4gICAqL1xuICBhc3luYyBnZXRTeXN0ZW1NZXRyaWNzKF9yZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IGFueSk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBjYWNoZUtleSA9ICdzeXN0ZW06bWV0cmljczpyZWFsJztcbiAgICAgIGNvbnN0IGNhY2hlZERhdGEgPSBhd2FpdCBnZXRDYWNoZShjYWNoZUtleSk7XG5cbiAgICAgIGlmIChjYWNoZWREYXRhKSB7XG4gICAgICAgIHJlcy5qc29uKEpTT04ucGFyc2UoY2FjaGVkRGF0YSkpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IG1ldHJpY3MgPSBhd2FpdCB0aGlzLm1ldHJpY3NTZXJ2aWNlLmdldFN5c3RlbU1ldHJpY3MoKTtcblxuICAgICAgYXdhaXQgc2V0Q2FjaGUoY2FjaGVLZXksIEpTT04uc3RyaW5naWZ5KG1ldHJpY3MpLCAyKTtcbiAgICAgIHJlcy5qc29uKG1ldHJpY3MpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBuZXh0KGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IENQVSB1c2FnZVxuICAgKi9cbiAgYXN5bmMgZ2V0Q1BVVXNhZ2UoX3JlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogYW55KSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGNwdVVzYWdlID0gYXdhaXQgdGhpcy5tZXRyaWNzU2VydmljZS5nZXRDUFVVc2FnZSgpO1xuICAgICAgY29uc3QgY3B1cyA9IG9zLmNwdXMoKTtcblxuICAgICAgcmVzLmpzb24oe1xuICAgICAgICB1c2FnZTogY3B1VXNhZ2UsXG4gICAgICAgIGNvcmVzOiBjcHVzLmxlbmd0aCxcbiAgICAgICAgbW9kZWw6IGNwdXNbMF0/Lm1vZGVsIHx8ICdVbmtub3duJyxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBuZXh0KGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IG1lbW9yeSB1c2FnZVxuICAgKi9cbiAgYXN5bmMgZ2V0TWVtb3J5VXNhZ2UoX3JlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogYW55KSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHVzYWdlUGVyY2VudCA9IGF3YWl0IHRoaXMubWV0cmljc1NlcnZpY2UuZ2V0TWVtb3J5VXNhZ2UoKTtcbiAgICAgIGNvbnN0IHRvdGFsTWVtID0gb3MudG90YWxtZW0oKTtcbiAgICAgIGNvbnN0IGZyZWVNZW0gPSBvcy5mcmVlbWVtKCk7XG4gICAgICBjb25zdCB1c2VkTWVtID0gdG90YWxNZW0gLSBmcmVlTWVtO1xuXG4gICAgICByZXMuanNvbih7XG4gICAgICAgIHRvdGFsOiB0b3RhbE1lbSxcbiAgICAgICAgdXNlZDogdXNlZE1lbSxcbiAgICAgICAgZnJlZTogZnJlZU1lbSxcbiAgICAgICAgdXNhZ2VQZXJjZW50OiB1c2FnZVBlcmNlbnQsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbmV4dChlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEdldCBkaXNrIHVzYWdlXG4gICAqL1xuICBhc3luYyBnZXREaXNrVXNhZ2UoX3JlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogYW55KSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHVzYWdlID0gYXdhaXQgdGhpcy5tZXRyaWNzU2VydmljZS5nZXREaXNrVXNhZ2UoKTtcbiAgICAgIHJlcy5qc29uKHsgdXNhZ2UgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIG5leHQoZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgbmV0d29yayBzdGF0c1xuICAgKi9cbiAgYXN5bmMgZ2V0TmV0d29ya1N0YXRzKF9yZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IGFueSkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBuZXR3b3JrSW50ZXJmYWNlcyA9IG9zLm5ldHdvcmtJbnRlcmZhY2VzKCk7XG4gICAgICBjb25zdCBpbnRlcmZhY2VzID0gT2JqZWN0LmVudHJpZXMobmV0d29ya0ludGVyZmFjZXMpLm1hcCgoW25hbWUsIGFkZHJzXSkgPT4gKHtcbiAgICAgICAgbmFtZSxcbiAgICAgICAgYWRkcmVzc2VzOiBhZGRycz8ubWFwKGFkZHIgPT4gKHtcbiAgICAgICAgICBhZGRyZXNzOiBhZGRyLmFkZHJlc3MsXG4gICAgICAgICAgZmFtaWx5OiBhZGRyLmZhbWlseSxcbiAgICAgICAgICBpbnRlcm5hbDogYWRkci5pbnRlcm5hbCxcbiAgICAgICAgfSkpLFxuICAgICAgfSkpO1xuXG4gICAgICByZXMuanNvbih7IGludGVyZmFjZXMgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIG5leHQoZXJyb3IpO1xuICAgIH1cbiAgfVxufVxuIl0sInZlcnNpb24iOjN9