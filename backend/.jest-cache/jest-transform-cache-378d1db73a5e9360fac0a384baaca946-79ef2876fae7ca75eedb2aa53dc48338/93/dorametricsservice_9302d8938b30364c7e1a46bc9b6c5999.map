{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\dora-metrics.service.ts","mappings":";;;;;;;;;AAAA,yCAAuC;AACvC,0CAAgD;AAChD,4CAAyC;AAUlC,IAAM,kBAAkB,GAAxB,MAAM,kBAAkB;IACZ,WAAW,GAAG,oBAAoB,CAAC;IAEpD;;OAEG;IACH,KAAK,CAAC,gBAAgB;QACpB,MAAM,MAAM,GAAG,IAAA,sBAAc,GAAE,CAAC;QAChC,IAAI,CAAC,MAAM,EAAE,MAAM;YAAE,OAAO;QAE5B,MAAM,MAAM,CAAC,OAAO,CAAC,IAAI,CAAC,WAAW,EAAE,mBAAmB,EAAE,CAAC,CAAC,CAAC;QAC/D,MAAM,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE,oBAAoB,EAAE,IAAI,IAAI,EAAE,CAAC,WAAW,EAAE,CAAC,CAAC;QACpF,eAAM,CAAC,IAAI,CAAC,oCAAoC,CAAC,CAAC;IACpD,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,2BAA2B,CAAC,WAAiB,EAAE,eAAqB;QACxE,MAAM,MAAM,GAAG,IAAA,sBAAc,GAAE,CAAC;QAChC,IAAI,CAAC,MAAM,EAAE,MAAM;YAAE,OAAO;QAE5B,MAAM,mBAAmB,GACvB,CAAC,eAAe,CAAC,OAAO,EAAE,GAAG,WAAW,CAAC,OAAO,EAAE,CAAC,GAAG,CAAC,IAAI,GAAG,EAAE,GAAG,EAAE,CAAC,CAAC;QACzE,MAAM,MAAM,CAAC,OAAO,CAAC,IAAI,CAAC,WAAW,EAAE,gBAAgB,EAAE,CAAC,CAAC,CAAC;QAC5D,uEAAuE;QACvE,MAAM,MAAM,CAAC,KAAK,CAAC,GAAG,IAAI,CAAC,WAAW,wBAAwB,EAAE,mBAAmB,CAAC,QAAQ,EAAE,CAAC,CAAC;QAChG,eAAM,CAAC,IAAI,CACT,oDAAoD,mBAAmB,CAAC,OAAO,CAAC,CAAC,CAAC,SAAS,CAC5F,CAAC;IACJ,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,UAAU;QACd,MAAM,MAAM,GAAG,IAAA,sBAAc,GAAE,CAAC;QAChC,IAAI,CAAC,MAAM,EAAE,MAAM;YACjB,OAAO;gBACL,mBAAmB,EAAE,CAAC;gBACtB,kBAAkB,EAAE,CAAC;gBACrB,iBAAiB,EAAE,CAAC;gBACpB,oBAAoB,EAAE,CAAC;aACxB,CAAC;QAEJ,MAAM,KAAK,GAAG,MAAM,MAAM,CAAC,OAAO,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;QACrD,kEAAkE;QAClE,OAAO;YACL,mBAAmB,EAAE,MAAM,CAAC,QAAQ,CAAC,KAAK,CAAC,iBAAiB,IAAI,GAAG,CAAC;YACpE,kBAAkB,EAAE,GAAG,EAAE,iBAAiB;YAC1C,iBAAiB,EACf,CAAC,MAAM,CAAC,QAAQ,CAAC,KAAK,CAAC,cAAc,IAAI,GAAG,CAAC;gBAC3C,MAAM,CAAC,QAAQ,CAAC,KAAK,CAAC,iBAAiB,IAAI,GAAG,CAAC,CAAC;gBAClD,GAAG;YACL,oBAAoB,EAAE,GAAG,EAAE,iBAAiB;SAC7C,CAAC;IACJ,CAAC;CACF,CAAA;AAzDY,gDAAkB;6BAAlB,kBAAkB;IAD9B,IAAA,sBAAU,GAAE;GACA,kBAAkB,CAyD9B","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\dora-metrics.service.ts"],"sourcesContent":["import { injectable } from 'inversify';\nimport { getRedisClient } from '../cache/redis';\nimport { logger } from '../utils/logger';\n\nexport interface DoraMetrics {\n  deploymentFrequency: number;\n  leadTimeForChanges: number; // in hours\n  changeFailureRate: number; // percentage\n  timeToRestoreService: number; // in hours\n}\n\n@injectable()\nexport class DoraMetricsService {\n  private readonly METRICS_KEY = 'nexus:dora_metrics';\n\n  /**\n   * Records a deployment event.\n   */\n  async recordDeployment(): Promise<void> {\n    const client = getRedisClient();\n    if (!client?.isOpen) return;\n\n    await client.hIncrBy(this.METRICS_KEY, 'deployments_count', 1);\n    await client.hSet(this.METRICS_KEY, 'last_deployment_at', new Date().toISOString());\n    logger.info('[DoraMetrics] Deployment recorded.');\n  }\n\n  /**\n   * Records a service failure and restoration time.\n   */\n  async recordFailureAndRestoration(failureTime: Date, restorationTime: Date): Promise<void> {\n    const client = getRedisClient();\n    if (!client?.isOpen) return;\n\n    const restorationDuration =\n      (restorationTime.getTime() - failureTime.getTime()) / (1000 * 60 * 60);\n    await client.hIncrBy(this.METRICS_KEY, 'failures_count', 1);\n    // Average calculation would be more complex, but here's a simple store\n    await client.lPush(`${this.METRICS_KEY}:restoration_durations`, restorationDuration.toString());\n    logger.info(\n      `[DoraMetrics] Failure recorded. Restoration took ${restorationDuration.toFixed(2)} hours.`,\n    );\n  }\n\n  /**\n   * Retrieves current DORA metrics.\n   */\n  async getMetrics(): Promise<DoraMetrics> {\n    const client = getRedisClient();\n    if (!client?.isOpen)\n      return {\n        deploymentFrequency: 0,\n        leadTimeForChanges: 0,\n        changeFailureRate: 0,\n        timeToRestoreService: 0,\n      };\n\n    const stats = await client.hGetAll(this.METRICS_KEY);\n    // Basic simulation of mapping stored raw data to DORA definitions\n    return {\n      deploymentFrequency: Number.parseInt(stats.deployments_count || '0'),\n      leadTimeForChanges: 2.5, // Mocked for now\n      changeFailureRate:\n        (Number.parseInt(stats.failures_count || '0') /\n          Number.parseInt(stats.deployments_count || '1')) *\n        100,\n      timeToRestoreService: 1.2, // Mocked for now\n    };\n  }\n}\n"],"version":3}