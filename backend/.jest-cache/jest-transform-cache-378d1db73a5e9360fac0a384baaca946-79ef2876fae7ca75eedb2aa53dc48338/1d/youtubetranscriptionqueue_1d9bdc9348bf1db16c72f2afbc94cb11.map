{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\queue\\youtube-transcription.queue.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\queue\\youtube-transcription.queue.ts"],"sourcesContent":["// YouTube Transcription Queue implementation using RabbitMQ (or mock)\nimport amqplib, { ConsumeMessage } from 'amqplib';\nimport { Service } from 'typedi';\n\nimport { logger } from '../utils/logger';\n\n/**\n * Interface for a transcription job.\n */\nexport interface TranscriptionJob {\n  videoUrl: string;\n  recipientEmail: string;\n  fileName: string;\n  timestamp: string;\n}\n\n/**\n * Queue service responsible for publishing transcription jobs and starting a consumer.\n * In test environments the `amqplib` import is mocked (see src/__tests__/mocks/rabbitmq.ts).\n */\n@Service()\nexport class YoutubeTranscriptionQueue {\n  private connection!: any;\n  private channel!: any;\n  private readonly queueName = 'youtube-transcription';\n\n  /** Connects to RabbitMQ (or mock) and asserts the queue. */\n  private async ensureConnection(): Promise<void> {\n    if (this.channel && this.connection) {\n      return;\n    }\n    try {\n      this.connection = (await amqplib.connect(\n        process.env.RABBITMQ_URL || 'amqp://localhost',\n      )) as any;\n      this.channel = await this.connection.createChannel();\n      await this.channel.assertQueue(this.queueName, { durable: true });\n      logger.info('YoutubeTranscriptionQueue connected and queue asserted');\n    } catch (err) {\n      logger.warn('Failed to connect to RabbitMQ (Docker down?). Transcription features disabled.');\n      // throw err; // DISABLE THROW to allow server start\n    }\n  }\n\n  /** Publishes a transcription job to the queue. */\n  async publishTranscriptionJob(job: TranscriptionJob): Promise<boolean> {\n    try {\n      await this.ensureConnection();\n      if (!this.channel) {\n        logger.warn('Job skipped (RabbitMQ not available)');\n        return false;\n      }\n      const payload = Buffer.from(JSON.stringify(job));\n      const ok = this.channel.sendToQueue(this.queueName, payload, { persistent: true });\n      logger.info(`Transcription job enqueued for ${job.fileName}`);\n      return ok;\n    } catch (e) {\n      logger.error(e, 'Failed to publish transcription job');\n      return false;\n    }\n  }\n\n  /** Starts a consumer that processes jobs. */\n  async startConsumer(handler: (job: TranscriptionJob) => Promise<void>): Promise<void> {\n    await this.ensureConnection();\n    if (!this.channel) {\n      logger.warn('Consumer did not start (RabbitMQ not available)');\n      return;\n    }\n    await this.channel.consume(\n      this.queueName,\n      async (msg: ConsumeMessage | null) => {\n        if (!msg) {\n          return;\n        }\n        try {\n          const job: TranscriptionJob = JSON.parse(msg.content.toString());\n          await handler(job);\n          this.channel.ack(msg);\n        } catch (err) {\n          logger.error(err, 'Error processing transcription job');\n          this.channel.nack(msg, false, false); // discard bad message\n        }\n      },\n      { noAck: false },\n    );\n    logger.info('YoutubeTranscriptionQueue consumer started');\n  }\n}\n\n// Export a singleton instance for convenience (used by existing code)\nexport const youtubeTranscriptionQueue = new YoutubeTranscriptionQueue();\n"],"version":3}