{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\middleware\\auth.middleware.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\middleware\\auth.middleware.ts"],"sourcesContent":["import type { NextFunction, Request, Response } from 'express';\nimport jwt from 'jsonwebtoken';\nimport { config } from '../config';\nimport { User } from '../models/User';\nimport { logger } from '../utils/logger';\nimport { container } from '../config/inversify.config';\nimport { TYPES } from '../types';\nimport { DevicePostureService } from '../services/device-posture.service';\n\n// Extender la interfaz Request para incluir la propiedad user\ndeclare global {\n  namespace Express {\n    interface Request {\n      user?: {\n        id: string;\n        email: string;\n        role: string;\n      };\n    }\n  }\n}\n\nexport const protect = async (req: Request, res: Response, next: NextFunction) => {\n  // 0. Bypass for God Mode Authority or existing service-to-service user\n  const authorityKey = req.headers['x-nexus-authority'];\n  if (authorityKey === 'NEXUS_GOD_2026_SOVEREIGN') {\n    (req as any).user = {\n      id: 'god-mode-sovereign',\n      email: 'god@nexus.sovereign',\n      role: 'god',\n    };\n    logger.debug('[Auth] God Mode access granted via X-Nexus-Authority');\n    return next();\n  }\n\n  if ((req as any).user) {\n    return next();\n  }\n\n  let token: string | undefined;\n\n  // Obtener el token del encabezado Authorization\n  if (req.headers.authorization?.startsWith('Bearer')) {\n    token = req.headers.authorization.split(' ')[1];\n  }\n  // Obtener el token de las cookies (opcional)\n  else if (req.cookies?.token) {\n    token = req.cookies.token;\n  }\n\n  // Verificar si existe el token\n  if (!token) {\n    (res as any).status(401).json({\n      success: false,\n      message: 'No autorizado. Por favor inicie sesión para continuar.',\n    });\n    return;\n  }\n\n  try {\n    // 1. Verificar firma del token\n    const decoded = jwt.verify(token, config.jwt.secret) as {\n      id: string;\n      email: string;\n      role: string;\n      iat: number;\n      tokenVersion?: number;\n      fingerprint?: {\n        ip: string;\n        userAgent: string;\n        deviceId?: string;\n      };\n    };\n\n    // 2. Verificar fingerprint y Device Posture (Zero Trust)\n    if (decoded.fingerprint) {\n      const currentUserAgent = req.headers['user-agent'] || 'unknown';\n\n      // UA Mismatch check\n      if (\n        process.env.NODE_ENV === 'production' &&\n        decoded.fingerprint.userAgent !== currentUserAgent\n      ) {\n        logger.warn(\n          `UA Mismatch: ${decoded.id}. Token: ${decoded.fingerprint.userAgent} vs Req: ${currentUserAgent}`,\n        );\n        (res as any).status(401).json({ success: false, message: 'Sesión inválida.' });\n        return;\n      }\n\n      // Device Posture Check\n      if (decoded.fingerprint.deviceId) {\n        const devicePostureService = container.get<DevicePostureService>(\n          TYPES.DevicePostureService,\n        );\n        const postureCheck = await devicePostureService.verifyDevice(decoded.id, {\n          deviceId: decoded.fingerprint.deviceId,\n          os: 'unknown', // Would extract from UA or other headers\n          browser: currentUserAgent,\n        });\n\n        if (!postureCheck.isCompliant && (decoded.role === 'god' || decoded.role === 'admin')) {\n          logger.warn(`Security Breach attempt: Non-compliant device for role ${decoded.role}`, {\n            userId: decoded.id,\n            reason: postureCheck.reason,\n          });\n          (res as any).status(403).json({\n            success: false,\n            message: `Acceso denegado: Dispositivo no cumple con las políticas de seguridad (${postureCheck.reason}).`,\n          });\n          return;\n        }\n      }\n    }\n\n    // 3. Verificar persistencia en DB (CRÍTICO)\n    const user = await User.findById(decoded.id).select('+tokenVersion +lastPasswordChange');\n\n    if (!user) {\n      (res as any).status(401).json({ success: false, message: 'El usuario ya no existe.' });\n      return;\n    }\n\n    // 4. Verificar versión del token (Revocación Instantánea)\n    // Si el usuario incrementó su versión (logout global), tokens viejos mueren.\n    if (user.tokenVersion && decoded.tokenVersion !== undefined) {\n      if (decoded.tokenVersion !== user.tokenVersion) {\n        (res as any)\n          .status(401)\n          .json({ success: false, message: 'Token revocado. Inicie sesión nuevamente.' });\n        return;\n      }\n    }\n\n    // 5. Verificar cambio de contraseña reciente\n    // Si la contraseña cambió después de emitir el token, revocar.\n    if (user.lastPasswordChange) {\n      const changedTimestamp = Math.floor(user.lastPasswordChange.getTime() / 1000);\n      if (decoded.iat < changedTimestamp) {\n        (res as any).status(401).json({\n          success: false,\n          message: 'Contraseña cambiada recientemente. Inicie sesión nuevamente.',\n        });\n        return;\n      }\n    }\n\n    // Añadir usuario al objeto request\n    (req as any).user = {\n      id: user._id.toString(),\n      email: user.email,\n      role: user.role,\n    };\n\n    next();\n  } catch (error: any) {\n    logger.error(\n      {\n        error: error.message,\n        name: error.name,\n        stack: error.stack,\n        token: token?.substring(0, 10) + '...', // Log only start of token for security\n      },\n      'Auth Middleware Error',\n    );\n    (res as any).status(401).json({\n      success: false,\n      message: 'Sesión inválida o expirada.',\n    });\n    return;\n  }\n};;\n\n// Middleware para verificar roles de usuario\nexport const authorize = (...roles: string[]) => {\n  return (req: Request, res: Response, next: NextFunction) => {\n    if (!(req as any).user || !roles.includes((req as any).user.role)) {\n      (res as any).status(403).json({\n        success: false,\n        message: `El rol ${(req as any).user?.role} no tiene permiso para realizar esta acción.`,\n      });\n      return;\n    }\n    next();\n  };\n};\nexport const requireAuth = protect;\n"],"version":3}