{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\SovereignSentinelService.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\SovereignSentinelService.ts"],"sourcesContent":["import { injectable, inject } from 'inversify';\r\nimport { TYPES } from '../types';\r\nimport { MonitoringService } from './monitoring.service';\r\nimport { logger } from '../utils/logger';\r\nimport { config } from '../config/config';\r\n\r\nexport interface ResourceForecast {\r\n  metric: string;\r\n  currentValue: number;\r\n  predictedValue1h: number;\r\n  predictedValue24h: number;\r\n  timeToThresholdMs: number | null;\r\n  confidence: number;\r\n}\r\n\r\n@injectable()\r\nexport class SovereignSentinelService {\r\n  constructor(@inject(TYPES.MonitoringService) private monitoringService: MonitoringService) {}\r\n\r\n  public async getResourceForecasts(): Promise<ResourceForecast[]> {\r\n    const metricsToTrack = ['cpu_usage', 'memory_usage'];\r\n    const forecasts: ResourceForecast[] = [];\r\n\r\n    for (const metricName of metricsToTrack) {\r\n      try {\r\n        const forecast = await this.calculateForecast(metricName);\r\n        if (forecast) forecasts.push(forecast);\r\n      } catch (err) {\r\n        logger.error({ err, metricName }, '[SovereignSentinel] Forecast calculation failed');\r\n      }\r\n    }\r\n\r\n    return forecasts;\r\n  }\r\n\r\n  private async calculateForecast(metricName: string): Promise<ResourceForecast | null> {\r\n    const now = Date.now();\r\n    const startTime = now - 60 * 60 * 1000; // Last hour\r\n    const rawMetrics = await this.monitoringService.getMetricsInRange(metricName, startTime, now);\r\n\r\n    if (rawMetrics.length < 5) {\r\n      return null; // Not enough data for trend analysis\r\n    }\r\n\r\n    // Simplified Linear Regression: y = mx + b\r\n    const n = rawMetrics.length;\r\n    let sumX = 0;\r\n    let sumY = 0;\r\n    let sumXY = 0;\r\n    let sumXX = 0;\r\n\r\n    const baseTime = rawMetrics[0].timestamp.getTime();\r\n\r\n    for (const metric of rawMetrics) {\r\n      const x = (metric.timestamp.getTime() - baseTime) / 1000; // x in seconds from start\r\n      const y = metric.value;\r\n      sumX += x;\r\n      sumY += y;\r\n      sumXY += x * y;\r\n      sumXX += x * x;\r\n    }\r\n\r\n    const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);\r\n    const intercept = (sumY - slope * sumX) / n;\r\n\r\n    const currentX = (now - baseTime) / 1000;\r\n    const currentValue = rawMetrics[rawMetrics.length - 1].value;\r\n\r\n    // Predictions\r\n    const x1h = currentX + 3600;\r\n    const x24h = currentX + 86400;\r\n    const predicted1h = Math.max(0, slope * x1h + intercept);\r\n    const predicted24h = Math.max(0, slope * x24h + intercept);\r\n\r\n    // Threshold check\r\n    const threshold =\r\n      metricName === 'cpu_usage'\r\n        ? config.monitoring.cpuThreshold\r\n        : config.monitoring.memoryThreshold;\r\n\r\n    let timeToThresholdMs = null;\r\n    if (slope > 0) {\r\n      const xThreshold = (threshold - intercept) / slope;\r\n      if (xThreshold > currentX) {\r\n        timeToThresholdMs = (xThreshold - currentX) * 1000;\r\n      }\r\n    }\r\n\r\n    // Confidence heuristic based on R-squared (simplified)\r\n    const confidence = Math.min(0.95, n / 100); // Higher data frequency = higher confidence placeholder\r\n\r\n    return {\r\n      metric: metricName.replace('_usage', '').toUpperCase(),\r\n      currentValue,\r\n      predictedValue1h: predicted1h,\r\n      predictedValue24h: predicted24h,\r\n      timeToThresholdMs,\r\n      confidence,\r\n    };\r\n  }\r\n}\r\n"],"version":3}