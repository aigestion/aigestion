{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\threat-intelligence.service.ts","mappings":";;;;;;;;;;;;;;;AAAA,kDAA0B;AAC1B,yCAAuC;AAEvC,0CAAgD;AAChD,4CAAyC;AAuClC,IAAM,yBAAyB,GAA/B,MAAM,yBAAyB;IACnB,KAAK,CAAkB;IACvB,YAAY,GAAG,EAAE,GAAG,EAAE,CAAC,CAAC,SAAS;IAC1C,KAAK,GAAiB,EAAE,CAAC;IAChB,MAAM,GAAkB,EAAE,CAAC;IAC3B,SAAS,GAAG,KAAK,CAAC;IAEnC;QACE,IAAI,CAAC,KAAK,GAAG,IAAA,sBAAc,GAAE,CAAC;QAE9B,IAAI,CAAC,eAAe,EAAE,CAAC;QACvB,IAAI,CAAC,gBAAgB,EAAE,CAAC;IAC1B,CAAC;IAEO,eAAe;QACrB,kCAAkC;QAClC,IAAI,CAAC,KAAK,GAAG;YACX;gBACE,IAAI,EAAE,wBAAwB;gBAC9B,GAAG,EAAE,mDAAmD;gBACxD,IAAI,EAAE,QAAQ;gBACd,MAAM,EAAE,KAAK;gBACb,OAAO,EAAE,IAAI;gBACb,WAAW,EAAE,IAAI,IAAI,CAAC,CAAC,CAAC;gBACxB,cAAc,EAAE,EAAE,EAAE,SAAS;aAC9B;YACD;gBACE,IAAI,EAAE,qBAAqB;gBAC3B,GAAG,EAAE,uDAAuD;gBAC5D,IAAI,EAAE,QAAQ;gBACd,MAAM,EAAE,KAAK;gBACb,OAAO,EAAE,IAAI;gBACb,WAAW,EAAE,IAAI,IAAI,CAAC,CAAC,CAAC;gBACxB,cAAc,EAAE,GAAG,EAAE,UAAU;aAChC;YACD;gBACE,IAAI,EAAE,WAAW;gBACjB,GAAG,EAAE,mDAAmD;gBACxD,IAAI,EAAE,KAAK;gBACX,MAAM,EAAE,MAAM;gBACd,OAAO,EAAE,IAAI;gBACb,WAAW,EAAE,IAAI,IAAI,CAAC,CAAC,CAAC;gBACxB,cAAc,EAAE,EAAE,EAAE,SAAS;aAC9B;YACD;gBACE,IAAI,EAAE,uBAAuB;gBAC7B,GAAG,EAAE,sCAAsC;gBAC3C,IAAI,EAAE,MAAM;gBACZ,MAAM,EAAE,MAAM;gBACd,OAAO,EAAE,OAAO,CAAC,GAAG,CAAC,kBAAkB,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,KAAK;gBACtD,WAAW,EAAE,IAAI,IAAI,CAAC,CAAC,CAAC;gBACxB,cAAc,EAAE,EAAE,EAAE,aAAa;aAClC;SACF,CAAC;QAEF,eAAM,CAAC,IAAI,CAAC,uCAAuC,EAAE;YACnD,UAAU,EAAE,IAAI,CAAC,KAAK,CAAC,MAAM;YAC7B,YAAY,EAAE,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,MAAM;SACvD,CAAC,CAAC;IACL,CAAC;IAEO,gBAAgB;QACtB,4BAA4B;QAC5B,WAAW,CACT,KAAK,IAAI,EAAE;YACT,MAAM,IAAI,CAAC,cAAc,EAAE,CAAC;QAC9B,CAAC,EACD,CAAC,GAAG,EAAE,GAAG,IAAI,CACd,CAAC,CAAC,kBAAkB;QAErB,iBAAiB;QACjB,IAAI,CAAC,cAAc,EAAE,CAAC,KAAK,CAAC,KAAK,CAAC,EAAE;YAClC,eAAM,CAAC,KAAK,CAAC,6BAA6B,EAAE,KAAK,CAAC,CAAC;QACrD,CAAC,CAAC,CAAC;IACL,CAAC;IAED;;OAEG;IACI,KAAK,CAAC,cAAc,CAAC,EAAU;QACpC,IAAI,CAAC;YACH,oBAAoB;YACpB,MAAM,QAAQ,GAAG,aAAa,EAAE,EAAE,CAAC;YACnC,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;YAC9C,IAAI,MAAM,EAAE,CAAC;gBACX,MAAM,SAAS,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;gBACrC,IAAI,SAAS,CAAC,QAAQ,EAAE,CAAC;oBACvB,OAAO,SAAS,CAAC;gBACnB,CAAC;YACH,CAAC;YAED,6BAA6B;YAC7B,MAAM,UAAU,GAAG,MAAM,IAAI,CAAC,gBAAgB,CAAC,IAAI,EAAE,EAAE,CAAC,CAAC;YAEzD,IAAI,UAAU,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;gBAC1B,MAAM,SAAS,GAAG,UAAU,CAAC,CAAC,CAAC,CAAC,CAAC,mCAAmC;gBAEpE,eAAe;gBACf,MAAM,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,QAAQ,EAAE,IAAI,CAAC,YAAY,EAAE,IAAI,CAAC,SAAS,CAAC,SAAS,CAAC,CAAC,CAAC;gBAE/E,eAAe;gBACf,MAAM,IAAI,CAAC,WAAW,CAAC;oBACrB,EAAE,EAAE,IAAI,CAAC,eAAe,EAAE;oBAC1B,IAAI,EAAE,cAAc;oBACpB,QAAQ,EAAE,SAAS,CAAC,QAAQ;oBAC5B,SAAS,EAAE,EAAE;oBACb,WAAW,EAAE,0BAA0B,SAAS,CAAC,WAAW,EAAE;oBAC9D,MAAM,EAAE,SAAS,CAAC,MAAM;oBACxB,SAAS,EAAE,IAAI,IAAI,EAAE;oBACrB,SAAS,EAAE,EAAE;oBACb,MAAM,EAAE,IAAI,CAAC,eAAe,CAAC,SAAS,CAAC,QAAQ,CAAC;iBACjD,CAAC,CAAC;gBAEH,OAAO,SAAS,CAAC;YACnB,CAAC;YAED,OAAO,IAAI,CAAC;QACd,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,4BAA4B,EAAE,EAAE,EAAE,EAAE,KAAK,EAAE,CAAC,CAAC;YAC1D,OAAO,IAAI,CAAC;QACd,CAAC;IACH,CAAC;IAED;;OAEG;IACI,KAAK,CAAC,WAAW,CAAC,MAAc;QACrC,IAAI,CAAC;YACH,oBAAoB;YACpB,MAAM,QAAQ,GAAG,iBAAiB,MAAM,EAAE,CAAC;YAC3C,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;YAC9C,IAAI,MAAM,EAAE,CAAC;gBACX,MAAM,SAAS,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;gBACrC,IAAI,SAAS,CAAC,QAAQ,EAAE,CAAC;oBACvB,OAAO,SAAS,CAAC;gBACnB,CAAC;YACH,CAAC;YAED,6BAA6B;YAC7B,MAAM,UAAU,GAAG,MAAM,IAAI,CAAC,gBAAgB,CAAC,QAAQ,EAAE,MAAM,CAAC,CAAC;YAEjE,IAAI,UAAU,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;gBAC1B,MAAM,SAAS,GAAG,UAAU,CAAC,CAAC,CAAC,CAAC;gBAEhC,eAAe;gBACf,MAAM,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,QAAQ,EAAE,IAAI,CAAC,YAAY,EAAE,IAAI,CAAC,SAAS,CAAC,SAAS,CAAC,CAAC,CAAC;gBAE/E,eAAe;gBACf,MAAM,IAAI,CAAC,WAAW,CAAC;oBACrB,EAAE,EAAE,IAAI,CAAC,eAAe,EAAE;oBAC1B,IAAI,EAAE,kBAAkB;oBACxB,QAAQ,EAAE,SAAS,CAAC,QAAQ;oBAC5B,SAAS,EAAE,MAAM;oBACjB,WAAW,EAAE,8BAA8B,SAAS,CAAC,WAAW,EAAE;oBAClE,MAAM,EAAE,SAAS,CAAC,MAAM;oBACxB,SAAS,EAAE,IAAI,IAAI,EAAE;oBACrB,MAAM,EAAE,IAAI,CAAC,eAAe,CAAC,SAAS,CAAC,QAAQ,CAAC;iBACjD,CAAC,CAAC;gBAEH,OAAO,SAAS,CAAC;YACnB,CAAC;YAED,OAAO,IAAI,CAAC;QACd,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,wBAAwB,EAAE,EAAE,MAAM,EAAE,KAAK,EAAE,CAAC,CAAC;YAC1D,OAAO,IAAI,CAAC;QACd,CAAC;IACH,CAAC;IAED;;OAEG;IACI,KAAK,CAAC,QAAQ,CAAC,GAAW;QAC/B,IAAI,CAAC;YACH,0BAA0B;YAC1B,MAAM,MAAM,GAAG,IAAI,GAAG,CAAC,GAAG,CAAC,CAAC,QAAQ,CAAC;YAErC,qBAAqB;YACrB,MAAM,eAAe,GAAG,MAAM,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC;YACvD,IAAI,eAAe,EAAE,CAAC;gBACpB,OAAO,eAAe,CAAC;YACzB,CAAC;YAED,2BAA2B;YAC3B,MAAM,QAAQ,GAAG,cAAc,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,QAAQ,CAAC,QAAQ,CAAC,EAAE,CAAC;YACrE,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;YAC9C,IAAI,MAAM,EAAE,CAAC;gBACX,MAAM,SAAS,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;gBACrC,IAAI,SAAS,CAAC,QAAQ,EAAE,CAAC;oBACvB,OAAO,SAAS,CAAC;gBACnB,CAAC;YACH,CAAC;YAED,MAAM,UAAU,GAAG,MAAM,IAAI,CAAC,gBAAgB,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;YAE3D,IAAI,UAAU,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;gBAC1B,MAAM,SAAS,GAAG,UAAU,CAAC,CAAC,CAAC,CAAC;gBAEhC,eAAe;gBACf,MAAM,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,QAAQ,EAAE,IAAI,CAAC,YAAY,EAAE,IAAI,CAAC,SAAS,CAAC,SAAS,CAAC,CAAC,CAAC;gBAE/E,eAAe;gBACf,MAAM,IAAI,CAAC,WAAW,CAAC;oBACrB,EAAE,EAAE,IAAI,CAAC,eAAe,EAAE;oBAC1B,IAAI,EAAE,eAAe;oBACrB,QAAQ,EAAE,SAAS,CAAC,QAAQ;oBAC5B,SAAS,EAAE,GAAG;oBACd,WAAW,EAAE,2BAA2B,SAAS,CAAC,WAAW,EAAE;oBAC/D,MAAM,EAAE,SAAS,CAAC,MAAM;oBACxB,SAAS,EAAE,IAAI,IAAI,EAAE;oBACrB,MAAM,EAAE,IAAI,CAAC,eAAe,CAAC,SAAS,CAAC,QAAQ,CAAC;iBACjD,CAAC,CAAC;gBAEH,OAAO,SAAS,CAAC;YACnB,CAAC;YAED,OAAO,IAAI,CAAC;QACd,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,qBAAqB,EAAE,EAAE,GAAG,EAAE,KAAK,EAAE,CAAC,CAAC;YACpD,OAAO,IAAI,CAAC;QACd,CAAC;IACH,CAAC;IAED;;OAEG;IACI,KAAK,CAAC,SAAS,CAAC,IAAY;QACjC,IAAI,CAAC;YACH,oBAAoB;YACpB,MAAM,QAAQ,GAAG,eAAe,IAAI,EAAE,CAAC;YACvC,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;YAC9C,IAAI,MAAM,EAAE,CAAC;gBACX,MAAM,SAAS,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;gBACrC,IAAI,SAAS,CAAC,QAAQ,EAAE,CAAC;oBACvB,OAAO,SAAS,CAAC;gBACnB,CAAC;YACH,CAAC;YAED,6BAA6B;YAC7B,MAAM,UAAU,GAAG,MAAM,IAAI,CAAC,gBAAgB,CAAC,MAAM,EAAE,IAAI,CAAC,CAAC;YAE7D,IAAI,UAAU,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;gBAC1B,MAAM,SAAS,GAAG,UAAU,CAAC,CAAC,CAAC,CAAC;gBAEhC,eAAe;gBACf,MAAM,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,QAAQ,EAAE,IAAI,CAAC,YAAY,EAAE,IAAI,CAAC,SAAS,CAAC,SAAS,CAAC,CAAC,CAAC;gBAE/E,eAAe;gBACf,MAAM,IAAI,CAAC,WAAW,CAAC;oBACrB,EAAE,EAAE,IAAI,CAAC,eAAe,EAAE;oBAC1B,IAAI,EAAE,gBAAgB;oBACtB,QAAQ,EAAE,SAAS,CAAC,QAAQ;oBAC5B,SAAS,EAAE,IAAI;oBACf,WAAW,EAAE,iCAAiC,SAAS,CAAC,WAAW,EAAE;oBACrE,MAAM,EAAE,SAAS,CAAC,MAAM;oBACxB,SAAS,EAAE,IAAI,IAAI,EAAE;oBACrB,MAAM,EAAE,IAAI,CAAC,eAAe,CAAC,SAAS,CAAC,QAAQ,CAAC;iBACjD,CAAC,CAAC;gBAEH,OAAO,SAAS,CAAC;YACnB,CAAC;YAED,OAAO,IAAI,CAAC;QACd,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,sBAAsB,EAAE,EAAE,IAAI,EAAE,KAAK,EAAE,CAAC,CAAC;YACtD,OAAO,IAAI,CAAC;QACd,CAAC;IACH,CAAC;IAED;;OAEG;IACK,KAAK,CAAC,gBAAgB,CAAC,IAAY,EAAE,KAAa;QACxD,MAAM,UAAU,GAAsB,EAAE,CAAC;QAEzC,KAAK,MAAM,IAAI,IAAI,IAAI,CAAC,KAAK,EAAE,CAAC;YAC9B,IAAI,CAAC,IAAI,CAAC,OAAO,IAAI,IAAI,CAAC,IAAI,KAAK,IAAI,EAAE,CAAC;gBACxC,SAAS;YACX,CAAC;YAED,IAAI,CAAC;gBACH,MAAM,cAAc,GAAG,MAAM,IAAI,CAAC,SAAS,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;gBACzD,UAAU,CAAC,IAAI,CAAC,GAAG,cAAc,CAAC,CAAC;YACrC,CAAC;YAAC,OAAO,KAAK,EAAE,CAAC;gBACf,eAAM,CAAC,KAAK,CAAC,sBAAsB,EAAE,EAAE,IAAI,EAAE,IAAI,CAAC,IAAI,EAAE,KAAK,EAAE,CAAC,CAAC;YACnE,CAAC;QACH,CAAC;QAED,kCAAkC;QAClC,OAAO,UAAU,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE;YAC9B,IAAI,CAAC,CAAC,QAAQ,KAAK,CAAC,CAAC,QAAQ,EAAE,CAAC;gBAC9B,MAAM,aAAa,GAAG,EAAE,QAAQ,EAAE,CAAC,EAAE,IAAI,EAAE,CAAC,EAAE,MAAM,EAAE,CAAC,EAAE,GAAG,EAAE,CAAC,EAAE,CAAC;gBAClE,OAAO,aAAa,CAAC,CAAC,CAAC,QAAQ,CAAC,GAAG,aAAa,CAAC,CAAC,CAAC,QAAQ,CAAC,CAAC;YAC/D,CAAC;YACD,OAAO,CAAC,CAAC,UAAU,GAAG,CAAC,CAAC,UAAU,CAAC;QACrC,CAAC,CAAC,CAAC;IACL,CAAC;IAED;;OAEG;IACK,KAAK,CAAC,SAAS,CAAC,IAAgB,EAAE,KAAa;QACrD,MAAM,UAAU,GAAsB,EAAE,CAAC;QAEzC,IAAI,CAAC;YACH,QAAQ,IAAI,CAAC,MAAM,EAAE,CAAC;gBACpB,KAAK,KAAK;oBACR,UAAU,CAAC,IAAI,CAAC,GAAG,CAAC,MAAM,IAAI,CAAC,aAAa,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC,CAAC,CAAC;oBAC5D,MAAM;gBACR,KAAK,MAAM;oBACT,UAAU,CAAC,IAAI,CAAC,GAAG,CAAC,MAAM,IAAI,CAAC,aAAa,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC,CAAC,CAAC;oBAC5D,MAAM;gBACR,KAAK,KAAK;oBACR,UAAU,CAAC,IAAI,CAAC,GAAG,CAAC,MAAM,IAAI,CAAC,YAAY,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC,CAAC,CAAC;oBAC3D,MAAM;YACV,CAAC;QACH,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,6BAA6B,EAAE,EAAE,IAAI,EAAE,IAAI,CAAC,IAAI,EAAE,MAAM,EAAE,IAAI,CAAC,MAAM,EAAE,KAAK,EAAE,CAAC,CAAC;QAC/F,CAAC;QAED,OAAO,UAAU,CAAC;IACpB,CAAC;IAED;;OAEG;IACK,KAAK,CAAC,aAAa,CAAC,IAAgB,EAAE,KAAa;QACzD,MAAM,QAAQ,GAAG,QAAQ,IAAI,CAAC,IAAI,EAAE,CAAC;QACrC,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;QAE9C,IAAI,MAAM,EAAE,CAAC;YACX,MAAM,KAAK,GAAG,MAAM,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;YACjC,MAAM,KAAK,GAAG,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE;gBAC9B,kCAAkC;gBAClC,MAAM,SAAS,GAAG,IAAI,CAAC,IAAI,EAAE,CAAC;gBAC9B,IAAI,SAAS,CAAC,UAAU,CAAC,GAAG,CAAC,IAAI,SAAS,KAAK,EAAE,EAAE,CAAC;oBAClD,OAAO,KAAK,CAAC;gBACf,CAAC;gBACD,OAAO,SAAS,KAAK,KAAK,IAAI,SAAS,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;YAC1D,CAAC,CAAC,CAAC;YAEH,IAAI,KAAK,EAAE,CAAC;gBACV,OAAO;oBACL;wBACE,IAAI,EAAE,IAAI,CAAC,IAAW;wBACtB,KAAK;wBACL,MAAM,EAAE,IAAI,CAAC,IAAI;wBACjB,UAAU,EAAE,GAAG;wBACf,QAAQ,EAAE,QAAiB;wBAC3B,WAAW,EAAE,YAAY,IAAI,CAAC,IAAI,EAAE;wBACpC,IAAI,EAAE,CAAC,aAAa,CAAC;wBACrB,SAAS,EAAE,IAAI,IAAI,EAAE;wBACrB,QAAQ,EAAE,IAAI,IAAI,EAAE;wBACpB,QAAQ,EAAE,IAAI;qBACf;iBACF,CAAC;YACJ,CAAC;YACD,OAAO,EAAE,CAAC;QACZ,CAAC;aAAM,CAAC;YACN,2DAA2D;YAC3D,MAAM,QAAQ,GAAG,MAAM,eAAK,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,EAAE,EAAE,YAAY,EAAE,QAAQ,EAAE,OAAO,EAAE,KAAK,EAAE,CAAC,CAAC;YACvF,MAAM,MAAM,GAAG,QAAQ,CAAC,IAA6B,CAAC;YACtD,MAAM,EAAE,GAAG,OAAO,CAAC,UAAU,CAAC,CAAC,eAAe,CAAC,EAAE,KAAK,EAAE,MAAM,EAAE,SAAS,EAAE,QAAQ,EAAE,CAAC,CAAC;YACvF,IAAI,KAAK,GAAG,KAAK,CAAC;YAClB,IAAI,KAAK,EAAE,MAAM,IAAI,IAAI,EAAE,EAAE,CAAC;gBAC5B,MAAM,SAAS,GAAG,IAAI,CAAC,IAAI,EAAE,CAAC;gBAC9B,IAAI,CAAC,SAAS,IAAI,SAAS,CAAC,UAAU,CAAC,GAAG,CAAC;oBAAE,SAAS;gBACtD,IAAI,SAAS,KAAK,KAAK,IAAI,SAAS,CAAC,QAAQ,CAAC,KAAK,CAAC,EAAE,CAAC;oBACrD,KAAK,GAAG,IAAI,CAAC;oBACb,MAAM;gBACR,CAAC;YACH,CAAC;YACD,6EAA6E;YAC7E,IAAI,KAAK,EAAE,CAAC;gBACV,OAAO;oBACL;wBACE,IAAI,EAAE,IAAI,CAAC,IAAW;wBACtB,KAAK;wBACL,MAAM,EAAE,IAAI,CAAC,IAAI;wBACjB,UAAU,EAAE,GAAG;wBACf,QAAQ,EAAE,QAAiB;wBAC3B,WAAW,EAAE,YAAY,IAAI,CAAC,IAAI,EAAE;wBACpC,IAAI,EAAE,CAAC,aAAa,CAAC;wBACrB,SAAS,EAAE,IAAI,IAAI,EAAE;wBACrB,QAAQ,EAAE,IAAI,IAAI,EAAE;wBACpB,QAAQ,EAAE,IAAI;qBACf;iBACF,CAAC;YACJ,CAAC;YACD,OAAO,EAAE,CAAC;QACZ,CAAC;IACH,CAAC;IAED;;OAEG;IACK,KAAK,CAAC,aAAa,CAAC,IAAgB,EAAE,KAAa;QACzD,MAAM,QAAQ,GAAG,QAAQ,IAAI,CAAC,IAAI,EAAE,CAAC;QACrC,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;QAE9C,IAAI,QAAa,CAAC;QAClB,IAAI,MAAM,EAAE,CAAC;YACX,QAAQ,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;QAChC,CAAC;aAAM,CAAC;YACN,MAAM,QAAQ,GAAG,MAAM,eAAK,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,EAAE,EAAE,OAAO,EAAE,KAAK,EAAE,CAAC,CAAC;YAC/D,QAAQ,GAAG,QAAQ,CAAC,IAAI,CAAC;YACzB,MAAM,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,QAAQ,EAAE,IAAI,CAAC,cAAc,GAAG,EAAE,EAAE,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,CAAC,CAAC;QACvF,CAAC;QAED,gCAAgC;QAChC,IAAI,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,WAAW,CAAC,EAAE,CAAC;YACpC,OAAO,IAAI,CAAC,kBAAkB,CAAC,QAAQ,EAAE,KAAK,CAAC,CAAC;QAClD,CAAC;aAAM,IAAI,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,YAAY,CAAC,EAAE,CAAC;YAC5C,OAAO,MAAM,IAAI,CAAC,mBAAmB,CAAC,KAAK,CAAC,CAAC;QAC/C,CAAC;QAED,OAAO,EAAE,CAAC;IACZ,CAAC;IAED;;OAEG;IACK,kBAAkB,CAAC,QAAa,EAAE,KAAa;QACrD,IAAI,CAAC,QAAQ,CAAC,IAAI,EAAE,CAAC;YACnB,OAAO,EAAE,CAAC;QACZ,CAAC;QAED,MAAM,OAAO,GAAG,QAAQ,CAAC,IAAI,CAAC,MAAM,CAClC,CAAC,KAAU,EAAE,EAAE,CAAC,KAAK,CAAC,GAAG,KAAK,KAAK,IAAI,KAAK,CAAC,GAAG,CAAC,QAAQ,CAAC,KAAK,CAAC,CACjE,CAAC;QAEF,OAAO,OAAO,CAAC,GAAG,CAAC,CAAC,KAAU,EAAE,EAAE,CAAC,CAAC;YAClC,IAAI,EAAE,KAAc;YACpB,KAAK;YACL,MAAM,EAAE,WAAW;YACnB,UAAU,EAAE,KAAK,CAAC,gBAAgB,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,GAAG;YAC9C,QAAQ,EAAE,MAAe;YACzB,WAAW,EAAE,KAAK,CAAC,gBAAgB,IAAI,uBAAuB;YAC9D,IAAI,EAAE,CAAC,UAAU,EAAE,KAAK,CAAC;YACzB,SAAS,EAAE,IAAI,IAAI,CAAC,KAAK,CAAC,eAAe,CAAC;YAC1C,QAAQ,EAAE,IAAI,IAAI,EAAE;YACpB,QAAQ,EAAE,IAAI;SACf,CAAC,CAAC,CAAC;IACN,CAAC;IAED;;OAEG;IACK,KAAK,CAAC,mBAAmB,CAAC,IAAY;QAC5C,MAAM,MAAM,GAAG,OAAO,CAAC,GAAG,CAAC,kBAAkB,CAAC;QAC9C,IAAI,CAAC,MAAM,EAAE,CAAC;YACZ,OAAO,EAAE,CAAC;QACZ,CAAC;QAED,IAAI,CAAC;YACH,MAAM,QAAQ,GAAG,MAAM,eAAK,CAAC,GAAG,CAAC,iDAAiD,EAAE;gBAClF,MAAM,EAAE;oBACN,MAAM,EAAE,MAAM;oBACd,QAAQ,EAAE,IAAI;iBACf;gBACD,OAAO,EAAE,KAAK;aACf,CAAC,CAAC;YAEH,MAAM,IAAI,GAAG,QAAQ,CAAC,IAAI,CAAC;YAE3B,IAAI,IAAI,CAAC,SAAS,GAAG,CAAC,IAAI,IAAI,CAAC,KAAK,GAAG,CAAC,EAAE,CAAC;gBACzC,MAAM,KAAK,GAAG,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,KAAK,CAAC;gBAC1C,6BAA6B;gBAC7B,IAAI,QAAQ,GAA2C,KAAK,CAAC;gBAE7D,IAAI,KAAK,IAAI,GAAG;oBAAE,QAAQ,GAAG,UAAU,CAAC;qBACnC,IAAI,KAAK,IAAI,GAAG;oBAAE,QAAQ,GAAG,MAAM,CAAC;qBACpC,IAAI,KAAK,IAAI,GAAG;oBAAE,QAAQ,GAAG,QAAQ,CAAC;gBAE3C,OAAO;oBACL;wBACE,IAAI,EAAE,MAAe;wBACrB,KAAK,EAAE,IAAI;wBACX,MAAM,EAAE,YAAY;wBACpB,UAAU,EAAE,KAAK;wBACjB,QAAQ;wBACR,WAAW,EAAE,uBAAuB,IAAI,CAAC,SAAS,IAAI,IAAI,CAAC,KAAK,UAAU;wBAC1E,IAAI,EAAE,CAAC,SAAS,EAAE,MAAM,CAAC;wBACzB,SAAS,EAAE,IAAI,IAAI,CAAC,IAAI,CAAC,SAAS,IAAI,IAAI,CAAC,GAAG,EAAE,CAAC;wBACjD,QAAQ,EAAE,IAAI,IAAI,EAAE;wBACpB,QAAQ,EAAE,IAAI;qBACf;iBACF,CAAC;YACJ,CAAC;QACH,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,uBAAuB,EAAE,KAAK,CAAC,CAAC;QAC/C,CAAC;QAED,OAAO,EAAE,CAAC;IACZ,CAAC;IAED;;OAEG;IACK,KAAK,CAAC,YAAY,CAAC,IAAgB,EAAE,KAAa;QACxD,+BAA+B;QAC/B,OAAO,EAAE,CAAC;IACZ,CAAC;IAED;;OAEG;IACK,KAAK,CAAC,cAAc;QAC1B,eAAM,CAAC,IAAI,CAAC,uCAAuC,CAAC,CAAC;QAErD,KAAK,MAAM,IAAI,IAAI,IAAI,CAAC,KAAK,EAAE,CAAC;YAC9B,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,CAAC;gBAClB,SAAS;YACX,CAAC;YAED,IAAI,CAAC;gBACH,MAAM,QAAQ,GAAG,QAAQ,IAAI,CAAC,IAAI,EAAE,CAAC;gBACrC,MAAM,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC,CAAC,gBAAgB;gBAEhD,eAAM,CAAC,KAAK,CAAC,cAAc,EAAE,EAAE,IAAI,EAAE,IAAI,CAAC,IAAI,EAAE,CAAC,CAAC;YACpD,CAAC;YAAC,OAAO,KAAK,EAAE,CAAC;gBACf,eAAM,CAAC,KAAK,CAAC,sBAAsB,EAAE,EAAE,IAAI,EAAE,IAAI,CAAC,IAAI,EAAE,KAAK,EAAE,CAAC,CAAC;YACnE,CAAC;QACH,CAAC;QAED,eAAM,CAAC,IAAI,CAAC,4CAA4C,CAAC,CAAC;IAC5D,CAAC;IAED;;OAEG;IACK,KAAK,CAAC,WAAW,CAAC,KAAkB;QAC1C,IAAI,CAAC;YACH,gBAAgB;YAChB,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;YAExB,0BAA0B;YAC1B,IAAI,IAAI,CAAC,MAAM,CAAC,MAAM,GAAG,IAAI,CAAC,SAAS,EAAE,CAAC;gBACxC,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,EAAE,IAAI,CAAC,MAAM,CAAC,MAAM,GAAG,IAAI,CAAC,SAAS,CAAC,CAAC;YAC7D,CAAC;YAED,iBAAiB;YACjB,MAAM,IAAI,CAAC,KAAK,CAAC,KAAK,CACpB,SAAS,KAAK,CAAC,EAAE,EAAE,EACnB,EAAE,GAAG,EAAE,GAAG,EAAE,EAAE,WAAW;YACzB,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,CACtB,CAAC;YAEF,qBAAqB;YACrB,MAAM,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,eAAe,EAAE,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC,CAAC;YAC/D,MAAM,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,eAAe,EAAE,CAAC,EAAE,GAAG,CAAC,CAAC,CAAC,iBAAiB;YAElE,eAAM,CAAC,IAAI,CAAC,sBAAsB,EAAE;gBAClC,EAAE,EAAE,KAAK,CAAC,EAAE;gBACZ,IAAI,EAAE,KAAK,CAAC,IAAI;gBAChB,QAAQ,EAAE,KAAK,CAAC,QAAQ;gBACxB,SAAS,EAAE,KAAK,CAAC,SAAS;gBAC1B,MAAM,EAAE,KAAK,CAAC,MAAM;aACrB,CAAC,CAAC;QACL,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,8BAA8B,EAAE,KAAK,CAAC,CAAC;QACtD,CAAC;IACH,CAAC;IAED;;OAEG;IACK,eAAe,CAAC,QAAgB;QACtC,QAAQ,QAAQ,EAAE,CAAC;YACjB,KAAK,UAAU,CAAC;YAChB,KAAK,MAAM;gBACT,OAAO,OAAO,CAAC;YACjB,KAAK,QAAQ;gBACX,OAAO,MAAM,CAAC;YAChB;gBACE,OAAO,SAAS,CAAC;QACrB,CAAC;IACH,CAAC;IAED;;OAEG;IACK,eAAe;QACrB,OAAO,SAAS,IAAI,CAAC,GAAG,EAAE,IAAI,IAAI,CAAC,MAAM,EAAE,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC,CAAC,EAAE,CAAC;IAC1E,CAAC;IAED;;OAEG;IACI,KAAK,CAAC,eAAe,CAAC,QAAgB,GAAG;QAC9C,IAAI,CAAC;YACH,MAAM,SAAS,GAAG,MAAM,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,eAAe,EAAE,CAAC,EAAE,KAAK,GAAG,CAAC,CAAC,CAAC;YACzE,OAAO,SAAS,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC;QACjD,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,8BAA8B,EAAE,KAAK,CAAC,CAAC;YACpD,OAAO,EAAE,CAAC;QACZ,CAAC;IACH,CAAC;IAED;;OAEG;IACI,KAAK,CAAC,QAAQ;QAQnB,IAAI,CAAC;YACH,MAAM,UAAU,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC;YACrC,MAAM,WAAW,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,MAAM,CAAC;YAC7D,MAAM,WAAW,GAAG,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC;YAEvC,MAAM,gBAAgB,GAA8B,EAAE,CAAC;YACvD,MAAM,YAAY,GAA8B,EAAE,CAAC;YAEnD,IAAI,CAAC,MAAM,CAAC,OAAO,CAAC,KAAK,CAAC,EAAE;gBAC1B,gBAAgB,CAAC,KAAK,CAAC,QAAQ,CAAC,GAAG,CAAC,gBAAgB,CAAC,KAAK,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC,GAAG,CAAC,CAAC;gBAC/E,YAAY,CAAC,KAAK,CAAC,IAAI,CAAC,GAAG,CAAC,YAAY,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,GAAG,CAAC,CAAC;YACjE,CAAC,CAAC,CAAC;YAEH,MAAM,YAAY,GAAG,MAAM,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,eAAe,CAAC,CAAC;YAE5D,OAAO;gBACL,UAAU;gBACV,WAAW;gBACX,WAAW;gBACX,gBAAgB;gBAChB,YAAY;gBACZ,YAAY;aACb,CAAC;QACJ,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,6BAA6B,EAAE,KAAK,CAAC,CAAC;YACnD,OAAO;gBACL,UAAU,EAAE,CAAC;gBACb,WAAW,EAAE,CAAC;gBACd,WAAW,EAAE,CAAC;gBACd,gBAAgB,EAAE,EAAE;gBACpB,YAAY,EAAE,EAAE;gBAChB,YAAY,EAAE,CAAC;aAChB,CAAC;QACJ,CAAC;IACH,CAAC;IAED;;OAEG;IACI,KAAK,CAAC,kBAAkB,CAC7B,SAAuE;QAEvE,IAAI,CAAC;YACH,MAAM,aAAa,GAAoB;gBACrC,GAAG,SAAS;gBACZ,SAAS,EAAE,IAAI,IAAI,EAAE;gBACrB,QAAQ,EAAE,IAAI,IAAI,EAAE;gBACpB,QAAQ,EAAE,IAAI;aACf,CAAC;YAEF,MAAM,QAAQ,GAAG,iBAAiB,SAAS,CAAC,IAAI,IAAI,SAAS,CAAC,KAAK,EAAE,CAAC;YACtE,MAAM,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,QAAQ,EAAE,IAAI,CAAC,YAAY,EAAE,IAAI,CAAC,SAAS,CAAC,aAAa,CAAC,CAAC,CAAC;YAEnF,eAAM,CAAC,IAAI,CAAC,+BAA+B,EAAE;gBAC3C,IAAI,EAAE,SAAS,CAAC,IAAI;gBACpB,KAAK,EAAE,SAAS,CAAC,KAAK;gBACtB,MAAM,EAAE,SAAS,CAAC,MAAM;aACzB,CAAC,CAAC;YAEH,OAAO,IAAI,CAAC;QACd,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,gCAAgC,EAAE,KAAK,CAAC,CAAC;YACtD,OAAO,KAAK,CAAC;QACf,CAAC;IACH,CAAC;IAED;;OAEG;IACI,KAAK,CAAC,UAAU,CAAC,QAAgB,EAAE,OAAgB;QACxD,IAAI,CAAC;YACH,MAAM,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,KAAK,QAAQ,CAAC,CAAC;YACvD,IAAI,CAAC,IAAI,EAAE,CAAC;gBACV,OAAO,KAAK,CAAC;YACf,CAAC;YAED,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;YACvB,eAAM,CAAC,IAAI,CAAC,eAAe,QAAQ,IAAI,OAAO,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,UAAU,EAAE,CAAC,CAAC;YAE3E,OAAO,IAAI,CAAC;QACd,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,sBAAsB,EAAE,EAAE,QAAQ,EAAE,KAAK,EAAE,CAAC,CAAC;YAC1D,OAAO,KAAK,CAAC;QACf,CAAC;IACH,CAAC;IAED;;OAEG;IACI,QAAQ;QACb,OAAO,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC,EAAE,GAAG,IAAI,EAAE,CAAC,CAAC,CAAC;IAC/C,CAAC;CACF,CAAA;AA9rBY,8DAAyB;oCAAzB,yBAAyB;IADrC,IAAA,sBAAU,GAAE;;GACA,yBAAyB,CA8rBrC","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\threat-intelligence.service.ts"],"sourcesContent":["import axios from 'axios';\nimport { injectable } from 'inversify';\nimport type { RedisClientType } from 'redis';\nimport { getRedisClient } from '../cache/redis';\nimport { logger } from '../utils/logger';\n\ninterface ThreatIndicator {\n  type: 'ip' | 'domain' | 'url' | 'hash' | 'email';\n  value: string;\n  source: string;\n  confidence: number;\n  severity: 'low' | 'medium' | 'high' | 'critical';\n  description: string;\n  tags: string[];\n  firstSeen: Date;\n  lastSeen: Date;\n  isActive: boolean;\n}\n\ninterface ThreatFeed {\n  name: string;\n  url: string;\n  type: 'ip' | 'domain' | 'hash' | 'url';\n  format: 'json' | 'txt' | 'csv';\n  enabled: boolean;\n  lastUpdated: Date;\n  updateInterval: number; // minutes\n}\n\ninterface ThreatAlert {\n  id: string;\n  type: string;\n  severity: 'low' | 'medium' | 'high' | 'critical';\n  indicator: string;\n  description: string;\n  source: string;\n  timestamp: Date;\n  userId?: string;\n  ipAddress?: string;\n  action: 'block' | 'warn' | 'monitor';\n}\n\n@injectable()\nexport class ThreatIntelligenceService {\n  private readonly redis: RedisClientType;\n  private readonly cacheTimeout = 60 * 60; // 1 hour\n  private feeds: ThreatFeed[] = [];\n  private readonly alerts: ThreatAlert[] = [];\n  private readonly maxAlerts = 10000;\n\n  constructor() {\n    this.redis = getRedisClient();\n\n    this.initializeFeeds();\n    this.startFeedUpdates();\n  }\n\n  private initializeFeeds() {\n    // Initialize default threat feeds\n    this.feeds = [\n      {\n        name: 'Abuse.ch SSL Blacklist',\n        url: 'https://sslbl.abuse.ch/downloads/SSLBLACKLIST.txt',\n        type: 'domain',\n        format: 'txt',\n        enabled: true,\n        lastUpdated: new Date(0),\n        updateInterval: 60, // 1 hour\n      },\n      {\n        name: 'Malware Domain List',\n        url: 'https://www.malwaredomainlist.com/hostslist/hosts.txt',\n        type: 'domain',\n        format: 'txt',\n        enabled: true,\n        lastUpdated: new Date(0),\n        updateInterval: 120, // 2 hours\n      },\n      {\n        name: 'PhishTank',\n        url: 'https://data.phishtank.com/data/online-valid.json',\n        type: 'url',\n        format: 'json',\n        enabled: true,\n        lastUpdated: new Date(0),\n        updateInterval: 60, // 1 hour\n      },\n      {\n        name: 'VirusTotal Public API',\n        url: 'https://www.virustotal.com/vtapi/v2/',\n        type: 'hash',\n        format: 'json',\n        enabled: process.env.VIRUSTOTAL_API_KEY ? true : false,\n        lastUpdated: new Date(0),\n        updateInterval: 30, // 30 minutes\n      },\n    ];\n\n    logger.info('Threat intelligence feeds initialized', {\n      totalFeeds: this.feeds.length,\n      enabledFeeds: this.feeds.filter(f => f.enabled).length,\n    });\n  }\n\n  private startFeedUpdates() {\n    // Update feeds periodically\n    setInterval(\n      async () => {\n        await this.updateAllFeeds();\n      },\n      5 * 60 * 1000,\n    ); // Every 5 minutes\n\n    // Initial update\n    this.updateAllFeeds().catch(error => {\n      logger.error('Initial feed update failed:', error);\n    });\n  }\n\n  /**\n   * Check if IP address is malicious\n   */\n  public async checkIPAddress(ip: string): Promise<ThreatIndicator | null> {\n    try {\n      // Check cache first\n      const cacheKey = `threat:ip:${ip}`;\n      const cached = await this.redis.get(cacheKey);\n      if (cached) {\n        const indicator = JSON.parse(cached);\n        if (indicator.isActive) {\n          return indicator;\n        }\n      }\n\n      // Check against threat feeds\n      const indicators = await this.checkThreatFeeds('ip', ip);\n\n      if (indicators.length > 0) {\n        const indicator = indicators[0]; // Use highest confidence indicator\n\n        // Cache result\n        await this.redis.setEx(cacheKey, this.cacheTimeout, JSON.stringify(indicator));\n\n        // Create alert\n        await this.createAlert({\n          id: this.generateAlertId(),\n          type: 'malicious_ip',\n          severity: indicator.severity,\n          indicator: ip,\n          description: `Malicious IP detected: ${indicator.description}`,\n          source: indicator.source,\n          timestamp: new Date(),\n          ipAddress: ip,\n          action: this.determineAction(indicator.severity),\n        });\n\n        return indicator;\n      }\n\n      return null;\n    } catch (error) {\n      logger.error('Error checking IP address:', { ip, error });\n      return null;\n    }\n  }\n\n  /**\n   * Check if domain is malicious\n   */\n  public async checkDomain(domain: string): Promise<ThreatIndicator | null> {\n    try {\n      // Check cache first\n      const cacheKey = `threat:domain:${domain}`;\n      const cached = await this.redis.get(cacheKey);\n      if (cached) {\n        const indicator = JSON.parse(cached);\n        if (indicator.isActive) {\n          return indicator;\n        }\n      }\n\n      // Check against threat feeds\n      const indicators = await this.checkThreatFeeds('domain', domain);\n\n      if (indicators.length > 0) {\n        const indicator = indicators[0];\n\n        // Cache result\n        await this.redis.setEx(cacheKey, this.cacheTimeout, JSON.stringify(indicator));\n\n        // Create alert\n        await this.createAlert({\n          id: this.generateAlertId(),\n          type: 'malicious_domain',\n          severity: indicator.severity,\n          indicator: domain,\n          description: `Malicious domain detected: ${indicator.description}`,\n          source: indicator.source,\n          timestamp: new Date(),\n          action: this.determineAction(indicator.severity),\n        });\n\n        return indicator;\n      }\n\n      return null;\n    } catch (error) {\n      logger.error('Error checking domain:', { domain, error });\n      return null;\n    }\n  }\n\n  /**\n   * Check if URL is malicious\n   */\n  public async checkURL(url: string): Promise<ThreatIndicator | null> {\n    try {\n      // Extract domain from URL\n      const domain = new URL(url).hostname;\n\n      // Check domain first\n      const domainIndicator = await this.checkDomain(domain);\n      if (domainIndicator) {\n        return domainIndicator;\n      }\n\n      // Check URL-specific feeds\n      const cacheKey = `threat:url:${Buffer.from(url).toString('base64')}`;\n      const cached = await this.redis.get(cacheKey);\n      if (cached) {\n        const indicator = JSON.parse(cached);\n        if (indicator.isActive) {\n          return indicator;\n        }\n      }\n\n      const indicators = await this.checkThreatFeeds('url', url);\n\n      if (indicators.length > 0) {\n        const indicator = indicators[0];\n\n        // Cache result\n        await this.redis.setEx(cacheKey, this.cacheTimeout, JSON.stringify(indicator));\n\n        // Create alert\n        await this.createAlert({\n          id: this.generateAlertId(),\n          type: 'malicious_url',\n          severity: indicator.severity,\n          indicator: url,\n          description: `Malicious URL detected: ${indicator.description}`,\n          source: indicator.source,\n          timestamp: new Date(),\n          action: this.determineAction(indicator.severity),\n        });\n\n        return indicator;\n      }\n\n      return null;\n    } catch (error) {\n      logger.error('Error checking URL:', { url, error });\n      return null;\n    }\n  }\n\n  /**\n   * Check if file hash is malicious\n   */\n  public async checkHash(hash: string): Promise<ThreatIndicator | null> {\n    try {\n      // Check cache first\n      const cacheKey = `threat:hash:${hash}`;\n      const cached = await this.redis.get(cacheKey);\n      if (cached) {\n        const indicator = JSON.parse(cached);\n        if (indicator.isActive) {\n          return indicator;\n        }\n      }\n\n      // Check against threat feeds\n      const indicators = await this.checkThreatFeeds('hash', hash);\n\n      if (indicators.length > 0) {\n        const indicator = indicators[0];\n\n        // Cache result\n        await this.redis.setEx(cacheKey, this.cacheTimeout, JSON.stringify(indicator));\n\n        // Create alert\n        await this.createAlert({\n          id: this.generateAlertId(),\n          type: 'malicious_hash',\n          severity: indicator.severity,\n          indicator: hash,\n          description: `Malicious file hash detected: ${indicator.description}`,\n          source: indicator.source,\n          timestamp: new Date(),\n          action: this.determineAction(indicator.severity),\n        });\n\n        return indicator;\n      }\n\n      return null;\n    } catch (error) {\n      logger.error('Error checking hash:', { hash, error });\n      return null;\n    }\n  }\n\n  /**\n   * Check threat feeds for indicators\n   */\n  private async checkThreatFeeds(type: string, value: string): Promise<ThreatIndicator[]> {\n    const indicators: ThreatIndicator[] = [];\n\n    for (const feed of this.feeds) {\n      if (!feed.enabled || feed.type !== type) {\n        continue;\n      }\n\n      try {\n        const feedIndicators = await this.checkFeed(feed, value);\n        indicators.push(...feedIndicators);\n      } catch (error) {\n        logger.error('Error checking feed:', { feed: feed.name, error });\n      }\n    }\n\n    // Sort by confidence and severity\n    return indicators.sort((a, b) => {\n      if (a.severity !== b.severity) {\n        const severityOrder = { critical: 4, high: 3, medium: 2, low: 1 };\n        return severityOrder[b.severity] - severityOrder[a.severity];\n      }\n      return b.confidence - a.confidence;\n    });\n  }\n\n  /**\n   * Check specific feed for indicator\n   */\n  private async checkFeed(feed: ThreatFeed, value: string): Promise<ThreatIndicator[]> {\n    const indicators: ThreatIndicator[] = [];\n\n    try {\n      switch (feed.format) {\n        case 'txt':\n          indicators.push(...(await this.checkTextFeed(feed, value)));\n          break;\n        case 'json':\n          indicators.push(...(await this.checkJSONFeed(feed, value)));\n          break;\n        case 'csv':\n          indicators.push(...(await this.checkCSVFeed(feed, value)));\n          break;\n      }\n    } catch (error) {\n      logger.error('Error checking feed format:', { feed: feed.name, format: feed.format, error });\n    }\n\n    return indicators;\n  }\n\n  /**\n   * Check text-based feed\n   */\n  private async checkTextFeed(feed: ThreatFeed, value: string): Promise<ThreatIndicator[]> {\n    const cacheKey = `feed:${feed.name}`;\n    const cached = await this.redis.get(cacheKey);\n\n    if (cached) {\n      const lines = cached.split('\\n');\n      const found = lines.some(line => {\n        // Remove comments and empty lines\n        const cleanLine = line.trim();\n        if (cleanLine.startsWith('#') || cleanLine === '') {\n          return false;\n        }\n        return cleanLine === value || cleanLine.includes(value);\n      });\n\n      if (found) {\n        return [\n          {\n            type: feed.type as any,\n            value,\n            source: feed.name,\n            confidence: 0.8,\n            severity: 'medium' as const,\n            description: `Found in ${feed.name}`,\n            tags: ['threat-feed'],\n            firstSeen: new Date(),\n            lastSeen: new Date(),\n            isActive: true,\n          },\n        ];\n      }\n      return [];\n    } else {\n      // Stream the feed to avoid loading entire file into memory\n      const response = await axios.get(feed.url, { responseType: 'stream', timeout: 10000 });\n      const stream = response.data as NodeJS.ReadableStream;\n      const rl = require('readline').createInterface({ input: stream, crlfDelay: Infinity });\n      let found = false;\n      for await (const line of rl) {\n        const cleanLine = line.trim();\n        if (!cleanLine || cleanLine.startsWith('#')) continue;\n        if (cleanLine === value || cleanLine.includes(value)) {\n          found = true;\n          break;\n        }\n      }\n      // Cache raw feed data for future fast access (optional, omitted for brevity)\n      if (found) {\n        return [\n          {\n            type: feed.type as any,\n            value,\n            source: feed.name,\n            confidence: 0.8,\n            severity: 'medium' as const,\n            description: `Found in ${feed.name}`,\n            tags: ['threat-feed'],\n            firstSeen: new Date(),\n            lastSeen: new Date(),\n            isActive: true,\n          },\n        ];\n      }\n      return [];\n    }\n  }\n\n  /**\n   * Check JSON-based feed\n   */\n  private async checkJSONFeed(feed: ThreatFeed, value: string): Promise<ThreatIndicator[]> {\n    const cacheKey = `feed:${feed.name}`;\n    const cached = await this.redis.get(cacheKey);\n\n    let feedData: any;\n    if (cached) {\n      feedData = JSON.parse(cached);\n    } else {\n      const response = await axios.get(feed.url, { timeout: 10000 });\n      feedData = response.data;\n      await this.redis.setEx(cacheKey, feed.updateInterval * 60, JSON.stringify(feedData));\n    }\n\n    // Handle different JSON formats\n    if (feed.name.includes('PhishTank')) {\n      return this.checkPhishTankFeed(feedData, value);\n    } else if (feed.name.includes('VirusTotal')) {\n      return await this.checkVirusTotalFeed(value);\n    }\n\n    return [];\n  }\n\n  /**\n   * Check PhishTank feed\n   */\n  private checkPhishTankFeed(feedData: any, value: string): ThreatIndicator[] {\n    if (!feedData.data) {\n      return [];\n    }\n\n    const entries = feedData.data.filter(\n      (entry: any) => entry.url === value || entry.url.includes(value),\n    );\n\n    return entries.map((entry: any) => ({\n      type: 'url' as const,\n      value,\n      source: 'PhishTank',\n      confidence: entry.phish_detail_url ? 0.9 : 0.7,\n      severity: 'high' as const,\n      description: entry.phish_detail_url || 'Phishing URL detected',\n      tags: ['phishing', 'url'],\n      firstSeen: new Date(entry.submission_time),\n      lastSeen: new Date(),\n      isActive: true,\n    }));\n  }\n\n  /**\n   * Check VirusTotal feed\n   */\n  private async checkVirusTotalFeed(hash: string): Promise<ThreatIndicator[]> {\n    const apiKey = process.env.VIRUSTOTAL_API_KEY;\n    if (!apiKey) {\n      return [];\n    }\n\n    try {\n      const response = await axios.get(`https://www.virustotal.com/vtapi/v2/file/report`, {\n        params: {\n          apikey: apiKey,\n          resource: hash,\n        },\n        timeout: 10000,\n      });\n\n      const data = response.data;\n\n      if (data.positives > 0 && data.total > 0) {\n        const ratio = data.positives / data.total;\n        // Use shared cache utilities\n        let severity: 'low' | 'medium' | 'high' | 'critical' = 'low';\n\n        if (ratio >= 0.7) severity = 'critical';\n        else if (ratio >= 0.5) severity = 'high';\n        else if (ratio >= 0.3) severity = 'medium';\n\n        return [\n          {\n            type: 'hash' as const,\n            value: hash,\n            source: 'VirusTotal',\n            confidence: ratio,\n            severity,\n            description: `Malware detected by ${data.positives}/${data.total} engines`,\n            tags: ['malware', 'hash'],\n            firstSeen: new Date(data.scan_date || Date.now()),\n            lastSeen: new Date(),\n            isActive: true,\n          },\n        ];\n      }\n    } catch (error) {\n      logger.error('VirusTotal API error:', error);\n    }\n\n    return [];\n  }\n\n  /**\n   * Check CSV-based feed\n   */\n  private async checkCSVFeed(feed: ThreatFeed, value: string): Promise<ThreatIndicator[]> {\n    // Implementation for CSV feeds\n    return [];\n  }\n\n  /**\n   * Update all threat feeds\n   */\n  private async updateAllFeeds() {\n    logger.info('Updating threat intelligence feeds...');\n\n    for (const feed of this.feeds) {\n      if (!feed.enabled) {\n        continue;\n      }\n\n      try {\n        const cacheKey = `feed:${feed.name}`;\n        await this.redis.del(cacheKey); // Force refresh\n\n        logger.debug('Feed updated', { feed: feed.name });\n      } catch (error) {\n        logger.error('Error updating feed:', { feed: feed.name, error });\n      }\n    }\n\n    logger.info('Threat intelligence feeds update completed');\n  }\n\n  /**\n   * Create threat alert\n   */\n  private async createAlert(alert: ThreatAlert) {\n    try {\n      // Add to memory\n      this.alerts.push(alert);\n\n      // Keep only recent alerts\n      if (this.alerts.length > this.maxAlerts) {\n        this.alerts.splice(0, this.alerts.length - this.maxAlerts);\n      }\n\n      // Store in Redis\n      await this.redis.setEx(\n        `alert:${alert.id}`,\n        24 * 60 * 60, // 24 hours\n        JSON.stringify(alert),\n      );\n\n      // Add to alerts list\n      await this.redis.lPush('alerts:recent', JSON.stringify(alert));\n      await this.redis.lTrim('alerts:recent', 0, 999); // Keep last 1000\n\n      logger.warn('Threat alert created', {\n        id: alert.id,\n        type: alert.type,\n        severity: alert.severity,\n        indicator: alert.indicator,\n        action: alert.action,\n      });\n    } catch (error) {\n      logger.error('Error creating threat alert:', error);\n    }\n  }\n\n  /**\n   * Determine action based on severity\n   */\n  private determineAction(severity: string): 'block' | 'warn' | 'monitor' {\n    switch (severity) {\n      case 'critical':\n      case 'high':\n        return 'block';\n      case 'medium':\n        return 'warn';\n      default:\n        return 'monitor';\n    }\n  }\n\n  /**\n   * Generate alert ID\n   */\n  private generateAlertId(): string {\n    return `alert_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n  }\n\n  /**\n   * Get recent alerts\n   */\n  public async getRecentAlerts(limit: number = 100): Promise<ThreatAlert[]> {\n    try {\n      const alertData = await this.redis.lRange('alerts:recent', 0, limit - 1);\n      return alertData.map(data => JSON.parse(data));\n    } catch (error) {\n      logger.error('Error getting recent alerts:', error);\n      return [];\n    }\n  }\n\n  /**\n   * Get threat statistics\n   */\n  public async getStats(): Promise<{\n    totalFeeds: number;\n    activeFeeds: number;\n    totalAlerts: number;\n    alertsBySeverity: { [key: string]: number };\n    alertsByType: { [key: string]: number };\n    recentAlerts: number;\n  }> {\n    try {\n      const totalFeeds = this.feeds.length;\n      const activeFeeds = this.feeds.filter(f => f.enabled).length;\n      const totalAlerts = this.alerts.length;\n\n      const alertsBySeverity: { [key: string]: number } = {};\n      const alertsByType: { [key: string]: number } = {};\n\n      this.alerts.forEach(alert => {\n        alertsBySeverity[alert.severity] = (alertsBySeverity[alert.severity] || 0) + 1;\n        alertsByType[alert.type] = (alertsByType[alert.type] || 0) + 1;\n      });\n\n      const recentAlerts = await this.redis.lLen('alerts:recent');\n\n      return {\n        totalFeeds,\n        activeFeeds,\n        totalAlerts,\n        alertsBySeverity,\n        alertsByType,\n        recentAlerts,\n      };\n    } catch (error) {\n      logger.error('Error getting threat stats:', error);\n      return {\n        totalFeeds: 0,\n        activeFeeds: 0,\n        totalAlerts: 0,\n        alertsBySeverity: {},\n        alertsByType: {},\n        recentAlerts: 0,\n      };\n    }\n  }\n\n  /**\n   * Add custom threat indicator\n   */\n  public async addCustomIndicator(\n    indicator: Omit<ThreatIndicator, 'firstSeen' | 'lastSeen' | 'isActive'>,\n  ): Promise<boolean> {\n    try {\n      const fullIndicator: ThreatIndicator = {\n        ...indicator,\n        firstSeen: new Date(),\n        lastSeen: new Date(),\n        isActive: true,\n      };\n\n      const cacheKey = `threat:custom:${indicator.type}:${indicator.value}`;\n      await this.redis.setEx(cacheKey, this.cacheTimeout, JSON.stringify(fullIndicator));\n\n      logger.info('Custom threat indicator added', {\n        type: indicator.type,\n        value: indicator.value,\n        source: indicator.source,\n      });\n\n      return true;\n    } catch (error) {\n      logger.error('Error adding custom indicator:', error);\n      return false;\n    }\n  }\n\n  /**\n   * Enable/disable threat feed\n   */\n  public async toggleFeed(feedName: string, enabled: boolean): Promise<boolean> {\n    try {\n      const feed = this.feeds.find(f => f.name === feedName);\n      if (!feed) {\n        return false;\n      }\n\n      feed.enabled = enabled;\n      logger.info(`Threat feed ${feedName} ${enabled ? 'enabled' : 'disabled'}`);\n\n      return true;\n    } catch (error) {\n      logger.error('Error toggling feed:', { feedName, error });\n      return false;\n    }\n  }\n\n  /**\n   * Get all threat feeds\n   */\n  public getFeeds(): ThreatFeed[] {\n    return this.feeds.map(feed => ({ ...feed }));\n  }\n}\n"],"version":3}