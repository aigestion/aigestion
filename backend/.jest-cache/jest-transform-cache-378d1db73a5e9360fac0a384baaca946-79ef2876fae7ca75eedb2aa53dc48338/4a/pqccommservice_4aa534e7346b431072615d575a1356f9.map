{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\pqc-comm.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\pqc-comm.service.ts"],"sourcesContent":["import { injectable } from 'inversify';\r\nimport * as kyber from 'crystals-kyber';\r\nimport * as nacl from 'tweetnacl';\r\nimport crypto from 'node:crypto';\r\nimport { logger } from '../utils/logger';\r\n\r\n@injectable()\r\nexport class PQCCommService {\r\n  /**\r\n   * Generates a hybrid keypair for the initial handshake.\r\n   */\r\n  async generateHandshakeKeys() {\r\n    try {\r\n      // 1. Classic X25519 Keypair\r\n      const classicKeys = nacl.box.keyPair();\r\n\r\n      // 2. Post-Quantum Kyber768 Keypair\r\n      // crystals-kyber KeyGen returns\r\n      const [kyberPK, kyberSK] = kyber.KeyGen768();\r\n\r\n      return {\r\n        classic: {\r\n          public: Buffer.from(classicKeys.publicKey).toString('hex'),\r\n          private: Buffer.from(classicKeys.secretKey).toString('hex'),\r\n        },\r\n        pqc: {\r\n          public: Buffer.from(kyberPK).toString('hex'),\r\n          private: Buffer.from(kyberSK).toString('hex'),\r\n        },\r\n      };\r\n    } catch (error) {\r\n      logger.error('[PQCComm] Key generation failed:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Derives a symmetric key using hybrid shared secrets.\r\n   * finalKey = HKDF(X25519_SS || Kyber_SS)\r\n   */\r\n  async deriveSymmetricKey(\r\n    myClassicSK: string,\r\n    theirClassicPK: string,\r\n    myKyberSK: string,\r\n    theirCiphertext?: string, // If they encapsulated for us\r\n    myKyberPK?: string, // If we need to encapsulate for them\r\n    theirKyberPK?: string,\r\n  ): Promise<string> {\r\n    try {\r\n      // 1. Classic Shared Secret\r\n      const classicSS = nacl.box.before(\r\n        Buffer.from(theirClassicPK, 'hex'),\r\n        Buffer.from(myClassicSK, 'hex'),\r\n      );\r\n\r\n      let kyberSS: Uint8Array;\r\n\r\n      if (theirCiphertext) {\r\n        // They encapsulated for us, we decrypt\r\n        kyberSS = kyber.Decrypt768(\r\n          Buffer.from(theirCiphertext, 'hex'),\r\n          Buffer.from(myKyberSK, 'hex'),\r\n        );\r\n      } else if (theirKyberPK) {\r\n        // We encapsulate for them (this usually happens on one side)\r\n        // In a real handshake, one side generates and the other encapsulates\r\n        const [, ss] = kyber.Encrypt768(Buffer.from(theirKyberPK, 'hex'));\r\n        kyberSS = ss;\r\n        // Note: ciphertext 'c' would need to be sent to them.\r\n        // This service would be called multiple times in a real protocol.\r\n      } else {\r\n        throw new Error('MISSING_PQC_HANDSHAKE_DATA');\r\n      }\r\n\r\n      // 2. Hybrid KDF (Simplification: HMAC of concatenated secrets)\r\n      const combined = Buffer.concat([Buffer.from(classicSS), Buffer.from(kyberSS)]);\r\n\r\n      return crypto.createHash('sha256').update(combined).digest('hex');\r\n    } catch (error) {\r\n      logger.error('[PQCComm] Key derivation failed:', error);\r\n      throw error;\r\n    }\r\n  }\r\n}\r\n"],"version":3}