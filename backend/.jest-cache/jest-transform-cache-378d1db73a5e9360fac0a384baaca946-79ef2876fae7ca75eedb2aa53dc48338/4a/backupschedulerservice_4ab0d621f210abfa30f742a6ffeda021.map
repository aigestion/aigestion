{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\backup-scheduler.service.ts","mappings":";;;;;;;;;;;;;;;;;;;AAAA,yCAA+C;AAC/C,gDAAwB;AAExB,oCAAiC;AACjC,4CAAyC;AACzC,qDAAiD;AACjD,yDAAqD;AAG9C,IAAM,sBAAsB,GAA5B,MAAM,sBAAsB;IAQM;IACE;IARjC,KAAK,GAA0B,IAAI,CAAC;IAC5C,8BAA8B;IACb,WAAW,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC;IACnD,yDAAyD;IACxC,UAAU,GAAG,cAAI,CAAC,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,IAAI,OAAO,CAAC,GAAG,CAAC,WAAW,IAAI,EAAE,EAAE,KAAK,CAAC,CAAC;IAElG,YACuC,aAA4B,EAC1B,eAAgC;QADlC,kBAAa,GAAb,aAAa,CAAe;QAC1B,oBAAe,GAAf,eAAe,CAAiB;IACtE,CAAC;IAEG,KAAK;QACV,eAAM,CAAC,IAAI,CACT,2FAA2F,CAC5F,CAAC;QAEF,sEAAsE;QACtE,UAAU,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,YAAY,EAAE,EAAE,KAAK,CAAC,CAAC;QAE7C,IAAI,CAAC,KAAK,GAAG,WAAW,CAAC,GAAG,EAAE;YAC5B,IAAI,CAAC,YAAY,EAAE,CAAC;QACtB,CAAC,EAAE,IAAI,CAAC,WAAW,CAAC,CAAC;IACvB,CAAC;IAEM,IAAI;QACT,IAAI,IAAI,CAAC,KAAK,EAAE,CAAC;YACf,aAAa,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;YAC1B,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC;QACpB,CAAC;IACH,CAAC;IAEO,KAAK,CAAC,YAAY;QACxB,eAAM,CAAC,IAAI,CAAC,iCAAiC,IAAI,CAAC,UAAU,EAAE,CAAC,CAAC;QAChE,IAAI,CAAC;YACH,MAAM,IAAI,CAAC,aAAa,CAAC,eAAe,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;YAC1D,MAAM,GAAG,GAAG,wBAAwB,IAAI,CAAC,UAAU,EAAE,CAAC;YACtD,eAAM,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;YACjB,8EAA8E;YAC9E,+CAA+C;QACjD,CAAC;QAAC,OAAO,KAAU,EAAE,CAAC;YACpB,MAAM,GAAG,GAAG,qBAAqB,KAAK,CAAC,OAAO,EAAE,CAAC;YACjD,eAAM,CAAC,KAAK,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC;YACzB,IAAI,CAAC;gBACH,MAAM,IAAI,CAAC,eAAe,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC;YAC9C,CAAC;YAAC,OAAO,OAAO,EAAE,CAAC;gBACjB,eAAM,CAAC,KAAK,CAAC,iDAAiD,EAAE,OAAO,CAAC,CAAC;YAC3E,CAAC;QACH,CAAC;IACH,CAAC;CACF,CAAA;AAlDY,wDAAsB;iCAAtB,sBAAsB;IADlC,IAAA,sBAAU,GAAE;IASR,WAAA,IAAA,kBAAM,EAAC,aAAK,CAAC,aAAa,CAAC,CAAA;IAC3B,WAAA,IAAA,kBAAM,EAAC,aAAK,CAAC,eAAe,CAAC,CAAA;yDADsB,8BAAa,oBAAb,8BAAa,oDACT,kCAAe,oBAAf,kCAAe;GAT9D,sBAAsB,CAkDlC","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\backup-scheduler.service.ts"],"sourcesContent":["import { inject, injectable } from 'inversify';\nimport path from 'path';\n\nimport { TYPES } from '../types';\nimport { logger } from '../utils/logger';\nimport { BackupService } from './backup.service';\nimport { TelegramService } from './telegram.service';\n\n@injectable()\nexport class BackupSchedulerService {\n  private timer: NodeJS.Timeout | null = null;\n  // Default: run every 24 hours\n  private readonly INTERVAL_MS = 24 * 60 * 60 * 1000;\n  // Default source: User's 'ale' folder (adjust as needed)\n  private readonly SOURCE_DIR = path.join(process.env.HOME || process.env.USERPROFILE || '', 'ale');\n\n  constructor(\n    @inject(TYPES.BackupService) private backupService: BackupService,\n    @inject(TYPES.TelegramService) private telegramService: TelegramService,\n  ) {}\n\n  public start() {\n    logger.info(\n      'BackupSchedulerService started. First backup will run immediately (async) and then daily.',\n    );\n\n    // Run initial backup after a short delay to let server startup finish\n    setTimeout(() => this.runBackupJob(), 10000);\n\n    this.timer = setInterval(() => {\n      this.runBackupJob();\n    }, this.INTERVAL_MS);\n  }\n\n  public stop() {\n    if (this.timer) {\n      clearInterval(this.timer);\n      this.timer = null;\n    }\n  }\n\n  private async runBackupJob() {\n    logger.info(`Starting scheduled backup for ${this.SOURCE_DIR}`);\n    try {\n      await this.backupService.backupDirectory(this.SOURCE_DIR);\n      const msg = `âœ… Backup Successful: ${this.SOURCE_DIR}`;\n      logger.info(msg);\n      // Optional: don't spam success message to telegram every day unless requested\n      // await this.telegramService.sendMessage(msg);\n    } catch (error: any) {\n      const msg = `ðŸš¨ Backup FAILED: ${error.message}`;\n      logger.error(msg, error);\n      try {\n        await this.telegramService.sendMessage(msg);\n      } catch (tgError) {\n        logger.error('Failed to send backup failure alert to Telegram', tgError);\n      }\n    }\n  }\n}\n"],"version":3}