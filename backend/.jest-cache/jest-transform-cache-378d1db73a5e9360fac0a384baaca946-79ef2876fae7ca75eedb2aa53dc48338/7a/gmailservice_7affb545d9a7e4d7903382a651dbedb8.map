{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\gmail.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\gmail.service.ts"],"sourcesContent":["import { google } from 'googleapis';\nimport { injectable } from 'inversify';\n\n/**\n * Gmail Service\n * IntegraciÃ³n completa con Gmail API para AIGestion\n */\n@injectable()\nexport class GmailService {\n  private gmail: any;\n  private auth: any;\n\n  async initialize() {\n    this.auth = new google.auth.GoogleAuth({\n      keyFile: process.env.GOOGLE_APPLICATION_CREDENTIALS,\n      scopes: [\n        'https://www.googleapis.com/auth/gmail.readonly',\n        'https://www.googleapis.com/auth/gmail.modify',\n        'https://www.googleapis.com/auth/gmail.send',\n      ],\n    });\n    this.gmail = google.gmail({ version: 'v1', auth: this.auth });\n  }\n\n  async getUnreadEmails(maxResults = 10) {\n    try {\n      const response = await this.gmail.users.messages.list({\n        userId: 'me',\n        q: 'is:unread',\n        maxResults,\n      });\n      return response.data.messages || [];\n    } catch (error) {\n      console.error('Error fetching unread emails:', error);\n      throw error;\n    }\n  }\n\n  async getEmail(messageId: string) {\n    try {\n      const response = await this.gmail.users.messages.get({\n        userId: 'me',\n        id: messageId,\n        format: 'full',\n      });\n      return response.data;\n    } catch (error) {\n      console.error('Error fetching email:', error);\n      throw error;\n    }\n  }\n\n  async parseEmail(message: any) {\n    try {\n      const headers = message.payload.headers;\n      const from = headers.find((h: any) => h.name === 'From').value;\n      const subject = headers.find((h: any) => h.name === 'Subject').value;\n      const body = this.decodeBody(message.payload);\n\n      return {\n        id: message.id,\n        from,\n        subject,\n        body,\n        timestamp: new Date(parseInt(message.internalDate)),\n      };\n    } catch (error) {\n      console.error('Error parsing email:', error);\n      throw error;\n    }\n  }\n\n  async sendEmail(to: string, subject: string, body: string) {\n    try {\n      const message = this.createMessage(to, subject, body);\n      const response = await this.gmail.users.messages.send({\n        userId: 'me',\n        requestBody: { raw: message },\n      });\n      return response.data;\n    } catch (error) {\n      console.error('Error sending email:', error);\n      throw error;\n    }\n  }\n\n  async labelEmail(messageId: string, labelId: string) {\n    try {\n      return await this.gmail.users.messages.modify({\n        userId: 'me',\n        id: messageId,\n        requestBody: {\n          addLabelIds: [labelId],\n        },\n      });\n    } catch (error) {\n      console.error('Error labeling email:', error);\n      throw error;\n    }\n  }\n\n  async archiveEmail(messageId: string) {\n    try {\n      return await this.gmail.users.messages.modify({\n        userId: 'me',\n        id: messageId,\n        requestBody: {\n          removeLabelIds: ['INBOX'],\n        },\n      });\n    } catch (error) {\n      console.error('Error archiving email:', error);\n      throw error;\n    }\n  }\n\n  private decodeBody(payload: any): string {\n    try {\n      if (payload.parts) {\n        return payload.parts.map((part: any) => this.decodeBody(part)).join('\\n');\n      } else if (payload.body?.data) {\n        const data = payload.body.data.replace(/-/g, '+').replace(/_/g, '/');\n        return Buffer.from(data, 'base64').toString('utf-8');\n      }\n      return '';\n    } catch (error) {\n      console.error('Error decoding body:', error);\n      return '';\n    }\n  }\n\n  private createMessage(to: string, subject: string, body: string): string {\n    const email = [\n      `To: ${to}`,\n      `Subject: ${subject}`,\n      'Content-Type: text/plain; charset=\"UTF-8\"',\n      'MIME-Version: 1.0',\n      '',\n      body,\n    ].join('\\n');\n\n    return Buffer.from(email)\n      .toString('base64')\n      .replace(/\\+/g, '-')\n      .replace(/\\//g, '_')\n      .replace(/=/g, '');\n  }\n}\n"],"version":3}