05aa0b5529c4663dec5710ecd83082e0
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.GmailService = void 0;
const googleapis_1 = require("googleapis");
const inversify_1 = require("inversify");
/**
 * Gmail Service
 * IntegraciÃ³n completa con Gmail API para AIGestion
 */
let GmailService = class GmailService {
    gmail;
    auth;
    async initialize() {
        this.auth = new googleapis_1.google.auth.GoogleAuth({
            keyFile: process.env.GOOGLE_APPLICATION_CREDENTIALS,
            scopes: [
                'https://www.googleapis.com/auth/gmail.readonly',
                'https://www.googleapis.com/auth/gmail.modify',
                'https://www.googleapis.com/auth/gmail.send',
            ],
        });
        this.gmail = googleapis_1.google.gmail({ version: 'v1', auth: this.auth });
    }
    async getUnreadEmails(maxResults = 10) {
        try {
            const response = await this.gmail.users.messages.list({
                userId: 'me',
                q: 'is:unread',
                maxResults,
            });
            return response.data.messages || [];
        }
        catch (error) {
            console.error('Error fetching unread emails:', error);
            throw error;
        }
    }
    async getEmail(messageId) {
        try {
            const response = await this.gmail.users.messages.get({
                userId: 'me',
                id: messageId,
                format: 'full',
            });
            return response.data;
        }
        catch (error) {
            console.error('Error fetching email:', error);
            throw error;
        }
    }
    async parseEmail(message) {
        try {
            const headers = message.payload.headers;
            const from = headers.find((h) => h.name === 'From').value;
            const subject = headers.find((h) => h.name === 'Subject').value;
            const body = this.decodeBody(message.payload);
            return {
                id: message.id,
                from,
                subject,
                body,
                timestamp: new Date(parseInt(message.internalDate)),
            };
        }
        catch (error) {
            console.error('Error parsing email:', error);
            throw error;
        }
    }
    async sendEmail(to, subject, body) {
        try {
            const message = this.createMessage(to, subject, body);
            const response = await this.gmail.users.messages.send({
                userId: 'me',
                requestBody: { raw: message },
            });
            return response.data;
        }
        catch (error) {
            console.error('Error sending email:', error);
            throw error;
        }
    }
    async labelEmail(messageId, labelId) {
        try {
            return await this.gmail.users.messages.modify({
                userId: 'me',
                id: messageId,
                requestBody: {
                    addLabelIds: [labelId],
                },
            });
        }
        catch (error) {
            console.error('Error labeling email:', error);
            throw error;
        }
    }
    async archiveEmail(messageId) {
        try {
            return await this.gmail.users.messages.modify({
                userId: 'me',
                id: messageId,
                requestBody: {
                    removeLabelIds: ['INBOX'],
                },
            });
        }
        catch (error) {
            console.error('Error archiving email:', error);
            throw error;
        }
    }
    decodeBody(payload) {
        try {
            if (payload.parts) {
                return payload.parts.map((part) => this.decodeBody(part)).join('\n');
            }
            else if (payload.body?.data) {
                const data = payload.body.data.replace(/-/g, '+').replace(/_/g, '/');
                return Buffer.from(data, 'base64').toString('utf-8');
            }
            return '';
        }
        catch (error) {
            console.error('Error decoding body:', error);
            return '';
        }
    }
    createMessage(to, subject, body) {
        const email = [
            `To: ${to}`,
            `Subject: ${subject}`,
            'Content-Type: text/plain; charset="UTF-8"',
            'MIME-Version: 1.0',
            '',
            body,
        ].join('\n');
        return Buffer.from(email)
            .toString('base64')
            .replace(/\+/g, '-')
            .replace(/\//g, '_')
            .replace(/=/g, '');
    }
};
exports.GmailService = GmailService;
exports.GmailService = GmailService = __decorate([
    (0, inversify_1.injectable)()
], GmailService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxzZXJ2aWNlc1xcZ21haWwuc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQSwyQ0FBb0M7QUFDcEMseUNBQXVDO0FBRXZDOzs7R0FHRztBQUVJLElBQU0sWUFBWSxHQUFsQixNQUFNLFlBQVk7SUFDZixLQUFLLENBQU07SUFDWCxJQUFJLENBQU07SUFFbEIsS0FBSyxDQUFDLFVBQVU7UUFDZCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksbUJBQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDO1lBQ3JDLE9BQU8sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLDhCQUE4QjtZQUNuRCxNQUFNLEVBQUU7Z0JBQ04sZ0RBQWdEO2dCQUNoRCw4Q0FBOEM7Z0JBQzlDLDRDQUE0QzthQUM3QztTQUNGLENBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxLQUFLLEdBQUcsbUJBQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztJQUNoRSxDQUFDO0lBRUQsS0FBSyxDQUFDLGVBQWUsQ0FBQyxVQUFVLEdBQUcsRUFBRTtRQUNuQyxJQUFJLENBQUM7WUFDSCxNQUFNLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUM7Z0JBQ3BELE1BQU0sRUFBRSxJQUFJO2dCQUNaLENBQUMsRUFBRSxXQUFXO2dCQUNkLFVBQVU7YUFDWCxDQUFDLENBQUM7WUFDSCxPQUFPLFFBQVEsQ0FBQyxJQUFJLENBQUMsUUFBUSxJQUFJLEVBQUUsQ0FBQztRQUN0QyxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMsK0JBQStCLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDdEQsTUFBTSxLQUFLLENBQUM7UUFDZCxDQUFDO0lBQ0gsQ0FBQztJQUVELEtBQUssQ0FBQyxRQUFRLENBQUMsU0FBaUI7UUFDOUIsSUFBSSxDQUFDO1lBQ0gsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDO2dCQUNuRCxNQUFNLEVBQUUsSUFBSTtnQkFDWixFQUFFLEVBQUUsU0FBUztnQkFDYixNQUFNLEVBQUUsTUFBTTthQUNmLENBQUMsQ0FBQztZQUNILE9BQU8sUUFBUSxDQUFDLElBQUksQ0FBQztRQUN2QixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMsdUJBQXVCLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDOUMsTUFBTSxLQUFLLENBQUM7UUFDZCxDQUFDO0lBQ0gsQ0FBQztJQUVELEtBQUssQ0FBQyxVQUFVLENBQUMsT0FBWTtRQUMzQixJQUFJLENBQUM7WUFDSCxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQztZQUN4QyxNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLE1BQU0sQ0FBQyxDQUFDLEtBQUssQ0FBQztZQUMvRCxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLFNBQVMsQ0FBQyxDQUFDLEtBQUssQ0FBQztZQUNyRSxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUU5QyxPQUFPO2dCQUNMLEVBQUUsRUFBRSxPQUFPLENBQUMsRUFBRTtnQkFDZCxJQUFJO2dCQUNKLE9BQU87Z0JBQ1AsSUFBSTtnQkFDSixTQUFTLEVBQUUsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQzthQUNwRCxDQUFDO1FBQ0osQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLHNCQUFzQixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQzdDLE1BQU0sS0FBSyxDQUFDO1FBQ2QsQ0FBQztJQUNILENBQUM7SUFFRCxLQUFLLENBQUMsU0FBUyxDQUFDLEVBQVUsRUFBRSxPQUFlLEVBQUUsSUFBWTtRQUN2RCxJQUFJLENBQUM7WUFDSCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLEVBQUUsRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDdEQsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDO2dCQUNwRCxNQUFNLEVBQUUsSUFBSTtnQkFDWixXQUFXLEVBQUUsRUFBRSxHQUFHLEVBQUUsT0FBTyxFQUFFO2FBQzlCLENBQUMsQ0FBQztZQUNILE9BQU8sUUFBUSxDQUFDLElBQUksQ0FBQztRQUN2QixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMsc0JBQXNCLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDN0MsTUFBTSxLQUFLLENBQUM7UUFDZCxDQUFDO0lBQ0gsQ0FBQztJQUVELEtBQUssQ0FBQyxVQUFVLENBQUMsU0FBaUIsRUFBRSxPQUFlO1FBQ2pELElBQUksQ0FBQztZQUNILE9BQU8sTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDO2dCQUM1QyxNQUFNLEVBQUUsSUFBSTtnQkFDWixFQUFFLEVBQUUsU0FBUztnQkFDYixXQUFXLEVBQUU7b0JBQ1gsV0FBVyxFQUFFLENBQUMsT0FBTyxDQUFDO2lCQUN2QjthQUNGLENBQUMsQ0FBQztRQUNMLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyx1QkFBdUIsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUM5QyxNQUFNLEtBQUssQ0FBQztRQUNkLENBQUM7SUFDSCxDQUFDO0lBRUQsS0FBSyxDQUFDLFlBQVksQ0FBQyxTQUFpQjtRQUNsQyxJQUFJLENBQUM7WUFDSCxPQUFPLE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQztnQkFDNUMsTUFBTSxFQUFFLElBQUk7Z0JBQ1osRUFBRSxFQUFFLFNBQVM7Z0JBQ2IsV0FBVyxFQUFFO29CQUNYLGNBQWMsRUFBRSxDQUFDLE9BQU8sQ0FBQztpQkFDMUI7YUFDRixDQUFDLENBQUM7UUFDTCxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMsd0JBQXdCLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDL0MsTUFBTSxLQUFLLENBQUM7UUFDZCxDQUFDO0lBQ0gsQ0FBQztJQUVPLFVBQVUsQ0FBQyxPQUFZO1FBQzdCLElBQUksQ0FBQztZQUNILElBQUksT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO2dCQUNsQixPQUFPLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBUyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzVFLENBQUM7aUJBQU0sSUFBSSxPQUFPLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDO2dCQUM5QixNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBQ3JFLE9BQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3ZELENBQUM7WUFDRCxPQUFPLEVBQUUsQ0FBQztRQUNaLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyxzQkFBc0IsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUM3QyxPQUFPLEVBQUUsQ0FBQztRQUNaLENBQUM7SUFDSCxDQUFDO0lBRU8sYUFBYSxDQUFDLEVBQVUsRUFBRSxPQUFlLEVBQUUsSUFBWTtRQUM3RCxNQUFNLEtBQUssR0FBRztZQUNaLE9BQU8sRUFBRSxFQUFFO1lBQ1gsWUFBWSxPQUFPLEVBQUU7WUFDckIsMkNBQTJDO1lBQzNDLG1CQUFtQjtZQUNuQixFQUFFO1lBQ0YsSUFBSTtTQUNMLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRWIsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQzthQUN0QixRQUFRLENBQUMsUUFBUSxDQUFDO2FBQ2xCLE9BQU8sQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDO2FBQ25CLE9BQU8sQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDO2FBQ25CLE9BQU8sQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDdkIsQ0FBQztDQUNGLENBQUE7QUEzSVksb0NBQVk7dUJBQVosWUFBWTtJQUR4QixJQUFBLHNCQUFVLEdBQUU7R0FDQSxZQUFZLENBMkl4QiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXEFsZWphbmRyb1xcQUlHZXN0aW9uXFxiYWNrZW5kXFxzcmNcXHNlcnZpY2VzXFxnbWFpbC5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGdvb2dsZSB9IGZyb20gJ2dvb2dsZWFwaXMnO1xuaW1wb3J0IHsgaW5qZWN0YWJsZSB9IGZyb20gJ2ludmVyc2lmeSc7XG5cbi8qKlxuICogR21haWwgU2VydmljZVxuICogSW50ZWdyYWNpw7NuIGNvbXBsZXRhIGNvbiBHbWFpbCBBUEkgcGFyYSBBSUdlc3Rpb25cbiAqL1xuQGluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEdtYWlsU2VydmljZSB7XG4gIHByaXZhdGUgZ21haWw6IGFueTtcbiAgcHJpdmF0ZSBhdXRoOiBhbnk7XG5cbiAgYXN5bmMgaW5pdGlhbGl6ZSgpIHtcbiAgICB0aGlzLmF1dGggPSBuZXcgZ29vZ2xlLmF1dGguR29vZ2xlQXV0aCh7XG4gICAgICBrZXlGaWxlOiBwcm9jZXNzLmVudi5HT09HTEVfQVBQTElDQVRJT05fQ1JFREVOVElBTFMsXG4gICAgICBzY29wZXM6IFtcbiAgICAgICAgJ2h0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL2F1dGgvZ21haWwucmVhZG9ubHknLFxuICAgICAgICAnaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vYXV0aC9nbWFpbC5tb2RpZnknLFxuICAgICAgICAnaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vYXV0aC9nbWFpbC5zZW5kJyxcbiAgICAgIF0sXG4gICAgfSk7XG4gICAgdGhpcy5nbWFpbCA9IGdvb2dsZS5nbWFpbCh7IHZlcnNpb246ICd2MScsIGF1dGg6IHRoaXMuYXV0aCB9KTtcbiAgfVxuXG4gIGFzeW5jIGdldFVucmVhZEVtYWlscyhtYXhSZXN1bHRzID0gMTApIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLmdtYWlsLnVzZXJzLm1lc3NhZ2VzLmxpc3Qoe1xuICAgICAgICB1c2VySWQ6ICdtZScsXG4gICAgICAgIHE6ICdpczp1bnJlYWQnLFxuICAgICAgICBtYXhSZXN1bHRzLFxuICAgICAgfSk7XG4gICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YS5tZXNzYWdlcyB8fCBbXTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgZmV0Y2hpbmcgdW5yZWFkIGVtYWlsczonLCBlcnJvcik7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICBhc3luYyBnZXRFbWFpbChtZXNzYWdlSWQ6IHN0cmluZykge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuZ21haWwudXNlcnMubWVzc2FnZXMuZ2V0KHtcbiAgICAgICAgdXNlcklkOiAnbWUnLFxuICAgICAgICBpZDogbWVzc2FnZUlkLFxuICAgICAgICBmb3JtYXQ6ICdmdWxsJyxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGZldGNoaW5nIGVtYWlsOicsIGVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHBhcnNlRW1haWwobWVzc2FnZTogYW55KSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGhlYWRlcnMgPSBtZXNzYWdlLnBheWxvYWQuaGVhZGVycztcbiAgICAgIGNvbnN0IGZyb20gPSBoZWFkZXJzLmZpbmQoKGg6IGFueSkgPT4gaC5uYW1lID09PSAnRnJvbScpLnZhbHVlO1xuICAgICAgY29uc3Qgc3ViamVjdCA9IGhlYWRlcnMuZmluZCgoaDogYW55KSA9PiBoLm5hbWUgPT09ICdTdWJqZWN0JykudmFsdWU7XG4gICAgICBjb25zdCBib2R5ID0gdGhpcy5kZWNvZGVCb2R5KG1lc3NhZ2UucGF5bG9hZCk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIGlkOiBtZXNzYWdlLmlkLFxuICAgICAgICBmcm9tLFxuICAgICAgICBzdWJqZWN0LFxuICAgICAgICBib2R5LFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKHBhcnNlSW50KG1lc3NhZ2UuaW50ZXJuYWxEYXRlKSksXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBwYXJzaW5nIGVtYWlsOicsIGVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHNlbmRFbWFpbCh0bzogc3RyaW5nLCBzdWJqZWN0OiBzdHJpbmcsIGJvZHk6IHN0cmluZykge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBtZXNzYWdlID0gdGhpcy5jcmVhdGVNZXNzYWdlKHRvLCBzdWJqZWN0LCBib2R5KTtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5nbWFpbC51c2Vycy5tZXNzYWdlcy5zZW5kKHtcbiAgICAgICAgdXNlcklkOiAnbWUnLFxuICAgICAgICByZXF1ZXN0Qm9keTogeyByYXc6IG1lc3NhZ2UgfSxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHNlbmRpbmcgZW1haWw6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgbGFiZWxFbWFpbChtZXNzYWdlSWQ6IHN0cmluZywgbGFiZWxJZDogc3RyaW5nKSB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmdtYWlsLnVzZXJzLm1lc3NhZ2VzLm1vZGlmeSh7XG4gICAgICAgIHVzZXJJZDogJ21lJyxcbiAgICAgICAgaWQ6IG1lc3NhZ2VJZCxcbiAgICAgICAgcmVxdWVzdEJvZHk6IHtcbiAgICAgICAgICBhZGRMYWJlbElkczogW2xhYmVsSWRdLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGxhYmVsaW5nIGVtYWlsOicsIGVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGFyY2hpdmVFbWFpbChtZXNzYWdlSWQ6IHN0cmluZykge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5nbWFpbC51c2Vycy5tZXNzYWdlcy5tb2RpZnkoe1xuICAgICAgICB1c2VySWQ6ICdtZScsXG4gICAgICAgIGlkOiBtZXNzYWdlSWQsXG4gICAgICAgIHJlcXVlc3RCb2R5OiB7XG4gICAgICAgICAgcmVtb3ZlTGFiZWxJZHM6IFsnSU5CT1gnXSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBhcmNoaXZpbmcgZW1haWw6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBkZWNvZGVCb2R5KHBheWxvYWQ6IGFueSk6IHN0cmluZyB7XG4gICAgdHJ5IHtcbiAgICAgIGlmIChwYXlsb2FkLnBhcnRzKSB7XG4gICAgICAgIHJldHVybiBwYXlsb2FkLnBhcnRzLm1hcCgocGFydDogYW55KSA9PiB0aGlzLmRlY29kZUJvZHkocGFydCkpLmpvaW4oJ1xcbicpO1xuICAgICAgfSBlbHNlIGlmIChwYXlsb2FkLmJvZHk/LmRhdGEpIHtcbiAgICAgICAgY29uc3QgZGF0YSA9IHBheWxvYWQuYm9keS5kYXRhLnJlcGxhY2UoLy0vZywgJysnKS5yZXBsYWNlKC9fL2csICcvJyk7XG4gICAgICAgIHJldHVybiBCdWZmZXIuZnJvbShkYXRhLCAnYmFzZTY0JykudG9TdHJpbmcoJ3V0Zi04Jyk7XG4gICAgICB9XG4gICAgICByZXR1cm4gJyc7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGRlY29kaW5nIGJvZHk6JywgZXJyb3IpO1xuICAgICAgcmV0dXJuICcnO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlTWVzc2FnZSh0bzogc3RyaW5nLCBzdWJqZWN0OiBzdHJpbmcsIGJvZHk6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgY29uc3QgZW1haWwgPSBbXG4gICAgICBgVG86ICR7dG99YCxcbiAgICAgIGBTdWJqZWN0OiAke3N1YmplY3R9YCxcbiAgICAgICdDb250ZW50LVR5cGU6IHRleHQvcGxhaW47IGNoYXJzZXQ9XCJVVEYtOFwiJyxcbiAgICAgICdNSU1FLVZlcnNpb246IDEuMCcsXG4gICAgICAnJyxcbiAgICAgIGJvZHksXG4gICAgXS5qb2luKCdcXG4nKTtcblxuICAgIHJldHVybiBCdWZmZXIuZnJvbShlbWFpbClcbiAgICAgIC50b1N0cmluZygnYmFzZTY0JylcbiAgICAgIC5yZXBsYWNlKC9cXCsvZywgJy0nKVxuICAgICAgLnJlcGxhY2UoL1xcLy9nLCAnXycpXG4gICAgICAucmVwbGFjZSgvPS9nLCAnJyk7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==