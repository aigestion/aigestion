{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\telegram-bot.handler.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\telegram-bot.handler.ts"],"sourcesContent":["import { inject, injectable } from 'inversify';\nimport { Context, Telegraf } from 'telegraf';\n\nimport { env } from '../config/env.schema';\nimport { logger } from '../utils/logger';\nimport { DanielaAIService } from './daniela-ai.service';\n\n/**\n * Telegram Bot Handler - Public Bot\n */\n@injectable()\nexport class TelegramBotHandler {\n  private bot: Telegraf | null = null;\n  private isLaunched = false;\n  private daniela: DanielaAIService;\n\n  constructor(@inject(DanielaAIService) daniela: DanielaAIService) {\n    this.daniela = daniela;\n    this.initialize();\n  }\n\n  /**\n   * Initialize the Telegram Bot with command handlers\n   */\n  private initialize() {\n    const botToken = env.TELEGRAM_BOT_TOKEN_PUBLIC || env.TELEGRAM_BOT_TOKEN;\n    if (!botToken) {\n      logger.warn(\n        'TELEGRAM_BOT_TOKEN_PUBLIC/TELEGRAM_BOT_TOKEN not provided. Telegram Bot disabled.',\n      );\n      return;\n    }\n\n    try {\n      this.bot = new Telegraf(botToken);\n\n      // Setup command handlers\n      this.setupCommands();\n\n      // Setup error handling\n      this.setupErrorHandling();\n\n      logger.info('Telegram Public Bot initialized');\n    } catch (error) {\n      logger.error('Failed to initialize Telegram Public Bot', error);\n    }\n  }\n\n  /**\n   * Setup all bot commands\n   */\n  private setupCommands() {\n    const bot = this.bot;\n    if (!bot) return;\n\n    // /start command\n    bot.start(async (ctx: Context) => {\n      try {\n        const chatId = ctx.chat?.id;\n        const firstName = ctx.from?.first_name || 'User';\n\n        logger.info(`Public bot started by ${firstName} (${chatId})`);\n\n        await ctx.reply(\n          `ü§ñ ¬°Bienvenido a AIGesti√≥n Bot!\\n\\n` +\n            `Hola ${firstName}, soy tu asistente de IA para gesti√≥n de proyectos.\\n\\n` +\n            `Comandos disponibles:\\n` +\n            `/help - Muestra esta ayuda\\n` +\n            `/status - Estado del sistema\\n` +\n            `/analytics - Analytics del proyecto\\n` +\n            `/settings - Configurar preferencias\\n` +\n            `/daniela - Asistente IA\\n\\n` +\n            `¬øC√≥mo puedo ayudarte?`,\n        );\n      } catch (error) {\n        logger.error('Error in /start command', error);\n        ctx.reply('‚ùå Hubo un error. Por favor, intenta de nuevo.');\n      }\n    });\n\n    // /help command\n    bot.help(async (ctx: Context) => {\n      try {\n        await ctx.reply(\n          `üìö *Gu√≠a de Comandos AIGesti√≥n Bot*\\n\\n` +\n            `/start - Inicia el bot\\n` +\n            `/help - Muestra esta ayuda\\n` +\n            `/status - Estado actual del sistema\\n` +\n            `/analytics - Ver analytics del proyecto\\n` +\n            `/settings - Configurar preferencias\\n` +\n            `/daniela - Asistente IA\\n\\n` +\n            `_Para m√°s informaci√≥n, visita nuestro sitio web._`,\n          { parse_mode: 'Markdown' },\n        );\n      } catch (error) {\n        logger.error('Error in /help command', error);\n      }\n    });\n\n    // /daniela command (public)\n    bot.command('daniela', async (ctx: Context) => {\n      const daniela = this.daniela;\n      if (!daniela) {\n        await ctx.reply('‚ùå Daniela no est√° disponible en este momento.');\n        return;\n      }\n\n      if (!ctx.message || !('text' in ctx.message)) {\n        await ctx.reply('‚ùå Necesito un mensaje de texto para ayudarte.');\n        return;\n      }\n\n      const message = ctx.message.text.replace('/daniela', '').trim();\n\n      if (!message) {\n        await ctx.reply(daniela.getDanielaInfo(), { parse_mode: 'Markdown' });\n        return;\n      }\n\n      await ctx.reply('‚è≥ Daniela est√° pensando...');\n\n      const response = await daniela.processMessage(\n        ctx.chat!.id,\n        message,\n        ctx.from?.first_name || 'User',\n        ctx.from?.id.toString() || 'unknown',\n        'public',\n      );\n\n      await ctx.reply(response, { parse_mode: 'Markdown' });\n    });\n\n    // /status command\n    bot.command('status', async (ctx: Context) => {\n      try {\n        await ctx.reply(\n          `‚úÖ *Estado del Sistema*\\n\\n` +\n            `üü¢ Backend: Operacional\\n` +\n            `üü¢ Telegram Bot: Conectado\\n` +\n            `üü¢ Notificaciones: Activas\\n\\n` +\n            `√öltima actualizaci√≥n: ${new Date().toLocaleString()}`,\n          { parse_mode: 'Markdown' },\n        );\n      } catch (error) {\n        logger.error('Error in /status command', error);\n      }\n    });\n\n    // /analytics command\n    bot.command('analytics', async (ctx: Context) => {\n      try {\n        await ctx.reply(\n          `üìä *Analytics del Proyecto*\\n\\n` +\n            `üìà Proyectos activos: 5\\n` +\n            `üë• Miembros del equipo: 12\\n` +\n            `‚úÖ Tareas completadas: 87%\\n` +\n            `‚è±Ô∏è Tiempo promedio: 4.2h\\n\\n` +\n            `√öltimos 7 d√≠as: +15% de productividad`,\n          { parse_mode: 'Markdown' },\n        );\n      } catch (error) {\n        logger.error('Error in /analytics command', error);\n      }\n    });\n\n    // /settings command\n    bot.command('settings', async (ctx: Context) => {\n      try {\n        await ctx.reply(\n          `‚öôÔ∏è *Configuraci√≥n*\\n\\n` + `Usa los botones de abajo para configurar tus preferencias:\\n`,\n          {\n            reply_markup: {\n              inline_keyboard: [\n                [\n                  { text: 'üîî Notificaciones', callback_data: 'settings_notifications' },\n                  { text: 'üåç Idioma', callback_data: 'settings_language' },\n                ],\n                [\n                  { text: 'üïê Zona Horaria', callback_data: 'settings_timezone' },\n                  { text: 'üìß Email', callback_data: 'settings_email' },\n                ],\n                [{ text: '‚ùå Cerrar', callback_data: 'settings_close' }],\n              ],\n            },\n          },\n        );\n      } catch (error) {\n        logger.error('Error in /settings command', error);\n      }\n    });\n  }\n\n  /**\n   * Setup error handling\n   */\n  private setupErrorHandling() {\n    if (!this.bot) return;\n\n    this.bot.catch((err: any, ctx: Context) => {\n      logger.error(`Error in public bot context:`, err);\n      try {\n        ctx.reply('‚ùå Ocurri√≥ un error. Por favor, intenta de nuevo.');\n      } catch (error) {\n        logger.error('Failed to send error message', error);\n      }\n    });\n  }\n\n  /**\n   * Launch the bot\n   */\n  public async launch(): Promise<void> {\n    if (!this.bot) {\n      logger.warn('Public bot not initialized. Cannot launch.');\n      return;\n    }\n\n    if (this.isLaunched) {\n      logger.warn('Public bot already launched.');\n      return;\n    }\n\n    try {\n      await this.bot.launch();\n      this.isLaunched = true;\n      logger.info('Telegram Public Bot launched successfully');\n\n      // Enable graceful stop\n      process.once('SIGINT', () => {\n        logger.info('SIGINT received, stopping public bot...');\n        this.bot?.stop('SIGINT');\n      });\n\n      process.once('SIGTERM', () => {\n        logger.info('SIGTERM received, stopping public bot...');\n        this.bot?.stop('SIGTERM');\n      });\n    } catch (error) {\n      logger.error('Failed to launch Telegram Public Bot', error);\n    }\n  }\n\n  /**\n   * Stop the bot\n   */\n  public async stop(): Promise<void> {\n    if (!this.bot || !this.isLaunched) {\n      return;\n    }\n\n    try {\n      await this.bot.stop();\n      this.isLaunched = false;\n      logger.info('Telegram Public Bot stopped');\n    } catch (error) {\n      logger.error('Error stopping Telegram Public Bot', error);\n    }\n  }\n\n  /**\n   * Check if bot is running\n   */\n  public isRunning(): boolean {\n    return this.isLaunched;\n  }\n\n  /**\n   * Get bot instance (for direct access if needed)\n   */\n  public getBot(): Telegraf | null {\n    return this.bot;\n  }\n}\n"],"version":3}