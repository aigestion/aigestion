2123d5ab14c45b5c7e54696717d81c09
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = require("express");
const security_middleware_1 = require("../middleware/security.middleware");
const waf_middleware_1 = require("../middleware/waf.middleware");
const logger_1 = require("../utils/logger");
const router = (0, express_1.Router)();
/**
 * WAF Management Routes
 * These endpoints allow monitoring and managing the Web Application Firewall
 */
// Get WAF statistics
router.get('/stats', security_middleware_1.requireApiKey, (req, res) => {
    try {
        const stats = waf_middleware_1.wafManagement.getStats();
        res.json({
            success: true,
            data: {
                ...stats,
                uptime: process.uptime(),
                timestamp: new Date().toISOString(),
            },
        });
    }
    catch (error) {
        logger_1.logger.error('Error getting WAF stats:', error);
        res.status(500).json({
            success: false,
            error: 'Internal server error',
        });
    }
});
// Get all WAF rules
router.get('/rules', security_middleware_1.requireApiKey, (req, res) => {
    try {
        const rules = waf_middleware_1.wafManagement.getRules();
        res.json({
            success: true,
            data: rules.map(rule => ({
                name: rule.name,
                enabled: rule.enabled,
                action: rule.action,
                description: rule.description,
                severity: rule.severity,
                pattern: rule.pattern.source,
            })),
        });
    }
    catch (error) {
        logger_1.logger.error('Error getting WAF rules:', error);
        res.status(500).json({
            success: false,
            error: 'Internal server error',
        });
    }
});
// Enable a specific WAF rule
router.post('/rules/:ruleName/enable', security_middleware_1.requireApiKey, (req, res) => {
    try {
        const { ruleName } = req.params;
        waf_middleware_1.wafManagement.enableRule(ruleName);
        logger_1.logger.info(`WAF rule ${ruleName} enabled by admin`, {
            ip: req.ip,
            timestamp: new Date().toISOString(),
        });
        res.json({
            success: true,
            message: `Rule ${ruleName} enabled successfully`,
        });
    }
    catch (error) {
        logger_1.logger.error('Error enabling WAF rule:', error);
        res.status(500).json({
            success: false,
            error: 'Internal server error',
        });
    }
});
// Disable a specific WAF rule
router.post('/rules/:ruleName/disable', security_middleware_1.requireApiKey, (req, res) => {
    try {
        const { ruleName } = req.params;
        waf_middleware_1.wafManagement.disableRule(ruleName);
        logger_1.logger.warn(`WAF rule ${ruleName} disabled by admin`, {
            ip: req.ip,
            timestamp: new Date().toISOString(),
        });
        res.json({
            success: true,
            message: `Rule ${ruleName} disabled successfully`,
        });
    }
    catch (error) {
        logger_1.logger.error('Error disabling WAF rule:', error);
        res.status(500).json({
            success: false,
            error: 'Internal server error',
        });
    }
});
// Reset WAF statistics
router.post('/stats/reset', security_middleware_1.requireApiKey, (req, res) => {
    try {
        waf_middleware_1.wafManagement.resetStats();
        logger_1.logger.info('WAF statistics reset by admin', {
            ip: req.ip,
            timestamp: new Date().toISOString(),
        });
        res.json({
            success: true,
            message: 'WAF statistics reset successfully',
        });
    }
    catch (error) {
        logger_1.logger.error('Error resetting WAF stats:', error);
        res.status(500).json({
            success: false,
            error: 'Internal server error',
        });
    }
});
// Test WAF with a payload
router.post('/test', security_middleware_1.requireApiKey, (req, res) => {
    try {
        const { payload, context } = req.body;
        if (!payload || !context) {
            return res.status(400).json({
                success: false,
                error: 'Payload and context are required',
            });
        }
        // Create a mock request to test
        const mockReq = {
            url: context === 'URL' ? payload : '/test',
            query: context === 'QUERY' ? { test: payload } : {},
            body: context === 'BODY' ? payload : {},
            headers: context === 'HEADER' ? { 'X-Test': payload } : {},
            ip: req.ip,
            get: (header) => req.get(header),
        };
        const wafInstance = waf_middleware_1.wafManagement.getInstance();
        const analysis = wafInstance.analyzeRequest(mockReq);
        res.json({
            success: true,
            data: {
                blocked: analysis.blocked,
                warnings: analysis.warnings,
                matchedRules: analysis.matchedRules,
                payload: payload.substring(0, 100), // Limit for security
                context,
            },
        });
    }
    catch (error) {
        logger_1.logger.error('Error testing WAF:', error);
        res.status(500).json({
            success: false,
            error: 'Internal server error',
        });
    }
});
// Get WAF health check
router.get('/health', (req, res) => {
    try {
        const stats = waf_middleware_1.wafManagement.getStats();
        const rules = waf_middleware_1.wafManagement.getRules();
        const health = {
            status: 'healthy',
            uptime: process.uptime(),
            rules: {
                total: rules.length,
                enabled: rules.filter(r => r.enabled).length,
                disabled: rules.filter(r => !r.enabled).length,
            },
            stats: {
                totalRequests: stats.totalRequests,
                blockedRequests: stats.blockedRequests,
                warnings: stats.warnings,
                blockRate: stats.totalRequests > 0
                    ? ((stats.blockedRequests / stats.totalRequests) * 100).toFixed(2) + '%'
                    : '0%',
            },
            timestamp: new Date().toISOString(),
        };
        res.json({
            success: true,
            data: health,
        });
    }
    catch (error) {
        logger_1.logger.error('Error getting WAF health:', error);
        res.status(500).json({
            success: false,
            error: 'Internal server error',
        });
    }
});
exports.default = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxyb3V0ZXNcXHdhZi5yb3V0ZXMudHMiLCJtYXBwaW5ncyI6Ijs7QUFBQSxxQ0FBaUM7QUFDakMsMkVBQWtFO0FBQ2xFLGlFQUE2RDtBQUM3RCw0Q0FBeUM7QUFFekMsTUFBTSxNQUFNLEdBQUcsSUFBQSxnQkFBTSxHQUFFLENBQUM7QUFFeEI7OztHQUdHO0FBRUgscUJBQXFCO0FBQ3JCLE1BQU0sQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLG1DQUFhLEVBQUUsQ0FBQyxHQUFRLEVBQUUsR0FBUSxFQUFFLEVBQUU7SUFDekQsSUFBSSxDQUFDO1FBQ0gsTUFBTSxLQUFLLEdBQUcsOEJBQWEsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUV2QyxHQUFHLENBQUMsSUFBSSxDQUFDO1lBQ1AsT0FBTyxFQUFFLElBQUk7WUFDYixJQUFJLEVBQUU7Z0JBQ0osR0FBRyxLQUFLO2dCQUNSLE1BQU0sRUFBRSxPQUFPLENBQUMsTUFBTSxFQUFFO2dCQUN4QixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7YUFDcEM7U0FDRixDQUFDLENBQUM7SUFDTCxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLGVBQU0sQ0FBQyxLQUFLLENBQUMsMEJBQTBCLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDaEQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDbkIsT0FBTyxFQUFFLEtBQUs7WUFDZCxLQUFLLEVBQUUsdUJBQXVCO1NBQy9CLENBQUMsQ0FBQztJQUNMLENBQUM7QUFDSCxDQUFDLENBQUMsQ0FBQztBQUVILG9CQUFvQjtBQUNwQixNQUFNLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxtQ0FBYSxFQUFFLENBQUMsR0FBUSxFQUFFLEdBQVEsRUFBRSxFQUFFO0lBQ3pELElBQUksQ0FBQztRQUNILE1BQU0sS0FBSyxHQUFHLDhCQUFhLENBQUMsUUFBUSxF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QUcsQ0FBQztvQkFDckIsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsZUFBZSxHQUFHLEtBQUssQ0FBQyxhQUFhLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRztvQkFDeEUsQ0FBQyxDQUFDLElBQUk7YUFDWDtZQUNELFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtTQUNwQyxDQUFDO1FBRUYsR0FBRyxDQUFDLElBQUksQ0FBQztZQUNQLE9BQU8sRUFBRSxJQUFJO1lBQ2IsSUFBSSxFQUFFLE1BQU07U0FDYixDQUFDLENBQUM7SUFDTCxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLGVBQU0sQ0FBQyxLQUFLLENBQUMsMkJBQTJCLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDakQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDbkIsT0FBTyxFQUFFLEtBQUs7WUFDZCxLQUFLLEVBQUUsdUJBQXVCO1NBQy9CLENBQUMsQ0FBQztJQUNMLENBQUM7QUFDSCxDQUFDLENBQUMsQ0FBQztBQUVILGtCQUFlLE1BQU0sQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXEFsZWphbmRyb1xcQUlHZXN0aW9uXFxiYWNrZW5kXFxzcmNcXHJvdXRlc1xcd2FmLnJvdXRlcy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IHJlcXVpcmVBcGlLZXkgfSBmcm9tICcuLi9taWRkbGV3YXJlL3NlY3VyaXR5Lm1pZGRsZXdhcmUnO1xuaW1wb3J0IHsgd2FmTWFuYWdlbWVudCB9IGZyb20gJy4uL21pZGRsZXdhcmUvd2FmLm1pZGRsZXdhcmUnO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi4vdXRpbHMvbG9nZ2VyJztcblxuY29uc3Qgcm91dGVyID0gUm91dGVyKCk7XG5cbi8qKlxuICogV0FGIE1hbmFnZW1lbnQgUm91dGVzXG4gKiBUaGVzZSBlbmRwb2ludHMgYWxsb3cgbW9uaXRvcmluZyBhbmQgbWFuYWdpbmcgdGhlIFdlYiBBcHBsaWNhdGlvbiBGaXJld2FsbFxuICovXG5cbi8vIEdldCBXQUYgc3RhdGlzdGljc1xucm91dGVyLmdldCgnL3N0YXRzJywgcmVxdWlyZUFwaUtleSwgKHJlcTogYW55LCByZXM6IGFueSkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHN0YXRzID0gd2FmTWFuYWdlbWVudC5nZXRTdGF0cygpO1xuXG4gICAgcmVzLmpzb24oe1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgLi4uc3RhdHMsXG4gICAgICAgIHVwdGltZTogcHJvY2Vzcy51cHRpbWUoKSxcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICB9LFxuICAgIH0pO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGxvZ2dlci5lcnJvcignRXJyb3IgZ2V0dGluZyBXQUYgc3RhdHM6JywgZXJyb3IpO1xuICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgZXJyb3I6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InLFxuICAgIH0pO1xuICB9XG59KTtcblxuLy8gR2V0IGFsbCBXQUYgcnVsZXNcbnJvdXRlci5nZXQoJy9ydWxlcycsIHJlcXVpcmVBcGlLZXksIChyZXE6IGFueSwgcmVzOiBhbnkpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBydWxlcyA9IHdhZk1hbmFnZW1lbnQuZ2V0UnVsZXMoKTtcblxuICAgIHJlcy5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBkYXRhOiBydWxlcy5tYXAocnVsZSA9PiAoe1xuICAgICAgICBuYW1lOiBydWxlLm5hbWUsXG4gICAgICAgIGVuYWJsZWQ6IHJ1bGUuZW5hYmxlZCxcbiAgICAgICAgYWN0aW9uOiBydWxlLmFjdGlvbixcbiAgICAgICAgZGVzY3JpcHRpb246IHJ1bGUuZGVzY3JpcHRpb24sXG4gICAgICAgIHNldmVyaXR5OiBydWxlLnNldmVyaXR5LFxuICAgICAgICBwYXR0ZXJuOiBydWxlLnBhdHRlcm4uc291cmNlLFxuICAgICAgfSkpLFxuICAgIH0pO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGxvZ2dlci5lcnJvcignRXJyb3IgZ2V0dGluZyBXQUYgcnVsZXM6JywgZXJyb3IpO1xuICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgZXJyb3I6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InLFxuICAgIH0pO1xuICB9XG59KTtcblxuLy8gRW5hYmxlIGEgc3BlY2lmaWMgV0FGIHJ1bGVcbnJvdXRlci5wb3N0KCcvcnVsZXMvOnJ1bGVOYW1lL2VuYWJsZScsIHJlcXVpcmVBcGlLZXksIChyZXE6IGFueSwgcmVzOiBhbnkpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB7IHJ1bGVOYW1lIH0gPSByZXEucGFyYW1zO1xuXG4gICAgd2FmTWFuYWdlbWVudC5lbmFibGVSdWxlKHJ1bGVOYW1lKTtcblxuICAgIGxvZ2dlci5pbmZvKGBXQUYgcnVsZSAke3J1bGVOYW1lfSBlbmFibGVkIGJ5IGFkbWluYCwge1xuICAgICAgaXA6IHJlcS5pcCxcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgIH0pO1xuXG4gICAgcmVzLmpzb24oe1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIG1lc3NhZ2U6IGBSdWxlICR7cnVsZU5hbWV9IGVuYWJsZWQgc3VjY2Vzc2Z1bGx5YCxcbiAgICB9KTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGVuYWJsaW5nIFdBRiBydWxlOicsIGVycm9yKTtcbiAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgIGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyxcbiAgICB9KTtcbiAgfVxufSk7XG5cbi8vIERpc2FibGUgYSBzcGVjaWZpYyBXQUYgcnVsZVxucm91dGVyLnBvc3QoJy9ydWxlcy86cnVsZU5hbWUvZGlzYWJsZScsIHJlcXVpcmVBcGlLZXksIChyZXE6IGFueSwgcmVzOiBhbnkpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB7IHJ1bGVOYW1lIH0gPSByZXEucGFyYW1zO1xuXG4gICAgd2FmTWFuYWdlbWVudC5kaXNhYmxlUnVsZShydWxlTmFtZSk7XG5cbiAgICBsb2dnZXIud2FybihgV0FGIHJ1bGUgJHtydWxlTmFtZX0gZGlzYWJsZWQgYnkgYWRtaW5gLCB7XG4gICAgICBpcDogcmVxLmlwLFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgfSk7XG5cbiAgICByZXMuanNvbih7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgbWVzc2FnZTogYFJ1bGUgJHtydWxlTmFtZX0gZGlzYWJsZWQgc3VjY2Vzc2Z1bGx5YCxcbiAgICB9KTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGRpc2FibGluZyBXQUYgcnVsZTonLCBlcnJvcik7XG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICBlcnJvcjogJ0ludGVybmFsIHNlcnZlciBlcnJvcicsXG4gICAgfSk7XG4gIH1cbn0pO1xuXG4vLyBSZXNldCBXQUYgc3RhdGlzdGljc1xucm91dGVyLnBvc3QoJy9zdGF0cy9yZXNldCcsIHJlcXVpcmVBcGlLZXksIChyZXE6IGFueSwgcmVzOiBhbnkpID0+IHtcbiAgdHJ5IHtcbiAgICB3YWZNYW5hZ2VtZW50LnJlc2V0U3RhdHMoKTtcblxuICAgIGxvZ2dlci5pbmZvKCdXQUYgc3RhdGlzdGljcyByZXNldCBieSBhZG1pbicsIHtcbiAgICAgIGlwOiByZXEuaXAsXG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICB9KTtcblxuICAgIHJlcy5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBtZXNzYWdlOiAnV0FGIHN0YXRpc3RpY3MgcmVzZXQgc3VjY2Vzc2Z1bGx5JyxcbiAgICB9KTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIHJlc2V0dGluZyBXQUYgc3RhdHM6JywgZXJyb3IpO1xuICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgZXJyb3I6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InLFxuICAgIH0pO1xuICB9XG59KTtcblxuLy8gVGVzdCBXQUYgd2l0aCBhIHBheWxvYWRcbnJvdXRlci5wb3N0KCcvdGVzdCcsIHJlcXVpcmVBcGlLZXksIChyZXE6IGFueSwgcmVzOiBhbnkpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB7IHBheWxvYWQsIGNvbnRleHQgfSA9IHJlcS5ib2R5O1xuXG4gICAgaWYgKCFwYXlsb2FkIHx8ICFjb250ZXh0KSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6ICdQYXlsb2FkIGFuZCBjb250ZXh0IGFyZSByZXF1aXJlZCcsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBDcmVhdGUgYSBtb2NrIHJlcXVlc3QgdG8gdGVzdFxuICAgIGNvbnN0IG1vY2tSZXEgPSB7XG4gICAgICB1cmw6IGNvbnRleHQgPT09ICdVUkwnID8gcGF5bG9hZCA6ICcvdGVzdCcsXG4gICAgICBxdWVyeTogY29udGV4dCA9PT0gJ1FVRVJZJyA/IHsgdGVzdDogcGF5bG9hZCB9IDoge30sXG4gICAgICBib2R5OiBjb250ZXh0ID09PSAnQk9EWScgPyBwYXlsb2FkIDoge30sXG4gICAgICBoZWFkZXJzOiBjb250ZXh0ID09PSAnSEVBREVSJyA/IHsgJ1gtVGVzdCc6IHBheWxvYWQgfSA6IHt9LFxuICAgICAgaXA6IHJlcS5pcCxcbiAgICAgIGdldDogKGhlYWRlcjogc3RyaW5nKSA9PiByZXEuZ2V0KGhlYWRlciksXG4gICAgfSBhcyBhbnk7XG5cbiAgICBjb25zdCB3YWZJbnN0YW5jZSA9IHdhZk1hbmFnZW1lbnQuZ2V0SW5zdGFuY2UoKTtcbiAgICBjb25zdCBhbmFseXNpcyA9IHdhZkluc3RhbmNlLmFuYWx5emVSZXF1ZXN0KG1vY2tSZXEpO1xuXG4gICAgcmVzLmpzb24oe1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgYmxvY2tlZDogYW5hbHlzaXMuYmxvY2tlZCxcbiAgICAgICAgd2FybmluZ3M6IGFuYWx5c2lzLndhcm5pbmdzLFxuICAgICAgICBtYXRjaGVkUnVsZXM6IGFuYWx5c2lzLm1hdGNoZWRSdWxlcyxcbiAgICAgICAgcGF5bG9hZDogcGF5bG9hZC5zdWJzdHJpbmcoMCwgMTAwKSwgLy8gTGltaXQgZm9yIHNlY3VyaXR5XG4gICAgICAgIGNvbnRleHQsXG4gICAgICB9LFxuICAgIH0pO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGxvZ2dlci5lcnJvcignRXJyb3IgdGVzdGluZyBXQUY6JywgZXJyb3IpO1xuICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgZXJyb3I6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InLFxuICAgIH0pO1xuICB9XG59KTtcblxuLy8gR2V0IFdBRiBoZWFsdGggY2hlY2tcbnJvdXRlci5nZXQoJy9oZWFsdGgnLCAocmVxOiBhbnksIHJlczogYW55KSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3Qgc3RhdHMgPSB3YWZNYW5hZ2VtZW50LmdldFN0YXRzKCk7XG4gICAgY29uc3QgcnVsZXMgPSB3YWZNYW5hZ2VtZW50LmdldFJ1bGVzKCk7XG5cbiAgICBjb25zdCBoZWFsdGggPSB7XG4gICAgICBzdGF0dXM6ICdoZWFsdGh5JyxcbiAgICAgIHVwdGltZTogcHJvY2Vzcy51cHRpbWUoKSxcbiAgICAgIHJ1bGVzOiB7XG4gICAgICAgIHRvdGFsOiBydWxlcy5sZW5ndGgsXG4gICAgICAgIGVuYWJsZWQ6IHJ1bGVzLmZpbHRlcihyID0+IHIuZW5hYmxlZCkubGVuZ3RoLFxuICAgICAgICBkaXNhYmxlZDogcnVsZXMuZmlsdGVyKHIgPT4gIXIuZW5hYmxlZCkubGVuZ3RoLFxuICAgICAgfSxcbiAgICAgIHN0YXRzOiB7XG4gICAgICAgIHRvdGFsUmVxdWVzdHM6IHN0YXRzLnRvdGFsUmVxdWVzdHMsXG4gICAgICAgIGJsb2NrZWRSZXF1ZXN0czogc3RhdHMuYmxvY2tlZFJlcXVlc3RzLFxuICAgICAgICB3YXJuaW5nczogc3RhdHMud2FybmluZ3MsXG4gICAgICAgIGJsb2NrUmF0ZTpcbiAgICAgICAgICBzdGF0cy50b3RhbFJlcXVlc3RzID4gMFxuICAgICAgICAgICAgPyAoKHN0YXRzLmJsb2NrZWRSZXF1ZXN0cyAvIHN0YXRzLnRvdGFsUmVxdWVzdHMpICogMTAwKS50b0ZpeGVkKDIpICsgJyUnXG4gICAgICAgICAgICA6ICcwJScsXG4gICAgICB9LFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgfTtcblxuICAgIHJlcy5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBkYXRhOiBoZWFsdGgsXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgbG9nZ2VyLmVycm9yKCdFcnJvciBnZXR0aW5nIFdBRiBoZWFsdGg6JywgZXJyb3IpO1xuICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgZXJyb3I6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InLFxuICAgIH0pO1xuICB9XG59KTtcblxuZXhwb3J0IGRlZmF1bHQgcm91dGVyO1xuIl0sInZlcnNpb24iOjN9