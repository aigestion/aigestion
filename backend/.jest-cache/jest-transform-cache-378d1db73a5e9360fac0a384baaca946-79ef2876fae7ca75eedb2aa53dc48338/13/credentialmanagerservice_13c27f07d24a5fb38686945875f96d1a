f2b4e826da354112491da3c159efc9ad
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.CredentialManagerService = void 0;
const axios_1 = __importDefault(require("axios"));
const inversify_1 = require("inversify");
const stripe_1 = __importDefault(require("stripe"));
const telegraf_1 = require("telegraf");
// import { TYPES } from '../types';
const premium_management_1 = require("@/premium_management");
const logger_1 = require("../utils/logger");
let CredentialManagerService = class CredentialManagerService {
    constructor() { }
    /**
     * Verified all critical credentials
     */
    async verifyAll() {
        const results = await Promise.all([
            this.verifyGoogleCloud(),
            this.verifyGemini(),
            this.verifyStripe(),
            this.verifyTelegram(),
            this.verifyInstagram(),
            this.verifyProfessionalAccount(),
        ]);
        logger_1.logger.info('Credential Verification Report Generated');
        return results;
    }
    async verifyGoogleCloud() {
        const hasCreds = !!process.env.GOOGLE_APPLICATION_CREDENTIALS;
        if (!hasCreds) {
            return this.report('Google Cloud', 'missing');
        }
        try {
            // Try to list a single secret or access metadata
            const projectId = process.env.GOOGLE_CLOUD_PROJECT_ID;
            if (!projectId) {
                return this.report('Google Cloud', 'invalid', 'Missing Project ID');
            }
            return this.report('Google Cloud', 'valid');
        }
        catch (e) {
            return this.report('Google Cloud', 'invalid', e.message);
        }
    }
    async verifyGemini() {
        const key = process.env.GEMINI_API_KEY || process.env.GENAI_API_KEY;
        if (!key) {
            return this.report('Gemini AI', 'missing');
        }
        try {
            // Vertex AI typically uses ADC (GCP Creds), not just a key in Node.js Vertex SDK
            // But if user uses Google AI SDK or vertex with key:
            return this.report('Gemini AI', 'valid');
        }
        catch (e) {
            return this.report('Gemini AI', 'invalid', e.message);
        }
    }
    async verifyStripe() {
        const key = process.env.STRIPE_SECRET_KEY;
        if (!key) {
            return this.report('Stripe', 'missing');
        }
        try {
            const stripe = new stripe_1.default(key, { apiVersion: '2022-11-15' });
            await stripe.balance.retrieve();
            return this.report('Stripe', 'valid');
        }
        catch (e) {
            return this.report('Stripe', 'invalid', e.message);
        }
    }
    async verifyTelegram() {
        const token = process.env.TELEGRAM_BOT_TOKEN;
        if (!token) {
            return this.report('Telegram', 'missing');
        }
        try {
            const bot = new telegraf_1.Telegraf(token);
            await bot.telegram.getMe();
            return this.report('Telegram', 'valid');
        }
        catch (e) {
            return this.report('Telegram', 'invalid', e.message);
        }
    }
    async verifyInstagram() {
        const token = process.env.INSTAGRAM_ACCESS_TOKEN;
        if (!token) {
            return this.report('Instagram', 'missing');
        }
        try {
            await axios_1.default.get(`https://graph.facebook.com/v19.0/me?access_token=${token}`);
            return this.report('Instagram', 'valid');
        }
        catch (e) {
            return this.report('Instagram', 'invalid', e.message);
        }
    }
    async verifyProfessionalAccount() {
        try {
            const creds = (0, premium_management_1.loadPremiumCredentials)();
            const proAccount = creds.find(c => c.type === 'professional');
            if (!proAccount) {
                return this.report('Professional Account', 'missing', 'No professional account configured');
            }
            // Basic validation (could be extended to check license servers etc)
            if (proAccount.email === 'admin@aigestion.net') {
                return this.report('Professional Account', 'valid', `Active: ${proAccount.email}`);
            }
            return this.report('Professional Account', 'invalid', 'Unauthorized professional email');
        }
        catch (e) {
            return this.report('Professional Account', 'invalid', e.message);
        }
    }
    report(provider, status, message) {
        return {
            provider,
            status,
            message,
            lastChecked: new Date(),
        };
    }
};
exports.CredentialManagerService = CredentialManagerService;
exports.CredentialManagerService = CredentialManagerService = __decorate([
    (0, inversify_1.injectable)(),
    __metadata("design:paramtypes", [])
], CredentialManagerService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxzZXJ2aWNlc1xcY3JlZGVudGlhbC1tYW5hZ2VyLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsa0RBQTBCO0FBQzFCLHlDQUF1QztBQUN2QyxvREFBNEI7QUFDNUIsdUNBQW9DO0FBRXBDLG9DQUFvQztBQUNwQyw2REFBOEQ7QUFDOUQsNENBQXlDO0FBVWxDLElBQU0sd0JBQXdCLEdBQTlCLE1BQU0sd0JBQXdCO0lBQ25DLGdCQUFlLENBQUM7SUFFaEI7O09BRUc7SUFDSCxLQUFLLENBQUMsU0FBUztRQUNiLE1BQU0sT0FBTyxHQUF1QixNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUM7WUFDcEQsSUFBSSxDQUFDLGlCQUFpQixFQUFFO1lBQ3hCLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDbkIsSUFBSSxDQUFDLFlBQVksRUFBRTtZQUNuQixJQUFJLENBQUMsY0FBYyxFQUFFO1lBQ3JCLElBQUksQ0FBQyxlQUFlLEVBQUU7WUFDdEIsSUFBSSxDQUFDLHlCQUF5QixFQUFFO1NBQ2pDLENBQUMsQ0FBQztRQUVILGVBQU0sQ0FBQyxJQUFJLENBQUMsMENBQTBDLENBQUMsQ0FBQztRQUN4RCxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDO0lBRUQsS0FBSyxDQUFDLGlCQUFpQjtRQUNyQixNQUFNLFFBQVEsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyw4QkFBOEIsQ0FBQztRQUM5RCxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDZCxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsY0FBYyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ2hELENBQUM7UUFFRCxJQUFJLENBQUM7WUFDSCxpREFBaUQ7WUFDakQsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyx1QkFBdUIsQ0FBQztZQUN0RCxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7Z0JBQ2YsT0FBTyxJ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LENBQUMsQ0FBQztRQUNuRSxDQUFDO0lBQ0gsQ0FBQztJQUVPLE1BQU0sQ0FDWixRQUFnQixFQUNoQixNQUFrQyxFQUNsQyxPQUFnQjtRQUVoQixPQUFPO1lBQ0wsUUFBUTtZQUNSLE1BQU07WUFDTixPQUFPO1lBQ1AsV0FBVyxFQUFFLElBQUksSUFBSSxFQUFFO1NBQ3hCLENBQUM7SUFDSixDQUFDO0NBQ0YsQ0FBQTtBQWpJWSw0REFBd0I7bUNBQXhCLHdCQUF3QjtJQURwQyxJQUFBLHNCQUFVLEdBQUU7O0dBQ0Esd0JBQXdCLENBaUlwQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXEFsZWphbmRyb1xcQUlHZXN0aW9uXFxiYWNrZW5kXFxzcmNcXHNlcnZpY2VzXFxjcmVkZW50aWFsLW1hbmFnZXIuc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYXhpb3MgZnJvbSAnYXhpb3MnO1xuaW1wb3J0IHsgaW5qZWN0YWJsZSB9IGZyb20gJ2ludmVyc2lmeSc7XG5pbXBvcnQgU3RyaXBlIGZyb20gJ3N0cmlwZSc7XG5pbXBvcnQgeyBUZWxlZ3JhZiB9IGZyb20gJ3RlbGVncmFmJztcblxuLy8gaW1wb3J0IHsgVFlQRVMgfSBmcm9tICcuLi90eXBlcyc7XG5pbXBvcnQgeyBsb2FkUHJlbWl1bUNyZWRlbnRpYWxzIH0gZnJvbSAnQC9wcmVtaXVtX21hbmFnZW1lbnQnO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi4vdXRpbHMvbG9nZ2VyJztcblxuZXhwb3J0IGludGVyZmFjZSBDcmVkZW50aWFsU3RhdHVzIHtcbiAgcHJvdmlkZXI6IHN0cmluZztcbiAgc3RhdHVzOiAndmFsaWQnIHwgJ2ludmFsaWQnIHwgJ21pc3NpbmcnO1xuICBtZXNzYWdlPzogc3RyaW5nO1xuICBsYXN0Q2hlY2tlZDogRGF0ZTtcbn1cblxuQGluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIENyZWRlbnRpYWxNYW5hZ2VyU2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKCkge31cblxuICAvKipcbiAgICogVmVyaWZpZWQgYWxsIGNyaXRpY2FsIGNyZWRlbnRpYWxzXG4gICAqL1xuICBhc3luYyB2ZXJpZnlBbGwoKTogUHJvbWlzZTxDcmVkZW50aWFsU3RhdHVzW10+IHtcbiAgICBjb25zdCByZXN1bHRzOiBDcmVkZW50aWFsU3RhdHVzW10gPSBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICB0aGlzLnZlcmlmeUdvb2dsZUNsb3VkKCksXG4gICAgICB0aGlzLnZlcmlmeUdlbWluaSgpLFxuICAgICAgdGhpcy52ZXJpZnlTdHJpcGUoKSxcbiAgICAgIHRoaXMudmVyaWZ5VGVsZWdyYW0oKSxcbiAgICAgIHRoaXMudmVyaWZ5SW5zdGFncmFtKCksXG4gICAgICB0aGlzLnZlcmlmeVByb2Zlc3Npb25hbEFjY291bnQoKSxcbiAgICBdKTtcblxuICAgIGxvZ2dlci5pbmZvKCdDcmVkZW50aWFsIFZlcmlmaWNhdGlvbiBSZXBvcnQgR2VuZXJhdGVkJyk7XG4gICAgcmV0dXJuIHJlc3VsdHM7XG4gIH1cblxuICBhc3luYyB2ZXJpZnlHb29nbGVDbG91ZCgpOiBQcm9taXNlPENyZWRlbnRpYWxTdGF0dXM+IHtcbiAgICBjb25zdCBoYXNDcmVkcyA9ICEhcHJvY2Vzcy5lbnYuR09PR0xFX0FQUExJQ0FUSU9OX0NSRURFTlRJQUxTO1xuICAgIGlmICghaGFzQ3JlZHMpIHtcbiAgICAgIHJldHVybiB0aGlzLnJlcG9ydCgnR29vZ2xlIENsb3VkJywgJ21pc3NpbmcnKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgLy8gVHJ5IHRvIGxpc3QgYSBzaW5nbGUgc2VjcmV0IG9yIGFjY2VzcyBtZXRhZGF0YVxuICAgICAgY29uc3QgcHJvamVjdElkID0gcHJvY2Vzcy5lbnYuR09PR0xFX0NMT1VEX1BST0pFQ1RfSUQ7XG4gICAgICBpZiAoIXByb2plY3RJZCkge1xuICAgICAgICByZXR1cm4gdGhpcy5yZXBvcnQoJ0dvb2dsZSBDbG91ZCcsICdpbnZhbGlkJywgJ01pc3NpbmcgUHJvamVjdCBJRCcpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHRoaXMucmVwb3J0KCdHb29nbGUgQ2xvdWQnLCAndmFsaWQnKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICByZXR1cm4gdGhpcy5yZXBvcnQoJ0dvb2dsZSBDbG91ZCcsICdpbnZhbGlkJywgZS5tZXNzYWdlKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyB2ZXJpZnlHZW1pbmkoKTogUHJvbWlzZTxDcmVkZW50aWFsU3RhdHVzPiB7XG4gICAgY29uc3Qga2V5ID0gcHJvY2Vzcy5lbnYuR0VNSU5JX0FQSV9LRVkgfHwgcHJvY2Vzcy5lbnYuR0VOQUlfQVBJX0tFWTtcbiAgICBpZiAoIWtleSkge1xuICAgICAgcmV0dXJuIHRoaXMucmVwb3J0KCdHZW1pbmkgQUknLCAnbWlzc2luZycpO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICAvLyBWZXJ0ZXggQUkgdHlwaWNhbGx5IHVzZXMgQURDIChHQ1AgQ3JlZHMpLCBub3QganVzdCBhIGtleSBpbiBOb2RlLmpzIFZlcnRleCBTREtcbiAgICAgIC8vIEJ1dCBpZiB1c2VyIHVzZXMgR29vZ2xlIEFJIFNESyBvciB2ZXJ0ZXggd2l0aCBrZXk6XG4gICAgICByZXR1cm4gdGhpcy5yZXBvcnQoJ0dlbWluaSBBSScsICd2YWxpZCcpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHJldHVybiB0aGlzLnJlcG9ydCgnR2VtaW5pIEFJJywgJ2ludmFsaWQnLCBlLm1lc3NhZ2UpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHZlcmlmeVN0cmlwZSgpOiBQcm9taXNlPENyZWRlbnRpYWxTdGF0dXM+IHtcbiAgICBjb25zdCBrZXkgPSBwcm9jZXNzLmVudi5TVFJJUEVfU0VDUkVUX0tFWTtcbiAgICBpZiAoIWtleSkge1xuICAgICAgcmV0dXJuIHRoaXMucmVwb3J0KCdTdHJpcGUnLCAnbWlzc2luZycpO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBjb25zdCBzdHJpcGUgPSBuZXcgU3RyaXBlKGtleSwgeyBhcGlWZXJzaW9uOiAnMjAyMi0xMS0xNScgfSk7XG4gICAgICBhd2FpdCBzdHJpcGUuYmFsYW5jZS5yZXRyaWV2ZSgpO1xuICAgICAgcmV0dXJuIHRoaXMucmVwb3J0KCdTdHJpcGUnLCAndmFsaWQnKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICByZXR1cm4gdGhpcy5yZXBvcnQoJ1N0cmlwZScsICdpbnZhbGlkJywgZS5tZXNzYWdlKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyB2ZXJpZnlUZWxlZ3JhbSgpOiBQcm9taXNlPENyZWRlbnRpYWxTdGF0dXM+IHtcbiAgICBjb25zdCB0b2tlbiA9IHByb2Nlc3MuZW52LlRFTEVHUkFNX0JPVF9UT0tFTjtcbiAgICBpZiAoIXRva2VuKSB7XG4gICAgICByZXR1cm4gdGhpcy5yZXBvcnQoJ1RlbGVncmFtJywgJ21pc3NpbmcnKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgYm90ID0gbmV3IFRlbGVncmFmKHRva2VuKTtcbiAgICAgIGF3YWl0IGJvdC50ZWxlZ3JhbS5nZXRNZSgpO1xuICAgICAgcmV0dXJuIHRoaXMucmVwb3J0KCdUZWxlZ3JhbScsICd2YWxpZCcpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHJldHVybiB0aGlzLnJlcG9ydCgnVGVsZWdyYW0nLCAnaW52YWxpZCcsIGUubWVzc2FnZSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgdmVyaWZ5SW5zdGFncmFtKCk6IFByb21pc2U8Q3JlZGVudGlhbFN0YXR1cz4ge1xuICAgIGNvbnN0IHRva2VuID0gcHJvY2Vzcy5lbnYuSU5TVEFHUkFNX0FDQ0VTU19UT0tFTjtcbiAgICBpZiAoIXRva2VuKSB7XG4gICAgICByZXR1cm4gdGhpcy5yZXBvcnQoJ0luc3RhZ3JhbScsICdtaXNzaW5nJyk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGF4aW9zLmdldChgaHR0cHM6Ly9ncmFwaC5mYWNlYm9vay5jb20vdjE5LjAvbWU/YWNjZXNzX3Rva2VuPSR7dG9rZW59YCk7XG4gICAgICByZXR1cm4gdGhpcy5yZXBvcnQoJ0luc3RhZ3JhbScsICd2YWxpZCcpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHJldHVybiB0aGlzLnJlcG9ydCgnSW5zdGFncmFtJywgJ2ludmFsaWQnLCBlLm1lc3NhZ2UpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHZlcmlmeVByb2Zlc3Npb25hbEFjY291bnQoKTogUHJvbWlzZTxDcmVkZW50aWFsU3RhdHVzPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGNyZWRzID0gbG9hZFByZW1pdW1DcmVkZW50aWFscygpO1xuICAgICAgY29uc3QgcHJvQWNjb3VudCA9IGNyZWRzLmZpbmQoYyA9PiBjLnR5cGUgPT09ICdwcm9mZXNzaW9uYWwnKTtcblxuICAgICAgaWYgKCFwcm9BY2NvdW50KSB7XG4gICAgICAgIHJldHVybiB0aGlzLnJlcG9ydCgnUHJvZmVzc2lvbmFsIEFjY291bnQnLCAnbWlzc2luZycsICdObyBwcm9mZXNzaW9uYWwgYWNjb3VudCBjb25maWd1cmVkJyk7XG4gICAgICB9XG5cbiAgICAgIC8vIEJhc2ljIHZhbGlkYXRpb24gKGNvdWxkIGJlIGV4dGVuZGVkIHRvIGNoZWNrIGxpY2Vuc2Ugc2VydmVycyBldGMpXG4gICAgICBpZiAocHJvQWNjb3VudC5lbWFpbCA9PT0gJ2FkbWluQGFpZ2VzdGlvbi5uZXQnKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnJlcG9ydCgnUHJvZmVzc2lvbmFsIEFjY291bnQnLCAndmFsaWQnLCBgQWN0aXZlOiAke3Byb0FjY291bnQuZW1haWx9YCk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB0aGlzLnJlcG9ydCgnUHJvZmVzc2lvbmFsIEFjY291bnQnLCAnaW52YWxpZCcsICdVbmF1dGhvcml6ZWQgcHJvZmVzc2lvbmFsIGVtYWlsJyk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgcmV0dXJuIHRoaXMucmVwb3J0KCdQcm9mZXNzaW9uYWwgQWNjb3VudCcsICdpbnZhbGlkJywgZS5tZXNzYWdlKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJlcG9ydChcbiAgICBwcm92aWRlcjogc3RyaW5nLFxuICAgIHN0YXR1czogQ3JlZGVudGlhbFN0YXR1c1snc3RhdHVzJ10sXG4gICAgbWVzc2FnZT86IHN0cmluZyxcbiAgKTogQ3JlZGVudGlhbFN0YXR1cyB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHByb3ZpZGVyLFxuICAgICAgc3RhdHVzLFxuICAgICAgbWVzc2FnZSxcbiAgICAgIGxhc3RDaGVja2VkOiBuZXcgRGF0ZSgpLFxuICAgIH07XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==