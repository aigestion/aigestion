5f28b32c3be4c92f6c750f1d39073506
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.connectToDatabase = void 0;
const mongoose_1 = __importDefault(require("mongoose"));
const logger_1 = require("../utils/logger");
const config_1 = require("./config");
const { mongo } = config_1.config;
const connectOptions = {
    serverSelectionTimeoutMS: 5000,
    maxPoolSize: 100, // Increase pool for high concurrency
    minPoolSize: 10, // Keep warm connections
    connectTimeoutMS: 5000,
    socketTimeoutMS: 45000,
    family: 4, // Faster IPv4 lookup
};
let isConnected = false;
const connectToDatabase = async () => {
    if (isConnected) {
        logger_1.logger.info('Using existing database connection');
        return;
    }
    try {
        logger_1.logger.info('Connecting to MongoDB...');
        const uri = process.env.MONGO_URI || mongo.uri;
        await mongoose_1.default.connect(uri, connectOptions);
        isConnected = true;
        logger_1.logger.info('Successfully connected to MongoDB');
        // Handle connection events
        mongoose_1.default.connection.on('connected', () => {
            logger_1.logger.info('MongoDB connected');
        });
        mongoose_1.default.connection.on('error', err => {
            logger_1.logger.error(err, 'MongoDB connection error:');
        });
        mongoose_1.default.connection.on('disconnected', () => {
            logger_1.logger.warn('MongoDB disconnected');
            isConnected = false;
        });
        // Handle process termination
        process.on('SIGINT', async () => {
            await mongoose_1.default.connection.close();
            logger_1.logger.info('MongoDB connection closed through app termination');
            process.exit(0);
        });
    }
    catch (error) {
        const err = error;
        logger_1.logger.error(err, 'MongoDB connection error (Resilient Mode Active):');
        logger_1.logger.warn('⚠️ SERVER STARTING WITHOUT DATABASE. SOME FEATURES WILL FAIL. ⚠️');
        // Do NOT exit process. Allow server to start for health check.
    }
};
exports.connectToDatabase = connectToDatabase;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxjb25maWdcXGRhdGFiYXNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLHdEQUFvRDtBQUVwRCw0Q0FBeUM7QUFDekMscUNBQWtDO0FBRWxDLE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxlQUFNLENBQUM7QUFFekIsTUFBTSxjQUFjLEdBQW1CO0lBQ3JDLHdCQUF3QixFQUFFLElBQUk7SUFDOUIsV0FBVyxFQUFFLEdBQUcsRUFBRSxxQ0FBcUM7SUFDdkQsV0FBVyxFQUFFLEVBQUUsRUFBRSx3QkFBd0I7SUFDekMsZ0JBQWdCLEVBQUUsSUFBSTtJQUN0QixlQUFlLEVBQUUsS0FBSztJQUN0QixNQUFNLEVBQUUsQ0FBQyxFQUFFLHFCQUFxQjtDQUNqQyxDQUFDO0FBRUYsSUFBSSxXQUFXLEdBQUcsS0FBSyxDQUFDO0FBRWpCLE1BQU0saUJBQWlCLEdBQUcsS0FBSyxJQUFtQixFQUFFO0lBQ3pELElBQUksV0FBVyxFQUFFLENBQUM7UUFDaEIsZUFBTSxDQUFDLElBQUksQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO1FBQ2xELE9BQU87SUFDVCxDQUFDO0lBRUQsSUFBSSxDQUFDO1FBQ0gsZUFBTSxDQUFDLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO1FBRXhDLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxJQUFJLEtBQUssQ0FBQyxHQUFHLENBQUM7UUFDL0MsTUFBTSxrQkFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsY0FBYyxDQUFDLENBQUM7UUFFNUMsV0FBVyxHQUFHLElBQUksQ0FBQztRQUNuQixlQUFNLENBQUMsSUFBSSxDQUFDLG1DQUFtQyxDQUFDLENBQUM7UUFFakQsMkJBQTJCO1FBQzNCLGtCQUFRLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxXQUFXLEVBQUUsR0FBRyxFQUFFO1lBQ3ZDLGVBQU0sQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsQ0FBQztRQUNuQyxDQUFDLENBQUMsQ0FBQztRQUVILGtCQUFRLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLEVBQUU7WUFDcEMsZUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsMkJBQTJCLENBQUMsQ0FBQztRQUNqRCxDQUFDLENBQUMsQ0FBQztRQUVILGtCQUFRLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxjQUFjLEVBQUUsR0FBRyxFQUFFO1lBQzFDLGVBQU0sQ0FBQyxJQUFJLENBQUMsc0JBQXNCLENBQUMsQ0FBQztZQUNwQyxXQUFXLEdBQUcsS0FBSyxDQUFDO1FBQ3RCLENBQUMsQ0FBQyxDQUFDO1FBRUgsNkJBQTZCO1FBQzdCLE9BQU8sQ0FBQyxFQUFFLENBQUMsUUFBUSxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQzlCLE1BQU0sa0JBQVEsQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDbEMsZUFBTSxDQUFDLElBQUksQ0FBQyxtREFBbUQsQ0FBQyxDQUFDO1lBQ2pFLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbEIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLE1BQU0sR0FBRyxHQUFHLEtBQWMsQ0FBQztRQUMzQixlQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxtREFBbUQsQ0FBQyxDQUFDO1FBQ3ZFLGVBQU0sQ0FBQyxJQUFJLENBQUMsa0VBQWtFLENBQUMsQ0FBQztRQUNoRiwrREFBK0Q7SUFDakUsQ0FBQztBQUNILENBQUMsQ0FBQztBQXpDVyxRQUFBLGlCQUFpQixxQkF5QzVCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcQWxlamFuZHJvXFxBSUdlc3Rpb25cXGJhY2tlbmRcXHNyY1xcY29uZmlnXFxkYXRhYmFzZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbW9uZ29vc2UsIHsgQ29ubmVjdE9wdGlvbnMgfSBmcm9tICdtb25nb29zZSc7XG5cbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uL3V0aWxzL2xvZ2dlcic7XG5pbXBvcnQgeyBjb25maWcgfSBmcm9tICcuL2NvbmZpZyc7XG5cbmNvbnN0IHsgbW9uZ28gfSA9IGNvbmZpZztcblxuY29uc3QgY29ubmVjdE9wdGlvbnM6IENvbm5lY3RPcHRpb25zID0ge1xuICBzZXJ2ZXJTZWxlY3Rpb25UaW1lb3V0TVM6IDUwMDAsXG4gIG1heFBvb2xTaXplOiAxMDAsIC8vIEluY3JlYXNlIHBvb2wgZm9yIGhpZ2ggY29uY3VycmVuY3lcbiAgbWluUG9vbFNpemU6IDEwLCAvLyBLZWVwIHdhcm0gY29ubmVjdGlvbnNcbiAgY29ubmVjdFRpbWVvdXRNUzogNTAwMCxcbiAgc29ja2V0VGltZW91dE1TOiA0NTAwMCxcbiAgZmFtaWx5OiA0LCAvLyBGYXN0ZXIgSVB2NCBsb29rdXBcbn07XG5cbmxldCBpc0Nvbm5lY3RlZCA9IGZhbHNlO1xuXG5leHBvcnQgY29uc3QgY29ubmVjdFRvRGF0YWJhc2UgPSBhc3luYyAoKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gIGlmIChpc0Nvbm5lY3RlZCkge1xuICAgIGxvZ2dlci5pbmZvKCdVc2luZyBleGlzdGluZyBkYXRhYmFzZSBjb25uZWN0aW9uJyk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgdHJ5IHtcbiAgICBsb2dnZXIuaW5mbygnQ29ubmVjdGluZyB0byBNb25nb0RCLi4uJyk7XG5cbiAgICBjb25zdCB1cmkgPSBwcm9jZXNzLmVudi5NT05HT19VUkkgfHwgbW9uZ28udXJpO1xuICAgIGF3YWl0IG1vbmdvb3NlLmNvbm5lY3QodXJpLCBjb25uZWN0T3B0aW9ucyk7XG5cbiAgICBpc0Nvbm5lY3RlZCA9IHRydWU7XG4gICAgbG9nZ2VyLmluZm8oJ1N1Y2Nlc3NmdWxseSBjb25uZWN0ZWQgdG8gTW9uZ29EQicpO1xuXG4gICAgLy8gSGFuZGxlIGNvbm5lY3Rpb24gZXZlbnRzXG4gICAgbW9uZ29vc2UuY29ubmVjdGlvbi5vbignY29ubmVjdGVkJywgKCkgPT4ge1xuICAgICAgbG9nZ2VyLmluZm8oJ01vbmdvREIgY29ubmVjdGVkJyk7XG4gICAgfSk7XG5cbiAgICBtb25nb29zZS5jb25uZWN0aW9uLm9uKCdlcnJvcicsIGVyciA9PiB7XG4gICAgICBsb2dnZXIuZXJyb3IoZXJyLCAnTW9uZ29EQiBjb25uZWN0aW9uIGVycm9yOicpO1xuICAgIH0pO1xuXG4gICAgbW9uZ29vc2UuY29ubmVjdGlvbi5vbignZGlzY29ubmVjdGVkJywgKCkgPT4ge1xuICAgICAgbG9nZ2VyLndhcm4oJ01vbmdvREIgZGlzY29ubmVjdGVkJyk7XG4gICAgICBpc0Nvbm5lY3RlZCA9IGZhbHNlO1xuICAgIH0pO1xuXG4gICAgLy8gSGFuZGxlIHByb2Nlc3MgdGVybWluYXRpb25cbiAgICBwcm9jZXNzLm9uKCdTSUdJTlQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBtb25nb29zZS5jb25uZWN0aW9uLmNsb3NlKCk7XG4gICAgICBsb2dnZXIuaW5mbygnTW9uZ29EQiBjb25uZWN0aW9uIGNsb3NlZCB0aHJvdWdoIGFwcCB0ZXJtaW5hdGlvbicpO1xuICAgICAgcHJvY2Vzcy5leGl0KDApO1xuICAgIH0pO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnN0IGVyciA9IGVycm9yIGFzIEVycm9yO1xuICAgIGxvZ2dlci5lcnJvcihlcnIsICdNb25nb0RCIGNvbm5lY3Rpb24gZXJyb3IgKFJlc2lsaWVudCBNb2RlIEFjdGl2ZSk6Jyk7XG4gICAgbG9nZ2VyLndhcm4oJ+KaoO+4jyBTRVJWRVIgU1RBUlRJTkcgV0lUSE9VVCBEQVRBQkFTRS4gU09NRSBGRUFUVVJFUyBXSUxMIEZBSUwuIOKaoO+4jycpO1xuICAgIC8vIERvIE5PVCBleGl0IHByb2Nlc3MuIEFsbG93IHNlcnZlciB0byBzdGFydCBmb3IgaGVhbHRoIGNoZWNrLlxuICB9XG59O1xuIl0sInZlcnNpb24iOjN9