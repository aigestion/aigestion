{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\controllers\\ai.controller.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\controllers\\ai.controller.ts"],"sourcesContent":["// src/controllers/ai.controller.ts\nimport type { NextFunction, Request, Response } from 'express';\n\nimport { container } from '../config/inversify.config';\nimport { buildResponse } from '../common/response-builder';\nimport { validate, schemas } from '../middleware/validation.middleware';\nimport { AIService } from '../services/ai.service';\nimport { TYPES } from '../types';\nimport { RateLimitService } from '../services/rate-limit.service';\n\nexport const runPrompt = [\n  validate({ body: schemas.ai.prompt }),\n  async (req: Request, res: Response, next: NextFunction) => {\n    try {\n      const { prompt } = req.body;\n      const userId = (req as any).user?.id || 'anonymous';\n      // Get the service from the container to ensure dependencies (Analytics, Search, etc.) are injected\n      const aiService = container.get<AIService>(TYPES.AIService);\n      const rateLimitService = container.get<RateLimitService>(TYPES.RateLimitService);\n\n      // God Mode: Bypass rate limits for admin/god\n      const userRole = (req as any).user?.role;\n      if (userRole !== 'god' && userRole !== 'admin') {\n        // Rate Limit: 10 requests per minute for prompts\n        await rateLimitService.incrementAndCheck(`ai_prompt:${userId}`, 10, 60);\n      }\n\n      const result = await aiService.generateContent(prompt, userId, userRole);\n      res.json(buildResponse(result, 200, (req as any).requestId || 'unknown'));\n    } catch (err) {\n      next(err);\n    }\n  },\n];\n\nexport const streamChat = [\n  validate({ body: schemas.ai.chat }),\n  async (req: Request, res: Response, next: NextFunction) => {\n    try {\n      const { prompt, history } = req.body;\n      const userId = (req as any).user?.id || 'anonymous';\n      const aiService = container.get<AIService>(TYPES.AIService);\n      const rateLimitService = container.get<RateLimitService>(TYPES.RateLimitService);\n\n      // God Mode: Bypass rate limits for admin/god\n      const userRole = (req as any).user?.role;\n      if (userRole !== 'god' && userRole !== 'admin') {\n        // Rate Limit: 20 requests per minute for chat sessions\n        await rateLimitService.incrementAndCheck(`ai_chat:${userId}`, 20, 60);\n      }\n\n      // Set headers for SSE\n      res.setHeader('Content-Type', 'text/event-stream');\n      res.setHeader('Cache-Control', 'no-cache');\n      res.setHeader('Connection', 'keep-alive');\n\n      try {\n        const stream = await aiService.streamChat({ prompt, history, userId, userRole });\n\n        for await (const chunk of stream) {\n          res.write(chunk);\n        }\n\n        res.write('data: [DONE]\\n\\n');\n        res.end();\n      } catch (streamError) {\n        console.error('Streaming error:', streamError);\n        res.write(`data: ${JSON.stringify({ type: 'error', content: 'Streaming failed' })}\\n\\n`);\n        res.end();\n      }\n    } catch (err) {\n      next(err);\n    }\n  },\n];\n"],"version":3}