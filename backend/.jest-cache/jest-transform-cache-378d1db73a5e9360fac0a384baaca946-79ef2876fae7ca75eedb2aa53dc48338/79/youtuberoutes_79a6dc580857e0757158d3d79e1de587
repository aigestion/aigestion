b3fb0e45d5f2a325999a576ab17343cd
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = require("express");
const zod_1 = require("zod");
const inversify_config_1 = require("../config/inversify.config");
const types_1 = require("../types");
const logger_1 = require("../utils/logger");
const youtubeRouter = (0, express_1.Router)();
const youtubeTranscriptionQueue = inversify_config_1.container.get(types_1.TYPES.YoutubeTranscriptionQueue);
const TranscribeSchema = zod_1.z.object({
    videoUrl: zod_1.z.string().url(),
    recipientEmail: zod_1.z.string().email(),
});
/**
 * @openapi
 * /youtube/transcribe:
 *   post:
 *     summary: Request a YouTube video transcription
 *     tags: [YouTube]
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             properties:
 *               videoUrl:
 *                 type: string
 *                 format: uri
 *               recipientEmail:
 *                 type: string
 *                 format: email
 *     responses:
 *       202:
 *         description: Transcription job queued
 *       400:
 *         description: Validation error
 *       500:
 *         description: Server error
 */
youtubeRouter.post('/transcribe', async (req, res) => {
    const requestId = req.requestId;
    try {
        const validated = TranscribeSchema.safeParse(req.body);
        if (!validated.success) {
            return res
                .status(400)
                .json(buildError('Invalid Input', 'VALIDATION_ERROR', 400, requestId, validated.error.flatten().fieldErrors));
        }
        const { videoUrl, recipientEmail } = validated.data;
        const fileName = `manual_request_${Date.now()}`;
        const job = {
            videoUrl,
            recipientEmail,
            fileName,
            timestamp: new Date().toISOString(),
        };
        const published = await youtubeTranscriptionQueue.publishTranscriptionJob(job);
        if (published) {
            logger_1.logger.info(`Transcription requested for ${videoUrl} by ${recipientEmail}`);
            return res.json(buildResponse({ message: 'Transcription job queued', jobId: fileName }, 202, requestId));
        }
        else {
            return res.status(500).json(buildError('Failed to queue job', 'QUEUE_ERROR', 500, requestId));
        }
    }
    catch (error) {
        logger_1.logger.error(error, 'Transcription request failed');
        return res.status(500).json(buildError(error.message, 'INTERNAL_ERROR', 500, requestId));
    }
});
exports.default = youtubeRouter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxyb3V0ZXNcXHlvdXR1YmUucm91dGVzLnRzIiwibWFwcGluZ3MiOiI7O0FBQUEscUNBQWlDO0FBQ2pDLDZCQUF3QjtBQUV4QixpRUFBdUQ7QUFFdkQsb0NBQWlDO0FBQ2pDLDRDQUF5QztBQUV6QyxNQUFNLGFBQWEsR0FBRyxJQUFBLGdCQUFNLEdBQUUsQ0FBQztBQUMvQixNQUFNLHlCQUF5QixHQUFHLDRCQUFTLENBQUMsR0FBRyxDQUM3QyxhQUFLLENBQUMseUJBQXlCLENBQ2hDLENBQUM7QUFFRixNQUFNLGdCQUFnQixHQUFHLE9BQUMsQ0FBQyxNQUFNLENBQUM7SUFDaEMsUUFBUSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLEVBQUU7SUFDMUIsY0FBYyxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxLQUFLLEVBQUU7Q0FDbkMsQ0FBQyxDQUFDO0FBRUg7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBMEJHO0FBQ0gsYUFBYSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsS0FBSyxFQUFFLEdBQVEsRUFBRSxHQUFRLEVBQUUsRUFBRTtJQUM3RCxNQUFNLFNBQVMsR0FBRyxHQUFHLENBQUMsU0FBUyxDQUFDO0lBQ2hDLElBQUksQ0FBQztRQUNILE1BQU0sU0FBUyxHQUFHLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdkQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUN2QixPQUFPLEdBQUc7aUJBQ1AsTUFBTSxDQUFDLEdBQUcsQ0FBQztpQkFDWCxJQUFJLENBQ0gsVUFBVSxDQUNSLGVBQWUsRUFDZixrQkFBa0IsRUFDbEIsR0FBRyxFQUNILFNBQVMsRUFDVCxTQUFTLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDLFdBQVcsQ0FDdEMsQ0FDRixDQUFDO1FBQ04sQ0FBQztRQUVELE1BQU0sRUFBRSxRQUFRLEVBQUUsY0FBYyxFQUFFLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQztRQUNwRCxNQUFNLFFBQVEsR0FBRyxrQkFBa0IsSUFBSSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUM7UUFFaEQsTUFBTSxHQUFHLEdBQUc7WUFDVixRQUFRO1lBQ1IsY0FBYztZQUNkLFFBQVE7WUFDUixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7U0FDcEMsQ0FBQztRQUVGLE1BQU0sU0FBUyxHQUFHLE1BQU0seUJBQXlCLENBQUMsdUJBQXVCLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFL0UsSUFBSSxTQUFTLEVBQUUsQ0FBQztZQUNkLGVBQU0sQ0FBQyxJQUFJLENBQUMsK0JBQStCLFFBQVEsT0FBTyxjQUFjLEVBQUUsQ0FBQyxDQUFDO1lBQzVFLE9BQU8sR0FBRyxDQUFDLElBQUksQ0FDYixhQUFhLENBQUMsRUFBRSxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxFQUFFLEdBQUcsRUFBRSxTQUFTLENBQUMsQ0FDeEYsQ0FBQztRQUNKLENBQUM7YUFBTSxDQUFDO1lBQ04sT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMscUJBQXFCLEVBQUUsYUFBYSxFQUFFLEdBQUcsRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDO1FBQ2hHLENBQUM7SUFDSCxDQUFDO0lBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztRQUNwQixlQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSw4QkFBOEIsQ0FBQyxDQUFDO1FBQ3BELE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7SUFDM0YsQ0FBQztBQUNILENBQUMsQ0FBQyxDQUFDO0FBRUgsa0JBQWUsYUFBYSxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcQWxlamFuZHJvXFxBSUdlc3Rpb25cXGJhY2tlbmRcXHNyY1xccm91dGVzXFx5b3V0dWJlLnJvdXRlcy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IHogfSBmcm9tICd6b2QnO1xuXG5pbXBvcnQgeyBjb250YWluZXIgfSBmcm9tICcuLi9jb25maWcvaW52ZXJzaWZ5LmNvbmZpZyc7XG5pbXBvcnQgeyBZb3V0dWJlVHJhbnNjcmlwdGlvblF1ZXVlIH0gZnJvbSAnLi4vcXVldWUveW91dHViZS10cmFuc2NyaXB0aW9uLnF1ZXVlJztcbmltcG9ydCB7IFRZUEVTIH0gZnJvbSAnLi4vdHlwZXMnO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi4vdXRpbHMvbG9nZ2VyJztcblxuY29uc3QgeW91dHViZVJvdXRlciA9IFJvdXRlcigpO1xuY29uc3QgeW91dHViZVRyYW5zY3JpcHRpb25RdWV1ZSA9IGNvbnRhaW5lci5nZXQ8WW91dHViZVRyYW5zY3JpcHRpb25RdWV1ZT4oXG4gIFRZUEVTLllvdXR1YmVUcmFuc2NyaXB0aW9uUXVldWUsXG4pO1xuXG5jb25zdCBUcmFuc2NyaWJlU2NoZW1hID0gei5vYmplY3Qoe1xuICB2aWRlb1VybDogei5zdHJpbmcoKS51cmwoKSxcbiAgcmVjaXBpZW50RW1haWw6IHouc3RyaW5nKCkuZW1haWwoKSxcbn0pO1xuXG4vKipcbiAqIEBvcGVuYXBpXG4gKiAveW91dHViZS90cmFuc2NyaWJlOlxuICogICBwb3N0OlxuICogICAgIHN1bW1hcnk6IFJlcXVlc3QgYSBZb3VUdWJlIHZpZGVvIHRyYW5zY3JpcHRpb25cbiAqICAgICB0YWdzOiBbWW91VHViZV1cbiAqICAgICByZXF1ZXN0Qm9keTpcbiAqICAgICAgIHJlcXVpcmVkOiB0cnVlXG4gKiAgICAgICBjb250ZW50OlxuICogICAgICAgICBhcHBsaWNhdGlvbi9qc29uOlxuICogICAgICAgICAgIHNjaGVtYTpcbiAqICAgICAgICAgICAgIHR5cGU6IG9iamVjdFxuICogICAgICAgICAgICAgcHJvcGVydGllczpcbiAqICAgICAgICAgICAgICAgdmlkZW9Vcmw6XG4gKiAgICAgICAgICAgICAgICAgdHlwZTogc3RyaW5nXG4gKiAgICAgICAgICAgICAgICAgZm9ybWF0OiB1cmlcbiAqICAgICAgICAgICAgICAgcmVjaXBpZW50RW1haWw6XG4gKiAgICAgICAgICAgICAgICAgdHlwZTogc3RyaW5nXG4gKiAgICAgICAgICAgICAgICAgZm9ybWF0OiBlbWFpbFxuICogICAgIHJlc3BvbnNlczpcbiAqICAgICAgIDIwMjpcbiAqICAgICAgICAgZGVzY3JpcHRpb246IFRyYW5zY3JpcHRpb24gam9iIHF1ZXVlZFxuICogICAgICAgNDAwOlxuICogICAgICAgICBkZXNjcmlwdGlvbjogVmFsaWRhdGlvbiBlcnJvclxuICogICAgICAgNTAwOlxuICogICAgICAgICBkZXNjcmlwdGlvbjogU2VydmVyIGVycm9yXG4gKi9cbnlvdXR1YmVSb3V0ZXIucG9zdCgnL3RyYW5zY3JpYmUnLCBhc3luYyAocmVxOiBhbnksIHJlczogYW55KSA9PiB7XG4gIGNvbnN0IHJlcXVlc3RJZCA9IHJlcS5yZXF1ZXN0SWQ7XG4gIHRyeSB7XG4gICAgY29uc3QgdmFsaWRhdGVkID0gVHJhbnNjcmliZVNjaGVtYS5zYWZlUGFyc2UocmVxLmJvZHkpO1xuICAgIGlmICghdmFsaWRhdGVkLnN1Y2Nlc3MpIHtcbiAgICAgIHJldHVybiByZXNcbiAgICAgICAgLnN0YXR1cyg0MDApXG4gICAgICAgIC5qc29uKFxuICAgICAgICAgIGJ1aWxkRXJyb3IoXG4gICAgICAgICAgICAnSW52YWxpZCBJbnB1dCcsXG4gICAgICAgICAgICAnVkFMSURBVElPTl9FUlJPUicsXG4gICAgICAgICAgICA0MDAsXG4gICAgICAgICAgICByZXF1ZXN0SWQsXG4gICAgICAgICAgICB2YWxpZGF0ZWQuZXJyb3IuZmxhdHRlbigpLmZpZWxkRXJyb3JzLFxuICAgICAgICAgICksXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgeyB2aWRlb1VybCwgcmVjaXBpZW50RW1haWwgfSA9IHZhbGlkYXRlZC5kYXRhO1xuICAgIGNvbnN0IGZpbGVOYW1lID0gYG1hbnVhbF9yZXF1ZXN0XyR7RGF0ZS5ub3coKX1gO1xuXG4gICAgY29uc3Qgam9iID0ge1xuICAgICAgdmlkZW9VcmwsXG4gICAgICByZWNpcGllbnRFbWFpbCxcbiAgICAgIGZpbGVOYW1lLFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgfTtcblxuICAgIGNvbnN0IHB1Ymxpc2hlZCA9IGF3YWl0IHlvdXR1YmVUcmFuc2NyaXB0aW9uUXVldWUucHVibGlzaFRyYW5zY3JpcHRpb25Kb2Ioam9iKTtcblxuICAgIGlmIChwdWJsaXNoZWQpIHtcbiAgICAgIGxvZ2dlci5pbmZvKGBUcmFuc2NyaXB0aW9uIHJlcXVlc3RlZCBmb3IgJHt2aWRlb1VybH0gYnkgJHtyZWNpcGllbnRFbWFpbH1gKTtcbiAgICAgIHJldHVybiByZXMuanNvbihcbiAgICAgICAgYnVpbGRSZXNwb25zZSh7IG1lc3NhZ2U6ICdUcmFuc2NyaXB0aW9uIGpvYiBxdWV1ZWQnLCBqb2JJZDogZmlsZU5hbWUgfSwgMjAyLCByZXF1ZXN0SWQpLFxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKGJ1aWxkRXJyb3IoJ0ZhaWxlZCB0byBxdWV1ZSBqb2InLCAnUVVFVUVfRVJST1InLCA1MDAsIHJlcXVlc3RJZCkpO1xuICAgIH1cbiAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgIGxvZ2dlci5lcnJvcihlcnJvciwgJ1RyYW5zY3JpcHRpb24gcmVxdWVzdCBmYWlsZWQnKTtcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24oYnVpbGRFcnJvcihlcnJvci5tZXNzYWdlLCAnSU5URVJOQUxfRVJST1InLCA1MDAsIHJlcXVlc3RJZCkpO1xuICB9XG59KTtcblxuZXhwb3J0IGRlZmF1bHQgeW91dHViZVJvdXRlcjtcbiJdLCJ2ZXJzaW9uIjozfQ==