3c5ab545b0f20d511310bc263cdd806c
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// Mock logger
jest.mock('../../utils/logger', () => ({
    logger: {
        info: jest.fn(),
        error: jest.fn(),
        warn: jest.fn(),
    },
}));
// Mock secrets utility
jest.mock('../../utils/secrets', () => ({
    deriveMissionKey: jest.fn().mockResolvedValue(Buffer.from('mock-key')),
}));
// Mock container
jest.mock('../../config/inversify.config', () => ({
    container: {
        get: jest.fn(),
    },
}));
require("reflect-metadata");
const SwarmProcessor_1 = require("../../infrastructure/jobs/SwarmProcessor");
const inversify_config_1 = require("../../config/inversify.config");
const types_1 = require("../../types");
const Mission_1 = require("../../models/Mission");
const mockAIService = {
    generateContent: jest.fn(),
};
const mockMissionRepo = {
    update: jest.fn(),
};
const mockSocketService = {
    emitMissionUpdate: jest.fn(),
};
const mockNotificationService = {
    createNotification: jest.fn(),
};
const mockVaultService = {
    encrypt: jest.fn().mockResolvedValue({ iv: 'iv', ciphertext: 'cipher', tag: 'tag' }),
};
const mockSwarmClient = {
    post: jest.fn(),
};
const mockKGService = {
    indexMissionFindings: jest.fn(),
};
describe('SwarmProcessor', () => {
    let mockJob;
    beforeEach(() => {
        jest.clearAllMocks();
        mockJob = {
            id: 'job-123',
            data: {
                objective: 'Test Mission',
                userId: 'user-1',
                missionId: 'mission-1',
                context: {},
            },
        };
        inversify_config_1.container.get.mockImplementation(type => {
            if (type === types_1.TYPES.AIService)
                return mockAIService;
            if (type === types_1.TYPES.MissionRepository)
                return mockMissionRepo;
            if (type === types_1.TYPES.SocketService)
                return mockSocketService;
            if (type === types_1.TYPES.NotificationService)
                return mockNotificationService;
            if (type === types_1.TYPES.VaultService)
                return mockVaultService;
            if (type === types_1.TYPES.SwarmInternalClient)
                return mockSwarmClient;
            if (type === types_1.TYPES.KnowledgeGraphService)
                return mockKGService;
            return {};
        });
    });
    it('should execute mission lifecycle successfully', async () => {
        // Setup mocks
        mockAIService.generateContent
            .mockResolvedValueOnce('Step 1: Plan') // Planning phase
            .mockResolvedValueOnce('Mission Success Report'); // Final report phase
        // Execute
        await SwarmProcessor_1.SwarmProcessor.process(mockJob);
        // Verify Planning Phase
        expect(mockMissionRepo.update).toHaveBeenCalledWith('mission-1', {
            status: Mission_1.MissionStatus.PLANNING,
        });
        expect(mockSocketService.emitMissionUpdate).toHaveBeenCalledWith('mission-1', {
            status: Mission_1.MissionStatus.PLANNING,
        });
        // Verify AI Planning
        expect(mockAIService.generateContent).toHaveBeenNthCalledWith(1, expect.stringContaining('Develop a concise step-by-step strategy'), 'user-1');
        // Verify Executing Phase
        expect(mockMissionRepo.update).toHaveBeenCalledWith('mission-1', {
            plan: 'Step 1: Plan',
            status: Mission_1.MissionStatus.EXECUTING,
        });
        // Verify Final Reporting
        expect(mockAIService.generateContent).toHaveBeenNthCalledWith(2, expect.stringContaining('Generate a final summary'), 'user-1');
        // Verify Completion
        expect(mockMissionRepo.update).toHaveBeenCalledWith('mission-1', expect.objectContaining({
            result: 'cipher',
            vaultIV: 'iv',
            vaultTag: 'tag',
            isEncrypted: true,
            status: Mission_1.MissionStatus.COMPLETED,
            completedAt: expect.any(Date),
        }));
        // Verify Notification — uses positional args:
        // createNotification(userId, type, title, message, metadata)
        expect(mockNotificationService.createNotification).toHaveBeenCalledWith('user-1', expect.anything(), // NotificationType.MISSION_COMPLETED enum value
        expect.any(String), // title
        expect.stringContaining('Test Mission'), // message
        expect.objectContaining({ missionId: 'mission-1' }));
    });
    it('should handle failures and update status to FAILED', async () => {
        const error = new Error('AI Service Down');
        mockAIService.generateContent.mockRejectedValue(error);
        await expect(SwarmProcessor_1.SwarmProcessor.process(mockJob)).rejects.toThrow('AI Service Down');
        // Verify Failure Update
        expect(mockMissionRepo.update).toHaveBeenCalledWith('mission-1', expect.objectContaining({
            status: Mission_1.MissionStatus.FAILED,
            error: 'AI Service Down',
            completedAt: expect.any(Date),
        }));
        // Verify Socket Error Emit
        expect(mockSocketService.emitMissionUpdate).toHaveBeenCalledWith('mission-1', expect.objectContaining({
            status: Mission_1.MissionStatus.FAILED,
            error: 'AI Service Down',
        }));
        // Verify Failure Notification — uses positional args:
        // createNotification(userId, type, title, message, metadata)
        expect(mockNotificationService.createNotification).toHaveBeenCalledWith('user-1', expect.anything(), // NotificationType.MISSION_FAILED enum value
        expect.any(String), // title
        expect.stringContaining('AI Service Down'), // message
        expect.objectContaining({ missionId: 'mission-1' }));
    });
    it('should log error when updating failure status fails', async () => {
        const primaryError = new Error('AI Service Down');
        const secondaryError = new Error('DB Update Failed');
        mockAIService.generateContent.mockRejectedValue(primaryError);
        // First update (planning) succeeds (or we can make AI fail immediately so 1st update is skipped?)
        // The code does:
        // 1. MissionRepo.update(PLANNING)
        // 2. AI Service...
        // If AI Service fails, it goes to catch block.
        // inside catch: MissionRepo.update(FAILED)
        // So we want MissionRepo.update to fail ONLY when called with FAILED status, or just generally fail to simulate the catch-catch block.
        // It's easier if we make it fail on the second call?
        // Actually, let's just make it throw when called with user-1 or something?
        // Or using mockImplementation to throw if status is FAILED.
        mockMissionRepo.update.mockImplementation((id, data) => {
            if (data.status === Mission_1.MissionStatus.FAILED) {
                return Promise.reject(secondaryError);
            }
            return Promise.resolve();
        });
        // We expect the PRIMARY error to be thrown, not the secondary one.
        await expect(SwarmProcessor_1.SwarmProcessor.process(mockJob)).rejects.toThrow('AI Service Down');
        // And we expect the secondary error to be logged
        // We need to import logger to verify this?
        // Or we can rely on console?
        // We mocked logger, let's verify it.
        // We need access to the mocked logger instance.
        // Since we didn't save the mocked logger instance in a variable outside, we can import it.
        const { logger } = require('../../utils/logger');
        expect(logger.error).toHaveBeenCalledWith(expect.stringContaining('Failed to update mission failure status'), secondaryError);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxfX3Rlc3RzX19cXHNlcnZpY2VzXFxTd2FybVByb2Nlc3Nvci50ZXN0LnRzIiwibWFwcGluZ3MiOiI7O0FBT0EsY0FBYztBQUNkLElBQUksQ0FBQyxJQUFJLENBQUMsb0JBQW9CLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUNyQyxNQUFNLEVBQUU7UUFDTixJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUNmLEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQ2hCLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0tBQ2hCO0NBQ0YsQ0FBQyxDQUFDLENBQUM7QUFFSix1QkFBdUI7QUFDdkIsSUFBSSxDQUFDLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ3RDLGdCQUFnQixFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0NBQ3ZFLENBQUMsQ0FBQyxDQUFDO0FBd0JKLGlCQUFpQjtBQUNqQixJQUFJLENBQUMsSUFBSSxDQUFDLCtCQUErQixFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDaEQsU0FBUyxFQUFFO1FBQ1QsR0FBRyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7S0FDZjtDQUNGLENBQUMsQ0FBQyxDQUFDO0FBaERKLDRCQUEwQjtBQUMxQiw2RUFBMEU7QUFFMUUsb0VBQTBEO0FBQzFELHVDQUFvQztBQUNwQyxrREFBcUQ7QUFnQnJELE1BQU0sYUFBYSxHQUFHO0lBQ3BCLGVBQWUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0NBQzNCLENBQUM7QUFDRixNQUFNLGVBQWUsR0FBRztJQUN0QixNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtDQUNsQixDQUFDO0FBQ0YsTUFBTSxpQkFBaUIsR0FBRztJQUN4QixpQkFBaUIsRUFBRSxJ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Q2xFLGNBQWMsQ0FDZixDQUFDO0lBQ0osQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXEFsZWphbmRyb1xcQUlHZXN0aW9uXFxiYWNrZW5kXFxzcmNcXF9fdGVzdHNfX1xcc2VydmljZXNcXFN3YXJtUHJvY2Vzc29yLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICdyZWZsZWN0LW1ldGFkYXRhJztcbmltcG9ydCB7IFN3YXJtUHJvY2Vzc29yIH0gZnJvbSAnLi4vLi4vaW5mcmFzdHJ1Y3R1cmUvam9icy9Td2FybVByb2Nlc3Nvcic7XG5pbXBvcnQgeyBKb2IgfSBmcm9tICdidWxsbXEnO1xuaW1wb3J0IHsgY29udGFpbmVyIH0gZnJvbSAnLi4vLi4vY29uZmlnL2ludmVyc2lmeS5jb25maWcnO1xuaW1wb3J0IHsgVFlQRVMgfSBmcm9tICcuLi8uLi90eXBlcyc7XG5pbXBvcnQgeyBNaXNzaW9uU3RhdHVzIH0gZnJvbSAnLi4vLi4vbW9kZWxzL01pc3Npb24nO1xuXG4vLyBNb2NrIGxvZ2dlclxuamVzdC5tb2NrKCcuLi8uLi91dGlscy9sb2dnZXInLCAoKSA9PiAoe1xuICBsb2dnZXI6IHtcbiAgICBpbmZvOiBqZXN0LmZuKCksXG4gICAgZXJyb3I6IGplc3QuZm4oKSxcbiAgICB3YXJuOiBqZXN0LmZuKCksXG4gIH0sXG59KSk7XG5cbi8vIE1vY2sgc2VjcmV0cyB1dGlsaXR5XG5qZXN0Lm1vY2soJy4uLy4uL3V0aWxzL3NlY3JldHMnLCAoKSA9PiAoe1xuICBkZXJpdmVNaXNzaW9uS2V5OiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoQnVmZmVyLmZyb20oJ21vY2sta2V5JykpLFxufSkpO1xuXG5jb25zdCBtb2NrQUlTZXJ2aWNlID0ge1xuICBnZW5lcmF0ZUNvbnRlbnQ6IGplc3QuZm4oKSxcbn07XG5jb25zdCBtb2NrTWlzc2lvblJlcG8gPSB7XG4gIHVwZGF0ZTogamVzdC5mbigpLFxufTtcbmNvbnN0IG1vY2tTb2NrZXRTZXJ2aWNlID0ge1xuICBlbWl0TWlzc2lvblVwZGF0ZTogamVzdC5mbigpLFxufTtcbmNvbnN0IG1vY2tOb3RpZmljYXRpb25TZXJ2aWNlID0ge1xuICBjcmVhdGVOb3RpZmljYXRpb246IGplc3QuZm4oKSxcbn07XG5jb25zdCBtb2NrVmF1bHRTZXJ2aWNlID0ge1xuICBlbmNyeXB0OiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoeyBpdjogJ2l2JywgY2lwaGVydGV4dDogJ2NpcGhlcicsIHRhZzogJ3RhZycgfSksXG59O1xuY29uc3QgbW9ja1N3YXJtQ2xpZW50ID0ge1xuICBwb3N0OiBqZXN0LmZuKCksXG59O1xuY29uc3QgbW9ja0tHU2VydmljZSA9IHtcbiAgaW5kZXhNaXNzaW9uRmluZGluZ3M6IGplc3QuZm4oKSxcbn07XG5cbi8vIE1vY2sgY29udGFpbmVyXG5qZXN0Lm1vY2soJy4uLy4uL2NvbmZpZy9pbnZlcnNpZnkuY29uZmlnJywgKCkgPT4gKHtcbiAgY29udGFpbmVyOiB7XG4gICAgZ2V0OiBqZXN0LmZuKCksXG4gIH0sXG59KSk7XG5cbmRlc2NyaWJlKCdTd2FybVByb2Nlc3NvcicsICgpID0+IHtcbiAgbGV0IG1vY2tKb2I6IFBhcnRpYWw8Sm9iPjtcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcblxuICAgIG1vY2tKb2IgPSB7XG4gICAgICBpZDogJ2pvYi0xMjMnLFxuICAgICAgZGF0YToge1xuICAgICAgICBvYmplY3RpdmU6ICdUZXN0IE1pc3Npb24nLFxuICAgICAgICB1c2VySWQ6ICd1c2VyLTEnLFxuICAgICAgICBtaXNzaW9uSWQ6ICdtaXNzaW9uLTEnLFxuICAgICAgICBjb250ZXh0OiB7fSxcbiAgICAgIH0sXG4gICAgfTtcblxuICAgIChjb250YWluZXIuZ2V0IGFzIGplc3QuTW9jaykubW9ja0ltcGxlbWVudGF0aW9uKHR5cGUgPT4ge1xuICAgICAgaWYgKHR5cGUgPT09IFRZUEVTLkFJU2VydmljZSkgcmV0dXJuIG1vY2tBSVNlcnZpY2U7XG4gICAgICBpZiAodHlwZSA9PT0gVFlQRVMuTWlzc2lvblJlcG9zaXRvcnkpIHJldHVybiBtb2NrTWlzc2lvblJlcG87XG4gICAgICBpZiAodHlwZSA9PT0gVFlQRVMuU29ja2V0U2VydmljZSkgcmV0dXJuIG1vY2tTb2NrZXRTZXJ2aWNlO1xuICAgICAgaWYgKHR5cGUgPT09IFRZUEVTLk5vdGlmaWNhdGlvblNlcnZpY2UpIHJldHVybiBtb2NrTm90aWZpY2F0aW9uU2VydmljZTtcbiAgICAgIGlmICh0eXBlID09PSBUWVBFUy5WYXVsdFNlcnZpY2UpIHJldHVybiBtb2NrVmF1bHRTZXJ2aWNlO1xuICAgICAgaWYgKHR5cGUgPT09IFRZUEVTLlN3YXJtSW50ZXJuYWxDbGllbnQpIHJldHVybiBtb2NrU3dhcm1DbGllbnQ7XG4gICAgICBpZiAodHlwZSA9PT0gVFlQRVMuS25vd2xlZGdlR3JhcGhTZXJ2aWNlKSByZXR1cm4gbW9ja0tHU2VydmljZTtcbiAgICAgIHJldHVybiB7fTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBleGVjdXRlIG1pc3Npb24gbGlmZWN5Y2xlIHN1Y2Nlc3NmdWxseScsIGFzeW5jICgpID0+IHtcbiAgICAvLyBTZXR1cCBtb2Nrc1xuICAgIG1vY2tBSVNlcnZpY2UuZ2VuZXJhdGVDb250ZW50XG4gICAgICAubW9ja1Jlc29sdmVkVmFsdWVPbmNlKCdTdGVwIDE6IFBsYW4nKSAvLyBQbGFubmluZyBwaGFzZVxuICAgICAgLm1vY2tSZXNvbHZlZFZhbHVlT25jZSgnTWlzc2lvbiBTdWNjZXNzIFJlcG9ydCcpOyAvLyBGaW5hbCByZXBvcnQgcGhhc2VcblxuICAgIC8vIEV4ZWN1dGVcbiAgICBhd2FpdCBTd2FybVByb2Nlc3Nvci5wcm9jZXNzKG1vY2tKb2IgYXMgSm9iKTtcblxuICAgIC8vIFZlcmlmeSBQbGFubmluZyBQaGFzZVxuICAgIGV4cGVjdChtb2NrTWlzc2lvblJlcG8udXBkYXRlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnbWlzc2lvbi0xJywge1xuICAgICAgc3RhdHVzOiBNaXNzaW9uU3RhdHVzLlBMQU5OSU5HLFxuICAgIH0pO1xuICAgIGV4cGVjdChtb2NrU29ja2V0U2VydmljZS5lbWl0TWlzc2lvblVwZGF0ZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ21pc3Npb24tMScsIHtcbiAgICAgIHN0YXR1czogTWlzc2lvblN0YXR1cy5QTEFOTklORyxcbiAgICB9KTtcblxuICAgIC8vIFZlcmlmeSBBSSBQbGFubmluZ1xuICAgIGV4cGVjdChtb2NrQUlTZXJ2aWNlLmdlbmVyYXRlQ29udGVudCkudG9IYXZlQmVlbk50aENhbGxlZFdpdGgoXG4gICAgICAxLFxuICAgICAgZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ0RldmVsb3AgYSBjb25jaXNlIHN0ZXAtYnktc3RlcCBzdHJhdGVneScpLFxuICAgICAgJ3VzZXItMScsXG4gICAgKTtcblxuICAgIC8vIFZlcmlmeSBFeGVjdXRpbmcgUGhhc2VcbiAgICBleHBlY3QobW9ja01pc3Npb25SZXBvLnVwZGF0ZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ21pc3Npb24tMScsIHtcbiAgICAgIHBsYW46ICdTdGVwIDE6IFBsYW4nLFxuICAgICAgc3RhdHVzOiBNaXNzaW9uU3RhdHVzLkVYRUNVVElORyxcbiAgICB9KTtcblxuICAgIC8vIFZlcmlmeSBGaW5hbCBSZXBvcnRpbmdcbiAgICBleHBlY3QobW9ja0FJU2VydmljZS5nZW5lcmF0ZUNvbnRlbnQpLnRvSGF2ZUJlZW5OdGhDYWxsZWRXaXRoKFxuICAgICAgMixcbiAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdHZW5lcmF0ZSBhIGZpbmFsIHN1bW1hcnknKSxcbiAgICAgICd1c2VyLTEnLFxuICAgICk7XG5cbiAgICAvLyBWZXJpZnkgQ29tcGxldGlvblxuICAgIGV4cGVjdChtb2NrTWlzc2lvblJlcG8udXBkYXRlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICdtaXNzaW9uLTEnLFxuICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICByZXN1bHQ6ICdjaXBoZXInLFxuICAgICAgICB2YXVsdElWOiAnaXYnLFxuICAgICAgICB2YXVsdFRhZzogJ3RhZycsXG4gICAgICAgIGlzRW5jcnlwdGVkOiB0cnVlLFxuICAgICAgICBzdGF0dXM6IE1pc3Npb25TdGF0dXMuQ09NUExFVEVELFxuICAgICAgICBjb21wbGV0ZWRBdDogZXhwZWN0LmFueShEYXRlKSxcbiAgICAgIH0pLFxuICAgICk7XG5cbiAgICAvLyBWZXJpZnkgTm90aWZpY2F0aW9uIOKAlCB1c2VzIHBvc2l0aW9uYWwgYXJnczpcbiAgICAvLyBjcmVhdGVOb3RpZmljYXRpb24odXNlcklkLCB0eXBlLCB0aXRsZSwgbWVzc2FnZSwgbWV0YWRhdGEpXG4gICAgZXhwZWN0KG1vY2tOb3RpZmljYXRpb25TZXJ2aWNlLmNyZWF0ZU5vdGlmaWNhdGlvbikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAndXNlci0xJyxcbiAgICAgIGV4cGVjdC5hbnl0aGluZygpLCAvLyBOb3RpZmljYXRpb25UeXBlLk1JU1NJT05fQ09NUExFVEVEIGVudW0gdmFsdWVcbiAgICAgIGV4cGVjdC5hbnkoU3RyaW5nKSwgLy8gdGl0bGVcbiAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdUZXN0IE1pc3Npb24nKSwgLy8gbWVzc2FnZVxuICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoeyBtaXNzaW9uSWQ6ICdtaXNzaW9uLTEnIH0pLCAvLyBtZXRhZGF0YVxuICAgICk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgaGFuZGxlIGZhaWx1cmVzIGFuZCB1cGRhdGUgc3RhdHVzIHRvIEZBSUxFRCcsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcignQUkgU2VydmljZSBEb3duJyk7XG4gICAgbW9ja0FJU2VydmljZS5nZW5lcmF0ZUNvbnRlbnQubW9ja1JlamVjdGVkVmFsdWUoZXJyb3IpO1xuXG4gICAgYXdhaXQgZXhwZWN0KFN3YXJtUHJvY2Vzc29yLnByb2Nlc3MobW9ja0pvYiBhcyBKb2IpKS5yZWplY3RzLnRvVGhyb3coJ0FJIFNlcnZpY2UgRG93bicpO1xuXG4gICAgLy8gVmVyaWZ5IEZhaWx1cmUgVXBkYXRlXG4gICAgZXhwZWN0KG1vY2tNaXNzaW9uUmVwby51cGRhdGUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgJ21pc3Npb24tMScsXG4gICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgIHN0YXR1czogTWlzc2lvblN0YXR1cy5GQUlMRUQsXG4gICAgICAgIGVycm9yOiAnQUkgU2VydmljZSBEb3duJyxcbiAgICAgICAgY29tcGxldGVkQXQ6IGV4cGVjdC5hbnkoRGF0ZSksXG4gICAgICB9KSxcbiAgICApO1xuXG4gICAgLy8gVmVyaWZ5IFNvY2tldCBFcnJvciBFbWl0XG4gICAgZXhwZWN0KG1vY2tTb2NrZXRTZXJ2aWNlLmVtaXRNaXNzaW9uVXBkYXRlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICdtaXNzaW9uLTEnLFxuICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICBzdGF0dXM6IE1pc3Npb25TdGF0dXMuRkFJTEVELFxuICAgICAgICBlcnJvcjogJ0FJIFNlcnZpY2UgRG93bicsXG4gICAgICB9KSxcbiAgICApO1xuXG4gICAgLy8gVmVyaWZ5IEZhaWx1cmUgTm90aWZpY2F0aW9uIOKAlCB1c2VzIHBvc2l0aW9uYWwgYXJnczpcbiAgICAvLyBjcmVhdGVOb3RpZmljYXRpb24odXNlcklkLCB0eXBlLCB0aXRsZSwgbWVzc2FnZSwgbWV0YWRhdGEpXG4gICAgZXhwZWN0KG1vY2tOb3RpZmljYXRpb25TZXJ2aWNlLmNyZWF0ZU5vdGlmaWNhdGlvbikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAndXNlci0xJyxcbiAgICAgIGV4cGVjdC5hbnl0aGluZygpLCAvLyBOb3RpZmljYXRpb25UeXBlLk1JU1NJT05fRkFJTEVEIGVudW0gdmFsdWVcbiAgICAgIGV4cGVjdC5hbnkoU3RyaW5nKSwgLy8gdGl0bGVcbiAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdBSSBTZXJ2aWNlIERvd24nKSwgLy8gbWVzc2FnZVxuICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoeyBtaXNzaW9uSWQ6ICdtaXNzaW9uLTEnIH0pLCAvLyBtZXRhZGF0YVxuICAgICk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgbG9nIGVycm9yIHdoZW4gdXBkYXRpbmcgZmFpbHVyZSBzdGF0dXMgZmFpbHMnLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgcHJpbWFyeUVycm9yID0gbmV3IEVycm9yKCdBSSBTZXJ2aWNlIERvd24nKTtcbiAgICBjb25zdCBzZWNvbmRhcnlFcnJvciA9IG5ldyBFcnJvcignREIgVXBkYXRlIEZhaWxlZCcpO1xuXG4gICAgbW9ja0FJU2VydmljZS5nZW5lcmF0ZUNvbnRlbnQubW9ja1JlamVjdGVkVmFsdWUocHJpbWFyeUVycm9yKTtcbiAgICAvLyBGaXJzdCB1cGRhdGUgKHBsYW5uaW5nKSBzdWNjZWVkcyAob3Igd2UgY2FuIG1ha2UgQUkgZmFpbCBpbW1lZGlhdGVseSBzbyAxc3QgdXBkYXRlIGlzIHNraXBwZWQ/KVxuICAgIC8vIFRoZSBjb2RlIGRvZXM6XG4gICAgLy8gMS4gTWlzc2lvblJlcG8udXBkYXRlKFBMQU5OSU5HKVxuICAgIC8vIDIuIEFJIFNlcnZpY2UuLi5cblxuICAgIC8vIElmIEFJIFNlcnZpY2UgZmFpbHMsIGl0IGdvZXMgdG8gY2F0Y2ggYmxvY2suXG4gICAgLy8gaW5zaWRlIGNhdGNoOiBNaXNzaW9uUmVwby51cGRhdGUoRkFJTEVEKVxuXG4gICAgLy8gU28gd2Ugd2FudCBNaXNzaW9uUmVwby51cGRhdGUgdG8gZmFpbCBPTkxZIHdoZW4gY2FsbGVkIHdpdGggRkFJTEVEIHN0YXR1cywgb3IganVzdCBnZW5lcmFsbHkgZmFpbCB0byBzaW11bGF0ZSB0aGUgY2F0Y2gtY2F0Y2ggYmxvY2suXG4gICAgLy8gSXQncyBlYXNpZXIgaWYgd2UgbWFrZSBpdCBmYWlsIG9uIHRoZSBzZWNvbmQgY2FsbD9cbiAgICAvLyBBY3R1YWxseSwgbGV0J3MganVzdCBtYWtlIGl0IHRocm93IHdoZW4gY2FsbGVkIHdpdGggdXNlci0xIG9yIHNvbWV0aGluZz9cbiAgICAvLyBPciB1c2luZyBtb2NrSW1wbGVtZW50YXRpb24gdG8gdGhyb3cgaWYgc3RhdHVzIGlzIEZBSUxFRC5cblxuICAgIG1vY2tNaXNzaW9uUmVwby51cGRhdGUubW9ja0ltcGxlbWVudGF0aW9uKChpZCwgZGF0YSkgPT4ge1xuICAgICAgaWYgKGRhdGEuc3RhdHVzID09PSBNaXNzaW9uU3RhdHVzLkZBSUxFRCkge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3Qoc2Vjb25kYXJ5RXJyb3IpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgIH0pO1xuXG4gICAgLy8gV2UgZXhwZWN0IHRoZSBQUklNQVJZIGVycm9yIHRvIGJlIHRocm93biwgbm90IHRoZSBzZWNvbmRhcnkgb25lLlxuICAgIGF3YWl0IGV4cGVjdChTd2FybVByb2Nlc3Nvci5wcm9jZXNzKG1vY2tKb2IgYXMgSm9iKSkucmVqZWN0cy50b1Rocm93KCdBSSBTZXJ2aWNlIERvd24nKTtcblxuICAgIC8vIEFuZCB3ZSBleHBlY3QgdGhlIHNlY29uZGFyeSBlcnJvciB0byBiZSBsb2dnZWRcbiAgICAvLyBXZSBuZWVkIHRvIGltcG9ydCBsb2dnZXIgdG8gdmVyaWZ5IHRoaXM/XG4gICAgLy8gT3Igd2UgY2FuIHJlbHkgb24gY29uc29sZT9cbiAgICAvLyBXZSBtb2NrZWQgbG9nZ2VyLCBsZXQncyB2ZXJpZnkgaXQuXG4gICAgLy8gV2UgbmVlZCBhY2Nlc3MgdG8gdGhlIG1vY2tlZCBsb2dnZXIgaW5zdGFuY2UuXG4gICAgLy8gU2luY2Ugd2UgZGlkbid0IHNhdmUgdGhlIG1vY2tlZCBsb2dnZXIgaW5zdGFuY2UgaW4gYSB2YXJpYWJsZSBvdXRzaWRlLCB3ZSBjYW4gaW1wb3J0IGl0LlxuICAgIGNvbnN0IHsgbG9nZ2VyIH0gPSByZXF1aXJlKCcuLi8uLi91dGlscy9sb2dnZXInKTtcbiAgICBleHBlY3QobG9nZ2VyLmVycm9yKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdGYWlsZWQgdG8gdXBkYXRlIG1pc3Npb24gZmFpbHVyZSBzdGF0dXMnKSxcbiAgICAgIHNlY29uZGFyeUVycm9yLFxuICAgICk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=