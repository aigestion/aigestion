{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\middleware\\errorHandler.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\middleware\\errorHandler.ts"],"sourcesContent":["import type { NextFunction, Request, Response } from 'express';\nimport { logger } from '../utils/logger';\nimport { AppError, HttpStatusCode } from '../utils/errors';\n\n/**\n * Central error-handling middleware for Express.\n *\n * It catches synchronous and asynchronous errors. Operational errors (AppError)\n * are sent to the client with their status code and code. External errors\n * (Zod, Mongoose, JWT) are transformed into operational AppErrors for consistency.\n */\nexport const errorHandler = (err: any, req: Request, res: Response, _next: NextFunction) => {\n  let error = { ...err };\n  error.message = err.message;\n\n  // 1. Handle specific error types\n\n  // Zod Validation Errors\n  if (err.name === 'ZodError') {\n    const message = 'Validation Failed';\n    const details = err.issues.map((i: any) => ({\n      path: i.path.join('.'),\n      message: i.message,\n    }));\n    error = new AppError(message, HttpStatusCode.BAD_REQUEST, 'VALIDATION_ERROR', details);\n  }\n\n  // Mongoose Cast Error (e.g., invalid ObjectId)\n  if (err.name === 'CastError') {\n    const message = `Invalid ${err.path}: ${err.value}`;\n    error = new AppError(message, HttpStatusCode.BAD_REQUEST, 'CAST_ERROR');\n  }\n\n  // Mongoose Duplicate Key Error\n  if (err.code === 11000) {\n    const value = err.errmsg.match(/([\"'])(\\\\?.)*?\\1/)[0];\n    const message = `Duplicate field value: ${value}. Please use another value!`;\n    error = new AppError(message, HttpStatusCode.CONFLICT, 'DUPLICATE_KEY_ERROR');\n  }\n\n  // Mongoose Validation Error\n  if (err.name === 'ValidationError') {\n    const errors = Object.values(err.errors).map((el: any) => el.message);\n    const message = `Invalid input data. ${errors.join('. ')}`;\n    error = new AppError(message, HttpStatusCode.BAD_REQUEST, 'VALIDATION_ERROR');\n  }\n\n  // JWT Errors\n  if (err.name === 'JsonWebTokenError') {\n    error = new AppError(\n      'Invalid token. Please log in again!',\n      HttpStatusCode.UNAUTHORIZED,\n      'INVALID_TOKEN',\n    );\n  }\n  if (err.name === 'TokenExpiredError') {\n    error = new AppError(\n      'Your token has expired! Please log in again.',\n      HttpStatusCode.UNAUTHORIZED,\n      'TOKEN_EXPIRED',\n    );\n  }\n\n  // 2. Final Error Response\n  const statusCode = err.status || error.statusCode || HttpStatusCode.INTERNAL_SERVER_ERROR;\n  const isDevelopment = process.env.NODE_ENV === 'development';\n  const requestId = (req as any).requestId || '';\n\n  // Log non-operational (unexpected) errors\n  if (!error.isOperational) {\n    logger.error('ERROR ðŸ’¥:', err);\n\n    // Phase 5: Report to Google Cloud in production\n    try {\n      const { container, TYPES } = require('../config/inversify.config');\n      const { ErrorReportingService } = require('../services/google/error-reporting.service');\n      const errorReporting = container.get(TYPES.ErrorReportingService);\n      errorReporting.report(err, req);\n    } catch (reportErr) {\n      logger.error('Failed to report error to Google Cloud', reportErr);\n    }\n  } else {\n    logger.warn(`Operational Error: ${error.message} [${error.code}]`);\n  }\n\n  // Use standardized builder for consistent error format\n  const { buildError } = require('../common/response-builder');\n  const response = buildError(\n    error.message || 'Something went wrong!',\n    error.code || 'INTERNAL_ERROR',\n    statusCode,\n    requestId,\n    error.details,\n  );\n\n  // Add stack trace in development\n  if (isDevelopment && !error.isOperational) {\n    response.error.stack = err.stack;\n  }\n\n  res.status(statusCode).json(response);\n};\n\n// Exporting HttpError for legacy compatibility if needed, but AppError is preferred.\nexport { AppError as HttpError };\n"],"version":3}