714b68be53fda611d609a1d5034af5ce
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.DocumentProcessorService = void 0;
const documentai_1 = require("@google-cloud/documentai");
const inversify_1 = require("inversify");
const env_schema_1 = require("../../config/env.schema");
const logger_1 = require("../../utils/logger");
let DocumentProcessorService = class DocumentProcessorService {
    client;
    constructor() {
        this.client = new documentai_1.DocumentProcessorServiceClient();
    }
    /**
     * Processes a document (Invoice or Contract) using GCP Document AI
     */
    async processDocument(fileBuffer, mimeType, processorId) {
        const projectId = env_schema_1.env.GOOGLE_CLOUD_PROJECT_ID;
        const location = env_schema_1.env.GOOGLE_CLOUD_LOCATION || 'europe-west1';
        const name = `projects/${projectId}/locations/${location}/processors/${processorId}`;
        const request = {
            name,
            rawDocument: {
                content: fileBuffer,
                mimeType,
            },
        };
        try {
            const [result] = await this.client.processDocument(request);
            const { document } = result;
            if (!document) {
                throw new Error('Document AI returned empty document');
            }
            return this.extractEntities(document);
        }
        catch (error) {
            logger_1.logger.error('[DocumentProcessorService] Error processing document:', error);
            throw error;
        }
    }
    /**
     * Specifically handles invoice processing
     */
    async processInvoice(fileBuffer) {
        const processorId = env_schema_1.env.INVOICE_PROCESSOR_ID;
        if (!processorId)
            throw new Error('INVOICE_PROCESSOR_ID not configured');
        return this.processDocument(fileBuffer, 'application/pdf', processorId);
    }
    /**
     * Specifically handles contract processing
     */
    async processContract(fileBuffer) {
        const processorId = env_schema_1.env.CONTRACT_PROCESSOR_ID;
        if (!processorId)
            throw new Error('CONTRACT_PROCESSOR_ID not configured');
        return this.processDocument(fileBuffer, 'application/pdf', processorId);
    }
    /**
     * Extracts structured entities from the Document AI response
     */
    extractEntities(document) {
        const entities = document.entities || [];
        const extractedData = {};
        entities.forEach((entity) => {
            extractedData[entity.type] = entity.mentionText || entity.normalizedValue?.text;
        });
        return {
            extractedData,
            text: document.text,
        };
    }
};
exports.DocumentProcessorService = DocumentProcessorService;
exports.DocumentProcessorService = DocumentProcessorService = __decorate([
    (0, inversify_1.injectable)(),
    __metadata("design:paramtypes", [])
], DocumentProcessorService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxzZXJ2aWNlc1xcZ29vZ2xlXFxkb2N1bWVudC1wcm9jZXNzb3Iuc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFBQSx5REFBMEU7QUFDMUUseUNBQStDO0FBQy9DLHdEQUE4QztBQUM5QywrQ0FBNEM7QUFHckMsSUFBTSx3QkFBd0IsR0FBOUIsTUFBTSx3QkFBd0I7SUFDM0IsTUFBTSxDQUFpQztJQUUvQztRQUNFLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSwyQ0FBOEIsRUFBRSxDQUFDO0lBQ3JELENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxlQUFlLENBQUMsVUFBa0IsRUFBRSxRQUFnQixFQUFFLFdBQW1CO1FBQzdFLE1BQU0sU0FBUyxHQUFHLGdCQUFHLENBQUMsdUJBQXVCLENBQUM7UUFDOUMsTUFBTSxRQUFRLEdBQUcsZ0JBQUcsQ0FBQyxxQkFBcUIsSUFBSSxjQUFjLENBQUM7UUFFN0QsTUFBTSxJQUFJLEdBQUcsWUFBWSxTQUFTLGNBQWMsUUFBUSxlQUFlLFdBQVcsRUFBRSxDQUFDO1FBRXJGLE1BQU0sT0FBTyxHQUFHO1lBQ2QsSUFBSTtZQUNKLFdBQVcsRUFBRTtnQkFDWCxPQUFPLEVBQUUsVUFBVTtnQkFDbkIsUUFBUTthQUNUO1NBQ0YsQ0FBQztRQUVGLElBQUksQ0FBQztZQUNILE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQzVELE1BQU0sRUFBRSxRQUFRLEVBQUUsR0FBRyxNQUFNLENBQUM7WUFFNUIsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO2dCQUNkLE1BQU0sSUFBSSxLQUFLLENBQUMscUNBQXFDLENBQUMsQ0FBQztZQUN6RCxDQUFDO1lBRUQsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3hDLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsZUFBTSxDQUFDLEtBQUssQ0FBQyx1REFBdUQsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUM3RSxNQUFNLEtBQUssQ0FBQztRQUNkLENBQUM7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsY0FBYyxDQUFDLFVBQWtCO1FBQ3JDLE1BQU0sV0FBVyxHQUFHLGdCQUFHLENBQUMsb0JBQW9CLENBQUM7UUFDN0MsSUFBSSxDQUFDLFdBQVc7WUFBRSxNQUFNLElBQUksS0FBSyxDQUFDLHFDQUFxQyxDQUFDLENBQUM7UUFDekUsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDLFVBQVUsRUFBRSxpQkFBaUIsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUMxRSxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsZUFBZSxDQUFDLFVBQWtCO1FBQ3RDLE1BQU0sV0FBVyxHQUFHLGdCQUFHLENBQUMscUJBQXFCLENBQUM7UUFDOUMsSUFBSSxDQUFDLFdBQVc7WUFBRSxNQUFNLElBQUksS0FBSyxDQUFDLHNDQUFzQyxDQUFDLENBQUM7UUFDMUUsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDLFVBQVUsRUFBRSxpQkFBaUIsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUMxRSxDQUFDO0lBRUQ7O09BRUc7SUFDSyxlQUFlLENBQUMsUUFBYTtRQUNuQyxNQUFNLFFBQVEsR0FBRyxRQUFRLENBQUMsUUFBUSxJQUFJLEVBQUUsQ0FBQztRQUN6QyxNQUFNLGFBQWEsR0FBd0IsRUFBRSxDQUFDO1FBRTlDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFXLEVBQUUsRUFBRTtZQUMvQixhQUFhLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLE1BQU0sQ0FBQyxXQUFXLElBQUksTUFBTSxDQUFDLGVBQWUsRUFBRSxJQUFJLENBQUM7UUFDbEYsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPO1lBQ0wsYUFBYTtZQUNiLElBQUksRUFBRSxRQUFRLENBQUMsSUFBSTtTQUNwQixDQUFDO0lBQ0osQ0FBQztDQUNGLENBQUE7QUF6RVksNERBQXdCO21DQUF4Qix3QkFBd0I7SUFEcEMsSUFBQSxzQkFBVSxHQUFFOztHQUNBLHdCQUF3QixDQXlFcEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxzZXJ2aWNlc1xcZ29vZ2xlXFxkb2N1bWVudC1wcm9jZXNzb3Iuc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEb2N1bWVudFByb2Nlc3NvclNlcnZpY2VDbGllbnQgfSBmcm9tICdAZ29vZ2xlLWNsb3VkL2RvY3VtZW50YWknO1xuaW1wb3J0IHsgaW5qZWN0LCBpbmplY3RhYmxlIH0gZnJvbSAnaW52ZXJzaWZ5JztcbmltcG9ydCB7IGVudiB9IGZyb20gJy4uLy4uL2NvbmZpZy9lbnYuc2NoZW1hJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uLy4uL3V0aWxzL2xvZ2dlcic7XG5cbkBpbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBEb2N1bWVudFByb2Nlc3NvclNlcnZpY2Uge1xuICBwcml2YXRlIGNsaWVudDogRG9jdW1lbnRQcm9jZXNzb3JTZXJ2aWNlQ2xpZW50O1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMuY2xpZW50ID0gbmV3IERvY3VtZW50UHJvY2Vzc29yU2VydmljZUNsaWVudCgpO1xuICB9XG5cbiAgLyoqXG4gICAqIFByb2Nlc3NlcyBhIGRvY3VtZW50IChJbnZvaWNlIG9yIENvbnRyYWN0KSB1c2luZyBHQ1AgRG9jdW1lbnQgQUlcbiAgICovXG4gIGFzeW5jIHByb2Nlc3NEb2N1bWVudChmaWxlQnVmZmVyOiBCdWZmZXIsIG1pbWVUeXBlOiBzdHJpbmcsIHByb2Nlc3NvcklkOiBzdHJpbmcpOiBQcm9taXNlPGFueT4ge1xuICAgIGNvbnN0IHByb2plY3RJZCA9IGVudi5HT09HTEVfQ0xPVURfUFJPSkVDVF9JRDtcbiAgICBjb25zdCBsb2NhdGlvbiA9IGVudi5HT09HTEVfQ0xPVURfTE9DQVRJT04gfHwgJ2V1cm9wZS13ZXN0MSc7XG5cbiAgICBjb25zdCBuYW1lID0gYHByb2plY3RzLyR7cHJvamVjdElkfS9sb2NhdGlvbnMvJHtsb2NhdGlvbn0vcHJvY2Vzc29ycy8ke3Byb2Nlc3NvcklkfWA7XG5cbiAgICBjb25zdCByZXF1ZXN0ID0ge1xuICAgICAgbmFtZSxcbiAgICAgIHJhd0RvY3VtZW50OiB7XG4gICAgICAgIGNvbnRlbnQ6IGZpbGVCdWZmZXIsXG4gICAgICAgIG1pbWVUeXBlLFxuICAgICAgfSxcbiAgICB9O1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IFtyZXN1bHRdID0gYXdhaXQgdGhpcy5jbGllbnQucHJvY2Vzc0RvY3VtZW50KHJlcXVlc3QpO1xuICAgICAgY29uc3QgeyBkb2N1bWVudCB9ID0gcmVzdWx0O1xuXG4gICAgICBpZiAoIWRvY3VtZW50KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignRG9jdW1lbnQgQUkgcmV0dXJuZWQgZW1wdHkgZG9jdW1lbnQnKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRoaXMuZXh0cmFjdEVudGl0aWVzKGRvY3VtZW50KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdbRG9jdW1lbnRQcm9jZXNzb3JTZXJ2aWNlXSBFcnJvciBwcm9jZXNzaW5nIGRvY3VtZW50OicsIGVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTcGVjaWZpY2FsbHkgaGFuZGxlcyBpbnZvaWNlIHByb2Nlc3NpbmdcbiAgICovXG4gIGFzeW5jIHByb2Nlc3NJbnZvaWNlKGZpbGVCdWZmZXI6IEJ1ZmZlcik6IFByb21pc2U8YW55PiB7XG4gICAgY29uc3QgcHJvY2Vzc29ySWQgPSBlbnYuSU5WT0lDRV9QUk9DRVNTT1JfSUQ7XG4gICAgaWYgKCFwcm9jZXNzb3JJZCkgdGhyb3cgbmV3IEVycm9yKCdJTlZPSUNFX1BST0NFU1NPUl9JRCBub3QgY29uZmlndXJlZCcpO1xuICAgIHJldHVybiB0aGlzLnByb2Nlc3NEb2N1bWVudChmaWxlQnVmZmVyLCAnYXBwbGljYXRpb24vcGRmJywgcHJvY2Vzc29ySWQpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNwZWNpZmljYWxseSBoYW5kbGVzIGNvbnRyYWN0IHByb2Nlc3NpbmdcbiAgICovXG4gIGFzeW5jIHByb2Nlc3NDb250cmFjdChmaWxlQnVmZmVyOiBCdWZmZXIpOiBQcm9taXNlPGFueT4ge1xuICAgIGNvbnN0IHByb2Nlc3NvcklkID0gZW52LkNPTlRSQUNUX1BST0NFU1NPUl9JRDtcbiAgICBpZiAoIXByb2Nlc3NvcklkKSB0aHJvdyBuZXcgRXJyb3IoJ0NPTlRSQUNUX1BST0NFU1NPUl9JRCBub3QgY29uZmlndXJlZCcpO1xuICAgIHJldHVybiB0aGlzLnByb2Nlc3NEb2N1bWVudChmaWxlQnVmZmVyLCAnYXBwbGljYXRpb24vcGRmJywgcHJvY2Vzc29ySWQpO1xuICB9XG5cbiAgLyoqXG4gICAqIEV4dHJhY3RzIHN0cnVjdHVyZWQgZW50aXRpZXMgZnJvbSB0aGUgRG9jdW1lbnQgQUkgcmVzcG9uc2VcbiAgICovXG4gIHByaXZhdGUgZXh0cmFjdEVudGl0aWVzKGRvY3VtZW50OiBhbnkpOiBhbnkge1xuICAgIGNvbnN0IGVudGl0aWVzID0gZG9jdW1lbnQuZW50aXRpZXMgfHwgW107XG4gICAgY29uc3QgZXh0cmFjdGVkRGF0YTogUmVjb3JkPHN0cmluZywgYW55PiA9IHt9O1xuXG4gICAgZW50aXRpZXMuZm9yRWFjaCgoZW50aXR5OiBhbnkpID0+IHtcbiAgICAgIGV4dHJhY3RlZERhdGFbZW50aXR5LnR5cGVdID0gZW50aXR5Lm1lbnRpb25UZXh0IHx8IGVudGl0eS5ub3JtYWxpemVkVmFsdWU/LnRleHQ7XG4gICAgfSk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgZXh0cmFjdGVkRGF0YSxcbiAgICAgIHRleHQ6IGRvY3VtZW50LnRleHQsXG4gICAgfTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9