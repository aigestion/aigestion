{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\google\\document-processor.service.ts","mappings":";;;;;;;;;;;;AAAA,yDAA0E;AAC1E,yCAA+C;AAC/C,wDAA8C;AAC9C,+CAA4C;AAGrC,IAAM,wBAAwB,GAA9B,MAAM,wBAAwB;IAC3B,MAAM,CAAiC;IAE/C;QACE,IAAI,CAAC,MAAM,GAAG,IAAI,2CAA8B,EAAE,CAAC;IACrD,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,eAAe,CAAC,UAAkB,EAAE,QAAgB,EAAE,WAAmB;QAC7E,MAAM,SAAS,GAAG,gBAAG,CAAC,uBAAuB,CAAC;QAC9C,MAAM,QAAQ,GAAG,gBAAG,CAAC,qBAAqB,IAAI,cAAc,CAAC;QAE7D,MAAM,IAAI,GAAG,YAAY,SAAS,cAAc,QAAQ,eAAe,WAAW,EAAE,CAAC;QAErF,MAAM,OAAO,GAAG;YACd,IAAI;YACJ,WAAW,EAAE;gBACX,OAAO,EAAE,UAAU;gBACnB,QAAQ;aACT;SACF,CAAC;QAEF,IAAI,CAAC;YACH,MAAM,CAAC,MAAM,CAAC,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,eAAe,CAAC,OAAO,CAAC,CAAC;YAC5D,MAAM,EAAE,QAAQ,EAAE,GAAG,MAAM,CAAC;YAE5B,IAAI,CAAC,QAAQ,EAAE,CAAC;gBACd,MAAM,IAAI,KAAK,CAAC,qCAAqC,CAAC,CAAC;YACzD,CAAC;YAED,OAAO,IAAI,CAAC,eAAe,CAAC,QAAQ,CAAC,CAAC;QACxC,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,uDAAuD,EAAE,KAAK,CAAC,CAAC;YAC7E,MAAM,KAAK,CAAC;QACd,CAAC;IACH,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,cAAc,CAAC,UAAkB;QACrC,MAAM,WAAW,GAAG,gBAAG,CAAC,oBAAoB,CAAC;QAC7C,IAAI,CAAC,WAAW;YAAE,MAAM,IAAI,KAAK,CAAC,qCAAqC,CAAC,CAAC;QACzE,OAAO,IAAI,CAAC,eAAe,CAAC,UAAU,EAAE,iBAAiB,EAAE,WAAW,CAAC,CAAC;IAC1E,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,eAAe,CAAC,UAAkB;QACtC,MAAM,WAAW,GAAG,gBAAG,CAAC,qBAAqB,CAAC;QAC9C,IAAI,CAAC,WAAW;YAAE,MAAM,IAAI,KAAK,CAAC,sCAAsC,CAAC,CAAC;QAC1E,OAAO,IAAI,CAAC,eAAe,CAAC,UAAU,EAAE,iBAAiB,EAAE,WAAW,CAAC,CAAC;IAC1E,CAAC;IAED;;OAEG;IACK,eAAe,CAAC,QAAa;QACnC,MAAM,QAAQ,GAAG,QAAQ,CAAC,QAAQ,IAAI,EAAE,CAAC;QACzC,MAAM,aAAa,GAAwB,EAAE,CAAC;QAE9C,QAAQ,CAAC,OAAO,CAAC,CAAC,MAAW,EAAE,EAAE;YAC/B,aAAa,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,MAAM,CAAC,WAAW,IAAI,MAAM,CAAC,eAAe,EAAE,IAAI,CAAC;QAClF,CAAC,CAAC,CAAC;QAEH,OAAO;YACL,aAAa;YACb,IAAI,EAAE,QAAQ,CAAC,IAAI;SACpB,CAAC;IACJ,CAAC;CACF,CAAA;AAzEY,4DAAwB;mCAAxB,wBAAwB;IADpC,IAAA,sBAAU,GAAE;;GACA,wBAAwB,CAyEpC","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\google\\document-processor.service.ts"],"sourcesContent":["import { DocumentProcessorServiceClient } from '@google-cloud/documentai';\nimport { inject, injectable } from 'inversify';\nimport { env } from '../../config/env.schema';\nimport { logger } from '../../utils/logger';\n\n@injectable()\nexport class DocumentProcessorService {\n  private client: DocumentProcessorServiceClient;\n\n  constructor() {\n    this.client = new DocumentProcessorServiceClient();\n  }\n\n  /**\n   * Processes a document (Invoice or Contract) using GCP Document AI\n   */\n  async processDocument(fileBuffer: Buffer, mimeType: string, processorId: string): Promise<any> {\n    const projectId = env.GOOGLE_CLOUD_PROJECT_ID;\n    const location = env.GOOGLE_CLOUD_LOCATION || 'europe-west1';\n\n    const name = `projects/${projectId}/locations/${location}/processors/${processorId}`;\n\n    const request = {\n      name,\n      rawDocument: {\n        content: fileBuffer,\n        mimeType,\n      },\n    };\n\n    try {\n      const [result] = await this.client.processDocument(request);\n      const { document } = result;\n\n      if (!document) {\n        throw new Error('Document AI returned empty document');\n      }\n\n      return this.extractEntities(document);\n    } catch (error) {\n      logger.error('[DocumentProcessorService] Error processing document:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Specifically handles invoice processing\n   */\n  async processInvoice(fileBuffer: Buffer): Promise<any> {\n    const processorId = env.INVOICE_PROCESSOR_ID;\n    if (!processorId) throw new Error('INVOICE_PROCESSOR_ID not configured');\n    return this.processDocument(fileBuffer, 'application/pdf', processorId);\n  }\n\n  /**\n   * Specifically handles contract processing\n   */\n  async processContract(fileBuffer: Buffer): Promise<any> {\n    const processorId = env.CONTRACT_PROCESSOR_ID;\n    if (!processorId) throw new Error('CONTRACT_PROCESSOR_ID not configured');\n    return this.processDocument(fileBuffer, 'application/pdf', processorId);\n  }\n\n  /**\n   * Extracts structured entities from the Document AI response\n   */\n  private extractEntities(document: any): any {\n    const entities = document.entities || [];\n    const extractedData: Record<string, any> = {};\n\n    entities.forEach((entity: any) => {\n      extractedData[entity.type] = entity.mentionText || entity.normalizedValue?.text;\n    });\n\n    return {\n      extractedData,\n      text: document.text,\n    };\n  }\n}\n"],"version":3}