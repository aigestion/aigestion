{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\email.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\email.service.ts"],"sourcesContent":["import nodemailer from 'nodemailer';\nimport { injectable } from 'inversify';\n\nimport { env } from '../config/env.schema';\nimport { logger } from '../utils/logger';\n\n/**\n * Interface for email options, matching the comprehensive version from utils.\n */\nexport interface EmailOptions {\n  to: string | string[];\n  subject: string;\n  text?: string;\n  html?: string;\n  attachments?: {\n    filename: string;\n    content?: string | Buffer;\n    path?: string;\n    contentType?: string;\n  }[];\n}\n\n@injectable()\nexport class EmailService {\n  private transporter: any;\n  private isConfigured = false;\n\n  constructor() {\n    this.initialize();\n  }\n\n  private initialize(): void {\n    try {\n      if (!env.EMAIL_HOST || !env.EMAIL_PORT) {\n        logger.warn('SMTP configuration incomplete. Email service disabled.');\n        return;\n      }\n\n      this.transporter = nodemailer.createTransport({\n        host: env.EMAIL_HOST,\n        port: env.EMAIL_PORT,\n        secure: env.EMAIL_PORT === 465,\n        auth: {\n          user: env.EMAIL_USERNAME,\n          pass: env.EMAIL_PASSWORD,\n        },\n        tls: {\n          rejectUnauthorized: false, // For local/sovereign mail servers\n        },\n      });\n      this.isConfigured = true;\n      logger.info('SMTP service correctly configured');\n    } catch (error) {\n      logger.error(error, 'Error initializing EmailService:');\n      this.isConfigured = false;\n    }\n  }\n\n  isReady(): boolean {\n    return this.isConfigured && this.transporter !== null;\n  }\n\n  /**\n   * Verify SMTP connection configuration\n   */\n  async verifyConnection(): Promise<boolean> {\n    if (!this.transporter) return false;\n    try {\n      await this.transporter.verify();\n      logger.info('‚úÖ SMTP connection verified');\n      return true;\n    } catch (error) {\n      logger.error(error, '‚ùå SMTP connection failed');\n      return false;\n    }\n    // No database connection handling here; skip shutdown of DB.\n    // If a DB connection is needed, integrate it with connectToDatabase.\n    // Placeholder for future DB cleanup.\n  }\n\n  /**\n   * Send an email\n   */\n  async sendEmail(options: EmailOptions): Promise<boolean> {\n    if (!this.isReady()) {\n      logger.error('Email service NOT ready');\n      return false;\n    }\n\n    try {\n      const info = await this.transporter.sendMail({\n        from: `\"${env.API_TITLE}\" <${env.EMAIL_FROM}>`,\n        to: Array.isArray(options.to) ? options.to.join(', ') : options.to,\n        subject: options.subject,\n        text: options.text,\n        html: options.html,\n        attachments: options.attachments,\n      });\n\n      logger.info(`üìß Email sent: ${info.messageId} to ${options.to}`);\n      return true;\n    } catch (error) {\n      logger.error(error, `Failed to send email to ${options.to}`);\n      return false;\n    }\n  }\n\n  /**\n   * Comprehensive transcription email generator (merged from utils)\n   */\n  async sendTranscriptionEmail(\n    to: string | string[],\n    videoTitle: string,\n    videoUrl: string,\n    transcript: string,\n    videoId: string,\n  ): Promise<boolean> {\n    const htmlContent = `\n      <!DOCTYPE html>\n      <html>\n      <head>\n        <meta charset=\"UTF-8\">\n        <style>\n          body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }\n          .header { background-color: #FF0000; color: white; padding: 20px; border-radius: 5px; margin-bottom: 20px; }\n          .header h1 { margin: 0; font-size: 24px; }\n          .video-info { background-color: #f5f5f5; padding: 15px; border-left: 4px solid #FF0000; margin-bottom: 20px; }\n          .video-info a { color: #FF0000; text-decoration: none; font-weight: bold; }\n          .transcript { background-color: #fff; padding: 20px; border: 1px solid #ddd; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word; }\n          .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; text-align: center; }\n          .thumbnail { max-width: 100%; height: auto; border-radius: 5px; margin: 15px 0; }\n        </style>\n      </head>\n      <body>\n        <div class=\"header\"><h1>üìπ Transcripci√≥n de YouTube</h1></div>\n        <div class=\"video-info\">\n          <h2>üì∫ ${videoTitle}</h2>\n          <p><strong>URL:</strong> <a href=\"${videoUrl}\" target=\"_blank\">${videoUrl}</a></p>\n          <p><strong>Fecha:</strong> ${new Date().toLocaleString('es-ES')}</p>\n          <img class=\"thumbnail\" src=\"https://img.youtube.com/vi/${videoId}/maxresdefault.jpg\" alt=\"Miniatura\">\n        </div>\n        <div class=\"transcript\">${transcript}</div>\n        <div class=\"footer\"><p>Generado por NEXUS V1 ‚Ä¢ ${new Date().getFullYear()}</p></div>\n      </body>\n      </html>\n    `;\n\n    return this.sendEmail({\n      to,\n      subject: `üìπ Transcripci√≥n: ${videoTitle}`,\n      html: htmlContent,\n    });\n  }\n}\n"],"version":3}