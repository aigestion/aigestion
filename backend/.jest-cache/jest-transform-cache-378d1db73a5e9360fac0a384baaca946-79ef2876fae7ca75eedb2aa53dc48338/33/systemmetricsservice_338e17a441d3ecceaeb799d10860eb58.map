{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\system-metrics.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\system-metrics.service.ts"],"sourcesContent":["import { exec } from 'child_process';\nimport { inject, injectable } from 'inversify';\nimport * as os from 'os';\nimport { promisify } from 'util';\n\nimport { TYPES } from '../types';\nimport { logger } from '../utils/logger';\nimport { CredentialManagerService } from './credential-manager.service';\n\nconst execAsync = promisify(exec);\n\nexport interface SystemMetrics {\n  cpu: number;\n  memory: number;\n  network: number;\n  disk: number;\n  uptime: number;\n  platform: NodeJS.Platform;\n  hostname: string;\n  timestamp: number;\n  dockerContainerCount?: number;\n  accountTier?: string;\n}\n\n@injectable()\nexport class SystemMetricsService {\n  private lastNetworkStats: { rx: number; tx: number; time: number } | null = null;\n\n  constructor(\n    @inject(TYPES.CredentialManagerService) private credentialManager: CredentialManagerService,\n  ) {}\n\n  /**\n   * Get all system metrics aggregated\n   */\n  async getSystemMetrics(): Promise<SystemMetrics> {\n    const [cpu, memory, network, disk, dockerCount, proStatus] = await Promise.all([\n      this.getCPUUsage(),\n      this.getMemoryUsage(),\n      this.getNetworkUsage(),\n      this.getDiskUsage(),\n      this.getDockerContainerCount(),\n      this.credentialManager.verifyProfessionalAccount(),\n    ]);\n\n    const accountTier = proStatus.status === 'valid' ? 'Professional' : 'Standard';\n\n    return {\n      cpu,\n      memory,\n      network,\n      disk,\n      dockerContainerCount: dockerCount,\n      accountTier,\n      uptime: os.uptime(),\n      platform: os.platform(),\n      hostname: os.hostname(),\n      timestamp: Date.now(),\n    };\n  }\n\n  /**\n   * Calculate CPU usage percentage\n   */\n  async getCPUUsage(): Promise<number> {\n    const cpus = os.cpus();\n    const usage =\n      cpus.reduce((acc, cpu) => {\n        const total = Object.values(cpu.times).reduce((a, b) => a + b, 0);\n        const idle = cpu.times.idle;\n        return acc + ((total - idle) / (total || 1)) * 100;\n      }, 0) / cpus.length;\n\n    return parseFloat(usage.toFixed(2));\n  }\n\n  /**\n   * Calculate Memory usage percentage\n   */\n  async getMemoryUsage(): Promise<number> {\n    const totalMem = os.totalmem();\n    const freeMem = os.freemem();\n    const usedMem = totalMem - freeMem;\n    return parseFloat(((usedMem / totalMem) * 100).toFixed(2));\n  }\n\n  /**\n   * Get aggregated Disk usage percentage (C: drive for Windows, root for others as fallback)\n   */\n  async getDiskUsage(): Promise<number> {\n    try {\n      if (os.platform() === 'win32') {\n        const { stdout } = await execAsync('wmic logicaldisk get size,freespace,caption');\n        const lines = stdout.trim().split('\\n').slice(1);\n        let total = 0;\n        let free = 0;\n\n        for (const line of lines) {\n          const parts = line.trim().split(/\\s+/);\n          if (parts.length >= 3 && parts[0].includes('C:')) {\n            free += parseInt(parts[1]);\n            total += parseInt(parts[2]);\n          }\n        }\n        return total > 0 ? parseFloat((((total - free) / total) * 100).toFixed(2)) : 0;\n      }\n      return 0; // Fallback for now or implement linux `df - h`\n    } catch (e) {\n      logger.error('Error getting disk usage', e);\n      return 0;\n    }\n  }\n\n  /**\n   * Get Network activity score (0-100) based on rx bytes\n   */\n  async getNetworkUsage(): Promise<number> {\n    let totalBytes = 0;\n\n    try {\n      if (os.platform() === 'win32') {\n        const { stdout } = await execAsync(\n          'powershell -Command \"Get-NetAdapterStatistics | Select-Object -ExpandProperty ReceivedBytes\"',\n        );\n        totalBytes = stdout.split('\\n').reduce((acc, val) => acc + (parseInt(val.trim()) || 0), 0);\n      } else {\n        // Fallback or Linux implementation\n        return 0;\n      }\n    } catch (e) {\n      return 0;\n    }\n\n    const now = Date.now();\n    if (this.lastNetworkStats) {\n      const elapsed = (now - this.lastNetworkStats.time) / 1000;\n      const delta = (totalBytes - this.lastNetworkStats.rx) / 1024 / 1024; // MB\n      this.lastNetworkStats = { rx: totalBytes, tx: 0, time: now };\n      return parseFloat(Math.max(0, Math.min(100, (delta / (elapsed || 1)) * 10)).toFixed(2));\n    }\n\n    this.lastNetworkStats = { rx: totalBytes, tx: 0, time: now };\n    return 0;\n  }\n\n  /**\n   * Get active Docker container count\n   */\n  async getDockerContainerCount(): Promise<number> {\n    try {\n      const { stdout } = await execAsync(\n        'docker ps -q | Measure-Object | Select-Object -ExpandProperty Count',\n      );\n      return parseInt(stdout.trim()) || 0;\n    } catch {\n      try {\n        const { stdout } = await execAsync('docker ps -q');\n        return stdout\n          .trim()\n          .split('\\n')\n          .filter(line => line).length;\n      } catch {\n        return 0;\n      }\n    }\n  }\n}\n"],"version":3}