{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\pinecone.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\pinecone.service.ts"],"sourcesContent":["import { Pinecone, PineconeRecord } from '@pinecone-database/pinecone';\nimport { injectable } from 'inversify';\nimport { env } from '../config/env.schema';\nimport { logger } from '../utils/logger';\nimport { vertexAIService } from './google/vertex-ai.service';\n\n@injectable()\nexport class PineconeService {\n  private client: any | null = null;\n  private indexName = 'aigestion-docs';\n\n  constructor() {\n    this.initialize();\n  }\n\n  private initialize() {\n    if (env.PINECONE_API_KEY) {\n      try {\n        this.client = new Pinecone({\n          apiKey: env.PINECONE_API_KEY,\n        });\n        logger.info('[PineconeService] Client initialized');\n      } catch (error) {\n        logger.error('[PineconeService] Failed to initialize client', error);\n      }\n    } else {\n      logger.warn('[PineconeService] PINECONE_API_KEY not set. Service disabled.');\n    }\n  }\n\n  /**\n   * Upserts document embeddings into Pinecone\n   */\n  async upsertDocument(id: string, text: string, metadata: any): Promise<void> {\n    await this.upsertDocBatch([{ id, text, metadata }]);\n  }\n\n  /**\n   * Upserts a batch of documents into Pinecone\n   */\n  async upsertDocBatch(\n    documents: { id: string; text: string; metadata: any }[],\n    namespace: string = 'default',\n  ): Promise<void> {\n    if (!this.client) {\n      logger.warn('[PineconeService] Client not initialized. Skipping batch upsert.');\n      return;\n    }\n\n    try {\n      const index = this.client.index(this.indexName);\n      const ns = index.namespace(namespace);\n\n      // Generate Embeddings in parallel\n      const records: any[] = await Promise.all(\n        documents.map(async doc => {\n          const embedding = await vertexAIService.generateEmbeddings(doc.text);\n          if (embedding.length === 0) {\n            throw new Error(`Failed to generate embeddings for document ${doc.id}`);\n          }\n          return {\n            id: doc.id,\n            values: embedding,\n            metadata: {\n              ...doc.metadata,\n              text: doc.text.substring(0, 3000), // Increased context length\n              timestamp: new Date().toISOString(),\n            },\n          } as any;\n        }),\n      );\n\n      if (records.length > 0) {\n        // Pinecone recommends batches of ~100\n        const batchSize = 100;\n        for (let i = 0; i < records.length; i += batchSize) {\n          const batch = records.slice(i, i + batchSize);\n          await ns.upsert(batch);\n        }\n        logger.info(\n          `[PineconeService] Successfully upserted ${records.length} documents into namespace: ${namespace}`,\n        );\n      }\n    } catch (error) {\n      logger.error('[PineconeService] Error in batch upsert to Pinecone:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Searches for similar documents\n   */\n  async search(\n    queryText: string,\n    topK: number = 5,\n    namespace: string = 'default',\n    filter?: object,\n  ): Promise<any[]> {\n    if (!this.client) {\n      logger.warn('[PineconeService] Client not initialized. Returning empty results.');\n      return [];\n    }\n\n    try {\n      const embedding = await vertexAIService.generateEmbeddings(queryText);\n      const index = this.client.index(this.indexName);\n      const ns = index.namespace(namespace);\n\n      const queryResponse = await ns.query({\n        vector: embedding,\n        topK,\n        filter,\n        includeMetadata: true,\n      });\n\n      return queryResponse.matches || [];\n    } catch (error) {\n      logger.error('[PineconeService] Error searching Pinecone:', error);\n      throw error;\n    }\n  }\n}\nexport const pineconeService = new PineconeService();\n"],"version":3}