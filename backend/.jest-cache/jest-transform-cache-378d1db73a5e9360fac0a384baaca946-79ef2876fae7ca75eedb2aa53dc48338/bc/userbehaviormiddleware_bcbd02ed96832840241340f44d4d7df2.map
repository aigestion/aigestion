{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\middleware\\user-behavior.middleware.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\middleware\\user-behavior.middleware.ts"],"sourcesContent":["import { NextFunction, Request, Response } from 'express';\nimport { Socket } from 'net';\nimport { UserBehaviorService } from '../services/user-behavior.service';\nimport { logger } from '../utils/logger';\n\ninterface BehaviorUser {\n  id: string;\n  email: string;\n  role: string;\n}\n\ninterface BehaviorRequest extends Request {\n  user?: BehaviorUser;\n  sessionId?: string;\n  file?: { size: number; mimetype: string; originalname: string } | any;\n  res?: Response;\n}\n\ninterface EventMetadata {\n  path: string;\n  method: string;\n  query: any;\n  timestamp: string;\n  [key: string]: any;\n}\n\n/**\n * Middleware for user behavior analysis\n */\nexport class UserBehaviorMiddleware {\n  private behaviorService: UserBehaviorService;\n\n  constructor() {\n    this.behaviorService = new UserBehaviorService();\n\n    // Start cleanup interval\n    setInterval(\n      () => {\n        this.behaviorService.cleanup();\n      },\n      60 * 60 * 1000,\n    ); // Every hour\n  }\n\n  /**\n   * Track user behavior events\n   */\n  public trackBehavior = (\n    eventType:\n      | 'login'\n      | 'logout'\n      | 'file_upload'\n      | 'api_call'\n      | 'page_view'\n      | 'error'\n      | 'permission_denied'\n      | 'data_access',\n  ) => {\n    return async (req: BehaviorRequest, res: Response, next: NextFunction) => {\n      try {\n        if (!req.user || !req.user.id) {\n          return next();\n        }\n\n        const event = {\n          userId: req.user.id,\n          eventType,\n          timestamp: new Date(),\n          ipAddress: this.getClientIP(req),\n          userAgent: req.get('User-Agent') || 'unknown',\n          sessionId: req.sessionId || this.generateSessionId(req),\n          metadata: this.extractMetadata(req, eventType),\n        };\n\n        await this.behaviorService.trackEvent(event);\n\n        // Add behavior headers\n        const profile = await this.behaviorService.getUserProfile(req.user.id);\n        if (profile) {\n          res.setHeader('X-Behavior-Risk-Score', profile.riskScore.toString());\n          res.setHeader('X-Behavior-Session-Id', event.sessionId);\n        }\n\n        next();\n      } catch (error) {\n        logger.error('Error tracking user behavior:', error);\n        next(); // Continue on error to avoid breaking functionality\n      }\n    };\n  };\n\n  /**\n   * Check user risk score and take action if needed\n   */\n  public checkRiskScore = async (req: BehaviorRequest, res: Response, next: NextFunction) => {\n    try {\n      if (!req.user || !req.user.id) {\n        return next();\n      }\n\n      const profile = await this.behaviorService.getUserProfile(req.user.id);\n      if (!profile) {\n        return next();\n      }\n\n      // Add risk score header\n      res.setHeader('X-Behavior-Risk-Score', profile.riskScore.toString());\n\n      // Take action based on risk score\n      if (profile.riskScore >= 80) {\n        logger.warn('High risk user detected', {\n          userId: req.user.id,\n          riskScore: profile.riskScore,\n          ipAddress: this.getClientIP(req),\n        });\n\n        // Require additional authentication\n        res.setHeader('X-Behavior-Action', 'additional-auth-required');\n\n        return res.status(403).json({\n          success: false,\n          error: 'Additional authentication required',\n          code: 'HIGH_RISK_USER',\n          data: {\n            riskScore: profile.riskScore,\n            reason: 'Unusual behavior detected',\n          },\n        });\n      } else if (profile.riskScore >= 60) {\n        logger.warn('Medium risk user detected', {\n          userId: req.user.id,\n          riskScore: profile.riskScore,\n        });\n\n        // Add warning headers\n        res.setHeader('X-Behavior-Action', 'monitor');\n        res.setHeader('X-Behavior-Warning', 'true');\n      }\n\n      next();\n    } catch (error) {\n      logger.error('Error checking risk score:', error);\n      next();\n    }\n  };\n\n  /**\n   * Monitor for suspicious patterns\n   */\n  public monitorSuspiciousPatterns = async (\n    req: BehaviorRequest,\n    res: Response,\n    next: NextFunction,\n  ) => {\n    try {\n      if (!req.user || !req.user.id) {\n        return next();\n      }\n\n      const profile = await this.behaviorService.getUserProfile(req.user.id);\n      if (!profile) {\n        return next();\n      }\n\n      // Check for rapid successive requests\n      const session = profile.currentSession;\n      const sessionDuration = Date.now() - session.startTime.getTime();\n      const requestsPerMinute = session.apiCalls / (sessionDuration / 60000);\n\n      if (requestsPerMinute > 100) {\n        logger.warn('High frequency requests detected', {\n          userId: req.user.id,\n          requestsPerMinute,\n          sessionDuration,\n        });\n\n        res.setHeader('X-Behavior-Pattern', 'high-frequency');\n\n        // Rate limit more aggressively\n        if (requestsPerMinute > 500) {\n          return res.status(429).json({\n            success: false,\n            error: 'Rate limit exceeded due to unusual activity',\n            code: 'BEHAVIOR_RATE_LIMIT',\n          });\n        }\n      }\n\n      // Check for error patterns\n      if (session.errors > 10 && session.apiCalls > 0) {\n        const errorRate = session.errors / session.apiCalls;\n        if (errorRate > 0.5) {\n          logger.warn('High error rate detected', {\n            userId: req.user.id,\n            errorRate,\n            errors: session.errors,\n            apiCalls: session.apiCalls,\n          });\n\n          res.setHeader('X-Behavior-Pattern', 'high-error-rate');\n        }\n      }\n\n      next();\n    } catch (error) {\n      logger.error('Error monitoring suspicious patterns:', error);\n      next();\n    }\n  };\n\n  /**\n   * Generate session ID\n   */\n  private generateSessionId(req: Request): string {\n    const ip = this.getClientIP(req);\n    const userAgent = req.get('User-Agent') || 'unknown';\n    const timestamp = Date.now();\n\n    return Buffer.from(`${ip}:${userAgent}:${timestamp}`).toString('base64').substring(0, 32);\n  }\n\n  /**\n   * Get client IP address\n   */\n  private getClientIP(req: BehaviorRequest): string {\n    const socket = (req.connection as any)?.socket as Socket | undefined;\n    return (\n      req.ip ||\n      req.connection.remoteAddress ||\n      req.socket.remoteAddress ||\n      socket?.remoteAddress ||\n      'unknown'\n    );\n  }\n\n  /**\n   * Extract metadata from request\n   */\n  private extractMetadata(req: BehaviorRequest, eventType: string): EventMetadata {\n    const metadata: EventMetadata = {\n      path: req.path,\n      method: req.method,\n      query: req.query,\n      timestamp: new Date().toISOString(),\n    };\n\n    // Add specific metadata based on event type\n    switch (eventType) {\n      case 'login':\n        metadata.loginMethod = req.body?.method || 'password';\n        metadata.success = req.body?.success || true;\n        break;\n\n      case 'file_upload':\n        if (req.file) {\n          metadata.fileSize = req.file.size;\n          metadata.fileType = req.file.mimetype;\n          metadata.fileName = req.file.originalname;\n        }\n        break;\n\n      case 'api_call':\n        metadata.endpoint = req.path;\n        metadata.responseTime = req.get('X-Response-Time');\n        metadata.statusCode = req.res?.statusCode;\n        break;\n\n      case 'error':\n        metadata.error = req.body?.error || 'Unknown error';\n        metadata.errorCode = req.body?.errorCode;\n        metadata.stack = req.body?.stack;\n        break;\n\n      case 'permission_denied':\n        metadata.resource = req.body?.resource || 'Unknown resource';\n        metadata.action = req.body?.action || 'Unknown action';\n        metadata.requiredPermission = req.body?.requiredPermission;\n        break;\n\n      case 'data_access':\n        metadata.resource =\n          req.body?.resource || (req.params as any)?.resource || (req.query as any)?.resource;\n        metadata.action = req.body?.action || req.method?.toLowerCase();\n        metadata.dataType = req.body?.dataType || 'unknown';\n        break;\n\n      case 'page_view':\n        metadata.referrer = req.get('Referer');\n        metadata.page = req.path;\n        metadata.duration = req.body?.duration;\n        break;\n    }\n\n    // Add user information\n    if (req.user) {\n      metadata.userId = req.user.id;\n      metadata.userEmail = req.user.email;\n      metadata.userRole = req.user.role;\n    }\n\n    return metadata;\n  }\n\n  /**\n   * Get behavior statistics\n   */\n  public getStats = async (_req: Request, res: Response) => {\n    try {\n      const stats = await this.behaviorService.getStats();\n\n      res.json({\n        success: true,\n        data: stats,\n      });\n    } catch (error) {\n      logger.error('Error getting behavior stats:', error);\n      res.status(500).json({\n        success: false,\n        error: 'Failed to get behavior statistics',\n      });\n    }\n  };\n\n  /**\n   * Get user behavior profile\n   */\n  public getUserProfile = async (req: BehaviorRequest, res: Response) => {\n    try {\n      const { userId } = req.params;\n      const userIdStr = Array.isArray(userId) ? userId[0] : userId;\n\n      if (!userIdStr) {\n        return res.status(400).json({\n          success: false,\n          error: 'userId is required',\n        });\n      }\n\n      const profile = await this.behaviorService.getUserProfile(userIdStr);\n\n      if (!profile) {\n        return res.status(404).json({\n          success: false,\n          error: 'User behavior profile not found',\n        });\n      }\n\n      res.json({\n        success: true,\n        data: profile,\n      });\n    } catch (error) {\n      logger.error('Error getting user profile:', error);\n      res.status(500).json({\n        success: false,\n        error: 'Failed to get user behavior profile',\n      });\n    }\n  };\n\n  /**\n   * Get user anomalies\n   */\n  public getUserAnomalies = async (req: BehaviorRequest, res: Response) => {\n    try {\n      const { userId } = req.params;\n      const limitParam = req.query.limit;\n      const limitStr = Array.isArray(limitParam) ? limitParam[0] : limitParam;\n      const limit = limitStr ? parseInt(limitStr as string) : 50;\n      const userIdStr = Array.isArray(userId) ? userId[0] : userId;\n\n      if (!userIdStr) {\n        return res.status(400).json({\n          success: false,\n          error: 'userId is required',\n        });\n      }\n\n      const anomalies = await this.behaviorService.getUserAnomalies(userIdStr, limit);\n\n      res.json({\n        success: true,\n        data: anomalies,\n      });\n    } catch (error) {\n      logger.error('Error getting user anomalies:', error);\n      res.status(500).json({\n        success: false,\n        error: 'Failed to get user anomalies',\n      });\n    }\n  };\n\n  /**\n   * Get recent anomalies\n   */\n  public getRecentAnomalies = async (req: Request, res: Response) => {\n    try {\n      const limitParam = req.query.limit;\n      const limitStr = Array.isArray(limitParam) ? limitParam[0] : limitParam;\n      const limit = limitStr ? parseInt(limitStr as string) : 100;\n      const anomalies = await this.behaviorService.getRecentAnomalies(limit);\n\n      res.json({\n        success: true,\n        data: anomalies,\n      });\n    } catch (error) {\n      logger.error('Error getting recent anomalies:', error);\n      res.status(500).json({\n        success: false,\n        error: 'Failed to get recent anomalies',\n      });\n    }\n  };\n\n  /**\n   * Resolve anomaly\n   */\n  public resolveAnomaly = async (req: Request, res: Response) => {\n    try {\n      const { anomalyId } = req.params;\n      const anomalyIdStr = Array.isArray(anomalyId) ? anomalyId[0] : anomalyId;\n\n      if (!anomalyIdStr) {\n        return res.status(400).json({\n          success: false,\n          error: 'anomalyId is required',\n        });\n      }\n\n      const success = await this.behaviorService.resolveAnomaly(anomalyIdStr);\n\n      res.json({\n        success: true,\n        data: { resolved: success },\n      });\n    } catch (error) {\n      logger.error('Error resolving anomaly:', error);\n      res.status(500).json({\n        success: false,\n        error: 'Failed to resolve anomaly',\n      });\n    }\n  };\n}\n\n// Export singleton instance\nexport const userBehaviorMiddleware = new UserBehaviorMiddleware();\n\n// Export convenience methods\nexport const trackBehavior = userBehaviorMiddleware.trackBehavior;\nexport const checkRiskScore = userBehaviorMiddleware.checkRiskScore;\nexport const monitorSuspiciousPatterns = userBehaviorMiddleware.monitorSuspiciousPatterns;\n"],"version":3}