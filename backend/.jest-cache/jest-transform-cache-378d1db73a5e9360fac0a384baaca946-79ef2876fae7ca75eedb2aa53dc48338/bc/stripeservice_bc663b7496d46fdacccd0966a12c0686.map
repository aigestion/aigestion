{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\stripe.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\stripe.service.ts"],"sourcesContent":["import type Stripe from 'stripe';\nimport { injectable } from 'inversify';\n\nimport { env } from '../config/env.schema';\nimport { CircuitBreakerFactory } from '../infrastructure/resilience/CircuitBreakerFactory';\nimport { logger } from '../utils/logger';\n\n@injectable()\nexport class StripeService {\n  private _stripe: Stripe | undefined;\n\n  // Circuit Breakers\n  private createCustomerBreaker: any;\n  private createSessionBreaker: any;\n  private createPortalBreaker: any;\n\n  private get stripe(): Stripe {\n    if (!this._stripe) {\n      if (!env.STRIPE_SECRET_KEY) {\n        logger.warn('Stripe Secret Key is missing. StripeService will not function correctly.');\n      }\n      // Lazy load the SDK\n      const StripeClass = require('stripe');\n      this._stripe = new StripeClass(env.STRIPE_SECRET_KEY || '', {\n        apiVersion: '2022-11-15', // Use a fixed API version\n        typescript: true,\n      });\n    }\n    return this._stripe as Stripe;\n  }\n\n  constructor() {\n    // Initialize Circuit Breakers - Note: These lambdas will access 'this.stripe' on execution, triggering lazy load of SDK.\n    this.createCustomerBreaker = CircuitBreakerFactory.create(\n      (email: string, name: string) => this.stripe.customers.create({ email, name }),\n      { name: 'Stripe.createCustomer' },\n    );\n\n    this.createSessionBreaker = CircuitBreakerFactory.create(\n      (customerId: string, priceId: string, successUrl: string, cancelUrl: string) =>\n        this.stripe.checkout.sessions.create({\n          customer: customerId,\n          payment_method_types: ['card'],\n          line_items: [{ price: priceId, quantity: 1 }],\n          mode: 'subscription',\n          success_url: successUrl,\n          cancel_url: cancelUrl,\n          automatic_tax: { enabled: true },\n          allow_promotion_codes: true,\n          customer_update: {\n            address: 'auto',\n          },\n        }),\n      { name: 'Stripe.createSubscriptionCheckoutSession' },\n    );\n\n    this.createPortalBreaker = CircuitBreakerFactory.create(\n      (customerId: string, returnUrl: string) =>\n        this.stripe.billingPortal.sessions.create({ customer: customerId, return_url: returnUrl }),\n      { name: 'Stripe.createPortalSession' },\n    );\n  }\n\n  /**\n   * Create a new Stripe customer\n   */\n  async createCustomer(email: string, name: string): Promise<Stripe.Customer> {\n    try {\n      const customer = await this.createCustomerBreaker.fire(email, name);\n      logger.info(`Stripe customer created: ${customer.id}`);\n      return customer;\n    } catch (error) {\n      logger.error(error, 'Error creating Stripe customer');\n      throw error;\n    }\n  }\n\n  /**\n   * Create a checkout session for a subscription\n   */\n  async createSubscriptionCheckoutSession(\n    customerId: string,\n    priceId: string,\n    successUrl: string,\n    cancelUrl: string,\n  ): Promise<Stripe.Checkout.Session> {\n    try {\n      const session = await this.createSessionBreaker.fire(\n        customerId,\n        priceId,\n        successUrl,\n        cancelUrl,\n      );\n      return session;\n    } catch (error) {\n      logger.error(error, 'Error creating checkout session');\n      throw error;\n    }\n  }\n\n  /**\n   * Create a customer portal session\n   */\n  async createPortalSession(\n    customerId: string,\n    returnUrl: string,\n  ): Promise<Stripe.BillingPortal.Session> {\n    return this.createPortalBreaker.fire(customerId, returnUrl);\n  }\n\n  /**\n   * Construct and verify a webhook event\n   */\n  constructEvent(payload: string | Buffer, signature: string): Stripe.Event {\n    if (!env.STRIPE_WEBHOOK_SECRET) {\n      throw new Error('Stripe Webhook Secret is missing');\n    }\n    return this.stripe.webhooks.constructEvent(payload, signature, env.STRIPE_WEBHOOK_SECRET);\n  }\n\n  /**\n   * Retrieve a subscription by ID\n   */\n  async getSubscription(subscriptionId: string): Promise<Stripe.Subscription> {\n    return this.stripe.subscriptions.retrieve(subscriptionId);\n  }\n\n  /**\n   * Cancel a subscription\n   */\n  async cancelSubscription(subscriptionId: string): Promise<Stripe.Subscription> {\n    return this.stripe.subscriptions.cancel(subscriptionId);\n  }\n\n  /**\n   * Report usage for metered billing\n   * Uses the Usage Records API (Stripe)\n   */\n  async reportUsage(subscriptionItemId: string, quantity: number): Promise<Stripe.UsageRecord> {\n    try {\n      const usageRecord = await this.stripe.subscriptionItems.createUsageRecord(\n        subscriptionItemId,\n        {\n          quantity,\n          timestamp: Math.floor(Date.now() / 1000),\n          action: 'increment',\n        },\n      );\n      logger.info(`Stripe usage reported: ${quantity} units for ${subscriptionItemId}`);\n      return usageRecord;\n    } catch (error) {\n      logger.error(error, `Error reporting usage to Stripe for ${subscriptionItemId}`);\n      throw error;\n    }\n  }\n}\n"],"version":3}