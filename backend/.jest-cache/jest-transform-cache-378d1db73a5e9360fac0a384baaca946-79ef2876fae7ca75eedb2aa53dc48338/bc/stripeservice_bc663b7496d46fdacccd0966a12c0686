cc9cbe3191cfc5fd22c4389c7f763909
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.StripeService = void 0;
const inversify_1 = require("inversify");
const env_schema_1 = require("../config/env.schema");
const CircuitBreakerFactory_1 = require("../infrastructure/resilience/CircuitBreakerFactory");
const logger_1 = require("../utils/logger");
let StripeService = class StripeService {
    _stripe;
    // Circuit Breakers
    createCustomerBreaker;
    createSessionBreaker;
    createPortalBreaker;
    get stripe() {
        if (!this._stripe) {
            if (!env_schema_1.env.STRIPE_SECRET_KEY) {
                logger_1.logger.warn('Stripe Secret Key is missing. StripeService will not function correctly.');
            }
            // Lazy load the SDK
            const StripeClass = require('stripe');
            this._stripe = new StripeClass(env_schema_1.env.STRIPE_SECRET_KEY || '', {
                apiVersion: '2022-11-15', // Use a fixed API version
                typescript: true,
            });
        }
        return this._stripe;
    }
    constructor() {
        // Initialize Circuit Breakers - Note: These lambdas will access 'this.stripe' on execution, triggering lazy load of SDK.
        this.createCustomerBreaker = CircuitBreakerFactory_1.CircuitBreakerFactory.create((email, name) => this.stripe.customers.create({ email, name }), { name: 'Stripe.createCustomer' });
        this.createSessionBreaker = CircuitBreakerFactory_1.CircuitBreakerFactory.create((customerId, priceId, successUrl, cancelUrl) => this.stripe.checkout.sessions.create({
            customer: customerId,
            payment_method_types: ['card'],
            line_items: [{ price: priceId, quantity: 1 }],
            mode: 'subscription',
            success_url: successUrl,
            cancel_url: cancelUrl,
            automatic_tax: { enabled: true },
            allow_promotion_codes: true,
            customer_update: {
                address: 'auto',
            },
        }), { name: 'Stripe.createSubscriptionCheckoutSession' });
        this.createPortalBreaker = CircuitBreakerFactory_1.CircuitBreakerFactory.create((customerId, returnUrl) => this.stripe.billingPortal.sessions.create({ customer: customerId, return_url: returnUrl }), { name: 'Stripe.createPortalSession' });
    }
    /**
     * Create a new Stripe customer
     */
    async createCustomer(email, name) {
        try {
            const customer = await this.createCustomerBreaker.fire(email, name);
            logger_1.logger.info(`Stripe customer created: ${customer.id}`);
            return customer;
        }
        catch (error) {
            logger_1.logger.error(error, 'Error creating Stripe customer');
            throw error;
        }
    }
    /**
     * Create a checkout session for a subscription
     */
    async createSubscriptionCheckoutSession(customerId, priceId, successUrl, cancelUrl) {
        try {
            const session = await this.createSessionBreaker.fire(customerId, priceId, successUrl, cancelUrl);
            return session;
        }
        catch (error) {
            logger_1.logger.error(error, 'Error creating checkout session');
            throw error;
        }
    }
    /**
     * Create a customer portal session
     */
    async createPortalSession(customerId, returnUrl) {
        return this.createPortalBreaker.fire(customerId, returnUrl);
    }
    /**
     * Construct and verify a webhook event
     */
    constructEvent(payload, signature) {
        if (!env_schema_1.env.STRIPE_WEBHOOK_SECRET) {
            throw new Error('Stripe Webhook Secret is missing');
        }
        return this.stripe.webhooks.constructEvent(payload, signature, env_schema_1.env.STRIPE_WEBHOOK_SECRET);
    }
    /**
     * Retrieve a subscription by ID
     */
    async getSubscription(subscriptionId) {
        return this.stripe.subscriptions.retrieve(subscriptionId);
    }
    /**
     * Cancel a subscription
     */
    async cancelSubscription(subscriptionId) {
        return this.stripe.subscriptions.cancel(subscriptionId);
    }
    /**
     * Report usage for metered billing
     * Uses the Usage Records API (Stripe)
     */
    async reportUsage(subscriptionItemId, quantity) {
        try {
            const usageRecord = await this.stripe.subscriptionItems.createUsageRecord(subscriptionItemId, {
                quantity,
                timestamp: Math.floor(Date.now() / 1000),
                action: 'increment',
            });
            logger_1.logger.info(`Stripe usage reported: ${quantity} units for ${subscriptionItemId}`);
            return usageRecord;
        }
        catch (error) {
            logger_1.logger.error(error, `Error reporting usage to Stripe for ${subscriptionItemId}`);
            throw error;
        }
    }
};
exports.StripeService = StripeService;
exports.StripeService = StripeService = __decorate([
    (0, inversify_1.injectable)(),
    __metadata("design:paramtypes", [])
], StripeService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxzZXJ2aWNlc1xcc3RyaXBlLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBQ0EseUNBQXVDO0FBRXZDLHFEQUEyQztBQUMzQyw4RkFBMkY7QUFDM0YsNENBQXlDO0FBR2xDLElBQU0sYUFBYSxHQUFuQixNQUFNLGFBQWE7SUFDaEIsT0FBTyxDQUFxQjtJQUVwQyxtQkFBbUI7SUFDWCxxQkFBcUIsQ0FBTTtJQUMzQixvQkFBb0IsQ0FBTTtJQUMxQixtQkFBbUIsQ0FBTTtJQUVqQyxJQUFZLE1BQU07UUFDaEIsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNsQixJQUFJLENBQUMsZ0JBQUcsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO2dCQUMzQixlQUFNLENBQUMsSUFBSSxDQUFDLDBFQUEwRSxDQUFDLENBQUM7WUFDMUYsQ0FBQztZQUNELG9CQUFvQjtZQUNwQixNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDdEMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLFdBQVcsQ0FBQyxnQkFBRyxDQUFDLGlCQUFpQixJQUFJLEVBQUUsRUFBRTtnQkFDMUQsVUFBVSxFQUFFLFlBQVksRUFBRSwwQkFBMEI7Z0JBQ3BELFVBQVUsRUFBRSxJQUFJO2FBQ2pCLENBQUMsQ0FBQztRQUNMLENBQUM7UUFDRCxPQUFPLElBQUksQ0FBQyxPQUFpQixDQUFDO0lBQ2hDLENBQUM7SUFFRDtRQUNFLHlIQUF5SDtRQUN6SCxJQUFJLENBQUMscUJBQXFCLEdBQUcsNkNBQXFCLENBQUMsTUFBTSxDQUN2RCxDQUFDLEtBQWEsRUFBRSxJQUFZLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUM5RSxFQUFFLElBQUksRUFBRSx1QkFBdUIsRUFBRSxDQUNsQyxD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YW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxzZXJ2aWNlc1xcc3RyaXBlLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgU3RyaXBlIGZyb20gJ3N0cmlwZSc7XG5pbXBvcnQgeyBpbmplY3RhYmxlIH0gZnJvbSAnaW52ZXJzaWZ5JztcblxuaW1wb3J0IHsgZW52IH0gZnJvbSAnLi4vY29uZmlnL2Vudi5zY2hlbWEnO1xuaW1wb3J0IHsgQ2lyY3VpdEJyZWFrZXJGYWN0b3J5IH0gZnJvbSAnLi4vaW5mcmFzdHJ1Y3R1cmUvcmVzaWxpZW5jZS9DaXJjdWl0QnJlYWtlckZhY3RvcnknO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi4vdXRpbHMvbG9nZ2VyJztcblxuQGluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFN0cmlwZVNlcnZpY2Uge1xuICBwcml2YXRlIF9zdHJpcGU6IFN0cmlwZSB8IHVuZGVmaW5lZDtcblxuICAvLyBDaXJjdWl0IEJyZWFrZXJzXG4gIHByaXZhdGUgY3JlYXRlQ3VzdG9tZXJCcmVha2VyOiBhbnk7XG4gIHByaXZhdGUgY3JlYXRlU2Vzc2lvbkJyZWFrZXI6IGFueTtcbiAgcHJpdmF0ZSBjcmVhdGVQb3J0YWxCcmVha2VyOiBhbnk7XG5cbiAgcHJpdmF0ZSBnZXQgc3RyaXBlKCk6IFN0cmlwZSB7XG4gICAgaWYgKCF0aGlzLl9zdHJpcGUpIHtcbiAgICAgIGlmICghZW52LlNUUklQRV9TRUNSRVRfS0VZKSB7XG4gICAgICAgIGxvZ2dlci53YXJuKCdTdHJpcGUgU2VjcmV0IEtleSBpcyBtaXNzaW5nLiBTdHJpcGVTZXJ2aWNlIHdpbGwgbm90IGZ1bmN0aW9uIGNvcnJlY3RseS4nKTtcbiAgICAgIH1cbiAgICAgIC8vIExhenkgbG9hZCB0aGUgU0RLXG4gICAgICBjb25zdCBTdHJpcGVDbGFzcyA9IHJlcXVpcmUoJ3N0cmlwZScpO1xuICAgICAgdGhpcy5fc3RyaXBlID0gbmV3IFN0cmlwZUNsYXNzKGVudi5TVFJJUEVfU0VDUkVUX0tFWSB8fCAnJywge1xuICAgICAgICBhcGlWZXJzaW9uOiAnMjAyMi0xMS0xNScsIC8vIFVzZSBhIGZpeGVkIEFQSSB2ZXJzaW9uXG4gICAgICAgIHR5cGVzY3JpcHQ6IHRydWUsXG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX3N0cmlwZSBhcyBTdHJpcGU7XG4gIH1cblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICAvLyBJbml0aWFsaXplIENpcmN1aXQgQnJlYWtlcnMgLSBOb3RlOiBUaGVzZSBsYW1iZGFzIHdpbGwgYWNjZXNzICd0aGlzLnN0cmlwZScgb24gZXhlY3V0aW9uLCB0cmlnZ2VyaW5nIGxhenkgbG9hZCBvZiBTREsuXG4gICAgdGhpcy5jcmVhdGVDdXN0b21lckJyZWFrZXIgPSBDaXJjdWl0QnJlYWtlckZhY3RvcnkuY3JlYXRlKFxuICAgICAgKGVtYWlsOiBzdHJpbmcsIG5hbWU6IHN0cmluZykgPT4gdGhpcy5zdHJpcGUuY3VzdG9tZXJzLmNyZWF0ZSh7IGVtYWlsLCBuYW1lIH0pLFxuICAgICAgeyBuYW1lOiAnU3RyaXBlLmNyZWF0ZUN1c3RvbWVyJyB9LFxuICAgICk7XG5cbiAgICB0aGlzLmNyZWF0ZVNlc3Npb25CcmVha2VyID0gQ2lyY3VpdEJyZWFrZXJGYWN0b3J5LmNyZWF0ZShcbiAgICAgIChjdXN0b21lcklkOiBzdHJpbmcsIHByaWNlSWQ6IHN0cmluZywgc3VjY2Vzc1VybDogc3RyaW5nLCBjYW5jZWxVcmw6IHN0cmluZykgPT5cbiAgICAgICAgdGhpcy5zdHJpcGUuY2hlY2tvdXQuc2Vzc2lvbnMuY3JlYXRlKHtcbiAgICAgICAgICBjdXN0b21lcjogY3VzdG9tZXJJZCxcbiAgICAgICAgICBwYXltZW50X21ldGhvZF90eXBlczogWydjYXJkJ10sXG4gICAgICAgICAgbGluZV9pdGVtczogW3sgcHJpY2U6IHByaWNlSWQsIHF1YW50aXR5OiAxIH1dLFxuICAgICAgICAgIG1vZGU6ICdzdWJzY3JpcHRpb24nLFxuICAgICAgICAgIHN1Y2Nlc3NfdXJsOiBzdWNjZXNzVXJsLFxuICAgICAgICAgIGNhbmNlbF91cmw6IGNhbmNlbFVybCxcbiAgICAgICAgICBhdXRvbWF0aWNfdGF4OiB7IGVuYWJsZWQ6IHRydWUgfSxcbiAgICAgICAgICBhbGxvd19wcm9tb3Rpb25fY29kZXM6IHRydWUsXG4gICAgICAgICAgY3VzdG9tZXJfdXBkYXRlOiB7XG4gICAgICAgICAgICBhZGRyZXNzOiAnYXV0bycsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSksXG4gICAgICB7IG5hbWU6ICdTdHJpcGUuY3JlYXRlU3Vic2NyaXB0aW9uQ2hlY2tvdXRTZXNzaW9uJyB9LFxuICAgICk7XG5cbiAgICB0aGlzLmNyZWF0ZVBvcnRhbEJyZWFrZXIgPSBDaXJjdWl0QnJlYWtlckZhY3RvcnkuY3JlYXRlKFxuICAgICAgKGN1c3RvbWVySWQ6IHN0cmluZywgcmV0dXJuVXJsOiBzdHJpbmcpID0+XG4gICAgICAgIHRoaXMuc3RyaXBlLmJpbGxpbmdQb3J0YWwuc2Vzc2lvbnMuY3JlYXRlKHsgY3VzdG9tZXI6IGN1c3RvbWVySWQsIHJldHVybl91cmw6IHJldHVyblVybCB9KSxcbiAgICAgIHsgbmFtZTogJ1N0cmlwZS5jcmVhdGVQb3J0YWxTZXNzaW9uJyB9LFxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIGEgbmV3IFN0cmlwZSBjdXN0b21lclxuICAgKi9cbiAgYXN5bmMgY3JlYXRlQ3VzdG9tZXIoZW1haWw6IHN0cmluZywgbmFtZTogc3RyaW5nKTogUHJvbWlzZTxTdHJpcGUuQ3VzdG9tZXI+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgY3VzdG9tZXIgPSBhd2FpdCB0aGlzLmNyZWF0ZUN1c3RvbWVyQnJlYWtlci5maXJlKGVtYWlsLCBuYW1lKTtcbiAgICAgIGxvZ2dlci5pbmZvKGBTdHJpcGUgY3VzdG9tZXIgY3JlYXRlZDogJHtjdXN0b21lci5pZH1gKTtcbiAgICAgIHJldHVybiBjdXN0b21lcjtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKGVycm9yLCAnRXJyb3IgY3JlYXRpbmcgU3RyaXBlIGN1c3RvbWVyJyk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIGEgY2hlY2tvdXQgc2Vzc2lvbiBmb3IgYSBzdWJzY3JpcHRpb25cbiAgICovXG4gIGFzeW5jIGNyZWF0ZVN1YnNjcmlwdGlvbkNoZWNrb3V0U2Vzc2lvbihcbiAgICBjdXN0b21lcklkOiBzdHJpbmcsXG4gICAgcHJpY2VJZDogc3RyaW5nLFxuICAgIHN1Y2Nlc3NVcmw6IHN0cmluZyxcbiAgICBjYW5jZWxVcmw6IHN0cmluZyxcbiAgKTogUHJvbWlzZTxTdHJpcGUuQ2hlY2tvdXQuU2Vzc2lvbj4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBzZXNzaW9uID0gYXdhaXQgdGhpcy5jcmVhdGVTZXNzaW9uQnJlYWtlci5maXJlKFxuICAgICAgICBjdXN0b21lcklkLFxuICAgICAgICBwcmljZUlkLFxuICAgICAgICBzdWNjZXNzVXJsLFxuICAgICAgICBjYW5jZWxVcmwsXG4gICAgICApO1xuICAgICAgcmV0dXJuIHNlc3Npb247XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcihlcnJvciwgJ0Vycm9yIGNyZWF0aW5nIGNoZWNrb3V0IHNlc3Npb24nKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSBjdXN0b21lciBwb3J0YWwgc2Vzc2lvblxuICAgKi9cbiAgYXN5bmMgY3JlYXRlUG9ydGFsU2Vzc2lvbihcbiAgICBjdXN0b21lcklkOiBzdHJpbmcsXG4gICAgcmV0dXJuVXJsOiBzdHJpbmcsXG4gICk6IFByb21pc2U8U3RyaXBlLkJpbGxpbmdQb3J0YWwuU2Vzc2lvbj4ge1xuICAgIHJldHVybiB0aGlzLmNyZWF0ZVBvcnRhbEJyZWFrZXIuZmlyZShjdXN0b21lcklkLCByZXR1cm5VcmwpO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbnN0cnVjdCBhbmQgdmVyaWZ5IGEgd2ViaG9vayBldmVudFxuICAgKi9cbiAgY29uc3RydWN0RXZlbnQocGF5bG9hZDogc3RyaW5nIHwgQnVmZmVyLCBzaWduYXR1cmU6IHN0cmluZyk6IFN0cmlwZS5FdmVudCB7XG4gICAgaWYgKCFlbnYuU1RSSVBFX1dFQkhPT0tfU0VDUkVUKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1N0cmlwZSBXZWJob29rIFNlY3JldCBpcyBtaXNzaW5nJyk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnN0cmlwZS53ZWJob29rcy5jb25zdHJ1Y3RFdmVudChwYXlsb2FkLCBzaWduYXR1cmUsIGVudi5TVFJJUEVfV0VCSE9PS19TRUNSRVQpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHJpZXZlIGEgc3Vic2NyaXB0aW9uIGJ5IElEXG4gICAqL1xuICBhc3luYyBnZXRTdWJzY3JpcHRpb24oc3Vic2NyaXB0aW9uSWQ6IHN0cmluZyk6IFByb21pc2U8U3RyaXBlLlN1YnNjcmlwdGlvbj4ge1xuICAgIHJldHVybiB0aGlzLnN0cmlwZS5zdWJzY3JpcHRpb25zLnJldHJpZXZlKHN1YnNjcmlwdGlvbklkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDYW5jZWwgYSBzdWJzY3JpcHRpb25cbiAgICovXG4gIGFzeW5jIGNhbmNlbFN1YnNjcmlwdGlvbihzdWJzY3JpcHRpb25JZDogc3RyaW5nKTogUHJvbWlzZTxTdHJpcGUuU3Vic2NyaXB0aW9uPiB7XG4gICAgcmV0dXJuIHRoaXMuc3RyaXBlLnN1YnNjcmlwdGlvbnMuY2FuY2VsKHN1YnNjcmlwdGlvbklkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXBvcnQgdXNhZ2UgZm9yIG1ldGVyZWQgYmlsbGluZ1xuICAgKiBVc2VzIHRoZSBVc2FnZSBSZWNvcmRzIEFQSSAoU3RyaXBlKVxuICAgKi9cbiAgYXN5bmMgcmVwb3J0VXNhZ2Uoc3Vic2NyaXB0aW9uSXRlbUlkOiBzdHJpbmcsIHF1YW50aXR5OiBudW1iZXIpOiBQcm9taXNlPFN0cmlwZS5Vc2FnZVJlY29yZD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB1c2FnZVJlY29yZCA9IGF3YWl0IHRoaXMuc3RyaXBlLnN1YnNjcmlwdGlvbkl0ZW1zLmNyZWF0ZVVzYWdlUmVjb3JkKFxuICAgICAgICBzdWJzY3JpcHRpb25JdGVtSWQsXG4gICAgICAgIHtcbiAgICAgICAgICBxdWFudGl0eSxcbiAgICAgICAgICB0aW1lc3RhbXA6IE1hdGguZmxvb3IoRGF0ZS5ub3coKSAvIDEwMDApLFxuICAgICAgICAgIGFjdGlvbjogJ2luY3JlbWVudCcsXG4gICAgICAgIH0sXG4gICAgICApO1xuICAgICAgbG9nZ2VyLmluZm8oYFN0cmlwZSB1c2FnZSByZXBvcnRlZDogJHtxdWFudGl0eX0gdW5pdHMgZm9yICR7c3Vic2NyaXB0aW9uSXRlbUlkfWApO1xuICAgICAgcmV0dXJuIHVzYWdlUmVjb3JkO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoZXJyb3IsIGBFcnJvciByZXBvcnRpbmcgdXNhZ2UgdG8gU3RyaXBlIGZvciAke3N1YnNjcmlwdGlvbkl0ZW1JZH1gKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxufVxuIl0sInZlcnNpb24iOjN9