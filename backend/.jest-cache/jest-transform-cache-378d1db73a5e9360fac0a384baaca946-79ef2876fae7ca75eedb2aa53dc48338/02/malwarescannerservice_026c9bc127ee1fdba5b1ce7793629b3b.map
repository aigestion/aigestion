{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\malware-scanner.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\malware-scanner.service.ts"],"sourcesContent":["import axios from 'axios';\nimport { exec } from 'child_process';\nimport crypto from 'crypto';\nimport fs from 'fs/promises';\nimport { injectable } from 'inversify';\nimport path from 'path';\nimport { promisify } from 'util';\nimport { logger } from '../utils/logger';\nimport { malwareScannerConfig } from '../config/malware-scanner.config';\n\nconst execAsync = promisify(exec);\n\ninterface ScanResult {\n  file: string;\n  hash: string;\n  size: number;\n  mimeType: string;\n  isInfected: boolean;\n  threats: string[];\n  scanTime: number;\n  engine: string;\n  timestamp: Date;\n}\n\ninterface QuarantineInfo {\n  originalPath: string;\n  quarantinePath: string;\n  hash: string;\n  threat: string;\n  quarantinedAt: Date;\n  userId?: string;\n}\n\n@injectable()\nexport class MalwareScannerService {\n  private readonly quarantineDir = malwareScannerConfig.quarantineDir;\n  private readonly scanCache = new Map<string, ScanResult>();\n  private readonly cacheTimeout = malwareScannerConfig.cacheTimeout;\n\n  private isClamAVAvailable = false;\n  private isYARAAvailable = false;\n\n  constructor() {\n    this.initializeQuarantine();\n    this.checkEngines();\n  }\n\n  private async checkEngines() {\n    try {\n      await execAsync('clamscan --version');\n      this.isClamAVAvailable = true;\n      logger.info('ClamAV engine detected and ready');\n    } catch (error) {\n      logger.warn('ClamAV engine not found, ClamAV scanning will be skipped');\n    }\n\n    try {\n      await execAsync('yara --version');\n      this.isYARAAvailable = true;\n      logger.info('YARA engine detected and ready');\n    } catch (error) {\n      logger.warn('YARA engine not found, YARA scanning will be skipped');\n    }\n  }\n\n  private async initializeQuarantine() {\n    try {\n      await fs.mkdir(this.quarantineDir, { recursive: true });\n      logger.info('Malware scanner quarantine directory initialized');\n    } catch (error) {\n      logger.error('Failed to initialize quarantine directory:', error);\n    }\n  }\n\n  public async scanFile(filePath: string, userId?: string): Promise<ScanResult> {\n    const startTime = Date.now();\n\n    try {\n      // Check file exists\n      const stats = await fs.stat(filePath);\n      const fileBuffer = await fs.readFile(filePath);\n      const hash = this.calculateHash(fileBuffer);\n\n      // Check cache first\n      const cached = this.scanCache.get(hash);\n      if (cached && Date.now() - cached.timestamp.getTime() < this.cacheTimeout) {\n        logger.info('Using cached scan result', { file: filePath, hash });\n        return cached;\n      }\n\n      // Determine file type\n      const mimeType = await this.detectMimeType(fileBuffer);\n\n      // Scan with multiple engines\n      const scanResults = await Promise.allSettled([\n        this.scanWithClamAV(filePath),\n        this.scanWithYARA(filePath),\n        this.scanWithCustomRules(fileBuffer, mimeType),\n        this.scanWithVirusTotal(hash),\n      ]);\n\n      // Aggregate results\n      const threats: string[] = [];\n      let isInfected = false;\n\n      scanResults.forEach((result, index) => {\n        if (result.status === 'fulfilled') {\n          if (result.value.isInfected) {\n            isInfected = true;\n            threats.push(...result.value.threats);\n          }\n          logger.debug(`Scan engine ${index} result:`, result.value);\n        } else {\n          logger.warn(`Scan engine ${index} failed:`, result.reason);\n        }\n      });\n\n      const scanResult: ScanResult = {\n        file: filePath,\n        hash,\n        size: stats.size,\n        mimeType,\n        isInfected,\n        threats: [...new Set(threats)], // Remove duplicates\n        scanTime: Date.now() - startTime,\n        engine: 'multi-engine',\n        timestamp: new Date(),\n      };\n\n      // Cache result\n      this.scanCache.set(hash, scanResult);\n\n      // Quarantine if infected\n      if (isInfected) {\n        await this.quarantineFile(filePath, scanResult, userId);\n        logger.warn('Malware detected and quarantined', {\n          file: filePath,\n          hash,\n          threats: scanResult.threats,\n          userId,\n        });\n      } else {\n        logger.info('File scan completed - clean', {\n          file: filePath,\n          hash,\n          scanTime: scanResult.scanTime,\n        });\n      }\n\n      return scanResult;\n    } catch (error) {\n      logger.error('Error scanning file:', { filePath, error });\n      throw new Error(`Failed to scan file: ${error}`);\n    }\n  }\n\n  private async scanWithClamAV(\n    filePath: string,\n  ): Promise<{ isInfected: boolean; threats: string[] }> {\n    if (!this.isClamAVAvailable) {\n      return { isInfected: false, threats: [] };\n    }\n    try {\n      const { stdout } = await execAsync(`clamscan --no-summary \"${filePath}\"`);\n\n      if (stdout.includes('FOUND')) {\n        const threats = stdout\n          .split('\\n')\n          .filter(line => line.includes('FOUND'))\n          .map(line => line.split(':')[0].trim());\n\n        return { isInfected: true, threats };\n      }\n\n      return { isInfected: false, threats: [] };\n    } catch (error) {\n      logger.warn('ClamAV scan failed:', error);\n      return { isInfected: false, threats: [] };\n    }\n  }\n\n  private async scanWithYARA(\n    filePath: string,\n  ): Promise<{ isInfected: boolean; threats: string[] }> {\n    if (!this.isYARAAvailable) {\n      return { isInfected: false, threats: [] };\n    }\n    try {\n      const { stdout } = await execAsync(\n        `yara ${malwareScannerConfig.yaraRulesPath} \"${filePath}\"`,\n      );\n\n      if (stdout.trim()) {\n        const threats = stdout.split('\\n').filter(line => line.trim());\n        return { isInfected: true, threats };\n      }\n\n      return { isInfected: false, threats: [] };\n    } catch (error) {\n      logger.warn('YARA scan failed:', error);\n      return { isInfected: false, threats: [] };\n    }\n  }\n\n  private async scanWithCustomRules(\n    buffer: Buffer,\n    mimeType: string,\n  ): Promise<{ isInfected: boolean; threats: string[] }> {\n    const threats: string[] = [];\n\n    // Check for suspicious patterns\n    const suspiciousPatterns = [\n      { pattern: /eval\\s*\\(/i, threat: 'JavaScript/PHP eval function' },\n      { pattern: /<script[^>]*>/i, threat: 'Embedded script tag' },\n      { pattern: /javascript:/i, threat: 'JavaScript protocol' },\n      { pattern: /vbscript:/i, threat: 'VBScript protocol' },\n      { pattern: /data:text\\/html/i, threat: 'Data URI HTML' },\n      { pattern: /PK\\x03\\x04/, threat: 'ZIP archive (potential payload)' },\n      { pattern: /MZ\\x90\\x00/, threat: 'PE executable' },\n      { pattern: /\\x7fELF/, threat: 'ELF executable' },\n      { pattern: /exec\\s*\\(/i, threat: 'System command execution' },\n      { pattern: /passthru\\s*\\(/i, threat: 'PHP passthru' },\n      { pattern: /shell_exec\\s*\\(/i, threat: 'PHP shell_exec' },\n      { pattern: /system\\s*\\(/i, threat: 'System call' },\n      { pattern: /base64_decode\\s*\\(/i, threat: 'Base64 decoding (potential obfuscation)' },\n      { pattern: /unescape\\s*\\(|decodeURIComponent\\s*\\(/i, threat: 'JavaScript de-obfuscation' },\n      { pattern: /document\\.write\\s*\\(/i, threat: 'Suspicious DOM manipulation' },\n      { pattern: /String\\.fromCharCode/i, threat: 'JavaScript character code obfuscation' },\n      // Advanced Heuristics\n      { pattern: /Invoke-Expression|IEX/i, threat: 'PowerShell remote execution' },\n      { pattern: /WScript\\.Shell|WshShell/i, threat: 'Windows Script Host manipulation' },\n      {\n        pattern: /AutoOpen|AutoExec|Document_Open|Workbook_Open/i,\n        threat: 'Office Macro Auto-execution',\n      },\n      { pattern: /vbaProject\\.bin/i, threat: 'Embedded VBA Project' },\n      { pattern: /python\\s+-c|base64\\s+-d\\s*\\|\\s*sh/i, threat: 'In-place script execution' },\n    ];\n\n    const content = buffer.toString('binary');\n\n    for (const { pattern, threat } of suspiciousPatterns) {\n      if (pattern.test(content)) {\n        threats.push(threat);\n      }\n    }\n\n    // Check file extension vs MIME type mismatch\n    const suspiciousExtensions = [\n      '.exe',\n      '.scr',\n      '.bat',\n      '.cmd',\n      '.com',\n      '.pif',\n      '.vbs',\n      '.js',\n      '.jar',\n    ];\n    const hasSuspiciousExtension = suspiciousExtensions.some(ext =>\n      content.toLowerCase().includes(ext),\n    );\n\n    if (hasSuspiciousExtension && !mimeType.startsWith('application/octet-stream')) {\n      threats.push('Suspicious file extension');\n    }\n\n    // Check for encrypted/obfuscated content\n    const entropy = this.calculateEntropy(buffer);\n    if (entropy > 7.0) {\n      threats.push('High entropy (possible encryption/obfuscation)');\n    }\n\n    // Check for large base64 strings (potential encoded payloads)\n    const base64Matches = content.match(/[A-Za-z0-9+/]{100,}={0,2}/g);\n    if (base64Matches && base64Matches.length > 0) {\n      threats.push('Large base64 strings detected');\n    }\n\n    return {\n      isInfected: threats.length > 0,\n      threats,\n    };\n  }\n\n  private async scanWithVirusTotal(\n    hash: string,\n  ): Promise<{ isInfected: boolean; threats: string[] }> {\n    try {\n      const apiKey = process.env.VIRUSTOTAL_API_KEY;\n      if (!apiKey) {\n        logger.debug('VirusTotal API key not found, skipping scan', { hash });\n        return { isInfected: false, threats: [] };\n      }\n\n      const response = await axios.get(`https://www.virustotal.com/api/v3/files/${hash}`, {\n        headers: {\n          'x-apikey': apiKey,\n        },\n        validateStatus: (status: number) => status === 200 || status === 404,\n      });\n\n      if (response.status === 404) {\n        logger.debug('File hash not found in VirusTotal database', { hash });\n        return { isInfected: false, threats: [] };\n      }\n\n      const { data } = response.data;\n      const lastAnalysisStats = data.attributes.last_analysis_stats;\n      const maliciousCount = lastAnalysisStats.malicious || 0;\n      const suspiciousCount = lastAnalysisStats.suspicious || 0;\n\n      if (maliciousCount > 0 || suspiciousCount > 2) {\n        const maliciousThreats = Object.values(\n          data.attributes.last_analysis_results as Record<string, any>,\n        )\n          .filter(r => r.category === 'malicious')\n          .map(r => r.result)\n          .filter(Boolean);\n\n        return {\n          isInfected: true,\n          threats: [\n            `VirusTotal: ${maliciousCount} engines detected threats`,\n            ...maliciousThreats.slice(0, 3),\n          ],\n        };\n      }\n\n      return { isInfected: false, threats: [] };\n    } catch (error) {\n      logger.warn('VirusTotal scan failed:', error);\n      return { isInfected: false, threats: [] };\n    }\n  }\n\n  private async quarantineFile(\n    filePath: string,\n    scanResult: ScanResult,\n    userId?: string,\n  ): Promise<void> {\n    try {\n      const fileName = path.basename(filePath);\n      const quarantineFileName = `${Date.now()}_${fileName}`;\n      const quarantinePath = path.join(this.quarantineDir, quarantineFileName);\n\n      // Move file to quarantine\n      await fs.copyFile(filePath, quarantinePath);\n      await fs.unlink(filePath); // Remove original\n\n      // Store quarantine info\n      const quarantineInfo: QuarantineInfo = {\n        originalPath: filePath,\n        quarantinePath,\n        hash: scanResult.hash,\n        threat: scanResult.threats.join(', '),\n        quarantinedAt: new Date(),\n        userId,\n      };\n\n      const infoPath = `${quarantinePath}.info`;\n      await fs.writeFile(infoPath, JSON.stringify(quarantineInfo, null, 2));\n\n      logger.info('File quarantined successfully', {\n        originalPath: filePath,\n        quarantinePath,\n        threats: scanResult.threats,\n      });\n    } catch (error) {\n      logger.error('Failed to quarantine file:', { filePath, error });\n      throw error;\n    }\n  }\n\n  public async releaseFromQuarantine(quarantinePath: string, targetPath: string): Promise<void> {\n    try {\n      const infoPath = `${quarantinePath}.info`;\n      const infoContent = await fs.readFile(infoPath, 'utf-8');\n      const quarantineInfo: QuarantineInfo = JSON.parse(infoContent);\n\n      // Move file back\n      await fs.copyFile(quarantinePath, targetPath);\n      await fs.unlink(quarantinePath);\n      await fs.unlink(infoPath);\n\n      logger.info('File released from quarantine', {\n        quarantinePath,\n        targetPath,\n        originalHash: quarantineInfo.hash,\n      });\n    } catch (error) {\n      logger.error('Failed to release file from quarantine:', { quarantinePath, error });\n      throw error;\n    }\n  }\n\n  public async getQuarantinedFiles(): Promise<QuarantineInfo[]> {\n    try {\n      const files = await fs.readdir(this.quarantineDir);\n      const quarantineFiles: QuarantineInfo[] = [];\n\n      for (const file of files) {\n        if (file.endsWith('.info')) {\n          const infoPath = path.join(this.quarantineDir, file);\n          const infoContent = await fs.readFile(infoPath, 'utf-8');\n          const quarantineInfo: QuarantineInfo = JSON.parse(infoContent);\n          quarantineFiles.push(quarantineInfo);\n        }\n      }\n\n      return quarantineFiles.sort((a, b) => b.quarantinedAt.getTime() - a.quarantinedAt.getTime());\n    } catch (error) {\n      logger.error('Failed to get quarantined files:', error);\n      return [];\n    }\n  }\n\n  public async deleteQuarantinedFile(quarantinePath: string): Promise<void> {\n    try {\n      const infoPath = `${quarantinePath}.info`;\n      await fs.unlink(quarantinePath);\n      await fs.unlink(infoPath);\n\n      logger.info('Quarantined file deleted', { quarantinePath });\n    } catch (error) {\n      logger.error('Failed to delete quarantined file:', { quarantinePath, error });\n      throw error;\n    }\n  }\n\n  /**\n   * Cleans up old files from the quarantine directory\n   * @param days Number of days to retain files\n   */\n  public async cleanupQuarantine(\n    days: number = malwareScannerConfig.quarantineRetentionDays,\n  ): Promise<void> {\n    try {\n      const files = await fs.readdir(this.quarantineDir);\n      const now = Date.now();\n      const retentionMs = days * 24 * 60 * 60 * 1000;\n      let count = 0;\n\n      for (const file of files) {\n        if (file.endsWith('.info')) {\n          const infoPath = path.join(this.quarantineDir, file);\n          const stats = await fs.stat(infoPath);\n\n          if (now - stats.mtimeMs > retentionMs) {\n            const quarantinePath = infoPath.replace('.info', '');\n            await this.deleteQuarantinedFile(quarantinePath);\n            count++;\n          }\n        }\n      }\n\n      if (count > 0) {\n        logger.info(`Quarantine cleanup completed. Removed ${count} old entries.`);\n      }\n    } catch (error) {\n      logger.error('Failed to cleanup quarantine:', error);\n    }\n  }\n\n  private calculateHash(buffer: Buffer): string {\n    return crypto.createHash('sha256').update(buffer).digest('hex');\n  }\n\n  private async detectMimeType(buffer: Buffer): Promise<string> {\n    // Simple MIME type detection based on file signatures\n    const signatures = [\n      { pattern: /^\\x89PNG\\r\\n\\x1a\\n/, mime: 'image/png' },\n      { pattern: /^\\xff\\xd8\\xff/, mime: 'image/jpeg' },\n      { pattern: /^GIF87a/, mime: 'image/gif' },\n      { pattern: /^GIF89a/, mime: 'image/gif' },\n      { pattern: /^%PDF-/, mime: 'application/pdf' },\n      { pattern: /^PK\\x03\\x04/, mime: 'application/zip' },\n      { pattern: /^MZ\\x90\\x00/, mime: 'application/x-msdownload' },\n      { pattern: /^\\x7fELF/, mime: 'application/x-executable' },\n    ];\n\n    const content = buffer.toString('binary', 0, Math.min(buffer.length, 100));\n\n    for (const { pattern, mime } of signatures) {\n      if (pattern.test(content)) {\n        return mime;\n      }\n    }\n\n    // Default to octet-stream if no signature matches\n    return 'application/octet-stream';\n  }\n\n  private calculateEntropy(buffer: Buffer): number {\n    const frequency = new Map<number, number>();\n\n    // Count byte frequencies\n    for (const byte of buffer) {\n      frequency.set(byte, (frequency.get(byte) || 0) + 1);\n    }\n\n    // Calculate Shannon entropy\n    let entropy = 0;\n    const length = buffer.length;\n\n    for (const count of frequency.values()) {\n      const probability = count / length;\n      entropy -= probability * Math.log2(probability);\n    }\n\n    return entropy;\n  }\n\n  public getScanStats(): {\n    totalScans: number;\n    infectedFiles: number;\n    quarantinedFiles: number;\n    averageScanTime: number;\n    topThreats: Array<{ threat: string; count: number }>;\n  } {\n    const scans = Array.from(this.scanCache.values());\n    const totalScans = scans.length;\n    const infectedFiles = scans.filter(s => s.isInfected).length;\n    const averageScanTime =\n      totalScans > 0 ? scans.reduce((sum, s) => sum + s.scanTime, 0) / totalScans : 0;\n\n    // Count top threats\n    const threatCounts = new Map<string, number>();\n    scans.forEach(scan => {\n      scan.threats.forEach(threat => {\n        threatCounts.set(threat, (threatCounts.get(threat) || 0) + 1);\n      });\n    });\n\n    const topThreats = Array.from(threatCounts.entries())\n      .map(([threat, count]) => ({ threat, count }))\n      .sort((a, b) => b.count - a.count)\n      .slice(0, 10);\n\n    return {\n      totalScans,\n      infectedFiles,\n      quarantinedFiles: scans.filter(s => s.isInfected).length,\n      averageScanTime,\n      topThreats,\n    };\n  }\n\n  public clearCache(): void {\n    this.scanCache.clear();\n    logger.info('Malware scan cache cleared');\n  }\n}\n"],"version":3}