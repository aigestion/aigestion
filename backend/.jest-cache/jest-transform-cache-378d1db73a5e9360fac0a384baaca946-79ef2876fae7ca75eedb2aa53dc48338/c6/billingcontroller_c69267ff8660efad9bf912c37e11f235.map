{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\controllers\\billing.controller.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\controllers\\billing.controller.ts"],"sourcesContent":["import { Request, Response, NextFunction } from 'express';\nimport { inject, injectable } from 'inversify';\nimport { UsageRecord } from '../models/UsageRecord';\nimport { User } from '../models/User';\nimport { logger } from '../utils/logger';\nimport { StripeService } from '../services/stripe.service';\nimport { PayPalService } from '../services/paypal.service';\nimport { env } from '../config/env.schema';\nimport { TYPES } from '../types';\n\n@injectable()\nexport class BillingController {\n  constructor(\n    @inject(TYPES.StripeService) private stripeService: StripeService,\n    @inject(TYPES.PaypalService) private payPalService: PayPalService,\n  ) {}\n\n  public async getBillingSnapshot(req: Request, res: Response, next: NextFunction) {\n    try {\n      const userId = (req as any).user?.id;\n      const aiCostData = await UsageRecord.aggregate([\n        { $match: { userId: userId } },\n        { $group: { _id: null, total: { $sum: '$costEstimate' } } },\n      ]);\n\n      const aiTotal = aiCostData[0]?.total || 0;\n      const snapshot = {\n        updatedAt: new Date().toISOString(),\n        googleCloudUSD: Number.parseFloat((aiTotal * 0.4).toFixed(2)),\n        githubActionsUSD: 8.75,\n        otherUSD: 5.0,\n        ivaRate: 0.21,\n        totalUSD: Number.parseFloat(((aiTotal + 20) * 1.21).toFixed(2)),\n        currency: 'EUR',\n        totalEUR: Number.parseFloat(((aiTotal + 20) * 1.21 * 0.92).toFixed(2)),\n      };\n\n      res.json(snapshot);\n    } catch (err) {\n      next(err);\n    }\n  }\n\n  public async createCheckoutSession(req: Request, res: Response, next: NextFunction) {\n    try {\n      const { priceId } = req.body;\n      const userId = (req as any).user?.id;\n\n      if (!priceId) {\n        return res.status(400).json({ error: 'Price ID is required' });\n      }\n\n      const user = await User.findById(userId);\n      if (!user) {\n        return res.status(404).json({ error: 'User not found' });\n      }\n\n      let customerId = user.stripeCustomerId;\n      if (!customerId) {\n        const customer = await this.stripeService.createCustomer(user.email, user.name);\n        customerId = customer.id;\n        user.stripeCustomerId = customerId;\n        await user.save();\n      }\n\n      const session = await this.stripeService.createSubscriptionCheckoutSession(\n        customerId,\n        priceId,\n        `${env.FRONTEND_URL}/billing?success=true`,\n        `${env.FRONTEND_URL}/billing?canceled=true`,\n      );\n\n      res.json({ sessionId: session.id, url: session.url });\n    } catch (error) {\n      next(error);\n    }\n  }\n\n  public async createPortalSession(req: Request, res: Response, next: NextFunction) {\n    try {\n      const userId = (req as any).user?.id;\n      const user = await User.findById(userId);\n\n      if (!user?.stripeCustomerId) {\n        return res.status(400).json({ error: 'No billing account linked to this user' });\n      }\n\n      const session = await this.stripeService.createPortalSession(\n        user.stripeCustomerId,\n        `${env.FRONTEND_URL}/billing`,\n      );\n\n      res.json({ url: session.url });\n    } catch (error) {\n      next(error);\n    }\n  }\n\n  public async createPayPalOrder(req: Request, res: Response, next: NextFunction) {\n    try {\n      const { amount, currency } = req.body;\n      const order = await this.payPalService.createOrder(amount, currency || 'USD');\n      res.json(order);\n    } catch (error) {\n      next(error);\n    }\n  }\n\n  public async capturePayPalOrder(req: Request, res: Response, next: NextFunction) {\n    try {\n      const { orderId } = req.body;\n      const capture = await this.payPalService.captureOrder(orderId);\n      res.json(capture);\n    } catch (error) {\n      next(error);\n    }\n  }\n}\n"],"version":3}