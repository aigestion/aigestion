cc015776c8137a7515819ab6a1134fd6
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.clearConversation = exports.getConversationHistory = exports.processConversation = void 0;
const zod_1 = require("zod");
const response_builder_1 = require("../common/response-builder");
const inversify_config_1 = require("../config/inversify.config");
const validation_middleware_1 = require("../middleware/validation.middleware");
const types_1 = require("../types");
exports.processConversation = [
    (0, validation_middleware_1.validate)({
        body: zod_1.z.object({
            sessionId: zod_1.z.string(),
            userId: zod_1.z.string(),
            text: zod_1.z.string().optional(),
            audio: zod_1.z.string().optional(), // Base64 encoded audio
        }),
    }),
    async (req, res, next) => {
        try {
            const { sessionId, userId, text, audio } = req.body;
            const enhancedVoiceService = inversify_config_1.container.get(types_1.TYPES.EnhancedVoiceService);
            const rateLimitService = inversify_config_1.container.get(types_1.TYPES.RateLimitService);
            // Check rate limits (bypass for admin/god)
            const userRole = req.user?.role;
            if (userRole !== 'god' && userRole !== 'admin') {
                await rateLimitService.incrementAndCheck(`enhanced_voice:${userId}`, 30, 60); // 30 requests per minute
            }
            // Process audio if provided
            let audioBuffer;
            if (audio) {
                audioBuffer = Buffer.from(audio, 'base64');
            }
            const result = await enhancedVoiceService.processConversation({
                audio: audioBuffer,
                text,
                sessionId,
                userId,
            });
            // Convert audio response to base64 for frontend
            const response = {
                ...result,
                audioResponse: result.audioResponse ? result.audioResponse.toString('base64') : undefined,
            };
            res.json((0, response_builder_1.buildResponse)(response, 200, req.requestId || 'unknown'));
        }
        catch (err) {
            next(err);
        }
    },
];
exports.getConversationHistory = [
    (0, validation_middleware_1.validate)({
        query: zod_1.z.object({
            sessionId: zod_1.z.string(),
        }),
    }),
    async (req, res, next) => {
        try {
            const { sessionId } = req.query;
            const enhancedVoiceService = inversify_config_1.container.get(types_1.TYPES.EnhancedVoiceService);
            const userId = req.user?.id || 'anonymous';
            const history = await enhancedVoiceService.getConversationHistory(sessionId);
            res.json((0, response_builder_1.buildResponse)(history, 200, req.requestId || 'unknown'));
        }
        catch (err) {
            next(err);
        }
    },
];
exports.clearConversation = [
    (0, validation_middleware_1.validate)({
        body: zod_1.z.object({
            sessionId: zod_1.z.string(),
        }),
    }),
    async (req, res, next) => {
        try {
            const { sessionId } = req.body;
            const enhancedVoiceService = inversify_config_1.container.get(types_1.TYPES.EnhancedVoiceService);
            const userId = req.user?.id || 'anonymous';
            await enhancedVoiceService.clearConversation(sessionId);
            res.json((0, response_builder_1.buildResponse)({ message: 'Conversation cleared successfully' }, 200, req.requestId || 'unknown'));
        }
        catch (err) {
            next(err);
        }
    },
];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxjb250cm9sbGVyc1xcZW5oYW5jZWQtdm9pY2UuY29udHJvbGxlci50cyIsIm1hcHBpbmdzIjoiOzs7QUFDQSw2QkFBd0I7QUFDeEIsaUVBQTJEO0FBQzNELGlFQUF1RDtBQUN2RCwrRUFBK0Q7QUFHL0Qsb0NBQWlDO0FBRXBCLFFBQUEsbUJBQW1CLEdBQUc7SUFDakMsSUFBQSxnQ0FBUSxFQUFDO1FBQ1AsSUFBSSxFQUFFLE9BQUMsQ0FBQyxNQUFNLENBQUM7WUFDYixTQUFTLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRTtZQUNyQixNQUFNLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRTtZQUNsQixJQUFJLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsRUFBRTtZQUMzQixLQUFLLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsRUFBRSxFQUFFLHVCQUF1QjtTQUN0RCxDQUFDO0tBQ0gsQ0FBQztJQUNGLEtBQUssRUFBRSxHQUFZLEVBQUUsR0FBYSxFQUFFLElBQWtCLEVBQUUsRUFBRTtRQUN4RCxJQUFJLENBQUM7WUFDSCxNQUFNLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQztZQUNwRCxNQUFNLG9CQUFvQixHQUFHLDRCQUFTLENBQUMsR0FBRyxDQUF1QixhQUFLLENBQUMsb0JBQW9CLENBQUMsQ0FBQztZQUM3RixNQUFNLGdCQUFnQixHQUFHLDRCQUFTLENBQUMsR0FBRyxDQUFtQixhQUFLLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztZQUVqRiwyQ0FBMkM7WUFDM0MsTUFBTSxRQUFRLEdBQUksR0FBVyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUM7WUFDekMsSUFBSSxRQUFRLEtBQUssS0FBSyxJQUFJLFFBQVEsS0FBSyxPQUFPLEVBQUUsQ0FBQztnQkFDL0MsTUFBTSxnQkFBZ0IsQ0FBQyxpQkFBaUIsQ0FBQyxrQkFBa0IsTUFBTSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMseUJBQXlCO1lBQ3pHLENBQUM7WUFFRCw0QkFBNEI7WUFDNUIsSUFBSSxXQUErQixDQUFDO1lBQ3BDLElBQUksS0FBSyxFQUFFLENBQUM7Z0JBQ1YsV0FBVyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBQzdDLENBQUM7WUFFRCxNQUFNLE1BQU0sR0FBRyxNQUFNLG9CQUFvQixDQUFDLG1CQUFtQixDQUFDO2dCQUM1RCxLQUFLLEVBQUUsV0FBVztnQkFDbEIsSUFBSTtnQkFDSixTQUFTO2dCQUNULE1BQU07YUFDUCxDQUFDLENBQUM7WUFFSCxnREFBZ0Q7WUFDaEQsTUFBTSxRQUFRLEdBQUc7Z0JBQ2YsR0FBRyxNQUFNO2dCQUNULGFBQWEsRUFBRSxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUzthQUMxRixDQUFDO1lBRUYsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFBLGdDQUFhLEVBQUMsUUFBUSxFQUFFLEdBQUcsRUFBRyxHQUFXLENBQUMsU0FBUyxJQUFJLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFDOUUsQ0FBQztRQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7WUFDYixJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDWixDQUFDO0lBQ0gsQ0FBQztDQUNGLENBQUM7QUFFVyxRQUFBLHNCQUFzQixHQUFHO0lBQ3BDLElBQUEsZ0NBQVEsRUFBQztRQUNQLEtBQUssRUFBRSxPQUFDLENBQUMsTUFBTSxDQUFDO1lBQ2QsU0FBUyxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUU7U0FDdEIsQ0FBQztLQUNILENBQUM7SUFDRixLQUFLLEVBQUUsR0FBWSxFQUFFLEdBQWEsRUFBRSxJQUFrQixFQUFFLEVBQUU7UUFDeEQsSUFBSSxDQUFDO1lBQ0gsTUFBTSxFQUFFLFNBQVMsRUFBRSxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUM7WUFDaEMsTUFBTSxvQkFBb0IsR0FBRyw0QkFBUyxDQUFDLEdBQUcsQ0FBdUIsYUFBSyxDQUFDLG9CQUFvQixDQUFDLENBQUM7WUFDN0YsTUFBTSxNQUFNLEdBQUksR0FBVyxDQUFDLElBQUksRUFBRSxFQUFFLElBQUksV0FBVyxDQUFDO1lBRXBELE1BQU0sT0FBTyxHQUFHLE1BQU0sb0JBQW9CLENBQUMsc0JBQXNCLENBQUMsU0FBbUIsQ0FBQyxDQUFDO1lBRXZGLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBQSxnQ0FBYSxFQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUcsR0FBVyxDQUFDLFNBQVMsSUFBSSxTQUFTLENBQUMsQ0FBQyxDQUFDO1FBQzdFLENBQUM7UUFBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO1lBQ2IsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ1osQ0FBQztJQUNILENBQUM7Q0FDRixDQUFDO0FBRVcsUUFBQSxpQkFBaUIsR0FBRztJQUMvQixJQUFBLGdDQUFRLEVBQUM7UUFDUCxJQUFJLEVBQUUsT0FBQyxDQUFDLE1BQU0sQ0FBQztZQUNiLFNBQVMsRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFO1NBQ3RCLENBQUM7S0FDSCxDQUFDO0lBQ0YsS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFhLEVBQUUsSUFBa0IsRUFBRSxFQUFFO1FBQ3hELElBQUksQ0FBQztZQUNILE1BQU0sRUFBRSxTQUFTLEVBQUUsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1lBQy9CLE1BQU0sb0JBQW9CLEdBQUcsNEJBQVMsQ0FBQyxHQUFHLENBQXVCLGFBQUssQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO1lBQzdGLE1BQU0sTUFBTSxHQUFJLEdBQVcsQ0FBQyxJQUFJLEVBQUUsRUFBRSxJQUFJLFdBQVcsQ0FBQztZQUVwRCxNQUFNLG9CQUFvQixDQUFDLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBRXhELEdBQUcsQ0FBQyxJQUFJLENBQ04sSUFBQSxnQ0FBYSxFQUNYLEVBQUUsT0FBTyxFQUFFLG1DQUFtQyxFQUFFLEVBQ2hELEdBQUcsRUFDRixHQUFXLENBQUMsU0FBUyxJQUFJLFNBQVMsQ0FDcEMsQ0FDRixDQUFDO1FBQ0osQ0FBQztRQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7WUFDYixJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDWixDQUFDO0lBQ0gsQ0FBQztDQUNGLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxjb250cm9sbGVyc1xcZW5oYW5jZWQtdm9pY2UuY29udHJvbGxlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IE5leHRGdW5jdGlvbiwgUmVxdWVzdCwgUmVzcG9uc2UgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IHogfSBmcm9tICd6b2QnO1xuaW1wb3J0IHsgYnVpbGRSZXNwb25zZSB9IGZyb20gJy4uL2NvbW1vbi9yZXNwb25zZS1idWlsZGVyJztcbmltcG9ydCB7IGNvbnRhaW5lciB9IGZyb20gJy4uL2NvbmZpZy9pbnZlcnNpZnkuY29uZmlnJztcbmltcG9ydCB7IHZhbGlkYXRlIH0gZnJvbSAnLi4vbWlkZGxld2FyZS92YWxpZGF0aW9uLm1pZGRsZXdhcmUnO1xuaW1wb3J0IHsgRW5oYW5jZWRWb2ljZVNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9lbmhhbmNlZC12b2ljZS5zZXJ2aWNlJztcbmltcG9ydCB7IFJhdGVMaW1pdFNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9yYXRlLWxpbWl0LnNlcnZpY2UnO1xuaW1wb3J0IHsgVFlQRVMgfSBmcm9tICcuLi90eXBlcyc7XG5cbmV4cG9ydCBjb25zdCBwcm9jZXNzQ29udmVyc2F0aW9uID0gW1xuICB2YWxpZGF0ZSh7XG4gICAgYm9keTogei5vYmplY3Qoe1xuICAgICAgc2Vzc2lvbklkOiB6LnN0cmluZygpLFxuICAgICAgdXNlcklkOiB6LnN0cmluZygpLFxuICAgICAgdGV4dDogei5zdHJpbmcoKS5vcHRpb25hbCgpLFxuICAgICAgYXVkaW86IHouc3RyaW5nKCkub3B0aW9uYWwoKSwgLy8gQmFzZTY0IGVuY29kZWQgYXVkaW9cbiAgICB9KSxcbiAgfSksXG4gIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IHNlc3Npb25JZCwgdXNlcklkLCB0ZXh0LCBhdWRpbyB9ID0gcmVxLmJvZHk7XG4gICAgICBjb25zdCBlbmhhbmNlZFZvaWNlU2VydmljZSA9IGNvbnRhaW5lci5nZXQ8RW5oYW5jZWRWb2ljZVNlcnZpY2U+KFRZUEVTLkVuaGFuY2VkVm9pY2VTZXJ2aWNlKTtcbiAgICAgIGNvbnN0IHJhdGVMaW1pdFNlcnZpY2UgPSBjb250YWluZXIuZ2V0PFJhdGVMaW1pdFNlcnZpY2U+KFRZUEVTLlJhdGVMaW1pdFNlcnZpY2UpO1xuXG4gICAgICAvLyBDaGVjayByYXRlIGxpbWl0cyAoYnlwYXNzIGZvciBhZG1pbi9nb2QpXG4gICAgICBjb25zdCB1c2VyUm9sZSA9IChyZXEgYXMgYW55KS51c2VyPy5yb2xlO1xuICAgICAgaWYgKHVzZXJSb2xlICE9PSAnZ29kJyAmJiB1c2VyUm9sZSAhPT0gJ2FkbWluJykge1xuICAgICAgICBhd2FpdCByYXRlTGltaXRTZXJ2aWNlLmluY3JlbWVudEFuZENoZWNrKGBlbmhhbmNlZF92b2ljZToke3VzZXJJZH1gLCAzMCwgNjApOyAvLyAzMCByZXF1ZXN0cyBwZXIgbWludXRlXG4gICAgICB9XG5cbiAgICAgIC8vIFByb2Nlc3MgYXVkaW8gaWYgcHJvdmlkZWRcbiAgICAgIGxldCBhdWRpb0J1ZmZlcjogQnVmZmVyIHwgdW5kZWZpbmVkO1xuICAgICAgaWYgKGF1ZGlvKSB7XG4gICAgICAgIGF1ZGlvQnVmZmVyID0gQnVmZmVyLmZyb20oYXVkaW8sICdiYXNlNjQnKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZW5oYW5jZWRWb2ljZVNlcnZpY2UucHJvY2Vzc0NvbnZlcnNhdGlvbih7XG4gICAgICAgIGF1ZGlvOiBhdWRpb0J1ZmZlcixcbiAgICAgICAgdGV4dCxcbiAgICAgICAgc2Vzc2lvbklkLFxuICAgICAgICB1c2VySWQsXG4gICAgICB9KTtcblxuICAgICAgLy8gQ29udmVydCBhdWRpbyByZXNwb25zZSB0byBiYXNlNjQgZm9yIGZyb250ZW5kXG4gICAgICBjb25zdCByZXNwb25zZSA9IHtcbiAgICAgICAgLi4ucmVzdWx0LFxuICAgICAgICBhdWRpb1Jlc3BvbnNlOiByZXN1bHQuYXVkaW9SZXNwb25zZSA/IHJlc3VsdC5hdWRpb1Jlc3BvbnNlLnRvU3RyaW5nKCdiYXNlNjQnKSA6IHVuZGVmaW5lZCxcbiAgICAgIH07XG5cbiAgICAgIHJlcy5qc29uKGJ1aWxkUmVzcG9uc2UocmVzcG9uc2UsIDIwMCwgKHJlcSBhcyBhbnkpLnJlcXVlc3RJZCB8fCAndW5rbm93bicpKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIG5leHQoZXJyKTtcbiAgICB9XG4gIH0sXG5dO1xuXG5leHBvcnQgY29uc3QgZ2V0Q29udmVyc2F0aW9uSGlzdG9yeSA9IFtcbiAgdmFsaWRhdGUoe1xuICAgIHF1ZXJ5OiB6Lm9iamVjdCh7XG4gICAgICBzZXNzaW9uSWQ6IHouc3RyaW5nKCksXG4gICAgfSksXG4gIH0pLFxuICBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBzZXNzaW9uSWQgfSA9IHJlcS5xdWVyeTtcbiAgICAgIGNvbnN0IGVuaGFuY2VkVm9pY2VTZXJ2aWNlID0gY29udGFpbmVyLmdldDxFbmhhbmNlZFZvaWNlU2VydmljZT4oVFlQRVMuRW5oYW5jZWRWb2ljZVNlcnZpY2UpO1xuICAgICAgY29uc3QgdXNlcklkID0gKHJlcSBhcyBhbnkpLnVzZXI/LmlkIHx8ICdhbm9ueW1vdXMnO1xuXG4gICAgICBjb25zdCBoaXN0b3J5ID0gYXdhaXQgZW5oYW5jZWRWb2ljZVNlcnZpY2UuZ2V0Q29udmVyc2F0aW9uSGlzdG9yeShzZXNzaW9uSWQgYXMgc3RyaW5nKTtcblxuICAgICAgcmVzLmpzb24oYnVpbGRSZXNwb25zZShoaXN0b3J5LCAyMDAsIChyZXEgYXMgYW55KS5yZXF1ZXN0SWQgfHwgJ3Vua25vd24nKSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBuZXh0KGVycik7XG4gICAgfVxuICB9LFxuXTtcblxuZXhwb3J0IGNvbnN0IGNsZWFyQ29udmVyc2F0aW9uID0gW1xuICB2YWxpZGF0ZSh7XG4gICAgYm9keTogei5vYmplY3Qoe1xuICAgICAgc2Vzc2lvbklkOiB6LnN0cmluZygpLFxuICAgIH0pLFxuICB9KSxcbiAgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgc2Vzc2lvbklkIH0gPSByZXEuYm9keTtcbiAgICAgIGNvbnN0IGVuaGFuY2VkVm9pY2VTZXJ2aWNlID0gY29udGFpbmVyLmdldDxFbmhhbmNlZFZvaWNlU2VydmljZT4oVFlQRVMuRW5oYW5jZWRWb2ljZVNlcnZpY2UpO1xuICAgICAgY29uc3QgdXNlcklkID0gKHJlcSBhcyBhbnkpLnVzZXI/LmlkIHx8ICdhbm9ueW1vdXMnO1xuXG4gICAgICBhd2FpdCBlbmhhbmNlZFZvaWNlU2VydmljZS5jbGVhckNvbnZlcnNhdGlvbihzZXNzaW9uSWQpO1xuXG4gICAgICByZXMuanNvbihcbiAgICAgICAgYnVpbGRSZXNwb25zZShcbiAgICAgICAgICB7IG1lc3NhZ2U6ICdDb252ZXJzYXRpb24gY2xlYXJlZCBzdWNjZXNzZnVsbHknIH0sXG4gICAgICAgICAgMjAwLFxuICAgICAgICAgIChyZXEgYXMgYW55KS5yZXF1ZXN0SWQgfHwgJ3Vua25vd24nLFxuICAgICAgICApLFxuICAgICAgKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIG5leHQoZXJyKTtcbiAgICB9XG4gIH0sXG5dO1xuIl0sInZlcnNpb24iOjN9