{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\middleware\\waf.middleware.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\middleware\\waf.middleware.ts"],"sourcesContent":["import { NextFunction, Request, Response } from 'express';\nimport { logger } from '../utils/logger';\n\n/**\n * Web Application Firewall (WAF) Middleware\n * Protects against common web attacks and malicious requests\n */\n\ninterface WAFRule {\n  name: string;\n  enabled: boolean;\n  pattern: RegExp;\n  action: 'block' | 'warn' | 'log';\n  description: string;\n  severity: 'low' | 'medium' | 'high' | 'critical';\n}\n\ninterface WAFStats {\n  totalRequests: number;\n  blockedRequests: number;\n  warnings: number;\n  rulesTriggered: { [ruleName: string]: number };\n}\n\nclass WebApplicationFirewall {\n  private rules: WAFRule[] = [];\n  private stats: WAFStats = {\n    totalRequests: 0,\n    blockedRequests: 0,\n    warnings: 0,\n    rulesTriggered: {},\n  };\n\n  constructor() {\n    this.initializeRules();\n  }\n\n  private initializeRules() {\n    this.rules = [\n      // SQL Injection Detection\n      {\n        name: 'SQL_INJECTION',\n        enabled: true,\n        pattern:\n          /(\\b(SELECT|INSERT|UPDATE|DELETE|DROP|CREATE|ALTER|EXEC|UNION|SCRIPT)\\b|\\b(OR|AND)\\s+\\d+\\s*=\\s*\\d+|\\'\\s*OR\\s*\\d+\\s*=\\s*\\d+|\\'\\s*OR\\s*\\'\\w+\\'\\s*=\\s*\\'\\w+\\'|\\'\\s*;\\s*DROP|\\'\\s*;\\s*DELETE|\\'\\s*;\\s*INSERT)/i,\n        action: 'block',\n        description: 'Detects SQL injection attempts',\n        severity: 'critical',\n      },\n\n      // XSS Detection\n      {\n        name: 'XSS_ATTACK',\n        enabled: true,\n        pattern:\n          /(<script[^>]*>.*?<\\/script>|<iframe[^>]*>.*?<\\/iframe>|javascript:|on\\w+\\s*=|<img[^>]*src\\s*=\\s*[\"\\']?javascript:|<object[^>]*data\\s*=\\s*[\"\\']?javascript:|eval\\s*\\(|alert\\s*\\(|confirm\\s*\\(|prompt\\s*\\()/i,\n        action: 'block',\n        description: 'Detects Cross-Site Scripting attempts',\n        severity: 'high',\n      },\n\n      // Path Traversal Detection\n      {\n        name: 'PATH_TRAVERSAL',\n        enabled: true,\n        pattern: /(\\.\\.[\\/\\\\])/,\n        action: 'block',\n        description: 'Detects path traversal attacks',\n        severity: 'high',\n      },\n\n      // Command Injection Detection\n      {\n        name: 'COMMAND_INJECTION',\n        enabled: true,\n        pattern:\n          /(;|\\||&|\\$\\(|\\`|\\$\\{)(\\s*(rm|del|format|fdisk|cat|type|more|less|head|tail|grep|find|ls|dir|whoami|id|uname|ps|netstat|ipconfig|ifconfig|ping|curl|wget|nc|telnet|ssh|ftp|scp|rsync)\\s)/i,\n        action: 'block',\n        description: 'Detects command injection attempts',\n        severity: 'critical',\n      },\n\n      // LDAP Injection Detection\n      {\n        name: 'LDAP_INJECTION',\n        enabled: true,\n        pattern: /(\\*|\\(|\\)|\\\\|\\||&|!|=|<|>|~)/,\n        action: 'warn',\n        description: 'Detects potential LDAP injection',\n        severity: 'medium',\n      },\n\n      // NoSQL Injection Detection\n      {\n        name: 'NOSQL_INJECTION',\n        enabled: true,\n        pattern: /(\\$where|\\$ne|\\$gt|\\$lt|\\$regex|\\$in|\\$nin|\\$exists|\\$or|\\$and|\\$not|\\$nor)/i,\n        action: 'block',\n        description: 'Detects NoSQL injection attempts',\n        severity: 'high',\n      },\n\n      // XXE (XML External Entity) Detection\n      {\n        name: 'XXE_ATTACK',\n        enabled: true,\n        pattern: /(<\\?xml|<!DOCTYPE|&lt;!ENTITY|&lt;!ATTLIST|SYSTEM|PUBLIC)/i,\n        action: 'block',\n        description: 'Detects XXE attacks',\n        severity: 'critical',\n      },\n\n      // SSRF (Server-Side Request Forgery) Detection\n      {\n        name: 'SSRF_ATTACK',\n        enabled: true,\n        pattern:\n          /(http:\\/\\/|https:\\/\\/|ftp:\\/\\/)(localhost|127\\.0\\.0\\.1|0\\.0\\.0\\.0|::1|169\\.254\\.|192\\.168\\.|10\\.|172\\.(1[6-9]|2[0-9]|3[01])\\.|metadata|internal|private)/i,\n        action: 'block',\n        description: 'Detects SSRF attempts',\n        severity: 'high',\n      },\n\n      // File Inclusion Detection\n      {\n        name: 'FILE_INCLUSION',\n        enabled: true,\n        pattern:\n          /(php:\\/\\/|file:\\/\\/|data:\\/\\/|expect:\\/\\/|zip:\\/\\/|phar:\\/\\/|glob:\\/\\/|ssh2:\\/\\/|rar:\\/\\/|ogg:\\/\\/|compress\\.zlib:\\/\\/)/i,\n        action: 'block',\n        description: 'Detects file inclusion attacks',\n        severity: 'high',\n      },\n\n      // Buffer Overflow Detection\n      {\n        name: 'BUFFER_OVERFLOW',\n        enabled: true,\n        pattern: /(.){1000,}/,\n        action: 'warn',\n        description: 'Detects potential buffer overflow attempts',\n        severity: 'medium',\n      },\n\n      // HTTP Header Injection\n      {\n        name: 'HEADER_INJECTION',\n        enabled: true,\n        pattern: /(\\r|\\n|%0d|%0a)/,\n        action: 'block',\n        description: 'Detects HTTP header injection',\n        severity: 'medium',\n      },\n\n      // HTTP Parameter Pollution\n      {\n        name: 'PARAMETER_POLLUTION',\n        enabled: true,\n        pattern: /(&\\w+=&|\\w+=.*&\\w+=)/,\n        action: 'warn',\n        description: 'Detects HTTP parameter pollution',\n        severity: 'low',\n      },\n    ];\n  }\n\n  public analyzeRequest(req: Request): {\n    blocked: boolean;\n    warnings: string[];\n    matchedRules: string[];\n  } {\n    const warnings: string[] = [];\n    const matchedRules: string[] = [];\n    let blocked = false;\n\n    // Analyze URL\n    const urlAnalysis = this.analyzeString(req.url, 'URL');\n    if (urlAnalysis.blocked) blocked = true;\n    warnings.push(...urlAnalysis.warnings);\n    matchedRules.push(...urlAnalysis.matchedRules);\n\n    // Analyze query parameters\n    if (req.query) {\n      for (const [key, value] of Object.entries(req.query)) {\n        const queryAnalysis = this.analyzeString(String(value), `QUERY_${key}`);\n        if (queryAnalysis.blocked) blocked = true;\n        warnings.push(...queryAnalysis.warnings);\n        matchedRules.push(...queryAnalysis.matchedRules);\n      }\n    }\n\n    // Analyze body\n    if (req.body) {\n      const bodyString = typeof req.body === 'string' ? req.body : JSON.stringify(req.body);\n      const bodyAnalysis = this.analyzeString(bodyString, 'BODY');\n      if (bodyAnalysis.blocked) blocked = true;\n      warnings.push(...bodyAnalysis.warnings);\n      matchedRules.push(...bodyAnalysis.matchedRules);\n    }\n\n    // Analyze headers\n    for (const [key, value] of Object.entries(req.headers)) {\n      if (value) {\n        const headerAnalysis = this.analyzeString(String(value), `HEADER_${key}`);\n        if (headerAnalysis.blocked) blocked = true;\n        warnings.push(...headerAnalysis.warnings);\n        matchedRules.push(...headerAnalysis.matchedRules);\n      }\n    }\n\n    return { blocked, warnings, matchedRules };\n  }\n\n  private analyzeString(\n    input: string,\n    context: string,\n  ): { blocked: boolean; warnings: string[]; matchedRules: string[] } {\n    const warnings: string[] = [];\n    const matchedRules: string[] = [];\n    let blocked = false;\n\n    for (const rule of this.rules) {\n      if (!rule.enabled) continue;\n\n      if (rule.pattern.test(input)) {\n        matchedRules.push(rule.name);\n\n        // Update stats\n        this.stats.rulesTriggered[rule.name] = (this.stats.rulesTriggered[rule.name] || 0) + 1;\n\n        if (rule.action === 'block') {\n          blocked = true;\n          logger.warn('WAF: Request blocked', {\n            rule: rule.name,\n            severity: rule.severity,\n            context,\n            input: input.substring(0, 100), // Limit input length in logs\n            ip: this.getClientIP(),\n            userAgent: this.getUserAgent(),\n            timestamp: new Date().toISOString(),\n          });\n        } else if (rule.action === 'warn') {\n          warnings.push(`WAF Warning: ${rule.description} detected in ${context}`);\n          logger.warn('WAF: Suspicious request detected', {\n            rule: rule.name,\n            severity: rule.severity,\n            context,\n            input: input.substring(0, 100),\n            ip: this.getClientIP(),\n            userAgent: this.getUserAgent(),\n            timestamp: new Date().toISOString(),\n          });\n        } else {\n          logger.info('WAF: Rule triggered', {\n            rule: rule.name,\n            context,\n            ip: this.getClientIP(),\n            timestamp: new Date().toISOString(),\n          });\n        }\n      }\n    }\n\n    return { blocked, warnings, matchedRules };\n  }\n\n  private getClientIP(req?: Request): string {\n    if (!req) return 'unknown';\n    return (\n      req.ip ||\n      req.connection.remoteAddress ||\n      req.socket.remoteAddress ||\n      (req.connection as any)?.socket?.remoteAddress ||\n      'unknown'\n    );\n  }\n\n  private getUserAgent(req?: Request): string {\n    if (!req) return 'unknown';\n    return req.get('User-Agent') || 'unknown';\n  }\n\n  public getStats(): WAFStats {\n    return { ...this.stats };\n  }\n\n  public resetStats(): void {\n    this.stats = {\n      totalRequests: 0,\n      blockedRequests: 0,\n      warnings: 0,\n      rulesTriggered: {},\n    };\n  }\n\n  public enableRule(ruleName: string): void {\n    const rule = this.rules.find(r => r.name === ruleName);\n    if (rule) {\n      rule.enabled = true;\n      logger.info(`WAF: Rule ${ruleName} enabled`);\n    }\n  }\n\n  public disableRule(ruleName: string): void {\n    const rule = this.rules.find(r => r.name === ruleName);\n    if (rule) {\n      rule.enabled = false;\n      logger.info(`WAF: Rule ${ruleName} disabled`);\n    }\n  }\n\n  public getRules(): WAFRule[] {\n    return [...this.rules];\n  }\n}\n\n// Singleton instance\nconst wafInstance = new WebApplicationFirewall();\n\n/**\n * WAF Middleware\n */\nexport const wafMiddleware = (req: Request, res: Response, next: NextFunction) => {\n  // Update total requests\n  (wafInstance as any).stats.totalRequests++;\n\n  // Analyze request\n  const analysis = wafInstance.analyzeRequest(req);\n\n  // Add WAF headers\n  res.setHeader('X-WAF-Status', analysis.blocked ? 'blocked' : 'allowed');\n  if (analysis.matchedRules.length > 0) {\n    res.setHeader('X-WAF-Rules', analysis.matchedRules.join(','));\n  }\n\n  // Block request if needed\n  if (analysis.blocked) {\n    (wafInstance as any).stats.blockedRequests++;\n\n    return res.status(403).json({\n      error: 'Forbidden',\n      message: 'Request blocked by Web Application Firewall',\n      code: 'WAF_BLOCKED',\n      timestamp: new Date().toISOString(),\n    });\n  }\n\n  // Add warnings to response headers if any\n  if (analysis.warnings.length > 0) {\n    (wafInstance as any).stats.warnings++;\n    res.setHeader('X-WAF-Warnings', analysis.warnings.length);\n\n    // Log warnings for monitoring\n    logger.warn('WAF: Request allowed with warnings', {\n      warnings: analysis.warnings,\n      ip: req.ip,\n      path: req.path,\n      timestamp: new Date().toISOString(),\n    });\n  }\n\n  next();\n};\n\n/**\n * WAF Management API\n */\nexport const wafManagement = {\n  getStats: () => wafInstance.getStats(),\n  resetStats: () => wafInstance.resetStats(),\n  getRules: () => wafInstance.getRules(),\n  enableRule: (name: string) => wafInstance.enableRule(name),\n  disableRule: (name: string) => wafInstance.disableRule(name),\n  getInstance: () => wafInstance,\n};\n\nexport default wafMiddleware;\n"],"version":3}