{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\controllers\\enhanced-voice.controller.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\controllers\\enhanced-voice.controller.ts"],"sourcesContent":["import type { NextFunction, Request, Response } from 'express';\nimport { z } from 'zod';\nimport { buildResponse } from '../common/response-builder';\nimport { container } from '../config/inversify.config';\nimport { validate } from '../middleware/validation.middleware';\nimport { EnhancedVoiceService } from '../services/enhanced-voice.service';\nimport { RateLimitService } from '../services/rate-limit.service';\nimport { TYPES } from '../types';\n\nexport const processConversation = [\n  validate({\n    body: z.object({\n      sessionId: z.string(),\n      userId: z.string(),\n      text: z.string().optional(),\n      audio: z.string().optional(), // Base64 encoded audio\n    }),\n  }),\n  async (req: Request, res: Response, next: NextFunction) => {\n    try {\n      const { sessionId, userId, text, audio } = req.body;\n      const enhancedVoiceService = container.get<EnhancedVoiceService>(TYPES.EnhancedVoiceService);\n      const rateLimitService = container.get<RateLimitService>(TYPES.RateLimitService);\n\n      // Check rate limits (bypass for admin/god)\n      const userRole = (req as any).user?.role;\n      if (userRole !== 'god' && userRole !== 'admin') {\n        await rateLimitService.incrementAndCheck(`enhanced_voice:${userId}`, 30, 60); // 30 requests per minute\n      }\n\n      // Process audio if provided\n      let audioBuffer: Buffer | undefined;\n      if (audio) {\n        audioBuffer = Buffer.from(audio, 'base64');\n      }\n\n      const result = await enhancedVoiceService.processConversation({\n        audio: audioBuffer,\n        text,\n        sessionId,\n        userId,\n      });\n\n      // Convert audio response to base64 for frontend\n      const response = {\n        ...result,\n        audioResponse: result.audioResponse ? result.audioResponse.toString('base64') : undefined,\n      };\n\n      res.json(buildResponse(response, 200, (req as any).requestId || 'unknown'));\n    } catch (err) {\n      next(err);\n    }\n  },\n];\n\nexport const getConversationHistory = [\n  validate({\n    query: z.object({\n      sessionId: z.string(),\n    }),\n  }),\n  async (req: Request, res: Response, next: NextFunction) => {\n    try {\n      const { sessionId } = req.query;\n      const enhancedVoiceService = container.get<EnhancedVoiceService>(TYPES.EnhancedVoiceService);\n      const userId = (req as any).user?.id || 'anonymous';\n\n      const history = await enhancedVoiceService.getConversationHistory(sessionId as string);\n\n      res.json(buildResponse(history, 200, (req as any).requestId || 'unknown'));\n    } catch (err) {\n      next(err);\n    }\n  },\n];\n\nexport const clearConversation = [\n  validate({\n    body: z.object({\n      sessionId: z.string(),\n    }),\n  }),\n  async (req: Request, res: Response, next: NextFunction) => {\n    try {\n      const { sessionId } = req.body;\n      const enhancedVoiceService = container.get<EnhancedVoiceService>(TYPES.EnhancedVoiceService);\n      const userId = (req as any).user?.id || 'anonymous';\n\n      await enhancedVoiceService.clearConversation(sessionId);\n\n      res.json(\n        buildResponse(\n          { message: 'Conversation cleared successfully' },\n          200,\n          (req as any).requestId || 'unknown',\n        ),\n      );\n    } catch (err) {\n      next(err);\n    }\n  },\n];\n"],"version":3}