de76a07382b20ebc0ac2a11d45023c62
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.SocketService = void 0;
const inversify_1 = require("inversify");
const socket_io_1 = require("socket.io");
const logger_1 = require("../utils/logger");
let SocketService = class SocketService {
    io = null;
    /**
     * Initialize the SocketService with the Socket.IO server instance.
     * This is called in server.ts after the server is created.
     */
    init(server) {
        if (server instanceof socket_io_1.Server) {
            this.io = server;
        }
        else {
            this.io = new socket_io_1.Server(server, {
                cors: {
                    origin: '*', // Adjust as needed
                    methods: ['GET', 'POST'],
                    credentials: true,
                },
            });
        }
        logger_1.logger.info('[SocketService] Initialized successfully');
    }
    getIO() {
        return this.io;
    }
    /**
     * Emit an event to a specific user.
     */
    emitToUser(userId, event, data) {
        this.emitToRoom(`user:${userId}`, event, data);
    }
    /**
     * Emit an event to all connected clients.
     */
    emit(event, data) {
        if (!this.io) {
            logger_1.logger.warn(`[SocketService] Cannot emit event "${event}": io not initialized`);
            return;
        }
        this.io.emit(event, data);
    }
    /**
     * Emit an event to a specific room (e.g., a specific mission room).
     */
    emitToRoom(room, event, data) {
        if (!this.io) {
            logger_1.logger.warn(`[SocketService] Cannot emit to room "${room}": io not initialized`);
            return;
        }
        this.io.to(room).emit(event, data);
        logger_1.logger.debug(`[SocketService] Emitted "${event}" to room "${room}"`);
    }
    /**
     * Broadcast mission specific updates.
     */
    emitMissionUpdate(missionId, data) {
        this.emitToRoom(`mission:${missionId}`, 'mission:update', data);
    }
};
exports.SocketService = SocketService;
exports.SocketService = SocketService = __decorate([
    (0, inversify_1.injectable)()
], SocketService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxzZXJ2aWNlc1xcc29ja2V0LnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEseUNBQXVDO0FBQ3ZDLHlDQUFtQztBQUNuQyw0Q0FBeUM7QUFHbEMsSUFBTSxhQUFhLEdBQW5CLE1BQU0sYUFBYTtJQUNoQixFQUFFLEdBQWtCLElBQUksQ0FBQztJQUVqQzs7O09BR0c7SUFDSSxJQUFJLENBQUMsTUFBVztRQUNyQixJQUFJLE1BQU0sWUFBWSxrQkFBTSxFQUFFLENBQUM7WUFDN0IsSUFBSSxDQUFDLEVBQUUsR0FBRyxNQUFNLENBQUM7UUFDbkIsQ0FBQzthQUFNLENBQUM7WUFDTixJQUFJLENBQUMsRUFBRSxHQUFHLElBQUksa0JBQU0sQ0FBQyxNQUFNLEVBQUU7Z0JBQzNCLElBQUksRUFBRTtvQkFDSixNQUFNLEVBQUUsR0FBRyxFQUFFLG1CQUFtQjtvQkFDaEMsT0FBTyxFQUFFLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQztvQkFDeEIsV0FBVyxFQUFFLElBQUk7aUJBQ2xCO2FBQ0YsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUNELGVBQU0sQ0FBQyxJQUFJLENBQUMsMENBQTBDLENBQUMsQ0FBQztJQUMxRCxDQUFDO0lBRU0sS0FBSztRQUNWLE9BQU8sSUFBSSxDQUFDLEVBQUUsQ0FBQztJQUNqQixDQUFDO0lBRUQ7O09BRUc7SUFDSSxVQUFVLENBQUMsTUFBYyxFQUFFLEtBQWEsRUFBRSxJQUFTO1FBQ3hELElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxNQUFNLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDakQsQ0FBQztJQUVEOztPQUVHO0lBQ0ksSUFBSSxDQUFDLEtBQWEsRUFBRSxJQUFTO1FBQ2xDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDYixlQUFNLENBQUMsSUFBSSxDQUFDLHNDQUFzQyxLQUFLLHVCQUF1QixDQUFDLENBQUM7WUFDaEYsT0FBTztRQUNULENBQUM7UUFDRCxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDNUIsQ0FBQztJQUVEOztPQUVHO0lBQ0ksVUFBVSxDQUFDLElBQVksRUFBRSxLQUFhLEVBQUUsSUFBUztRQUN0RCxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO1lBQ2IsZUFBTSxDQUFDLElBQUksQ0FBQyx3Q0FBd0MsSUFBSSx1QkFBdUIsQ0FBQyxDQUFDO1lBQ2pGLE9BQU87UUFDVCxDQUFDO1FBQ0QsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNuQyxlQUFNLENBQUMsS0FBSyxDQUFDLDRCQUE0QixLQUFLLGNBQWMsSUFBSSxHQUFHLENBQUMsQ0FBQztJQUN2RSxDQUFDO0lBRUQ7O09BRUc7SUFDSSxpQkFBaUIsQ0FBQyxTQUFpQixFQUFFLElBQVM7UUFDbkQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLFNBQVMsRUFBRSxFQUFFLGdCQUFnQixFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ2xFLENBQUM7Q0FDRixDQUFBO0FBOURZLHNDQUFhO3dCQUFiLGFBQWE7SUFEekIsSUFBQSxzQkFBVSxHQUFFO0dBQ0EsYUFBYSxDQThEekIiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxzZXJ2aWNlc1xcc29ja2V0LnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaW5qZWN0YWJsZSB9IGZyb20gJ2ludmVyc2lmeSc7XG5pbXBvcnQgeyBTZXJ2ZXIgfSBmcm9tICdzb2NrZXQuaW8nO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi4vdXRpbHMvbG9nZ2VyJztcblxuQGluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFNvY2tldFNlcnZpY2Uge1xuICBwcml2YXRlIGlvOiBTZXJ2ZXIgfCBudWxsID0gbnVsbDtcblxuICAvKipcbiAgICogSW5pdGlhbGl6ZSB0aGUgU29ja2V0U2VydmljZSB3aXRoIHRoZSBTb2NrZXQuSU8gc2VydmVyIGluc3RhbmNlLlxuICAgKiBUaGlzIGlzIGNhbGxlZCBpbiBzZXJ2ZXIudHMgYWZ0ZXIgdGhlIHNlcnZlciBpcyBjcmVhdGVkLlxuICAgKi9cbiAgcHVibGljIGluaXQoc2VydmVyOiBhbnkpOiB2b2lkIHtcbiAgICBpZiAoc2VydmVyIGluc3RhbmNlb2YgU2VydmVyKSB7XG4gICAgICB0aGlzLmlvID0gc2VydmVyO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmlvID0gbmV3IFNlcnZlcihzZXJ2ZXIsIHtcbiAgICAgICAgY29yczoge1xuICAgICAgICAgIG9yaWdpbjogJyonLCAvLyBBZGp1c3QgYXMgbmVlZGVkXG4gICAgICAgICAgbWV0aG9kczogWydHRVQnLCAnUE9TVCddLFxuICAgICAgICAgIGNyZWRlbnRpYWxzOiB0cnVlLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfVxuICAgIGxvZ2dlci5pbmZvKCdbU29ja2V0U2VydmljZV0gSW5pdGlhbGl6ZWQgc3VjY2Vzc2Z1bGx5Jyk7XG4gIH1cblxuICBwdWJsaWMgZ2V0SU8oKTogU2VydmVyIHwgbnVsbCB7XG4gICAgcmV0dXJuIHRoaXMuaW87XG4gIH1cblxuICAvKipcbiAgICogRW1pdCBhbiBldmVudCB0byBhIHNwZWNpZmljIHVzZXIuXG4gICAqL1xuICBwdWJsaWMgZW1pdFRvVXNlcih1c2VySWQ6IHN0cmluZywgZXZlbnQ6IHN0cmluZywgZGF0YTogYW55KTogdm9pZCB7XG4gICAgdGhpcy5lbWl0VG9Sb29tKGB1c2VyOiR7dXNlcklkfWAsIGV2ZW50LCBkYXRhKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBFbWl0IGFuIGV2ZW50IHRvIGFsbCBjb25uZWN0ZWQgY2xpZW50cy5cbiAgICovXG4gIHB1YmxpYyBlbWl0KGV2ZW50OiBzdHJpbmcsIGRhdGE6IGFueSk6IHZvaWQge1xuICAgIGlmICghdGhpcy5pbykge1xuICAgICAgbG9nZ2VyLndhcm4oYFtTb2NrZXRTZXJ2aWNlXSBDYW5ub3QgZW1pdCBldmVudCBcIiR7ZXZlbnR9XCI6IGlvIG5vdCBpbml0aWFsaXplZGApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmlvLmVtaXQoZXZlbnQsIGRhdGEpO1xuICB9XG5cbiAgLyoqXG4gICAqIEVtaXQgYW4gZXZlbnQgdG8gYSBzcGVjaWZpYyByb29tIChlLmcuLCBhIHNwZWNpZmljIG1pc3Npb24gcm9vbSkuXG4gICAqL1xuICBwdWJsaWMgZW1pdFRvUm9vbShyb29tOiBzdHJpbmcsIGV2ZW50OiBzdHJpbmcsIGRhdGE6IGFueSk6IHZvaWQge1xuICAgIGlmICghdGhpcy5pbykge1xuICAgICAgbG9nZ2VyLndhcm4oYFtTb2NrZXRTZXJ2aWNlXSBDYW5ub3QgZW1pdCB0byByb29tIFwiJHtyb29tfVwiOiBpbyBub3QgaW5pdGlhbGl6ZWRgKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5pby50byhyb29tKS5lbWl0KGV2ZW50LCBkYXRhKTtcbiAgICBsb2dnZXIuZGVidWcoYFtTb2NrZXRTZXJ2aWNlXSBFbWl0dGVkIFwiJHtldmVudH1cIiB0byByb29tIFwiJHtyb29tfVwiYCk7XG4gIH1cblxuICAvKipcbiAgICogQnJvYWRjYXN0IG1pc3Npb24gc3BlY2lmaWMgdXBkYXRlcy5cbiAgICovXG4gIHB1YmxpYyBlbWl0TWlzc2lvblVwZGF0ZShtaXNzaW9uSWQ6IHN0cmluZywgZGF0YTogYW55KTogdm9pZCB7XG4gICAgdGhpcy5lbWl0VG9Sb29tKGBtaXNzaW9uOiR7bWlzc2lvbklkfWAsICdtaXNzaW9uOnVwZGF0ZScsIGRhdGEpO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=