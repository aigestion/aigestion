{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\middleware\\malware-scanner.middleware.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\middleware\\malware-scanner.middleware.ts"],"sourcesContent":["import { NextFunction, Request, Response } from 'express';\nimport multer from 'multer';\nimport path from 'path';\nimport { container, TYPES } from '../config/inversify.config';\nimport { MalwareScannerService } from '../services/malware-scanner.service';\nimport { logger } from '../utils/logger';\nimport { UserBehaviorService } from '../services/user-behavior.service';\nimport fs from 'fs/promises';\nimport { malwareScannerConfig } from '../config/malware-scanner.config';\n\n// Interface for internal use instead of extending express Global Request\ninterface FileScanResult {\n  originalname: string;\n  filename: string;\n  path: string;\n  size: number;\n  mimetype: string;\n  scanResult: any;\n  isClean: boolean;\n}\n\n/**\n * Middleware for scanning uploaded files for malware\n */\nexport class MalwareScannerMiddleware {\n  private _scanner: MalwareScannerService | undefined;\n  private uploadDir = malwareScannerConfig.uploadDir;\n\n  private get scanner(): MalwareScannerService {\n    return (this._scanner ??= container.get<MalwareScannerService>(TYPES.MalwareScannerService));\n  }\n\n  private get behaviorService(): UserBehaviorService {\n    return container.get<UserBehaviorService>(UserBehaviorService);\n  }\n\n  constructor() {\n    this.initializeUploadDir();\n  }\n\n  private async initializeUploadDir() {\n    try {\n      await fs.mkdir(this.uploadDir, { recursive: true });\n      logger.info('Upload directory initialized');\n    } catch (error) {\n      logger.error('Failed to initialize upload directory:', error);\n    }\n  }\n\n  /**\n   * Multer configuration for file uploads\n   */\n  public getMulterConfig() {\n    const storage = multer.diskStorage({\n      destination: (req, file, cb) => {\n        cb(null, this.uploadDir);\n      },\n      filename: (req, file, cb) => {\n        const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1e9);\n        const ext = path.extname(file.originalname);\n        cb(null, `${file.fieldname}-${uniqueSuffix}${ext}`);\n      },\n    });\n\n    const fileFilter = (req: any, file: any, cb: any) => {\n      // Check file size limit from config\n      if (file.size > malwareScannerConfig.maxFileSize) {\n        return cb(\n          new Error(\n            `File size exceeds ${malwareScannerConfig.maxFileSize / (1024 * 1024)}MB limit`,\n          ),\n        );\n      }\n\n      // Check allowed MIME types from config\n      if (malwareScannerConfig.allowedMimeTypes.includes(file.mimetype)) {\n        cb(null, true);\n      } else {\n        cb(new Error(`File type ${file.mimetype} is not allowed`));\n      }\n    };\n\n    return multer({\n      storage,\n      fileFilter,\n      limits: {\n        fileSize: malwareScannerConfig.maxFileSize,\n        files: malwareScannerConfig.maxFiles,\n      },\n    });\n  }\n\n  /**\n   * Middleware to scan uploaded files\n   */\n  public scanFiles = async (req: any, res: any, next: NextFunction) => {\n    const files = req.files;\n    if (!files || !Array.isArray(files) || files.length === 0) {\n      return next();\n    }\n\n    const scanResults: FileScanResult[] = [];\n    const userId = req.user?.id;\n\n    try {\n      // Scan each file\n      for (const file of files) {\n        logger.info('Scanning uploaded file', {\n          filename: file.filename,\n          originalname: file.originalname,\n          size: file.size,\n          mimetype: file.mimetype,\n        });\n\n        try {\n          const scanResult = await this.scanner.scanFile(file.path, userId);\n\n          const fileScanResult: FileScanResult = {\n            originalname: file.originalname,\n            filename: file.filename,\n            path: file.path,\n            size: file.size,\n            mimetype: file.mimetype,\n            scanResult,\n            isClean: !scanResult.isInfected,\n          };\n\n          scanResults.push(fileScanResult);\n\n          // If file is infected, remove it from uploads\n          if (scanResult.isInfected) {\n            // Track threat event\n            if (userId) {\n              await this.behaviorService.trackThreat(\n                userId,\n                file.originalname,\n                scanResult.threats,\n                this.getClientIP(req),\n              );\n            }\n\n            try {\n              await fs.unlink(file.path);\n              logger.warn('Infected file removed from uploads', {\n                filename: file.filename,\n                threats: scanResult.threats,\n              });\n            } catch (unlinkErr) {\n              logger.error('Failed to remove infected file:', unlinkErr);\n            }\n          }\n        } catch (error) {\n          logger.error('Error scanning file:', {\n            filename: file.filename,\n            error,\n          });\n\n          // Remove file if scan failed\n          try {\n            await fs.unlink(file.path);\n          } catch (unlinkErr) {\n            logger.error('Failed to remove file after scan error:', unlinkErr);\n          }\n\n          return res.status(500).json({\n            success: false,\n            error: 'File scan failed',\n            details: error instanceof Error ? error.message : 'Unknown error',\n          });\n        }\n      }\n\n      // Check if any files were infected\n      const infectedFiles = scanResults.filter(result => !result.isClean);\n\n      if (infectedFiles.length > 0) {\n        logger.warn('Malware detected in uploaded files, cleaning up all files in request', {\n          totalFiles: scanResults.length,\n          infectedFiles: infectedFiles.length,\n        });\n\n        // Cleanup ALL files for this request to prevent leaks\n        for (const fileItem of files) {\n          try {\n            await fs.unlink(fileItem.path);\n          } catch (unlinkErr) {\n            // File might already be unlinked if it was the infected one\n          }\n        }\n\n        return res.status(422).json({\n          success: false,\n          error: 'Malware detected',\n          message: `${infectedFiles.length} file(s) contained malware. All uploaded files for this request have been removed.`,\n          infectedFiles: infectedFiles.map(f => ({\n            originalname: f.originalname,\n            threats: f.scanResult.threats,\n          })),\n        });\n      }\n\n      // Attach scan results to request\n      req.fileScanResults = scanResults;\n\n      logger.info('All files scanned successfully', {\n        totalFiles: scanResults.length,\n        totalSize: scanResults.reduce((sum, f) => sum + f.size, 0),\n      });\n\n      next();\n    } catch (error) {\n      logger.error('Error in malware scan middleware:', error);\n\n      // Clean up all files if middleware fails\n      const uploadedFiles = req.files;\n      if (uploadedFiles && Array.isArray(uploadedFiles)) {\n        for (const fileItem of uploadedFiles) {\n          try {\n            await fs.unlink(fileItem.path);\n          } catch (unlinkErr) {\n            logger.error('Failed to cleanup file:', unlinkErr);\n          }\n        }\n      }\n\n      return res.status(500).json({\n        success: false,\n        error: 'File scan process failed',\n        details: error instanceof Error ? error.message : 'Unknown error',\n      });\n    }\n  };\n\n  /**\n   * Middleware for single file upload with scanning\n   */\n  public uploadSingle(field: string) {\n    const upload = this.getMulterConfig().single(field);\n\n    return async (req: any, res: any, next: NextFunction) => {\n      // First, handle the upload\n      upload(req, res, async err => {\n        if (err) {\n          logger.error('File upload error:', err);\n          return res.status(400).json({\n            success: false,\n            error: 'File upload failed',\n            details: err.message,\n          });\n        }\n\n        // Then scan the file if it exists\n        const file = req.file;\n        if (file) {\n          const userId = req.user?.id;\n\n          try {\n            const scanResult = await this.scanner.scanFile(file.path, userId);\n\n            if (scanResult.isInfected) {\n              // Track threat event\n              if (userId) {\n                await this.behaviorService.trackThreat(\n                  userId,\n                  file.originalname,\n                  scanResult.threats,\n                  this.getClientIP(req),\n                );\n              }\n\n              // Remove infected file\n              try {\n                await fs.unlink(file.path);\n              } catch (unlinkErr) {\n                logger.error('Failed to remove infected file:', unlinkErr);\n              }\n\n              return res.status(422).json({\n                success: false,\n                error: 'Malware detected',\n                message: 'Uploaded file contains malware and was removed',\n                threats: scanResult.threats,\n              });\n            }\n\n            // Attach scan result\n            req.fileScanResult = scanResult;\n            logger.info('File scanned successfully', {\n              filename: file.filename,\n              scanTime: scanResult.scanTime,\n            });\n          } catch (error) {\n            logger.error('Error scanning uploaded file:', error);\n\n            // Remove file if scan failed\n            try {\n              if (file) {\n                await fs.unlink(file.path);\n              }\n            } catch (unlinkErr) {\n              logger.error('Failed to remove file after scan error:', unlinkErr);\n            }\n\n            return res.status(500).json({\n              success: false,\n              error: 'File scan failed',\n              details: error instanceof Error ? error.message : 'Unknown error',\n            });\n          }\n        }\n\n        next();\n      });\n    };\n  }\n\n  /**\n   * Middleware for multiple file upload with scanning\n   */\n  public uploadMultiple(field: string, maxCount: number = 5) {\n    const upload = this.getMulterConfig().array(field, maxCount);\n\n    return async (req: any, res: any, next: NextFunction) => {\n      // First, handle the upload\n      upload(req, res, async err => {\n        if (err) {\n          logger.error('File upload error:', err);\n          return res.status(400).json({\n            success: false,\n            error: 'File upload failed',\n            details: err.message,\n          });\n        }\n\n        // Then scan files using the scanFiles middleware\n        this.scanFiles(req, res, next);\n      });\n    };\n  }\n\n  /**\n   * Get scanner statistics\n   */\n  public getScannerStats() {\n    return this.scanner.getScanStats();\n  }\n\n  /**\n   * Clear scanner cache\n   */\n  public clearCache() {\n    this.scanner.clearCache();\n  }\n\n  /**\n   * Get client IP address\n   */\n  private getClientIP(req: any): string {\n    return req.ip || req.connection?.remoteAddress || req.socket?.remoteAddress || 'unknown';\n  }\n}\n\n// Export singleton instance\nexport const malwareScanner = new MalwareScannerMiddleware();\n\n// Export convenience methods\nexport const uploadSingle = (field: string) => malwareScanner.uploadSingle(field);\nexport const uploadMultiple = (field: string, maxCount?: number) =>\n  malwareScanner.uploadMultiple(field, maxCount);\nexport const scanUploadedFiles = malwareScanner.scanFiles;\n"],"version":3}