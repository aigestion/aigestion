ce56f03d915146bce24f794c8f342529
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var _a, _b, _c;
Object.defineProperty(exports, "__esModule", { value: true });
exports.YoutubeWatcherService = void 0;
const inversify_1 = require("inversify");
const chokidar = __importStar(require("chokidar"));
const fs = __importStar(require("fs"));
const path = __importStar(require("path"));
const env_schema_1 = require("../config/env.schema");
const youtube_transcription_queue_1 = require("../queue/youtube-transcription.queue");
const youtube_channel_service_1 = require("../services/google/youtube-channel.service");
const telegram_service_1 = require("../services/telegram.service");
const logger_1 = require("../utils/logger");
const types_1 = require("../types");
const VIDEO_EXTENSIONS = ['.mp4', '.mov', '.avi', '.mkv'];
/**
 * Servicio de vigilancia de carpeta para archivos de YouTube
 */
let YoutubeWatcherService = class YoutubeWatcherService {
    youtubeTranscriptionQueue;
    youtubeChannelService;
    telegramService;
    watcher = null;
    watchPath;
    processedPath;
    recipientEmail;
    constructor(youtubeTranscriptionQueue, youtubeChannelService, telegramService) {
        this.youtubeTranscriptionQueue = youtubeTranscriptionQueue;
        this.youtubeChannelService = youtubeChannelService;
        this.telegramService = telegramService;
        // La carpeta a vigilar estÃ¡ en la raÃ­z del proyecto NEXUS V1
        const projectRoot = path.resolve(__dirname, '../../../../');
        this.watchPath = path.join(projectRoot, 'youtube', 'Videos.Transcripcion');
        this.processedPath = path.join(this.watchPath, 'processed');
        // Email del destinatario (puede ser configurado via variable de entorno)
        this.recipientEmail = process.env.YOUTUBE_TRANSCRIPTION_EMAIL || env_schema_1.env.EMAIL_FROM;
    }
    /**
     * Asegura que las carpetas necesarias existan
     */
    ensureDirectories() {
        if (!fs.existsSync(this.watchPath)) {
            fs.mkdirSync(this.watchPath, { recursive: true });
            logger_1.logger.info(`Carpeta creada: ${this.watchPath}`);
        }
        if (!fs.existsSync(this.processedPath)) {
            fs.mkdirSync(this.processedPath, { recursive: true });
            logger_1.logger.info(`Carpeta creada: ${this.processedPath}`);
        }
    }
    /**
     * Extrae la URL del video desde un archivo de texto
     */
    extractVideoUrl(filePath) {
        try {
            const content = fs.readFileSync(filePath, 'utf-8').trim();
            // Validar que parece ser una URL de YouTube
            if (content.includes('youtube.com') || content.includes('youtu.be')) {
                // Extraer la primera lÃ­nea que contenga una URL
                const lines = content.split('\n');
                for (const line of lines) {
                    const trimmed = line.trim();
                    if (trimmed.includes('youtube.com') || trimmed.includes('youtu.be')) {
                        return trimmed;
                    }
                }
            }
            return null;
        }
        catch (error) {
            logger_1.logger.error(error, `Error leyendo archivo ${filePath}`);
            return null;
        }
    }
    /**
     * Mueve el archivo procesado a la carpeta processed/
     */
    moveToProcessed(filePath) {
        try {
            const fileName = path.basename(filePath);
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const newFileName = `${timestamp}_${fileName}`;
            const newPath = path.join(this.processedPath, newFileName);
            fs.renameSync(filePath, newPath);
            logger_1.logger.info(`Archivo movido a processed: ${newFileName}`);
        }
        catch (error) {
            logger_1.logger.error(error, `Error moviendo archivo ${filePath}`);
        }
    }
    /**
     * Procesa un nuevo archivo detectado
     */
    async processFile(filePath) {
        const fileName = path.basename(filePath);
        // Ignorar archivos temporales o del sistema
        if (fileName.startsWith('.') || fileName.startsWith('~')) {
            return;
        }
        // Soporte para archivos de texto (URL)
        if (path.extname(filePath) === '.txt') {
            await this.processTxtFile(filePath, fileName);
            return;
        }
        // Soporte para archivos de video (Upload)
        if (VIDEO_EXTENSIONS.includes(path.extname(filePath).toLowerCase())) {
            await this.processVideoFile(filePath, fileName);
            return;
        }
        logger_1.logger.debug(`Archivo ignorado (extensiÃ³n no soportada): ${fileName}`);
    }
    /**
     * Procesa un archivo .txt que contiene una URL de YouTube
     */
    async processTxtFile(filePath, fileName) {
        logger_1.logger.info(`Analizando archivo de texto: ${fileName}`);
        // PequeÃ±a demora para asegurar que el archivo se terminÃ³ de escribir
        await new Promise(resolve => setTimeout(resolve, 500));
        // Extraer URL del video
        const videoUrl = this.extractVideoUrl(filePath);
        if (!videoUrl) {
            logger_1.logger.warn(`No se encontrÃ³ una URL de YouTube vÃ¡lida en: ${fileName}`);
            return;
        }
        logger_1.logger.info(`URL de YouTube detectada: ${videoUrl}`);
        // Crear job de transcripciÃ³n
        const job = {
            videoUrl,
            recipientEmail: this.recipientEmail,
            fileName,
            timestamp: new Date().toISOString(),
        };
        // Encolar el job
        const enqueued = await this.youtubeTranscriptionQueue.publishTranscriptionJob(job);
        if (enqueued) {
            logger_1.logger.info(`Job encolado exitosamente para: ${fileName}`);
            this.moveToProcessed(filePath);
        }
    }
    /**
     * Sube un video local a AIGestion y luego encola su transcripciÃ³n
     */
    async processVideoFile(filePath, fileName) {
        logger_1.logger.info(`ðŸš€ Iniciando carga premium de video: ${fileName}`);
        try {
            // 1. Subir a YouTube (Canal AIGestion)
            const videoId = await this.youtubeChannelService.uploadVideo({
                channelType: 'business',
                filePath: filePath,
                metadata: {
                    title: path.parse(fileName).name, // Nombre del archivo sin extensiÃ³n
                    description: 'Video procesado automÃ¡ticamente por AIGestion (NEXUS V1)',
                    tags: ['AIGestion', 'Automation', 'Tutorial'],
                    categoryId: '27', // Education
                    privacyStatus: 'unlisted', // Por defecto oculto por privacidad
                },
            });
            // 2. AÃ±adir a la lista de Tutoriales
            const playlistId = await this.youtubeChannelService.findPlaylistByName('business', 'Tutoriales');
            if (playlistId) {
                await this.youtubeChannelService.addVideoToPlaylist('business', videoId, playlistId);
                logger_1.logger.info(`Video aÃ±adido a la playlist Tutoriales: ${playlistId}`);
            }
            const videoUrl = `https://www.youtube.com/watch?v=${videoId}`;
            logger_1.logger.info(`Video subido exitosamente: ${videoUrl}`);
            // 3. Encolar transcripciÃ³n (usaremos la URL generada)
            const job = {
                videoUrl,
                recipientEmail: this.recipientEmail,
                fileName,
                timestamp: new Date().toISOString(),
            };
            const enqueued = await youtubeTranscriptionQueue.publishTranscriptionJob(job);
            if (enqueued) {
                logger_1.logger.info(`Job de transcripciÃ³n encolado para video subido: ${fileName}`);
                this.moveToProcessed(filePath);
                // 4. NotificaciÃ³n Premium por Telegram
                try {
                    const adminChatId = process.env.TELEGRAM_ADMIN_CHAT_ID || process.env.TELEGRAM_CHAT_ID;
                    if (adminChatId) {
                        const message = `ðŸŽ¬ *NEXUS V1: Video Automatizado*\n\n` +
                            `âœ… *Archivo:* \`${fileName}\` subido exitosamente.\n` +
                            `ðŸ’Ž *Canal:* AIGestion (Empresa)\n` +
                            `ðŸ“Œ *Playlist:* Tutoriales\n` +
                            `ðŸ”— *URL:* ${videoUrl}\n\n` +
                            `ðŸ“ _La transcripciÃ³n se estÃ¡ procesando y se incluirÃ¡ en el prÃ³ximo Briefing._`;
                        await this.telegramService.sendMessage(adminChatId, message);
                        logger_1.logger.info('NotificaciÃ³n de Telegram enviada exitosamente.');
                    }
                }
                catch (msgError) {
                    logger_1.logger.error(msgError, 'Error enviando notificaciÃ³n de Telegram');
                }
            }
        }
        catch (error) {
            logger_1.logger.error(error, `Error durante la automatizaciÃ³n premium del video ${fileName}`);
        }
    }
    /**
     * Inicia el servicio de vigilancia
     */
    start() {
        this.ensureDirectories();
        logger_1.logger.info(`Iniciando vigilancia de carpeta: ${this.watchPath}`);
        logger_1.logger.info(`Email de destino: ${this.recipientEmail}`);
        this.watcher = chokidar.watch(this.watchPath, {
            ignored: path => [
                /(^|[\/\\])\../, // Archivos ocultos
                /processed/, // Carpeta processed
                /README\.md/, // README
            ].some(pattern => pattern.test(path)),
            persistent: true,
            ignoreInitial: true, // No procesar archivos existentes al iniciar
            awaitWriteFinish: {
                stabilityThreshold: 1000,
                pollInterval: 100,
            },
        });
        this.watcher
            .on('add', filePath => {
            this.processFile(filePath).catch((error) => {
                logger_1.logger.error(error, `Error procesando archivo ${filePath}`);
            });
        })
            .on('error', (error) => {
            logger_1.logger.error(error, 'Error en el watcher');
        })
            .on('ready', () => {
            logger_1.logger.info('âœ… Watcher de YouTube listo. Esperando archivos...');
        });
    }
    /**
     * Detiene el servicio de vigilancia
     */
    async stop() {
        if (this.watcher) {
            await this.watcher.close();
            this.watcher = null;
            logger_1.logger.info('Watcher de YouTube detenido');
        }
    }
    /**
     * Obtiene el estado del watcher
     */
    getStatus() {
        return {
            isRunning: this.watcher !== null,
            watchPath: this.watchPath,
            recipientEmail: this.recipientEmail,
        };
    }
};
exports.YoutubeWatcherService = YoutubeWatcherService;
exports.YoutubeWatcherService = YoutubeWatcherService = __decorate([
    (0, inversify_1.injectable)(),
    __param(0, (0, inversify_1.inject)(types_1.TYPES.YoutubeTranscriptionQueue)),
    __param(1, (0, inversify_1.inject)(types_1.TYPES.YoutubeChannelService)),
    __param(2, (0, inversify_1.inject)(types_1.TYPES.TelegramService)),
    __metadata("design:paramtypes", [typeof (_a = typeof youtube_transcription_queue_1.YoutubeTranscriptionQueue !== "undefined" && youtube_transcription_queue_1.YoutubeTranscriptionQueue) === "function" ? _a : Object, typeof (_b = typeof youtube_channel_service_1.YouTubeChannelService !== "undefined" && youtube_channel_service_1.YouTubeChannelService) === "function" ? _b : Object, typeof (_c = typeof telegram_service_1.TelegramService !== "undefined" && telegram_service_1.TelegramService) === "function" ? _c : Object])
], YoutubeWatcherService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFx1dGlsc1xceW91dHViZS13YXRjaGVyLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFDLHlDQUErQztBQUNoRCxtREFBcUM7QUFDckMsdUNBQXlCO0FBQ3pCLDJDQUE2QjtBQUU3QixxREFBMkM7QUFDM0Msc0ZBQW1HO0FBQ25HLHdGQUFtRjtBQUNuRixtRUFBK0Q7QUFDL0QsNENBQXlDO0FBQ3pDLG9DQUFpQztBQUVqQyxNQUFNLGdCQUFnQixHQUFHLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFFMUQ7O0dBRUc7QUFFSSxJQUFNLHFCQUFxQixHQUEzQixNQUFNLHFCQUFxQjtJQVF0QjtJQUNxQztJQUNOO0lBVGpDLE9BQU8sR0FBOEIsSUFBSSxDQUFDO0lBQzFDLFNBQVMsQ0FBUztJQUNsQixhQUFhLENBQVM7SUFDdEIsY0FBYyxDQUFTO0lBRS9CLFlBRVUseUJBQW9ELEVBQ2YscUJBQTRDLEVBQ2xELGVBQWdDO1FBRi9ELDhCQUF5QixHQUF6Qix5QkFBeUIsQ0FBMkI7UUFDZiwwQkFBcUIsR0FBckIscUJBQXFCLENBQXVCO1FBQ2xELG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQUV2RSw2REFBNkQ7UUFDN0QsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsY0FBYyxDQUFDLENBQUM7UUFDNUQsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxTQUFTLEVBQUUsc0JBQXNCLENBQUMsQ0FBQztRQUMzRSxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxXQUFXLENBQUMsQ0FBQztRQUU1RCx5RUFBeUU7UUFDekUsSUFBSSxDQUFDLGNB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WUFDaEMsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTO1lBQ3pCLGNBQWMsRUFBRSxJQUFJLENBQUMsY0FBYztTQUNwQyxDQUFDO0lBQ0osQ0FBQztDQUNGLENBQUE7QUFwUlksc0RBQXFCO2dDQUFyQixxQkFBcUI7SUFEakMsSUFBQSxzQkFBVSxHQUFFO0lBUVIsV0FBQSxJQUFBLGtCQUFNLEVBQUMsYUFBSyxDQUFDLHlCQUF5QixDQUFDLENBQUE7SUFFdkMsV0FBQSxJQUFBLGtCQUFNLEVBQUMsYUFBSyxDQUFDLHFCQUFxQixDQUFDLENBQUE7SUFDbkMsV0FBQSxJQUFBLGtCQUFNLEVBQUMsYUFBSyxDQUFDLGVBQWUsQ0FBQyxDQUFBO3lEQUZLLHVEQUF5QixvQkFBekIsdURBQXlCLG9EQUNRLCtDQUFxQixvQkFBckIsK0NBQXFCLG9EQUNqQyxrQ0FBZSxvQkFBZixrQ0FBZTtHQVY5RCxxQkFBcUIsQ0FvUmpDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcQWxlamFuZHJvXFxBSUdlc3Rpb25cXGJhY2tlbmRcXHNyY1xcdXRpbHNcXHlvdXR1YmUtd2F0Y2hlci5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIu+7v2ltcG9ydCB7IGluamVjdGFibGUsIGluamVjdCB9IGZyb20gJ2ludmVyc2lmeSc7XG5pbXBvcnQgKiBhcyBjaG9raWRhciBmcm9tICdjaG9raWRhcic7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuXG5pbXBvcnQgeyBlbnYgfSBmcm9tICcuLi9jb25maWcvZW52LnNjaGVtYSc7XG5pbXBvcnQgeyBUcmFuc2NyaXB0aW9uSm9iLCBZb3V0dWJlVHJhbnNjcmlwdGlvblF1ZXVlIH0gZnJvbSAnLi4vcXVldWUveW91dHViZS10cmFuc2NyaXB0aW9uLnF1ZXVlJztcbmltcG9ydCB7IFlvdVR1YmVDaGFubmVsU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL2dvb2dsZS95b3V0dWJlLWNoYW5uZWwuc2VydmljZSc7XG5pbXBvcnQgeyBUZWxlZ3JhbVNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy90ZWxlZ3JhbS5zZXJ2aWNlJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uL3V0aWxzL2xvZ2dlcic7XG5pbXBvcnQgeyBUWVBFUyB9IGZyb20gJy4uL3R5cGVzJztcblxuY29uc3QgVklERU9fRVhURU5TSU9OUyA9IFsnLm1wNCcsICcubW92JywgJy5hdmknLCAnLm1rdiddO1xuXG4vKipcbiAqIFNlcnZpY2lvIGRlIHZpZ2lsYW5jaWEgZGUgY2FycGV0YSBwYXJhIGFyY2hpdm9zIGRlIFlvdVR1YmVcbiAqL1xuQGluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFlvdXR1YmVXYXRjaGVyU2VydmljZSB7XG4gIHByaXZhdGUgd2F0Y2hlcjogY2hva2lkYXIuRlNXYXRjaGVyIHwgbnVsbCA9IG51bGw7XG4gIHByaXZhdGUgd2F0Y2hQYXRoOiBzdHJpbmc7XG4gIHByaXZhdGUgcHJvY2Vzc2VkUGF0aDogc3RyaW5nO1xuICBwcml2YXRlIHJlY2lwaWVudEVtYWlsOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQGluamVjdChUWVBFUy5Zb3V0dWJlVHJhbnNjcmlwdGlvblF1ZXVlKVxuICAgIHByaXZhdGUgeW91dHViZVRyYW5zY3JpcHRpb25RdWV1ZTogWW91dHViZVRyYW5zY3JpcHRpb25RdWV1ZSxcbiAgICBAaW5qZWN0KFRZUEVTLllvdXR1YmVDaGFubmVsU2VydmljZSkgcHJpdmF0ZSB5b3V0dWJlQ2hhbm5lbFNlcnZpY2U6IFlvdVR1YmVDaGFubmVsU2VydmljZSxcbiAgICBAaW5qZWN0KFRZUEVTLlRlbGVncmFtU2VydmljZSkgcHJpdmF0ZSB0ZWxlZ3JhbVNlcnZpY2U6IFRlbGVncmFtU2VydmljZSxcbiAgKSB7XG4gICAgLy8gTGEgY2FycGV0YSBhIHZpZ2lsYXIgZXN0w6EgZW4gbGEgcmHDrXogZGVsIHByb3llY3RvIE5FWFVTIFYxXG4gICAgY29uc3QgcHJvamVjdFJvb3QgPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4vLi4vLi4vLi4vJyk7XG4gICAgdGhpcy53YXRjaFBhdGggPSBwYXRoLmpvaW4ocHJvamVjdFJvb3QsICd5b3V0dWJlJywgJ1ZpZGVvcy5UcmFuc2NyaXBjaW9uJyk7XG4gICAgdGhpcy5wcm9jZXNzZWRQYXRoID0gcGF0aC5qb2luKHRoaXMud2F0Y2hQYXRoLCAncHJvY2Vzc2VkJyk7XG5cbiAgICAvLyBFbWFpbCBkZWwgZGVzdGluYXRhcmlvIChwdWVkZSBzZXIgY29uZmlndXJhZG8gdmlhIHZhcmlhYmxlIGRlIGVudG9ybm8pXG4gICAgdGhpcy5yZWNpcGllbnRFbWFpbCA9IHByb2Nlc3MuZW52LllPVVRVQkVfVFJBTlNDUklQVElPTl9FTUFJTCB8fCBlbnYuRU1BSUxfRlJPTTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBc2VndXJhIHF1ZSBsYXMgY2FycGV0YXMgbmVjZXNhcmlhcyBleGlzdGFuXG4gICAqL1xuICBwcml2YXRlIGVuc3VyZURpcmVjdG9yaWVzKCk6IHZvaWQge1xuICAgIGlmICghZnMuZXhpc3RzU3luYyh0aGlzLndhdGNoUGF0aCkpIHtcbiAgICAgIGZzLm1rZGlyU3luYyh0aGlzLndhdGNoUGF0aCwgeyByZWN1cnNpdmU6IHRydWUgfSk7XG4gICAgICBsb2dnZXIuaW5mbyhgQ2FycGV0YSBjcmVhZGE6ICR7dGhpcy53YXRjaFBhdGh9YCk7XG4gICAgfVxuXG4gICAgaWYgKCFmcy5leGlzdHNTeW5jKHRoaXMucHJvY2Vzc2VkUGF0aCkpIHtcbiAgICAgIGZzLm1rZGlyU3luYyh0aGlzLnByb2Nlc3NlZFBhdGgsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuICAgICAgbG9nZ2VyLmluZm8oYENhcnBldGEgY3JlYWRhOiAke3RoaXMucHJvY2Vzc2VkUGF0aH1gKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRXh0cmFlIGxhIFVSTCBkZWwgdmlkZW8gZGVzZGUgdW4gYXJjaGl2byBkZSB0ZXh0b1xuICAgKi9cbiAgcHJpdmF0ZSBleHRyYWN0VmlkZW9VcmwoZmlsZVBhdGg6IHN0cmluZyk6IHN0cmluZyB8IG51bGwge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBjb250ZW50ID0gZnMucmVhZEZpbGVTeW5jKGZpbGVQYXRoLCAndXRmLTgnKS50cmltKCk7XG5cbiAgICAgIC8vIFZhbGlkYXIgcXVlIHBhcmVjZSBzZXIgdW5hIFVSTCBkZSBZb3VUdWJlXG4gICAgICBpZiAoY29udGVudC5pbmNsdWRlcygneW91dHViZS5jb20nKSB8fCBjb250ZW50LmluY2x1ZGVzKCd5b3V0dS5iZScpKSB7XG4gICAgICAgIC8vIEV4dHJhZXIgbGEgcHJpbWVyYSBsw61uZWEgcXVlIGNvbnRlbmdhIHVuYSBVUkxcbiAgICAgICAgY29uc3QgbGluZXMgPSBjb250ZW50LnNwbGl0KCdcXG4nKTtcbiAgICAgICAgZm9yIChjb25zdCBsaW5lIG9mIGxpbmVzKSB7XG4gICAgICAgICAgY29uc3QgdHJpbW1lZCA9IGxpbmUudHJpbSgpO1xuICAgICAgICAgIGlmICh0cmltbWVkLmluY2x1ZGVzKCd5b3V0dWJlLmNvbScpIHx8IHRyaW1tZWQuaW5jbHVkZXMoJ3lvdXR1LmJlJykpIHtcbiAgICAgICAgICAgIHJldHVybiB0cmltbWVkO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBsb2dnZXIuZXJyb3IoZXJyb3IsIGBFcnJvciBsZXllbmRvIGFyY2hpdm8gJHtmaWxlUGF0aH1gKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBNdWV2ZSBlbCBhcmNoaXZvIHByb2Nlc2FkbyBhIGxhIGNhcnBldGEgcHJvY2Vzc2VkL1xuICAgKi9cbiAgcHJpdmF0ZSBtb3ZlVG9Qcm9jZXNzZWQoZmlsZVBhdGg6IHN0cmluZyk6IHZvaWQge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBmaWxlTmFtZSA9IHBhdGguYmFzZW5hbWUoZmlsZVBhdGgpO1xuICAgICAgY29uc3QgdGltZXN0YW1wID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpLnJlcGxhY2UoL1s6Ll0vZywgJy0nKTtcbiAgICAgIGNvbnN0IG5ld0ZpbGVOYW1lID0gYCR7dGltZXN0YW1wfV8ke2ZpbGVOYW1lfWA7XG4gICAgICBjb25zdCBuZXdQYXRoID0gcGF0aC5qb2luKHRoaXMucHJvY2Vzc2VkUGF0aCwgbmV3RmlsZU5hbWUpO1xuXG4gICAgICBmcy5yZW5hbWVTeW5jKGZpbGVQYXRoLCBuZXdQYXRoKTtcbiAgICAgIGxvZ2dlci5pbmZvKGBBcmNoaXZvIG1vdmlkbyBhIHByb2Nlc3NlZDogJHtuZXdGaWxlTmFtZX1gKTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBsb2dnZXIuZXJyb3IoZXJyb3IsIGBFcnJvciBtb3ZpZW5kbyBhcmNoaXZvICR7ZmlsZVBhdGh9YCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFByb2Nlc2EgdW4gbnVldm8gYXJjaGl2byBkZXRlY3RhZG9cbiAgICovXG4gIHByaXZhdGUgYXN5bmMgcHJvY2Vzc0ZpbGUoZmlsZVBhdGg6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGZpbGVOYW1lID0gcGF0aC5iYXNlbmFtZShmaWxlUGF0aCk7XG5cbiAgICAvLyBJZ25vcmFyIGFyY2hpdm9zIHRlbXBvcmFsZXMgbyBkZWwgc2lzdGVtYVxuICAgIGlmIChmaWxlTmFtZS5zdGFydHNXaXRoKCcuJykgfHwgZmlsZU5hbWUuc3RhcnRzV2l0aCgnficpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gU29wb3J0ZSBwYXJhIGFyY2hpdm9zIGRlIHRleHRvIChVUkwpXG4gICAgaWYgKHBhdGguZXh0bmFtZShmaWxlUGF0aCkgPT09ICcudHh0Jykge1xuICAgICAgYXdhaXQgdGhpcy5wcm9jZXNzVHh0RmlsZShmaWxlUGF0aCwgZmlsZU5hbWUpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIFNvcG9ydGUgcGFyYSBhcmNoaXZvcyBkZSB2aWRlbyAoVXBsb2FkKVxuICAgIGlmIChWSURFT19FWFRFTlNJT05TLmluY2x1ZGVzKHBhdGguZXh0bmFtZShmaWxlUGF0aCkudG9Mb3dlckNhc2UoKSkpIHtcbiAgICAgIGF3YWl0IHRoaXMucHJvY2Vzc1ZpZGVvRmlsZShmaWxlUGF0aCwgZmlsZU5hbWUpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxvZ2dlci5kZWJ1ZyhgQXJjaGl2byBpZ25vcmFkbyAoZXh0ZW5zacOzbiBubyBzb3BvcnRhZGEpOiAke2ZpbGVOYW1lfWApO1xuICB9XG5cbiAgLyoqXG4gICAqIFByb2Nlc2EgdW4gYXJjaGl2byAudHh0IHF1ZSBjb250aWVuZSB1bmEgVVJMIGRlIFlvdVR1YmVcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgcHJvY2Vzc1R4dEZpbGUoZmlsZVBhdGg6IHN0cmluZywgZmlsZU5hbWU6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGxvZ2dlci5pbmZvKGBBbmFsaXphbmRvIGFyY2hpdm8gZGUgdGV4dG86ICR7ZmlsZU5hbWV9YCk7XG5cbiAgICAvLyBQZXF1ZcOxYSBkZW1vcmEgcGFyYSBhc2VndXJhciBxdWUgZWwgYXJjaGl2byBzZSB0ZXJtaW7DsyBkZSBlc2NyaWJpclxuICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCA1MDApKTtcblxuICAgIC8vIEV4dHJhZXIgVVJMIGRlbCB2aWRlb1xuICAgIGNvbnN0IHZpZGVvVXJsID0gdGhpcy5leHRyYWN0VmlkZW9VcmwoZmlsZVBhdGgpO1xuXG4gICAgaWYgKCF2aWRlb1VybCkge1xuICAgICAgbG9nZ2VyLndhcm4oYE5vIHNlIGVuY29udHLDsyB1bmEgVVJMIGRlIFlvdVR1YmUgdsOhbGlkYSBlbjogJHtmaWxlTmFtZX1gKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsb2dnZXIuaW5mbyhgVVJMIGRlIFlvdVR1YmUgZGV0ZWN0YWRhOiAke3ZpZGVvVXJsfWApO1xuXG4gICAgLy8gQ3JlYXIgam9iIGRlIHRyYW5zY3JpcGNpw7NuXG4gICAgY29uc3Qgam9iOiBUcmFuc2NyaXB0aW9uSm9iID0ge1xuICAgICAgdmlkZW9VcmwsXG4gICAgICByZWNpcGllbnRFbWFpbDogdGhpcy5yZWNpcGllbnRFbWFpbCxcbiAgICAgIGZpbGVOYW1lLFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgfTtcblxuICAgIC8vIEVuY29sYXIgZWwgam9iXG4gICAgY29uc3QgZW5xdWV1ZWQgPSBhd2FpdCB0aGlzLnlvdXR1YmVUcmFuc2NyaXB0aW9uUXVldWUucHVibGlzaFRyYW5zY3JpcHRpb25Kb2Ioam9iKTtcblxuICAgIGlmIChlbnF1ZXVlZCkge1xuICAgICAgbG9nZ2VyLmluZm8oYEpvYiBlbmNvbGFkbyBleGl0b3NhbWVudGUgcGFyYTogJHtmaWxlTmFtZX1gKTtcbiAgICAgIHRoaXMubW92ZVRvUHJvY2Vzc2VkKGZpbGVQYXRoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU3ViZSB1biB2aWRlbyBsb2NhbCBhIEFJR2VzdGlvbiB5IGx1ZWdvIGVuY29sYSBzdSB0cmFuc2NyaXBjacOzblxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBwcm9jZXNzVmlkZW9GaWxlKGZpbGVQYXRoOiBzdHJpbmcsIGZpbGVOYW1lOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBsb2dnZXIuaW5mbyhg8J+agCBJbmljaWFuZG8gY2FyZ2EgcHJlbWl1bSBkZSB2aWRlbzogJHtmaWxlTmFtZX1gKTtcblxuICAgIHRyeSB7XG4gICAgICAvLyAxLiBTdWJpciBhIFlvdVR1YmUgKENhbmFsIEFJR2VzdGlvbilcbiAgICAgIGNvbnN0IHZpZGVvSWQgPSBhd2FpdCB0aGlzLnlvdXR1YmVDaGFubmVsU2VydmljZS51cGxvYWRWaWRlbyh7XG4gICAgICAgIGNoYW5uZWxUeXBlOiAnYnVzaW5lc3MnLFxuICAgICAgICBmaWxlUGF0aDogZmlsZVBhdGgsXG4gICAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgICAgdGl0bGU6IHBhdGgucGFyc2UoZmlsZU5hbWUpLm5hbWUsIC8vIE5vbWJyZSBkZWwgYXJjaGl2byBzaW4gZXh0ZW5zacOzblxuICAgICAgICAgIGRlc2NyaXB0aW9uOiAnVmlkZW8gcHJvY2VzYWRvIGF1dG9tw6F0aWNhbWVudGUgcG9yIEFJR2VzdGlvbiAoTkVYVVMgVjEpJyxcbiAgICAgICAgICB0YWdzOiBbJ0FJR2VzdGlvbicsICdBdXRvbWF0aW9uJywgJ1R1dG9yaWFsJ10sXG4gICAgICAgICAgY2F0ZWdvcnlJZDogJzI3JywgLy8gRWR1Y2F0aW9uXG4gICAgICAgICAgcHJpdmFjeVN0YXR1czogJ3VubGlzdGVkJywgLy8gUG9yIGRlZmVjdG8gb2N1bHRvIHBvciBwcml2YWNpZGFkXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgLy8gMi4gQcOxYWRpciBhIGxhIGxpc3RhIGRlIFR1dG9yaWFsZXNcbiAgICAgIGNvbnN0IHBsYXlsaXN0SWQgPSBhd2FpdCB0aGlzLnlvdXR1YmVDaGFubmVsU2VydmljZS5maW5kUGxheWxpc3RCeU5hbWUoXG4gICAgICAgICdidXNpbmVzcycsXG4gICAgICAgICdUdXRvcmlhbGVzJyxcbiAgICAgICk7XG4gICAgICBpZiAocGxheWxpc3RJZCkge1xuICAgICAgICBhd2FpdCB0aGlzLnlvdXR1YmVDaGFubmVsU2VydmljZS5hZGRWaWRlb1RvUGxheWxpc3QoJ2J1c2luZXNzJywgdmlkZW9JZCwgcGxheWxpc3RJZCk7XG4gICAgICAgIGxvZ2dlci5pbmZvKGBWaWRlbyBhw7FhZGlkbyBhIGxhIHBsYXlsaXN0IFR1dG9yaWFsZXM6ICR7cGxheWxpc3RJZH1gKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgdmlkZW9VcmwgPSBgaHR0cHM6Ly93d3cueW91dHViZS5jb20vd2F0Y2g/dj0ke3ZpZGVvSWR9YDtcbiAgICAgIGxvZ2dlci5pbmZvKGBWaWRlbyBzdWJpZG8gZXhpdG9zYW1lbnRlOiAke3ZpZGVvVXJsfWApO1xuXG4gICAgICAvLyAzLiBFbmNvbGFyIHRyYW5zY3JpcGNpw7NuICh1c2FyZW1vcyBsYSBVUkwgZ2VuZXJhZGEpXG4gICAgICBjb25zdCBqb2I6IFRyYW5zY3JpcHRpb25Kb2IgPSB7XG4gICAgICAgIHZpZGVvVXJsLFxuICAgICAgICByZWNpcGllbnRFbWFpbDogdGhpcy5yZWNpcGllbnRFbWFpbCxcbiAgICAgICAgZmlsZU5hbWUsXG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgfTtcblxuICAgICAgY29uc3QgZW5xdWV1ZWQgPSBhd2FpdCB5b3V0dWJlVHJhbnNjcmlwdGlvblF1ZXVlLnB1Ymxpc2hUcmFuc2NyaXB0aW9uSm9iKGpvYik7XG5cbiAgICAgIGlmIChlbnF1ZXVlZCkge1xuICAgICAgICBsb2dnZXIuaW5mbyhgSm9iIGRlIHRyYW5zY3JpcGNpw7NuIGVuY29sYWRvIHBhcmEgdmlkZW8gc3ViaWRvOiAke2ZpbGVOYW1lfWApO1xuICAgICAgICB0aGlzLm1vdmVUb1Byb2Nlc3NlZChmaWxlUGF0aCk7XG5cbiAgICAgICAgLy8gNC4gTm90aWZpY2FjacOzbiBQcmVtaXVtIHBvciBUZWxlZ3JhbVxuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IGFkbWluQ2hhdElkID0gcHJvY2Vzcy5lbnYuVEVMRUdSQU1fQURNSU5fQ0hBVF9JRCB8fCBwcm9jZXNzLmVudi5URUxFR1JBTV9DSEFUX0lEO1xuXG4gICAgICAgICAgaWYgKGFkbWluQ2hhdElkKSB7XG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlID1cbiAgICAgICAgICAgICAgYPCfjqwgKk5FWFVTIFYxOiBWaWRlbyBBdXRvbWF0aXphZG8qXFxuXFxuYCArXG4gICAgICAgICAgICAgIGDinIUgKkFyY2hpdm86KiBcXGAke2ZpbGVOYW1lfVxcYCBzdWJpZG8gZXhpdG9zYW1lbnRlLlxcbmAgK1xuICAgICAgICAgICAgICBg8J+SjiAqQ2FuYWw6KiBBSUdlc3Rpb24gKEVtcHJlc2EpXFxuYCArXG4gICAgICAgICAgICAgIGDwn5OMICpQbGF5bGlzdDoqIFR1dG9yaWFsZXNcXG5gICtcbiAgICAgICAgICAgICAgYPCflJcgKlVSTDoqICR7dmlkZW9Vcmx9XFxuXFxuYCArXG4gICAgICAgICAgICAgIGDwn5OdIF9MYSB0cmFuc2NyaXBjacOzbiBzZSBlc3TDoSBwcm9jZXNhbmRvIHkgc2UgaW5jbHVpcsOhIGVuIGVsIHByw7N4aW1vIEJyaWVmaW5nLl9gO1xuXG4gICAgICAgICAgICBhd2FpdCB0aGlzLnRlbGVncmFtU2VydmljZS5zZW5kTWVzc2FnZShhZG1pbkNoYXRJZCwgbWVzc2FnZSk7XG4gICAgICAgICAgICBsb2dnZXIuaW5mbygnTm90aWZpY2FjacOzbiBkZSBUZWxlZ3JhbSBlbnZpYWRhIGV4aXRvc2FtZW50ZS4nKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2ggKG1zZ0Vycm9yKSB7XG4gICAgICAgICAgbG9nZ2VyLmVycm9yKG1zZ0Vycm9yLCAnRXJyb3IgZW52aWFuZG8gbm90aWZpY2FjacOzbiBkZSBUZWxlZ3JhbScpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgbG9nZ2VyLmVycm9yKGVycm9yLCBgRXJyb3IgZHVyYW50ZSBsYSBhdXRvbWF0aXphY2nDs24gcHJlbWl1bSBkZWwgdmlkZW8gJHtmaWxlTmFtZX1gKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogSW5pY2lhIGVsIHNlcnZpY2lvIGRlIHZpZ2lsYW5jaWFcbiAgICovXG4gIHN0YXJ0KCk6IHZvaWQge1xuICAgIHRoaXMuZW5zdXJlRGlyZWN0b3JpZXMoKTtcblxuICAgIGxvZ2dlci5pbmZvKGBJbmljaWFuZG8gdmlnaWxhbmNpYSBkZSBjYXJwZXRhOiAke3RoaXMud2F0Y2hQYXRofWApO1xuICAgIGxvZ2dlci5pbmZvKGBFbWFpbCBkZSBkZXN0aW5vOiAke3RoaXMucmVjaXBpZW50RW1haWx9YCk7XG5cbiAgICB0aGlzLndhdGNoZXIgPSBjaG9raWRhci53YXRjaCh0aGlzLndhdGNoUGF0aCwge1xuICAgICAgaWdub3JlZDogcGF0aCA9PlxuICAgICAgICBbXG4gICAgICAgICAgLyhefFtcXC9cXFxcXSlcXC4uLywgLy8gQXJjaGl2b3Mgb2N1bHRvc1xuICAgICAgICAgIC9wcm9jZXNzZWQvLCAvLyBDYXJwZXRhIHByb2Nlc3NlZFxuICAgICAgICAgIC9SRUFETUVcXC5tZC8sIC8vIFJFQURNRVxuICAgICAgICBdLnNvbWUocGF0dGVybiA9PiBwYXR0ZXJuLnRlc3QocGF0aCkpLFxuICAgICAgcGVyc2lzdGVudDogdHJ1ZSxcbiAgICAgIGlnbm9yZUluaXRpYWw6IHRydWUsIC8vIE5vIHByb2Nlc2FyIGFyY2hpdm9zIGV4aXN0ZW50ZXMgYWwgaW5pY2lhclxuICAgICAgYXdhaXRXcml0ZUZpbmlzaDoge1xuICAgICAgICBzdGFiaWxpdHlUaHJlc2hvbGQ6IDEwMDAsXG4gICAgICAgIHBvbGxJbnRlcnZhbDogMTAwLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHRoaXMud2F0Y2hlclxuICAgICAgLm9uKCdhZGQnLCBmaWxlUGF0aCA9PiB7XG4gICAgICAgIHRoaXMucHJvY2Vzc0ZpbGUoZmlsZVBhdGgpLmNhdGNoKChlcnJvcjogYW55KSA9PiB7XG4gICAgICAgICAgbG9nZ2VyLmVycm9yKGVycm9yLCBgRXJyb3IgcHJvY2VzYW5kbyBhcmNoaXZvICR7ZmlsZVBhdGh9YCk7XG4gICAgICAgIH0pO1xuICAgICAgfSlcbiAgICAgIC5vbignZXJyb3InLCAoZXJyb3I6IGFueSkgPT4ge1xuICAgICAgICBsb2dnZXIuZXJyb3IoZXJyb3IsICdFcnJvciBlbiBlbCB3YXRjaGVyJyk7XG4gICAgICB9KVxuICAgICAgLm9uKCdyZWFkeScsICgpID0+IHtcbiAgICAgICAgbG9nZ2VyLmluZm8oJ+KchSBXYXRjaGVyIGRlIFlvdVR1YmUgbGlzdG8uIEVzcGVyYW5kbyBhcmNoaXZvcy4uLicpO1xuICAgICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogRGV0aWVuZSBlbCBzZXJ2aWNpbyBkZSB2aWdpbGFuY2lhXG4gICAqL1xuICBhc3luYyBzdG9wKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICh0aGlzLndhdGNoZXIpIHtcbiAgICAgIGF3YWl0IHRoaXMud2F0Y2hlci5jbG9zZSgpO1xuICAgICAgdGhpcy53YXRjaGVyID0gbnVsbDtcbiAgICAgIGxvZ2dlci5pbmZvKCdXYXRjaGVyIGRlIFlvdVR1YmUgZGV0ZW5pZG8nKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogT2J0aWVuZSBlbCBlc3RhZG8gZGVsIHdhdGNoZXJcbiAgICovXG4gIGdldFN0YXR1cygpOiB7XG4gICAgaXNSdW5uaW5nOiBib29sZWFuO1xuICAgIHdhdGNoUGF0aDogc3RyaW5nO1xuICAgIHJlY2lwaWVudEVtYWlsOiBzdHJpbmc7XG4gIH0ge1xuICAgIHJldHVybiB7XG4gICAgICBpc1J1bm5pbmc6IHRoaXMud2F0Y2hlciAhPT0gbnVsbCxcbiAgICAgIHdhdGNoUGF0aDogdGhpcy53YXRjaFBhdGgsXG4gICAgICByZWNpcGllbnRFbWFpbDogdGhpcy5yZWNpcGllbnRFbWFpbCxcbiAgICB9O1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=