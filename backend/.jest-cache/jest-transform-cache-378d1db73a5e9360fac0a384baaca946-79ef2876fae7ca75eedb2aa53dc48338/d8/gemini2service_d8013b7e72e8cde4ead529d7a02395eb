bf64c2223976494a46492c1a421f955b
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.Gemini2Service = void 0;
const inversify_1 = require("inversify");
const daniela_ai_service_1 = require("./daniela-ai.service");
/**
 * Gemini 2.0 Service
 * Integración con el último modelo Gemini 2.0 Pro
 */
let Gemini2Service = class Gemini2Service {
    daniela;
    client;
    constructor(daniela) {
        this.daniela = daniela;
    }
    async initialize() {
        try {
            // Nota: Requiere @google-cloud/vertexai
            const { VertexAI } = require('@google-cloud/vertexai');
            this.client = new VertexAI({
                project: process.env.GOOGLE_CLOUD_PROJECT_ID,
                location: process.env.VERTEX_AI_LOCATION,
            });
            console.log('✅ Gemini 2.0 Service initialized');
        }
        catch (error) {
            console.error('Error initializing Gemini 2.0:', error);
            throw error;
        }
    }
    async generateText(prompt, options = {}) {
        try {
            const model = this.client.getGenerativeModel({
                model: process.env.GEMINI_2_MODEL || 'gemini-2.0-pro',
            });
            const request = {
                contents: [
                    {
                        role: 'user',
                        parts: [{ text: prompt }],
                    },
                ],
                generationConfig: {
                    temperature: options.temperature || 0.7,
                    maxOutputTokens: options.maxTokens || 4096,
                    topP: 0.95,
                    topK: 40,
                },
            };
            const response = await model.generateContent(request);
            return response.response.text();
        }
        catch (error) {
            console.error('Error generating text with Gemini 2.0:', error);
            throw error;
        }
    }
    async analyzeImage(imageUrl, prompt) {
        try {
            const model = this.client.getGenerativeModel({
                model: 'gemini-2.0-pro-vision',
            });
            const imageData = await this.urlToBase64(imageUrl);
            const response = await model.generateContent([
                {
                    inlineData: {
                        mimeType: 'image/jpeg',
                        data: imageData,
                    },
                },
                { text: prompt },
            ]);
            return response.response.text();
        }
        catch (error) {
            console.error('Error analyzing image:', error);
            throw error;
        }
    }
    async multimodalAnalysis(inputs) {
        try {
            const model = this.client.getGenerativeModel({
                model: 'gemini-2.0-pro-multimodal',
            });
            const content = [];
            if (inputs.text) {
                content.push({ text: inputs.text });
            }
            if (inputs.imageUrl) {
                const imageData = await this.urlToBase64(inputs.imageUrl);
                content.push({
                    inlineData: {
                        mimeType: 'image/jpeg',
                        data: imageData,
                    },
                });
            }
            const response = await model.generateContent(content);
            return response.response.text();
        }
        catch (error) {
            console.error('Error in multimodal analysis:', error);
            throw error;
        }
    }
    async streamResponse(prompt) {
        try {
            const model = this.client.getGenerativeModel({
                model: 'gemini-2.0-flash',
            });
            const response = await model.generateContentStream({
                contents: [
                    {
                        role: 'user',
                        parts: [{ text: prompt }],
                    },
                ],
            });
            return response;
        }
        catch (error) {
            console.error('Error streaming response:', error);
            throw error;
        }
    }
    async functionCalling(prompt, functions) {
        try {
            const model = this.client.getGenerativeModel({
                model: 'gemini-2.0-pro',
            });
            const tools = {
                functionDeclarations: functions,
            };
            const response = await model.generateContent({
                contents: [
                    {
                        role: 'user',
                        parts: [{ text: prompt }],
                    },
                ],
                tools: [tools],
            });
            return response;
        }
        catch (error) {
            console.error('Error in function calling:', error);
            throw error;
        }
    }
    async summarizeText(text, length = 'medium') {
        try {
            const lengthMap = {
                short: '1-2 sentences',
                medium: '3-5 sentences',
                long: '1 paragraph',
            };
            const prompt = `Summarize the following text in ${lengthMap[length]}:\n\n${text}`;
            return await this.generateText(prompt, {
                maxTokens: length === 'short' ? 100 : length === 'medium' ? 200 : 500,
            });
        }
        catch (error) {
            console.error('Error summarizing text:', error);
            throw error;
        }
    }
    async translateText(text, targetLanguage) {
        try {
            const prompt = `Translate the following text to ${targetLanguage}:\n\n${text}`;
            return await this.generateText(prompt);
        }
        catch (error) {
            console.error('Error translating text:', error);
            throw error;
        }
    }
    async classifyContent(text, categories) {
        try {
            const prompt = `Classify the following text into one of these categories: ${categories.join(', ')}\n\nText: ${text}`;
            return await this.generateText(prompt);
        }
        catch (error) {
            console.error('Error classifying content:', error);
            throw error;
        }
    }
    async urlToBase64(url) {
        try {
            const response = await fetch(url);
            const buffer = await response.arrayBuffer();
            return Buffer.from(buffer).toString('base64');
        }
        catch (error) {
            console.error('Error converting URL to base64:', error);
            throw error;
        }
    }
};
exports.Gemini2Service = Gemini2Service;
exports.Gemini2Service = Gemini2Service = __decorate([
    (0, inversify_1.injectable)(),
    __param(0, (0, inversify_1.inject)(daniela_ai_service_1.DanielaAIService)),
    __metadata("design:paramtypes", [typeof (_a = typeof daniela_ai_service_1.DanielaAIService !== "undefined" && daniela_ai_service_1.DanielaAIService) === "function" ? _a : Object])
], Gemini2Service);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxzZXJ2aWNlc1xcZ2VtaW5pLTIuc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7O0FBQUEseUNBQStDO0FBQy9DLDZEQUF3RDtBQUV4RDs7O0dBR0c7QUFFSSxJQUFNLGNBQWMsR0FBcEIsTUFBTSxjQUFjO0lBR3FCO0lBRnRDLE1BQU0sQ0FBTTtJQUVwQixZQUE4QyxPQUF5QjtRQUF6QixZQUFPLEdBQVAsT0FBTyxDQUFrQjtJQUFHLENBQUM7SUFFM0UsS0FBSyxDQUFDLFVBQVU7UUFDZCxJQUFJLENBQUM7WUFDSCx3Q0FBd0M7WUFDeEMsTUFBTSxFQUFFLFFBQVEsRUFBRSxHQUFHLE9BQU8sQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO1lBRXZELElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxRQUFRLENBQUM7Z0JBQ3pCLE9BQU8sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLHVCQUF1QjtnQkFDNUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCO2FBQ3pDLENBQUMsQ0FBQztZQUVILE9BQU8sQ0FBQyxHQUFHLENBQUMsa0NBQWtDLENBQUMsQ0FBQztRQUNsRCxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMsZ0NBQWdDLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDdkQsTUFBTSxLQUFLLENBQUM7UUFDZCxDQUFDO0lBQ0gsQ0FBQztJQUVELEtBQUssQ0FBQyxZQUFZLENBQUMsTUFBYyxFQUFFLFVBQWUsRUFBRTtRQUNsRCxJQUFJLENBQUM7WUFDSCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLGtCQUFrQixDQUFDO2dCQUMzQyxLQUFLLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLElBQUksZ0JBQWdCO2FBQ3RELENBQUMsQ0FBQztZQUVILE1BQU0sT0FBTyxHQUFHO2dCQUNkLFFBQVEsRUFB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XHNyY1xcc2VydmljZXNcXGdlbWluaS0yLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaW5qZWN0YWJsZSwgaW5qZWN0IH0gZnJvbSAnaW52ZXJzaWZ5JztcbmltcG9ydCB7IERhbmllbGFBSVNlcnZpY2UgfSBmcm9tICcuL2RhbmllbGEtYWkuc2VydmljZSc7XG5cbi8qKlxuICogR2VtaW5pIDIuMCBTZXJ2aWNlXG4gKiBJbnRlZ3JhY2nDs24gY29uIGVsIMO6bHRpbW8gbW9kZWxvIEdlbWluaSAyLjAgUHJvXG4gKi9cbkBpbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBHZW1pbmkyU2VydmljZSB7XG4gIHByaXZhdGUgY2xpZW50OiBhbnk7XG5cbiAgY29uc3RydWN0b3IoQGluamVjdChEYW5pZWxhQUlTZXJ2aWNlKSBwcml2YXRlIGRhbmllbGE6IERhbmllbGFBSVNlcnZpY2UpIHt9XG5cbiAgYXN5bmMgaW5pdGlhbGl6ZSgpIHtcbiAgICB0cnkge1xuICAgICAgLy8gTm90YTogUmVxdWllcmUgQGdvb2dsZS1jbG91ZC92ZXJ0ZXhhaVxuICAgICAgY29uc3QgeyBWZXJ0ZXhBSSB9ID0gcmVxdWlyZSgnQGdvb2dsZS1jbG91ZC92ZXJ0ZXhhaScpO1xuXG4gICAgICB0aGlzLmNsaWVudCA9IG5ldyBWZXJ0ZXhBSSh7XG4gICAgICAgIHByb2plY3Q6IHByb2Nlc3MuZW52LkdPT0dMRV9DTE9VRF9QUk9KRUNUX0lELFxuICAgICAgICBsb2NhdGlvbjogcHJvY2Vzcy5lbnYuVkVSVEVYX0FJX0xPQ0FUSU9OLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnNvbGUubG9nKCfinIUgR2VtaW5pIDIuMCBTZXJ2aWNlIGluaXRpYWxpemVkJyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGluaXRpYWxpemluZyBHZW1pbmkgMi4wOicsIGVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdlbmVyYXRlVGV4dChwcm9tcHQ6IHN0cmluZywgb3B0aW9uczogYW55ID0ge30pIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgbW9kZWwgPSB0aGlzLmNsaWVudC5nZXRHZW5lcmF0aXZlTW9kZWwoe1xuICAgICAgICBtb2RlbDogcHJvY2Vzcy5lbnYuR0VNSU5JXzJfTU9ERUwgfHwgJ2dlbWluaS0yLjAtcHJvJyxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCByZXF1ZXN0ID0ge1xuICAgICAgICBjb250ZW50czogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIHJvbGU6ICd1c2VyJyxcbiAgICAgICAgICAgIHBhcnRzOiBbeyB0ZXh0OiBwcm9tcHQgfV0sXG4gICAgICAgICAgfSxcbiAgICAgICAgXSxcbiAgICAgICAgZ2VuZXJhdGlvbkNvbmZpZzoge1xuICAgICAgICAgIHRlbXBlcmF0dXJlOiBvcHRpb25zLnRlbXBlcmF0dXJlIHx8IDAuNyxcbiAgICAgICAgICBtYXhPdXRwdXRUb2tlbnM6IG9wdGlvbnMubWF4VG9rZW5zIHx8IDQwOTYsXG4gICAgICAgICAgdG9wUDogMC45NSxcbiAgICAgICAgICB0b3BLOiA0MCxcbiAgICAgICAgfSxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgbW9kZWwuZ2VuZXJhdGVDb250ZW50KHJlcXVlc3QpO1xuICAgICAgcmV0dXJuIHJlc3BvbnNlLnJlc3BvbnNlLnRleHQoKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgZ2VuZXJhdGluZyB0ZXh0IHdpdGggR2VtaW5pIDIuMDonLCBlcnJvcik7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICBhc3luYyBhbmFseXplSW1hZ2UoaW1hZ2VVcmw6IHN0cmluZywgcHJvbXB0OiBzdHJpbmcpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgbW9kZWwgPSB0aGlzLmNsaWVudC5nZXRHZW5lcmF0aXZlTW9kZWwoe1xuICAgICAgICBtb2RlbDogJ2dlbWluaS0yLjAtcHJvLXZpc2lvbicsXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgaW1hZ2VEYXRhID0gYXdhaXQgdGhpcy51cmxUb0Jhc2U2NChpbWFnZVVybCk7XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgbW9kZWwuZ2VuZXJhdGVDb250ZW50KFtcbiAgICAgICAge1xuICAgICAgICAgIGlubGluZURhdGE6IHtcbiAgICAgICAgICAgIG1pbWVUeXBlOiAnaW1hZ2UvanBlZycsXG4gICAgICAgICAgICBkYXRhOiBpbWFnZURhdGEsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgeyB0ZXh0OiBwcm9tcHQgfSxcbiAgICAgIF0pO1xuXG4gICAgICByZXR1cm4gcmVzcG9uc2UucmVzcG9uc2UudGV4dCgpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBhbmFseXppbmcgaW1hZ2U6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgbXVsdGltb2RhbEFuYWx5c2lzKGlucHV0czogeyB0ZXh0Pzogc3RyaW5nOyBpbWFnZVVybD86IHN0cmluZzsgYXVkaW9Vcmw/OiBzdHJpbmcgfSkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBtb2RlbCA9IHRoaXMuY2xpZW50LmdldEdlbmVyYXRpdmVNb2RlbCh7XG4gICAgICAgIG1vZGVsOiAnZ2VtaW5pLTIuMC1wcm8tbXVsdGltb2RhbCcsXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgY29udGVudDogYW55W10gPSBbXTtcblxuICAgICAgaWYgKGlucHV0cy50ZXh0KSB7XG4gICAgICAgIGNvbnRlbnQucHVzaCh7IHRleHQ6IGlucHV0cy50ZXh0IH0pO1xuICAgICAgfVxuXG4gICAgICBpZiAoaW5wdXRzLmltYWdlVXJsKSB7XG4gICAgICAgIGNvbnN0IGltYWdlRGF0YSA9IGF3YWl0IHRoaXMudXJsVG9CYXNlNjQoaW5wdXRzLmltYWdlVXJsKTtcbiAgICAgICAgY29udGVudC5wdXNoKHtcbiAgICAgICAgICBpbmxpbmVEYXRhOiB7XG4gICAgICAgICAgICBtaW1lVHlwZTogJ2ltYWdlL2pwZWcnLFxuICAgICAgICAgICAgZGF0YTogaW1hZ2VEYXRhLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0gYXMgYW55KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBtb2RlbC5nZW5lcmF0ZUNvbnRlbnQoY29udGVudCk7XG4gICAgICByZXR1cm4gcmVzcG9uc2UucmVzcG9uc2UudGV4dCgpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBpbiBtdWx0aW1vZGFsIGFuYWx5c2lzOicsIGVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHN0cmVhbVJlc3BvbnNlKHByb21wdDogc3RyaW5nKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IG1vZGVsID0gdGhpcy5jbGllbnQuZ2V0R2VuZXJhdGl2ZU1vZGVsKHtcbiAgICAgICAgbW9kZWw6ICdnZW1pbmktMi4wLWZsYXNoJyxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IG1vZGVsLmdlbmVyYXRlQ29udGVudFN0cmVhbSh7XG4gICAgICAgIGNvbnRlbnRzOiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgcm9sZTogJ3VzZXInLFxuICAgICAgICAgICAgcGFydHM6IFt7IHRleHQ6IHByb21wdCB9XSxcbiAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiByZXNwb25zZTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignRXJyb3Igc3RyZWFtaW5nIHJlc3BvbnNlOicsIGVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGZ1bmN0aW9uQ2FsbGluZyhcbiAgICBwcm9tcHQ6IHN0cmluZyxcbiAgICBmdW5jdGlvbnM6IEFycmF5PHtcbiAgICAgIG5hbWU6IHN0cmluZztcbiAgICAgIGRlc2NyaXB0aW9uOiBzdHJpbmc7XG4gICAgICBwYXJhbWV0ZXJzOiBhbnk7XG4gICAgfT4sXG4gICkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBtb2RlbCA9IHRoaXMuY2xpZW50LmdldEdlbmVyYXRpdmVNb2RlbCh7XG4gICAgICAgIG1vZGVsOiAnZ2VtaW5pLTIuMC1wcm8nLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHRvb2xzID0ge1xuICAgICAgICBmdW5jdGlvbkRlY2xhcmF0aW9uczogZnVuY3Rpb25zLFxuICAgICAgfTtcblxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBtb2RlbC5nZW5lcmF0ZUNvbnRlbnQoe1xuICAgICAgICBjb250ZW50czogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIHJvbGU6ICd1c2VyJyxcbiAgICAgICAgICAgIHBhcnRzOiBbeyB0ZXh0OiBwcm9tcHQgfV0sXG4gICAgICAgICAgfSxcbiAgICAgICAgXSxcbiAgICAgICAgdG9vbHM6IFt0b29sc10sXG4gICAgICB9KTtcblxuICAgICAgcmV0dXJuIHJlc3BvbnNlO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBpbiBmdW5jdGlvbiBjYWxsaW5nOicsIGVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHN1bW1hcml6ZVRleHQodGV4dDogc3RyaW5nLCBsZW5ndGg6ICdzaG9ydCcgfCAnbWVkaXVtJyB8ICdsb25nJyA9ICdtZWRpdW0nKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGxlbmd0aE1hcCA9IHtcbiAgICAgICAgc2hvcnQ6ICcxLTIgc2VudGVuY2VzJyxcbiAgICAgICAgbWVkaXVtOiAnMy01IHNlbnRlbmNlcycsXG4gICAgICAgIGxvbmc6ICcxIHBhcmFncmFwaCcsXG4gICAgICB9O1xuXG4gICAgICBjb25zdCBwcm9tcHQgPSBgU3VtbWFyaXplIHRoZSBmb2xsb3dpbmcgdGV4dCBpbiAke2xlbmd0aE1hcFtsZW5ndGhdfTpcXG5cXG4ke3RleHR9YDtcblxuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2VuZXJhdGVUZXh0KHByb21wdCwge1xuICAgICAgICBtYXhUb2tlbnM6IGxlbmd0aCA9PT0gJ3Nob3J0JyA/IDEwMCA6IGxlbmd0aCA9PT0gJ21lZGl1bScgPyAyMDAgOiA1MDAsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignRXJyb3Igc3VtbWFyaXppbmcgdGV4dDonLCBlcnJvcik7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICBhc3luYyB0cmFuc2xhdGVUZXh0KHRleHQ6IHN0cmluZywgdGFyZ2V0TGFuZ3VhZ2U6IHN0cmluZykge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBwcm9tcHQgPSBgVHJhbnNsYXRlIHRoZSBmb2xsb3dpbmcgdGV4dCB0byAke3RhcmdldExhbmd1YWdlfTpcXG5cXG4ke3RleHR9YDtcblxuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2VuZXJhdGVUZXh0KHByb21wdCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHRyYW5zbGF0aW5nIHRleHQ6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgY2xhc3NpZnlDb250ZW50KHRleHQ6IHN0cmluZywgY2F0ZWdvcmllczogc3RyaW5nW10pIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcHJvbXB0ID0gYENsYXNzaWZ5IHRoZSBmb2xsb3dpbmcgdGV4dCBpbnRvIG9uZSBvZiB0aGVzZSBjYXRlZ29yaWVzOiAke2NhdGVnb3JpZXMuam9pbihcbiAgICAgICAgJywgJyxcbiAgICAgICl9XFxuXFxuVGV4dDogJHt0ZXh0fWA7XG5cbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmdlbmVyYXRlVGV4dChwcm9tcHQpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBjbGFzc2lmeWluZyBjb250ZW50OicsIGVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgdXJsVG9CYXNlNjQodXJsOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKHVybCk7XG4gICAgICBjb25zdCBidWZmZXIgPSBhd2FpdCByZXNwb25zZS5hcnJheUJ1ZmZlcigpO1xuICAgICAgcmV0dXJuIEJ1ZmZlci5mcm9tKGJ1ZmZlcikudG9TdHJpbmcoJ2Jhc2U2NCcpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBjb252ZXJ0aW5nIFVSTCB0byBiYXNlNjQ6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=