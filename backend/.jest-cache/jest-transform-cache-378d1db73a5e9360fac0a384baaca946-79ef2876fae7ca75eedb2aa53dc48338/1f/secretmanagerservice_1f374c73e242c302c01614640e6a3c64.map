{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\google\\secret-manager.service.ts","mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,4CAAoB;AACpB,yCAAuC;AACvC,gDAAwB;AAExB,+CAA4C;AAGrC,IAAM,0BAA0B,GAAhC,MAAM,0BAA0B;IACrC;;;OAGG;IACH,KAAK,CAAC,gBAAgB,CAAC,IAAc;QACnC,MAAM,SAAS,GAAG,OAAO,CAAC,GAAG,CAAC,8BAA8B,IAAI,EAAE,CAAC;QACnE,MAAM,QAAQ,GAAG,SAAS,IAAI,YAAE,CAAC,UAAU,CAAC,cAAI,CAAC,OAAO,CAAC,OAAO,CAAC,GAAG,EAAE,EAAE,SAAS,CAAC,CAAC,CAAC;QAEpF,IAAI,CAAC,QAAQ,EAAE,CAAC;YACd,eAAM,CAAC,IAAI,CAAC,sEAAsE,CAAC,CAAC;YACpF,OAAO;QACT,CAAC;QAED,IAAI,0BAA+B,CAAC;QACpC,IAAI,CAAC;YACH,MAAM,YAAY,GAAG,wDAAa,8BAA8B,GAAC,CAAC;YAClE,0BAA0B,GAAG,YAAY,CAAC,0BAA0B,CAAC;QACvE,CAAC;QAAC,OAAO,CAAC,EAAE,CAAC;YACX,eAAM,CAAC,IAAI,CAAC,uEAAuE,CAAC,CAAC;YACrF,OAAO;QACT,CAAC;QAED,MAAM,MAAM,GAAG,IAAI,0BAA0B,EAAE,CAAC;QAChD,MAAM,SAAS,GAAG,OAAO,CAAC,GAAG,CAAC,uBAAuB,CAAC;QAEtD,IAAI,CAAC,SAAS,EAAE,CAAC;YACf,eAAM,CAAC,IAAI,CAAC,oDAAoD,CAAC,CAAC;YAClE,OAAO;QACT,CAAC;QAED,KAAK,MAAM,GAAG,IAAI,IAAI,EAAE,CAAC;YACvB,MAAM,IAAI,GAAG,YAAY,SAAS,YAAY,GAAG,kBAAkB,CAAC;YACpE,IAAI,CAAC;gBACH,MAAM,CAAC,OAAO,CAAC,GAAG,MAAM,MAAM,CAAC,mBAAmB,CAAC,EAAE,IAAI,EAAE,CAAC,CAAC;gBAC7D,MAAM,OAAO,GAAG,OAAO,EAAE,OAAO,EAAE,IAAI,EAAE,QAAQ,EAAE,CAAC;gBACnD,IAAI,OAAO,KAAK,SAAS,EAAE,CAAC;oBAC1B,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,OAAO,CAAC;oBAC3B,eAAM,CAAC,IAAI,CAAC,UAAU,GAAG,kBAAkB,CAAC,CAAC;gBAC/C,CAAC;YACH,CAAC;YAAC,OAAO,GAAG,EAAE,CAAC;gBACb,eAAM,CAAC,KAAK,CAAC,GAAG,EAAE,yBAAyB,GAAG,EAAE,CAAC,CAAC;YACpD,CAAC;QACH,CAAC;IACH,CAAC;CACF,CAAA;AA7CY,gEAA0B;qCAA1B,0BAA0B;IADtC,IAAA,sBAAU,GAAE;GACA,0BAA0B,CA6CtC","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\google\\secret-manager.service.ts"],"sourcesContent":["import fs from 'fs';\nimport { injectable } from 'inversify';\nimport path from 'path';\n\nimport { logger } from '../../utils/logger';\n\n@injectable()\nexport class GoogleSecretManagerService {\n  /**\n   * Loads an array of secret names into `process.env`.\n   * @param keys List of secret identifiers (as they appear in GCP Secret Manager).\n   */\n  async loadSecretsToEnv(keys: string[]): Promise<void> {\n    const credsPath = process.env.GOOGLE_APPLICATION_CREDENTIALS || '';\n    const hasCreds = credsPath && fs.existsSync(path.resolve(process.cwd(), credsPath));\n\n    if (!hasCreds) {\n      logger.warn('Google Cloud credentials not found – skipping Secret Manager loading');\n      return;\n    }\n\n    let SecretManagerServiceClient: any;\n    try {\n      const clientModule = await import('@google-cloud/secret-manager');\n      SecretManagerServiceClient = clientModule.SecretManagerServiceClient;\n    } catch (e) {\n      logger.warn('Secret Manager client library not installed – skipping secret loading');\n      return;\n    }\n\n    const client = new SecretManagerServiceClient();\n    const projectId = process.env.GOOGLE_CLOUD_PROJECT_ID;\n\n    if (!projectId) {\n      logger.warn('GCP project ID not set – cannot build secret names');\n      return;\n    }\n\n    for (const key of keys) {\n      const name = `projects/${projectId}/secrets/${key}/versions/latest`;\n      try {\n        const [version] = await client.accessSecretVersion({ name });\n        const payload = version?.payload?.data?.toString();\n        if (payload !== undefined) {\n          process.env[key] = payload;\n          logger.info(`Secret ${key} loaded into env`);\n        }\n      } catch (err) {\n        logger.error(err, `Failed to load secret ${key}`);\n      }\n    }\n  }\n}\n"],"version":3}