{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\utils\\youtube-transcription.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\utils\\youtube-transcription.service.ts"],"sourcesContent":["import { YoutubeTranscript } from 'youtube-transcript';\nimport { injectable } from 'inversify';\n\nimport { logger } from './logger';\n\n/**\n * Interface para el resultado de la transcripción\n */\nexport interface TranscriptionResult {\n  videoId: string;\n  title: string;\n  url: string;\n  transcript: string;\n  language: string;\n  duration: number;\n}\n\ninterface TranscriptItem {\n  text: string;\n  duration: number;\n  offset: number;\n}\n\n/**\n * Servicio para extraer transcripciones de videos de YouTube\n */\n@injectable()\nexport class YoutubeTranscriptionService {\n  /**\n   * Extrae el ID del video desde una URL de YouTube\n   */\n  private extractVideoId(url: string): string | null {\n    const patterns = [\n      /(?:youtube\\.com\\/watch\\?v=)([^&]+)/,\n      /(?:youtu\\.be\\/)([^?]+)/,\n      /(?:youtube\\.com\\/embed\\/)([^?]+)/,\n      /(?:youtube\\.com\\/v\\/)([^?]+)/,\n    ];\n\n    for (const pattern of patterns) {\n      const match = url.match(pattern);\n      if (match && match[1]) {\n        return match[1];\n      }\n    }\n\n    return null;\n  }\n\n  /**\n   * Obtiene la transcripción de un video de YouTube en español\n   */\n  async getTranscription(videoUrl: string): Promise<TranscriptionResult> {\n    try {\n      const videoId = this.extractVideoId(videoUrl);\n      if (!videoId) {\n        throw new Error('URL de YouTube inválida');\n      }\n\n      logger.info(`Obteniendo transcripción para video: ${videoId}`);\n\n      // Intentar primero con subtítulos en español\n      let transcriptItems: TranscriptItem[];\n      try {\n        transcriptItems = (await YoutubeTranscript.fetchTranscript(videoId, {\n          lang: 'es',\n        })) as TranscriptItem[];\n      } catch (error) {\n        // Si no hay subtítulos en español, intentar con autogenerados\n        logger.warn(\n          `No se encontraron subtítulos en español para ${videoId}, intentando con autogenerados: ${\n            error instanceof Error ? error.message : 'Unknown error'\n          }`,\n        );\n        transcriptItems = (await YoutubeTranscript.fetchTranscript(videoId)) as TranscriptItem[];\n      }\n\n      if (!transcriptItems || transcriptItems.length === 0) {\n        throw new Error('No se encontraron subtítulos/transcripciones disponibles para este video');\n      }\n\n      // Combinar todos los segmentos de texto\n      const fullTranscript = transcriptItems\n        .map(item => item.text)\n        .join(' ')\n        .replace(/\\s+/g, ' ')\n        .trim();\n\n      // Calcular duración total\n      const duration = transcriptItems[transcriptItems.length - 1]?.offset || 0;\n\n      logger.info(\n        `Transcripción obtenida exitosamente para ${videoId}. Longitud: ${fullTranscript.length} caracteres`,\n      );\n\n      return {\n        videoId,\n        title: `Video de YouTube ${videoId}`,\n        url: videoUrl,\n        transcript: fullTranscript,\n        language: 'es',\n        duration: Math.round(duration / 1000), // Convertir a segundos\n      };\n    } catch (error) {\n      logger.error(error, 'Error obteniendo transcripción de YouTube');\n      throw new Error(`No se pudo obtener la transcripción: ${(error as Error).message}`);\n    }\n  }\n\n  /**\n   * Formatea la transcripción en párrafos más legibles\n   */\n  formatTranscript(transcript: string, wordsPerParagraph = 100): string {\n    const words = transcript.split(' ');\n    const paragraphs: string[] = [];\n\n    for (let i = 0; i < words.length; i += wordsPerParagraph) {\n      const paragraph = words.slice(i, i + wordsPerParagraph).join(' ');\n      paragraphs.push(paragraph);\n    }\n\n    return paragraphs.join('\\n\\n');\n  }\n\n  /**\n   * Obtiene información básica del video (sin la transcripción completa)\n   */\n  async getVideoInfo(videoUrl: string): Promise<{ videoId: string; url: string }> {\n    const videoId = this.extractVideoId(videoUrl);\n    if (!videoId) {\n      throw new Error('URL de YouTube inválida');\n    }\n\n    return {\n      videoId,\n      url: videoUrl,\n    };\n  }\n}\n"],"version":3}