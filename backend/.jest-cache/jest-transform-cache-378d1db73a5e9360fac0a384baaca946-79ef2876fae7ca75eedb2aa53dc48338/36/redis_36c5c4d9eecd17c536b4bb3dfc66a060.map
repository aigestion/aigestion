{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\cache\\redis.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\cache\\redis.ts"],"sourcesContent":["import type { RedisClientType } from 'redis';\nimport * as redis from 'redis';\n\nimport { logger } from '../utils/logger';\n\nexport const resetRedisClient = () => {\n  if (redisClient && redisClient.isOpen) {\n    redisClient.quit();\n  }\n  redisClient = null;\n};\nlet redisClient: RedisClientType | null = null;\n\nexport const getRedisClient = (): RedisClientType => {\n  if (process.env.ENABLE_REDIS === 'false') {\n    // Return a mock that satisfies basic needs of rate-limit-redis and other consumers\n    if (!redisClient) {\n      redisClient = {\n        on: () => {},\n        connect: async () => {},\n        quit: async () => {},\n        isOpen: true,\n        get: async () => null,\n        set: async () => 'OK',\n        setEx: async () => 'OK',\n        sendCommand: async () => ({}), // Satisfies rate-limit-redis\n        del: async () => 1,\n        hGet: async () => null,\n        hSet: async () => 1,\n        hGetAll: async () => ({}),\n        exists: async () => 0,\n        expire: async () => true,\n        ttl: async () => -1,\n        incr: async () => 1,\n        decr: async () => 0,\n        lPush: async () => 1,\n        lTrim: async () => 'OK',\n        lRange: async () => [],\n        // Add others as needed\n      } as any;\n      logger.info('Redis is disabled: Using God Mode Mock');\n    }\n    return redisClient!;\n  }\n\n  if (!redisClient) {\n    const clusterNodes = process.env.REDIS_CLUSTER_NODES;\n\n    if (clusterNodes) {\n      // Cluster Connection\n      const nodes = clusterNodes.split(',').map(url => ({ url: url.trim() }));\n      logger.info(`Initializing Redis Cluster with nodes: ${JSON.stringify(nodes)}`);\n\n      redisClient = redis.createCluster({\n        rootNodes: nodes,\n        defaults: {\n          socket: {\n            reconnectStrategy: retries => Math.min(retries * 100, 5000),\n          },\n        },\n      }) as unknown as RedisClientType; // Cast compatibility\n    } else {\n      // Standalone Connection\n      const host = process.env.REDIS_HOST || 'localhost';\n      const port = process.env.REDIS_PORT || '6379';\n      const password = process.env.REDIS_PASSWORD;\n      const url = password ? `redis://:${password}@${host}:${port}` : `redis://${host}:${port}`;\n\n      redisClient = redis.createClient({\n        url,\n        socket: {\n          reconnectStrategy: retries => {\n            if (retries > 50) {\n              logger.error(\n                `Redis reconnection GAVE UP after 50 attempts. Manual intervention required.`,\n              );\n              return new Error('Redis reconnection failed');\n            }\n            const delay = Math.min(retries * 200, 5000);\n            if (retries > 10) {\n              logger.warn(`Redis reconnection attempt ${retries}. Delay: ${delay}ms`);\n            }\n            return delay;\n          },\n        },\n      }) as RedisClientType;\n    }\n\n    if (redisClient) {\n      redisClient.on('error', (err: Error) => {\n        logger.error(err, 'Redis Client Error:');\n      });\n    }\n\n    // Connect in the background\n    const isTest = process.env.NODE_ENV === 'test' || !!process.env.JEST_WORKER_ID;\n\n    if (!isTest) {\n      (async () => {\n        try {\n          await redisClient?.connect();\n          logger.info(\n            clusterNodes ? 'Connected to Redis Cluster' : 'Connected to Redis Standalone',\n          );\n        } catch (err) {\n          logger.error(err, 'Failed to connect to Redis:');\n        }\n      })();\n    }\n  }\n  return redisClient;\n};\n\n// Utility function to safely close the Redis connection\nexport const closeRedis = async (): Promise<void> => {\n  if (redisClient) {\n    await redisClient.quit();\n    redisClient = null;\n  }\n};\n\n// In-memory L1 cache\nconst l1Cache = new Map<string, { value: any; expiry: number }>();\nconst MAX_L1_SIZE = 1000;\n\n/**\n * Get value from layered cache\n * L1: Memory (fastest)\n * L2: Redis (distributed)\n */\nexport const getCache = async (key: string): Promise<any> => {\n  // Check L1 first\n  const l1Item = l1Cache.get(key);\n  if (l1Item && l1Item.expiry > Date.now()) {\n    logger.debug({ key }, 'L1 Cache Hit');\n    return l1Item.value;\n  }\n\n  // L1 Miss or Expired, try L2 (Redis)\n  const client = getRedisClient();\n  if (client?.isOpen) {\n    try {\n      const data = await client.get(key);\n      if (data) {\n        const parsed = JSON.parse(data);\n\n        // Populate L1 for subsequent requests\n        // We don't have the original TTL here safely from Redis 'get',\n        // so we assume a default or check 'ttl' if we had it.\n        // For simplicity, we use a 5-minute local L1 mirror of the L2 data.\n        l1Cache.set(key, {\n          value: parsed,\n          expiry: Date.now() + 5 * 60 * 1000,\n        });\n\n        logger.debug({ key }, 'L2 Cache Hit (Mirroring to L1)');\n        return parsed;\n      }\n    } catch (error) {\n      logger.warn({ error, key }, 'Redis get error');\n    }\n  }\n\n  return null;\n};\n\n/**\n * Set value in layered cache\n * Sets both L1 and L2\n */\nexport const setCache = async (key: string, value: any, ttlSeconds = 3600): Promise<boolean> => {\n  // Set L1\n  l1Cache.set(key, {\n    value,\n    expiry: Date.now() + ttlSeconds * 1000,\n  });\n\n  // Simple L1 GC\n  if (l1Cache.size > MAX_L1_SIZE) {\n    const now = Date.now();\n    for (const [k, v] of l1Cache) {\n      if (v.expiry < now) {\n        l1Cache.delete(k);\n      }\n    }\n  }\n\n  // Set L2 (Redis)\n  const client = getRedisClient();\n  if (client?.isOpen) {\n    try {\n      await client.set(key, JSON.stringify(value), {\n        EX: ttlSeconds,\n      });\n      return true;\n    } catch (error) {\n      logger.warn({ error, key }, 'Redis set error');\n    }\n  }\n\n  return true;\n};\n"],"version":3}