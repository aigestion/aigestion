2e38d24cd720b3736bb5e214abfe19d5
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.PayPalService = void 0;
const typedi_1 = require("typedi");
const axios_1 = __importDefault(require("axios"));
const env_schema_1 = require("../config/env.schema");
const logger_1 = require("../utils/logger");
const CircuitBreakerFactory_1 = require("../infrastructure/resilience/CircuitBreakerFactory");
let PayPalService = class PayPalService {
    baseUrl;
    clientId;
    clientSecret;
    accessToken = null;
    tokenExpiry = 0;
    // Circuit Breakers
    createOrderBreaker;
    captureOrderBreaker;
    constructor() {
        this.baseUrl = env_schema_1.env.PAYPAL_MODE === 'live'
            ? 'https://api-m.paypal.com'
            : 'https://api-m.sandbox.paypal.com';
        this.clientId = env_schema_1.env.PAYPAL_CLIENT_ID || '';
        this.clientSecret = env_schema_1.env.PAYPAL_CLIENT_SECRET || '';
        if (!this.clientId || !this.clientSecret) {
            logger_1.logger.warn('PayPal credentials missing. PayPalService will not function.');
        }
        // Initialize Circuit Breakers
        this.createOrderBreaker = CircuitBreakerFactory_1.CircuitBreakerFactory.create((amount, currency) => this.createOrderInternal(amount, currency), { name: 'PayPal.createOrder' });
        this.captureOrderBreaker = CircuitBreakerFactory_1.CircuitBreakerFactory.create((orderId) => this.captureOrderInternal(orderId), { name: 'PayPal.captureOrder' });
    }
    async getAccessToken() {
        if (this.accessToken && Date.now() < this.tokenExpiry) {
            return this.accessToken;
        }
        const auth = Buffer.from(`${this.clientId}:${this.clientSecret}`).toString('base64');
        try {
            const response = await axios_1.default.post(`${this.baseUrl}/v1/oauth2/token`, 'grant_type=client_credentials', {
                headers: {
                    'Authorization': `Basic ${auth}`,
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            });
            this.accessToken = response.data.access_token;
            this.tokenExpiry = Date.now() + (response.data.expires_in * 1000) - 60000; // Buffer 1 min
            return this.accessToken;
        }
        catch (error) {
            logger_1.logger.error(error, 'Failed to get PayPal access token');
            throw new Error('PayPal authentication failed');
        }
    }
    async createOrder(amount, currency = 'USD') {
        return this.createOrderBreaker.fire(amount, currency);
    }
    async createOrderInternal(amount, currency) {
        const token = await this.getAccessToken();
        try {
            const response = await axios_1.default.post(`${this.baseUrl}/v2/checkout/orders`, {
                intent: 'CAPTURE',
                purchase_units: [
                    {
                        amount: {
                            currency_code: currency,
                            value: amount
                        }
                    }
                ]
            }, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            return response.data;
        }
        catch (error) {
            logger_1.logger.error(error, 'PayPal create order failed');
            throw error;
        }
    }
    async captureOrder(orderId) {
        return this.captureOrderBreaker.fire(orderId);
    }
    async captureOrderInternal(orderId) {
        const token = await this.getAccessToken();
        try {
            const response = await axios_1.default.post(`${this.baseUrl}/v2/checkout/orders/${orderId}/capture`, {}, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            return response.data;
        }
        catch (error) {
            logger_1.logger.error(error, 'PayPal capture order failed');
            throw error;
        }
    }
};
exports.PayPalService = PayPalService;
exports.PayPalService = PayPalService = __decorate([
    (0, typedi_1.Service)(),
    __metadata("design:paramtypes", [])
], PayPalService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxzZXJ2aWNlc1xccGF5cGFsLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsbUNBQWlDO0FBQ2pDLGtEQUEwQjtBQUMxQixxREFBMkM7QUFDM0MsNENBQXlDO0FBQ3pDLDhGQUEyRjtBQWVwRixJQUFNLGFBQWEsR0FBbkIsTUFBTSxhQUFhO0lBQ2hCLE9BQU8sQ0FBUztJQUNoQixRQUFRLENBQVM7SUFDakIsWUFBWSxDQUFTO0lBQ3JCLFdBQVcsR0FBa0IsSUFBSSxDQUFDO0lBQ2xDLFdBQVcsR0FBVyxDQUFDLENBQUM7SUFFaEMsbUJBQW1CO0lBQ1gsa0JBQWtCLENBQU07SUFDeEIsbUJBQW1CLENBQU07SUFFakM7UUFDRSxJQUFJLENBQUMsT0FBTyxHQUFHLGdCQUFHLENBQUMsV0FBVyxLQUFLLE1BQU07WUFDdkMsQ0FBQyxDQUFDLDBCQUEwQjtZQUM1QixDQUFDLENBQUMsa0NBQWtDLENBQUM7UUFFdkMsSUFBSSxDQUFDLFFBQVEsR0FBRyxnQkFBRyxDQUFDLGdCQUFnQixJQUFJLEVBQUUsQ0FBQztRQUMzQyxJQUFJLENBQUMsWUFBWSxHQUFHLGdCQUFHLENBQUMsb0JBQW9CLElBQUksRUFBRSxDQUFDO1FBRW5ELElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1lBQ3ZDLGVBQU0sQ0FBQyxJQUFJLENBQUMsOERBQThELENBQUMsQ0FBQztRQUNoRixDQUFDO1FBRUQsOEJBQThCO1FBQzlCLElBQUksQ0FBQyxrQkFBa0IsR0FBRyw2Q0FBcUIsQ0FBQyxNQUFNLENBQ3BELENBQUMsTUFBYyxFQUFFLFFBQWdCLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUFDLEVBQ2hGLEVBQUUsSUFBSSxFQUFFLG9CQUFvQixFQUFFLENBQy9CLENBQUM7UUFFRixJQUFJLENB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UUFDaEQsTUFBTSxLQUFLLEdBQUcsTUFBTSxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7UUFFMUMsSUFBSSxDQUFDO1lBQ0gsTUFBTSxRQUFRLEdBQUcsTUFBTSxlQUFLLENBQUMsSUFBSSxDQUMvQixHQUFHLElBQUksQ0FBQyxPQUFPLHVCQUF1QixPQUFPLFVBQVUsRUFDdkQsRUFBRSxFQUNGO2dCQUNFLE9BQU8sRUFBRTtvQkFDUCxlQUFlLEVBQUUsVUFBVSxLQUFLLEVBQUU7b0JBQ2xDLGNBQWMsRUFBRSxrQkFBa0I7aUJBQ25DO2FBQ0YsQ0FDRixDQUFDO1lBRUYsT0FBTyxRQUFRLENBQUMsSUFBSSxDQUFDO1FBQ3ZCLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsZUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsNkJBQTZCLENBQUMsQ0FBQztZQUNuRCxNQUFNLEtBQUssQ0FBQztRQUNkLENBQUM7SUFDSCxDQUFDO0NBQ0YsQ0FBQTtBQTVIWSxzQ0FBYTt3QkFBYixhQUFhO0lBRHpCLElBQUEsZ0JBQU8sR0FBRTs7R0FDRyxhQUFhLENBNEh6QiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXEFsZWphbmRyb1xcQUlHZXN0aW9uXFxiYWNrZW5kXFxzcmNcXHNlcnZpY2VzXFxwYXlwYWwuc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTZXJ2aWNlIH0gZnJvbSAndHlwZWRpJztcbmltcG9ydCBheGlvcyBmcm9tICdheGlvcyc7XG5pbXBvcnQgeyBlbnYgfSBmcm9tICcuLi9jb25maWcvZW52LnNjaGVtYSc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuLi91dGlscy9sb2dnZXInO1xuaW1wb3J0IHsgQ2lyY3VpdEJyZWFrZXJGYWN0b3J5IH0gZnJvbSAnLi4vaW5mcmFzdHJ1Y3R1cmUvcmVzaWxpZW5jZS9DaXJjdWl0QnJlYWtlckZhY3RvcnknO1xuXG5pbnRlcmZhY2UgQ3JlYXRlT3JkZXJSZXNwb25zZSB7XG4gIGlkOiBzdHJpbmc7XG4gIHN0YXR1czogc3RyaW5nO1xuICBsaW5rczogQXJyYXk8eyBocmVmOiBzdHJpbmc7IHJlbDogc3RyaW5nOyBtZXRob2Q6IHN0cmluZyB9Pjtcbn1cblxuaW50ZXJmYWNlIENhcHR1cmVPcmRlclJlc3BvbnNlIHtcbiAgaWQ6IHN0cmluZztcbiAgc3RhdHVzOiBzdHJpbmc7XG4gIHBheWVyOiBhbnk7XG59XG5cbkBTZXJ2aWNlKClcbmV4cG9ydCBjbGFzcyBQYXlQYWxTZXJ2aWNlIHtcbiAgcHJpdmF0ZSBiYXNlVXJsOiBzdHJpbmc7XG4gIHByaXZhdGUgY2xpZW50SWQ6IHN0cmluZztcbiAgcHJpdmF0ZSBjbGllbnRTZWNyZXQ6IHN0cmluZztcbiAgcHJpdmF0ZSBhY2Nlc3NUb2tlbjogc3RyaW5nIHwgbnVsbCA9IG51bGw7XG4gIHByaXZhdGUgdG9rZW5FeHBpcnk6IG51bWJlciA9IDA7XG5cbiAgLy8gQ2lyY3VpdCBCcmVha2Vyc1xuICBwcml2YXRlIGNyZWF0ZU9yZGVyQnJlYWtlcjogYW55O1xuICBwcml2YXRlIGNhcHR1cmVPcmRlckJyZWFrZXI6IGFueTtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLmJhc2VVcmwgPSBlbnYuUEFZUEFMX01PREUgPT09ICdsaXZlJ1xuICAgICAgPyAnaHR0cHM6Ly9hcGktbS5wYXlwYWwuY29tJ1xuICAgICAgOiAnaHR0cHM6Ly9hcGktbS5zYW5kYm94LnBheXBhbC5jb20nO1xuXG4gICAgdGhpcy5jbGllbnRJZCA9IGVudi5QQVlQQUxfQ0xJRU5UX0lEIHx8ICcnO1xuICAgIHRoaXMuY2xpZW50U2VjcmV0ID0gZW52LlBBWVBBTF9DTElFTlRfU0VDUkVUIHx8ICcnO1xuXG4gICAgaWYgKCF0aGlzLmNsaWVudElkIHx8ICF0aGlzLmNsaWVudFNlY3JldCkge1xuICAgICAgICBsb2dnZXIud2FybignUGF5UGFsIGNyZWRlbnRpYWxzIG1pc3NpbmcuIFBheVBhbFNlcnZpY2Ugd2lsbCBub3QgZnVuY3Rpb24uJyk7XG4gICAgfVxuXG4gICAgLy8gSW5pdGlhbGl6ZSBDaXJjdWl0IEJyZWFrZXJzXG4gICAgdGhpcy5jcmVhdGVPcmRlckJyZWFrZXIgPSBDaXJjdWl0QnJlYWtlckZhY3RvcnkuY3JlYXRlKFxuICAgICAgKGFtb3VudDogc3RyaW5nLCBjdXJyZW5jeTogc3RyaW5nKSA9PiB0aGlzLmNyZWF0ZU9yZGVySW50ZXJuYWwoYW1vdW50LCBjdXJyZW5jeSksXG4gICAgICB7IG5hbWU6ICdQYXlQYWwuY3JlYXRlT3JkZXInIH1cbiAgICApO1xuXG4gICAgdGhpcy5jYXB0dXJlT3JkZXJCcmVha2VyID0gQ2lyY3VpdEJyZWFrZXJGYWN0b3J5LmNyZWF0ZShcbiAgICAgIChvcmRlcklkOiBzdHJpbmcpID0+IHRoaXMuY2FwdHVyZU9yZGVySW50ZXJuYWwob3JkZXJJZCksXG4gICAgICB7IG5hbWU6ICdQYXlQYWwuY2FwdHVyZU9yZGVyJyB9XG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZ2V0QWNjZXNzVG9rZW4oKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBpZiAodGhpcy5hY2Nlc3NUb2tlbiAmJiBEYXRlLm5vdygpIDwgdGhpcy50b2tlbkV4cGlyeSkge1xuICAgICAgcmV0dXJuIHRoaXMuYWNjZXNzVG9rZW47XG4gICAgfVxuXG4gICAgY29uc3QgYXV0aCA9IEJ1ZmZlci5mcm9tKGAke3RoaXMuY2xpZW50SWR9OiR7dGhpcy5jbGllbnRTZWNyZXR9YCkudG9TdHJpbmcoJ2Jhc2U2NCcpO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgYXhpb3MucG9zdChcbiAgICAgICAgYCR7dGhpcy5iYXNlVXJsfS92MS9vYXV0aDIvdG9rZW5gLFxuICAgICAgICAnZ3JhbnRfdHlwZT1jbGllbnRfY3JlZGVudGlhbHMnLFxuICAgICAgICB7XG4gICAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICAgJ0F1dGhvcml6YXRpb24nOiBgQmFzaWMgJHthdXRofWAsXG4gICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCdcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICk7XG5cbiAgICAgIHRoaXMuYWNjZXNzVG9rZW4gPSByZXNwb25zZS5kYXRhLmFjY2Vzc190b2tlbjtcbiAgICAgIHRoaXMudG9rZW5FeHBpcnkgPSBEYXRlLm5vdygpICsgKHJlc3BvbnNlLmRhdGEuZXhwaXJlc19pbiAqIDEwMDApIC0gNjAwMDA7IC8vIEJ1ZmZlciAxIG1pblxuICAgICAgcmV0dXJuIHRoaXMuYWNjZXNzVG9rZW4hO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoZXJyb3IsICdGYWlsZWQgdG8gZ2V0IFBheVBhbCBhY2Nlc3MgdG9rZW4nKTtcbiAgICAgIHRocm93IG5ldyBFcnJvcignUGF5UGFsIGF1dGhlbnRpY2F0aW9uIGZhaWxlZCcpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZU9yZGVyKGFtb3VudDogc3RyaW5nLCBjdXJyZW5jeTogc3RyaW5nID0gJ1VTRCcpOiBQcm9taXNlPENyZWF0ZU9yZGVyUmVzcG9uc2U+IHtcbiAgICAgIHJldHVybiB0aGlzLmNyZWF0ZU9yZGVyQnJlYWtlci5maXJlKGFtb3VudCwgY3VycmVuY3kpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBjcmVhdGVPcmRlckludGVybmFsKGFtb3VudDogc3RyaW5nLCBjdXJyZW5jeTogc3RyaW5nKTogUHJvbWlzZTxDcmVhdGVPcmRlclJlc3BvbnNlPiB7XG4gICAgY29uc3QgdG9rZW4gPSBhd2FpdCB0aGlzLmdldEFjY2Vzc1Rva2VuKCk7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBheGlvcy5wb3N0KFxuICAgICAgICBgJHt0aGlzLmJhc2VVcmx9L3YyL2NoZWNrb3V0L29yZGVyc2AsXG4gICAgICAgIHtcbiAgICAgICAgICBpbnRlbnQ6ICdDQVBUVVJFJyxcbiAgICAgICAgICBwdXJjaGFzZV91bml0czogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBhbW91bnQ6IHtcbiAgICAgICAgICAgICAgICBjdXJyZW5jeV9jb2RlOiBjdXJyZW5jeSxcbiAgICAgICAgICAgICAgICB2YWx1ZTogYW1vdW50XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICBdXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAnQXV0aG9yaXphdGlvbic6IGBCZWFyZXIgJHt0b2tlbn1gLFxuICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJ1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgKTtcblxuICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcihlcnJvciwgJ1BheVBhbCBjcmVhdGUgb3JkZXIgZmFpbGVkJyk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICBhc3luYyBjYXB0dXJlT3JkZXIob3JkZXJJZDogc3RyaW5nKTogUHJvbWlzZTxDYXB0dXJlT3JkZXJSZXNwb25zZT4ge1xuICAgICAgcmV0dXJuIHRoaXMuY2FwdHVyZU9yZGVyQnJlYWtlci5maXJlKG9yZGVySWQpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBjYXB0dXJlT3JkZXJJbnRlcm5hbChvcmRlcklkOiBzdHJpbmcpOiBQcm9taXNlPENhcHR1cmVPcmRlclJlc3BvbnNlPiB7XG4gICAgY29uc3QgdG9rZW4gPSBhd2FpdCB0aGlzLmdldEFjY2Vzc1Rva2VuKCk7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBheGlvcy5wb3N0KFxuICAgICAgICBgJHt0aGlzLmJhc2VVcmx9L3YyL2NoZWNrb3V0L29yZGVycy8ke29yZGVySWR9L2NhcHR1cmVgLFxuICAgICAgICB7fSxcbiAgICAgICAge1xuICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke3Rva2VufWAsXG4gICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICApO1xuXG4gICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKGVycm9yLCAnUGF5UGFsIGNhcHR1cmUgb3JkZXIgZmFpbGVkJyk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==