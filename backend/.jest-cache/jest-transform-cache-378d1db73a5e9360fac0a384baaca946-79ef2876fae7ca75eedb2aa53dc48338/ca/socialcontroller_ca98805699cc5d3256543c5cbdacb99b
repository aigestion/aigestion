8b2da3b83db5cbea1f072106b055ea39
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.SocialController = void 0;
const axios_1 = __importDefault(require("axios"));
const typedi_1 = require("typedi");
const response_builder_1 = require("../common/response-builder");
const index_1 = require("../config/index");
const instagram_service_1 = require("../services/instagram.service");
const linkedin_service_1 = require("../services/linkedin.service");
const tiktok_service_1 = require("../services/tiktok.service");
const x_service_1 = require("../services/x.service");
const FB_API_URL = index_1.config.whatsapp.apiUrl;
class SocialController {
    // Publicar en Facebook Page
    static async publishPost(req, res) {
        try {
            const { message, link } = req.body;
            const pageId = process.env.FACEBOOK_PAGE_ID;
            const accessToken = process.env.FACEBOOK_ACCESS_TOKEN;
            if (!pageId || !accessToken) {
                res.status(500).json({ error: 'Facebook credentials not configured' });
                return;
            }
            console.log(`üöÄ Publishing to Facebook Page ${pageId}...`);
            const response = await axios_1.default.post(`${FB_API_URL}/${pageId}/feed`, {
                message,
                link,
                access_token: accessToken,
            });
            console.log('‚úÖ Published successfully:', response.data);
            res.json({ success: true, postId: response.data.id });
        }
        catch (error) {
            console.error('‚ùå Error publishing to Facebook:', error.response?.data || error.message);
            res
                .status(500)
                .json({ error: 'Failed to publish to Facebook', details: error.response?.data });
        }
    }
    // Obtener M√©tricas de la P√°gina
    static async getPageStats(_req, res) {
        try {
            const pageId = process.env.FACEBOOK_PAGE_ID;
            const accessToken = process.env.FACEBOOK_ACCESS_TOKEN;
            if (!pageId || !accessToken) {
                // Mock data si no hay credenciales (para demo)
                res.json({
                    followers: 1250,
                    impressions: 4500,
                    engagement: 8.5,
                    mock: true,
                });
            }
            const response = await axios_1.default.get(`${FB_API_URL}/${pageId}`, {
                params: {
                    fields: 'fan_count,rating_count,new_like_count,talking_about_count',
                    access_token: accessToken,
                },
            });
            res.json(response.data);
        }
        catch (error) {
            console.error('‚ùå Error fetching FB stats:', error.response?.data || error.message);
            res
                .status(500)
                .json((0, response_builder_1.buildError)('Failed to get stats', 'SOCIAL_ERROR', 500, _req.requestId));
        }
    }
    // Enviar Mensaje Directo Instagram
    static async sendInstagramDM(req, res) {
        try {
            const { recipientId, text } = req.body;
            const instagramService = typedi_1.Container.get(instagram_service_1.InstagramService);
            const result = await instagramService.sendDM(recipientId, text);
            res.json({ success: true, result });
        }
        catch (error) {
            res.status(500).json({ error: 'Failed to send Instagram DM' });
        }
    }
    // Publicar Tweet en X
    static async postTweet(req, res) {
        try {
            const { text } = req.body;
            // Ensure we have a string; if not, coerce to string or reject
            if (typeof text !== 'string' || text.trim() === '') {
                res.status(400).json({ error: 'Invalid tweet text' });
                return;
            }
            const xService = typedi_1.Container.get(x_service_1.XService);
            const result = await xService.postTweet(text);
            res.json({ success: true, result });
        }
        catch (error) {
            res.status(500).json({ error: 'Failed to post Tweet to X' });
        }
    }
    // Publicar Video en TikTok
    static async publishTikTokVideo(req, res) {
        try {
            const { videoUrl, title } = req.body || {};
            const tiktokService = typedi_1.Container.get(tiktok_service_1.TikTokService);
            const result = await tiktokService.publishVideo(videoUrl, title);
            res.json({ success: true, result });
        }
        catch (error) {
            res.status(500).json({ error: 'Failed to publish to TikTok' });
        }
    }
    // Publicar Post en LinkedIn
    static async publishLinkedInPost(req, res) {
        try {
            const { text } = req.body || {};
            const linkedinService = typedi_1.Container.get(linkedin_service_1.LinkedInService);
            const result = await linkedinService.sharePost(text);
            res.json({ success: true, result });
        }
        catch (error) {
            res.status(500).json({ error: 'Failed to publish to LinkedIn' });
        }
    }
}
exports.SocialController = SocialController;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxjb250cm9sbGVyc1xcc29jaWFsLmNvbnRyb2xsZXIudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsa0RBQTBCO0FBRTFCLG1DQUFtQztBQUVuQyxpRUFBd0Q7QUFDeEQsMkNBQXlDO0FBQ3pDLHFFQUFpRTtBQUNqRSxtRUFBK0Q7QUFDL0QsK0RBQTJEO0FBQzNELHFEQUFpRDtBQUVqRCxNQUFNLFVBQVUsR0FBRyxjQUFNLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQztBQUUxQyxNQUFhLGdCQUFnQjtJQUMzQiw0QkFBNEI7SUFDNUIsTUFBTSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsR0FBWSxFQUFFLEdBQWE7UUFDbEQsSUFBSSxDQUFDO1lBQ0gsTUFBTSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1lBQ25DLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUM7WUFDNUMsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsQ0FBQztZQUV0RCxJQUFJLENBQUMsTUFBTSxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7Z0JBQzVCLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLHFDQUFxQyxFQUFFLENBQUMsQ0FBQztnQkFDdkUsT0FBTztZQUNULENBQUM7WUFFRCxPQUFPLENBQUMsR0FBRyxDQUFDLGtDQUFrQyxNQUFNLEtBQUssQ0FBQyxDQUFDO1lBRTNELE1BQU0sUUFBUSxHQUFHLE1BQU0sZUFBSyxDQUFDLElBQUksQ0FBQyxHQUFHLFVBQVUsSUFBSSxNQUFNLE9BQU8sRUFBRTtnQkFDaEUsT0FBTztnQkFDUCxJQUFJO2dCQUNKLFlBQVksRUFBRSxXQUFXO2FBQzFCLENBQUMsQ0FBQztZQUVILE9BQU8sQ0FBQyxHQUFHLENBQUMsMkJB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RUFBRSxLQUFLLENBQUMsQ0FBQztZQUNqRSxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO1FBQ3RDLENBQUM7UUFBQyxPQUFPLEtBQVUsRUFBRSxDQUFDO1lBQ3BCLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLDZCQUE2QixFQUFFLENBQUMsQ0FBQztRQUNqRSxDQUFDO0lBQ0gsQ0FBQztJQUVELDRCQUE0QjtJQUM1QixNQUFNLENBQUMsS0FBSyxDQUFDLG1CQUFtQixDQUFDLEdBQVksRUFBRSxHQUFhO1FBQzFELElBQUksQ0FBQztZQUNILE1BQU0sRUFBRSxJQUFJLEVBQUUsR0FBSSxHQUFXLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQztZQUN6QyxNQUFNLGVBQWUsR0FBRyxrQkFBUyxDQUFDLEdBQUcsQ0FBQyxrQ0FBZSxDQUFRLENBQUM7WUFDOUQsTUFBTSxNQUFNLEdBQUcsTUFBTSxlQUFlLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3JELEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7UUFDdEMsQ0FBQztRQUFDLE9BQU8sS0FBVSxFQUFFLENBQUM7WUFDcEIsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsK0JBQStCLEVBQUUsQ0FBQyxDQUFDO1FBQ25FLENBQUM7SUFDSCxDQUFDO0NBQ0Y7QUFuSEQsNENBbUhDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcQWxlamFuZHJvXFxBSUdlc3Rpb25cXGJhY2tlbmRcXHNyY1xcY29udHJvbGxlcnNcXHNvY2lhbC5jb250cm9sbGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBheGlvcyBmcm9tICdheGlvcyc7XG5pbXBvcnQgdHlwZSB7IFJlcXVlc3QsIFJlc3BvbnNlIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBDb250YWluZXIgfSBmcm9tICd0eXBlZGknO1xuXG5pbXBvcnQgeyBidWlsZEVycm9yIH0gZnJvbSAnLi4vY29tbW9uL3Jlc3BvbnNlLWJ1aWxkZXInO1xuaW1wb3J0IHsgY29uZmlnIH0gZnJvbSAnLi4vY29uZmlnL2luZGV4JztcbmltcG9ydCB7IEluc3RhZ3JhbVNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9pbnN0YWdyYW0uc2VydmljZSc7XG5pbXBvcnQgeyBMaW5rZWRJblNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9saW5rZWRpbi5zZXJ2aWNlJztcbmltcG9ydCB7IFRpa1Rva1NlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy90aWt0b2suc2VydmljZSc7XG5pbXBvcnQgeyBYU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL3guc2VydmljZSc7XG5cbmNvbnN0IEZCX0FQSV9VUkwgPSBjb25maWcud2hhdHNhcHAuYXBpVXJsO1xuXG5leHBvcnQgY2xhc3MgU29jaWFsQ29udHJvbGxlciB7XG4gIC8vIFB1YmxpY2FyIGVuIEZhY2Vib29rIFBhZ2VcbiAgc3RhdGljIGFzeW5jIHB1Ymxpc2hQb3N0KHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IG1lc3NhZ2UsIGxpbmsgfSA9IHJlcS5ib2R5O1xuICAgICAgY29uc3QgcGFnZUlkID0gcHJvY2Vzcy5lbnYuRkFDRUJPT0tfUEFHRV9JRDtcbiAgICAgIGNvbnN0IGFjY2Vzc1Rva2VuID0gcHJvY2Vzcy5lbnYuRkFDRUJPT0tfQUNDRVNTX1RPS0VOO1xuXG4gICAgICBpZiAoIXBhZ2VJZCB8fCAhYWNjZXNzVG9rZW4pIHtcbiAgICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oeyBlcnJvcjogJ0ZhY2Vib29rIGNyZWRlbnRpYWxzIG5vdCBjb25maWd1cmVkJyB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBjb25zb2xlLmxvZyhg8J+agCBQdWJsaXNoaW5nIHRvIEZhY2Vib29rIFBhZ2UgJHtwYWdlSWR9Li4uYCk7XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgYXhpb3MucG9zdChgJHtGQl9BUElfVVJMfS8ke3BhZ2VJZH0vZmVlZGAsIHtcbiAgICAgICAgbWVzc2FnZSxcbiAgICAgICAgbGluayxcbiAgICAgICAgYWNjZXNzX3Rva2VuOiBhY2Nlc3NUb2tlbixcbiAgICAgIH0pO1xuXG4gICAgICBjb25zb2xlLmxvZygn4pyFIFB1Ymxpc2hlZCBzdWNjZXNzZnVsbHk6JywgcmVzcG9uc2UuZGF0YSk7XG4gICAgICByZXMuanNvbih7IHN1Y2Nlc3M6IHRydWUsIHBvc3RJZDogcmVzcG9uc2UuZGF0YS5pZCB9KTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJyb3IgcHVibGlzaGluZyB0byBGYWNlYm9vazonLCBlcnJvci5yZXNwb25zZT8uZGF0YSB8fCBlcnJvci5tZXNzYWdlKTtcbiAgICAgIHJlc1xuICAgICAgICAuc3RhdHVzKDUwMClcbiAgICAgICAgLmpzb24oeyBlcnJvcjogJ0ZhaWxlZCB0byBwdWJsaXNoIHRvIEZhY2Vib29rJywgZGV0YWlsczogZXJyb3IucmVzcG9uc2U/LmRhdGEgfSk7XG4gICAgfVxuICB9XG5cbiAgLy8gT2J0ZW5lciBNw6l0cmljYXMgZGUgbGEgUMOhZ2luYVxuICBzdGF0aWMgYXN5bmMgZ2V0UGFnZVN0YXRzKF9yZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcGFnZUlkID0gcHJvY2Vzcy5lbnYuRkFDRUJPT0tfUEFHRV9JRDtcbiAgICAgIGNvbnN0IGFjY2Vzc1Rva2VuID0gcHJvY2Vzcy5lbnYuRkFDRUJPT0tfQUNDRVNTX1RPS0VOO1xuXG4gICAgICBpZiAoIXBhZ2VJZCB8fCAhYWNjZXNzVG9rZW4pIHtcbiAgICAgICAgLy8gTW9jayBkYXRhIHNpIG5vIGhheSBjcmVkZW5jaWFsZXMgKHBhcmEgZGVtbylcbiAgICAgICAgcmVzLmpzb24oe1xuICAgICAgICAgIGZvbGxvd2VyczogMTI1MCxcbiAgICAgICAgICBpbXByZXNzaW9uczogNDUwMCxcbiAgICAgICAgICBlbmdhZ2VtZW50OiA4LjUsXG4gICAgICAgICAgbW9jazogdHJ1ZSxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgYXhpb3MuZ2V0KGAke0ZCX0FQSV9VUkx9LyR7cGFnZUlkfWAsIHtcbiAgICAgICAgcGFyYW1zOiB7XG4gICAgICAgICAgZmllbGRzOiAnZmFuX2NvdW50LHJhdGluZ19jb3VudCxuZXdfbGlrZV9jb3VudCx0YWxraW5nX2Fib3V0X2NvdW50JyxcbiAgICAgICAgICBhY2Nlc3NfdG9rZW46IGFjY2Vzc1Rva2VuLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIHJlcy5qc29uKHJlc3BvbnNlLmRhdGEpO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvciBmZXRjaGluZyBGQiBzdGF0czonLCBlcnJvci5yZXNwb25zZT8uZGF0YSB8fCBlcnJvci5tZXNzYWdlKTtcbiAgICAgIChyZXMgYXMgYW55KVxuICAgICAgICAuc3RhdHVzKDUwMClcbiAgICAgICAgLmpzb24oYnVpbGRFcnJvcignRmFpbGVkIHRvIGdldCBzdGF0cycsICdTT0NJQUxfRVJST1InLCA1MDAsIChfcmVxIGFzIGFueSkucmVxdWVzdElkKSk7XG4gICAgfVxuICB9XG5cbiAgLy8gRW52aWFyIE1lbnNhamUgRGlyZWN0byBJbnN0YWdyYW1cbiAgc3RhdGljIGFzeW5jIHNlbmRJbnN0YWdyYW1ETShyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyByZWNpcGllbnRJZCwgdGV4dCB9ID0gcmVxLmJvZHk7XG4gICAgICBjb25zdCBpbnN0YWdyYW1TZXJ2aWNlID0gQ29udGFpbmVyLmdldChJbnN0YWdyYW1TZXJ2aWNlKSBhcyBhbnk7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBpbnN0YWdyYW1TZXJ2aWNlLnNlbmRETShyZWNpcGllbnRJZCwgdGV4dCk7XG4gICAgICByZXMuanNvbih7IHN1Y2Nlc3M6IHRydWUsIHJlc3VsdCB9KTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IGVycm9yOiAnRmFpbGVkIHRvIHNlbmQgSW5zdGFncmFtIERNJyB9KTtcbiAgICB9XG4gIH1cblxuICAvLyBQdWJsaWNhciBUd2VldCBlbiBYXG4gIHN0YXRpYyBhc3luYyBwb3N0VHdlZXQocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgdGV4dCB9ID0gcmVxLmJvZHkgYXMgeyB0ZXh0PzogdW5rbm93biB9O1xuICAgICAgLy8gRW5zdXJlIHdlIGhhdmUgYSBzdHJpbmc7IGlmIG5vdCwgY29lcmNlIHRvIHN0cmluZyBvciByZWplY3RcbiAgICAgIGlmICh0eXBlb2YgdGV4dCAhPT0gJ3N0cmluZycgfHwgdGV4dC50cmltKCkgPT09ICcnKSB7XG4gICAgICAgIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgZXJyb3I6ICdJbnZhbGlkIHR3ZWV0IHRleHQnIH0pO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBjb25zdCB4U2VydmljZSA9IENvbnRhaW5lci5nZXQoWFNlcnZpY2UpO1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgeFNlcnZpY2UucG9zdFR3ZWV0KHRleHQpO1xuICAgICAgcmVzLmpzb24oeyBzdWNjZXNzOiB0cnVlLCByZXN1bHQgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oeyBlcnJvcjogJ0ZhaWxlZCB0byBwb3N0IFR3ZWV0IHRvIFgnIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8vIFB1YmxpY2FyIFZpZGVvIGVuIFRpa1Rva1xuICBzdGF0aWMgYXN5bmMgcHVibGlzaFRpa1Rva1ZpZGVvKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IHZpZGVvVXJsLCB0aXRsZSB9ID0gKHJlcSBhcyBhbnkpLmJvZHkgfHwge307XG4gICAgICBjb25zdCB0aWt0b2tTZXJ2aWNlID0gQ29udGFpbmVyLmdldChUaWtUb2tTZXJ2aWNlKTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRpa3Rva1NlcnZpY2UucHVibGlzaFZpZGVvKHZpZGVvVXJsLCB0aXRsZSk7XG4gICAgICByZXMuanNvbih7IHN1Y2Nlc3M6IHRydWUsIHJlc3VsdCB9KTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IGVycm9yOiAnRmFpbGVkIHRvIHB1Ymxpc2ggdG8gVGlrVG9rJyB9KTtcbiAgICB9XG4gIH1cblxuICAvLyBQdWJsaWNhciBQb3N0IGVuIExpbmtlZEluXG4gIHN0YXRpYyBhc3luYyBwdWJsaXNoTGlua2VkSW5Qb3N0KHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IHRleHQgfSA9IChyZXEgYXMgYW55KS5ib2R5IHx8IHt9O1xuICAgICAgY29uc3QgbGlua2VkaW5TZXJ2aWNlID0gQ29udGFpbmVyLmdldChMaW5rZWRJblNlcnZpY2UpIGFzIGFueTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGxpbmtlZGluU2VydmljZS5zaGFyZVBvc3QodGV4dCk7XG4gICAgICByZXMuanNvbih7IHN1Y2Nlc3M6IHRydWUsIHJlc3VsdCB9KTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IGVycm9yOiAnRmFpbGVkIHRvIHB1Ymxpc2ggdG8gTGlua2VkSW4nIH0pO1xuICAgIH1cbiAgfVxufVxuIl0sInZlcnNpb24iOjN9