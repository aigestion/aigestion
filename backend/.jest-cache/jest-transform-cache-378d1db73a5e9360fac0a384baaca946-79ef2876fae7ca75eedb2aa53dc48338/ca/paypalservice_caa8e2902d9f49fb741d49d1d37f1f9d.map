{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\paypal.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\paypal.service.ts"],"sourcesContent":["import { injectable } from 'inversify';\nimport axios from 'axios';\nimport { env } from '../config/env.schema';\nimport { logger } from '../utils/logger';\nimport { CircuitBreakerFactory } from '../infrastructure/resilience/CircuitBreakerFactory';\n\ninterface CreateOrderResponse {\n  id: string;\n  status: string;\n  links: Array<{ href: string; rel: string; method: string }>;\n}\n\ninterface CaptureOrderResponse {\n  id: string;\n  status: string;\n  payer: any;\n}\n\n@injectable()\nexport class PayPalService {\n  private baseUrl: string;\n  private clientId: string;\n  private clientSecret: string;\n  private accessToken: string | null = null;\n  private tokenExpiry: number = 0;\n\n  // Circuit Breakers\n  private createOrderBreaker: any;\n  private captureOrderBreaker: any;\n\n  constructor() {\n    this.baseUrl =\n      env.PAYPAL_MODE === 'live' ? 'https://api-m.paypal.com' : 'https://api-m.sandbox.paypal.com';\n\n    this.clientId = env.PAYPAL_CLIENT_ID || '';\n    this.clientSecret = env.PAYPAL_CLIENT_SECRET || '';\n\n    if (!this.clientId || !this.clientSecret) {\n      logger.warn('PayPal credentials missing. PayPalService will not function.');\n    }\n\n    // Initialize Circuit Breakers\n    this.createOrderBreaker = CircuitBreakerFactory.create(\n      (amount: string, currency: string) => this.createOrderInternal(amount, currency),\n      { name: 'PayPal.createOrder' },\n    );\n\n    this.captureOrderBreaker = CircuitBreakerFactory.create(\n      (orderId: string) => this.captureOrderInternal(orderId),\n      { name: 'PayPal.captureOrder' },\n    );\n  }\n\n  private async getAccessToken(): Promise<string> {\n    if (this.accessToken && Date.now() < this.tokenExpiry) {\n      return this.accessToken;\n    }\n\n    const auth = Buffer.from(`${this.clientId}:${this.clientSecret}`).toString('base64');\n\n    try {\n      const response = await axios.post(\n        `${this.baseUrl}/v1/oauth2/token`,\n        'grant_type=client_credentials',\n        {\n          headers: {\n            Authorization: `Basic ${auth}`,\n            'Content-Type': 'application/x-www-form-urlencoded',\n          },\n        },\n      );\n\n      this.accessToken = response.data.access_token;\n      this.tokenExpiry = Date.now() + response.data.expires_in * 1000 - 60000; // Buffer 1 min\n      return this.accessToken!;\n    } catch (error) {\n      logger.error(error, 'Failed to get PayPal access token');\n      throw new Error('PayPal authentication failed');\n    }\n  }\n\n  async createOrder(amount: string, currency: string = 'USD'): Promise<CreateOrderResponse> {\n    return this.createOrderBreaker.fire(amount, currency);\n  }\n\n  private async createOrderInternal(\n    amount: string,\n    currency: string,\n  ): Promise<CreateOrderResponse> {\n    const token = await this.getAccessToken();\n\n    try {\n      const response = await axios.post(\n        `${this.baseUrl}/v2/checkout/orders`,\n        {\n          intent: 'CAPTURE',\n          purchase_units: [\n            {\n              amount: {\n                currency_code: currency,\n                value: amount,\n              },\n            },\n          ],\n        },\n        {\n          headers: {\n            Authorization: `Bearer ${token}`,\n            'Content-Type': 'application/json',\n          },\n        },\n      );\n\n      return response.data;\n    } catch (error) {\n      logger.error(error, 'PayPal create order failed');\n      throw error;\n    }\n  }\n\n  async captureOrder(orderId: string): Promise<CaptureOrderResponse> {\n    return this.captureOrderBreaker.fire(orderId);\n  }\n\n  private async captureOrderInternal(orderId: string): Promise<CaptureOrderResponse> {\n    const token = await this.getAccessToken();\n\n    try {\n      const response = await axios.post(\n        `${this.baseUrl}/v2/checkout/orders/${orderId}/capture`,\n        {},\n        {\n          headers: {\n            Authorization: `Bearer ${token}`,\n            'Content-Type': 'application/json',\n          },\n        },\n      );\n\n      return response.data;\n    } catch (error) {\n      logger.error(error, 'PayPal capture order failed');\n      throw error;\n    }\n  }\n}\n"],"version":3}