{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\enhanced-voice.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\enhanced-voice.service.ts"],"sourcesContent":["import fs from 'fs/promises';\nimport { inject, injectable } from 'inversify';\nimport path from 'path';\nimport { env } from '../config/env.schema';\nimport { TYPES } from '../types';\nimport { logger } from '../utils/logger';\nimport { AIService } from './ai.service';\nimport { AnalyticsService } from './analytics.service';\nimport { ElevenLabsService } from './elevenlabs.service';\nimport { MetaverseService } from './metaverse.service';\nimport { QwenTTSService } from './qwen-tts.service';\n\ninterface ConversationMessage {\n  id: string;\n  text: string;\n  speaker: 'daniela' | 'client';\n  timestamp: Date;\n  emotion?: string;\n  confidence?: number;\n}\n\ninterface EmotionalAnalysis {\n  emotion: string;\n  confidence: number;\n  sentiment: 'positive' | 'negative' | 'neutral';\n  suggestions: string[];\n}\n\ninterface ConversationContext {\n  messages: ConversationMessage[];\n  emotionalHistory: EmotionalAnalysis[];\n  clientProfile: {\n    preferences: string[];\n    previousTopics: string[];\n    interactionStyle: string;\n  };\n}\n\ninterface SuggestedAction {\n  id: string;\n  text: string;\n  type: 'response' | 'action' | 'question';\n  priority: 'high' | 'medium' | 'low';\n  context: string;\n}\n\n@injectable()\nexport class EnhancedVoiceService {\n  private conversationContexts = new Map<string, ConversationContext>();\n\n  constructor(\n    @inject(TYPES.AIService) private aiService: AIService,\n    @inject(TYPES.AnalyticsService) private analyticsService: AnalyticsService,\n    @inject(TYPES.MetaverseService) private metaverseService: MetaverseService,\n    @inject(TYPES.ElevenLabsService) private elevenLabsService: ElevenLabsService,\n    @inject(TYPES.QwenTTSService) private qwenTTSService: QwenTTSService,\n  ) {}\n\n  /**\n   * Process conversation with emotional analysis and contextual responses\n   */\n  async processConversation(payload: {\n    audio?: Buffer;\n    text?: string;\n    sessionId: string;\n    userId: string;\n  }): Promise<{\n    transcription?: string;\n    emotionalAnalysis?: EmotionalAnalysis;\n    response: string;\n    audioResponse?: Buffer;\n    suggestedActions: SuggestedAction[];\n    context: ConversationContext;\n  }> {\n    try {\n      // Get or create conversation context\n      const context = this.getOrCreateContext(payload.sessionId, payload.userId);\n\n      // Process input (audio or text)\n      let transcription = payload.text;\n      if (payload.audio) {\n        transcription = await this.transcribeAudio(payload.audio);\n      }\n\n      if (!transcription) {\n        throw new Error('No input provided');\n      }\n\n      // Analyze emotion and sentiment\n      const emotionalAnalysis = await this.analyzeEmotion(transcription, context);\n\n      // Add message to context\n      context.messages.push({\n        id: Date.now().toString(),\n        text: transcription,\n        speaker: 'client',\n        timestamp: new Date(),\n        emotion: emotionalAnalysis.emotion,\n        confidence: emotionalAnalysis.confidence,\n      });\n\n      // Generate contextual response\n      const response = await this.generateContextualResponse(\n        transcription,\n        emotionalAnalysis,\n        context,\n      );\n\n      // Convert response to audio\n      const audioResponse = await this.textToSpeech(response);\n\n      // Generate suggested actions\n      const suggestedActions = await this.generateSuggestedActions(\n        transcription,\n        emotionalAnalysis,\n        context,\n      );\n\n      // Add Daniela's response to context\n      context.messages.push({\n        id: (Date.now() + 1).toString(),\n        text: response,\n        speaker: 'daniela',\n        timestamp: new Date(),\n        emotion: 'professional',\n      });\n\n      // Update emotional history\n      context.emotionalHistory.push(emotionalAnalysis);\n\n      // Update conversation context\n      this.conversationContexts.set(payload.sessionId, context);\n\n      return {\n        transcription,\n        emotionalAnalysis,\n        response,\n        audioResponse,\n        suggestedActions,\n        context,\n      };\n    } catch (error) {\n      logger.error(error, '[EnhancedVoiceService] Error processing conversation');\n      throw error;\n    }\n  }\n\n  /**\n   * Transcribe audio to text using enhanced speech recognition\n   */\n  private async transcribeAudio(audioBuffer: Buffer): Promise<string> {\n    try {\n      // Implementation with Google Cloud Speech-to-Text or similar\n      // For now, return mock transcription\n      logger.info('[EnhancedVoiceService] Transcribing audio...');\n\n      // TODO: Implement actual speech-to-text\n      return 'Audio transcribed successfully';\n    } catch (error) {\n      logger.error(error, '[EnhancedVoiceService] Error transcribing audio');\n      throw error;\n    }\n  }\n\n  /**\n   * Analyze emotional content of the message\n   */\n  private async analyzeEmotion(\n    text: string,\n    context: ConversationContext,\n  ): Promise<EmotionalAnalysis> {\n    try {\n      const prompt = `\n        Analiza el siguiente mensaje y determina la emoción principal del hablante.\n        Considera el contexto de la conversación previa si existe.\n\n        Mensaje: \"${text}\"\n        Contexto previo: ${context.messages\n          .slice(-3)\n          .map(m => m.text)\n          .join(' | ')}\n\n        Responde en formato JSON:\n        {\n          \"emotion\": \"happy|concerned|excited|professional|neutral\",\n          \"confidence\": 0.0-1.0,\n          \"sentiment\": \"positive|negative|neutral\",\n          \"suggestions\": [\"suggestion1\", \"suggestion2\"]\n        }\n      `;\n\n      const analysisText = await this.aiService.generateContent(prompt);\n\n      try {\n        const analysis = JSON.parse(analysisText);\n        return {\n          emotion: analysis.emotion || 'neutral',\n          confidence: analysis.confidence || 0.5,\n          sentiment: analysis.sentiment || 'neutral',\n          suggestions: analysis.suggestions || [],\n        };\n      } catch {\n        // Fallback if JSON parsing fails\n        return {\n          emotion: 'neutral',\n          confidence: 0.5,\n          sentiment: 'neutral',\n          suggestions: [],\n        };\n      }\n    } catch (error) {\n      logger.error(error, '[EnhancedVoiceService] Error analyzing emotion');\n      return {\n        emotion: 'neutral',\n        confidence: 0.5,\n        sentiment: 'neutral',\n        suggestions: [],\n      };\n    }\n  }\n\n  /**\n   * Generate contextual response based on emotion and conversation history\n   */\n  private async generateContextualResponse(\n    text: string,\n    emotionalAnalysis: EmotionalAnalysis,\n    context: ConversationContext,\n  ): Promise<string> {\n    try {\n      const systemPrompt = `\n        Eres Daniela, una asistente de IA futurista y empática de AIGestion.\n\n        Directrices:\n        - Adapta tu tono según la emoción detectada: ${emotionalAnalysis.emotion}\n        - Mantén un perfil profesional pero cercano\n        - Usa el contexto de la conversación para respuestas coherentes\n        - Sé proactiva y ofrece soluciones cuando sea apropiado\n        - Mantén las respuestas concisas pero informativas\n\n        Emoción detectada: ${emotionalAnalysis.emotion} (${emotionalAnalysis.confidence}% de confianza)\n        Sentimiento: ${emotionalAnalysis.sentiment}\n      `;\n\n      const conversationHistory = context.messages.map(msg => ({\n        role: msg.speaker === 'daniela' ? ('assistant' as const) : ('user' as const),\n        content: msg.text,\n      }));\n\n      const response = await this.aiService.streamChat({\n        prompt: text,\n        history: conversationHistory,\n        userId: context.messages[0]?.id || 'unknown',\n        userRole: 'premium',\n      });\n\n      // For now, return a mock response\n      // TODO: Implement actual streaming response handling\n      return this.generateResponseBasedOnEmotion(text, emotionalAnalysis);\n    } catch (error) {\n      logger.error(error, '[EnhancedVoiceService] Error generating response');\n      return 'Entendido. ¿En qué más puedo ayudarte?';\n    }\n  }\n\n  /**\n   * Generate response based on emotional analysis\n   */\n  private generateResponseBasedOnEmotion(text: string, analysis: EmotionalAnalysis): string {\n    const responses = {\n      happy: [\n        '¡Me alegra escuchar eso! ¿Hay algo específico en lo que pueda ayudarte para mantener este momento positivo?',\n        '¡Excelente! Tu energía es contagiosa. ¿Qué proyecto emocionante tienes en mente?',\n      ],\n      concerned: [\n        'Entiendo tu preocupación. Estoy aquí para ayudarte a encontrar la mejor solución.',\n        'Detecto que podría haber algún desafío. Permíteme ayudarte a analizar la situación.',\n      ],\n      excited: [\n        '¡Siento tu entusiasmo! Acompáñame en esta emocionante jornada tecnológica.',\n        'Tu energía es fantástica. ¿Qué innovación te tiene tan motivado?',\n      ],\n      professional: [\n        'Comprendido. Procederé con análisis profesional de tu solicitud.',\n        'Recibido. Analizando los parámetros para proporcionar la respuesta óptima.',\n      ],\n      neutral: [\n        'Entendido. ¿En qué puedo asistirte específicamente?',\n        'Recibido. Estoy lista para ayudarte con lo que necesites.',\n      ],\n    };\n\n    const emotionResponses =\n      responses[analysis.emotion as keyof typeof responses] || responses.neutral;\n    return emotionResponses[Math.floor(Math.random() * emotionResponses.length)];\n  }\n\n  /**\n   * Convert text to speech using ElevenLabs or Qwen3\n   */\n  public async textToSpeech(\n    text: string,\n    provider: 'elevenlabs' | 'qwen' = 'qwen',\n  ): Promise<Buffer> {\n    try {\n      const tempPath = path.join(process.cwd(), 'uploads', 'voice', `${Date.now()}.mp3`);\n\n      let audioPath: string;\n      if (provider === 'qwen') {\n        audioPath = await this.qwenTTSService.textToSpeech(text, tempPath);\n      } else {\n        // Fallback to ElevenLabs if needed\n        audioPath = await this.elevenLabsService.textToSpeech(\n          text,\n          env.ELEVENLABS_VOICE_ID || '',\n          tempPath,\n        );\n      }\n\n      const audioBuffer = await fs.readFile(audioPath);\n\n      // Cleanup temp file (optional, depends on if we want to stream or cache)\n      // await fs.unlink(audioPath);\n\n      return audioBuffer;\n    } catch (error) {\n      logger.error(error, '[EnhancedVoiceService] Error converting text to speech');\n      // If one fails, try the other as fallback\n      if (provider === 'qwen' && env.ELEVENLABS_API_KEY) {\n        logger.info('[EnhancedVoiceService] Falling back to ElevenLabs...');\n        return this.textToSpeech(text, 'elevenlabs');\n      }\n      throw error;\n    }\n  }\n\n  /**\n   * Generate suggested actions based on context\n   */\n  private async generateSuggestedActions(\n    text: string,\n    emotionalAnalysis: EmotionalAnalysis,\n    context: ConversationContext,\n  ): Promise<SuggestedAction[]> {\n    const actions: SuggestedAction[] = [];\n\n    // Analyze text for common patterns\n    if (text.toLowerCase().includes('dashboard') || text.toLowerCase().includes('mostrar')) {\n      actions.push({\n        id: 'dashboard',\n        text: 'Mostrar dashboard principal',\n        type: 'action',\n        priority: 'high',\n        context: 'visualization',\n      });\n    }\n\n    if (text.toLowerCase().includes('analizar') || text.toLowerCase().includes('métrica')) {\n      actions.push({\n        id: 'analytics',\n        text: 'Analizar métricas de rendimiento',\n        type: 'action',\n        priority: 'high',\n        context: 'analytics',\n      });\n    }\n\n    if (emotionalAnalysis.emotion === 'concerned') {\n      actions.push({\n        id: 'support',\n        text: '¿Necesitas ayuda técnica?',\n        type: 'question',\n        priority: 'medium',\n        context: 'support',\n      });\n    }\n\n    // Add contextual suggestions based on conversation history\n    if (context.messages.length > 3) {\n      actions.push({\n        id: 'summary',\n        text: 'Resumir nuestra conversación',\n        type: 'response',\n        priority: 'low',\n        context: 'summary',\n      });\n    }\n\n    return actions.slice(0, 3); // Limit to 3 suggestions\n  }\n\n  /**\n   * Get or create conversation context\n   */\n  private getOrCreateContext(sessionId: string, userId: string): ConversationContext {\n    if (!this.conversationContexts.has(sessionId)) {\n      this.conversationContexts.set(sessionId, {\n        messages: [],\n        emotionalHistory: [],\n        clientProfile: {\n          preferences: [],\n          previousTopics: [],\n          interactionStyle: 'professional',\n        },\n      });\n    }\n    return this.conversationContexts.get(sessionId)!;\n  }\n\n  /**\n   * Get conversation history\n   */\n  async getConversationHistory(sessionId: string): Promise<ConversationContext | null> {\n    return this.conversationContexts.get(sessionId) || null;\n  }\n\n  /**\n   * Clear conversation context\n   */\n  async clearConversation(sessionId: string): Promise<void> {\n    this.conversationContexts.delete(sessionId);\n  }\n}\n"],"version":3}