5ddb4471e428faa27517e7719e4a4dd3
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
var _a, _b, _c, _d, _e;
Object.defineProperty(exports, "__esModule", { value: true });
exports.EnhancedVoiceService = void 0;
const promises_1 = __importDefault(require("fs/promises"));
const inversify_1 = require("inversify");
const path_1 = __importDefault(require("path"));
const env_schema_1 = require("../config/env.schema");
const types_1 = require("../types");
const logger_1 = require("../utils/logger");
const ai_service_1 = require("./ai.service");
const analytics_service_1 = require("./analytics.service");
const elevenlabs_service_1 = require("./elevenlabs.service");
const metaverse_service_1 = require("./metaverse.service");
const qwen_tts_service_1 = require("./qwen-tts.service");
let EnhancedVoiceService = class EnhancedVoiceService {
    aiService;
    analyticsService;
    metaverseService;
    elevenLabsService;
    qwenTTSService;
    conversationContexts = new Map();
    constructor(aiService, analyticsService, metaverseService, elevenLabsService, qwenTTSService) {
        this.aiService = aiService;
        this.analyticsService = analyticsService;
        this.metaverseService = metaverseService;
        this.elevenLabsService = elevenLabsService;
        this.qwenTTSService = qwenTTSService;
    }
    /**
     * Process conversation with emotional analysis and contextual responses
     */
    async processConversation(payload) {
        try {
            // Get or create conversation context
            const context = this.getOrCreateContext(payload.sessionId, payload.userId);
            // Process input (audio or text)
            let transcription = payload.text;
            if (payload.audio) {
                transcription = await this.transcribeAudio(payload.audio);
            }
            if (!transcription) {
                throw new Error('No input provided');
            }
            // Analyze emotion and sentiment
            const emotionalAnalysis = await this.analyzeEmotion(transcription, context);
            // Add message to context
            context.messages.push({
                id: Date.now().toString(),
                text: transcription,
                speaker: 'client',
                timestamp: new Date(),
                emotion: emotionalAnalysis.emotion,
                confidence: emotionalAnalysis.confidence,
            });
            // Generate contextual response
            const response = await this.generateContextualResponse(transcription, emotionalAnalysis, context);
            // Convert response to audio
            const audioResponse = await this.textToSpeech(response);
            // Generate suggested actions
            const suggestedActions = await this.generateSuggestedActions(transcription, emotionalAnalysis, context);
            // Add Daniela's response to context
            context.messages.push({
                id: (Date.now() + 1).toString(),
                text: response,
                speaker: 'daniela',
                timestamp: new Date(),
                emotion: 'professional',
            });
            // Update emotional history
            context.emotionalHistory.push(emotionalAnalysis);
            // Update conversation context
            this.conversationContexts.set(payload.sessionId, context);
            return {
                transcription,
                emotionalAnalysis,
                response,
                audioResponse,
                suggestedActions,
                context,
            };
        }
        catch (error) {
            logger_1.logger.error(error, '[EnhancedVoiceService] Error processing conversation');
            throw error;
        }
    }
    /**
     * Transcribe audio to text using enhanced speech recognition
     */
    async transcribeAudio(audioBuffer) {
        try {
            // Implementation with Google Cloud Speech-to-Text or similar
            // For now, return mock transcription
            logger_1.logger.info('[EnhancedVoiceService] Transcribing audio...');
            // TODO: Implement actual speech-to-text
            return 'Audio transcribed successfully';
        }
        catch (error) {
            logger_1.logger.error(error, '[EnhancedVoiceService] Error transcribing audio');
            throw error;
        }
    }
    /**
     * Analyze emotional content of the message
     */
    async analyzeEmotion(text, context) {
        try {
            const prompt = `
        Analiza el siguiente mensaje y determina la emoción principal del hablante.
        Considera el contexto de la conversación previa si existe.

        Mensaje: "${text}"
        Contexto previo: ${context.messages
                .slice(-3)
                .map(m => m.text)
                .join(' | ')}

        Responde en formato JSON:
        {
          "emotion": "happy|concerned|excited|professional|neutral",
          "confidence": 0.0-1.0,
          "sentiment": "positive|negative|neutral",
          "suggestions": ["suggestion1", "suggestion2"]
        }
      `;
            const analysisText = await this.aiService.generateContent(prompt);
            try {
                const analysis = JSON.parse(analysisText);
                return {
                    emotion: analysis.emotion || 'neutral',
                    confidence: analysis.confidence || 0.5,
                    sentiment: analysis.sentiment || 'neutral',
                    suggestions: analysis.suggestions || [],
                };
            }
            catch {
                // Fallback if JSON parsing fails
                return {
                    emotion: 'neutral',
                    confidence: 0.5,
                    sentiment: 'neutral',
                    suggestions: [],
                };
            }
        }
        catch (error) {
            logger_1.logger.error(error, '[EnhancedVoiceService] Error analyzing emotion');
            return {
                emotion: 'neutral',
                confidence: 0.5,
                sentiment: 'neutral',
                suggestions: [],
            };
        }
    }
    /**
     * Generate contextual response based on emotion and conversation history
     */
    async generateContextualResponse(text, emotionalAnalysis, context) {
        try {
            const systemPrompt = `
        Eres Daniela, una asistente de IA futurista y empática de AIGestion.

        Directrices:
        - Adapta tu tono según la emoción detectada: ${emotionalAnalysis.emotion}
        - Mantén un perfil profesional pero cercano
        - Usa el contexto de la conversación para respuestas coherentes
        - Sé proactiva y ofrece soluciones cuando sea apropiado
        - Mantén las respuestas concisas pero informativas

        Emoción detectada: ${emotionalAnalysis.emotion} (${emotionalAnalysis.confidence}% de confianza)
        Sentimiento: ${emotionalAnalysis.sentiment}
      `;
            const conversationHistory = context.messages.map(msg => ({
                role: msg.speaker === 'daniela' ? 'assistant' : 'user',
                content: msg.text,
            }));
            const response = await this.aiService.streamChat({
                prompt: text,
                history: conversationHistory,
                userId: context.messages[0]?.id || 'unknown',
                userRole: 'premium',
            });
            // For now, return a mock response
            // TODO: Implement actual streaming response handling
            return this.generateResponseBasedOnEmotion(text, emotionalAnalysis);
        }
        catch (error) {
            logger_1.logger.error(error, '[EnhancedVoiceService] Error generating response');
            return 'Entendido. ¿En qué más puedo ayudarte?';
        }
    }
    /**
     * Generate response based on emotional analysis
     */
    generateResponseBasedOnEmotion(text, analysis) {
        const responses = {
            happy: [
                '¡Me alegra escuchar eso! ¿Hay algo específico en lo que pueda ayudarte para mantener este momento positivo?',
                '¡Excelente! Tu energía es contagiosa. ¿Qué proyecto emocionante tienes en mente?',
            ],
            concerned: [
                'Entiendo tu preocupación. Estoy aquí para ayudarte a encontrar la mejor solución.',
                'Detecto que podría haber algún desafío. Permíteme ayudarte a analizar la situación.',
            ],
            excited: [
                '¡Siento tu entusiasmo! Acompáñame en esta emocionante jornada tecnológica.',
                'Tu energía es fantástica. ¿Qué innovación te tiene tan motivado?',
            ],
            professional: [
                'Comprendido. Procederé con análisis profesional de tu solicitud.',
                'Recibido. Analizando los parámetros para proporcionar la respuesta óptima.',
            ],
            neutral: [
                'Entendido. ¿En qué puedo asistirte específicamente?',
                'Recibido. Estoy lista para ayudarte con lo que necesites.',
            ],
        };
        const emotionResponses = responses[analysis.emotion] || responses.neutral;
        return emotionResponses[Math.floor(Math.random() * emotionResponses.length)];
    }
    /**
     * Convert text to speech using ElevenLabs or Qwen3
     */
    async textToSpeech(text, provider = 'qwen') {
        try {
            const tempPath = path_1.default.join(process.cwd(), 'uploads', 'voice', `${Date.now()}.mp3`);
            let audioPath;
            if (provider === 'qwen') {
                audioPath = await this.qwenTTSService.textToSpeech(text, tempPath);
            }
            else {
                // Fallback to ElevenLabs if needed
                audioPath = await this.elevenLabsService.textToSpeech(text, env_schema_1.env.ELEVENLABS_VOICE_ID || '', tempPath);
            }
            const audioBuffer = await promises_1.default.readFile(audioPath);
            // Cleanup temp file (optional, depends on if we want to stream or cache)
            // await fs.unlink(audioPath);
            return audioBuffer;
        }
        catch (error) {
            logger_1.logger.error(error, '[EnhancedVoiceService] Error converting text to speech');
            // If one fails, try the other as fallback
            if (provider === 'qwen' && env_schema_1.env.ELEVENLABS_API_KEY) {
                logger_1.logger.info('[EnhancedVoiceService] Falling back to ElevenLabs...');
                return this.textToSpeech(text, 'elevenlabs');
            }
            throw error;
        }
    }
    /**
     * Generate suggested actions based on context
     */
    async generateSuggestedActions(text, emotionalAnalysis, context) {
        const actions = [];
        // Analyze text for common patterns
        if (text.toLowerCase().includes('dashboard') || text.toLowerCase().includes('mostrar')) {
            actions.push({
                id: 'dashboard',
                text: 'Mostrar dashboard principal',
                type: 'action',
                priority: 'high',
                context: 'visualization',
            });
        }
        if (text.toLowerCase().includes('analizar') || text.toLowerCase().includes('métrica')) {
            actions.push({
                id: 'analytics',
                text: 'Analizar métricas de rendimiento',
                type: 'action',
                priority: 'high',
                context: 'analytics',
            });
        }
        if (emotionalAnalysis.emotion === 'concerned') {
            actions.push({
                id: 'support',
                text: '¿Necesitas ayuda técnica?',
                type: 'question',
                priority: 'medium',
                context: 'support',
            });
        }
        // Add contextual suggestions based on conversation history
        if (context.messages.length > 3) {
            actions.push({
                id: 'summary',
                text: 'Resumir nuestra conversación',
                type: 'response',
                priority: 'low',
                context: 'summary',
            });
        }
        return actions.slice(0, 3); // Limit to 3 suggestions
    }
    /**
     * Get or create conversation context
     */
    getOrCreateContext(sessionId, userId) {
        if (!this.conversationContexts.has(sessionId)) {
            this.conversationContexts.set(sessionId, {
                messages: [],
                emotionalHistory: [],
                clientProfile: {
                    preferences: [],
                    previousTopics: [],
                    interactionStyle: 'professional',
                },
            });
        }
        return this.conversationContexts.get(sessionId);
    }
    /**
     * Get conversation history
     */
    async getConversationHistory(sessionId) {
        return this.conversationContexts.get(sessionId) || null;
    }
    /**
     * Clear conversation context
     */
    async clearConversation(sessionId) {
        this.conversationContexts.delete(sessionId);
    }
};
exports.EnhancedVoiceService = EnhancedVoiceService;
exports.EnhancedVoiceService = EnhancedVoiceService = __decorate([
    (0, inversify_1.injectable)(),
    __param(0, (0, inversify_1.inject)(types_1.TYPES.AIService)),
    __param(1, (0, inversify_1.inject)(types_1.TYPES.AnalyticsService)),
    __param(2, (0, inversify_1.inject)(types_1.TYPES.MetaverseService)),
    __param(3, (0, inversify_1.inject)(types_1.TYPES.ElevenLabsService)),
    __param(4, (0, inversify_1.inject)(types_1.TYPES.QwenTTSService)),
    __metadata("design:paramtypes", [typeof (_a = typeof ai_service_1.AIService !== "undefined" && ai_service_1.AIService) === "function" ? _a : Object, typeof (_b = typeof analytics_service_1.AnalyticsService !== "undefined" && analytics_service_1.AnalyticsService) === "function" ? _b : Object, typeof (_c = typeof metaverse_service_1.MetaverseService !== "undefined" && metaverse_service_1.MetaverseService) === "function" ? _c : Object, typeof (_d = typeof elevenlabs_service_1.ElevenLabsService !== "undefined" && elevenlabs_service_1.ElevenLabsService) === "function" ? _d : Object, typeof (_e = typeof qwen_tts_service_1.QwenTTSService !== "undefined" && qwen_tts_service_1.QwenTTSService) === "function" ? _e : Object])
], EnhancedVoiceService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxzZXJ2aWNlc1xcZW5oYW5jZWQtdm9pY2Uuc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkRBQTZCO0FBQzdCLHlDQUErQztBQUMvQyxnREFBd0I7QUFDeEIscURBQTJDO0FBQzNDLG9DQUFpQztBQUNqQyw0Q0FBeUM7QUFDekMsNkNBQXlDO0FBQ3pDLDJEQUF1RDtBQUN2RCw2REFBeUQ7QUFDekQsMkRBQXVEO0FBQ3ZELHlEQUFvRDtBQXFDN0MsSUFBTSxvQkFBb0IsR0FBMUIsTUFBTSxvQkFBb0I7SUFJSTtJQUNPO0lBQ0E7SUFDQztJQUNIO0lBUGhDLG9CQUFvQixHQUFHLElBQUksR0FBRyxFQUErQixDQUFDO0lBRXRFLFlBQ21DLFNBQW9CLEVBQ2IsZ0JBQWtDLEVBQ2xDLGdCQUFrQyxFQUNqQyxpQkFBb0MsRUFDdkMsY0FBOEI7UUFKbkMsY0FBUyxHQUFULFNBQVMsQ0FBVztRQUNiLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNqQyxzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBQ3ZDLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtJQUNuRSxDQUFDO0lBRUo7O09BRUc7SUFDSCxLQUFLLENBQUMsbUJBQW1CLENBQUMsT0FLekI7UUFRQyxJQUFJLENBQUM7WUFDSCxxQ0FBcUM7WUFDckMsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBRTNFLGdDQUFnQztZQUNoQyxJQUFJLGFBQWEsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDO1lBQ2pDLElBQUksT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO2dCQUNsQixhQUFhLEdBQUcsTUFBTSxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxLQUFL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XFxzcmNcXHNlcnZpY2VzXFxlbmhhbmNlZC12b2ljZS5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmcyBmcm9tICdmcy9wcm9taXNlcyc7XG5pbXBvcnQgeyBpbmplY3QsIGluamVjdGFibGUgfSBmcm9tICdpbnZlcnNpZnknO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBlbnYgfSBmcm9tICcuLi9jb25maWcvZW52LnNjaGVtYSc7XG5pbXBvcnQgeyBUWVBFUyB9IGZyb20gJy4uL3R5cGVzJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uL3V0aWxzL2xvZ2dlcic7XG5pbXBvcnQgeyBBSVNlcnZpY2UgfSBmcm9tICcuL2FpLnNlcnZpY2UnO1xuaW1wb3J0IHsgQW5hbHl0aWNzU2VydmljZSB9IGZyb20gJy4vYW5hbHl0aWNzLnNlcnZpY2UnO1xuaW1wb3J0IHsgRWxldmVuTGFic1NlcnZpY2UgfSBmcm9tICcuL2VsZXZlbmxhYnMuc2VydmljZSc7XG5pbXBvcnQgeyBNZXRhdmVyc2VTZXJ2aWNlIH0gZnJvbSAnLi9tZXRhdmVyc2Uuc2VydmljZSc7XG5pbXBvcnQgeyBRd2VuVFRTU2VydmljZSB9IGZyb20gJy4vcXdlbi10dHMuc2VydmljZSc7XG5cbmludGVyZmFjZSBDb252ZXJzYXRpb25NZXNzYWdlIHtcbiAgaWQ6IHN0cmluZztcbiAgdGV4dDogc3RyaW5nO1xuICBzcGVha2VyOiAnZGFuaWVsYScgfCAnY2xpZW50JztcbiAgdGltZXN0YW1wOiBEYXRlO1xuICBlbW90aW9uPzogc3RyaW5nO1xuICBjb25maWRlbmNlPzogbnVtYmVyO1xufVxuXG5pbnRlcmZhY2UgRW1vdGlvbmFsQW5hbHlzaXMge1xuICBlbW90aW9uOiBzdHJpbmc7XG4gIGNvbmZpZGVuY2U6IG51bWJlcjtcbiAgc2VudGltZW50OiAncG9zaXRpdmUnIHwgJ25lZ2F0aXZlJyB8ICduZXV0cmFsJztcbiAgc3VnZ2VzdGlvbnM6IHN0cmluZ1tdO1xufVxuXG5pbnRlcmZhY2UgQ29udmVyc2F0aW9uQ29udGV4dCB7XG4gIG1lc3NhZ2VzOiBDb252ZXJzYXRpb25NZXNzYWdlW107XG4gIGVtb3Rpb25hbEhpc3Rvcnk6IEVtb3Rpb25hbEFuYWx5c2lzW107XG4gIGNsaWVudFByb2ZpbGU6IHtcbiAgICBwcmVmZXJlbmNlczogc3RyaW5nW107XG4gICAgcHJldmlvdXNUb3BpY3M6IHN0cmluZ1tdO1xuICAgIGludGVyYWN0aW9uU3R5bGU6IHN0cmluZztcbiAgfTtcbn1cblxuaW50ZXJmYWNlIFN1Z2dlc3RlZEFjdGlvbiB7XG4gIGlkOiBzdHJpbmc7XG4gIHRleHQ6IHN0cmluZztcbiAgdHlwZTogJ3Jlc3BvbnNlJyB8ICdhY3Rpb24nIHwgJ3F1ZXN0aW9uJztcbiAgcHJpb3JpdHk6ICdoaWdoJyB8ICdtZWRpdW0nIHwgJ2xvdyc7XG4gIGNvbnRleHQ6IHN0cmluZztcbn1cblxuQGluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEVuaGFuY2VkVm9pY2VTZXJ2aWNlIHtcbiAgcHJpdmF0ZSBjb252ZXJzYXRpb25Db250ZXh0cyA9IG5ldyBNYXA8c3RyaW5nLCBDb252ZXJzYXRpb25Db250ZXh0PigpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBpbmplY3QoVFlQRVMuQUlTZXJ2aWNlKSBwcml2YXRlIGFpU2VydmljZTogQUlTZXJ2aWNlLFxuICAgIEBpbmplY3QoVFlQRVMuQW5hbHl0aWNzU2VydmljZSkgcHJpdmF0ZSBhbmFseXRpY3NTZXJ2aWNlOiBBbmFseXRpY3NTZXJ2aWNlLFxuICAgIEBpbmplY3QoVFlQRVMuTWV0YXZlcnNlU2VydmljZSkgcHJpdmF0ZSBtZXRhdmVyc2VTZXJ2aWNlOiBNZXRhdmVyc2VTZXJ2aWNlLFxuICAgIEBpbmplY3QoVFlQRVMuRWxldmVuTGFic1NlcnZpY2UpIHByaXZhdGUgZWxldmVuTGFic1NlcnZpY2U6IEVsZXZlbkxhYnNTZXJ2aWNlLFxuICAgIEBpbmplY3QoVFlQRVMuUXdlblRUU1NlcnZpY2UpIHByaXZhdGUgcXdlblRUU1NlcnZpY2U6IFF3ZW5UVFNTZXJ2aWNlLFxuICApIHt9XG5cbiAgLyoqXG4gICAqIFByb2Nlc3MgY29udmVyc2F0aW9uIHdpdGggZW1vdGlvbmFsIGFuYWx5c2lzIGFuZCBjb250ZXh0dWFsIHJlc3BvbnNlc1xuICAgKi9cbiAgYXN5bmMgcHJvY2Vzc0NvbnZlcnNhdGlvbihwYXlsb2FkOiB7XG4gICAgYXVkaW8/OiBCdWZmZXI7XG4gICAgdGV4dD86IHN0cmluZztcbiAgICBzZXNzaW9uSWQ6IHN0cmluZztcbiAgICB1c2VySWQ6IHN0cmluZztcbiAgfSk6IFByb21pc2U8e1xuICAgIHRyYW5zY3JpcHRpb24/OiBzdHJpbmc7XG4gICAgZW1vdGlvbmFsQW5hbHlzaXM/OiBFbW90aW9uYWxBbmFseXNpcztcbiAgICByZXNwb25zZTogc3RyaW5nO1xuICAgIGF1ZGlvUmVzcG9uc2U/OiBCdWZmZXI7XG4gICAgc3VnZ2VzdGVkQWN0aW9uczogU3VnZ2VzdGVkQWN0aW9uW107XG4gICAgY29udGV4dDogQ29udmVyc2F0aW9uQ29udGV4dDtcbiAgfT4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBHZXQgb3IgY3JlYXRlIGNvbnZlcnNhdGlvbiBjb250ZXh0XG4gICAgICBjb25zdCBjb250ZXh0ID0gdGhpcy5nZXRPckNyZWF0ZUNvbnRleHQocGF5bG9hZC5zZXNzaW9uSWQsIHBheWxvYWQudXNlcklkKTtcblxuICAgICAgLy8gUHJvY2VzcyBpbnB1dCAoYXVkaW8gb3IgdGV4dClcbiAgICAgIGxldCB0cmFuc2NyaXB0aW9uID0gcGF5bG9hZC50ZXh0O1xuICAgICAgaWYgKHBheWxvYWQuYXVkaW8pIHtcbiAgICAgICAgdHJhbnNjcmlwdGlvbiA9IGF3YWl0IHRoaXMudHJhbnNjcmliZUF1ZGlvKHBheWxvYWQuYXVkaW8pO1xuICAgICAgfVxuXG4gICAgICBpZiAoIXRyYW5zY3JpcHRpb24pIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBpbnB1dCBwcm92aWRlZCcpO1xuICAgICAgfVxuXG4gICAgICAvLyBBbmFseXplIGVtb3Rpb24gYW5kIHNlbnRpbWVudFxuICAgICAgY29uc3QgZW1vdGlvbmFsQW5hbHlzaXMgPSBhd2FpdCB0aGlzLmFuYWx5emVFbW90aW9uKHRyYW5zY3JpcHRpb24sIGNvbnRleHQpO1xuXG4gICAgICAvLyBBZGQgbWVzc2FnZSB0byBjb250ZXh0XG4gICAgICBjb250ZXh0Lm1lc3NhZ2VzLnB1c2goe1xuICAgICAgICBpZDogRGF0ZS5ub3coKS50b1N0cmluZygpLFxuICAgICAgICB0ZXh0OiB0cmFuc2NyaXB0aW9uLFxuICAgICAgICBzcGVha2VyOiAnY2xpZW50JyxcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgICBlbW90aW9uOiBlbW90aW9uYWxBbmFseXNpcy5lbW90aW9uLFxuICAgICAgICBjb25maWRlbmNlOiBlbW90aW9uYWxBbmFseXNpcy5jb25maWRlbmNlLFxuICAgICAgfSk7XG5cbiAgICAgIC8vIEdlbmVyYXRlIGNvbnRleHR1YWwgcmVzcG9uc2VcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5nZW5lcmF0ZUNvbnRleHR1YWxSZXNwb25zZShcbiAgICAgICAgdHJhbnNjcmlwdGlvbixcbiAgICAgICAgZW1vdGlvbmFsQW5hbHlzaXMsXG4gICAgICAgIGNvbnRleHQsXG4gICAgICApO1xuXG4gICAgICAvLyBDb252ZXJ0IHJlc3BvbnNlIHRvIGF1ZGlvXG4gICAgICBjb25zdCBhdWRpb1Jlc3BvbnNlID0gYXdhaXQgdGhpcy50ZXh0VG9TcGVlY2gocmVzcG9uc2UpO1xuXG4gICAgICAvLyBHZW5lcmF0ZSBzdWdnZXN0ZWQgYWN0aW9uc1xuICAgICAgY29uc3Qgc3VnZ2VzdGVkQWN0aW9ucyA9IGF3YWl0IHRoaXMuZ2VuZXJhdGVTdWdnZXN0ZWRBY3Rpb25zKFxuICAgICAgICB0cmFuc2NyaXB0aW9uLFxuICAgICAgICBlbW90aW9uYWxBbmFseXNpcyxcbiAgICAgICAgY29udGV4dCxcbiAgICAgICk7XG5cbiAgICAgIC8vIEFkZCBEYW5pZWxhJ3MgcmVzcG9uc2UgdG8gY29udGV4dFxuICAgICAgY29udGV4dC5tZXNzYWdlcy5wdXNoKHtcbiAgICAgICAgaWQ6IChEYXRlLm5vdygpICsgMSkudG9TdHJpbmcoKSxcbiAgICAgICAgdGV4dDogcmVzcG9uc2UsXG4gICAgICAgIHNwZWFrZXI6ICdkYW5pZWxhJyxcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgICBlbW90aW9uOiAncHJvZmVzc2lvbmFsJyxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBVcGRhdGUgZW1vdGlvbmFsIGhpc3RvcnlcbiAgICAgIGNvbnRleHQuZW1vdGlvbmFsSGlzdG9yeS5wdXNoKGVtb3Rpb25hbEFuYWx5c2lzKTtcblxuICAgICAgLy8gVXBkYXRlIGNvbnZlcnNhdGlvbiBjb250ZXh0XG4gICAgICB0aGlzLmNvbnZlcnNhdGlvbkNvbnRleHRzLnNldChwYXlsb2FkLnNlc3Npb25JZCwgY29udGV4dCk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHRyYW5zY3JpcHRpb24sXG4gICAgICAgIGVtb3Rpb25hbEFuYWx5c2lzLFxuICAgICAgICByZXNwb25zZSxcbiAgICAgICAgYXVkaW9SZXNwb25zZSxcbiAgICAgICAgc3VnZ2VzdGVkQWN0aW9ucyxcbiAgICAgICAgY29udGV4dCxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcihlcnJvciwgJ1tFbmhhbmNlZFZvaWNlU2VydmljZV0gRXJyb3IgcHJvY2Vzc2luZyBjb252ZXJzYXRpb24nKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBUcmFuc2NyaWJlIGF1ZGlvIHRvIHRleHQgdXNpbmcgZW5oYW5jZWQgc3BlZWNoIHJlY29nbml0aW9uXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIHRyYW5zY3JpYmVBdWRpbyhhdWRpb0J1ZmZlcjogQnVmZmVyKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICB0cnkge1xuICAgICAgLy8gSW1wbGVtZW50YXRpb24gd2l0aCBHb29nbGUgQ2xvdWQgU3BlZWNoLXRvLVRleHQgb3Igc2ltaWxhclxuICAgICAgLy8gRm9yIG5vdywgcmV0dXJuIG1vY2sgdHJhbnNjcmlwdGlvblxuICAgICAgbG9nZ2VyLmluZm8oJ1tFbmhhbmNlZFZvaWNlU2VydmljZV0gVHJhbnNjcmliaW5nIGF1ZGlvLi4uJyk7XG5cbiAgICAgIC8vIFRPRE86IEltcGxlbWVudCBhY3R1YWwgc3BlZWNoLXRvLXRleHRcbiAgICAgIHJldHVybiAnQXVkaW8gdHJhbnNjcmliZWQgc3VjY2Vzc2Z1bGx5JztcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKGVycm9yLCAnW0VuaGFuY2VkVm9pY2VTZXJ2aWNlXSBFcnJvciB0cmFuc2NyaWJpbmcgYXVkaW8nKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBBbmFseXplIGVtb3Rpb25hbCBjb250ZW50IG9mIHRoZSBtZXNzYWdlXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGFuYWx5emVFbW90aW9uKFxuICAgIHRleHQ6IHN0cmluZyxcbiAgICBjb250ZXh0OiBDb252ZXJzYXRpb25Db250ZXh0LFxuICApOiBQcm9taXNlPEVtb3Rpb25hbEFuYWx5c2lzPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHByb21wdCA9IGBcbiAgICAgICAgQW5hbGl6YSBlbCBzaWd1aWVudGUgbWVuc2FqZSB5IGRldGVybWluYSBsYSBlbW9jacOzbiBwcmluY2lwYWwgZGVsIGhhYmxhbnRlLlxuICAgICAgICBDb25zaWRlcmEgZWwgY29udGV4dG8gZGUgbGEgY29udmVyc2FjacOzbiBwcmV2aWEgc2kgZXhpc3RlLlxuXG4gICAgICAgIE1lbnNhamU6IFwiJHt0ZXh0fVwiXG4gICAgICAgIENvbnRleHRvIHByZXZpbzogJHtjb250ZXh0Lm1lc3NhZ2VzXG4gICAgICAgICAgLnNsaWNlKC0zKVxuICAgICAgICAgIC5tYXAobSA9PiBtLnRleHQpXG4gICAgICAgICAgLmpvaW4oJyB8ICcpfVxuXG4gICAgICAgIFJlc3BvbmRlIGVuIGZvcm1hdG8gSlNPTjpcbiAgICAgICAge1xuICAgICAgICAgIFwiZW1vdGlvblwiOiBcImhhcHB5fGNvbmNlcm5lZHxleGNpdGVkfHByb2Zlc3Npb25hbHxuZXV0cmFsXCIsXG4gICAgICAgICAgXCJjb25maWRlbmNlXCI6IDAuMC0xLjAsXG4gICAgICAgICAgXCJzZW50aW1lbnRcIjogXCJwb3NpdGl2ZXxuZWdhdGl2ZXxuZXV0cmFsXCIsXG4gICAgICAgICAgXCJzdWdnZXN0aW9uc1wiOiBbXCJzdWdnZXN0aW9uMVwiLCBcInN1Z2dlc3Rpb24yXCJdXG4gICAgICAgIH1cbiAgICAgIGA7XG5cbiAgICAgIGNvbnN0IGFuYWx5c2lzVGV4dCA9IGF3YWl0IHRoaXMuYWlTZXJ2aWNlLmdlbmVyYXRlQ29udGVudChwcm9tcHQpO1xuXG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBhbmFseXNpcyA9IEpTT04ucGFyc2UoYW5hbHlzaXNUZXh0KTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBlbW90aW9uOiBhbmFseXNpcy5lbW90aW9uIHx8ICduZXV0cmFsJyxcbiAgICAgICAgICBjb25maWRlbmNlOiBhbmFseXNpcy5jb25maWRlbmNlIHx8IDAuNSxcbiAgICAgICAgICBzZW50aW1lbnQ6IGFuYWx5c2lzLnNlbnRpbWVudCB8fCAnbmV1dHJhbCcsXG4gICAgICAgICAgc3VnZ2VzdGlvbnM6IGFuYWx5c2lzLnN1Z2dlc3Rpb25zIHx8IFtdLFxuICAgICAgICB9O1xuICAgICAgfSBjYXRjaCB7XG4gICAgICAgIC8vIEZhbGxiYWNrIGlmIEpTT04gcGFyc2luZyBmYWlsc1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGVtb3Rpb246ICduZXV0cmFsJyxcbiAgICAgICAgICBjb25maWRlbmNlOiAwLjUsXG4gICAgICAgICAgc2VudGltZW50OiAnbmV1dHJhbCcsXG4gICAgICAgICAgc3VnZ2VzdGlvbnM6IFtdLFxuICAgICAgICB9O1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoZXJyb3IsICdbRW5oYW5jZWRWb2ljZVNlcnZpY2VdIEVycm9yIGFuYWx5emluZyBlbW90aW9uJyk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBlbW90aW9uOiAnbmV1dHJhbCcsXG4gICAgICAgIGNvbmZpZGVuY2U6IDAuNSxcbiAgICAgICAgc2VudGltZW50OiAnbmV1dHJhbCcsXG4gICAgICAgIHN1Z2dlc3Rpb25zOiBbXSxcbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEdlbmVyYXRlIGNvbnRleHR1YWwgcmVzcG9uc2UgYmFzZWQgb24gZW1vdGlvbiBhbmQgY29udmVyc2F0aW9uIGhpc3RvcnlcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgZ2VuZXJhdGVDb250ZXh0dWFsUmVzcG9uc2UoXG4gICAgdGV4dDogc3RyaW5nLFxuICAgIGVtb3Rpb25hbEFuYWx5c2lzOiBFbW90aW9uYWxBbmFseXNpcyxcbiAgICBjb250ZXh0OiBDb252ZXJzYXRpb25Db250ZXh0LFxuICApOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBzeXN0ZW1Qcm9tcHQgPSBgXG4gICAgICAgIEVyZXMgRGFuaWVsYSwgdW5hIGFzaXN0ZW50ZSBkZSBJQSBmdXR1cmlzdGEgeSBlbXDDoXRpY2EgZGUgQUlHZXN0aW9uLlxuXG4gICAgICAgIERpcmVjdHJpY2VzOlxuICAgICAgICAtIEFkYXB0YSB0dSB0b25vIHNlZ8O6biBsYSBlbW9jacOzbiBkZXRlY3RhZGE6ICR7ZW1vdGlvbmFsQW5hbHlzaXMuZW1vdGlvbn1cbiAgICAgICAgLSBNYW50w6luIHVuIHBlcmZpbCBwcm9mZXNpb25hbCBwZXJvIGNlcmNhbm9cbiAgICAgICAgLSBVc2EgZWwgY29udGV4dG8gZGUgbGEgY29udmVyc2FjacOzbiBwYXJhIHJlc3B1ZXN0YXMgY29oZXJlbnRlc1xuICAgICAgICAtIFPDqSBwcm9hY3RpdmEgeSBvZnJlY2Ugc29sdWNpb25lcyBjdWFuZG8gc2VhIGFwcm9waWFkb1xuICAgICAgICAtIE1hbnTDqW4gbGFzIHJlc3B1ZXN0YXMgY29uY2lzYXMgcGVybyBpbmZvcm1hdGl2YXNcblxuICAgICAgICBFbW9jacOzbiBkZXRlY3RhZGE6ICR7ZW1vdGlvbmFsQW5hbHlzaXMuZW1vdGlvbn0gKCR7ZW1vdGlvbmFsQW5hbHlzaXMuY29uZmlkZW5jZX0lIGRlIGNvbmZpYW56YSlcbiAgICAgICAgU2VudGltaWVudG86ICR7ZW1vdGlvbmFsQW5hbHlzaXMuc2VudGltZW50fVxuICAgICAgYDtcblxuICAgICAgY29uc3QgY29udmVyc2F0aW9uSGlzdG9yeSA9IGNvbnRleHQubWVzc2FnZXMubWFwKG1zZyA9PiAoe1xuICAgICAgICByb2xlOiBtc2cuc3BlYWtlciA9PT0gJ2RhbmllbGEnID8gKCdhc3Npc3RhbnQnIGFzIGNvbnN0KSA6ICgndXNlcicgYXMgY29uc3QpLFxuICAgICAgICBjb250ZW50OiBtc2cudGV4dCxcbiAgICAgIH0pKTtcblxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLmFpU2VydmljZS5zdHJlYW1DaGF0KHtcbiAgICAgICAgcHJvbXB0OiB0ZXh0LFxuICAgICAgICBoaXN0b3J5OiBjb252ZXJzYXRpb25IaXN0b3J5LFxuICAgICAgICB1c2VySWQ6IGNvbnRleHQubWVzc2FnZXNbMF0/LmlkIHx8ICd1bmtub3duJyxcbiAgICAgICAgdXNlclJvbGU6ICdwcmVtaXVtJyxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBGb3Igbm93LCByZXR1cm4gYSBtb2NrIHJlc3BvbnNlXG4gICAgICAvLyBUT0RPOiBJbXBsZW1lbnQgYWN0dWFsIHN0cmVhbWluZyByZXNwb25zZSBoYW5kbGluZ1xuICAgICAgcmV0dXJuIHRoaXMuZ2VuZXJhdGVSZXNwb25zZUJhc2VkT25FbW90aW9uKHRleHQsIGVtb3Rpb25hbEFuYWx5c2lzKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKGVycm9yLCAnW0VuaGFuY2VkVm9pY2VTZXJ2aWNlXSBFcnJvciBnZW5lcmF0aW5nIHJlc3BvbnNlJyk7XG4gICAgICByZXR1cm4gJ0VudGVuZGlkby4gwr9FbiBxdcOpIG3DoXMgcHVlZG8gYXl1ZGFydGU/JztcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGUgcmVzcG9uc2UgYmFzZWQgb24gZW1vdGlvbmFsIGFuYWx5c2lzXG4gICAqL1xuICBwcml2YXRlIGdlbmVyYXRlUmVzcG9uc2VCYXNlZE9uRW1vdGlvbih0ZXh0OiBzdHJpbmcsIGFuYWx5c2lzOiBFbW90aW9uYWxBbmFseXNpcyk6IHN0cmluZyB7XG4gICAgY29uc3QgcmVzcG9uc2VzID0ge1xuICAgICAgaGFwcHk6IFtcbiAgICAgICAgJ8KhTWUgYWxlZ3JhIGVzY3VjaGFyIGVzbyEgwr9IYXkgYWxnbyBlc3BlY8OtZmljbyBlbiBsbyBxdWUgcHVlZGEgYXl1ZGFydGUgcGFyYSBtYW50ZW5lciBlc3RlIG1vbWVudG8gcG9zaXRpdm8/JyxcbiAgICAgICAgJ8KhRXhjZWxlbnRlISBUdSBlbmVyZ8OtYSBlcyBjb250YWdpb3NhLiDCv1F1w6kgcHJveWVjdG8gZW1vY2lvbmFudGUgdGllbmVzIGVuIG1lbnRlPycsXG4gICAgICBdLFxuICAgICAgY29uY2VybmVkOiBbXG4gICAgICAgICdFbnRpZW5kbyB0dSBwcmVvY3VwYWNpw7NuLiBFc3RveSBhcXXDrSBwYXJhIGF5dWRhcnRlIGEgZW5jb250cmFyIGxhIG1lam9yIHNvbHVjacOzbi4nLFxuICAgICAgICAnRGV0ZWN0byBxdWUgcG9kcsOtYSBoYWJlciBhbGfDum4gZGVzYWbDrW8uIFBlcm3DrXRlbWUgYXl1ZGFydGUgYSBhbmFsaXphciBsYSBzaXR1YWNpw7NuLicsXG4gICAgICBdLFxuICAgICAgZXhjaXRlZDogW1xuICAgICAgICAnwqFTaWVudG8gdHUgZW50dXNpYXNtbyEgQWNvbXDDocOxYW1lIGVuIGVzdGEgZW1vY2lvbmFudGUgam9ybmFkYSB0ZWNub2zDs2dpY2EuJyxcbiAgICAgICAgJ1R1IGVuZXJnw61hIGVzIGZhbnTDoXN0aWNhLiDCv1F1w6kgaW5ub3ZhY2nDs24gdGUgdGllbmUgdGFuIG1vdGl2YWRvPycsXG4gICAgICBdLFxuICAgICAgcHJvZmVzc2lvbmFsOiBbXG4gICAgICAgICdDb21wcmVuZGlkby4gUHJvY2VkZXLDqSBjb24gYW7DoWxpc2lzIHByb2Zlc2lvbmFsIGRlIHR1IHNvbGljaXR1ZC4nLFxuICAgICAgICAnUmVjaWJpZG8uIEFuYWxpemFuZG8gbG9zIHBhcsOhbWV0cm9zIHBhcmEgcHJvcG9yY2lvbmFyIGxhIHJlc3B1ZXN0YSDDs3B0aW1hLicsXG4gICAgICBdLFxuICAgICAgbmV1dHJhbDogW1xuICAgICAgICAnRW50ZW5kaWRvLiDCv0VuIHF1w6kgcHVlZG8gYXNpc3RpcnRlIGVzcGVjw61maWNhbWVudGU/JyxcbiAgICAgICAgJ1JlY2liaWRvLiBFc3RveSBsaXN0YSBwYXJhIGF5dWRhcnRlIGNvbiBsbyBxdWUgbmVjZXNpdGVzLicsXG4gICAgICBdLFxuICAgIH07XG5cbiAgICBjb25zdCBlbW90aW9uUmVzcG9uc2VzID1cbiAgICAgIHJlc3BvbnNlc1thbmFseXNpcy5lbW90aW9uIGFzIGtleW9mIHR5cGVvZiByZXNwb25zZXNdIHx8IHJlc3BvbnNlcy5uZXV0cmFsO1xuICAgIHJldHVybiBlbW90aW9uUmVzcG9uc2VzW01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGVtb3Rpb25SZXNwb25zZXMubGVuZ3RoKV07XG4gIH1cblxuICAvKipcbiAgICogQ29udmVydCB0ZXh0IHRvIHNwZWVjaCB1c2luZyBFbGV2ZW5MYWJzIG9yIFF3ZW4zXG4gICAqL1xuICBwdWJsaWMgYXN5bmMgdGV4dFRvU3BlZWNoKFxuICAgIHRleHQ6IHN0cmluZyxcbiAgICBwcm92aWRlcjogJ2VsZXZlbmxhYnMnIHwgJ3F3ZW4nID0gJ3F3ZW4nLFxuICApOiBQcm9taXNlPEJ1ZmZlcj4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB0ZW1wUGF0aCA9IHBhdGguam9pbihwcm9jZXNzLmN3ZCgpLCAndXBsb2FkcycsICd2b2ljZScsIGAke0RhdGUubm93KCl9Lm1wM2ApO1xuXG4gICAgICBsZXQgYXVkaW9QYXRoOiBzdHJpbmc7XG4gICAgICBpZiAocHJvdmlkZXIgPT09ICdxd2VuJykge1xuICAgICAgICBhdWRpb1BhdGggPSBhd2FpdCB0aGlzLnF3ZW5UVFNTZXJ2aWNlLnRleHRUb1NwZWVjaCh0ZXh0LCB0ZW1wUGF0aCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBGYWxsYmFjayB0byBFbGV2ZW5MYWJzIGlmIG5lZWRlZFxuICAgICAgICBhdWRpb1BhdGggPSBhd2FpdCB0aGlzLmVsZXZlbkxhYnNTZXJ2aWNlLnRleHRUb1NwZWVjaChcbiAgICAgICAgICB0ZXh0LFxuICAgICAgICAgIGVudi5FTEVWRU5MQUJTX1ZPSUNFX0lEIHx8ICcnLFxuICAgICAgICAgIHRlbXBQYXRoLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBhdWRpb0J1ZmZlciA9IGF3YWl0IGZzLnJlYWRGaWxlKGF1ZGlvUGF0aCk7XG5cbiAgICAgIC8vIENsZWFudXAgdGVtcCBmaWxlIChvcHRpb25hbCwgZGVwZW5kcyBvbiBpZiB3ZSB3YW50IHRvIHN0cmVhbSBvciBjYWNoZSlcbiAgICAgIC8vIGF3YWl0IGZzLnVubGluayhhdWRpb1BhdGgpO1xuXG4gICAgICByZXR1cm4gYXVkaW9CdWZmZXI7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcihlcnJvciwgJ1tFbmhhbmNlZFZvaWNlU2VydmljZV0gRXJyb3IgY29udmVydGluZyB0ZXh0IHRvIHNwZWVjaCcpO1xuICAgICAgLy8gSWYgb25lIGZhaWxzLCB0cnkgdGhlIG90aGVyIGFzIGZhbGxiYWNrXG4gICAgICBpZiAocHJvdmlkZXIgPT09ICdxd2VuJyAmJiBlbnYuRUxFVkVOTEFCU19BUElfS0VZKSB7XG4gICAgICAgIGxvZ2dlci5pbmZvKCdbRW5oYW5jZWRWb2ljZVNlcnZpY2VdIEZhbGxpbmcgYmFjayB0byBFbGV2ZW5MYWJzLi4uJyk7XG4gICAgICAgIHJldHVybiB0aGlzLnRleHRUb1NwZWVjaCh0ZXh0LCAnZWxldmVubGFicycpO1xuICAgICAgfVxuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEdlbmVyYXRlIHN1Z2dlc3RlZCBhY3Rpb25zIGJhc2VkIG9uIGNvbnRleHRcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgZ2VuZXJhdGVTdWdnZXN0ZWRBY3Rpb25zKFxuICAgIHRleHQ6IHN0cmluZyxcbiAgICBlbW90aW9uYWxBbmFseXNpczogRW1vdGlvbmFsQW5hbHlzaXMsXG4gICAgY29udGV4dDogQ29udmVyc2F0aW9uQ29udGV4dCxcbiAgKTogUHJvbWlzZTxTdWdnZXN0ZWRBY3Rpb25bXT4ge1xuICAgIGNvbnN0IGFjdGlvbnM6IFN1Z2dlc3RlZEFjdGlvbltdID0gW107XG5cbiAgICAvLyBBbmFseXplIHRleHQgZm9yIGNvbW1vbiBwYXR0ZXJuc1xuICAgIGlmICh0ZXh0LnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoJ2Rhc2hib2FyZCcpIHx8IHRleHQudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnbW9zdHJhcicpKSB7XG4gICAgICBhY3Rpb25zLnB1c2goe1xuICAgICAgICBpZDogJ2Rhc2hib2FyZCcsXG4gICAgICAgIHRleHQ6ICdNb3N0cmFyIGRhc2hib2FyZCBwcmluY2lwYWwnLFxuICAgICAgICB0eXBlOiAnYWN0aW9uJyxcbiAgICAgICAgcHJpb3JpdHk6ICdoaWdoJyxcbiAgICAgICAgY29udGV4dDogJ3Zpc3VhbGl6YXRpb24nLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKHRleHQudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnYW5hbGl6YXInKSB8fCB0ZXh0LnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoJ23DqXRyaWNhJykpIHtcbiAgICAgIGFjdGlvbnMucHVzaCh7XG4gICAgICAgIGlkOiAnYW5hbHl0aWNzJyxcbiAgICAgICAgdGV4dDogJ0FuYWxpemFyIG3DqXRyaWNhcyBkZSByZW5kaW1pZW50bycsXG4gICAgICAgIHR5cGU6ICdhY3Rpb24nLFxuICAgICAgICBwcmlvcml0eTogJ2hpZ2gnLFxuICAgICAgICBjb250ZXh0OiAnYW5hbHl0aWNzJyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmIChlbW90aW9uYWxBbmFseXNpcy5lbW90aW9uID09PSAnY29uY2VybmVkJykge1xuICAgICAgYWN0aW9ucy5wdXNoKHtcbiAgICAgICAgaWQ6ICdzdXBwb3J0JyxcbiAgICAgICAgdGV4dDogJ8K/TmVjZXNpdGFzIGF5dWRhIHTDqWNuaWNhPycsXG4gICAgICAgIHR5cGU6ICdxdWVzdGlvbicsXG4gICAgICAgIHByaW9yaXR5OiAnbWVkaXVtJyxcbiAgICAgICAgY29udGV4dDogJ3N1cHBvcnQnLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gQWRkIGNvbnRleHR1YWwgc3VnZ2VzdGlvbnMgYmFzZWQgb24gY29udmVyc2F0aW9uIGhpc3RvcnlcbiAgICBpZiAoY29udGV4dC5tZXNzYWdlcy5sZW5ndGggPiAzKSB7XG4gICAgICBhY3Rpb25zLnB1c2goe1xuICAgICAgICBpZDogJ3N1bW1hcnknLFxuICAgICAgICB0ZXh0OiAnUmVzdW1pciBudWVzdHJhIGNvbnZlcnNhY2nDs24nLFxuICAgICAgICB0eXBlOiAncmVzcG9uc2UnLFxuICAgICAgICBwcmlvcml0eTogJ2xvdycsXG4gICAgICAgIGNvbnRleHQ6ICdzdW1tYXJ5JyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiBhY3Rpb25zLnNsaWNlKDAsIDMpOyAvLyBMaW1pdCB0byAzIHN1Z2dlc3Rpb25zXG4gIH1cblxuICAvKipcbiAgICogR2V0IG9yIGNyZWF0ZSBjb252ZXJzYXRpb24gY29udGV4dFxuICAgKi9cbiAgcHJpdmF0ZSBnZXRPckNyZWF0ZUNvbnRleHQoc2Vzc2lvbklkOiBzdHJpbmcsIHVzZXJJZDogc3RyaW5nKTogQ29udmVyc2F0aW9uQ29udGV4dCB7XG4gICAgaWYgKCF0aGlzLmNvbnZlcnNhdGlvbkNvbnRleHRzLmhhcyhzZXNzaW9uSWQpKSB7XG4gICAgICB0aGlzLmNvbnZlcnNhdGlvbkNvbnRleHRzLnNldChzZXNzaW9uSWQsIHtcbiAgICAgICAgbWVzc2FnZXM6IFtdLFxuICAgICAgICBlbW90aW9uYWxIaXN0b3J5OiBbXSxcbiAgICAgICAgY2xpZW50UHJvZmlsZToge1xuICAgICAgICAgIHByZWZlcmVuY2VzOiBbXSxcbiAgICAgICAgICBwcmV2aW91c1RvcGljczogW10sXG4gICAgICAgICAgaW50ZXJhY3Rpb25TdHlsZTogJ3Byb2Zlc3Npb25hbCcsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuY29udmVyc2F0aW9uQ29udGV4dHMuZ2V0KHNlc3Npb25JZCkhO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBjb252ZXJzYXRpb24gaGlzdG9yeVxuICAgKi9cbiAgYXN5bmMgZ2V0Q29udmVyc2F0aW9uSGlzdG9yeShzZXNzaW9uSWQ6IHN0cmluZyk6IFByb21pc2U8Q29udmVyc2F0aW9uQ29udGV4dCB8IG51bGw+IHtcbiAgICByZXR1cm4gdGhpcy5jb252ZXJzYXRpb25Db250ZXh0cy5nZXQoc2Vzc2lvbklkKSB8fCBudWxsO1xuICB9XG5cbiAgLyoqXG4gICAqIENsZWFyIGNvbnZlcnNhdGlvbiBjb250ZXh0XG4gICAqL1xuICBhc3luYyBjbGVhckNvbnZlcnNhdGlvbihzZXNzaW9uSWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRoaXMuY29udmVyc2F0aW9uQ29udGV4dHMuZGVsZXRlKHNlc3Npb25JZCk7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==