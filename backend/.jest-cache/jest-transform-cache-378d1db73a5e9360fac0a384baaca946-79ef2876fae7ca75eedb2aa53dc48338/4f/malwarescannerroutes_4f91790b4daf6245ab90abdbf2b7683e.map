{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\routes\\malware-scanner.routes.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\routes\\malware-scanner.routes.ts"],"sourcesContent":["import { Router } from 'express';\nimport { malwareScanner } from '../middleware/malware-scanner.middleware';\nimport { requireApiKey } from '../middleware/security.middleware';\nimport { MalwareScannerService } from '../services/malware-scanner.service';\nimport { logger } from '../utils/logger';\n\nconst router = Router();\nconst scannerService = new MalwareScannerService();\n\n/**\n * Malware Scanner Management Routes\n */\n\n// Get scanner statistics\nrouter.get('/stats', requireApiKey, (req: any, res: any) => {\n  try {\n    const stats = malwareScanner.getScannerStats();\n\n    res.json({\n      success: true,\n      data: {\n        ...stats,\n        timestamp: new Date().toISOString(),\n      },\n    });\n  } catch (error) {\n    logger.error('Error getting malware scanner stats:', error);\n    res.status(500).json({\n      success: false,\n      error: 'Internal server error',\n    });\n  }\n});\n\n// Get quarantined files\nrouter.get('/quarantine', requireApiKey, async (req: any, res: any) => {\n  try {\n    const quarantinedFiles = await scannerService.getQuarantinedFiles();\n\n    res.json({\n      success: true,\n      data: quarantinedFiles.map(file => ({\n        originalPath: file.originalPath,\n        quarantinePath: file.quarantinePath,\n        hash: file.hash,\n        threat: file.threat,\n        quarantinedAt: file.quarantinedAt,\n        userId: file.userId,\n      })),\n    });\n  } catch (error) {\n    logger.error('Error getting quarantined files:', error);\n    res.status(500).json({\n      success: false,\n      error: 'Internal server error',\n    });\n  }\n});\n\n// Release file from quarantine\nrouter.post('/quarantine/:quarantinePath/release', requireApiKey, async (req: any, res: any) => {\n  try {\n    const { quarantinePath } = req.params;\n    const { targetPath } = req.body;\n\n    if (!targetPath) {\n      return res.status(400).json({\n        success: false,\n        error: 'Target path is required',\n      });\n    }\n\n    await scannerService.releaseFromQuarantine(quarantinePath, targetPath);\n\n    logger.info('File released from quarantine', {\n      quarantinePath,\n      targetPath,\n      ip: req.ip,\n    });\n\n    res.json({\n      success: true,\n      message: 'File released from quarantine successfully',\n    });\n  } catch (error) {\n    logger.error('Error releasing file from quarantine:', error);\n    res.status(500).json({\n      success: false,\n      error: 'Internal server error',\n    });\n  }\n});\n\n// Delete quarantined file\nrouter.delete('/quarantine/:quarantinePath', requireApiKey, async (req: any, res: any) => {\n  try {\n    const { quarantinePath } = req.params;\n\n    await scannerService.deleteQuarantinedFile(quarantinePath);\n\n    logger.info('Quarantined file deleted', {\n      quarantinePath,\n      ip: req.ip,\n    });\n\n    res.json({\n      success: true,\n      message: 'Quarantined file deleted successfully',\n    });\n  } catch (error) {\n    logger.error('Error deleting quarantined file:', error);\n    res.status(500).json({\n      success: false,\n      error: 'Internal server error',\n    });\n  }\n});\n\n// Clear scanner cache\nrouter.post('/cache/clear', requireApiKey, (req: any, res: any) => {\n  try {\n    malwareScanner.clearCache();\n\n    logger.info('Malware scanner cache cleared', {\n      ip: req.ip,\n    });\n\n    res.json({\n      success: true,\n      message: 'Scanner cache cleared successfully',\n    });\n  } catch (error) {\n    logger.error('Error clearing scanner cache:', error);\n    res.status(500).json({\n      success: false,\n      error: 'Internal server error',\n    });\n  }\n});\n\n// Upload and scan file (test endpoint)\nrouter.post(\n  '/scan',\n  requireApiKey,\n  malwareScanner.uploadSingle('file'),\n  async (req: any, res: any) => {\n    try {\n      const uploadedFile = (req as any).file;\n      if (!uploadedFile) {\n        return res.status(400).json({\n          success: false,\n          error: 'No file uploaded',\n        });\n      }\n\n      const scanResult = (req as any).fileScanResult;\n\n      res.json({\n        success: true,\n        data: {\n          file: {\n            originalname: uploadedFile.originalname,\n            filename: uploadedFile.filename,\n            size: uploadedFile.size,\n            mimetype: uploadedFile.mimetype,\n          },\n          scanResult: {\n            isInfected: scanResult.isInfected,\n            threats: scanResult.threats,\n            scanTime: scanResult.scanTime,\n            engine: scanResult.engine,\n            hash: scanResult.hash,\n          },\n        },\n      });\n    } catch (error) {\n      logger.error('Error in scan endpoint:', error);\n      res.status(500).json({\n        success: false,\n        error: 'Internal server error',\n      });\n    }\n  },\n);\n\n// Upload and scan multiple files (test endpoint)\nrouter.post(\n  '/scan-batch',\n  requireApiKey,\n  malwareScanner.uploadMultiple('files', 5),\n  async (req: any, res: any) => {\n    try {\n      const scanResults = (req as any).fileScanResults;\n\n      if (!scanResults || scanResults.length === 0) {\n        return res.status(400).json({\n          success: false,\n          error: 'No files uploaded',\n        });\n      }\n\n      res.json({\n        success: true,\n        data: {\n          totalFiles: scanResults.length,\n          cleanFiles: scanResults.filter((r: any) => r.isClean).length,\n          infectedFiles: scanResults.filter((r: any) => !r.isClean).length,\n          results: scanResults.map((result: any) => ({\n            file: {\n              originalname: result.originalname,\n              filename: result.filename,\n              size: result.size,\n              mimetype: result.mimetype,\n            },\n            scanResult: {\n              isInfected: result.scanResult.isInfected,\n              threats: result.scanResult.threats,\n              scanTime: result.scanResult.scanTime,\n              engine: result.scanResult.engine,\n              hash: result.scanResult.hash,\n            },\n          })),\n        },\n      });\n    } catch (error) {\n      logger.error('Error in batch scan endpoint:', error);\n      res.status(500).json({\n        success: false,\n        error: 'Internal server error',\n      });\n    }\n  },\n);\n\n// Get scanner health\nrouter.get('/health', (req: any, res: any) => {\n  try {\n    const stats = malwareScanner.getScannerStats();\n\n    const health = {\n      status: 'healthy',\n      scanner: 'active',\n      stats: {\n        totalScans: stats.totalScans,\n        infectedFiles: stats.infectedFiles,\n        quarantinedFiles: stats.quarantinedFiles,\n        averageScanTime: Math.round(stats.averageScanTime * 100) / 100,\n      },\n      timestamp: new Date().toISOString(),\n    };\n\n    res.json({\n      success: true,\n      data: health,\n    });\n  } catch (error) {\n    logger.error('Error getting scanner health:', error);\n    res.status(500).json({\n      success: false,\n      error: 'Internal server error',\n    });\n  }\n});\n\nexport default router;\n"],"version":3}