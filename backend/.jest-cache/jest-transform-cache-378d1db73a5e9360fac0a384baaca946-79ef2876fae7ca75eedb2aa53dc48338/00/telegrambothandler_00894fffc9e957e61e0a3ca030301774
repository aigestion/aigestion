71d179cb5b7bf3eda412f7cb58444c84
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.TelegramBotHandler = void 0;
const inversify_1 = require("inversify");
const telegraf_1 = require("telegraf");
const env_schema_1 = require("../config/env.schema");
const logger_1 = require("../utils/logger");
const daniela_ai_service_1 = require("./daniela-ai.service");
/**
 * Telegram Bot Handler - Public Bot
 */
let TelegramBotHandler = class TelegramBotHandler {
    bot = null;
    isLaunched = false;
    daniela;
    constructor(daniela) {
        this.daniela = daniela;
        this.initialize();
    }
    /**
     * Initialize the Telegram Bot with command handlers
     */
    initialize() {
        const botToken = env_schema_1.env.TELEGRAM_BOT_TOKEN_PUBLIC || env_schema_1.env.TELEGRAM_BOT_TOKEN;
        if (!botToken) {
            logger_1.logger.warn('TELEGRAM_BOT_TOKEN_PUBLIC/TELEGRAM_BOT_TOKEN not provided. Telegram Bot disabled.');
            return;
        }
        try {
            this.bot = new telegraf_1.Telegraf(botToken);
            // Setup command handlers
            this.setupCommands();
            // Setup error handling
            this.setupErrorHandling();
            logger_1.logger.info('Telegram Public Bot initialized');
        }
        catch (error) {
            logger_1.logger.error('Failed to initialize Telegram Public Bot', error);
        }
    }
    /**
     * Setup all bot commands
     */
    setupCommands() {
        const bot = this.bot;
        if (!bot)
            return;
        // /start command
        bot.start(async (ctx) => {
            try {
                const chatId = ctx.chat?.id;
                const firstName = ctx.from?.first_name || 'User';
                logger_1.logger.info(`Public bot started by ${firstName} (${chatId})`);
                await ctx.reply(`ðŸ¤– Â¡Bienvenido a AIGestiÃ³n Bot!\n\n` +
                    `Hola ${firstName}, soy tu asistente de IA para gestiÃ³n de proyectos.\n\n` +
                    `Comandos disponibles:\n` +
                    `/help - Muestra esta ayuda\n` +
                    `/status - Estado del sistema\n` +
                    `/analytics - Analytics del proyecto\n` +
                    `/settings - Configurar preferencias\n` +
                    `/daniela - Asistente IA\n\n` +
                    `Â¿CÃ³mo puedo ayudarte?`);
            }
            catch (error) {
                logger_1.logger.error('Error in /start command', error);
                ctx.reply('âŒ Hubo un error. Por favor, intenta de nuevo.');
            }
        });
        // /help command
        bot.help(async (ctx) => {
            try {
                await ctx.reply(`ðŸ“š *GuÃ­a de Comandos AIGestiÃ³n Bot*\n\n` +
                    `/start - Inicia el bot\n` +
                    `/help - Muestra esta ayuda\n` +
                    `/status - Estado actual del sistema\n` +
                    `/analytics - Ver analytics del proyecto\n` +
                    `/settings - Configurar preferencias\n` +
                    `/daniela - Asistente IA\n\n` +
                    `_Para mÃ¡s informaciÃ³n, visita nuestro sitio web._`, { parse_mode: 'Markdown' });
            }
            catch (error) {
                logger_1.logger.error('Error in /help command', error);
            }
        });
        // /daniela command (public)
        bot.command('daniela', async (ctx) => {
            const daniela = this.daniela;
            if (!daniela) {
                await ctx.reply('âŒ Daniela no estÃ¡ disponible en este momento.');
                return;
            }
            if (!ctx.message || !('text' in ctx.message)) {
                await ctx.reply('âŒ Necesito un mensaje de texto para ayudarte.');
                return;
            }
            const message = ctx.message.text.replace('/daniela', '').trim();
            if (!message) {
                await ctx.reply(daniela.getDanielaInfo(), { parse_mode: 'Markdown' });
                return;
            }
            await ctx.reply('â³ Daniela estÃ¡ pensando...');
            const response = await daniela.processMessage(ctx.chat.id, message, ctx.from?.first_name || 'User', ctx.from?.id.toString() || 'unknown', 'public');
            await ctx.reply(response, { parse_mode: 'Markdown' });
        });
        // /status command
        bot.command('status', async (ctx) => {
            try {
                await ctx.reply(`âœ… *Estado del Sistema*\n\n` +
                    `ðŸŸ¢ Backend: Operacional\n` +
                    `ðŸŸ¢ Telegram Bot: Conectado\n` +
                    `ðŸŸ¢ Notificaciones: Activas\n\n` +
                    `Ãšltima actualizaciÃ³n: ${new Date().toLocaleString()}`, { parse_mode: 'Markdown' });
            }
            catch (error) {
                logger_1.logger.error('Error in /status command', error);
            }
        });
        // /analytics command
        bot.command('analytics', async (ctx) => {
            try {
                await ctx.reply(`ðŸ“Š *Analytics del Proyecto*\n\n` +
                    `ðŸ“ˆ Proyectos activos: 5\n` +
                    `ðŸ‘¥ Miembros del equipo: 12\n` +
                    `âœ… Tareas completadas: 87%\n` +
                    `â±ï¸ Tiempo promedio: 4.2h\n\n` +
                    `Ãšltimos 7 dÃ­as: +15% de productividad`, { parse_mode: 'Markdown' });
            }
            catch (error) {
                logger_1.logger.error('Error in /analytics command', error);
            }
        });
        // /settings command
        bot.command('settings', async (ctx) => {
            try {
                await ctx.reply(`âš™ï¸ *ConfiguraciÃ³n*\n\n` + `Usa los botones de abajo para configurar tus preferencias:\n`, {
                    reply_markup: {
                        inline_keyboard: [
                            [
                                { text: 'ðŸ”” Notificaciones', callback_data: 'settings_notifications' },
                                { text: 'ðŸŒ Idioma', callback_data: 'settings_language' },
                            ],
                            [
                                { text: 'ðŸ• Zona Horaria', callback_data: 'settings_timezone' },
                                { text: 'ðŸ“§ Email', callback_data: 'settings_email' },
                            ],
                            [{ text: 'âŒ Cerrar', callback_data: 'settings_close' }],
                        ],
                    },
                });
            }
            catch (error) {
                logger_1.logger.error('Error in /settings command', error);
            }
        });
    }
    /**
     * Setup error handling
     */
    setupErrorHandling() {
        if (!this.bot)
            return;
        this.bot.catch((err, ctx) => {
            logger_1.logger.error(`Error in public bot context:`, err);
            try {
                ctx.reply('âŒ OcurriÃ³ un error. Por favor, intenta de nuevo.');
            }
            catch (error) {
                logger_1.logger.error('Failed to send error message', error);
            }
        });
    }
    /**
     * Launch the bot
     */
    async launch() {
        if (!this.bot) {
            logger_1.logger.warn('Public bot not initialized. Cannot launch.');
            return;
        }
        if (this.isLaunched) {
            logger_1.logger.warn('Public bot already launched.');
            return;
        }
        try {
            await this.bot.launch();
            this.isLaunched = true;
            logger_1.logger.info('Telegram Public Bot launched successfully');
            // Enable graceful stop
            process.once('SIGINT', () => {
                logger_1.logger.info('SIGINT received, stopping public bot...');
                this.bot?.stop('SIGINT');
            });
            process.once('SIGTERM', () => {
                logger_1.logger.info('SIGTERM received, stopping public bot...');
                this.bot?.stop('SIGTERM');
            });
        }
        catch (error) {
            logger_1.logger.error('Failed to launch Telegram Public Bot', error);
        }
    }
    /**
     * Stop the bot
     */
    async stop() {
        if (!this.bot || !this.isLaunched) {
            return;
        }
        try {
            await this.bot.stop();
            this.isLaunched = false;
            logger_1.logger.info('Telegram Public Bot stopped');
        }
        catch (error) {
            logger_1.logger.error('Error stopping Telegram Public Bot', error);
        }
    }
    /**
     * Check if bot is running
     */
    isRunning() {
        return this.isLaunched;
    }
    /**
     * Get bot instance (for direct access if needed)
     */
    getBot() {
        return this.bot;
    }
};
exports.TelegramBotHandler = TelegramBotHandler;
exports.TelegramBotHandler = TelegramBotHandler = __decorate([
    (0, inversify_1.injectable)(),
    __param(0, (0, inversify_1.inject)(daniela_ai_service_1.DanielaAIService)),
    __metadata("design:paramtypes", [typeof (_a = typeof daniela_ai_service_1.DanielaAIService !== "undefined" && daniela_ai_service_1.DanielaAIService) === "function" ? _a : Object])
], TelegramBotHandler);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxzZXJ2aWNlc1xcdGVsZWdyYW0tYm90LmhhbmRsZXIudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLHlDQUErQztBQUMvQyx1Q0FBNkM7QUFFN0MscURBQTJDO0FBQzNDLDRDQUF5QztBQUN6Qyw2REFBd0Q7QUFFeEQ7O0dBRUc7QUFFSSxJQUFNLGtCQUFrQixHQUF4QixNQUFNLGtCQUFrQjtJQUNyQixHQUFHLEdBQW9CLElBQUksQ0FBQztJQUM1QixVQUFVLEdBQUcsS0FBSyxDQUFDO0lBQ25CLE9BQU8sQ0FBbUI7SUFFbEMsWUFBc0MsT0FBeUI7UUFDN0QsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7UUFDdkIsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO0lBQ3BCLENBQUM7SUFFRDs7T0FFRztJQUNLLFVBQVU7UUFDaEIsTUFBTSxRQUFRLEdBQUcsZ0JBQUcsQ0FBQyx5QkFBeUIsSUFBSSxnQkFBRyxDQUFDLGtCQUFrQixDQUFDO1FBQ3pFLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNkLGVBQU0sQ0FBQyxJQUFJLENBQ1QsbUZBQW1GLENBQ3BGLENBQUM7WUFDRixPQUFPO1FBQ1QsQ0FBQztRQUVELElBQUksQ0FBQztZQUNILElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxtQkFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRWxDLHlCQUF5QjtZQUN6QixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7WUFFckIsdUJBQXVCO1lBQ3ZCLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1lBRTFCLGVBQU0sQ0FBQyxJQUFJLENBQUMsaUNBQWlDLENBQUMsQ0FBQztRQUNqRCxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLGVBQU0sQ0FBQyxLQUFLLENBQUMsMENBQTBDLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDbEUsQ0FBQztJQUNILENBQUM7SUFFRDs7T0FF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LENBQUM7WUFDZixlQUFNLENBQUMsS0FBSyxDQUFDLHNDQUFzQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzlELENBQUM7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSSxLQUFLLENBQUMsSUFBSTtRQUNmLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBQ2xDLE9BQU87UUFDVCxDQUFDO1FBRUQsSUFBSSxDQUFDO1lBQ0gsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ3RCLElBQUksQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDO1lBQ3hCLGVBQU0sQ0FBQyxJQUFJLENBQUMsNkJBQTZCLENBQUMsQ0FBQztRQUM3QyxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLGVBQU0sQ0FBQyxLQUFLLENBQUMsb0NBQW9DLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDNUQsQ0FBQztJQUNILENBQUM7SUFFRDs7T0FFRztJQUNJLFNBQVM7UUFDZCxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUM7SUFDekIsQ0FBQztJQUVEOztPQUVHO0lBQ0ksTUFBTTtRQUNYLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQztJQUNsQixDQUFDO0NBQ0YsQ0FBQTtBQXJRWSxnREFBa0I7NkJBQWxCLGtCQUFrQjtJQUQ5QixJQUFBLHNCQUFVLEdBQUU7SUFNRSxXQUFBLElBQUEsa0JBQU0sRUFBQyxxQ0FBZ0IsQ0FBQyxDQUFBO3lEQUFVLHFDQUFnQixvQkFBaEIscUNBQWdCO0dBTHBELGtCQUFrQixDQXFROUIiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxzZXJ2aWNlc1xcdGVsZWdyYW0tYm90LmhhbmRsZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaW5qZWN0LCBpbmplY3RhYmxlIH0gZnJvbSAnaW52ZXJzaWZ5JztcbmltcG9ydCB7IENvbnRleHQsIFRlbGVncmFmIH0gZnJvbSAndGVsZWdyYWYnO1xuXG5pbXBvcnQgeyBlbnYgfSBmcm9tICcuLi9jb25maWcvZW52LnNjaGVtYSc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuLi91dGlscy9sb2dnZXInO1xuaW1wb3J0IHsgRGFuaWVsYUFJU2VydmljZSB9IGZyb20gJy4vZGFuaWVsYS1haS5zZXJ2aWNlJztcblxuLyoqXG4gKiBUZWxlZ3JhbSBCb3QgSGFuZGxlciAtIFB1YmxpYyBCb3RcbiAqL1xuQGluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFRlbGVncmFtQm90SGFuZGxlciB7XG4gIHByaXZhdGUgYm90OiBUZWxlZ3JhZiB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIGlzTGF1bmNoZWQgPSBmYWxzZTtcbiAgcHJpdmF0ZSBkYW5pZWxhOiBEYW5pZWxhQUlTZXJ2aWNlO1xuXG4gIGNvbnN0cnVjdG9yKEBpbmplY3QoRGFuaWVsYUFJU2VydmljZSkgZGFuaWVsYTogRGFuaWVsYUFJU2VydmljZSkge1xuICAgIHRoaXMuZGFuaWVsYSA9IGRhbmllbGE7XG4gICAgdGhpcy5pbml0aWFsaXplKCk7XG4gIH1cblxuICAvKipcbiAgICogSW5pdGlhbGl6ZSB0aGUgVGVsZWdyYW0gQm90IHdpdGggY29tbWFuZCBoYW5kbGVyc1xuICAgKi9cbiAgcHJpdmF0ZSBpbml0aWFsaXplKCkge1xuICAgIGNvbnN0IGJvdFRva2VuID0gZW52LlRFTEVHUkFNX0JPVF9UT0tFTl9QVUJMSUMgfHwgZW52LlRFTEVHUkFNX0JPVF9UT0tFTjtcbiAgICBpZiAoIWJvdFRva2VuKSB7XG4gICAgICBsb2dnZXIud2FybihcbiAgICAgICAgJ1RFTEVHUkFNX0JPVF9UT0tFTl9QVUJMSUMvVEVMRUdSQU1fQk9UX1RPS0VOIG5vdCBwcm92aWRlZC4gVGVsZWdyYW0gQm90IGRpc2FibGVkLicsXG4gICAgICApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICB0aGlzLmJvdCA9IG5ldyBUZWxlZ3JhZihib3RUb2tlbik7XG5cbiAgICAgIC8vIFNldHVwIGNvbW1hbmQgaGFuZGxlcnNcbiAgICAgIHRoaXMuc2V0dXBDb21tYW5kcygpO1xuXG4gICAgICAvLyBTZXR1cCBlcnJvciBoYW5kbGluZ1xuICAgICAgdGhpcy5zZXR1cEVycm9ySGFuZGxpbmcoKTtcblxuICAgICAgbG9nZ2VyLmluZm8oJ1RlbGVncmFtIFB1YmxpYyBCb3QgaW5pdGlhbGl6ZWQnKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gaW5pdGlhbGl6ZSBUZWxlZ3JhbSBQdWJsaWMgQm90JywgZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTZXR1cCBhbGwgYm90IGNvbW1hbmRzXG4gICAqL1xuICBwcml2YXRlIHNldHVwQ29tbWFuZHMoKSB7XG4gICAgY29uc3QgYm90ID0gdGhpcy5ib3Q7XG4gICAgaWYgKCFib3QpIHJldHVybjtcblxuICAgIC8vIC9zdGFydCBjb21tYW5kXG4gICAgYm90LnN0YXJ0KGFzeW5jIChjdHg6IENvbnRleHQpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IGNoYXRJZCA9IGN0eC5jaGF0Py5pZDtcbiAgICAgICAgY29uc3QgZmlyc3ROYW1lID0gY3R4LmZyb20/LmZpcnN0X25hbWUgfHwgJ1VzZXInO1xuXG4gICAgICAgIGxvZ2dlci5pbmZvKGBQdWJsaWMgYm90IHN0YXJ0ZWQgYnkgJHtmaXJzdE5hbWV9ICgke2NoYXRJZH0pYCk7XG5cbiAgICAgICAgYXdhaXQgY3R4LnJlcGx5KFxuICAgICAgICAgIGDwn6SWIMKhQmllbnZlbmlkbyBhIEFJR2VzdGnDs24gQm90IVxcblxcbmAgK1xuICAgICAgICAgICAgYEhvbGEgJHtmaXJzdE5hbWV9LCBzb3kgdHUgYXNpc3RlbnRlIGRlIElBIHBhcmEgZ2VzdGnDs24gZGUgcHJveWVjdG9zLlxcblxcbmAgK1xuICAgICAgICAgICAgYENvbWFuZG9zIGRpc3BvbmlibGVzOlxcbmAgK1xuICAgICAgICAgICAgYC9oZWxwIC0gTXVlc3RyYSBlc3RhIGF5dWRhXFxuYCArXG4gICAgICAgICAgICBgL3N0YXR1cyAtIEVzdGFkbyBkZWwgc2lzdGVtYVxcbmAgK1xuICAgICAgICAgICAgYC9hbmFseXRpY3MgLSBBbmFseXRpY3MgZGVsIHByb3llY3RvXFxuYCArXG4gICAgICAgICAgICBgL3NldHRpbmdzIC0gQ29uZmlndXJhciBwcmVmZXJlbmNpYXNcXG5gICtcbiAgICAgICAgICAgIGAvZGFuaWVsYSAtIEFzaXN0ZW50ZSBJQVxcblxcbmAgK1xuICAgICAgICAgICAgYMK/Q8OzbW8gcHVlZG8gYXl1ZGFydGU/YCxcbiAgICAgICAgKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGxvZ2dlci5lcnJvcignRXJyb3IgaW4gL3N0YXJ0IGNvbW1hbmQnLCBlcnJvcik7XG4gICAgICAgIGN0eC5yZXBseSgn4p2MIEh1Ym8gdW4gZXJyb3IuIFBvciBmYXZvciwgaW50ZW50YSBkZSBudWV2by4nKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vIC9oZWxwIGNvbW1hbmRcbiAgICBib3QuaGVscChhc3luYyAoY3R4OiBDb250ZXh0KSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBjdHgucmVwbHkoXG4gICAgICAgICAgYPCfk5ogKkd1w61hIGRlIENvbWFuZG9zIEFJR2VzdGnDs24gQm90KlxcblxcbmAgK1xuICAgICAgICAgICAgYC9zdGFydCAtIEluaWNpYSBlbCBib3RcXG5gICtcbiAgICAgICAgICAgIGAvaGVscCAtIE11ZXN0cmEgZXN0YSBheXVkYVxcbmAgK1xuICAgICAgICAgICAgYC9zdGF0dXMgLSBFc3RhZG8gYWN0dWFsIGRlbCBzaXN0ZW1hXFxuYCArXG4gICAgICAgICAgICBgL2FuYWx5dGljcyAtIFZlciBhbmFseXRpY3MgZGVsIHByb3llY3RvXFxuYCArXG4gICAgICAgICAgICBgL3NldHRpbmdzIC0gQ29uZmlndXJhciBwcmVmZXJlbmNpYXNcXG5gICtcbiAgICAgICAgICAgIGAvZGFuaWVsYSAtIEFzaXN0ZW50ZSBJQVxcblxcbmAgK1xuICAgICAgICAgICAgYF9QYXJhIG3DoXMgaW5mb3JtYWNpw7NuLCB2aXNpdGEgbnVlc3RybyBzaXRpbyB3ZWIuX2AsXG4gICAgICAgICAgeyBwYXJzZV9tb2RlOiAnTWFya2Rvd24nIH0sXG4gICAgICAgICk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGluIC9oZWxwIGNvbW1hbmQnLCBlcnJvcik7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICAvLyAvZGFuaWVsYSBjb21tYW5kIChwdWJsaWMpXG4gICAgYm90LmNvbW1hbmQoJ2RhbmllbGEnLCBhc3luYyAoY3R4OiBDb250ZXh0KSA9PiB7XG4gICAgICBjb25zdCBkYW5pZWxhID0gdGhpcy5kYW5pZWxhO1xuICAgICAgaWYgKCFkYW5pZWxhKSB7XG4gICAgICAgIGF3YWl0IGN0eC5yZXBseSgn4p2MIERhbmllbGEgbm8gZXN0w6EgZGlzcG9uaWJsZSBlbiBlc3RlIG1vbWVudG8uJyk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgaWYgKCFjdHgubWVzc2FnZSB8fCAhKCd0ZXh0JyBpbiBjdHgubWVzc2FnZSkpIHtcbiAgICAgICAgYXdhaXQgY3R4LnJlcGx5KCfinYwgTmVjZXNpdG8gdW4gbWVuc2FqZSBkZSB0ZXh0byBwYXJhIGF5dWRhcnRlLicpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IG1lc3NhZ2UgPSBjdHgubWVzc2FnZS50ZXh0LnJlcGxhY2UoJy9kYW5pZWxhJywgJycpLnRyaW0oKTtcblxuICAgICAgaWYgKCFtZXNzYWdlKSB7XG4gICAgICAgIGF3YWl0IGN0eC5yZXBseShkYW5pZWxhLmdldERhbmllbGFJbmZvKCksIHsgcGFyc2VfbW9kZTogJ01hcmtkb3duJyB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBhd2FpdCBjdHgucmVwbHkoJ+KPsyBEYW5pZWxhIGVzdMOhIHBlbnNhbmRvLi4uJyk7XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZGFuaWVsYS5wcm9jZXNzTWVzc2FnZShcbiAgICAgICAgY3R4LmNoYXQhLmlkLFxuICAgICAgICBtZXNzYWdlLFxuICAgICAgICBjdHguZnJvbT8uZmlyc3RfbmFtZSB8fCAnVXNlcicsXG4gICAgICAgIGN0eC5mcm9tPy5pZC50b1N0cmluZygpIHx8ICd1bmtub3duJyxcbiAgICAgICAgJ3B1YmxpYycsXG4gICAgICApO1xuXG4gICAgICBhd2FpdCBjdHgucmVwbHkocmVzcG9uc2UsIHsgcGFyc2VfbW9kZTogJ01hcmtkb3duJyB9KTtcbiAgICB9KTtcblxuICAgIC8vIC9zdGF0dXMgY29tbWFuZFxuICAgIGJvdC5jb21tYW5kKCdzdGF0dXMnLCBhc3luYyAoY3R4OiBDb250ZXh0KSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBjdHgucmVwbHkoXG4gICAgICAgICAgYOKchSAqRXN0YWRvIGRlbCBTaXN0ZW1hKlxcblxcbmAgK1xuICAgICAgICAgICAgYPCfn6IgQmFja2VuZDogT3BlcmFjaW9uYWxcXG5gICtcbiAgICAgICAgICAgIGDwn5+iIFRlbGVncmFtIEJvdDogQ29uZWN0YWRvXFxuYCArXG4gICAgICAgICAgICBg8J+foiBOb3RpZmljYWNpb25lczogQWN0aXZhc1xcblxcbmAgK1xuICAgICAgICAgICAgYMOabHRpbWEgYWN0dWFsaXphY2nDs246ICR7bmV3IERhdGUoKS50b0xvY2FsZVN0cmluZygpfWAsXG4gICAgICAgICAgeyBwYXJzZV9tb2RlOiAnTWFya2Rvd24nIH0sXG4gICAgICAgICk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGluIC9zdGF0dXMgY29tbWFuZCcsIGVycm9yKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vIC9hbmFseXRpY3MgY29tbWFuZFxuICAgIGJvdC5jb21tYW5kKCdhbmFseXRpY3MnLCBhc3luYyAoY3R4OiBDb250ZXh0KSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBjdHgucmVwbHkoXG4gICAgICAgICAgYPCfk4ogKkFuYWx5dGljcyBkZWwgUHJveWVjdG8qXFxuXFxuYCArXG4gICAgICAgICAgICBg8J+TiCBQcm95ZWN0b3MgYWN0aXZvczogNVxcbmAgK1xuICAgICAgICAgICAgYPCfkaUgTWllbWJyb3MgZGVsIGVxdWlwbzogMTJcXG5gICtcbiAgICAgICAgICAgIGDinIUgVGFyZWFzIGNvbXBsZXRhZGFzOiA4NyVcXG5gICtcbiAgICAgICAgICAgIGDij7HvuI8gVGllbXBvIHByb21lZGlvOiA0LjJoXFxuXFxuYCArXG4gICAgICAgICAgICBgw5psdGltb3MgNyBkw61hczogKzE1JSBkZSBwcm9kdWN0aXZpZGFkYCxcbiAgICAgICAgICB7IHBhcnNlX21vZGU6ICdNYXJrZG93bicgfSxcbiAgICAgICAgKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGxvZ2dlci5lcnJvcignRXJyb3IgaW4gL2FuYWx5dGljcyBjb21tYW5kJywgZXJyb3IpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gL3NldHRpbmdzIGNvbW1hbmRcbiAgICBib3QuY29tbWFuZCgnc2V0dGluZ3MnLCBhc3luYyAoY3R4OiBDb250ZXh0KSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBjdHgucmVwbHkoXG4gICAgICAgICAgYOKame+4jyAqQ29uZmlndXJhY2nDs24qXFxuXFxuYCArIGBVc2EgbG9zIGJvdG9uZXMgZGUgYWJham8gcGFyYSBjb25maWd1cmFyIHR1cyBwcmVmZXJlbmNpYXM6XFxuYCxcbiAgICAgICAgICB7XG4gICAgICAgICAgICByZXBseV9tYXJrdXA6IHtcbiAgICAgICAgICAgICAgaW5saW5lX2tleWJvYXJkOiBbXG4gICAgICAgICAgICAgICAgW1xuICAgICAgICAgICAgICAgICAgeyB0ZXh0OiAn8J+UlCBOb3RpZmljYWNpb25lcycsIGNhbGxiYWNrX2RhdGE6ICdzZXR0aW5nc19ub3RpZmljYXRpb25zJyB9LFxuICAgICAgICAgICAgICAgICAgeyB0ZXh0OiAn8J+MjSBJZGlvbWEnLCBjYWxsYmFja19kYXRhOiAnc2V0dGluZ3NfbGFuZ3VhZ2UnIH0sXG4gICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICBbXG4gICAgICAgICAgICAgICAgICB7IHRleHQ6ICfwn5WQIFpvbmEgSG9yYXJpYScsIGNhbGxiYWNrX2RhdGE6ICdzZXR0aW5nc190aW1lem9uZScgfSxcbiAgICAgICAgICAgICAgICAgIHsgdGV4dDogJ/Cfk6cgRW1haWwnLCBjYWxsYmFja19kYXRhOiAnc2V0dGluZ3NfZW1haWwnIH0sXG4gICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICBbeyB0ZXh0OiAn4p2MIENlcnJhcicsIGNhbGxiYWNrX2RhdGE6ICdzZXR0aW5nc19jbG9zZScgfV0sXG4gICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGluIC9zZXR0aW5ncyBjb21tYW5kJywgZXJyb3IpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldHVwIGVycm9yIGhhbmRsaW5nXG4gICAqL1xuICBwcml2YXRlIHNldHVwRXJyb3JIYW5kbGluZygpIHtcbiAgICBpZiAoIXRoaXMuYm90KSByZXR1cm47XG5cbiAgICB0aGlzLmJvdC5jYXRjaCgoZXJyOiBhbnksIGN0eDogQ29udGV4dCkgPT4ge1xuICAgICAgbG9nZ2VyLmVycm9yKGBFcnJvciBpbiBwdWJsaWMgYm90IGNvbnRleHQ6YCwgZXJyKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGN0eC5yZXBseSgn4p2MIE9jdXJyacOzIHVuIGVycm9yLiBQb3IgZmF2b3IsIGludGVudGEgZGUgbnVldm8uJyk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBsb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byBzZW5kIGVycm9yIG1lc3NhZ2UnLCBlcnJvcik7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogTGF1bmNoIHRoZSBib3RcbiAgICovXG4gIHB1YmxpYyBhc3luYyBsYXVuY2goKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKCF0aGlzLmJvdCkge1xuICAgICAgbG9nZ2VyLndhcm4oJ1B1YmxpYyBib3Qgbm90IGluaXRpYWxpemVkLiBDYW5ub3QgbGF1bmNoLicpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmlzTGF1bmNoZWQpIHtcbiAgICAgIGxvZ2dlci53YXJuKCdQdWJsaWMgYm90IGFscmVhZHkgbGF1bmNoZWQuJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuYm90LmxhdW5jaCgpO1xuICAgICAgdGhpcy5pc0xhdW5jaGVkID0gdHJ1ZTtcbiAgICAgIGxvZ2dlci5pbmZvKCdUZWxlZ3JhbSBQdWJsaWMgQm90IGxhdW5jaGVkIHN1Y2Nlc3NmdWxseScpO1xuXG4gICAgICAvLyBFbmFibGUgZ3JhY2VmdWwgc3RvcFxuICAgICAgcHJvY2Vzcy5vbmNlKCdTSUdJTlQnLCAoKSA9PiB7XG4gICAgICAgIGxvZ2dlci5pbmZvKCdTSUdJTlQgcmVjZWl2ZWQsIHN0b3BwaW5nIHB1YmxpYyBib3QuLi4nKTtcbiAgICAgICAgdGhpcy5ib3Q/LnN0b3AoJ1NJR0lOVCcpO1xuICAgICAgfSk7XG5cbiAgICAgIHByb2Nlc3Mub25jZSgnU0lHVEVSTScsICgpID0+IHtcbiAgICAgICAgbG9nZ2VyLmluZm8oJ1NJR1RFUk0gcmVjZWl2ZWQsIHN0b3BwaW5nIHB1YmxpYyBib3QuLi4nKTtcbiAgICAgICAgdGhpcy5ib3Q/LnN0b3AoJ1NJR1RFUk0nKTtcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byBsYXVuY2ggVGVsZWdyYW0gUHVibGljIEJvdCcsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU3RvcCB0aGUgYm90XG4gICAqL1xuICBwdWJsaWMgYXN5bmMgc3RvcCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoIXRoaXMuYm90IHx8ICF0aGlzLmlzTGF1bmNoZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5ib3Quc3RvcCgpO1xuICAgICAgdGhpcy5pc0xhdW5jaGVkID0gZmFsc2U7XG4gICAgICBsb2dnZXIuaW5mbygnVGVsZWdyYW0gUHVibGljIEJvdCBzdG9wcGVkJyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignRXJyb3Igc3RvcHBpbmcgVGVsZWdyYW0gUHVibGljIEJvdCcsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2sgaWYgYm90IGlzIHJ1bm5pbmdcbiAgICovXG4gIHB1YmxpYyBpc1J1bm5pbmcoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuaXNMYXVuY2hlZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgYm90IGluc3RhbmNlIChmb3IgZGlyZWN0IGFjY2VzcyBpZiBuZWVkZWQpXG4gICAqL1xuICBwdWJsaWMgZ2V0Qm90KCk6IFRlbGVncmFmIHwgbnVsbCB7XG4gICAgcmV0dXJuIHRoaXMuYm90O1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=