0370e3c20f31e4b078014f588332f0b5
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.comprehensiveThreatCheck = exports.checkHashThreat = exports.checkURLThreat = exports.checkDomainThreat = exports.checkIPThreat = exports.threatIntelligenceMiddleware = exports.ThreatIntelligenceMiddleware = void 0;
const threat_intelligence_service_1 = require("../services/threat-intelligence.service");
const logger_1 = require("../utils/logger");
/**
 * Middleware for threat intelligence integration
 */
class ThreatIntelligenceMiddleware {
    threatService;
    constructor() {
        this.threatService = new threat_intelligence_service_1.ThreatIntelligenceService();
    }
    /**
     * Check IP address against threat intelligence
     */
    checkIPThreat = async (req, res, next) => {
        try {
            const clientIP = this.getClientIP(req);
            if (!clientIP || this.isPrivateIP(clientIP)) {
                return next();
            }
            const threat = await this.threatService.checkIPAddress(clientIP);
            if (threat) {
                req.threatCheck = req.threatCheck || { riskScore: 0, action: 'allow' };
                req.threatCheck.ipThreat = threat;
                req.threatCheck.riskScore += this.getScoreFromSeverity(threat.severity);
                // Determine action based on severity
                if (threat.severity === 'critical' || threat.severity === 'high') {
                    req.threatCheck.action = 'block';
                }
                else if (threat.severity === 'medium') {
                    req.threatCheck.action = req.threatCheck.action === 'block' ? 'block' : 'warn';
                }
                logger_1.logger.warn('Threat detected - IP', {
                    ip: clientIP,
                    threat: threat.description,
                    severity: threat.severity,
                    action: req.threatCheck.action,
                });
                // Add security headers
                res.setHeader('X-Threat-IP-Detected', 'true');
                res.setHeader('X-Threat-IP-Severity', threat.severity);
                res.setHeader('X-Threat-IP-Source', threat.source);
            }
            next();
        }
        catch (error) {
            logger_1.logger.error('Error checking IP threat:', error);
            next(); // Continue on error to avoid breaking functionality
        }
    };
    /**
     * Check domain against threat intelligence
     */
    checkDomainThreat = async (req, res, next) => {
        try {
            const domain = this.extractDomainFromRequest(req);
            if (!domain) {
                return next();
            }
            const threat = await this.threatService.checkDomain(domain);
            if (threat) {
                req.threatCheck = req.threatCheck || { riskScore: 0, action: 'allow' };
                req.threatCheck.domainThreat = threat;
                req.threatCheck.riskScore += this.getScoreFromSeverity(threat.severity);
                // Determine action based on severity
                if (threat.severity === 'critical' || threat.severity === 'high') {
                    req.threatCheck.action = 'block';
                }
                else if (threat.severity === 'medium') {
                    req.threatCheck.action = req.threatCheck.action === 'block' ? 'block' : 'warn';
                }
                logger_1.logger.warn('Threat detected - Domain', {
                    domain,
                    threat: threat.description,
                    severity: threat.severity,
                    action: req.threatCheck.action,
                });
                // Add security headers
                res.setHeader('X-Threat-Domain-Detected', 'true');
                res.setHeader('X-Threat-Domain-Severity', threat.severity);
                res.setHeader('X-Threat-Domain-Source', threat.source);
            }
            next();
        }
        catch (error) {
            logger_1.logger.error('Error checking domain threat:', error);
            next();
        }
    };
    /**
     * Check URL against threat intelligence
     */
    checkURLThreat = async (req, res, next) => {
        try {
            const url = this.extractURLFromRequest(req);
            if (!url) {
                return next();
            }
            const threat = await this.threatService.checkURL(url);
            if (threat) {
                req.threatCheck = req.threatCheck || { riskScore: 0, action: 'allow' };
                req.threatCheck.urlThreat = threat;
                req.threatCheck.riskScore += this.getScoreFromSeverity(threat.severity);
                // Determine action based on severity
                if (threat.severity === 'critical' || threat.severity === 'high') {
                    req.threatCheck.action = 'block';
                }
                else if (threat.severity === 'medium') {
                    req.threatCheck.action = req.threatCheck.action === 'block' ? 'block' : 'warn';
                }
                logger_1.logger.warn('Threat detected - URL', {
                    url,
                    threat: threat.description,
                    severity: threat.severity,
                    action: req.threatCheck.action,
                });
                // Add security headers
                res.setHeader('X-Threat-URL-Detected', 'true');
                res.setHeader('X-Threat-URL-Severity', threat.severity);
                res.setHeader('X-Threat-URL-Source', threat.source);
            }
            next();
        }
        catch (error) {
            logger_1.logger.error('Error checking URL threat:', error);
            next();
        }
    };
    /**
     * Check file hash against threat intelligence
     */
    checkHashThreat = async (req, res, next) => {
        try {
            const hash = this.extractHashFromRequest(req);
            if (!hash) {
                return next();
            }
            const threat = await this.threatService.checkHash(hash);
            if (threat) {
                req.threatCheck = req.threatCheck || { riskScore: 0, action: 'allow' };
                req.threatCheck.riskScore += this.getScoreFromSeverity(threat.severity);
                // Always block malicious files
                req.threatCheck.action = 'block';
                logger_1.logger.warn('Threat detected - File Hash', {
                    hash,
                    threat: threat.description,
                    severity: threat.severity,
                    action: req.threatCheck.action,
                });
                // Add security headers
                res.setHeader('X-Threat-Hash-Detected', 'true');
                res.setHeader('X-Threat-Hash-Severity', threat.severity);
                res.setHeader('X-Threat-Hash-Source', threat.source);
            }
            next();
        }
        catch (error) {
            logger_1.logger.error('Error checking hash threat:', error);
            next();
        }
    };
    /**
     * Comprehensive threat check (IP, Domain, URL)
     */
    comprehensiveThreatCheck = async (req, res, next) => {
        try {
            req.threatCheck = { riskScore: 0, action: 'allow' };
            // Run all threat checks in parallel
            await Promise.all([
                this.checkIPThreat(req, res, () => { }),
                this.checkDomainThreat(req, res, () => { }),
                this.checkURLThreat(req, res, () => { }),
            ]);
            // Add overall threat score header
            res.setHeader('X-Threat-Score', req.threatCheck.riskScore.toString());
            res.setHeader('X-Threat-Action', req.threatCheck.action);
            // Block request if action is block
            if (req.threatCheck.action === 'block') {
                logger_1.logger.warn('Request blocked due to threat intelligence', {
                    ip: this.getClientIP(req),
                    path: req.path,
                    riskScore: req.threatCheck.riskScore,
                    threats: {
                        ip: req.threatCheck.ipThreat?.description,
                        domain: req.threatCheck.domainThreat?.description,
                        url: req.threatCheck.urlThreat?.description,
                    },
                });
                return res.status(403).json({
                    success: false,
                    error: 'Request blocked due to security concerns',
                    code: 'THREAT_BLOCKED',
                    data: {
                        riskScore: req.threatCheck.riskScore,
                        threats: {
                            ip: req.threatCheck.ipThreat
                                ? {
                                    severity: req.threatCheck.ipThreat.severity,
                                    description: req.threatCheck.ipThreat.description,
                                    source: req.threatCheck.ipThreat.source,
                                }
                                : null,
                            domain: req.threatCheck.domainThreat
                                ? {
                                    severity: req.threatCheck.domainThreat.severity,
                                    description: req.threatCheck.domainThreat.description,
                                    source: req.threatCheck.domainThreat.source,
                                }
                                : null,
                            url: req.threatCheck.urlThreat
                                ? {
                                    severity: req.threatCheck.urlThreat.severity,
                                    description: req.threatCheck.urlThreat.description,
                                    source: req.threatCheck.urlThreat.source,
                                }
                                : null,
                        },
                    },
                });
            }
            // Add warning headers if action is warn
            if (req.threatCheck.action === 'warn') {
                res.setHeader('X-Threat-Warning', 'true');
                logger_1.logger.warn('Request allowed with threat warning', {
                    ip: this.getClientIP(req),
                    path: req.path,
                    riskScore: req.threatCheck.riskScore,
                });
            }
            next();
        }
        catch (error) {
            logger_1.logger.error('Error in comprehensive threat check:', error);
            next();
        }
    };
    /**
     * Get client IP address
     */
    getClientIP(req) {
        return (req.ip ||
            req.connection.remoteAddress ||
            req.socket.remoteAddress ||
            req.connection?.socket?.remoteAddress ||
            'unknown');
    }
    /**
     * Check if IP is private
     */
    isPrivateIP(ip) {
        // Private IP ranges
        const privateRanges = [
            /^10\./,
            /^172\.(1[6-9]|2[0-9]|3[01])\./,
            /^192\.168\./,
            /^127\./,
            /^169\.254\./,
            /^::1$/,
            /^fc00:/,
            /^fe80:/,
        ];
        return privateRanges.some(range => range.test(ip));
    }
    /**
     * Extract domain from request
     */
    extractDomainFromRequest(req) {
        // Try to get domain from various sources
        const host = req.get('Host') || req.get('X-Forwarded-Host') || req.hostname;
        if (host) {
            // Remove port if present
            return host.split(':')[0];
        }
        // Try to extract from URL parameter
        if (req.query && typeof req.query.url === 'string') {
            try {
                return new URL(req.query.url).hostname;
            }
            catch {
                // Invalid URL
            }
        }
        // Try to extract from body
        if (req.body && typeof req.body === 'object') {
            const url = req.body.url || req.body.domain || req.body.website;
            if (typeof url === 'string') {
                try {
                    return new URL(url).hostname;
                }
                catch {
                    // Invalid URL, might be just a domain
                    if (url.includes('.')) {
                        return url.split('/')[0]; // Remove path if any
                    }
                }
            }
        }
        return null;
    }
    /**
     * Extract URL from request
     */
    extractURLFromRequest(req) {
        // Try to get URL from various sources
        if (req.query && typeof req.query.url === 'string') {
            return req.query.url;
        }
        if (req.body && typeof req.body === 'object') {
            const url = req.body.url || req.body.link || req.body.redirect;
            if (typeof url === 'string') {
                return url;
            }
        }
        // Try Referer header
        const referer = req.get('Referer');
        if (referer) {
            return referer;
        }
        return null;
    }
    /**
     * Extract hash from request
     */
    extractHashFromRequest(req) {
        // Try to get hash from various sources
        if (req.query && typeof req.query.hash === 'string') {
            return req.query.hash;
        }
        if (req.body && typeof req.body === 'object') {
            const hash = req.body.hash || req.body.fileHash || req.body.checksum;
            if (typeof hash === 'string') {
                return hash;
            }
        }
        // Try from file upload
        if (req.file && req.file.filename) {
            // In a real implementation, you would calculate the file hash
            // For now, return null
            return null;
        }
        return null;
    }
    /**
     * Get score from severity
     */
    getScoreFromSeverity(severity) {
        switch (severity) {
            case 'critical':
                return 10;
            case 'high':
                return 7;
            case 'medium':
                return 4;
            case 'low':
                return 1;
            default:
                return 0;
        }
    }
    /**
     * Get threat intelligence statistics
     */
    getStats = async (req, res) => {
        try {
            const stats = await this.threatService.getStats();
            res.json({
                success: true,
                data: stats,
            });
        }
        catch (error) {
            logger_1.logger.error('Error getting threat stats:', error);
            res.status(500).json({
                success: false,
                error: 'Failed to get threat intelligence statistics',
            });
        }
    };
    /**
     * Get recent threat alerts
     */
    getRecentAlerts = async (req, res) => {
        try {
            const limit = parseInt(req.query.limit) || 100;
            const alerts = await this.threatService.getRecentAlerts(limit);
            res.json({
                success: true,
                data: alerts,
            });
        }
        catch (error) {
            logger_1.logger.error('Error getting recent alerts:', error);
            res.status(500).json({
                success: false,
                error: 'Failed to get recent threat alerts',
            });
        }
    };
    /**
     * Add custom threat indicator
     */
    addCustomIndicator = async (req, res) => {
        try {
            const indicator = req.body;
            if (!indicator.type || !indicator.value || !indicator.source) {
                return res.status(400).json({
                    success: false,
                    error: 'type, value, and source are required',
                });
            }
            const success = await this.threatService.addCustomIndicator(indicator);
            res.json({
                success: true,
                data: { added: success },
            });
        }
        catch (error) {
            logger_1.logger.error('Error adding custom indicator:', error);
            res.status(500).json({
                success: false,
                error: 'Failed to add custom threat indicator',
            });
        }
    };
    /**
     * Get threat feeds
     */
    getFeeds = (req, res) => {
        try {
            const feeds = this.threatService.getFeeds();
            res.json({
                success: true,
                data: feeds,
            });
        }
        catch (error) {
            logger_1.logger.error('Error getting threat feeds:', error);
            res.status(500).json({
                success: false,
                error: 'Failed to get threat feeds',
            });
        }
    };
    /**
     * Toggle threat feed
     */
    toggleFeed = async (req, res) => {
        try {
            const { feedName, enabled } = req.body;
            if (!feedName || typeof enabled !== 'boolean') {
                return res.status(400).json({
                    success: false,
                    error: 'feedName and enabled are required',
                });
            }
            const success = await this.threatService.toggleFeed(feedName, enabled);
            res.json({
                success: true,
                data: { toggled: success },
            });
        }
        catch (error) {
            logger_1.logger.error('Error toggling feed:', error);
            res.status(500).json({
                success: false,
                error: 'Failed to toggle threat feed',
            });
        }
    };
}
exports.ThreatIntelligenceMiddleware = ThreatIntelligenceMiddleware;
// Export singleton instance
exports.threatIntelligenceMiddleware = new ThreatIntelligenceMiddleware();
// Export convenience methods
exports.checkIPThreat = exports.threatIntelligenceMiddleware.checkIPThreat;
exports.checkDomainThreat = exports.threatIntelligenceMiddleware.checkDomainThreat;
exports.checkURLThreat = exports.threatIntelligenceMiddleware.checkURLThreat;
exports.checkHashThreat = exports.threatIntelligenceMiddleware.checkHashThreat;
exports.comprehensiveThreatCheck = exports.threatIntelligenceMiddleware.comprehensiveThreatCheck;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxtaWRkbGV3YXJlXFx0aHJlYXQtaW50ZWxsaWdlbmNlLm1pZGRsZXdhcmUudHMiLCJtYXBwaW5ncyI6Ijs7O0FBQ0EseUZBQW9GO0FBQ3BGLDRDQUF5QztBQVl6Qzs7R0FFRztBQUNILE1BQWEsNEJBQTRCO0lBQy9CLGFBQWEsQ0FBNEI7SUFFakQ7UUFDRSxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksdURBQXlCLEVBQUUsQ0FBQztJQUN2RCxDQUFDO0lBRUQ7O09BRUc7SUFDSSxhQUFhLEdBQUcsS0FBSyxFQUFFLEdBQWtCLEVBQUUsR0FBYSxFQUFFLElBQWtCLEVBQUUsRUFBRTtRQUNyRixJQUFJLENBQUM7WUFDSCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBRXZDLElBQUksQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDO2dCQUM1QyxPQUFPLElBQUksRUFBRSxDQUFDO1lBQ2hCLENBQUM7WUFFRCxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxhQUFhLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRWpFLElBQUksTUFBTSxFQUFFLENBQUM7Z0JBQ1gsR0FBRyxDQUFDLFdBQVcsR0FBRyxHQUFHLENBQUMsV0FBVyxJQUFJLEVBQUUsU0FBUyxFQUFFLENBQUMsRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLENBQUM7Z0JBQ3ZFLEdBQUcsQ0FBQyxXQUFXLENBQUMsUUFBUSxHQUFHLE1BQU0sQ0FBQztnQkFDbEMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLG9CQUFvQixDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFFeEUscUNBQXFDO2dCQUNyQyxJQUFJLE1BQU0sQ0FBQyxRQUFRLEtBQUssVUFBVSxJQUFJLE1BQU0sQ0FBQyxRQUFRLEtBQUss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Q0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQztZQUV2RSxHQUFHLENBQUMsSUFBSSxDQUFDO2dCQUNQLE9BQU8sRUFBRSxJQUFJO2dCQUNiLElBQUksRUFBRSxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUU7YUFDM0IsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixlQUFNLENBQUMsS0FBSyxDQUFDLHNCQUFzQixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQzVDLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUNuQixPQUFPLEVBQUUsS0FBSztnQkFDZCxLQUFLLEVBQUUsOEJBQThCO2FBQ3RDLENBQUMsQ0FBQztRQUNMLENBQUM7SUFDSCxDQUFDLENBQUM7Q0FDSDtBQTdnQkQsb0VBNmdCQztBQUVELDRCQUE0QjtBQUNmLFFBQUEsNEJBQTRCLEdBQUcsSUFBSSw0QkFBNEIsRUFBRSxDQUFDO0FBRS9FLDZCQUE2QjtBQUNoQixRQUFBLGFBQWEsR0FBRyxvQ0FBNEIsQ0FBQyxhQUFhLENBQUM7QUFDM0QsUUFBQSxpQkFBaUIsR0FBRyxvQ0FBNEIsQ0FBQyxpQkFBaUIsQ0FBQztBQUNuRSxRQUFBLGNBQWMsR0FBRyxvQ0FBNEIsQ0FBQyxjQUFjLENBQUM7QUFDN0QsUUFBQSxlQUFlLEdBQUcsb0NBQTRCLENBQUMsZUFBZSxDQUFDO0FBQy9ELFFBQUEsd0JBQXdCLEdBQUcsb0NBQTRCLENBQUMsd0JBQXdCLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxtaWRkbGV3YXJlXFx0aHJlYXQtaW50ZWxsaWdlbmNlLm1pZGRsZXdhcmUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTmV4dEZ1bmN0aW9uLCBSZXF1ZXN0LCBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgVGhyZWF0SW50ZWxsaWdlbmNlU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL3RocmVhdC1pbnRlbGxpZ2VuY2Uuc2VydmljZSc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuLi91dGlscy9sb2dnZXInO1xuXG5pbnRlcmZhY2UgVGhyZWF0UmVxdWVzdCBleHRlbmRzIFJlcXVlc3Qge1xuICB0aHJlYXRDaGVjaz86IHtcbiAgICBpcFRocmVhdD86IGFueTtcbiAgICBkb21haW5UaHJlYXQ/OiBhbnk7XG4gICAgdXJsVGhyZWF0PzogYW55O1xuICAgIHJpc2tTY29yZTogbnVtYmVyO1xuICAgIGFjdGlvbjogJ2FsbG93JyB8ICd3YXJuJyB8ICdibG9jayc7XG4gIH07XG59XG5cbi8qKlxuICogTWlkZGxld2FyZSBmb3IgdGhyZWF0IGludGVsbGlnZW5jZSBpbnRlZ3JhdGlvblxuICovXG5leHBvcnQgY2xhc3MgVGhyZWF0SW50ZWxsaWdlbmNlTWlkZGxld2FyZSB7XG4gIHByaXZhdGUgdGhyZWF0U2VydmljZTogVGhyZWF0SW50ZWxsaWdlbmNlU2VydmljZTtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLnRocmVhdFNlcnZpY2UgPSBuZXcgVGhyZWF0SW50ZWxsaWdlbmNlU2VydmljZSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrIElQIGFkZHJlc3MgYWdhaW5zdCB0aHJlYXQgaW50ZWxsaWdlbmNlXG4gICAqL1xuICBwdWJsaWMgY2hlY2tJUFRocmVhdCA9IGFzeW5jIChyZXE6IFRocmVhdFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBjbGllbnRJUCA9IHRoaXMuZ2V0Q2xpZW50SVAocmVxKTtcblxuICAgICAgaWYgKCFjbGllbnRJUCB8fCB0aGlzLmlzUHJpdmF0ZUlQKGNsaWVudElQKSkge1xuICAgICAgICByZXR1cm4gbmV4dCgpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB0aHJlYXQgPSBhd2FpdCB0aGlzLnRocmVhdFNlcnZpY2UuY2hlY2tJUEFkZHJlc3MoY2xpZW50SVApO1xuXG4gICAgICBpZiAodGhyZWF0KSB7XG4gICAgICAgIHJlcS50aHJlYXRDaGVjayA9IHJlcS50aHJlYXRDaGVjayB8fCB7IHJpc2tTY29yZTogMCwgYWN0aW9uOiAnYWxsb3cnIH07XG4gICAgICAgIHJlcS50aHJlYXRDaGVjay5pcFRocmVhdCA9IHRocmVhdDtcbiAgICAgICAgcmVxLnRocmVhdENoZWNrLnJpc2tTY29yZSArPSB0aGlzLmdldFNjb3JlRnJvbVNldmVyaXR5KHRocmVhdC5zZXZlcml0eSk7XG5cbiAgICAgICAgLy8gRGV0ZXJtaW5lIGFjdGlvbiBiYXNlZCBvbiBzZXZlcml0eVxuICAgICAgICBpZiAodGhyZWF0LnNldmVyaXR5ID09PSAnY3JpdGljYWwnIHx8IHRocmVhdC5zZXZlcml0eSA9PT0gJ2hpZ2gnKSB7XG4gICAgICAgICAgcmVxLnRocmVhdENoZWNrLmFjdGlvbiA9ICdibG9jayc7XG4gICAgICAgIH0gZWxzZSBpZiAodGhyZWF0LnNldmVyaXR5ID09PSAnbWVkaXVtJykge1xuICAgICAgICAgIHJlcS50aHJlYXRDaGVjay5hY3Rpb24gPSByZXEudGhyZWF0Q2hlY2suYWN0aW9uID09PSAnYmxvY2snID8gJ2Jsb2NrJyA6ICd3YXJuJztcbiAgICAgICAgfVxuXG4gICAgICAgIGxvZ2dlci53YXJuKCdUaHJlYXQgZGV0ZWN0ZWQgLSBJUCcsIHtcbiAgICAgICAgICBpcDogY2xpZW50SVAsXG4gICAgICAgICAgdGhyZWF0OiB0aHJlYXQuZGVzY3JpcHRpb24sXG4gICAgICAgICAgc2V2ZXJpdHk6IHRocmVhdC5zZXZlcml0eSxcbiAgICAgICAgICBhY3Rpb246IHJlcS50aHJlYXRDaGVjay5hY3Rpb24sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIEFkZCBzZWN1cml0eSBoZWFkZXJzXG4gICAgICAgIHJlcy5zZXRIZWFkZXIoJ1gtVGhyZWF0LUlQLURldGVjdGVkJywgJ3RydWUnKTtcbiAgICAgICAgcmVzLnNldEhlYWRlcignWC1UaHJlYXQtSVAtU2V2ZXJpdHknLCB0aHJlYXQuc2V2ZXJpdHkpO1xuICAgICAgICByZXMuc2V0SGVhZGVyKCdYLVRocmVhdC1JUC1Tb3VyY2UnLCB0aHJlYXQuc291cmNlKTtcbiAgICAgIH1cblxuICAgICAgbmV4dCgpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGNoZWNraW5nIElQIHRocmVhdDonLCBlcnJvcik7XG4gICAgICBuZXh0KCk7IC8vIENvbnRpbnVlIG9uIGVycm9yIHRvIGF2b2lkIGJyZWFraW5nIGZ1bmN0aW9uYWxpdHlcbiAgICB9XG4gIH07XG5cbiAgLyoqXG4gICAqIENoZWNrIGRvbWFpbiBhZ2FpbnN0IHRocmVhdCBpbnRlbGxpZ2VuY2VcbiAgICovXG4gIHB1YmxpYyBjaGVja0RvbWFpblRocmVhdCA9IGFzeW5jIChyZXE6IFRocmVhdFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBkb21haW4gPSB0aGlzLmV4dHJhY3REb21haW5Gcm9tUmVxdWVzdChyZXEpO1xuXG4gICAgICBpZiAoIWRvbWFpbikge1xuICAgICAgICByZXR1cm4gbmV4dCgpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB0aHJlYXQgPSBhd2FpdCB0aGlzLnRocmVhdFNlcnZpY2UuY2hlY2tEb21haW4oZG9tYWluKTtcblxuICAgICAgaWYgKHRocmVhdCkge1xuICAgICAgICByZXEudGhyZWF0Q2hlY2sgPSByZXEudGhyZWF0Q2hlY2sgfHwgeyByaXNrU2NvcmU6IDAsIGFjdGlvbjogJ2FsbG93JyB9O1xuICAgICAgICByZXEudGhyZWF0Q2hlY2suZG9tYWluVGhyZWF0ID0gdGhyZWF0O1xuICAgICAgICByZXEudGhyZWF0Q2hlY2sucmlza1Njb3JlICs9IHRoaXMuZ2V0U2NvcmVGcm9tU2V2ZXJpdHkodGhyZWF0LnNldmVyaXR5KTtcblxuICAgICAgICAvLyBEZXRlcm1pbmUgYWN0aW9uIGJhc2VkIG9uIHNldmVyaXR5XG4gICAgICAgIGlmICh0aHJlYXQuc2V2ZXJpdHkgPT09ICdjcml0aWNhbCcgfHwgdGhyZWF0LnNldmVyaXR5ID09PSAnaGlnaCcpIHtcbiAgICAgICAgICByZXEudGhyZWF0Q2hlY2suYWN0aW9uID0gJ2Jsb2NrJztcbiAgICAgICAgfSBlbHNlIGlmICh0aHJlYXQuc2V2ZXJpdHkgPT09ICdtZWRpdW0nKSB7XG4gICAgICAgICAgcmVxLnRocmVhdENoZWNrLmFjdGlvbiA9IHJlcS50aHJlYXRDaGVjay5hY3Rpb24gPT09ICdibG9jaycgPyAnYmxvY2snIDogJ3dhcm4nO1xuICAgICAgICB9XG5cbiAgICAgICAgbG9nZ2VyLndhcm4oJ1RocmVhdCBkZXRlY3RlZCAtIERvbWFpbicsIHtcbiAgICAgICAgICBkb21haW4sXG4gICAgICAgICAgdGhyZWF0OiB0aHJlYXQuZGVzY3JpcHRpb24sXG4gICAgICAgICAgc2V2ZXJpdHk6IHRocmVhdC5zZXZlcml0eSxcbiAgICAgICAgICBhY3Rpb246IHJlcS50aHJlYXRDaGVjay5hY3Rpb24sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIEFkZCBzZWN1cml0eSBoZWFkZXJzXG4gICAgICAgIHJlcy5zZXRIZWFkZXIoJ1gtVGhyZWF0LURvbWFpbi1EZXRlY3RlZCcsICd0cnVlJyk7XG4gICAgICAgIHJlcy5zZXRIZWFkZXIoJ1gtVGhyZWF0LURvbWFpbi1TZXZlcml0eScsIHRocmVhdC5zZXZlcml0eSk7XG4gICAgICAgIHJlcy5zZXRIZWFkZXIoJ1gtVGhyZWF0LURvbWFpbi1Tb3VyY2UnLCB0aHJlYXQuc291cmNlKTtcbiAgICAgIH1cblxuICAgICAgbmV4dCgpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGNoZWNraW5nIGRvbWFpbiB0aHJlYXQ6JywgZXJyb3IpO1xuICAgICAgbmV4dCgpO1xuICAgIH1cbiAgfTtcblxuICAvKipcbiAgICogQ2hlY2sgVVJMIGFnYWluc3QgdGhyZWF0IGludGVsbGlnZW5jZVxuICAgKi9cbiAgcHVibGljIGNoZWNrVVJMVGhyZWF0ID0gYXN5bmMgKHJlcTogVGhyZWF0UmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHVybCA9IHRoaXMuZXh0cmFjdFVSTEZyb21SZXF1ZXN0KHJlcSk7XG5cbiAgICAgIGlmICghdXJsKSB7XG4gICAgICAgIHJldHVybiBuZXh0KCk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHRocmVhdCA9IGF3YWl0IHRoaXMudGhyZWF0U2VydmljZS5jaGVja1VSTCh1cmwpO1xuXG4gICAgICBpZiAodGhyZWF0KSB7XG4gICAgICAgIHJlcS50aHJlYXRDaGVjayA9IHJlcS50aHJlYXRDaGVjayB8fCB7IHJpc2tTY29yZTogMCwgYWN0aW9uOiAnYWxsb3cnIH07XG4gICAgICAgIHJlcS50aHJlYXRDaGVjay51cmxUaHJlYXQgPSB0aHJlYXQ7XG4gICAgICAgIHJlcS50aHJlYXRDaGVjay5yaXNrU2NvcmUgKz0gdGhpcy5nZXRTY29yZUZyb21TZXZlcml0eSh0aHJlYXQuc2V2ZXJpdHkpO1xuXG4gICAgICAgIC8vIERldGVybWluZSBhY3Rpb24gYmFzZWQgb24gc2V2ZXJpdHlcbiAgICAgICAgaWYgKHRocmVhdC5zZXZlcml0eSA9PT0gJ2NyaXRpY2FsJyB8fCB0aHJlYXQuc2V2ZXJpdHkgPT09ICdoaWdoJykge1xuICAgICAgICAgIHJlcS50aHJlYXRDaGVjay5hY3Rpb24gPSAnYmxvY2snO1xuICAgICAgICB9IGVsc2UgaWYgKHRocmVhdC5zZXZlcml0eSA9PT0gJ21lZGl1bScpIHtcbiAgICAgICAgICByZXEudGhyZWF0Q2hlY2suYWN0aW9uID0gcmVxLnRocmVhdENoZWNrLmFjdGlvbiA9PT0gJ2Jsb2NrJyA/ICdibG9jaycgOiAnd2Fybic7XG4gICAgICAgIH1cblxuICAgICAgICBsb2dnZXIud2FybignVGhyZWF0IGRldGVjdGVkIC0gVVJMJywge1xuICAgICAgICAgIHVybCxcbiAgICAgICAgICB0aHJlYXQ6IHRocmVhdC5kZXNjcmlwdGlvbixcbiAgICAgICAgICBzZXZlcml0eTogdGhyZWF0LnNldmVyaXR5LFxuICAgICAgICAgIGFjdGlvbjogcmVxLnRocmVhdENoZWNrLmFjdGlvbixcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gQWRkIHNlY3VyaXR5IGhlYWRlcnNcbiAgICAgICAgcmVzLnNldEhlYWRlcignWC1UaHJlYXQtVVJMLURldGVjdGVkJywgJ3RydWUnKTtcbiAgICAgICAgcmVzLnNldEhlYWRlcignWC1UaHJlYXQtVVJMLVNldmVyaXR5JywgdGhyZWF0LnNldmVyaXR5KTtcbiAgICAgICAgcmVzLnNldEhlYWRlcignWC1UaHJlYXQtVVJMLVNvdXJjZScsIHRocmVhdC5zb3VyY2UpO1xuICAgICAgfVxuXG4gICAgICBuZXh0KCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignRXJyb3IgY2hlY2tpbmcgVVJMIHRocmVhdDonLCBlcnJvcik7XG4gICAgICBuZXh0KCk7XG4gICAgfVxuICB9O1xuXG4gIC8qKlxuICAgKiBDaGVjayBmaWxlIGhhc2ggYWdhaW5zdCB0aHJlYXQgaW50ZWxsaWdlbmNlXG4gICAqL1xuICBwdWJsaWMgY2hlY2tIYXNoVGhyZWF0ID0gYXN5bmMgKHJlcTogVGhyZWF0UmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGhhc2ggPSB0aGlzLmV4dHJhY3RIYXNoRnJvbVJlcXVlc3QocmVxKTtcblxuICAgICAgaWYgKCFoYXNoKSB7XG4gICAgICAgIHJldHVybiBuZXh0KCk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHRocmVhdCA9IGF3YWl0IHRoaXMudGhyZWF0U2VydmljZS5jaGVja0hhc2goaGFzaCk7XG5cbiAgICAgIGlmICh0aHJlYXQpIHtcbiAgICAgICAgcmVxLnRocmVhdENoZWNrID0gcmVxLnRocmVhdENoZWNrIHx8IHsgcmlza1Njb3JlOiAwLCBhY3Rpb246ICdhbGxvdycgfTtcbiAgICAgICAgcmVxLnRocmVhdENoZWNrLnJpc2tTY29yZSArPSB0aGlzLmdldFNjb3JlRnJvbVNldmVyaXR5KHRocmVhdC5zZXZlcml0eSk7XG5cbiAgICAgICAgLy8gQWx3YXlzIGJsb2NrIG1hbGljaW91cyBmaWxlc1xuICAgICAgICByZXEudGhyZWF0Q2hlY2suYWN0aW9uID0gJ2Jsb2NrJztcblxuICAgICAgICBsb2dnZXIud2FybignVGhyZWF0IGRldGVjdGVkIC0gRmlsZSBIYXNoJywge1xuICAgICAgICAgIGhhc2gsXG4gICAgICAgICAgdGhyZWF0OiB0aHJlYXQuZGVzY3JpcHRpb24sXG4gICAgICAgICAgc2V2ZXJpdHk6IHRocmVhdC5zZXZlcml0eSxcbiAgICAgICAgICBhY3Rpb246IHJlcS50aHJlYXRDaGVjay5hY3Rpb24sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIEFkZCBzZWN1cml0eSBoZWFkZXJzXG4gICAgICAgIHJlcy5zZXRIZWFkZXIoJ1gtVGhyZWF0LUhhc2gtRGV0ZWN0ZWQnLCAndHJ1ZScpO1xuICAgICAgICByZXMuc2V0SGVhZGVyKCdYLVRocmVhdC1IYXNoLVNldmVyaXR5JywgdGhyZWF0LnNldmVyaXR5KTtcbiAgICAgICAgcmVzLnNldEhlYWRlcignWC1UaHJlYXQtSGFzaC1Tb3VyY2UnLCB0aHJlYXQuc291cmNlKTtcbiAgICAgIH1cblxuICAgICAgbmV4dCgpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGNoZWNraW5nIGhhc2ggdGhyZWF0OicsIGVycm9yKTtcbiAgICAgIG5leHQoKTtcbiAgICB9XG4gIH07XG5cbiAgLyoqXG4gICAqIENvbXByZWhlbnNpdmUgdGhyZWF0IGNoZWNrIChJUCwgRG9tYWluLCBVUkwpXG4gICAqL1xuICBwdWJsaWMgY29tcHJlaGVuc2l2ZVRocmVhdENoZWNrID0gYXN5bmMgKFxuICAgIHJlcTogVGhyZWF0UmVxdWVzdCxcbiAgICByZXM6IFJlc3BvbnNlLFxuICAgIG5leHQ6IE5leHRGdW5jdGlvbixcbiAgKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIHJlcS50aHJlYXRDaGVjayA9IHsgcmlza1Njb3JlOiAwLCBhY3Rpb246ICdhbGxvdycgfTtcblxuICAgICAgLy8gUnVuIGFsbCB0aHJlYXQgY2hlY2tzIGluIHBhcmFsbGVsXG4gICAgICBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICAgIHRoaXMuY2hlY2tJUFRocmVhdChyZXEsIHJlcywgKCkgPT4ge30pLFxuICAgICAgICB0aGlzLmNoZWNrRG9tYWluVGhyZWF0KHJlcSwgcmVzLCAoKSA9PiB7fSksXG4gICAgICAgIHRoaXMuY2hlY2tVUkxUaHJlYXQocmVxLCByZXMsICgpID0+IHt9KSxcbiAgICAgIF0pO1xuXG4gICAgICAvLyBBZGQgb3ZlcmFsbCB0aHJlYXQgc2NvcmUgaGVhZGVyXG4gICAgICByZXMuc2V0SGVhZGVyKCdYLVRocmVhdC1TY29yZScsIHJlcS50aHJlYXRDaGVjay5yaXNrU2NvcmUudG9TdHJpbmcoKSk7XG4gICAgICByZXMuc2V0SGVhZGVyKCdYLVRocmVhdC1BY3Rpb24nLCByZXEudGhyZWF0Q2hlY2suYWN0aW9uKTtcblxuICAgICAgLy8gQmxvY2sgcmVxdWVzdCBpZiBhY3Rpb24gaXMgYmxvY2tcbiAgICAgIGlmIChyZXEudGhyZWF0Q2hlY2suYWN0aW9uID09PSAnYmxvY2snKSB7XG4gICAgICAgIGxvZ2dlci53YXJuKCdSZXF1ZXN0IGJsb2NrZWQgZHVlIHRvIHRocmVhdCBpbnRlbGxpZ2VuY2UnLCB7XG4gICAgICAgICAgaXA6IHRoaXMuZ2V0Q2xpZW50SVAocmVxKSxcbiAgICAgICAgICBwYXRoOiByZXEucGF0aCxcbiAgICAgICAgICByaXNrU2NvcmU6IHJlcS50aHJlYXRDaGVjay5yaXNrU2NvcmUsXG4gICAgICAgICAgdGhyZWF0czoge1xuICAgICAgICAgICAgaXA6IHJlcS50aHJlYXRDaGVjay5pcFRocmVhdD8uZGVzY3JpcHRpb24sXG4gICAgICAgICAgICBkb21haW46IHJlcS50aHJlYXRDaGVjay5kb21haW5UaHJlYXQ/LmRlc2NyaXB0aW9uLFxuICAgICAgICAgICAgdXJsOiByZXEudGhyZWF0Q2hlY2sudXJsVGhyZWF0Py5kZXNjcmlwdGlvbixcbiAgICAgICAgICB9LFxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oe1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIGVycm9yOiAnUmVxdWVzdCBibG9ja2VkIGR1ZSB0byBzZWN1cml0eSBjb25jZXJucycsXG4gICAgICAgICAgY29kZTogJ1RIUkVBVF9CTE9DS0VEJyxcbiAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICByaXNrU2NvcmU6IHJlcS50aHJlYXRDaGVjay5yaXNrU2NvcmUsXG4gICAgICAgICAgICB0aHJlYXRzOiB7XG4gICAgICAgICAgICAgIGlwOiByZXEudGhyZWF0Q2hlY2suaXBUaHJlYXRcbiAgICAgICAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgICAgICAgc2V2ZXJpdHk6IHJlcS50aHJlYXRDaGVjay5pcFRocmVhdC5zZXZlcml0eSxcbiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IHJlcS50aHJlYXRDaGVjay5pcFRocmVhdC5kZXNjcmlwdGlvbixcbiAgICAgICAgICAgICAgICAgICAgc291cmNlOiByZXEudGhyZWF0Q2hlY2suaXBUaHJlYXQuc291cmNlLFxuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIDogbnVsbCxcbiAgICAgICAgICAgICAgZG9tYWluOiByZXEudGhyZWF0Q2hlY2suZG9tYWluVGhyZWF0XG4gICAgICAgICAgICAgICAgPyB7XG4gICAgICAgICAgICAgICAgICAgIHNldmVyaXR5OiByZXEudGhyZWF0Q2hlY2suZG9tYWluVGhyZWF0LnNldmVyaXR5LFxuICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogcmVxLnRocmVhdENoZWNrLmRvbWFpblRocmVhdC5kZXNjcmlwdGlvbixcbiAgICAgICAgICAgICAgICAgICAgc291cmNlOiByZXEudGhyZWF0Q2hlY2suZG9tYWluVGhyZWF0LnNvdXJjZSxcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICA6IG51bGwsXG4gICAgICAgICAgICAgIHVybDogcmVxLnRocmVhdENoZWNrLnVybFRocmVhdFxuICAgICAgICAgICAgICAgID8ge1xuICAgICAgICAgICAgICAgICAgICBzZXZlcml0eTogcmVxLnRocmVhdENoZWNrLnVybFRocmVhdC5zZXZlcml0eSxcbiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IHJlcS50aHJlYXRDaGVjay51cmxUaHJlYXQuZGVzY3JpcHRpb24sXG4gICAgICAgICAgICAgICAgICAgIHNvdXJjZTogcmVxLnRocmVhdENoZWNrLnVybFRocmVhdC5zb3VyY2UsXG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgOiBudWxsLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gQWRkIHdhcm5pbmcgaGVhZGVycyBpZiBhY3Rpb24gaXMgd2FyblxuICAgICAgaWYgKHJlcS50aHJlYXRDaGVjay5hY3Rpb24gPT09ICd3YXJuJykge1xuICAgICAgICByZXMuc2V0SGVhZGVyKCdYLVRocmVhdC1XYXJuaW5nJywgJ3RydWUnKTtcbiAgICAgICAgbG9nZ2VyLndhcm4oJ1JlcXVlc3QgYWxsb3dlZCB3aXRoIHRocmVhdCB3YXJuaW5nJywge1xuICAgICAgICAgIGlwOiB0aGlzLmdldENsaWVudElQKHJlcSksXG4gICAgICAgICAgcGF0aDogcmVxLnBhdGgsXG4gICAgICAgICAgcmlza1Njb3JlOiByZXEudGhyZWF0Q2hlY2sucmlza1Njb3JlLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgbmV4dCgpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGluIGNvbXByZWhlbnNpdmUgdGhyZWF0IGNoZWNrOicsIGVycm9yKTtcbiAgICAgIG5leHQoKTtcbiAgICB9XG4gIH07XG5cbiAgLyoqXG4gICAqIEdldCBjbGllbnQgSVAgYWRkcmVzc1xuICAgKi9cbiAgcHJpdmF0ZSBnZXRDbGllbnRJUChyZXE6IFJlcXVlc3QpOiBzdHJpbmcge1xuICAgIHJldHVybiAoXG4gICAgICByZXEuaXAgfHxcbiAgICAgIHJlcS5jb25uZWN0aW9uLnJlbW90ZUFkZHJlc3MgfHxcbiAgICAgIHJlcS5zb2NrZXQucmVtb3RlQWRkcmVzcyB8fFxuICAgICAgKHJlcS5jb25uZWN0aW9uIGFzIGFueSk/LnNvY2tldD8ucmVtb3RlQWRkcmVzcyB8fFxuICAgICAgJ3Vua25vd24nXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBpZiBJUCBpcyBwcml2YXRlXG4gICAqL1xuICBwcml2YXRlIGlzUHJpdmF0ZUlQKGlwOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAvLyBQcml2YXRlIElQIHJhbmdlc1xuICAgIGNvbnN0IHByaXZhdGVSYW5nZXMgPSBbXG4gICAgICAvXjEwXFwuLyxcbiAgICAgIC9eMTcyXFwuKDFbNi05XXwyWzAtOV18M1swMV0pXFwuLyxcbiAgICAgIC9eMTkyXFwuMTY4XFwuLyxcbiAgICAgIC9eMTI3XFwuLyxcbiAgICAgIC9eMTY5XFwuMjU0XFwuLyxcbiAgICAgIC9eOjoxJC8sXG4gICAgICAvXmZjMDA6LyxcbiAgICAgIC9eZmU4MDovLFxuICAgIF07XG5cbiAgICByZXR1cm4gcHJpdmF0ZVJhbmdlcy5zb21lKHJhbmdlID0+IHJhbmdlLnRlc3QoaXApKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBFeHRyYWN0IGRvbWFpbiBmcm9tIHJlcXVlc3RcbiAgICovXG4gIHByaXZhdGUgZXh0cmFjdERvbWFpbkZyb21SZXF1ZXN0KHJlcTogUmVxdWVzdCk6IHN0cmluZyB8IG51bGwge1xuICAgIC8vIFRyeSB0byBnZXQgZG9tYWluIGZyb20gdmFyaW91cyBzb3VyY2VzXG4gICAgY29uc3QgaG9zdCA9IHJlcS5nZXQoJ0hvc3QnKSB8fCByZXEuZ2V0KCdYLUZvcndhcmRlZC1Ib3N0JykgfHwgcmVxLmhvc3RuYW1lO1xuXG4gICAgaWYgKGhvc3QpIHtcbiAgICAgIC8vIFJlbW92ZSBwb3J0IGlmIHByZXNlbnRcbiAgICAgIHJldHVybiBob3N0LnNwbGl0KCc6JylbMF07XG4gICAgfVxuXG4gICAgLy8gVHJ5IHRvIGV4dHJhY3QgZnJvbSBVUkwgcGFyYW1ldGVyXG4gICAgaWYgKHJlcS5xdWVyeSAmJiB0eXBlb2YgcmVxLnF1ZXJ5LnVybCA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHJldHVybiBuZXcgVVJMKHJlcS5xdWVyeS51cmwpLmhvc3RuYW1lO1xuICAgICAgfSBjYXRjaCB7XG4gICAgICAgIC8vIEludmFsaWQgVVJMXG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gVHJ5IHRvIGV4dHJhY3QgZnJvbSBib2R5XG4gICAgaWYgKHJlcS5ib2R5ICYmIHR5cGVvZiByZXEuYm9keSA9PT0gJ29iamVjdCcpIHtcbiAgICAgIGNvbnN0IHVybCA9IHJlcS5ib2R5LnVybCB8fCByZXEuYm9keS5kb21haW4gfHwgcmVxLmJvZHkud2Vic2l0ZTtcbiAgICAgIGlmICh0eXBlb2YgdXJsID09PSAnc3RyaW5nJykge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIHJldHVybiBuZXcgVVJMKHVybCkuaG9zdG5hbWU7XG4gICAgICAgIH0gY2F0Y2gge1xuICAgICAgICAgIC8vIEludmFsaWQgVVJMLCBtaWdodCBiZSBqdXN0IGEgZG9tYWluXG4gICAgICAgICAgaWYgKHVybC5pbmNsdWRlcygnLicpKSB7XG4gICAgICAgICAgICByZXR1cm4gdXJsLnNwbGl0KCcvJylbMF07IC8vIFJlbW92ZSBwYXRoIGlmIGFueVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgLyoqXG4gICAqIEV4dHJhY3QgVVJMIGZyb20gcmVxdWVzdFxuICAgKi9cbiAgcHJpdmF0ZSBleHRyYWN0VVJMRnJvbVJlcXVlc3QocmVxOiBSZXF1ZXN0KTogc3RyaW5nIHwgbnVsbCB7XG4gICAgLy8gVHJ5IHRvIGdldCBVUkwgZnJvbSB2YXJpb3VzIHNvdXJjZXNcbiAgICBpZiAocmVxLnF1ZXJ5ICYmIHR5cGVvZiByZXEucXVlcnkudXJsID09PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuIHJlcS5xdWVyeS51cmw7XG4gICAgfVxuXG4gICAgaWYgKHJlcS5ib2R5ICYmIHR5cGVvZiByZXEuYm9keSA9PT0gJ29iamVjdCcpIHtcbiAgICAgIGNvbnN0IHVybCA9IHJlcS5ib2R5LnVybCB8fCByZXEuYm9keS5saW5rIHx8IHJlcS5ib2R5LnJlZGlyZWN0O1xuICAgICAgaWYgKHR5cGVvZiB1cmwgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIHJldHVybiB1cmw7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gVHJ5IFJlZmVyZXIgaGVhZGVyXG4gICAgY29uc3QgcmVmZXJlciA9IHJlcS5nZXQoJ1JlZmVyZXInKTtcbiAgICBpZiAocmVmZXJlcikge1xuICAgICAgcmV0dXJuIHJlZmVyZXI7XG4gICAgfVxuXG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICAvKipcbiAgICogRXh0cmFjdCBoYXNoIGZyb20gcmVxdWVzdFxuICAgKi9cbiAgcHJpdmF0ZSBleHRyYWN0SGFzaEZyb21SZXF1ZXN0KHJlcTogUmVxdWVzdCk6IHN0cmluZyB8IG51bGwge1xuICAgIC8vIFRyeSB0byBnZXQgaGFzaCBmcm9tIHZhcmlvdXMgc291cmNlc1xuICAgIGlmIChyZXEucXVlcnkgJiYgdHlwZW9mIHJlcS5xdWVyeS5oYXNoID09PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuIHJlcS5xdWVyeS5oYXNoO1xuICAgIH1cblxuICAgIGlmIChyZXEuYm9keSAmJiB0eXBlb2YgcmVxLmJvZHkgPT09ICdvYmplY3QnKSB7XG4gICAgICBjb25zdCBoYXNoID0gcmVxLmJvZHkuaGFzaCB8fCByZXEuYm9keS5maWxlSGFzaCB8fCByZXEuYm9keS5jaGVja3N1bTtcbiAgICAgIGlmICh0eXBlb2YgaGFzaCA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgcmV0dXJuIGhhc2g7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gVHJ5IGZyb20gZmlsZSB1cGxvYWRcbiAgICBpZiAoKHJlcSBhcyBhbnkpLmZpbGUgJiYgKHJlcSBhcyBhbnkpLmZpbGUuZmlsZW5hbWUpIHtcbiAgICAgIC8vIEluIGEgcmVhbCBpbXBsZW1lbnRhdGlvbiwgeW91IHdvdWxkIGNhbGN1bGF0ZSB0aGUgZmlsZSBoYXNoXG4gICAgICAvLyBGb3Igbm93LCByZXR1cm4gbnVsbFxuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHNjb3JlIGZyb20gc2V2ZXJpdHlcbiAgICovXG4gIHByaXZhdGUgZ2V0U2NvcmVGcm9tU2V2ZXJpdHkoc2V2ZXJpdHk6IHN0cmluZyk6IG51bWJlciB7XG4gICAgc3dpdGNoIChzZXZlcml0eSkge1xuICAgICAgY2FzZSAnY3JpdGljYWwnOlxuICAgICAgICByZXR1cm4gMTA7XG4gICAgICBjYXNlICdoaWdoJzpcbiAgICAgICAgcmV0dXJuIDc7XG4gICAgICBjYXNlICdtZWRpdW0nOlxuICAgICAgICByZXR1cm4gNDtcbiAgICAgIGNhc2UgJ2xvdyc6XG4gICAgICAgIHJldHVybiAxO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIDA7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aHJlYXQgaW50ZWxsaWdlbmNlIHN0YXRpc3RpY3NcbiAgICovXG4gIHB1YmxpYyBnZXRTdGF0cyA9IGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgc3RhdHMgPSBhd2FpdCB0aGlzLnRocmVhdFNlcnZpY2UuZ2V0U3RhdHMoKTtcblxuICAgICAgcmVzLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBkYXRhOiBzdGF0cyxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGdldHRpbmcgdGhyZWF0IHN0YXRzOicsIGVycm9yKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOiAnRmFpbGVkIHRvIGdldCB0aHJlYXQgaW50ZWxsaWdlbmNlIHN0YXRpc3RpY3MnLFxuICAgICAgfSk7XG4gICAgfVxuICB9O1xuXG4gIC8qKlxuICAgKiBHZXQgcmVjZW50IHRocmVhdCBhbGVydHNcbiAgICovXG4gIHB1YmxpYyBnZXRSZWNlbnRBbGVydHMgPSBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGxpbWl0ID0gcGFyc2VJbnQocmVxLnF1ZXJ5LmxpbWl0IGFzIHN0cmluZykgfHwgMTAwO1xuICAgICAgY29uc3QgYWxlcnRzID0gYXdhaXQgdGhpcy50aHJlYXRTZXJ2aWNlLmdldFJlY2VudEFsZXJ0cyhsaW1pdCk7XG5cbiAgICAgIHJlcy5qc29uKHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGF0YTogYWxlcnRzLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignRXJyb3IgZ2V0dGluZyByZWNlbnQgYWxlcnRzOicsIGVycm9yKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOiAnRmFpbGVkIHRvIGdldCByZWNlbnQgdGhyZWF0IGFsZXJ0cycsXG4gICAgICB9KTtcbiAgICB9XG4gIH07XG5cbiAgLyoqXG4gICAqIEFkZCBjdXN0b20gdGhyZWF0IGluZGljYXRvclxuICAgKi9cbiAgcHVibGljIGFkZEN1c3RvbUluZGljYXRvciA9IGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgaW5kaWNhdG9yID0gcmVxLmJvZHk7XG5cbiAgICAgIGlmICghaW5kaWNhdG9yLnR5cGUgfHwgIWluZGljYXRvci52YWx1ZSB8fCAhaW5kaWNhdG9yLnNvdXJjZSkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIGVycm9yOiAndHlwZSwgdmFsdWUsIGFuZCBzb3VyY2UgYXJlIHJlcXVpcmVkJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHN1Y2Nlc3MgPSBhd2FpdCB0aGlzLnRocmVhdFNlcnZpY2UuYWRkQ3VzdG9tSW5kaWNhdG9yKGluZGljYXRvcik7XG5cbiAgICAgIHJlcy5qc29uKHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGF0YTogeyBhZGRlZDogc3VjY2VzcyB9LFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignRXJyb3IgYWRkaW5nIGN1c3RvbSBpbmRpY2F0b3I6JywgZXJyb3IpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6ICdGYWlsZWQgdG8gYWRkIGN1c3RvbSB0aHJlYXQgaW5kaWNhdG9yJyxcbiAgICAgIH0pO1xuICAgIH1cbiAgfTtcblxuICAvKipcbiAgICogR2V0IHRocmVhdCBmZWVkc1xuICAgKi9cbiAgcHVibGljIGdldEZlZWRzID0gKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBmZWVkcyA9IHRoaXMudGhyZWF0U2VydmljZS5nZXRGZWVkcygpO1xuXG4gICAgICByZXMuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIGRhdGE6IGZlZWRzLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignRXJyb3IgZ2V0dGluZyB0aHJlYXQgZmVlZHM6JywgZXJyb3IpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6ICdGYWlsZWQgdG8gZ2V0IHRocmVhdCBmZWVkcycsXG4gICAgICB9KTtcbiAgICB9XG4gIH07XG5cbiAgLyoqXG4gICAqIFRvZ2dsZSB0aHJlYXQgZmVlZFxuICAgKi9cbiAgcHVibGljIHRvZ2dsZUZlZWQgPSBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgZmVlZE5hbWUsIGVuYWJsZWQgfSA9IHJlcS5ib2R5O1xuXG4gICAgICBpZiAoIWZlZWROYW1lIHx8IHR5cGVvZiBlbmFibGVkICE9PSAnYm9vbGVhbicpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBlcnJvcjogJ2ZlZWROYW1lIGFuZCBlbmFibGVkIGFyZSByZXF1aXJlZCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBzdWNjZXNzID0gYXdhaXQgdGhpcy50aHJlYXRTZXJ2aWNlLnRvZ2dsZUZlZWQoZmVlZE5hbWUsIGVuYWJsZWQpO1xuXG4gICAgICByZXMuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIGRhdGE6IHsgdG9nZ2xlZDogc3VjY2VzcyB9LFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignRXJyb3IgdG9nZ2xpbmcgZmVlZDonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjogJ0ZhaWxlZCB0byB0b2dnbGUgdGhyZWF0IGZlZWQnLFxuICAgICAgfSk7XG4gICAgfVxuICB9O1xufVxuXG4vLyBFeHBvcnQgc2luZ2xldG9uIGluc3RhbmNlXG5leHBvcnQgY29uc3QgdGhyZWF0SW50ZWxsaWdlbmNlTWlkZGxld2FyZSA9IG5ldyBUaHJlYXRJbnRlbGxpZ2VuY2VNaWRkbGV3YXJlKCk7XG5cbi8vIEV4cG9ydCBjb252ZW5pZW5jZSBtZXRob2RzXG5leHBvcnQgY29uc3QgY2hlY2tJUFRocmVhdCA9IHRocmVhdEludGVsbGlnZW5jZU1pZGRsZXdhcmUuY2hlY2tJUFRocmVhdDtcbmV4cG9ydCBjb25zdCBjaGVja0RvbWFpblRocmVhdCA9IHRocmVhdEludGVsbGlnZW5jZU1pZGRsZXdhcmUuY2hlY2tEb21haW5UaHJlYXQ7XG5leHBvcnQgY29uc3QgY2hlY2tVUkxUaHJlYXQgPSB0aHJlYXRJbnRlbGxpZ2VuY2VNaWRkbGV3YXJlLmNoZWNrVVJMVGhyZWF0O1xuZXhwb3J0IGNvbnN0IGNoZWNrSGFzaFRocmVhdCA9IHRocmVhdEludGVsbGlnZW5jZU1pZGRsZXdhcmUuY2hlY2tIYXNoVGhyZWF0O1xuZXhwb3J0IGNvbnN0IGNvbXByZWhlbnNpdmVUaHJlYXRDaGVjayA9IHRocmVhdEludGVsbGlnZW5jZU1pZGRsZXdhcmUuY29tcHJlaGVuc2l2ZVRocmVhdENoZWNrO1xuIl0sInZlcnNpb24iOjN9