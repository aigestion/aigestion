{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\rag.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\services\\rag.service.ts"],"sourcesContent":["import axios from 'axios';\nimport { exec } from 'child_process';\nimport fs from 'fs/promises';\nimport path from 'path';\nimport { promisify } from 'util';\nimport { injectable, inject } from 'inversify';\n\nconst execAsync = promisify(exec);\n\nimport { logger } from '../utils/logger';\nimport { pineconeService } from './pinecone.service';\nimport { supabaseService } from './supabase.service';\nimport { TYPES } from '../types';\nimport { SovereignVaultService } from './SovereignVaultService';\n\ninterface FileContext {\n  path: string;\n  content: string;\n  size: number;\n}\n\n// Basic simulation of TF-IDF / BM25 components\ninterface SearchResult {\n  file: FileContext;\n  score: number;\n  metadata: {\n    keywordScore: number;\n    semanticScore: number;\n    matches: string[];\n  };\n}\n\ninterface RagSearchResult {\n  query: string;\n  results: Array<{\n    content: string;\n    metadata: {\n      source: string;\n      filename: string;\n      type: string;\n      [key: string]: any;\n    };\n    distance?: number;\n  }>;\n}\n\n@injectable()\nexport class RagService {\n  private readonly rootDir: string;\n  private readonly maxContextSize: number = 100000; // ~25k tokens (safe limit)\n  private readonly cacheTTL = 5 * 60 * 1000; // 5 minutes\n  private cache: { data: string; timestamp: number } | null = null;\n  private fileCache: { files: FileContext[]; timestamp: number } | null = null;\n\n  private readonly ignoredDirs = new Set([\n    'node_modules',\n    'dist',\n    'build',\n    '.git',\n    '.turbo',\n    'coverage',\n    'logs',\n    '.trunk',\n    '.vscode',\n    '.idea',\n  ]);\n\n  private readonly ignoredExtensions = new Set([\n    '.lock',\n    '.png',\n    '.jpg',\n    '.jpeg',\n    '.gif',\n    '.svg',\n    '.ico',\n    '.pdf',\n    '.zip',\n    '.map',\n    '.mp4',\n    '.mp3',\n  ]);\n\n  constructor(@inject(TYPES.SovereignVaultService) private readonly vault: SovereignVaultService) {\n    this.rootDir = path.resolve(__dirname, '../../../');\n  }\n\n  /**\n   * Scans the codebase and returns a formatted string of the context.\n   * Uses in-memory caching and prepends an ASCII tree of the project structure.\n   * If query is provided, performs a Hybrid Search simulation to prioritize relevant files.\n   * ALSO queries the Sovereign Vault service for documentation context.\n   */\n  async getProjectContext(query?: string): Promise<string> {\n    try {\n      logger.info(`[RagService] Getting context${query ? ` for query: \"${query}\"` : ' (full)'}...`);\n\n      let context = '';\n\n      // 1. Run File Scan and Database Query in parallel\n      const [files, vaultResults] = await Promise.all([\n        this.getAllFiles(),\n        query && query.trim().length > 0 ? this.vault.query(query) : Promise.resolve(null),\n      ]);\n\n      // 2. Generate ASCII Tree (always useful for structure)\n      const filePaths = files.map(f => f.path);\n      const asciiTree = this.generateAsciiTree(filePaths);\n\n      context += `Project Structure:\\n${asciiTree}\\n\\n`;\n\n      let sortedFiles = files;\n\n      // [GOD MODE] Use Rust-powered rag-core if query is provided\n      if (query && query.trim().length > 0) {\n        context += `[Code Context optimized for query: \"${query}\"]\\n\\n`;\n\n        try {\n          const rustResults = await this.queryRustCore(query);\n          if (rustResults && rustResults.length > 0) {\n            logger.info(\n              `[RagService] Rust RagCore provided ${rustResults.length} optimized results.`,\n            );\n            sortedFiles = rustResults;\n          } else {\n            sortedFiles = this.rankFiles(files, query!);\n          }\n        } catch (err) {\n          logger.warn(`[RagService] Rust RagCore failed, falling back to JS ranking: ${err}`);\n          sortedFiles = this.rankFiles(files, query!);\n        }\n\n        // Append Sovereign Vault Context (Unified Memory)\n        if (vaultResults && vaultResults.length > 0) {\n          context += `[Sovereign Vault - Unified Memory Banks]\\n`;\n          vaultResults.forEach((res, i) => {\n            context += `--- Memory Item ${i + 1} [Source: ${res.source.toUpperCase()}] ---\\n${\n              res.content\n            }\\n\\n`;\n          });\n        }\n\n        const localContext = await this.queryLocalMemory(query!);\n        if (localContext) {\n          context += `[Local Neural Memory (NeuroCore)]\\n${localContext}\\n\\n`;\n        }\n      } else {\n        context += `[Full Context - No Query Provided]\\n\\n`;\n        // Default sort by path if no query to maintain stability\n        sortedFiles.sort((a, b) => a.path.localeCompare(b.path));\n      }\n\n      context += `Here is the codebase context:\\n\\n`;\n      let currentSize = context.length;\n\n      // 4. Context Stuffing with Limit\n      let includedCount = 0;\n      for (const file of sortedFiles) {\n        const fileBlock = `<file path=\"${file.path}\">\\n${file.content}\\n</file>\\n\\n`;\n\n        if (currentSize + fileBlock.length > this.maxContextSize) {\n          context += `\\n<!-- Context truncated due to size limit (${this.maxContextSize} chars). Included ${includedCount} of ${sortedFiles.length} files. -->`;\n          break;\n        }\n\n        context += fileBlock;\n        currentSize += fileBlock.length;\n        includedCount++;\n      }\n\n      return context;\n    } catch (error) {\n      logger.error(error, 'Error in RagService:');\n      return ''; // Fail gracefully\n    }\n  }\n\n  /**\n   * Public interface to query the knowledge base (Vector DB documentation).\n   * Migrated to SovereignVaultService for unified discovery.\n   */\n  async queryKnowledgeBase(query: string): Promise<string | null> {\n    const results = await this.vault.query(query);\n\n    if (!results || results.length === 0) return null;\n\n    return results\n      .map(\n        (res, i) =>\n          `[Source: ${res.source.toUpperCase()} | Score: ${res.score.toFixed(2)}]\\n${res.content}`,\n      )\n      .join('\\n\\n');\n  }\n\n  /**\n   * Ingests a new document into the Sovereign Vault.\n   */\n  async ingestDocument(filename: string, content: string, tags: string[] = []): Promise<void> {\n    logger.info(`[RagService] Forwarding ingestion to SovereignVault: ${filename}`);\n    await this.vault.ingest(filename, content, tags);\n  }\n\n  /**\n   * Specifically archives data to the local NeuroCore ML service.\n   */\n  private async archiveToLocalMemory(\n    content: string,\n    filename: string,\n    tags: string[] = [],\n  ): Promise<void> {\n    try {\n      const mlServiceUrl = process.env.ML_SERVICE_URL || 'http://ml-service:5000';\n      await axios.post(`${mlServiceUrl}/archive`, {\n        content,\n        source: filename,\n        tags,\n      });\n      logger.info(`[RagService] Document archived to local NeuroCore: ${filename}`);\n    } catch (error: any) {\n      logger.warn(`[RagService] Failed to archive to local NeuroCore: ${error.message}`);\n    }\n  }\n\n  /**\n   * Queries the local NeuroCore ML service for neural embeddings search.\n   */\n  private async queryLocalMemory(query: string): Promise<string | null> {\n    try {\n      const mlServiceUrl = process.env.ML_SERVICE_URL || 'http://ml-service:5000';\n      const response = await axios.post(`${mlServiceUrl}/recall`, { query, limit: 3 });\n\n      const results = response.data.results;\n      if (results && results.length > 0) {\n        return results\n          .map(\n            (res: any, i: number) =>\n              `[Local Match ${i + 1}] Source: ${res.metadata.source}\\n${res.content}`,\n          )\n          .join('\\n\\n');\n      }\n      return null;\n    } catch (error: any) {\n      logger.warn(`[RagService] Failed to query local NeuroCore: ${error.message}`);\n      return null;\n    }\n  }\n\n  /**\n   * Queries the direct Pinecone Vector DB for relevant documentation.\n   */\n  private async queryVectorDb(query: string): Promise<string | null> {\n    try {\n      logger.info(`[RagService] Querying Pinecone Vector DB for: \"${query}\"`);\n\n      const results = await pineconeService.search(query, 3);\n\n      if (results && results.length > 0) {\n        let docStr = '';\n        results.forEach((res, index) => {\n          const filename = res.metadata?.filename || 'unknown';\n          const content = res.metadata?.text || '';\n          docStr += `--- Document ${index + 1} (${filename}) ---\\n${content}\\n\\n`;\n        });\n        return docStr.trim();\n      }\n      return null;\n    } catch (error: any) {\n      // Log but don't crash\n      logger.warn(`[RagService] Failed to query Pinecone Vector DB: ${error.message}`);\n      return `<!-- Failed to retrieve documentation context from Pinecone: ${error.message} -->`;\n    }\n  }\n\n  private async getAllFiles(): Promise<FileContext[]> {\n    if (this.fileCache && Date.now() - this.fileCache.timestamp < this.cacheTTL) {\n      return this.fileCache.files;\n    }\n\n    const files = await this.scanDirectory(this.rootDir);\n    this.fileCache = {\n      files,\n      timestamp: Date.now(),\n    };\n    return files;\n  }\n\n  /**\n   * Ranks files using a simulated Hybrid Search (Keyword + Structural).\n   * Calculates a simple score based on:\n   * 1. Path/Filename match (Structural/Semantic proxy)\n   * 2. Content keyword frequency (TF proxy)\n   */\n  private rankFiles(files: FileContext[], query: string): FileContext[] {\n    const terms = query\n      .toLowerCase()\n      .split(/\\s+/)\n      .filter(t => t.length > 2);\n    if (terms.length === 0) return files;\n\n    const results: SearchResult[] = files.map(file => {\n      let keywordScore = 0;\n      let semanticScore = 0;\n      const matches: string[] = [];\n      const contentLower = file.content.toLowerCase();\n      const pathLower = file.path.toLowerCase();\n\n      terms.forEach(term => {\n        // Structural Score: Filename matches are high signal\n        if (pathLower.includes(term)) {\n          semanticScore += 10;\n          matches.push(`path:${term}`);\n        }\n\n        // Keyword Score: Simple frequency count in content\n        const regex = new RegExp(this.escapeRegExp(term), 'g');\n        const count = (contentLower.match(regex) || []).length;\n        if (count > 0) {\n          keywordScore += count;\n        }\n      });\n\n      const finalKeywordScore = keywordScore > 0 ? Math.log(1 + keywordScore) : 0;\n      const totalScore = semanticScore * 2 + finalKeywordScore;\n\n      return {\n        file,\n        score: totalScore,\n        metadata: { keywordScore: finalKeywordScore, semanticScore, matches },\n      };\n    });\n\n    const relevantFiles = results\n      .filter(r => r.score > 0)\n      .sort((a, b) => b.score - a.score)\n      .map(r => r.file);\n\n    const otherFiles = files.filter(f => !relevantFiles.includes(f));\n    return [...relevantFiles, ...otherFiles];\n  }\n\n  private escapeRegExp(string: string) {\n    return string.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n  }\n\n  private async scanDirectory(dir: string): Promise<FileContext[]> {\n    let results: FileContext[] = [];\n\n    try {\n      const entries = await fs.readdir(dir, { withFileTypes: true });\n\n      for (const entry of entries) {\n        const fullPath = path.join(dir, entry.name);\n        const relativePath = path.relative(this.rootDir, fullPath);\n\n        if (entry.isDirectory()) {\n          if (!this.ignoredDirs.has(entry.name)) {\n            const subResults = await this.scanDirectory(fullPath);\n            results = results.concat(subResults);\n          }\n        } else if (entry.isFile()) {\n          const ext = path.extname(entry.name).toLowerCase();\n          if (!this.ignoredExtensions.has(ext)) {\n            try {\n              const content = await fs.readFile(fullPath, 'utf-8');\n              results.push({\n                path: relativePath,\n                content: content,\n                size: content.length,\n              });\n            } catch (err: any) {\n              logger.warn(`Could not read file ${fullPath}: ${err.message}`);\n            }\n          }\n        }\n      }\n    } catch (error) {\n      logger.error(error, `Failed to scan dir ${dir}:`);\n    }\n\n    return results;\n  }\n\n  /**\n   * Generates a simple ASCII tree from a list of relative file paths.\n   */\n  private generateAsciiTree(paths: string[]): string {\n    const tree: any = {};\n    for (const p of paths) {\n      const parts = p.split(path.sep);\n      let current = tree;\n      for (const part of parts) {\n        current[part] = current[part] || {};\n        current = current[part];\n      }\n    }\n\n    return this.printTree(tree);\n  }\n\n  private printTree(node: any, prefix = ''): string {\n    const keys = Object.keys(node).sort();\n    let result = '';\n\n    for (let i = 0; i < keys.length; i++) {\n      const key = keys[i];\n      const isLast = i === keys.length - 1;\n      const connector = isLast ? '└── ' : '├── ';\n\n      result += `${prefix}${connector}${key}\\n`;\n\n      const children = node[key];\n      if (Object.keys(children).length > 0) {\n        const childPrefix = prefix + (isLast ? '    ' : '│   ');\n        result += this.printTree(children, childPrefix);\n      }\n    }\n    return result;\n  }\n\n  /**\n   * [GOD MODE] Invokes the Rust RagCore binary for extreme performance.\n   */\n  private async queryRustCore(query: string): Promise<FileContext[]> {\n    const binPath = path.resolve(__dirname, '../../rag-core/target/release/rag-core.exe');\n    const rootPath = this.rootDir;\n\n    const cmd = `\"${binPath}\" --root \"${rootPath}\" --query \"${query}\" --limit 25`;\n    const { stdout } = await execAsync(cmd, { maxBuffer: 10 * 1024 * 1024 });\n    const results = JSON.parse(stdout);\n\n    return results.map((res: any) => ({\n      path: res.path,\n      content: res.content,\n      size: res.content.length,\n    }));\n  }\n\n  /**\n   * Queries the sovereign Supabase Hybrid Search knowledge base.\n   */\n  private async querySupabaseKnowledge(query: string): Promise<string | null> {\n    try {\n      logger.info(`[RagService] Querying Supabase Sovereign DB for: \"${query}\"`);\n\n      // Mock embedding (768d) - In production you would use gemini or openai here\n      const mockEmbedding = new Array(768).fill(0).map(() => Math.random());\n\n      const results = await supabaseService.hybridSearch(\n        undefined, // All projects\n        query,\n        mockEmbedding,\n        0.3,\n        3,\n      );\n\n      if (results && results.length > 0) {\n        return results\n          .map(\n            (res: any, i: number) =>\n              `[Sovereign Match ${i + 1}] Title: ${res.title}\\n${res.content}`,\n          )\n          .join('\\n\\n');\n      }\n      return null;\n    } catch (error: any) {\n      logger.warn(`[RagService] Failed to query Supabase Sovereign DB: ${error.message}`);\n      return null;\n    }\n  }\n}\n\n// REMOVED manual instantiation to break circular dependency and support constructor injection via Inversify\n// export const ragService = new RagService();\n"],"version":3}