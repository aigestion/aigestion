0a398e5584b41a017ffd56aa572bd0b7
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.PayPalService = void 0;
const inversify_1 = require("inversify");
const axios_1 = __importDefault(require("axios"));
const env_schema_1 = require("../config/env.schema");
const logger_1 = require("../utils/logger");
const CircuitBreakerFactory_1 = require("../infrastructure/resilience/CircuitBreakerFactory");
let PayPalService = class PayPalService {
    baseUrl;
    clientId;
    clientSecret;
    accessToken = null;
    tokenExpiry = 0;
    // Circuit Breakers
    createOrderBreaker;
    captureOrderBreaker;
    constructor() {
        this.baseUrl =
            env_schema_1.env.PAYPAL_MODE === 'live' ? 'https://api-m.paypal.com' : 'https://api-m.sandbox.paypal.com';
        this.clientId = env_schema_1.env.PAYPAL_CLIENT_ID || '';
        this.clientSecret = env_schema_1.env.PAYPAL_CLIENT_SECRET || '';
        if (!this.clientId || !this.clientSecret) {
            logger_1.logger.warn('PayPal credentials missing. PayPalService will not function.');
        }
        // Initialize Circuit Breakers
        this.createOrderBreaker = CircuitBreakerFactory_1.CircuitBreakerFactory.create((amount, currency) => this.createOrderInternal(amount, currency), { name: 'PayPal.createOrder' });
        this.captureOrderBreaker = CircuitBreakerFactory_1.CircuitBreakerFactory.create((orderId) => this.captureOrderInternal(orderId), { name: 'PayPal.captureOrder' });
    }
    async getAccessToken() {
        if (this.accessToken && Date.now() < this.tokenExpiry) {
            return this.accessToken;
        }
        const auth = Buffer.from(`${this.clientId}:${this.clientSecret}`).toString('base64');
        try {
            const response = await axios_1.default.post(`${this.baseUrl}/v1/oauth2/token`, 'grant_type=client_credentials', {
                headers: {
                    Authorization: `Basic ${auth}`,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
            });
            this.accessToken = response.data.access_token;
            this.tokenExpiry = Date.now() + response.data.expires_in * 1000 - 60000; // Buffer 1 min
            return this.accessToken;
        }
        catch (error) {
            logger_1.logger.error(error, 'Failed to get PayPal access token');
            throw new Error('PayPal authentication failed');
        }
    }
    async createOrder(amount, currency = 'USD') {
        return this.createOrderBreaker.fire(amount, currency);
    }
    async createOrderInternal(amount, currency) {
        const token = await this.getAccessToken();
        try {
            const response = await axios_1.default.post(`${this.baseUrl}/v2/checkout/orders`, {
                intent: 'CAPTURE',
                purchase_units: [
                    {
                        amount: {
                            currency_code: currency,
                            value: amount,
                        },
                    },
                ],
            }, {
                headers: {
                    Authorization: `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
            });
            return response.data;
        }
        catch (error) {
            logger_1.logger.error(error, 'PayPal create order failed');
            throw error;
        }
    }
    async captureOrder(orderId) {
        return this.captureOrderBreaker.fire(orderId);
    }
    async captureOrderInternal(orderId) {
        const token = await this.getAccessToken();
        try {
            const response = await axios_1.default.post(`${this.baseUrl}/v2/checkout/orders/${orderId}/capture`, {}, {
                headers: {
                    Authorization: `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
            });
            return response.data;
        }
        catch (error) {
            logger_1.logger.error(error, 'PayPal capture order failed');
            throw error;
        }
    }
};
exports.PayPalService = PayPalService;
exports.PayPalService = PayPalService = __decorate([
    (0, inversify_1.injectable)(),
    __metadata("design:paramtypes", [])
], PayPalService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxzZXJ2aWNlc1xccGF5cGFsLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7O0FBQUEseUNBQXVDO0FBQ3ZDLGtEQUEwQjtBQUMxQixxREFBMkM7QUFDM0MsNENBQXlDO0FBQ3pDLDhGQUEyRjtBQWVwRixJQUFNLGFBQWEsR0FBbkIsTUFBTSxhQUFhO0lBQ2hCLE9BQU8sQ0FBUztJQUNoQixRQUFRLENBQVM7SUFDakIsWUFBWSxDQUFTO0lBQ3JCLFdBQVcsR0FBa0IsSUFBSSxDQUFDO0lBQ2xDLFdBQVcsR0FBVyxDQUFDLENBQUM7SUFFaEMsbUJBQW1CO0lBQ1gsa0JBQWtCLENBQU07SUFDeEIsbUJBQW1CLENBQU07SUFFakM7UUFDRSxJQUFJLENBQUMsT0FBTztZQUNWLGdCQUFHLENBQUMsV0FBVyxLQUFLLE1BQU0sQ0FBQyxDQUFDLENBQUMsMEJBQTBCLENBQUMsQ0FBQyxDQUFDLGtDQUFrQyxDQUFDO1FBRS9GLElBQUksQ0FBQyxRQUFRLEdBQUcsZ0JBQUcsQ0FBQyxnQkFBZ0IsSUFBSSxFQUFFLENBQUM7UUFDM0MsSUFBSSxDQUFDLFlBQVksR0FBRyxnQkFBRyxDQUFDLG9CQUFvQixJQUFJLEVBQUUsQ0FBQztRQUVuRCxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUN6QyxlQUFNLENBQUMsSUFBSSxDQUFDLDhEQUE4RCxDQUFDLENBQUM7UUFDOUUsQ0FBQztRQUVELDhCQUE4QjtRQUM5QixJQUFJLENBQUMsa0JBQWtCLEdBQUcsNkNBQXFCLENBQUMsTUFBTSxDQUNwRCxDQUFDLE1BQWMsRUFBRSxRQUFnQixFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsTUFBTSxFQUFFLFFBQVEsQ0FBQyxFQUNoRixFQUFFLElBQUksRUFBRSxvQkFBb0IsRUFBRSxDQUMvQixDQUFDO1FBRUYsSUFBSSxDQUFD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S0FBSyxHQUFHLE1BQU0sSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBRTFDLElBQUksQ0FBQztZQUNILE1BQU0sUUFBUSxHQUFHLE1BQU0sZUFBSyxDQUFDLElBQUksQ0FDL0IsR0FBRyxJQUFJLENBQUMsT0FBTyx1QkFBdUIsT0FBTyxVQUFVLEVBQ3ZELEVBQUUsRUFDRjtnQkFDRSxPQUFPLEVBQUU7b0JBQ1AsYUFBYSxFQUFFLFVBQVUsS0FBSyxFQUFFO29CQUNoQyxjQUFjLEVBQUUsa0JBQWtCO2lCQUNuQzthQUNGLENBQ0YsQ0FBQztZQUVGLE9BQU8sUUFBUSxDQUFDLElBQUksQ0FBQztRQUN2QixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLGVBQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLDZCQUE2QixDQUFDLENBQUM7WUFDbkQsTUFBTSxLQUFLLENBQUM7UUFDZCxDQUFDO0lBQ0gsQ0FBQztDQUNGLENBQUE7QUE5SFksc0NBQWE7d0JBQWIsYUFBYTtJQUR6QixJQUFBLHNCQUFVLEdBQUU7O0dBQ0EsYUFBYSxDQThIekIiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxzZXJ2aWNlc1xccGF5cGFsLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaW5qZWN0YWJsZSB9IGZyb20gJ2ludmVyc2lmeSc7XG5pbXBvcnQgYXhpb3MgZnJvbSAnYXhpb3MnO1xuaW1wb3J0IHsgZW52IH0gZnJvbSAnLi4vY29uZmlnL2Vudi5zY2hlbWEnO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi4vdXRpbHMvbG9nZ2VyJztcbmltcG9ydCB7IENpcmN1aXRCcmVha2VyRmFjdG9yeSB9IGZyb20gJy4uL2luZnJhc3RydWN0dXJlL3Jlc2lsaWVuY2UvQ2lyY3VpdEJyZWFrZXJGYWN0b3J5JztcblxuaW50ZXJmYWNlIENyZWF0ZU9yZGVyUmVzcG9uc2Uge1xuICBpZDogc3RyaW5nO1xuICBzdGF0dXM6IHN0cmluZztcbiAgbGlua3M6IEFycmF5PHsgaHJlZjogc3RyaW5nOyByZWw6IHN0cmluZzsgbWV0aG9kOiBzdHJpbmcgfT47XG59XG5cbmludGVyZmFjZSBDYXB0dXJlT3JkZXJSZXNwb25zZSB7XG4gIGlkOiBzdHJpbmc7XG4gIHN0YXR1czogc3RyaW5nO1xuICBwYXllcjogYW55O1xufVxuXG5AaW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgUGF5UGFsU2VydmljZSB7XG4gIHByaXZhdGUgYmFzZVVybDogc3RyaW5nO1xuICBwcml2YXRlIGNsaWVudElkOiBzdHJpbmc7XG4gIHByaXZhdGUgY2xpZW50U2VjcmV0OiBzdHJpbmc7XG4gIHByaXZhdGUgYWNjZXNzVG9rZW46IHN0cmluZyB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIHRva2VuRXhwaXJ5OiBudW1iZXIgPSAwO1xuXG4gIC8vIENpcmN1aXQgQnJlYWtlcnNcbiAgcHJpdmF0ZSBjcmVhdGVPcmRlckJyZWFrZXI6IGFueTtcbiAgcHJpdmF0ZSBjYXB0dXJlT3JkZXJCcmVha2VyOiBhbnk7XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5iYXNlVXJsID1cbiAgICAgIGVudi5QQVlQQUxfTU9ERSA9PT0gJ2xpdmUnID8gJ2h0dHBzOi8vYXBpLW0ucGF5cGFsLmNvbScgOiAnaHR0cHM6Ly9hcGktbS5zYW5kYm94LnBheXBhbC5jb20nO1xuXG4gICAgdGhpcy5jbGllbnRJZCA9IGVudi5QQVlQQUxfQ0xJRU5UX0lEIHx8ICcnO1xuICAgIHRoaXMuY2xpZW50U2VjcmV0ID0gZW52LlBBWVBBTF9DTElFTlRfU0VDUkVUIHx8ICcnO1xuXG4gICAgaWYgKCF0aGlzLmNsaWVudElkIHx8ICF0aGlzLmNsaWVudFNlY3JldCkge1xuICAgICAgbG9nZ2VyLndhcm4oJ1BheVBhbCBjcmVkZW50aWFscyBtaXNzaW5nLiBQYXlQYWxTZXJ2aWNlIHdpbGwgbm90IGZ1bmN0aW9uLicpO1xuICAgIH1cblxuICAgIC8vIEluaXRpYWxpemUgQ2lyY3VpdCBCcmVha2Vyc1xuICAgIHRoaXMuY3JlYXRlT3JkZXJCcmVha2VyID0gQ2lyY3VpdEJyZWFrZXJGYWN0b3J5LmNyZWF0ZShcbiAgICAgIChhbW91bnQ6IHN0cmluZywgY3VycmVuY3k6IHN0cmluZykgPT4gdGhpcy5jcmVhdGVPcmRlckludGVybmFsKGFtb3VudCwgY3VycmVuY3kpLFxuICAgICAgeyBuYW1lOiAnUGF5UGFsLmNyZWF0ZU9yZGVyJyB9LFxuICAgICk7XG5cbiAgICB0aGlzLmNhcHR1cmVPcmRlckJyZWFrZXIgPSBDaXJjdWl0QnJlYWtlckZhY3RvcnkuY3JlYXRlKFxuICAgICAgKG9yZGVySWQ6IHN0cmluZykgPT4gdGhpcy5jYXB0dXJlT3JkZXJJbnRlcm5hbChvcmRlcklkKSxcbiAgICAgIHsgbmFtZTogJ1BheVBhbC5jYXB0dXJlT3JkZXInIH0sXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZ2V0QWNjZXNzVG9rZW4oKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBpZiAodGhpcy5hY2Nlc3NUb2tlbiAmJiBEYXRlLm5vdygpIDwgdGhpcy50b2tlbkV4cGlyeSkge1xuICAgICAgcmV0dXJuIHRoaXMuYWNjZXNzVG9rZW47XG4gICAgfVxuXG4gICAgY29uc3QgYXV0aCA9IEJ1ZmZlci5mcm9tKGAke3RoaXMuY2xpZW50SWR9OiR7dGhpcy5jbGllbnRTZWNyZXR9YCkudG9TdHJpbmcoJ2Jhc2U2NCcpO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgYXhpb3MucG9zdChcbiAgICAgICAgYCR7dGhpcy5iYXNlVXJsfS92MS9vYXV0aDIvdG9rZW5gLFxuICAgICAgICAnZ3JhbnRfdHlwZT1jbGllbnRfY3JlZGVudGlhbHMnLFxuICAgICAgICB7XG4gICAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICAgQXV0aG9yaXphdGlvbjogYEJhc2ljICR7YXV0aH1gLFxuICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICApO1xuXG4gICAgICB0aGlzLmFjY2Vzc1Rva2VuID0gcmVzcG9uc2UuZGF0YS5hY2Nlc3NfdG9rZW47XG4gICAgICB0aGlzLnRva2VuRXhwaXJ5ID0gRGF0ZS5ub3coKSArIHJlc3BvbnNlLmRhdGEuZXhwaXJlc19pbiAqIDEwMDAgLSA2MDAwMDsgLy8gQnVmZmVyIDEgbWluXG4gICAgICByZXR1cm4gdGhpcy5hY2Nlc3NUb2tlbiE7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcihlcnJvciwgJ0ZhaWxlZCB0byBnZXQgUGF5UGFsIGFjY2VzcyB0b2tlbicpO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdQYXlQYWwgYXV0aGVudGljYXRpb24gZmFpbGVkJyk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgY3JlYXRlT3JkZXIoYW1vdW50OiBzdHJpbmcsIGN1cnJlbmN5OiBzdHJpbmcgPSAnVVNEJyk6IFByb21pc2U8Q3JlYXRlT3JkZXJSZXNwb25zZT4ge1xuICAgIHJldHVybiB0aGlzLmNyZWF0ZU9yZGVyQnJlYWtlci5maXJlKGFtb3VudCwgY3VycmVuY3kpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBjcmVhdGVPcmRlckludGVybmFsKFxuICAgIGFtb3VudDogc3RyaW5nLFxuICAgIGN1cnJlbmN5OiBzdHJpbmcsXG4gICk6IFByb21pc2U8Q3JlYXRlT3JkZXJSZXNwb25zZT4ge1xuICAgIGNvbnN0IHRva2VuID0gYXdhaXQgdGhpcy5nZXRBY2Nlc3NUb2tlbigpO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgYXhpb3MucG9zdChcbiAgICAgICAgYCR7dGhpcy5iYXNlVXJsfS92Mi9jaGVja291dC9vcmRlcnNgLFxuICAgICAgICB7XG4gICAgICAgICAgaW50ZW50OiAnQ0FQVFVSRScsXG4gICAgICAgICAgcHVyY2hhc2VfdW5pdHM6IFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgYW1vdW50OiB7XG4gICAgICAgICAgICAgICAgY3VycmVuY3lfY29kZTogY3VycmVuY3ksXG4gICAgICAgICAgICAgICAgdmFsdWU6IGFtb3VudCxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgXSxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgIEF1dGhvcml6YXRpb246IGBCZWFyZXIgJHt0b2tlbn1gLFxuICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgKTtcblxuICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcihlcnJvciwgJ1BheVBhbCBjcmVhdGUgb3JkZXIgZmFpbGVkJyk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICBhc3luYyBjYXB0dXJlT3JkZXIob3JkZXJJZDogc3RyaW5nKTogUHJvbWlzZTxDYXB0dXJlT3JkZXJSZXNwb25zZT4ge1xuICAgIHJldHVybiB0aGlzLmNhcHR1cmVPcmRlckJyZWFrZXIuZmlyZShvcmRlcklkKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgY2FwdHVyZU9yZGVySW50ZXJuYWwob3JkZXJJZDogc3RyaW5nKTogUHJvbWlzZTxDYXB0dXJlT3JkZXJSZXNwb25zZT4ge1xuICAgIGNvbnN0IHRva2VuID0gYXdhaXQgdGhpcy5nZXRBY2Nlc3NUb2tlbigpO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgYXhpb3MucG9zdChcbiAgICAgICAgYCR7dGhpcy5iYXNlVXJsfS92Mi9jaGVja291dC9vcmRlcnMvJHtvcmRlcklkfS9jYXB0dXJlYCxcbiAgICAgICAge30sXG4gICAgICAgIHtcbiAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dG9rZW59YCxcbiAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICk7XG5cbiAgICAgIHJldHVybiByZXNwb25zZS5kYXRhO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoZXJyb3IsICdQYXlQYWwgY2FwdHVyZSBvcmRlciBmYWlsZWQnKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxufVxuIl0sInZlcnNpb24iOjN9