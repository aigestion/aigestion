{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\__tests__\\services\\SwarmProcessor.test.ts","mappings":"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","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\__tests__\\services\\SwarmProcessor.test.ts"],"sourcesContent":["import 'reflect-metadata';\nimport { SwarmProcessor } from '../../infrastructure/jobs/SwarmProcessor';\nimport { Job } from 'bullmq';\nimport { container } from '../../config/inversify.config';\nimport { TYPES } from '../../types';\nimport { MissionStatus } from '../../models/Mission';\n\n// Mock logger\njest.mock('../../utils/logger', () => ({\n  logger: {\n    info: jest.fn(),\n    error: jest.fn(),\n    warn: jest.fn(),\n  },\n}));\n\n// Mock secrets utility\njest.mock('../../utils/secrets', () => ({\n  deriveMissionKey: jest.fn().mockResolvedValue(Buffer.from('mock-key')),\n}));\n\nconst mockAIService = {\n  generateContent: jest.fn(),\n};\nconst mockMissionRepo = {\n  update: jest.fn(),\n};\nconst mockSocketService = {\n  emitMissionUpdate: jest.fn(),\n};\nconst mockNotificationService = {\n  createNotification: jest.fn(),\n};\nconst mockVaultService = {\n  encrypt: jest.fn().mockResolvedValue({ iv: 'iv', ciphertext: 'cipher', tag: 'tag' }),\n};\nconst mockSwarmClient = {\n  post: jest.fn(),\n};\nconst mockKGService = {\n  indexMissionFindings: jest.fn(),\n};\n\n// Mock container\njest.mock('../../config/inversify.config', () => ({\n  container: {\n    get: jest.fn(),\n  },\n}));\n\ndescribe('SwarmProcessor', () => {\n  let mockJob: Partial<Job>;\n\n  beforeEach(() => {\n    jest.clearAllMocks();\n\n    mockJob = {\n      id: 'job-123',\n      data: {\n        objective: 'Test Mission',\n        userId: 'user-1',\n        missionId: 'mission-1',\n        context: {},\n      },\n    };\n\n    (container.get as jest.Mock).mockImplementation(type => {\n      if (type === TYPES.AIService) return mockAIService;\n      if (type === TYPES.MissionRepository) return mockMissionRepo;\n      if (type === TYPES.SocketService) return mockSocketService;\n      if (type === TYPES.NotificationService) return mockNotificationService;\n      return {};\n    });\n  });\n\n  it('should execute mission lifecycle successfully', async () => {\n    // Setup mocks\n    mockAIService.generateContent\n      .mockResolvedValueOnce('Step 1: Plan') // Planning phase\n      .mockResolvedValueOnce('Mission Success Report'); // Final report phase\n\n    // Execute\n    await SwarmProcessor.process(mockJob as Job);\n\n    // Verify Planning Phase\n    expect(mockMissionRepo.update).toHaveBeenCalledWith('mission-1', {\n      status: MissionStatus.PLANNING,\n    });\n    expect(mockSocketService.emitMissionUpdate).toHaveBeenCalledWith('mission-1', {\n      status: MissionStatus.PLANNING,\n    });\n\n    // Verify AI Planning\n    expect(mockAIService.generateContent).toHaveBeenNthCalledWith(\n      1,\n      expect.stringContaining('Develop a concise step-by-step strategy'),\n      'user-1',\n    );\n\n    // Verify Executing Phase\n    expect(mockMissionRepo.update).toHaveBeenCalledWith('mission-1', {\n      plan: 'Step 1: Plan',\n      status: MissionStatus.EXECUTING,\n    });\n\n    // Verify Final Reporting\n    expect(mockAIService.generateContent).toHaveBeenNthCalledWith(\n      2,\n      expect.stringContaining('Generate a final summary'),\n      'user-1',\n    );\n\n    // Verify Completion\n    expect(mockMissionRepo.update).toHaveBeenCalledWith(\n      'mission-1',\n      expect.objectContaining({\n        result: 'Mission Success Report',\n        status: MissionStatus.COMPLETED,\n        completedAt: expect.any(Date),\n      }),\n    );\n\n    // Verify Notification — uses positional args:\n    // createNotification(userId, type, title, message, metadata)\n    expect(mockNotificationService.createNotification).toHaveBeenCalledWith(\n      'user-1',\n      expect.anything(), // NotificationType.MISSION_COMPLETED enum value\n      expect.any(String), // title\n      expect.stringContaining('Test Mission'), // message\n      expect.objectContaining({ missionId: 'mission-1' }), // metadata\n    );\n  });\n\n  it('should handle failures and update status to FAILED', async () => {\n    const error = new Error('AI Service Down');\n    mockAIService.generateContent.mockRejectedValue(error);\n\n    await expect(SwarmProcessor.process(mockJob as Job)).rejects.toThrow('AI Service Down');\n\n    // Verify Failure Update\n    expect(mockMissionRepo.update).toHaveBeenCalledWith(\n      'mission-1',\n      expect.objectContaining({\n        status: MissionStatus.FAILED,\n        error: 'AI Service Down',\n        completedAt: expect.any(Date),\n      }),\n    );\n\n    // Verify Socket Error Emit\n    expect(mockSocketService.emitMissionUpdate).toHaveBeenCalledWith(\n      'mission-1',\n      expect.objectContaining({\n        status: MissionStatus.FAILED,\n        error: 'AI Service Down',\n      }),\n    );\n\n    // Verify Failure Notification — uses positional args:\n    // createNotification(userId, type, title, message, metadata)\n    expect(mockNotificationService.createNotification).toHaveBeenCalledWith(\n      'user-1',\n      expect.anything(), // NotificationType.MISSION_FAILED enum value\n      expect.any(String), // title\n      expect.stringContaining('AI Service Down'), // message\n      expect.objectContaining({ missionId: 'mission-1' }), // metadata\n    );\n  });\n\n  it('should log error when updating failure status fails', async () => {\n    const primaryError = new Error('AI Service Down');\n    const secondaryError = new Error('DB Update Failed');\n\n    mockAIService.generateContent.mockRejectedValue(primaryError);\n    // First update (planning) succeeds (or we can make AI fail immediately so 1st update is skipped?)\n    // The code does:\n    // 1. MissionRepo.update(PLANNING)\n    // 2. AI Service...\n\n    // If AI Service fails, it goes to catch block.\n    // inside catch: MissionRepo.update(FAILED)\n\n    // So we want MissionRepo.update to fail ONLY when called with FAILED status, or just generally fail to simulate the catch-catch block.\n    // It's easier if we make it fail on the second call?\n    // Actually, let's just make it throw when called with user-1 or something?\n    // Or using mockImplementation to throw if status is FAILED.\n\n    mockMissionRepo.update.mockImplementation((id, data) => {\n      if (data.status === MissionStatus.FAILED) {\n        return Promise.reject(secondaryError);\n      }\n      return Promise.resolve();\n    });\n\n    // We expect the PRIMARY error to be thrown, not the secondary one.\n    await expect(SwarmProcessor.process(mockJob as Job)).rejects.toThrow('AI Service Down');\n\n    // And we expect the secondary error to be logged\n    // We need to import logger to verify this?\n    // Or we can rely on console?\n    // We mocked logger, let's verify it.\n    // We need access to the mocked logger instance.\n    // Since we didn't save the mocked logger instance in a variable outside, we can import it.\n    const { logger } = require('../../utils/logger');\n    expect(logger.error).toHaveBeenCalledWith(\n      expect.stringContaining('Failed to update mission failure status'),\n      secondaryError,\n    );\n  });\n});\n"],"version":3}