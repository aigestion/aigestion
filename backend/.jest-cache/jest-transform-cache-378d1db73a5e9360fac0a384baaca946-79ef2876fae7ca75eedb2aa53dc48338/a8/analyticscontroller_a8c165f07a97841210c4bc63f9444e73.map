{"file":"C:\\Users\\Alejandro\\AIGestion\\backend\\src\\controllers\\analytics.controller.ts","mappings":";;;;;;;;;;;;AACA,yCAAuC;AACvC,sDAAyB;AAEzB,yCAAsC;AACtC,0CAAoD;AACpD,0CAAuC;AAGhC,IAAM,mBAAmB,GAAzB,MAAM,mBAAmB;IACvB,KAAK,CAAC,oBAAoB,CAAC,IAAa,EAAE,GAAa,EAAE,IAAkB;QAChF,IAAI,CAAC;YACH,MAAM,QAAQ,GAAG,yBAAyB,CAAC;YAC3C,MAAM,UAAU,GAAG,MAAM,IAAA,gBAAQ,EAAC,QAAQ,CAAC,CAAC;YAE5C,IAAI,UAAU,EAAE,CAAC;gBACf,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC,CAAC;gBACjC,OAAO;YACT,CAAC;YAED,MAAM,UAAU,GAAG,MAAM,WAAI,CAAC,cAAc,EAAE,CAAC;YAC/C,MAAM,kBAAkB,GAAG,MAAM,WAAI,CAAC,cAAc,CAAC;gBACnD,SAAS,EAAE,EAAE,IAAI,EAAE,IAAI,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC,EAAE;aAC3D,CAAC,CAAC;YAEH,MAAM,QAAQ,GAAG;gBACf,WAAW,EAAE,kBAAkB,IAAI,CAAC;gBACpC,UAAU;gBACV,aAAa,EAAE,aAAK,CAAC,aAAa;gBAClC,SAAS,EACP,aAAK,CAAC,aAAa,GAAG,CAAC;oBACrB,CAAC,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC,CAAC,aAAK,CAAC,UAAU,GAAG,aAAK,CAAC,aAAa,CAAC,GAAG,GAAG,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC;oBAChF,CAAC,CAAC,CAAC;gBACP,eAAe,EAAE,aAAK,CAAC,eAAe;gBACtC,SAAS,EAAE,IAAI,CAAC,GAAG,EAAE;aACtB,CAAC;YAEF,MAAM,IAAA,gBAAQ,EAAC,QAAQ,EAAE,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,EAAE,EAAE,CAAC,CAAC;YACvD,GAAG,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;QACrB,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,IAAI,CAAC,KAAK,CAAC,CAAC;QACd,CAAC;IACH,CAAC;IAEM,KAAK,CAAC,eAAe,CAAC,GAAY,EAAE,GAAa,EAAE,IAAkB;QAC1E,IAAI,CAAC;YACH,MAAM,KAAK,GAAG,GAAG,CAAC,KAAK,CAAC,KAAK,IAAI,KAAK,CAAC;YACvC,MAAM,UAAU,GAAG,MAAM,WAAI,CAAC,cAAc,EAAE,CAAC;YAC/C,MAAM,QAAQ,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,MAAM,EAAE,EAAE,EAAE,EAAE,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC,CAAC;gBACrD,IAAI,EAAE,CAAC;gBACP,KAAK,EAAE,IAAI,CAAC,KAAK,CAAC,UAAU,GAAG,CAAC,GAAG,GAAG,IAAI,CAAC,MAAM,EAAE,GAAG,GAAG,CAAC,CAAC;gBAC3D,QAAQ,EAAE,IAAI,CAAC,KAAK,CAAC,UAAU,GAAG,CAAC,IAAI,GAAG,IAAI,CAAC,MAAM,EAAE,GAAG,GAAG,CAAC,CAAC;aAChE,CAAC,CAAC,CAAC;YAEJ,GAAG,CAAC,IAAI,CAAC,EAAE,KAAK,EAAE,IAAI,EAAE,QAAQ,EAAE,CAAC,CAAC;QACtC,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,IAAI,CAAC,KAAK,CAAC,CAAC;QACd,CAAC;IACH,CAAC;IAEM,cAAc,CAAC,IAAa,EAAE,GAAa,EAAE,IAAkB;QACpE,IAAI,CAAC;YACH,MAAM,OAAO,GAAG,iBAAE,CAAC,OAAO,EAAE,CAAC;YAC7B,MAAM,QAAQ,GAAG,iBAAE,CAAC,QAAQ,EAAE,CAAC;YAC/B,MAAM,OAAO,GAAG,iBAAE,CAAC,OAAO,EAAE,CAAC,CAAC,CAAC,CAAC;YAEhC,MAAM,KAAK,GAAG;gBACZ,GAAG,EAAE,KAAK,CAAC,IAAI,CAAC,EAAE,MAAM,EAAE,EAAE,EAAE,EAAE,GAAG,EAAE,CACnC,MAAM,CAAC,UAAU,CAAC,CAAC,OAAO,GAAG,EAAE,GAAG,IAAI,CAAC,MAAM,EAAE,GAAG,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,CACjE;gBACD,MAAM,EAAE,KAAK,CAAC,IAAI,CAAC,EAAE,MAAM,EAAE,EAAE,EAAE,EAAE,GAAG,EAAE,CACtC,MAAM,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,QAAQ,GAAG,OAAO,CAAC,GAAG,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,CACxE;gBACD,OAAO,EAAE,KAAK,CAAC,IAAI,CAAC,EAAE,MAAM,EAAE,EAAE,EAAE,EAAE,GAAG,EAAE,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC,IAAI,CAAC,MAAM,EAAE,GAAG,EAAE,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC;aAC9F,CAAC;YAEF,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;QAClB,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,IAAI,CAAC,KAAK,CAAC,CAAC;QACd,CAAC;IACH,CAAC;IAEM,aAAa,CAAC,IAAa,EAAE,GAAa,EAAE,IAAkB;QACnE,IAAI,CAAC;YACH,MAAM,MAAM,GAAG;gBACb,KAAK,EAAE,aAAK,CAAC,UAAU;gBACvB,MAAM,EAAE;oBACN,KAAK,EAAE,IAAI,CAAC,KAAK,CAAC,aAAK,CAAC,UAAU,GAAG,GAAG,CAAC;oBACzC,KAAK,EAAE,IAAI,CAAC,KAAK,CAAC,aAAK,CAAC,UAAU,GAAG,GAAG,CAAC;oBACzC,OAAO,EAAE,CAAC;iBACX;gBACD,KAAK,EAAE,KAAK,CAAC,IAAI,CAAC,EAAE,MAAM,EAAE,EAAE,EAAE,EAAE,GAAG,EAAE,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,EAAE,GAAG,CAAC,CAAC,CAAC;aACvE,CAAC;YAEF,GAAG,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;QACnB,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,IAAI,CAAC,KAAK,CAAC,CAAC;QACd,CAAC;IACH,CAAC;IAEM,KAAK,CAAC,gBAAgB,CAAC,IAAa,EAAE,GAAa,EAAE,IAAkB;QAC5E,IAAI,CAAC;YACH,MAAM,MAAM,GAAG,CAAC,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,CAAC,CAAC;YACpG,MAAM,OAAO,GAAG,MAAM,CAAC,GAAG,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC;gBACnC,IAAI,EAAE,KAAK;gBACX,KAAK,EAAE,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,EAAE,GAAG,KAAK,CAAC,GAAG,KAAK,GAAG,IAAI,CAAC,MAAM,EAAE,GAAG,KAAK;aACzE,CAAC,CAAC,CAAC;YAEJ,MAAM,IAAI,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,MAAM,EAAE,EAAE,EAAE,EAAE,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC,OAAO,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC;YAClE,IAAI,QAAQ,GAAG,IAAI,CAAC;YACpB,MAAM,KAAK,GAAG,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,EAAE;gBAC3B,QAAQ,GAAG,IAAI,CAAC,KAAK,CAAC,QAAQ,GAAG,CAAC,CAAC,GAAG,CAAC,IAAI,CAAC,MAAM,EAAE,GAAG,GAAG,GAAG,IAAI,CAAC,CAAC,CAAC,CAAC;gBACrE,OAAO,EAAE,IAAI,EAAE,GAAG,EAAE,KAAK,EAAE,QAAQ,EAAE,CAAC;YACxC,CAAC,CAAC,CAAC;YAEH,MAAM,WAAW,GAAG;gBAClB,EAAE,IAAI,EAAE,UAAU,EAAE,KAAK,EAAE,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,EAAE,GAAG,IAAI,CAAC,EAAE;gBACrE,EAAE,IAAI,EAAE,SAAS,EAAE,KAAK,EAAE,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,EAAE,GAAG,GAAG,CAAC,EAAE;gBAClE,EAAE,IAAI,EAAE,QAAQ,EAAE,KAAK,EAAE,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,EAAE,GAAG,GAAG,CAAC,EAAE;gBACjE,EAAE,IAAI,EAAE,QAAQ,EAAE,KAAK,EAAE,GAAG,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,EAAE,GAAG,GAAG,CAAC,EAAE;aACjE,CAAC;YAEF,GAAG,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,KAAK,EAAE,WAAW,EAAE,CAAC,CAAC;QAC5C,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,IAAI,CAAC,KAAK,CAAC,CAAC;QACd,CAAC;IACH,CAAC;IAEM,KAAK,CAAC,YAAY,CAAC,IAAa,EAAE,GAAa,EAAE,IAAkB;QACxE,IAAI,CAAC;YACH,MAAM,SAAS,GAAG,IAAI,IAAI,EAAE,CAAC,WAAW,EAAE,CAAC;YAC3C,IAAI,GAAG,GAAG,oBAAoB,SAAS,MAAM,CAAC;YAC9C,GAAG,IAAI,mBAAmB,CAAC;YAC3B,GAAG,IAAI,eAAe,MAAM,WAAI,CAAC,cAAc,EAAE,IAAI,CAAC;YACtD,GAAG,IAAI,kBAAkB,aAAK,CAAC,aAAa,IAAI,CAAC;YACjD,GAAG,IAAI,cAAc,CAAC,CAAC,aAAK,CAAC,UAAU,GAAG,CAAC,aAAK,CAAC,aAAa,IAAI,CAAC,CAAC,CAAC,GAAG,GAAG,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC;YAC/F,GAAG,IAAI,uBAAuB,CAAC;YAC/B,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,EAAE,EAAE,CAAC,EAAE,EAAE,CAAC;gBAC5B,MAAM,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,EAAE,GAAG,IAAI,CAAC,CAAC;gBAC/C,GAAG,IAAI,GAAG,CAAC,OAAO,KAAK,IAAI,IAAI,CAAC,KAAK,CAAC,KAAK,GAAG,GAAG,CAAC,IAAI,CAAC;YACzD,CAAC;YAED,GAAG,CAAC,MAAM,CAAC,cAAc,EAAE,UAAU,CAAC,CAAC;YACvC,GAAG,CAAC,UAAU,CAAC,oBAAoB,IAAI,CAAC,GAAG,EAAE,MAAM,CAAC,CAAC;YACrD,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;QAChB,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,IAAI,CAAC,KAAK,CAAC,CAAC;QACd,CAAC;IACH,CAAC;CACF,CAAA;AA5IY,kDAAmB;8BAAnB,mBAAmB;IAD/B,IAAA,sBAAU,GAAE;GACA,mBAAmB,CA4I/B","names":[],"sources":["C:\\Users\\Alejandro\\AIGestion\\backend\\src\\controllers\\analytics.controller.ts"],"sourcesContent":["import { Request, Response, NextFunction } from 'express';\nimport { injectable } from 'inversify';\nimport os from 'node:os';\n\nimport { User } from '../models/User';\nimport { getCache, setCache } from '../utils/redis';\nimport { stats } from '../utils/stats';\n\n@injectable()\nexport class AnalyticsController {\n  public async getAnalyticsOverview(_req: Request, res: Response, next: NextFunction): Promise<void> {\n    try {\n      const cacheKey = 'analytics:overview:real';\n      const cachedData = await getCache(cacheKey);\n\n      if (cachedData) {\n        res.json(JSON.parse(cachedData));\n        return;\n      }\n\n      const totalUsers = await User.countDocuments();\n      const activeUsersInRange = await User.countDocuments({\n        lastLogin: { $gte: new Date(Date.now() - 15 * 60 * 1000) },\n      });\n\n      const overview = {\n        activeUsers: activeUsersInRange || 1,\n        totalUsers,\n        totalRequests: stats.totalRequests,\n        errorRate:\n          stats.totalRequests > 0\n            ? Number.parseFloat(((stats.errorCount / stats.totalRequests) * 100).toFixed(2))\n            : 0,\n        avgResponseTime: stats.lastRequestTime,\n        timestamp: Date.now(),\n      };\n\n      await setCache(cacheKey, JSON.stringify(overview), 10);\n      res.json(overview);\n    } catch (error) {\n      next(error);\n    }\n  }\n\n  public async getUserActivity(req: Request, res: Response, next: NextFunction): Promise<void> {\n    try {\n      const range = req.query.range || '24h';\n      const totalUsers = await User.countDocuments();\n      const activity = Array.from({ length: 24 }, (_, i) => ({\n        hour: i,\n        users: Math.floor(totalUsers * (0.1 + Math.random() * 0.2)),\n        sessions: Math.floor(totalUsers * (0.15 + Math.random() * 0.3)),\n      }));\n\n      res.json({ range, data: activity });\n    } catch (error) {\n      next(error);\n    }\n  }\n\n  public getSystemUsage(_req: Request, res: Response, next: NextFunction): void {\n    try {\n      const freeMem = os.freemem();\n      const totalMem = os.totalmem();\n      const loadAvg = os.loadavg()[0];\n\n      const usage = {\n        cpu: Array.from({ length: 60 }, () =>\n          Number.parseFloat((loadAvg * 10 + Math.random() * 5).toFixed(1)),\n        ),\n        memory: Array.from({ length: 60 }, () =>\n          Number.parseFloat((((totalMem - freeMem) / totalMem) * 100).toFixed(1)),\n        ),\n        network: Array.from({ length: 60 }, () => Number.parseFloat((Math.random() * 10).toFixed(1))),\n      };\n\n      res.json(usage);\n    } catch (error) {\n      next(error);\n    }\n  }\n\n  public getErrorRates(_req: Request, res: Response, next: NextFunction): void {\n    try {\n      const errors = {\n        total: stats.errorCount,\n        byType: {\n          '4xx': Math.floor(stats.errorCount * 0.7),\n          '5xx': Math.floor(stats.errorCount * 0.3),\n          timeout: 0,\n        },\n        trend: Array.from({ length: 24 }, () => Math.floor(Math.random() * 2)),\n      };\n\n      res.json(errors);\n    } catch (error) {\n      next(error);\n    }\n  }\n\n  public async getDashboardData(_req: Request, res: Response, next: NextFunction): Promise<void> {\n    try {\n      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];\n      const revenue = months.map(month => ({\n        name: month,\n        value: Math.floor(Math.random() * 50000) + 20000 + Math.random() * 10000,\n      }));\n\n      const days = Array.from({ length: 14 }, (_, i) => `Day ${i + 1}`);\n      let previous = 1000;\n      const users = days.map(day => {\n        previous = Math.floor(previous * (1 + (Math.random() * 0.1 - 0.02)));\n        return { name: day, value: previous };\n      });\n\n      const conversions = [\n        { name: 'Visitors', value: 12000 + Math.floor(Math.random() * 2000) },\n        { name: 'Signups', value: 4500 + Math.floor(Math.random() * 500) },\n        { name: 'Active', value: 3200 + Math.floor(Math.random() * 300) },\n        { name: 'Paying', value: 850 + Math.floor(Math.random() * 100) },\n      ];\n\n      res.json({ revenue, users, conversions });\n    } catch (error) {\n      next(error);\n    }\n  }\n\n  public async exportReport(_req: Request, res: Response, next: NextFunction): Promise<void> {\n    try {\n      const timestamp = new Date().toISOString();\n      let csv = `Report Generated,${timestamp}\\n\\n`;\n      csv += 'SECTION,METRICS\\n';\n      csv += `Total Users,${await User.countDocuments()}\\n`;\n      csv += `Total Requests,${stats.totalRequests}\\n`;\n      csv += `Error Rate,${((stats.errorCount / (stats.totalRequests || 1)) * 100).toFixed(2)}%\\n\\n`;\n      csv += 'hour,users,sessions\\n';\n      for (let i = 0; i < 24; i++) {\n        const users = Math.floor(Math.random() * 1000);\n        csv += `${i}:00,${users},${Math.floor(users * 1.5)}\\n`;\n      }\n\n      res.header('Content-Type', 'text/csv');\n      res.attachment(`analytics_report_${Date.now()}.csv`);\n      res.send(csv);\n    } catch (error) {\n      next(error);\n    }\n  }\n}\n"],"version":3}