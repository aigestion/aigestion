8f95914836d61d6df4558e1776bddc2c
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AnalyticsController = void 0;
const inversify_1 = require("inversify");
const node_os_1 = __importDefault(require("node:os"));
const User_1 = require("../models/User");
const redis_1 = require("../utils/redis");
const stats_1 = require("../utils/stats");
let AnalyticsController = class AnalyticsController {
    async getAnalyticsOverview(_req, res, next) {
        try {
            const cacheKey = 'analytics:overview:real';
            const cachedData = await (0, redis_1.getCache)(cacheKey);
            if (cachedData) {
                res.json(JSON.parse(cachedData));
                return;
            }
            const totalUsers = await User_1.User.countDocuments();
            const activeUsersInRange = await User_1.User.countDocuments({
                lastLogin: { $gte: new Date(Date.now() - 15 * 60 * 1000) },
            });
            const overview = {
                activeUsers: activeUsersInRange || 1,
                totalUsers,
                totalRequests: stats_1.stats.totalRequests,
                errorRate: stats_1.stats.totalRequests > 0
                    ? Number.parseFloat(((stats_1.stats.errorCount / stats_1.stats.totalRequests) * 100).toFixed(2))
                    : 0,
                avgResponseTime: stats_1.stats.lastRequestTime,
                timestamp: Date.now(),
            };
            await (0, redis_1.setCache)(cacheKey, JSON.stringify(overview), 10);
            res.json(overview);
        }
        catch (error) {
            next(error);
        }
    }
    async getUserActivity(req, res, next) {
        try {
            const range = req.query.range || '24h';
            const totalUsers = await User_1.User.countDocuments();
            const activity = Array.from({ length: 24 }, (_, i) => ({
                hour: i,
                users: Math.floor(totalUsers * (0.1 + Math.random() * 0.2)),
                sessions: Math.floor(totalUsers * (0.15 + Math.random() * 0.3)),
            }));
            res.json({ range, data: activity });
        }
        catch (error) {
            next(error);
        }
    }
    getSystemUsage(_req, res, next) {
        try {
            const freeMem = node_os_1.default.freemem();
            const totalMem = node_os_1.default.totalmem();
            const loadAvg = node_os_1.default.loadavg()[0];
            const usage = {
                cpu: Array.from({ length: 60 }, () => Number.parseFloat((loadAvg * 10 + Math.random() * 5).toFixed(1))),
                memory: Array.from({ length: 60 }, () => Number.parseFloat((((totalMem - freeMem) / totalMem) * 100).toFixed(1))),
                network: Array.from({ length: 60 }, () => Number.parseFloat((Math.random() * 10).toFixed(1))),
            };
            res.json(usage);
        }
        catch (error) {
            next(error);
        }
    }
    getErrorRates(_req, res, next) {
        try {
            const errors = {
                total: stats_1.stats.errorCount,
                byType: {
                    '4xx': Math.floor(stats_1.stats.errorCount * 0.7),
                    '5xx': Math.floor(stats_1.stats.errorCount * 0.3),
                    timeout: 0,
                },
                trend: Array.from({ length: 24 }, () => Math.floor(Math.random() * 2)),
            };
            res.json(errors);
        }
        catch (error) {
            next(error);
        }
    }
    async getDashboardData(_req, res, next) {
        try {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const revenue = months.map(month => ({
                name: month,
                value: Math.floor(Math.random() * 50000) + 20000 + Math.random() * 10000,
            }));
            const days = Array.from({ length: 14 }, (_, i) => `Day ${i + 1}`);
            let previous = 1000;
            const users = days.map(day => {
                previous = Math.floor(previous * (1 + (Math.random() * 0.1 - 0.02)));
                return { name: day, value: previous };
            });
            const conversions = [
                { name: 'Visitors', value: 12000 + Math.floor(Math.random() * 2000) },
                { name: 'Signups', value: 4500 + Math.floor(Math.random() * 500) },
                { name: 'Active', value: 3200 + Math.floor(Math.random() * 300) },
                { name: 'Paying', value: 850 + Math.floor(Math.random() * 100) },
            ];
            res.json({ revenue, users, conversions });
        }
        catch (error) {
            next(error);
        }
    }
    async exportReport(_req, res, next) {
        try {
            const timestamp = new Date().toISOString();
            let csv = `Report Generated,${timestamp}\n\n`;
            csv += 'SECTION,METRICS\n';
            csv += `Total Users,${await User_1.User.countDocuments()}\n`;
            csv += `Total Requests,${stats_1.stats.totalRequests}\n`;
            csv += `Error Rate,${((stats_1.stats.errorCount / (stats_1.stats.totalRequests || 1)) * 100).toFixed(2)}%\n\n`;
            csv += 'hour,users,sessions\n';
            for (let i = 0; i < 24; i++) {
                const users = Math.floor(Math.random() * 1000);
                csv += `${i}:00,${users},${Math.floor(users * 1.5)}\n`;
            }
            res.header('Content-Type', 'text/csv');
            res.attachment(`analytics_report_${Date.now()}.csv`);
            res.send(csv);
        }
        catch (error) {
            next(error);
        }
    }
};
exports.AnalyticsController = AnalyticsController;
exports.AnalyticsController = AnalyticsController = __decorate([
    (0, inversify_1.injectable)()
], AnalyticsController);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxBbGVqYW5kcm9cXEFJR2VzdGlvblxcYmFja2VuZFxcc3JjXFxjb250cm9sbGVyc1xcYW5hbHl0aWNzLmNvbnRyb2xsZXIudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBQ0EseUNBQXVDO0FBQ3ZDLHNEQUF5QjtBQUV6Qix5Q0FBc0M7QUFDdEMsMENBQW9EO0FBQ3BELDBDQUF1QztBQUdoQyxJQUFNLG1CQUFtQixHQUF6QixNQUFNLG1CQUFtQjtJQUN2QixLQUFLLENBQUMsb0JBQW9CLENBQUMsSUFBYSxFQUFFLEdBQWEsRUFBRSxJQUFrQjtRQUNoRixJQUFJLENBQUM7WUFDSCxNQUFNLFFBQVEsR0FBRyx5QkFBeUIsQ0FBQztZQUMzQyxNQUFNLFVBQVUsR0FBRyxNQUFNLElBQUEsZ0JBQVEsRUFBQyxRQUFRLENBQUMsQ0FBQztZQUU1QyxJQUFJLFVBQVUsRUFBRSxDQUFDO2dCQUNmLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO2dCQUNqQyxPQUFPO1lBQ1QsQ0FBQztZQUVELE1BQU0sVUFBVSxHQUFHLE1BQU0sV0FBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1lBQy9DLE1BQU0sa0JBQWtCLEdBQUcsTUFBTSxXQUFJLENBQUMsY0FBYyxDQUFDO2dCQUNuRCxTQUFTLEVBQUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLEVBQUU7YUFDM0QsQ0FBQyxDQUFDO1lBRUgsTUFBTSxRQUFRLEdBQUc7Z0JBQ2YsV0FBVyxFQUFFLGtCQUFrQixJQUFJLENBQUM7Z0JBQ3BDLFVBQVU7Z0JBQ1YsYUFBYSxFQUFFLGFBQUssQ0FBQyxhQUFhO2dCQUNsQyxTQUFTLEVBQ1AsYUFBSyxDQUFDLGFBQWEsR0FBRyxDQUFDO29CQUNyQixDQUFDLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsYUFB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QyxHQUFHLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDO1lBQy9GLEdBQUcsSUFBSSx1QkFBdUIsQ0FBQztZQUMvQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7Z0JBQzVCLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO2dCQUMvQyxHQUFHLElBQUksR0FBRyxDQUFDLE9BQU8sS0FBSyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7WUFDekQsQ0FBQztZQUVELEdBQUcsQ0FBQyxNQUFNLENBQUMsY0FBYyxFQUFFLFVBQVUsQ0FBQyxDQUFDO1lBQ3ZDLEdBQUcsQ0FBQyxVQUFVLENBQUMsb0JBQW9CLElBQUksQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLENBQUM7WUFDckQsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNoQixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNkLENBQUM7SUFDSCxDQUFDO0NBQ0YsQ0FBQTtBQTVJWSxrREFBbUI7OEJBQW5CLG1CQUFtQjtJQUQvQixJQUFBLHNCQUFVLEdBQUU7R0FDQSxtQkFBbUIsQ0E0SS9CIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcQWxlamFuZHJvXFxBSUdlc3Rpb25cXGJhY2tlbmRcXHNyY1xcY29udHJvbGxlcnNcXGFuYWx5dGljcy5jb250cm9sbGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJlcXVlc3QsIFJlc3BvbnNlLCBOZXh0RnVuY3Rpb24gfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IGluamVjdGFibGUgfSBmcm9tICdpbnZlcnNpZnknO1xuaW1wb3J0IG9zIGZyb20gJ25vZGU6b3MnO1xuXG5pbXBvcnQgeyBVc2VyIH0gZnJvbSAnLi4vbW9kZWxzL1VzZXInO1xuaW1wb3J0IHsgZ2V0Q2FjaGUsIHNldENhY2hlIH0gZnJvbSAnLi4vdXRpbHMvcmVkaXMnO1xuaW1wb3J0IHsgc3RhdHMgfSBmcm9tICcuLi91dGlscy9zdGF0cyc7XG5cbkBpbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBBbmFseXRpY3NDb250cm9sbGVyIHtcbiAgcHVibGljIGFzeW5jIGdldEFuYWx5dGljc092ZXJ2aWV3KF9yZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbik6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBjYWNoZUtleSA9ICdhbmFseXRpY3M6b3ZlcnZpZXc6cmVhbCc7XG4gICAgICBjb25zdCBjYWNoZWREYXRhID0gYXdhaXQgZ2V0Q2FjaGUoY2FjaGVLZXkpO1xuXG4gICAgICBpZiAoY2FjaGVkRGF0YSkge1xuICAgICAgICByZXMuanNvbihKU09OLnBhcnNlKGNhY2hlZERhdGEpKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB0b3RhbFVzZXJzID0gYXdhaXQgVXNlci5jb3VudERvY3VtZW50cygpO1xuICAgICAgY29uc3QgYWN0aXZlVXNlcnNJblJhbmdlID0gYXdhaXQgVXNlci5jb3VudERvY3VtZW50cyh7XG4gICAgICAgIGxhc3RMb2dpbjogeyAkZ3RlOiBuZXcgRGF0ZShEYXRlLm5vdygpIC0gMTUgKiA2MCAqIDEwMDApIH0sXG4gICAgICB9KTtcblxuICAgICAgY29uc3Qgb3ZlcnZpZXcgPSB7XG4gICAgICAgIGFjdGl2ZVVzZXJzOiBhY3RpdmVVc2Vyc0luUmFuZ2UgfHwgMSxcbiAgICAgICAgdG90YWxVc2VycyxcbiAgICAgICAgdG90YWxSZXF1ZXN0czogc3RhdHMudG90YWxSZXF1ZXN0cyxcbiAgICAgICAgZXJyb3JSYXRlOlxuICAgICAgICAgIHN0YXRzLnRvdGFsUmVxdWVzdHMgPiAwXG4gICAgICAgICAgICA/IE51bWJlci5wYXJzZUZsb2F0KCgoc3RhdHMuZXJyb3JDb3VudCAvIHN0YXRzLnRvdGFsUmVxdWVzdHMpICogMTAwKS50b0ZpeGVkKDIpKVxuICAgICAgICAgICAgOiAwLFxuICAgICAgICBhdmdSZXNwb25zZVRpbWU6IHN0YXRzLmxhc3RSZXF1ZXN0VGltZSxcbiAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgfTtcblxuICAgICAgYXdhaXQgc2V0Q2FjaGUoY2FjaGVLZXksIEpTT04uc3RyaW5naWZ5KG92ZXJ2aWV3KSwgMTApO1xuICAgICAgcmVzLmpzb24ob3ZlcnZpZXcpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBuZXh0KGVycm9yKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0VXNlckFjdGl2aXR5KHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJhbmdlID0gcmVxLnF1ZXJ5LnJhbmdlIHx8ICcyNGgnO1xuICAgICAgY29uc3QgdG90YWxVc2VycyA9IGF3YWl0IFVzZXIuY291bnREb2N1bWVudHMoKTtcbiAgICAgIGNvbnN0IGFjdGl2aXR5ID0gQXJyYXkuZnJvbSh7IGxlbmd0aDogMjQgfSwgKF8sIGkpID0+ICh7XG4gICAgICAgIGhvdXI6IGksXG4gICAgICAgIHVzZXJzOiBNYXRoLmZsb29yKHRvdGFsVXNlcnMgKiAoMC4xICsgTWF0aC5yYW5kb20oKSAqIDAuMikpLFxuICAgICAgICBzZXNzaW9uczogTWF0aC5mbG9vcih0b3RhbFVzZXJzICogKDAuMTUgKyBNYXRoLnJhbmRvbSgpICogMC4zKSksXG4gICAgICB9KSk7XG5cbiAgICAgIHJlcy5qc29uKHsgcmFuZ2UsIGRhdGE6IGFjdGl2aXR5IH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBuZXh0KGVycm9yKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZ2V0U3lzdGVtVXNhZ2UoX3JlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKTogdm9pZCB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGZyZWVNZW0gPSBvcy5mcmVlbWVtKCk7XG4gICAgICBjb25zdCB0b3RhbE1lbSA9IG9zLnRvdGFsbWVtKCk7XG4gICAgICBjb25zdCBsb2FkQXZnID0gb3MubG9hZGF2ZygpWzBdO1xuXG4gICAgICBjb25zdCB1c2FnZSA9IHtcbiAgICAgICAgY3B1OiBBcnJheS5mcm9tKHsgbGVuZ3RoOiA2MCB9LCAoKSA9PlxuICAgICAgICAgIE51bWJlci5wYXJzZUZsb2F0KChsb2FkQXZnICogMTAgKyBNYXRoLnJhbmRvbSgpICogNSkudG9GaXhlZCgxKSksXG4gICAgICAgICksXG4gICAgICAgIG1lbW9yeTogQXJyYXkuZnJvbSh7IGxlbmd0aDogNjAgfSwgKCkgPT5cbiAgICAgICAgICBOdW1iZXIucGFyc2VGbG9hdCgoKCh0b3RhbE1lbSAtIGZyZWVNZW0pIC8gdG90YWxNZW0pICogMTAwKS50b0ZpeGVkKDEpKSxcbiAgICAgICAgKSxcbiAgICAgICAgbmV0d29yazogQXJyYXkuZnJvbSh7IGxlbmd0aDogNjAgfSwgKCkgPT4gTnVtYmVyLnBhcnNlRmxvYXQoKE1hdGgucmFuZG9tKCkgKiAxMCkudG9GaXhlZCgxKSkpLFxuICAgICAgfTtcblxuICAgICAgcmVzLmpzb24odXNhZ2UpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBuZXh0KGVycm9yKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZ2V0RXJyb3JSYXRlcyhfcmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pOiB2b2lkIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZXJyb3JzID0ge1xuICAgICAgICB0b3RhbDogc3RhdHMuZXJyb3JDb3VudCxcbiAgICAgICAgYnlUeXBlOiB7XG4gICAgICAgICAgJzR4eCc6IE1hdGguZmxvb3Ioc3RhdHMuZXJyb3JDb3VudCAqIDAuNyksXG4gICAgICAgICAgJzV4eCc6IE1hdGguZmxvb3Ioc3RhdHMuZXJyb3JDb3VudCAqIDAuMyksXG4gICAgICAgICAgdGltZW91dDogMCxcbiAgICAgICAgfSxcbiAgICAgICAgdHJlbmQ6IEFycmF5LmZyb20oeyBsZW5ndGg6IDI0IH0sICgpID0+IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDIpKSxcbiAgICAgIH07XG5cbiAgICAgIHJlcy5qc29uKGVycm9ycyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIG5leHQoZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBnZXREYXNoYm9hcmREYXRhKF9yZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbik6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBtb250aHMgPSBbJ0phbicsICdGZWInLCAnTWFyJywgJ0FwcicsICdNYXknLCAnSnVuJywgJ0p1bCcsICdBdWcnLCAnU2VwJywgJ09jdCcsICdOb3YnLCAnRGVjJ107XG4gICAgICBjb25zdCByZXZlbnVlID0gbW9udGhzLm1hcChtb250aCA9PiAoe1xuICAgICAgICBuYW1lOiBtb250aCxcbiAgICAgICAgdmFsdWU6IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDUwMDAwKSArIDIwMDAwICsgTWF0aC5yYW5kb20oKSAqIDEwMDAwLFxuICAgICAgfSkpO1xuXG4gICAgICBjb25zdCBkYXlzID0gQXJyYXkuZnJvbSh7IGxlbmd0aDogMTQgfSwgKF8sIGkpID0+IGBEYXkgJHtpICsgMX1gKTtcbiAgICAgIGxldCBwcmV2aW91cyA9IDEwMDA7XG4gICAgICBjb25zdCB1c2VycyA9IGRheXMubWFwKGRheSA9PiB7XG4gICAgICAgIHByZXZpb3VzID0gTWF0aC5mbG9vcihwcmV2aW91cyAqICgxICsgKE1hdGgucmFuZG9tKCkgKiAwLjEgLSAwLjAyKSkpO1xuICAgICAgICByZXR1cm4geyBuYW1lOiBkYXksIHZhbHVlOiBwcmV2aW91cyB9O1xuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGNvbnZlcnNpb25zID0gW1xuICAgICAgICB7IG5hbWU6ICdWaXNpdG9ycycsIHZhbHVlOiAxMjAwMCArIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDIwMDApIH0sXG4gICAgICAgIHsgbmFtZTogJ1NpZ251cHMnLCB2YWx1ZTogNDUwMCArIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDUwMCkgfSxcbiAgICAgICAgeyBuYW1lOiAnQWN0aXZlJywgdmFsdWU6IDMyMDAgKyBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAzMDApIH0sXG4gICAgICAgIHsgbmFtZTogJ1BheWluZycsIHZhbHVlOiA4NTAgKyBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAxMDApIH0sXG4gICAgICBdO1xuXG4gICAgICByZXMuanNvbih7IHJldmVudWUsIHVzZXJzLCBjb252ZXJzaW9ucyB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbmV4dChlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGV4cG9ydFJlcG9ydChfcmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdGltZXN0YW1wID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xuICAgICAgbGV0IGNzdiA9IGBSZXBvcnQgR2VuZXJhdGVkLCR7dGltZXN0YW1wfVxcblxcbmA7XG4gICAgICBjc3YgKz0gJ1NFQ1RJT04sTUVUUklDU1xcbic7XG4gICAgICBjc3YgKz0gYFRvdGFsIFVzZXJzLCR7YXdhaXQgVXNlci5jb3VudERvY3VtZW50cygpfVxcbmA7XG4gICAgICBjc3YgKz0gYFRvdGFsIFJlcXVlc3RzLCR7c3RhdHMudG90YWxSZXF1ZXN0c31cXG5gO1xuICAgICAgY3N2ICs9IGBFcnJvciBSYXRlLCR7KChzdGF0cy5lcnJvckNvdW50IC8gKHN0YXRzLnRvdGFsUmVxdWVzdHMgfHwgMSkpICogMTAwKS50b0ZpeGVkKDIpfSVcXG5cXG5gO1xuICAgICAgY3N2ICs9ICdob3VyLHVzZXJzLHNlc3Npb25zXFxuJztcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMjQ7IGkrKykge1xuICAgICAgICBjb25zdCB1c2VycyA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDEwMDApO1xuICAgICAgICBjc3YgKz0gYCR7aX06MDAsJHt1c2Vyc30sJHtNYXRoLmZsb29yKHVzZXJzICogMS41KX1cXG5gO1xuICAgICAgfVxuXG4gICAgICByZXMuaGVhZGVyKCdDb250ZW50LVR5cGUnLCAndGV4dC9jc3YnKTtcbiAgICAgIHJlcy5hdHRhY2htZW50KGBhbmFseXRpY3NfcmVwb3J0XyR7RGF0ZS5ub3coKX0uY3N2YCk7XG4gICAgICByZXMuc2VuZChjc3YpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBuZXh0KGVycm9yKTtcbiAgICB9XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==