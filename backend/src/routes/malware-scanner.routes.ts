import { Router } from 'express';
import { malwareScanner } from '../middleware/malware-scanner.middleware';
import { requireApiKey } from '../middleware/security.middleware';
import { MalwareScannerService } from '../services/malware-scanner.service';
import { logger } from '../utils/logger';

const router = Router();
const scannerService = new MalwareScannerService();

/**
 * Malware Scanner Management Routes
 */

// Get scanner statistics
router.get('/stats', requireApiKey, (req: any, res: any) => {
  try {
    const stats = malwareScanner.getScannerStats();

    res.json({
      success: true,
      data: {
        ...stats,
        timestamp: new Date().toISOString(),
      },
    });
  } catch (error) {
    logger.error('Error getting malware scanner stats:', error);
    res.status(500).json({
      success: false,
      error: 'Internal server error',
    });
  }
});

// Get quarantined files
router.get('/quarantine', requireApiKey, async (req: any, res: any) => {
  try {
    const quarantinedFiles = await scannerService.getQuarantinedFiles();

    res.json({
      success: true,
      data: quarantinedFiles.map(file => ({
        originalPath: file.originalPath,
        quarantinePath: file.quarantinePath,
        hash: file.hash,
        threat: file.threat,
        quarantinedAt: file.quarantinedAt,
        userId: file.userId,
      })),
    });
  } catch (error) {
    logger.error('Error getting quarantined files:', error);
    res.status(500).json({
      success: false,
      error: 'Internal server error',
    });
  }
});

// Release file from quarantine
router.post('/quarantine/:quarantinePath/release', requireApiKey, async (req: any, res: any) => {
  try {
    const { quarantinePath } = req.params;
    const { targetPath } = req.body;

    if (!targetPath) {
      return res.status(400).json({
        success: false,
        error: 'Target path is required',
      });
    }

    await scannerService.releaseFromQuarantine(quarantinePath, targetPath);

    logger.info('File released from quarantine', {
      quarantinePath,
      targetPath,
      ip: req.ip,
    });

    res.json({
      success: true,
      message: 'File released from quarantine successfully',
    });
  } catch (error) {
    logger.error('Error releasing file from quarantine:', error);
    res.status(500).json({
      success: false,
      error: 'Internal server error',
    });
  }
});

// Delete quarantined file
router.delete('/quarantine/:quarantinePath', requireApiKey, async (req: any, res: any) => {
  try {
    const { quarantinePath } = req.params;

    await scannerService.deleteQuarantinedFile(quarantinePath);

    logger.info('Quarantined file deleted', {
      quarantinePath,
      ip: req.ip,
    });

    res.json({
      success: true,
      message: 'Quarantined file deleted successfully',
    });
  } catch (error) {
    logger.error('Error deleting quarantined file:', error);
    res.status(500).json({
      success: false,
      error: 'Internal server error',
    });
  }
});

// Clear scanner cache
router.post('/cache/clear', requireApiKey, (req: any, res: any) => {
  try {
    malwareScanner.clearCache();

    logger.info('Malware scanner cache cleared', {
      ip: req.ip,
    });

    res.json({
      success: true,
      message: 'Scanner cache cleared successfully',
    });
  } catch (error) {
    logger.error('Error clearing scanner cache:', error);
    res.status(500).json({
      success: false,
      error: 'Internal server error',
    });
  }
});

// Upload and scan file (test endpoint)
router.post(
  '/scan',
  requireApiKey,
  malwareScanner.uploadSingle('file'),
  async (req: any, res: any) => {
    try {
      const uploadedFile = (req as any).file;
      if (!uploadedFile) {
        return res.status(400).json({
          success: false,
          error: 'No file uploaded',
        });
      }

      const scanResult = (req as any).fileScanResult;

      res.json({
        success: true,
        data: {
          file: {
            originalname: uploadedFile.originalname,
            filename: uploadedFile.filename,
            size: uploadedFile.size,
            mimetype: uploadedFile.mimetype,
          },
          scanResult: {
            isInfected: scanResult.isInfected,
            threats: scanResult.threats,
            scanTime: scanResult.scanTime,
            engine: scanResult.engine,
            hash: scanResult.hash,
          },
        },
      });
    } catch (error) {
      logger.error('Error in scan endpoint:', error);
      res.status(500).json({
        success: false,
        error: 'Internal server error',
      });
    }
  },
);

// Upload and scan multiple files (test endpoint)
router.post(
  '/scan-batch',
  requireApiKey,
  malwareScanner.uploadMultiple('files', 5),
  async (req: any, res: any) => {
    try {
      const scanResults = (req as any).fileScanResults;

      if (!scanResults || scanResults.length === 0) {
        return res.status(400).json({
          success: false,
          error: 'No files uploaded',
        });
      }

      res.json({
        success: true,
        data: {
          totalFiles: scanResults.length,
          cleanFiles: scanResults.filter((r: any) => r.isClean).length,
          infectedFiles: scanResults.filter((r: any) => !r.isClean).length,
          results: scanResults.map((result: any) => ({
            file: {
              originalname: result.originalname,
              filename: result.filename,
              size: result.size,
              mimetype: result.mimetype,
            },
            scanResult: {
              isInfected: result.scanResult.isInfected,
              threats: result.scanResult.threats,
              scanTime: result.scanResult.scanTime,
              engine: result.scanResult.engine,
              hash: result.scanResult.hash,
            },
          })),
        },
      });
    } catch (error) {
      logger.error('Error in batch scan endpoint:', error);
      res.status(500).json({
        success: false,
        error: 'Internal server error',
      });
    }
  },
);

// Get scanner health
router.get('/health', (req: any, res: any) => {
  try {
    const stats = malwareScanner.getScannerStats();

    const health = {
      status: 'healthy',
      scanner: 'active',
      stats: {
        totalScans: stats.totalScans,
        infectedFiles: stats.infectedFiles,
        quarantinedFiles: stats.quarantinedFiles,
        averageScanTime: Math.round(stats.averageScanTime * 100) / 100,
      },
      timestamp: new Date().toISOString(),
    };

    res.json({
      success: true,
      data: health,
    });
  } catch (error) {
    logger.error('Error getting scanner health:', error);
    res.status(500).json({
      success: false,
      error: 'Internal server error',
    });
  }
});

export default router;
