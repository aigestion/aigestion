#!/bin/bash

# Vulnerability Scanning Script
# Runs comprehensive security scans on the AIGestion project

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging function
log() {
    echo -e "${BLUE}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1" >&2
}

success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# Check if required tools are installed
check_dependencies() {
    log "Checking dependencies..."

    local tools=("docker" "trivy" "npm" "pnpm" "python3" "pip")
    local missing_tools=()

    for tool in "${tools[@]}"; do
        if ! command -v "$tool" &> /dev/null; then
            missing_tools+=("$tool")
        fi
    done

    if [ ${#missing_tools[@]} -ne 0 ]; then
        error "Missing required tools: ${missing_tools[*]}"
        error "Please install the missing tools and try again."
        exit 1
    fi

    success "All required tools are installed"
}

# Scan Docker images for vulnerabilities
scan_docker_images() {
    log "Scanning Docker images..."

    local images=("nexus-backend" "nexus-frontend" "nexus-ml-service")
    local vulnerabilities_found=false

    for image in "${images[@]}"; do
        log "Building $image image..."
        case $image in
            "nexus-backend")
                docker build -t "$image:latest" ./backend
                ;;
            "nexus-frontend")
                docker build -t "$image:latest" ./frontend
                ;;
            "nexus-ml-service")
                docker build -t "$image:latest" ./ml-service
                ;;
        esac

        log "Scanning $image for vulnerabilities..."
        if trivy image --format json --output "trivy-$image-results.json" "$image:latest"; then
            log "Trivy scan completed for $image"
        else
            warning "Trivy scan failed for $image"
            vulnerabilities_found=true
        fi

        # Check for critical/high vulnerabilities
        local critical_count=$(jq -r '.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL") | .VulnerabilityID' "trivy-$image-results.json" | wc -l || echo "0")
        local high_count=$(jq -r '.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH") | .VulnerabilityID' "trivy-$image-results.json" | wc -l || echo "0")

        if [ "$critical_count" -gt 0 ] || [ "$high_count" -gt 0 ]; then
            warning "Found $critical_count critical and $high_count high vulnerabilities in $image"
            vulnerabilities_found=true
        else
            success "No critical or high vulnerabilities found in $image"
        fi
    done

    if [ "$vulnerabilities_found" = true ]; then
        warning "Some vulnerabilities were found. Check the JSON reports for details."
    fi
}

# Scan Node.js dependencies
scan_node_dependencies() {
    log "Scanning Node.js dependencies..."

    local directories=("." "backend" "frontend")

    for dir in "${directories[@]}"; do
        if [ -f "$dir/package.json" ]; then
            log "Scanning dependencies in $dir..."

            cd "$dir"

            # Run npm audit
            if pnpm audit --audit-level moderate --json > audit-results.json 2>/dev/null; then
                log "Audit completed for $dir"
            else
                warning "Audit found issues in $dir"
            fi

            # Check for outdated packages
            if pnpm outdated --json > outdated.json 2>/dev/null; then
                local outdated_count=$(jq 'keys | length' outdated.json 2>/dev/null || echo "0")
                if [ "$outdated_count" -gt 0 ]; then
                    warning "Found $outdated_count outdated packages in $dir"
                fi
            fi

            cd ..
        fi
    done
}

# Scan Python dependencies
scan_python_dependencies() {
    log "Scanning Python dependencies..."

    local python_dirs=("ml-service" "aig-ia-engine")

    for dir in "${python_dirs[@]}"; do
        if [ -f "$dir/requirements.txt" ]; then
            log "Scanning Python dependencies in $dir..."

            cd "$dir"

            # Install pip-audit if not present
            if ! command -v pip-audit &> /dev/null; then
                log "Installing pip-audit..."
                pip install pip-audit
            fi

            # Run pip-audit
            if pip-audit --format=json --requirement=requirements.txt > pip-audit-results.json 2>/dev/null; then
                log "pip-audit completed for $dir"
            else
                warning "pip-audit found issues in $dir"
            fi

            cd ..
        fi
    done
}

# Scan for secrets in code
scan_secrets() {
    log "Scanning for secrets in code..."

    # Install gitleaks if not present
    if ! command -v gitleaks &> /dev/null; then
        log "Installing gitleaks..."
        wget https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks-linux-amd64
        chmod +x gitleaks-linux-amd64
        sudo mv gitleaks-linux-amd64 /usr/local/bin/gitleaks
    fi

    # Run gitleaks
    if gitleaks detect --verbose --report-format json --report-path gitleaks-results.json; then
        success "No secrets detected by gitleaks"
    else
        warning "Gitleaks detected potential secrets. Check gitleaks-results.json"
    fi

    # Run trufflehog if available
    if command -v trufflehog &> /dev/null; then
        log "Running trufflehog..."
        trufflehog filesystem --directory . --json --output trufflehog-results.json || true
    fi
}

# Generate security report
generate_report() {
    log "Generating security report..."

    local report_file="security-scan-report-$(date +%Y%m%d-%H%M%S).md"

    cat > "$report_file" << EOF
# Security Scan Report

**Generated on:** $(date)
**Project:** AIGestion (NEXUS V1)

## Executive Summary

This report contains the results of comprehensive security scans including:
- Docker image vulnerability scanning
- Dependency analysis (Node.js and Python)
- Secret detection

## Scan Results

### Docker Image Scans
EOF

    # Add Docker scan results
    for image in "backend" "frontend" "ml-service"; do
        if [ -f "trivy-nexus-$image-results.json" ]; then
            local critical=$(jq -r '.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL") | .VulnerabilityID' "trivy-nexus-$image-results.json" 2>/dev/null | wc -l || echo "0")
            local high=$(jq -r '.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH") | .VulnerabilityID' "trivy-nexus-$image-results.json" 2>/dev/null | wc -l || echo "0")
            echo "- **$image:** $critical critical, $high high vulnerabilities" >> "$report_file"
        fi
    done

    cat >> "$report_file" << EOF

### Dependency Scans

#### Node.js Dependencies
EOF

    # Add Node.js dependency results
    for dir in "." "backend" "frontend"; do
        if [ -f "$dir/audit-results.json" ]; then
            echo "- **$dir:** Audit completed" >> "$report_file"
        fi
    done

    cat >> "$report_file" << EOF

#### Python Dependencies
EOF

    # Add Python dependency results
    for dir in "ml-service" "aig-ia-engine"; do
        if [ -f "$dir/pip-audit-results.json" ]; then
            echo "- **$dir:** pip-audit completed" >> "$report_file"
        fi
    done

    cat >> "$report_file" << EOF

### Secret Detection
EOF

    # Add secret detection results
    if [ -f "gitleaks-results.json" ]; then
        local secrets_count=$(jq '. | length' gitleaks-results.json 2>/dev/null || echo "0")
        echo "- **Gitleaks:** $secrets_count potential secrets found" >> "$report_file"
    fi

    cat >> "$report_file" << EOF

## Recommendations

1. **Address Critical Vulnerabilities:** Immediately fix any critical vulnerabilities found in Docker images
2. **Update Dependencies:** Update outdated packages to their latest secure versions
3. **Review Secrets:** If any secrets were detected, rotate them immediately
4. **Regular Scanning:** Schedule regular security scans to maintain security posture

## Detailed Reports

Detailed JSON reports are available for each scan type:
- trivy-*-results.json: Docker vulnerability scans
- audit-results.json: Node.js dependency audits
- pip-audit-results.json: Python dependency audits
- gitleaks-results.json: Secret detection results

EOF

    success "Security report generated: $report_file"
}

# Cleanup function
cleanup() {
    log "Cleaning up temporary files..."
    # Remove Docker images
    docker rmi nexus-backend:latest nexus-frontend:latest nexus-ml-service:latest 2>/dev/null || true
}

# Main execution
main() {
    log "Starting comprehensive vulnerability scan..."

    check_dependencies
    scan_docker_images
    scan_node_dependencies
    scan_python_dependencies
    scan_secrets
    generate_report

    success "Vulnerability scan completed successfully!"
    log "Check the generated reports for detailed findings."
}

# Trap to cleanup on exit
trap cleanup EXIT

# Run main function
main "$@"
