#!/bin/bash

# Setup Malware Scanner Script
# Installs and configures malware scanning tools

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging function
log() {
    echo -e "${BLUE}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1" >&2
}

success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# Check if running as root for system installations
check_root() {
    if [[ $EUID -ne 0 ]]; then
        warning "Some installations require sudo. You may be prompted for password."
    fi
}

# Install ClamAV
install_clamav() {
    log "Installing ClamAV..."

    if command -v clamscan &> /dev/null; then
        log "ClamAV is already installed"
        clamscan --version
    else
        log "Installing ClamAV..."

        # Detect package manager
        if command -v apt-get &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y clamav clamav-freshclam clamav-daemon
        elif command -v yum &> /dev/null; then
            sudo yum install -y clamav clamav-update
        elif command -v brew &> /dev/null; then
            brew install clamav
        else
            error "Unsupported package manager. Please install ClamAV manually."
            return 1
        fi

        # Update virus definitions
        log "Updating ClamAV virus definitions..."
        sudo freshclam

        success "ClamAV installed successfully"
    fi
}

# Install YARA
install_yara() {
    log "Installing YARA..."

    if command -v yara &> /dev/null; then
        log "YARA is already installed"
        yara --version
    else
        log "Installing YARA..."

        # Detect package manager
        if command -v apt-get &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y yara
        elif command -v yum &> /dev/null; then
            sudo yum install -y yara
        elif command -v brew &> /dev/null; then
            brew install yara
        else
            error "Unsupported package manager. Please install YARA manually."
            return 1
        fi

        success "YARA installed successfully"
    fi
}

# Download YARA rules
download_yara_rules() {
    log "Downloading YARA malware rules..."

    local rules_dir="/usr/share/yara/rules"

    # Create rules directory if it doesn't exist
    sudo mkdir -p "$rules_dir"

    # Download malware rules
    if command -v wget &> /dev/null; then
        # Download from YARA rules repository
        log "Downloading malware.yar rules..."
        sudo wget -O "$rules_dir/malware.yar" \
            "https://raw.githubusercontent.com/Yara-Rules/rules/main/malware/malware.yar" || \
        {
            warning "Failed to download malware.yar, creating basic rules..."
            create_basic_yara_rules "$rules_dir"
        }

        # Download additional rule sets
        log "Downloading additional YARA rules..."
        sudo wget -O "$rules_dir/packer.yar" \
            "https://raw.githubusercontent.com/Yara-Rules/rules/main/packers/packer.yar" || \
        {
            warning "Failed to download packer.yar"
        }

        sudo wget -O "$rules_dir/crypto.yar" \
            "https://raw.githubusercontent.com/Yara-Rules/rules/main/crypto/crypto.yar" || \
        {
            warning "Failed to download crypto.yar"
        }

    else
        warning "wget not available, creating basic rules..."
        create_basic_yara_rules "$rules_dir"
    fi

    success "YARA rules downloaded/created"
}

# Create basic YARA rules if download fails
create_basic_yara_rules() {
    local rules_dir="$1"

    log "Creating basic YARA rules..."

    sudo tee "$rules_dir/malware.yar" > /dev/null << 'EOF'
rule SuspiciousPE {
    meta:
        description = "Detects suspicious PE executable files"
        author = "AIGestion Security Team"
        date = "2026-01-18"

    condition:
        uint16(0) == 0x5A4D and // MZ header
        filesize < 10MB and
        (
            // Check for suspicious imports
            pe.imports("CreateRemoteThread") or
            pe.imports("WriteProcessMemory") or
            pe.imports("VirtualAllocEx") or
            pe.imports("SetWindowsHookEx") or
            pe.imports("GetAsyncKeyState") or
            pe.imports("GetForegroundWindow")
        )
}

rule SuspiciousScript {
    meta:
        description = "Detects suspicious script files"
        author = "AIGestion Security Team"
        date = "2026-01-18"

    strings:
        $eval1 = /eval\s*\(/
        $eval2 = /eval\s*\(/
        $exec1 = /exec\s*\(/
        $exec2 = /system\s*\(/
        $shell1 = /shell_exec\s*\(/
        $wscript = /CreateObject\s*\(\s*["']WScript\.Shell["']/
        $powershell = /powershell\.exe/
        $cmd = /cmd\.exe/
        $base64 = /[A-Za-z0-9+/]{100,}={0,2}/

    condition:
        filesize < 5MB and
        (
            2 of ($eval1, $eval2, $exec1, $exec2, $shell1) or
            $wscript or $powershell or $cmd or
            $base64
        )
}

rule SuspiciousNetwork {
    meta:
        description = "Detects suspicious network activity patterns"
        author = "AIGestion Security Team"
        date = "2026-01-18"

    strings:
        $http1 = /http:\/\/[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/
        $http2 = /https:\/\/[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/
        $ftp1 = /ftp:\/\/[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/
        $port1 = /:[0-9]{4,5}/
        $c2 = /bot\.|c2|command.*control/

    condition:
        filesize < 10MB and
        (
            2 of ($http1, $http2, $ftp1) or
            $port1 or
            $c2
        )
}

rule HighEntropy {
    meta:
        description = "Detects high entropy files (possible encryption/packing)"
        author = "AIGestion Security Team"
        date = "2026-01-18"

    condition:
        filesize > 1KB and
        filesize < 100MB and
        math.entropy(0, filesize) > 7.5
}
EOF

    success "Basic YARA rules created"
}

# Test ClamAV
test_clamav() {
    log "Testing ClamAV..."

    # Create test file
    local test_file="/tmp/eicar.txt"
    echo 'X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*' > "$test_file"

    # Scan test file
    if clamscan --infected --remove=yes "$test_file" 2>/dev/null; then
        success "ClamAV test passed - EICAR test file detected"
    else
        error "ClamAV test failed - EICAR test file not detected"
        return 1
    fi

    # Clean up
    rm -f "$test_file"
}

# Test YARA
test_yara() {
    log "Testing YARA..."

    # Create test file
    local test_file="/tmp/test_malware.exe"

    # Create a simple PE-like file for testing
    printf '\x4D\x5A\x90\x00\x03\x00\x00\x00' > "$test_file"

    # Test YARA scan
    if yara /usr/share/yara/rules/malware.yar "$test_file" 2>/dev/null; then
        success "YARA test passed - Test file detected"
    else
        warning "YARA test completed - No rules matched (this may be normal)"
    fi

    # Clean up
    rm -f "$test_file"
}

# Create quarantine directory
create_quarantine() {
    log "Creating quarantine directory..."

    local quarantine_dir="./quarantine"

    if [ ! -d "$quarantine_dir" ]; then
        mkdir -p "$quarantine_dir"
        chmod 700 "$quarantine_dir"
        success "Quarantine directory created: $quarantine_dir"
    else
        log "Quarantine directory already exists"
    fi
}

# Create uploads directory
create_uploads() {
    log "Creating uploads directory..."

    local uploads_dir="./uploads"

    if [ ! -d "$uploads_dir" ]; then
        mkdir -p "$uploads_dir"
        chmod 755 "$uploads_dir"
        success "Uploads directory created: $uploads_dir"
    else
        log "Uploads directory already exists"
    fi
}

# Configure environment variables
configure_env() {
    log "Configuring environment variables..."

    local env_file=".env"

    if [ -f "$env_file" ]; then
        # Add malware scanner configuration
        local malware_vars=(
            "MALWARE_SCAN_ENABLED=true"
            "CLAMAV_ENABLED=true"
            "YARA_ENABLED=true"
            "VIRUSTOTAL_API_KEY="
            "MAX_FILE_SIZE=10485760"
            "ALLOWED_MIME_TYPES=image/jpeg,image/png,image/gif,image/webp,application/pdf,text/plain,application/json"
            "QUARANTINE_ENABLED=true"
            "SCAN_TIMEOUT=30000"
        )

        for var in "${malware_vars[@]}"; do
            local key=$(echo "$var" | cut -d'=' -f1)
            if ! grep -q "^$key=" "$env_file"; then
                echo "$var" >> "$env_file"
                log "Added $key to .env"
            fi
        done

        success "Environment variables configured"
    else
        warning ".env file not found. Please configure manually."
    fi
}

# Create systemd service for ClamAV (optional)
create_clamav_service() {
    log "Creating ClamAV daemon service..."

    if command -v systemctl &> /dev/null; then
        # Check if service already exists
        if systemctl list-unit-files | grep -q "clamav-daemon"; then
            log "ClamAV daemon service already exists"

            # Enable and start service
            sudo systemctl enable clamav-daemon || true
            sudo systemctl start clamav-daemon || true

            success "ClamAV daemon service configured"
        else
            warning "ClamAV daemon service not found. Manual configuration may be required."
        fi
    else
        warning "systemctl not available. Service configuration skipped."
    fi
}

# Update virus definitions
update_definitions() {
    log "Updating virus definitions..."

    if command -v freshclam &> /dev/null; then
        if sudo freshclam; then
            success "Virus definitions updated"
        else
            error "Failed to update virus definitions"
            return 1
        fi
    else
        warning "freshclam not available. Please update manually."
    fi
}

# Main function
main() {
    log "Starting malware scanner setup..."

    check_root

    # Install components
    install_clamav
    install_yara

    # Configure components
    download_yara_rules
    create_quarantine
    create_uploads
    configure_env
    create_clamav_service

    # Update definitions
    update_definitions

    # Test components
    test_clamav
    test_yara

    success "Malware scanner setup completed!"
    echo
    echo "Next steps:"
    echo "1. Configure VIRUSTOTAL_API_KEY in .env for enhanced scanning"
    echo "2. Test the malware scanner with the API endpoints"
    echo "3. Monitor quarantine directory regularly"
    echo "4. Schedule regular virus definition updates"
    echo "5. Review scan logs for false positives"
    echo
    echo "API endpoints available:"
    echo "- GET /malware-scanner/stats - Scanner statistics"
    echo "- GET /malware-scanner/quarantine - Quarantined files"
    echo "- POST /malware-scanner/scan - Scan single file"
    echo "- POST /malware-scanner/scan-batch - Scan multiple files"
    echo "- GET /malware-scanner/health - Scanner health"
}

# Run main function
main "$@"
