name: ðŸ§ª Automated Testing Suite

on:
  push:
    branches: [main, develop]
    paths:
      - 'frontend/apps/website-epic/**'
  pull_request:
    branches: [main]
    paths:
      - 'frontend/apps/website-epic/**'
  schedule:
    - cron: '0 6 * * *' # Daily at 6 AM UTC
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  pull-requests: write
  issues: write

jobs:
  # ðŸ§ª Unit Tests
  unit-tests:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    outputs:
      coverage-badge: ${{ steps.coverage.outputs.badge }}
    steps:
      - name: ðŸšš Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ðŸ”„ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: '8'

      - name: ðŸ“‹ Install Dependencies
        working-directory: ./frontend/apps/website-epic
        run: pnpm install

      - name: ðŸ§ª Run Unit Tests
        working-directory: ./frontend/apps/website-epic
        run: pnpm test --coverage --watchAll=false --ci

      - name: ðŸ“Š Generate Coverage Badge
        id: coverage
        working-directory: ./frontend/apps/website-epic
        run: |
          COVERAGE=$(cat coverage/lcov.info | lcov --summary 2>/dev/null | grep lines | awk '{print $2}' | sed 's/%//')
          echo "Coverage: ${COVERAGE}%"
          echo "badge=${COVERAGE}" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Upload Coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./frontend/apps/website-epic/coverage/lcov.info
          flags: frontend
          name: frontend-coverage

      - name: ðŸ“Š Coverage Comment
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const coverage = '${{ steps.coverage.outputs.badge }}';
            const comment = `
            ## ðŸ“Š Test Coverage Report

            **Coverage:** ${coverage}%

            ${coverage >= 80 ? 'âœ… Good coverage!' : coverage >= 60 ? 'âš ï¸ Moderate coverage' : 'âŒ Low coverage - needs improvement'}

            [View detailed coverage report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ðŸŽ­ Component Testing
  component-tests:
    name: ðŸŽ­ Component Tests
    runs-on: ubuntu-latest
    steps:
      - name: ðŸšš Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ðŸ”„ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: '8'

      - name: ðŸ“‹ Install Dependencies
        working-directory: ./frontend/apps/website-epic
        run: pnpm install

      - name: ðŸŽ­ Run Component Tests
        working-directory: ./frontend/apps/website-epic
        run: pnpm test:components --ci --coverage

      - name: ðŸ“¸ Component Screenshots
        working-directory: ./frontend/apps/website-epic
        run: |
          # Take screenshots of key components
          mkdir -p ./screenshots

          # Build for testing
          pnpm build

          # Start preview server
          pnpm preview &
          sleep 10

          # Take screenshots using puppeteer
          npx puppeteer screenshot --url=http://localhost:4173 --path=./screenshots/homepage.png
          npx puppeteer screenshot --url=http://localhost:4173/about --path=./screenshots/about.png

      - name: ðŸ“¤ Upload Screenshots
        uses: actions/upload-artifact@v4
        with:
          name: component-screenshots-${{ github.run_number }}
          path: ./frontend/apps/website-epic/screenshots/

  # ðŸŒ E2E Testing
  e2e-tests:
    name: ðŸŒ E2E Tests
    runs-on: ubuntu-latest
    steps:
      - name: ðŸšš Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ðŸ”„ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: '8'

      - name: ðŸ“‹ Install Dependencies
        working-directory: ./frontend/apps/website-epic
        run: pnpm install

      - name: ðŸ”¨ Build Application
        working-directory: ./frontend/apps/website-epic
        run: pnpm build

      - name: ðŸŒ Start Application
        working-directory: ./frontend/apps/website-epic
        run: |
          pnpm preview &
          sleep 15

      - name: ðŸŒ Run E2E Tests
        working-directory: ./frontend/apps/website-epic
        run: |
          # Install Playwright if not present
          npx playwright install --with-deps

          # Run E2E tests
          npx playwright test || true

      - name: ðŸ“Š E2E Test Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-report-${{ github.run_number }}
          path: |
            ./frontend/apps/website-epic/playwright-report/
            ./frontend/apps/website-epic/test-results/

  # ðŸ“± Visual Regression Testing
  visual-regression:
    name: ðŸ“± Visual Regression
    runs-on: ubuntu-latest
    steps:
      - name: ðŸšš Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ðŸ”„ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: '8'

      - name: ðŸ“‹ Install Dependencies
        working-directory: ./frontend/apps/website-epic
        run: pnpm install

      - name: ðŸ”¨ Build Application
        working-directory: ./frontend/apps/website-epic
        run: pnpm build

      - name: ðŸ“¸ Visual Regression Tests
        working-directory: ./frontend/apps/website-epic
        run: |
          # Install visual regression tools
          npm install -g backstopjs

          # Create backstop config
          cat > backstop.json << EOF
          {
            "id": "aigestion",
            "viewports": [
              {
                "label": "desktop",
                "width": 1200,
                "height": 800
              },
              {
                "label": "mobile",
                "width": 375,
                "height": 667
              }
            ],
            "scenarios": [
              {
                "label": "Homepage",
                "url": "http://localhost:4173",
                "referenceUrl": "",
                "readyEvent": "",
                "readySelector": "",
                "delay": 1000,
                "hideSelectors": [],
                "removeSelectors": [],
                "hoverSelector": "",
                "clickSelector": "",
                "postInteractionWait": "",
                "selectors": [],
                "selectorExpansion": true,
                "expect": 0,
                "misMatchThreshold": 0.1,
                "requireSameDimensions": true
              }
            ],
            "paths": {
              "bitmaps_reference": "backstop_data/bitmaps_reference",
              "bitmaps_test": "backstop_data/bitmaps_test",
              "html_report": "backstop_data/html_report",
              "ci_report": "backstop_data/ci_report"
            },
            "engine": "puppeteer",
            "engineOptions": {
              "args": ["--no-sandbox"]
            },
            "report": ["browser", "CI"],
            "debug": false
          }
          EOF

          # Start preview server
          pnpm preview &
          sleep 15

          # Run visual regression tests
          npx backstop test || true

      - name: ðŸ“¤ Upload Visual Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-regression-${{ github.run_number }}
          path: ./frontend/apps/website-epic/backstop_data/

  # ðŸ§ª Integration Testing
  integration-tests:
    name: ðŸ”— Integration Tests
    runs-on: ubuntu-latest
    services:
      supabase:
        image: supabase/postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: ðŸšš Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ðŸ”„ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: '8'

      - name: ðŸ“‹ Install Dependencies
        working-directory: ./frontend/apps/website-epic
        run: pnpm install

      - name: ðŸ”— Run Integration Tests
        working-directory: ./frontend/apps/website-epic
        run: |
          # Set test environment
          export VITE_SUPABASE_URL=http://localhost:5432
          export VITE_SUPABASE_ANON_KEY=test_key

          # Run integration tests
          pnpm test:integration || true
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db

  # ðŸ“Š Test Summary
  test-summary:
    name: ðŸ“Š Test Summary
    needs: [unit-tests, component-tests, e2e-tests, visual-regression, integration-tests]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“Š Generate Test Summary
        run: |
          cat > test-summary.md << EOF
          # ðŸ§ª Test Suite Summary

          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Workflow:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ## ðŸ“Š Test Results

          | Test Type | Status | Details |
          |------------|--------|---------|
          | ðŸ§ª Unit Tests | ${{ needs.unit-tests.result }} | Coverage: ${{ needs.unit-tests.outputs.coverage-badge }}% |
          | ðŸŽ­ Component Tests | ${{ needs.component-tests.result }} | Component validation |
          | ðŸŒ E2E Tests | ${{ needs.e2e-tests.result }} | End-to-end scenarios |
          | ðŸ“± Visual Regression | ${{ needs.visual-regression.result }} | UI consistency |
          | ðŸ”— Integration Tests | ${{ needs.integration-tests.result }} | Service integration |

          ## ðŸ“ˆ Overall Status
          ${{ contains(needs.*.result, 'failure') && 'âŒ Some tests failed' || 'âœ… All tests passed' }}

          ## ðŸ”— Links
          - [Unit Test Coverage](https://codecov.io/gh/${{ github.repository }})
          - [Component Screenshots](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [E2E Test Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [Visual Regression Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ---
          *Generated by GitHub Actions*
          EOF

      - name: ðŸ“¤ Upload Summary
        uses: actions/upload-artifact@v4
        with:
          name: test-summary-${{ github.run_number }}
          path: test-summary.md

      - name: ðŸ“§ Summary Comment
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('test-summary.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
