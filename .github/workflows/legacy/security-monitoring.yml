name: ğŸ”’ Security & Monitoring

on:
  schedule:
    - cron: '0 2 * * *' # Daily at 2 AM UTC
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read
  issues: write
  pull-requests: write

jobs:
  # ğŸ” Security Scanning
  security-scan:
    name: ğŸ” Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: ğŸšš Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ğŸ“Š Upload Trivy Scan Results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: ğŸ” CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          languages: javascript

      - name: ğŸ” OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: 'https://aigestion.net'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'

  # ğŸ“Š Performance Monitoring
  performance-monitor:
    name: ğŸ“Š Performance Monitor
    runs-on: ubuntu-latest
    steps:
      - name: ğŸšš Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŒ Web Vitals Monitoring
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            https://aigestion.net
            https://aigestion.net/about
          configPath: './lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: ğŸ“Š Performance Budget Check
        run: |
          # Check if bundle sizes are within limits
          BUNDLE_SIZE_LIMIT_KB=500
          ACTUAL_SIZE=$(du -k ./frontend/apps/website-epic/dist/assets/index-*.js | cut -f1)

          if [ $ACTUAL_SIZE -gt $BUNDLE_SIZE_LIMIT_KB ]; then
            echo "âŒ Bundle size $ACTUAL_SIZE KB exceeds limit of $BUNDLE_SIZE_LIMIT_KB KB"
            exit 1
          else
            echo "âœ… Bundle size $ACTUAL_SIZE KB is within limits"
          fi

  # ğŸ” Dependency Health
  dependency-health:
    name: ğŸ” Dependency Health
    runs-on: ubuntu-latest
    steps:
      - name: ğŸšš Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ğŸ”„ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: '8'

      - name: ğŸ“‹ Install Dependencies
        working-directory: ./frontend/apps/website-epic
        run: pnpm install

      - name: ğŸ” Outdated Dependencies Check
        working-directory: ./frontend/apps/website-epic
        run: |
          pnpm outdated --format=list > outdated-deps.txt || true
          if [ -s outdated-deps.txt ]; then
            echo "âš ï¸ Outdated dependencies found:"
            cat outdated-deps.txt
          else
            echo "âœ… All dependencies are up to date"
          fi

      - name: ğŸ”’ Security Audit
        working-directory: ./frontend/apps/website-epic
        run: pnpm audit --audit-level moderate

      - name: ğŸ“Š Create Dependency Report
        run: |
          echo "# Dependency Health Report" > dependency-report.md
          echo "Generated: $(date)" >> dependency-report.md
          echo "" >> dependency-report.md
          echo "## Security Audit" >> dependency-report.md
          echo '```' >> dependency-report.md
          cd frontend/apps/website-epic && pnpm audit --json >> ../../dependency-report.md || true
          echo '```' >> dependency-report.md

      - name: ğŸ“¤ Upload Dependency Report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report
          path: dependency-report.md

  # ğŸ“ˆ Uptime Monitoring
  uptime-monitor:
    name: ğŸ“ˆ Uptime Monitor
    runs-on: ubuntu-latest
    steps:
      - name: ğŸŒ Check Website Uptime
        run: |
          # Check main site
          response=$(curl -s -o /dev/null -w "%{http_code}" https://aigestion.net)
          if [ $response -eq 200 ]; then
            echo "âœ… aigestion.net is UP (HTTP $response)"
          else
            echo "âŒ aigestion.net is DOWN (HTTP $response)"
            exit 1
          fi

          # Check GitHub Pages
          response=$(curl -s -o /dev/null -w "%{http_code}" https://aigestion.github.io/aigestion/)
          if [ $response -eq 200 ]; then
            echo "âœ… GitHub Pages is UP (HTTP $response)"
          else
            echo "âŒ GitHub Pages is DOWN (HTTP $response)"
            exit 1
          fi

      - name: ğŸ“Š Performance Metrics
        run: |
          # Measure page load time
          start_time=$(date +%s%N)
          curl -s https://aigestion.net > /dev/null
          end_time=$(date +%s%N)

          load_time=$((($end_time - $start_time) / 1000000))
          echo "ğŸ“Š Page load time: ${load_time}ms"

          if [ $load_time -gt 3000 ]; then
            echo "âš ï¸ Slow load time detected (>3s)"
          else
            echo "âœ… Load time is acceptable"
          fi

  # ğŸš¨ Alert on Issues
  alert-on-issues:
    name: ğŸš¨ Alert on Issues
    needs: [security-scan, performance-monitor, dependency-health, uptime-monitor]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“§ Create Issue for Security Problems
        if: needs.security-scan.result == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ Security Scan Failed',
              body: 'Security scan detected vulnerabilities. Please review the workflow run and fix the issues.',
              labels: ['security', 'urgent']
            })

      - name: ğŸ“§ Create Issue for Performance Problems
        if: needs.performance-monitor.result == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'âš ï¸ Performance Issues Detected',
              body: 'Performance monitoring detected issues. Please review Lighthouse reports and optimize.',
              labels: ['performance', 'enhancement']
            })

      - name: ğŸ“§ Create Issue for Uptime Problems
        if: needs.uptime-monitor.result == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ Website Down',
              body: 'Uptime monitoring detected that the website is down. Immediate attention required.',
              labels: ['urgent', 'bug']
            })
