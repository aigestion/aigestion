name: ğŸš€ CI/CD Pipeline Mejorado

on:
  push:
    branches: [ main, develop, staging]
  pull_request:
    branches: [ main, develop]
  release:
    types: [published]

env:
  NODE_VERSION: '22'
  CACHE_VERSION: 'v2'

permissions:
  contents: read
  packages: write
  pages: write
  id-token: write
  deployments: write
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # AnÃ¡lisis de cÃ³digo y seguridad
  code-analysis:
    name: ğŸ” AnÃ¡lisis de CÃ³digo
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/website-epic/package-lock.json

      - name: ğŸ“¦ Install Dependencies
        run: |
          cd frontend/website-epic
          npm ci

      - name: ğŸ” Type Check
        run: |
          cd frontend/website-epic
          npm run type-check

      - name: ğŸ§¹ Lint Code
        run: |
          cd frontend/website-epic
          npm run lint

      - name: ğŸ”’ Security Scan
        uses: securecodewarrior/github-action-add-sarif@v1
        with:
          sarif-file: 'frontend/website-epic/security-scan-results.sarif'

      - name: ğŸ“Š Complexity Analysis
        run: |
          cd frontend/website-epic
          npx complexity-report --output json --format json src/ > complexity-report.json

      - name: ğŸ“ˆ Bundle Analysis
        run: |
          cd frontend/website-epic
          npm run build
          npx webpack-bundle-analyzer dist/static/js/*.js --mode json > bundle-analysis.json

  # Tests automatizados
  tests:
    name: ğŸ§ª Tests Automatizados
    runs-on: ubuntu-latest
    needs: code-analysis
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/website-epic/package-lock.json

      - name: ğŸ“¦ Install Dependencies
        run: |
          cd frontend/website-epic
          npm ci

      - name: ğŸ§ª Unit Tests
        run: |
          cd frontend/website-epic
          npm run test:run

      - name: ğŸ“Š Coverage Report
        run: |
          cd frontend/website-epic
          npm run test:coverage

      - name: ğŸ“‹ Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: frontend/website-epic/coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

      - name: ğŸ­ Component Tests
        run: |
          cd frontend/website-epic
          npm run test -- --coverage --watchAll=false

      - name: ğŸ“ E2E Tests
        run: |
          cd frontend/website-epic
          npm run build
          npm run test:e2e

  # Build y optimizaciÃ³n
  build:
    name: ğŸ—ï¸ Build y OptimizaciÃ³n
    runs-on: ubuntu-latest
    needs: [code-analysis, tests]
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/website-epic/package-lock.json

      - name: ğŸ“¦ Install Dependencies
        run: |
          cd frontend/website-epic
          npm ci

      - name: ğŸ—ï¸ Build Production
        run: |
          cd frontend/website-epic
          npm run build

      - name: ğŸ“Š Bundle Analysis
        run: |
          cd frontend/website-epic
          npx bundlesize

      - name: ğŸ“ˆ Performance Budget Check
        run: |
          cd frontend/website-epic
          node scripts/check-bundle-size.js

      - name: ğŸ“¦ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: frontend/website-epic/dist/
          retention-days: 30

  # Deploy a staging
  deploy-staging:
    name: ğŸš€ Deploy Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: https://staging.aigestion.net
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: frontend/website-epic/dist/

      - name: ğŸš€ Deploy to Staging
        run: |
          echo "Deploying to staging environment"
          # AquÃ­ irÃ­a el deploy a staging (Vercel, Netlify, etc.)

      - name: ğŸ§ª Run Staging Tests
        run: |
          echo "Running staging smoke tests"
          # Tests automatizados en staging

  # Deploy a producciÃ³n
  deploy-production:
    name: ğŸš€ Deploy ProducciÃ³n
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://aigestion.net
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: frontend/website-epic/dist/

      - name: ğŸ”§ Setup Pages
        uses: actions/configure-pages@v4

      - name: ğŸ“¤ Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: frontend/website-epic/dist/

      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ğŸ“Š Performance Monitoring
        run: |
          echo "Deployed to production"
          curl -s "https://aigestion.net" > /dev/null && echo "âœ… Site is live" || echo "âŒ Site not responding"

      - name: ğŸ“§ Notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          text: |
            ğŸš€ Deploy AIGestion.net
            Status: ${{ job.status }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            URL: https://aigestion.net

  # Tests post-deploy
  post-deploy-tests:
    name: ğŸ§ª Tests Post-Deploy
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.ref == 'refs/heads/main'
    steps:
      - name: ğŸŒ Health Check
        run: |
          echo "Checking production health..."
          curl -f https://aigestion.net/api/health || exit 1

      - name: ğŸ“Š Performance Test
        run: |
          echo "Running performance tests..."
          npx lighthouse https://aigestion.net --output=json --output-path=lighthouse-results.json

      - name: ğŸ” Security Scan
        run: |
          echo "Running security scan..."
          npx zap-baseline.py -t https://aigestion.net -J zap-results.json

      - name: ğŸ“‹ Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: post-deploy-results
          path: |
            lighthouse-results.json
            zap-results.json

  # Release automation
  release:
    name: ğŸ‰ Release Automation
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    needs: [build]
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Create Release Notes
        run: |
          echo "Creating release notes for ${{ github.ref_name }}"

      - name: ğŸ“¦ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: frontend/website-epic/dist/

      - name: ğŸ“¤ Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          files: frontend/website-epic/dist/**/*
          draft: false
          prerelease: false

  # Rollback automÃ¡tico
  rollback:
    name: ğŸ”„ Rollback AutomÃ¡tico
    runs-on: ubuntu-latest
    if: failure() && needs.deploy-production.result == 'failure'
    needs: deploy-production
    steps:
      - name: ğŸ”„ Rollback Deployment
        run: |
          echo "Rolling back to previous version"
          # LÃ³gica de rollback aquÃ­

      - name: ğŸ“§ Rollback Notification
        uses: 8398a7/action-slack@v3
        with:
          status: 'failure'
          channel: '#deployments'
          text: |
            ğŸ”„ Rollback AIGestion.net
            Reason: Deploy failed
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
