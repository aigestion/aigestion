name: ğŸš€ GitHub God Mode â€” Sovereign Orchestrator

on:
  push:
    branches: [main, develop, staging, production]
  pull_request:
    branches: [main, develop]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'packages/**'
      - '.github/workflows/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
  release:
    types: [published, created, edited]
  schedule:
    # Run every day at 14:04 CET (13:04 UTC)
    - cron: '4 13 * * *'
  workflow_dispatch:
    inputs:
      action_type:
        description: 'Type of action to perform'
        required: true
        default: 'full-suite'
        type: choice
        options:
          - full-suite
          - security-only
          - performance-only
          - vercel-deploy
          - railway-deploy
          - gcp-deploy
          - cleanup-only
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - preview
          - staging
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  packages: write
  pages: write
  id-token: write
  deployments: write
  security-events: write
  actions: read
  checks: write
  pull-requests: write
  issues: write
  discussions: write
  statuses: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â”€â”€â”€ ğŸ—ï¸ CI: Build & Analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ci:
    uses: ./.github/workflows/ci.yml
    with:
      force_deploy: ${{ inputs.force_deploy || false }}
    secrets:
      VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
      VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
      VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # â”€â”€â”€ ğŸ”’ Security Scan Suite â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  security:
    needs: ci
    uses: ./.github/workflows/security.yml
    secrets:
      GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # â”€â”€â”€ ğŸš€ Vercel Deploy (Canary â†’ Production) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-vercel:
    needs: [ci, security]
    uses: ./.github/workflows/deploy-vercel.yml
    with:
      deploy-approved: ${{ needs.ci.outputs.deploy-approved }}
    secrets:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

  # â”€â”€â”€ ğŸ—ï¸ Infrastructure Deploy (Railway / GCP) â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-infra:
    needs: [ci, security]
    uses: ./.github/workflows/deploy-infra.yml
    with:
      action_type: ${{ inputs.action_type || 'full-suite' }}
    secrets:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      GCP_WID_PROVIDER: ${{ secrets.GCP_WID_PROVIDER }}
      GCP_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      REDIS_URL: ${{ secrets.REDIS_URL }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}

  # â”€â”€â”€ ğŸ¤– Automation (PR Insights, Releases, Perf) â”€â”€â”€â”€â”€â”€
  automation:
    needs: ci
    uses: ./.github/workflows/automation.yml
    secrets:
      LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
