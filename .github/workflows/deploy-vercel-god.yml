name: 🚀 DEPLOY TO VERCEL - GOD MODE

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: 'vercel-deploy'
  cancel-in-progress: false

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ steps.deploy.outputs.preview-url }}

    steps:
      - name: 🚀 GOD MODE INIT
        run: |
          echo "🌌 INITIALIZING VERCEL GOD MODE DEPLOYMENT"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Time: $(date)"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

      - name: 📥 CHECKOUT REPOSITORY
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🟢 SETUP NODE.JS 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      - name: 📦 INSTALL & BUILD DEPENDENCIES
        run: |
          echo "📦 Installing Design System dependencies..."
          cd packages/design-system-v2
          npm install

          echo "🔨 Building Design System..."
          npm run build
          cd ../..

      - name: 🔧 BUILD WEBSITE - GOD MODE
        run: |
          echo "🔧 BUILDING WEBSITE - GOD MODE"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          echo "📦 Installing Website dependencies..."
          cd frontend/website-epic
          npm install

          # Set production environment
          export NODE_ENV=production
          export VITE_SUPABASE_URL="https://T8jp4wZKQU1l5WQHSHoM1g_w1mvEbx1.supabase.co"
          export VITE_SUPABASE_ANON_KEY="sb_publishable_CqCI6d-vk4X6vlsOL69g_Q_BYH5K4yG"
          export VITE_SUPABASE_SERVICE_ROLE_KEY="$VITE_SUPABASE_SERVICE_ROLE_KEY"
          export VITE_ELEVENLABS_API_KEY="$VITE_ELEVENLABS_API_KEY"
          export VITE_VAPI_PUBLIC_KEY="$VITE_VAPI_PUBLIC_KEY"
          export VITE_VAPI_PRIVATE_KEY="$VITE_VAPI_PRIVATE_KEY"
          export VITE_TWILIO_ACCOUNT_SID="$VITE_TWILIO_ACCOUNT_SID"
          export VITE_TWILIO_AUTH_TOKEN="$VITE_TWILIO_AUTH_TOKEN"
          export VITE_TWILIO_RECOVERY_CODE="$VITE_TWILIO_RECOVERY_CODE"
          export VITE_API_BASE_URL="/api"

          echo "🔨 Building Website..."
          npm run build > ../../website_build.log 2>&1 || { echo "❌ Website Build Failed" ; cat ../../website_build.log ; exit 1; }
          cd ../..

      - name: 🚨 DEBUG - COMMIT LOGS ON FAILURE
        if: failure()
        run: |
          echo "🚨 Workflow Failed! Committing logs..."
          git config --global user.name "God Mode Debugger"
          git config --global user.email "debugger@aigestion.net"
          git add website_build.log || true
          git commit -m "chore(debug): upload build logs for analysis" || true
          git push origin main || true

          echo "✅ Build completed"
          echo "📊 Build artifacts:"
          ls -la frontend/website-epic/dist/
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

      - name: 📤 PREPARE DEPLOYMENT ARTIFACTS
        run: |
          echo "📤 Preparing deployment artifacts..."

          # Create nested directory structure to match vercel.json outputDirectory
          mkdir -p vercel-deploy/frontend/website-epic/dist

          # Copy all frontend files to the expected directory
          cp -r frontend/website-epic/dist/* vercel-deploy/frontend/website-epic/dist/



          # Copy root vercel.json if exists
          if [ -f vercel.json ]; then
            echo "📄 Using repository vercel.json"
            cp vercel.json vercel-deploy/
          else
            echo "❌ vercel.json not found in root!"
            ls -la
            exit 1
          fi

          echo "✅ Deployment artifacts prepared"

          echo "✅ Deployment artifacts prepared"
          echo "📁 Deployment directory contents:"
          ls -la vercel-deploy/
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

      - name: 🔑 SETUP VERCEL CLI
        run: |
          echo "🔑 Setting up Vercel CLI..."
          npm install --global vercel@latest
          echo "✅ Vercel CLI installed"

      - name: 🚀 DEPLOY TO VERCEL - GOD MODE
        id: deploy
        run: |
          echo "🚀 DEPLOYING TO VERCEL - GOD MODE"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          cd vercel-deploy

          # Deploy to Vercel
          echo "🌐 Deploying to Vercel..."
          vercel --prod --token ${{ secrets.VERCEL_TOKEN }} --confirm

          # Get deployment URL
          DEPLOYMENT_URL=$(vercel ls --token ${{ secrets.VERCEL_TOKEN }} --scope ${{ secrets.VERCEL_ORG_ID }} | grep website-epic | head -1 | awk '{print $3}')

          echo "✅ Deployment completed"
          echo "🌐 Deployment URL: $DEPLOYMENT_URL"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          # Set output for GitHub
          echo "preview-url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "DEPLOYMENT_URL=$DEPLOYMENT_URL" >> $GITHUB_ENV

      - name: 📊 DEPLOYMENT SUMMARY
        run: |
          echo "📊 DEPLOYMENT SUMMARY - GOD MODE"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ Status: DEPLOYED"
          echo "🌐 URL: ${{ env.DEPLOYMENT_URL }}"
          echo "🔥 Environment: Production"
          echo "🚀 Framework: Vite + React"
          echo "🌌 Supabase: Divine Mode Active"
          echo "⚡ Vercel: Supreme Configuration"
          echo "📊 Analytics: Enabled"
          echo "🔒 Security: Maximum Level"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

      - name: 🧪 HEALTH CHECK
        run: |
          echo "🧪 Running health check..."
          sleep 10

          if curl -f -s "${{ env.DEPLOYMENT_URL }}" > /dev/null; then
            echo "✅ Health check passed"
          else
            echo "❌ Health check failed"
            exit 1
          fi

      - name: 🎉 SUCCESS NOTIFICATION
        run: |
          echo "🎉 VERCEL GOD MODE DEPLOYMENT SUCCESSFUL!"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "🌐 Website: ${{ env.DEPLOYMENT_URL }}"
          echo "🔥 Status: PRODUCTION READY"
          echo "🌌 Supabase: DIVINE MODE"
          echo "⚡ Vercel: SUPREME LEVEL"
          echo "🚀 AIGestion.net: READY FOR GODS"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
