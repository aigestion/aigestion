name: ðŸš€ [DISABLED] AIGestion CI/CD Pipeline - Daniela AI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  release:
    types: [published]

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  # Backend Tests
  backend-tests:
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ping: 1})'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        working-directory: ./backend
        run: pnpm install --frozen-lockfile

      - name: Run linting
        working-directory: ./backend
        run: pnpm run lint

      - name: Run type checking
        working-directory: ./backend
        run: pnpm run type-check

      - name: Run unit tests
        working-directory: ./backend
        run: pnpm run test:unit
        env:
          MONGODB_URI: mongodb://localhost:27017/test
          REDIS_URL: redis://localhost:6379

      - name: Run integration tests
        working-directory: ./backend
        run: pnpm run test:integration
        env:
          MONGODB_URI: mongodb://localhost:27017/test
          REDIS_URL: redis://localhost:6379

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./backend/coverage/lcov.info
          flags: backend

  # Frontend Tests
  frontend-tests:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        app: [website-epic, admindashboard, clientdashboard, demodashboard]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        working-directory: ./frontend
        run: pnpm install --frozen-lockfile

      - name: Run linting
        working-directory: ./frontend/apps/${{ matrix.app }}
        run: pnpm run lint

      - name: Run type checking
        working-directory: ./frontend/apps/${{ matrix.app }}
        run: pnpm run type-check

      - name: Run unit tests
        working-directory: ./frontend/apps/${{ matrix.app }}
        run: pnpm run test:unit

      - name: Build application
        working-directory: ./frontend/apps/${{ matrix.app }}
        run: pnpm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: frontend-build-${{ matrix.app }}
          path: frontend/apps/${{ matrix.app }}/dist

  # E2E Tests
  e2e-tests:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        working-directory: ./frontend
        run: pnpm install --frozen-lockfile

      - name: Install Playwright
        run: pnpm exec playwright install --with-deps

      - name: Build applications
        working-directory: ./frontend
        run: pnpm run build:all

      - name: Start services
        run: |
          cd backend
          pnpm run build
          pnpm start &
          sleep 10

      - name: Start frontend
        run: |
          cd frontend/apps/website-epic
          pnpm preview &
          sleep 5

      - name: Run E2E tests
        working-directory: ./frontend/apps/website-epic
        run: pnpm run test:e2e

      - name: Upload E2E test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: e2e-test-results
          path: frontend/apps/website-epic/playwright-report

  # Security Audit
  security-audit:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Audit backend dependencies
        working-directory: ./backend
        run: pnpm audit --audit-level moderate

      - name: Audit frontend dependencies
        working-directory: ./frontend
        run: pnpm audit --audit-level moderate

      - name: Run security tests
        working-directory: ./backend
        run: pnpm run test:security

  # Performance Tests
  performance-tests:
    runs-on: ubuntu-latest
    needs: [e2e-tests]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        working-directory: ./frontend
        run: pnpm install --frozen-lockfile

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.12.x

      - name: Build applications
        working-directory: ./frontend
        run: pnpm run build:all

      - name: Start applications
        run: |
          cd backend
          pnpm start &
          cd ../frontend/apps/website-epic
          pnpm preview &
          sleep 15

      - name: Run Lighthouse CI
        run: |
          lhci autorun
          lhci upload --target=temporary-public-storage

  # Deploy to Staging
  deploy-staging:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, e2e-tests, security-audit]
    if: github.ref == 'refs/heads/develop'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Vercel Staging
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--scope aigestion-staging'
          working-directory: ./frontend

      - name: Deploy Backend to Render Staging
        uses: johnbeynon/render-deploy-action@v0.0.8
        with:
          service-id: ${{ secrets.RENDER_SERVICE_ID }}
          api-key: ${{ secrets.RENDER_API_KEY }}
          env-vars: |
            NODE_ENV=staging
            MONGODB_URI=${{ secrets.STAGING_MONGODB_URI }}
            REDIS_URL=${{ secrets.STAGING_REDIS_URL }

  # Deploy to Production
  deploy-production:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, e2e-tests, security-audit, performance-tests]
    if: github.event_name == 'release'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Vercel Production
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./frontend

      - name: Deploy Backend to Render Production
        uses: johnbeynon/render-deploy-action@v0.0.8
        with:
          service-id: ${{ secrets.RENDER_SERVICE_ID }}
          api-key: ${{ secrets.RENDER_API_KEY }}
          env-vars: |
            NODE_ENV=production
            MONGODB_URI=${{ secrets.PRODUCTION_MONGODB_URI }}
            REDIS_URL=${{ secrets.PRODUCTION_REDIS_URL }}

      - name: Run smoke tests
        run: |
          curl -f https://aigestion.net/api/v1/health || exit 1
          curl -f https://admin.aigestion.net/api/v1/health || exit 1
          curl -f https://client.aigestion.net/api/v1/health || exit 1

      - name: Notify deployment success
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          message: 'ðŸš€ Daniela AI deployed to production successfully!'

  # Quality Gates
  quality-gates:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, e2e-tests, security-audit]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "Backend tests: ${{ needs.backend-tests.result }}"
          echo "Frontend tests: ${{ needs.frontend-tests.result }}"
          echo "E2E tests: ${{ needs.e2e-tests.result }}"
          echo "Security audit: ${{ needs.security-audit.result }}"

      - name: Quality gate check
        run: |
          if [[ "${{ needs.backend-tests.result }}" != "success" ]]; then
            echo "âŒ Backend tests failed"
            exit 1
          fi

          if [[ "${{ needs.frontend-tests.result }}" != "success" ]]; then
            echo "âŒ Frontend tests failed"
            exit 1
          fi

          if [[ "${{ needs.e2e-tests.result }}" != "success" ]]; then
            echo "âŒ E2E tests failed"
            exit 1
          fi

          if [[ "${{ needs.security-audit.result }}" != "success" ]]; then
            echo "âŒ Security audit failed"
            exit 1
          fi

          echo "âœ… All quality gates passed!"

  # Release Notes
  release-notes:
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: github.event_name == 'release'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate release notes
        run: |
          # Extract version from package.json
          VERSION=$(node -p "require('./package.json').version")

          # Get commit messages since last release
          COMMITS=$(git log --pretty=format:"- %s" $(git describe --tags --abbrev=0)..HEAD)

          # Generate release notes
          cat > release-notes.md << EOF
          # Daniela AI v$VERSION Release Notes

          ## ðŸš€ What's New

          $COMMITS

          ## ðŸ› Bug Fixes
          - Various performance improvements
          - Enhanced error handling
          - Security updates

          ## ðŸ“ˆ Improvements
          - Better emotional analysis accuracy
          - Faster response times
          - Enhanced user experience

          ## ðŸ”§ Technical Details
          - Updated dependencies
          - Improved test coverage
          - Enhanced monitoring

          ---

          **Full Changelog**: https://github.com/aigestion/daniela-ai/compare/v${{VERSION}...main
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-notes.md
          body_path: release-notes.md
          draft: false
          prerelease: false

  # Notification
  notify:
    runs-on: ubuntu-latest
    needs: [quality-gates, deploy-production]
    if: always()

    steps:
      - name: Notify on success
        if: needs.quality-gates.result == 'success' && needs.deploy-production.result == 'success'
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          message: 'ðŸŽ‰ Daniela AI pipeline completed successfully! All tests passed and deployed to production.'

      - name: Notify on failure
        if: needs.quality-gates.result == 'failure' || needs.deploy-production.result == 'failure'
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          message: 'âŒ Daniela AI pipeline failed. Please check the logs and fix the issues.'
