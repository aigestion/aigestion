name: ðŸš€ Vercel God Mode - Deploy Supremo

on:
  push:
    branches: [main, develop, staging]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - preview
          - staging
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        default: false
        type: boolean

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  NODE_VERSION: '22'

jobs:
  # ðŸ” PRE-DEPLOYMENT ANALYSIS
  pre-deploy-analysis:
    name: ðŸ” Pre-Deployment Analysis
    runs-on: ubuntu-latest
    outputs:
      bundle-size: ${{ steps.bundle.outputs.size }}
      performance-score: ${{ steps.perf.outputs.score }}
      security-status: ${{ steps.security.outputs.status }}
      deploy-approved: ${{ steps.decision.outputs.approved }}

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build Application
        run: npm run build

      - name: ðŸ“Š Bundle Size Analysis
        id: bundle
        run: |
          cd frontend/website-epic
          SIZE=$(du -sh dist | cut -f1)
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "Bundle size: $SIZE"

      - name: âš¡ Performance Score
        id: perf
        run: |
          cd frontend/website-epic
          npx lighthouse dist/index.html --output=json --quiet > lighthouse.json
          SCORE=$(cat lighthouse.json | jq '.lhr.categories.performance.score * 100 | floor')
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "Performance score: $SCORE"

      - name: ðŸ”’ Security Check
        id: security
        run: |
          npm audit --audit-level=high --json > audit.json || echo "high" > security-status
          if [ -f audit.json ]; then
            STATUS=$(cat audit.json | jq -r '.metadata.vulnerabilities.total')
            if [ "$STATUS" -eq 0 ]; then
              echo "status=passed" >> $GITHUB_OUTPUT
            else
              echo "status=failed" >> $GITHUB_OUTPUT
            fi
          else
            echo "status=passed" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ¤– Deployment Decision
        id: decision
        run: |
          PERF_SCORE=${{ steps.perf.outputs.score }}
          SECURITY=${{ steps.security.outputs.status }}
          FORCE=${{ github.event.inputs.force_deploy || 'false' }}
          
          if [ "$FORCE" = "true" ]; then
            echo "approved=true" >> $GITHUB_OUTPUT
            echo "âœ… Force deployment approved"
          elif [ "$PERF_SCORE" -gt 80 ] && [ "$SECURITY" = "passed" ]; then
            echo "approved=true" >> $GITHUB_OUTPUT
            echo "âœ… Deployment approved"
          else
            echo "approved=false" >> $GITHUB_OUTPUT
            echo "âŒ Deployment blocked"
          fi

  # ðŸš€ VERCEL DEPLOYMENT
  vercel-deploy:
    name: ðŸš€ Vercel Deployment
    runs-on: ubuntu-latest
    needs: pre-deploy-analysis
    if: needs.pre-deploy-analysis.outputs.deploy-approved == 'true'
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ steps.deploy.outputs.preview-url }}

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build Application
        run: npm run build

      - name: ðŸš€ Deploy to Vercel
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: frontend/website-epic

      - name: ðŸ“Š Deployment Summary
        run: |
          echo "## ðŸš€ Vercel Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Preview URL:** ${{ steps.deploy.outputs.preview-url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Bundle Size:** ${{ needs.pre-deploy-analysis.outputs.bundle-size }}" >> $GITHUB_STEP_SUMMARY
          echo "**Performance Score:** ${{ needs.pre-deploy-analysis.outputs.performance-score }}" >> $GITHUB_STEP_SUMMARY
          echo "**Security Status:** ${{ needs.pre-deploy-analysis.outputs.security-status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY

  # ðŸ” POST-DEPLOYMENT VALIDATION
  post-deploy-validation:
    name: ðŸ” Post-Deployment Validation
    runs-on: ubuntu-latest
    needs: vercel-deploy
    if: always() && needs.vercel-deploy.result == 'success'

    steps:
      - name: â±ï¸ Wait for Deployment
        run: sleep 30

      - name: ðŸ” Health Check
        run: |
          URL="${{ needs.vercel-deploy.outputs.preview-url }}"
          for i in {1..10}; do
            if curl -f "$URL/api/health" > /dev/null 2>&1; then
              echo "âœ… Health check passed"
              break
            else
              echo "â³ Waiting for deployment... ($i/10)"
              sleep 10
            fi
          done

      - name: âš¡ Performance Test
        run: |
          npx lighthouse "${{ needs.vercel-deploy.outputs.preview-url }}" \
            --output=json \
            --output-path=lighthouse-post-deploy.json \
            --quiet

      - name: ðŸ“Š Performance Report
        run: |
          PERF=$(cat lighthouse-post-deploy.json | jq '.lhr.categories.performance.score * 100 | floor')
          echo "## ðŸ“Š Post-Deployment Performance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Performance Score:** $PERF/100" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** $([ "$PERF" -gt 80 ] && echo "âœ… Excellent" || echo "âš ï¸ Needs Optimization")" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ”’ Security Scan
        run: |
          npx zap-baseline.py -t "${{ needs.vercel-deploy.outputs.preview-url }}" \
            -J zap-report.json \
            --quiet || true

      - name: ðŸ“ˆ Analytics Integration Test
        run: |
          curl -X POST "${{ needs.vercel-deploy.outputs.preview-url }}/api/analytics/test" \
            -H "Content-Type: application/json" \
            -d '{"event": "deployment_test", "data": {"timestamp": "'$(date -u)'"}}' \
            || echo "Analytics endpoint not available"

  # ðŸ“¢ NOTIFICATIONS
  notifications:
    name: ðŸ“¢ Smart Notifications
    runs-on: ubuntu-latest
    needs: [pre-deploy-analysis, vercel-deploy, post-deploy-validation]
    if: always()

    steps:
      - name: ðŸ“§ Slack Notification
        if: always()
        run: |
          STATUS="âœ… Success"
          if [ "${{ needs.vercel-deploy.result }}" != "success" ]; then
            STATUS="âŒ Failed"
          fi
          
          echo "## ðŸš€ AIGestion Deployment $STATUS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Bundle Size:** ${{ needs.pre-deploy-analysis.outputs.bundle-size }}" >> $GITHUB_STEP_SUMMARY
          echo "**Performance:** ${{ needs.pre-deploy-analysis.outputs.performance-score }}/100" >> $GITHUB_STEP_SUMMARY
          echo "**Security:** ${{ needs.pre-deploy-analysis.outputs.security-status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment URL:** ${{ needs.vercel-deploy.outputs.preview-url }}" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“Š Update Deployment Metrics
        run: |
          echo "Deployment metrics updated successfully"
          # Add your metrics tracking logic here

  # ðŸ§¹ CLEANUP
  cleanup:
    name: ðŸ§¹ Cleanup & Optimization
    runs-on: ubuntu-latest
    needs: [vercel-deploy, post-deploy-validation]
    if: always() && needs.vercel-deploy.result == 'success'

    steps:
      - name: ðŸ§¹ Clean Old Deployments
        run: |
          echo "Cleaning up old deployments..."
          # Add cleanup logic here

      - name: ðŸ“Š Cache Optimization
        run: |
          echo "Optimizing cache..."
          # Add cache optimization logic here

      - name: ðŸ”„ Update CDN
        run: |
          echo "Updating CDN configuration..."
          # Add CDN update logic here
