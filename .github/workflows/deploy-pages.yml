name: ðŸš€ Deploy to GitHub Pages - God Mode Optimized

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - preview
          - staging
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  pages: write
  id-token: write
  actions: read
  checks: write

concurrency:
  group: 'pages'
  cancel-in-progress: false

env:
  NODE_VERSION: '22'
  PNPM_VERSION: '9'

jobs:
  # ðŸ” PRE-DEPLOY VALIDATION
  pre-deploy:
    name: ðŸ” Pre-Deploy Validation
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.decision.outputs.should-deploy }}
      build-cache-hit: ${{ steps.cache.outputs.cache-hit }}

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: './frontend/apps/website-epic/pnpm-lock.yaml'

      - name: ðŸ” Security Scan
        run: |
          echo "ðŸ” Running security scan..."
          cd frontend/apps/website-epic
          # Check for hardcoded secrets
          if grep -rn --include='*.ts' --include='*.tsx' --include='*.js' --include='*.json' \
            -E '(password|secret|api_key|private_key)\s*[:=]\s*["\''']((?!\$\{|process\.env|import\.meta).){8,}' \
            --exclude-dir=node_modules --exclude-dir=dist . 2>/dev/null; then
            echo "âŒ Security scan failed - hardcoded secrets found"
            exit 1
          fi
          echo "âœ… Security scan passed"

      - name: ðŸ“Š Bundle Size Check
        id: cache
        run: |
          cd frontend/apps/website-epic
          CURRENT_BUNDLE=$(find dist/assets -name "*.js" -exec du -ch {} + | sort -rh | head -1 | cut -f1)
          MAX_BUNDLE=$((1024 * 1024)) # 1MB
          if [ "$CURRENT_BUNDLE" -gt "$MAX_BUNDLE" ]; then
            echo "âš ï¸ Bundle size warning: $CURRENT_BUNDLE bytes"
          else
            echo "âœ… Bundle size OK: $CURRENT_BUNDLE bytes"
          fi
          echo "cache-hit=false" >> $GITHUB_OUTPUT

      - name: ðŸ¤– Deploy Decision
        id: decision
        run: |
          FORCE=${{ github.event.inputs.force_deploy || 'false' }}
          IS_MAIN=${{ github.ref == 'refs/heads/main' }}

          if [ "$FORCE" = "true" ] || [ "$IS_MAIN" = "true" ]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… Deployment approved"
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
            echo "ðŸš« Deployment skipped (not main branch)"
          fi

  # ðŸ—ï¸ BUILD & DEPLOY
  build-and-deploy:
    name: ðŸ—ï¸ Build & Deploy
    runs-on: ubuntu-latest
    needs: pre-deploy
    if: needs.pre-deploy.outputs.should-deploy == 'true'
    outputs:
      deployment-url: ${{ steps.deploy.outputs.url }}
      build-time: ${{ steps.build.outputs.time }}
      bundle-size: ${{ steps.analyze.outputs.size }}

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: './frontend/apps/website-epic/pnpm-lock.yaml'

      - name: ðŸ“¦ Install Dependencies
        run: |
          cd frontend/apps/website-epic
          pnpm install --frozen-lockfile

      - name: ðŸ—ï¸ Build Website
        id: build
        run: |
          cd frontend/apps/website-epic
          START_TIME=$(date +%s)
          pnpm run build
          END_TIME=$(date +%s)
          BUILD_TIME=$((END_TIME - START_TIME))
          echo "time=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "âœ… Build completed in ${BUILD_TIME}s"

      - name: ðŸ“Š Bundle Analysis
        id: analyze
        run: |
          cd frontend/apps/website-epic
          TOTAL_SIZE=$(du -sh dist | cut -f1)
          LARGEST_JS=$(find dist/assets -name "*.js" -exec du -ch {} + | sort -rh | head -1)
          JS_COUNT=$(find dist/assets -name "*.js" | wc -l)

          echo "size=$TOTAL_SIZE" >> $GITHUB_OUTPUT
          echo "largest-js=$LARGEST_JS" >> $GITHUB_OUTPUT
          echo "js-count=$JS_COUNT" >> $GITHUB_OUTPUT

          echo "ðŸ“Š Bundle Analysis:"
          echo "Total size: ${TOTAL_SIZE} bytes"
          echo "Largest JS: ${LARGEST_JS} bytes"
          echo "JS files: $JS_COUNT"

      - name: âš™ï¸ Setup Pages
        uses: actions/configure-pages@v4

      - name: ðŸ“¤ Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './frontend/apps/website-epic/dist'
          retention-days: 1

  # ðŸš€ DEPLOY TO PRODUCTION
  deploy:
    name: ðŸš€ Deploy to Production
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ðŸš€ Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4

      - name: ðŸ” Post-Deploy Health Check
        run: |
          sleep 30
          for i in {1..5}; do
            if curl -f https://aigestion.net > /dev/null 2>&1; then
              echo "âœ… Health check passed (attempt $i)"
              break
            else
              echo "â³ Waiting... ($i/5)"
              sleep 10
            fi
          done

  # ðŸ“Š DEPLOYMENT SUMMARY
  deployment-summary:
    name: ðŸ“Š Deployment Summary
    runs-on: ubuntu-latest
    needs: [build-and-deploy, deploy]
    if: always()

    steps:
      - name: ðŸ“‹ Generate Summary
        run: |
          echo "# ðŸš€ AIGestion Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Time**: ${{ needs.build-and-deploy.outputs.build-time }}s" >> $GITHUB_STEP_SUMMARY
          echo "- **Bundle Size**: ${{ needs.build-and-deploy.outputs.bundle-size }} bytes" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment URL**: https://aigestion.net" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Status" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "- **Production**: âœ… Deployed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Production**: âŒ Deployment failed" >> $GITHUB_STEP_SUMMARY
          fi
