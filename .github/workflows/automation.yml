name: ðŸ¤– Automation â€” PR Insights, Releases & Perf

on:
  workflow_call:
    secrets:
      LHCI_GITHUB_APP_TOKEN:
        required: false
      GITHUB_TOKEN:
        required: false
  workflow_dispatch:

env:
  NODE_VERSION: '22'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # âš¡ PERFORMANCE TESTING
  performance-testing:
    name: âš¡ Performance Testing
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: ðŸ“¥ Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: app-dist
          path: frontend/apps/website-epic/dist

      - name: ðŸ“Š Bundle Analysis
        continue-on-error: true
        run: |
          cd frontend/apps/website-epic
          # Try to find the largest JS file in assets/ to analyze
          JS_FILE=$(find dist/assets -name "*.js" | head -n 1)
          if [ -n "$JS_FILE" ]; then
            npx webpack-bundle-analyzer "$JS_FILE" --mode json > bundle-analysis.json
          else
            echo "No JS files found for analysis"
            echo "[]" > bundle-analysis.json
          fi

      - name: âš¡ Performance Budget Check
        continue-on-error: true
        run: |
          cd frontend/apps/website-epic
          node scripts/check-bundle-size.js

      - name: ðŸ” Lighthouse CI
        run: |
          cd frontend/apps/website-epic
          pnpm install -g @lhci/cli@0.12.x
          lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

  # ðŸ¤– AI-POWERED PR INSIGHTS
  ai-pr-insights:
    name: ðŸ¤– AI PR Insights
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ§ª Generate AI Summary
        uses: actions/github-script@v6
        with:
          script: |
            const { data: pullRequest } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
            });
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
            });

            const summary = `
            ## ðŸ¤– AI PR Insights - Sovereign Intelligence

            **PR Title:** ${pullRequest.title}
            **Status:** ðŸš€ God Level Optimization Detected

            ### ðŸ“Š Change Summary:
            - **Files Modified:** ${files.length}
            - **Lines Added:** +${pullRequest.additions}
            - **Lines Removed:** -${pullRequest.deletions}

            ### ðŸ” Quick Audit:
            ${files.map(f => `- \`${f.filename}\`: ${f.status}`).join('\n')}

            ---
            *Generated by Antigravity AI Orchestrator*
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: summary
            });

  # ðŸ† AI-POWERED RELEASE MANAGEMENT
  ai-release-management:
    name: ðŸ† AI Release Management
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸŽ“ Generate Release Notes
        id: release-notes
        uses: actions/github-script@v6
        with:
          script: |
            const commits = await github.rest.repos.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 10
            });
            const notes = commits.data.map(c => `- ${c.commit.message}`).join('\n');
            const releaseBody = `## ðŸš€ New Sovereign Release\n\n### ðŸ§¬ Genetic Updates:\n${notes}\n\n---\n*Orchestrated by Antigravity God Mode*`;

            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: `v${new Date().getTime()}`,
              name: `Sovereign Update ${new Date().toLocaleDateString()}`,
              body: releaseBody
            });

  # ðŸ§¹ CLEANUP
  cleanup:
    name: ðŸ§¹ Cleanup & Optimization
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ðŸ§¹ Clean Cache & Old Runs
        run: |
          echo "ðŸ§¹ Performing God-Level maintenance..."
          gh run delete --all --status completed --limit 5 || true
          echo "âœ… Repository optimized"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
