name: ðŸš€ AIGestion CI/CD - God Mode

on:
  push:
    branches: [main, develop]
    paths:
      - 'frontend/apps/website-epic/**'
      - '.github/workflows/ci-cd-god-mode.yml'
  pull_request:
    branches: [main]
    paths:
      - 'frontend/apps/website-epic/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '22'
  PNPM_VERSION: '8'
  CACHE_VERSION: 'v1'

permissions:
  contents: read
  pages: write
  id-token: write
  actions: read
  checks: write
  pull-requests: write
  issues: write
  discussions: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  # ðŸ” Code Quality & Security Analysis
  quality-gate:
    name: ðŸ” Quality Gate
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
      test-status: ${{ steps.tests.outcome }}
      lint-status: ${{ steps.lint.outcome }}
      security-status: ${{ steps.security.outcome }}
    steps:
      - name: ðŸšš Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ”„ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ“‹ Install Dependencies
        working-directory: ./frontend/apps/website-epic
        run: pnpm install --frozen-lockfile

      - name: ðŸ” Type Check
        working-directory: ./frontend/apps/website-epic
        run: pnpm type-check

      - name: ðŸ§¹ Lint Code
        id: lint
        working-directory: ./frontend/apps/website-epic
        run: pnpm lint

      - name: ðŸ§ª Run Tests
        id: tests
        working-directory: ./frontend/apps/website-epic
        run: pnpm test --coverage --watchAll=false

      - name: ðŸ“Š Coverage Report
        uses: codecov/codecov-action@v3
        with:
          file: ./frontend/apps/website-epic/coverage/lcov.info
          flags: frontend
          name: frontend-coverage

      - name: ðŸ”’ Security Audit
        id: security
        working-directory: ./frontend/apps/website-epic
        run: pnpm audit --audit-level moderate

      - name: ðŸ›¡ï¸ Dependency Security Scan
        uses: securecodewarrior/github-action-add-sarif@v1
        if: always()
        with:
          sarif-file: 'security-scan-results.sarif'

      - name: âœ… Deployment Decision
        id: check
        run: |
          SHOULD_DEPLOY="true"
          if [ "${{ steps.tests.outcome }}" != "success" ] && [ "${{ github.event.inputs.force_deploy }}" != "true" ]; then
            SHOULD_DEPLOY="false"
          fi
          if [ "${{ steps.lint.outcome }}" != "success" ] && [ "${{ github.event.inputs.force_deploy }}" != "true" ]; then
            SHOULD_DEPLOY="false"
          fi
          echo "should-deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT

  # ðŸ—ï¸ Build & Test Matrix
  build-matrix:
    name: ðŸ—ï¸ Build Matrix
    needs: quality-gate
    if: needs.quality-gate.outputs.should-deploy == 'true'
    strategy:
      matrix:
        environment: [staging, production]
        include:
          - environment: staging
            url: https://aigestion.github.io/aigestion-staging/
            build-args: ''
          - environment: production
            url: https://aigestion.net
            build-args: '--production'
    runs-on: ubuntu-latest
    outputs:
      artifact-name: ${{ steps.build.outputs.artifact-name }}
      deploy-url: ${{ matrix.environment == 'production' && 'https://aigestion.net' || 'https://aigestion.github.io/aigestion-staging/' }}
    steps:
      - name: ðŸšš Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ”„ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ“‹ Install Dependencies
        working-directory: ./frontend/apps/website-epic
        run: pnpm install --frozen-lockfile

      - name: ðŸ”¨ Build Application
        id: build
        working-directory: ./frontend/apps/website-epic
        run: |
          ARTIFACT_NAME="website-epic-${{ matrix.environment }}-${{ github.sha }}"
          echo "artifact-name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT

          # Build with environment-specific variables
          pnpm build ${{ matrix.build-args }}

          # Generate build info
          echo "Build completed for ${{ matrix.environment }}" > build-info.txt
          echo "Commit: ${{ github.sha }}" >> build-info.txt
          echo "Timestamp: $(date -u)" >> build-info.txt
          echo "Environment: ${{ matrix.environment }}" >> build-info.txt

      - name: ðŸ“¦ Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.artifact-name }}
          path: |
            ./frontend/apps/website-epic/dist/
            ./frontend/apps/website-epic/build-info.txt
          retention-days: 30

      - name: ðŸ§ª E2E Tests (Production only)
        if: matrix.environment == 'production'
        working-directory: ./frontend/apps/website-epic
        run: |
          # Start preview server
          pnpm preview &
          sleep 10

          # Run E2E tests
          pnpm test:e2e || true

  # ðŸš€ Deploy to Environments
  deploy:
    name: ðŸš€ Deploy to ${{ matrix.environment }}
    needs: build-matrix
    if: |
      github.ref == 'refs/heads/main' &&
      needs.build-matrix.result == 'success' &&
      (github.event.inputs.environment == matrix.environment || github.event.inputs.environment == '')
    strategy:
      matrix:
        environment: [staging, production]
    runs-on: ubuntu-latest
    environment:
      name: ${{ matrix.environment }}
      url: ${{ needs.build-matrix.outputs.deploy-url }}
    steps:
      - name: ðŸ“¥ Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: website-epic-${{ matrix.environment }}-${{ github.sha }}
          path: ./dist

      - name: ðŸš€ Deploy to GitHub Pages
        if: matrix.environment == 'production'
        uses: actions/deploy-pages@v4
        with:
          artifact_name: website-epic-${{ matrix.environment }}-${{ github.sha }}

      - name: ðŸš€ Deploy to Staging
        if: matrix.environment == 'staging'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          destination_dir: aigestion-staging

      - name: ðŸ“Š Performance Audit
        if: matrix.environment == 'production'
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            https://aigestion.net
            https://aigestion.net/about
          configPath: './lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true

  # ðŸ“± Notifications & Monitoring
  notify:
    name: ðŸ“± Notifications
    needs: [quality-gate, build-matrix, deploy]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“§ Slack Notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,action,eventName,ref,workflow

      - name: ðŸ“§ Email Notification
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ðŸš¨ AIGestion Deployment Failed - ${{ github.ref }}"
          body: |
            Deployment failed for commit ${{ github.sha }}

            Quality Gate: ${{ needs.quality-gate.result }}
            Build Matrix: ${{ needs.build-matrix.result }}
            Deploy: ${{ needs.deploy.result }}

            Check: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.ADMIN_EMAIL }}
          from: "GitHub Actions <noreply@aigestion.net>"

  # ðŸ§¹ Cleanup
  cleanup:
    name: ðŸ§¹ Cleanup
    needs: [deploy]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ—‘ï¸ Clean Old Artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });

            // Keep only last 10 artifacts
            if (artifacts.data.artifacts.length > 10) {
              const toDelete = artifacts.data.artifacts.slice(10);
              for (const artifact of toDelete) {
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id,
                });
              }
            }
