name: ðŸš€ Deploy â€” Vercel (Canary â†’ Production)

on:
  workflow_call:
    inputs:
      deploy-approved:
        description: 'Whether deployment was approved by CI'
        required: true
        type: string
    secrets: inherit
  workflow_dispatch:

permissions:
  deployments: write

jobs:
  # ðŸš€ VERCEL CANARY DEPLOY
  vercel-canary:
    name: ðŸ›¡ï¸ Vercel Canary Deploy
    runs-on: ubuntu-latest
    if: ${{ inputs.deploy-approved == 'true' || github.event_name == 'workflow_dispatch' }}
    outputs:
      preview-url: ${{ steps.deploy.outputs.preview-url }}
    environment:
      name: staging
      url: ${{ steps.deploy.outputs.preview-url }}

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: app-dist
          path: frontend/apps/website-epic/dist

      - name: ðŸ›¡ï¸ Deploy Canary (Preview)
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '' # No --prod for canary
          working-directory: frontend/apps/website-epic

  # ðŸ” CANARY HEALTH CHECK
  post-deploy-validation:
    name: ðŸ” Canary Validation
    runs-on: ubuntu-latest
    needs: vercel-canary
    if: success()
    outputs:
      passed: ${{ steps.health.outputs.passed }}

    steps:
      - name: â±ï¸ Wait for Propagation
        run: sleep 15

      - name: ðŸ” Health Check
        id: health
        run: |
          URL="${{ needs.vercel-canary.outputs.preview-url }}"
          echo "Testing Canary at $URL"
          for i in {1..5}; do
            if curl -f "$URL" > /dev/null 2>&1; then
              echo "âœ… Health check passed"
              echo "passed=true" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "â³ Waiting... ($i/5)"
              sleep 10
            fi
          done
          echo "âŒ Health check failed"
          echo "passed=false" >> $GITHUB_OUTPUT
          exit 1

  # ðŸ† PRODUCTION PROMOTION
  production-promotion:
    name: ðŸš€ Production Promotion
    runs-on: ubuntu-latest
    needs: [vercel-canary, post-deploy-validation]
    if: needs.post-deploy-validation.result == 'success'
    environment:
      name: production
      url: https://aigestion.net

    steps:
      - name: ðŸ“¥ Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: app-dist
          path: frontend/apps/website-epic/dist

      - name: ðŸš€ Promote to Production
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: frontend/apps/website-epic

      - name: ðŸ“Š Deployment Summary
        run: |
          echo "## ðŸš€ Production Promotion Successful" >> $GITHUB_STEP_SUMMARY
          echo "The canary version has been promoted to production." >> $GITHUB_STEP_SUMMARY

  # ðŸ“¢ NOTIFICATIONS
  notifications:
    name: ðŸ“¢ Smart Notifications
    runs-on: ubuntu-latest
    needs: [production-promotion, post-deploy-validation]
    if: always()

    steps:
      - name: ðŸ“§ Deployment Notification
        if: always()
        run: |
          STATUS="âœ… Success"
          if [ "${{ needs.production-promotion.result }}" != "success" ]; then
            STATUS="âŒ Failed"
          fi

          echo "## ðŸš€ AIGestion Vercel Deployment $STATUS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Promotion Status:** $STATUS" >> $GITHUB_STEP_SUMMARY
          echo "**Canary Validation:** ${{ needs.post-deploy-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment URL:** https://aigestion.net" >> $GITHUB_STEP_SUMMARY
