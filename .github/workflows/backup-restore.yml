name: ðŸ’¾ Backup & Recovery

on:
  schedule:
    - cron: '0 3 * * 0' # Weekly on Sunday at 3 AM UTC
  workflow_dispatch:
    inputs:
      backup_type:
        description: 'Type of backup'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - incremental
          - config-only
      restore_point:
        description: 'Restore point (for restore operations)'
        required: false
        type: string

permissions:
  contents: write
  actions: read
  issues: write

jobs:
  # ðŸ’¾ Create Backup
  backup:
    name: ðŸ’¾ Create Backup
    runs-on: ubuntu-latest
    outputs:
      backup-id: ${{ steps.backup.outputs.backup-id }}
      backup-date: ${{ steps.backup.outputs.backup-date }}
    steps:
      - name: ðŸšš Checkout Code
        uses: actions/checkout@v6

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: ðŸ”„ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '8'

      - name: ðŸ“‹ Install Dependencies
        working-directory: ./frontend/apps/website-epic
        run: pnpm install

      - name: ðŸ”¨ Build Production Version
        working-directory: ./frontend/apps/website-epic
        run: pnpm build

      - name: ðŸ“¦ Create Backup Archive
        id: backup
        run: |
          BACKUP_ID="aigestion-backup-$(date +%Y%m%d-%H%M%S)"
          BACKUP_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          echo "backup-id=$BACKUP_ID" >> $GITHUB_OUTPUT
          echo "backup-date=$BACKUP_DATE" >> $GITHUB_OUTPUT

          # Create backup directory
          mkdir -p ./backup/$BACKUP_ID

          # Backup source code
          tar -czf ./backup/$BACKUP_ID/source-code.tar.gz \
            --exclude=node_modules \
            --exclude=dist \
            --exclude=.git \
            ./frontend/apps/website-epic/

          # Backup build artifacts
          cp -r ./frontend/apps/website-epic/dist ./backup/$BACKUP_ID/

          # Backup configuration files
          mkdir -p ./backup/$BACKUP_ID/config
          cp ./frontend/apps/website-epic/package*.json ./backup/$BACKUP_ID/config/
          cp ./frontend/apps/website-epic/vercel.json ./backup/$BACKUP_ID/config/ || true
          cp ./frontend/apps/website-epic/netlify.toml ./backup/$BACKUP_ID/config/ || true

          # Backup environment template
          mkdir -p ./backup/$BACKUP_ID/env
          echo "# Environment Variables Template" > ./backup/$BACKUP_ID/env/.env.template
          echo "VITE_SUPABASE_URL=your_supabase_url" >> ./backup/$BACKUP_ID/env/.env.template
          echo "VITE_SUPABASE_ANON_KEY=your_supabase_anon_key" >> ./backup/$BACKUP_ID/env/.env.template

          # Create backup metadata
          cat > ./backup/$BACKUP_ID/metadata.json << EOF
          {
            "backup_id": "$BACKUP_ID",
            "backup_date": "$BACKUP_DATE",
            "commit_hash": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "backup_type": "${{ github.event.inputs.backup_type || 'scheduled' }}",
            "created_by": "${{ github.actor }}",
            "workflow_run": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }
          EOF

          echo "âœ… Backup created: $BACKUP_ID"

      - name: ðŸ“¤ Upload Backup to Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: ${{ steps.backup.outputs.backup-id }}
          path: ./backup/${{ steps.backup.outputs.backup-id }}/
          retention-days: 90

      - name: ðŸ“¤ Upload Backup to Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: backup-${{ steps.backup.outputs.backup-id }}
          name: ðŸ“¦ Backup ${{ steps.backup.outputs.backup-id }}
          body: |
            ## ðŸ“¦ AIGestion Backup

            **Backup ID:** ${{ steps.backup.outputs.backup-id }}
            **Date:** ${{ steps.backup.outputs.backup-date }}
            **Commit:** ${{ github.sha }}
            **Type:** ${{ github.event.inputs.backup_type || 'Scheduled' }}

            ### ðŸ“ Contents:
            - âœ… Source code (excluding node_modules)
            - âœ… Production build artifacts
            - âœ… Configuration files
            - âœ… Environment template
            - âœ… Metadata

            ### ðŸ”„ Restore Instructions:
            1. Download the backup artifact
            2. Extract source-code.tar.gz
            3. Run `pnpm install`
            4. Configure environment variables
            5. Run `pnpm build`

            ---
            *Automated backup by GitHub Actions*
          files: |
            backup/${{ steps.backup.outputs.backup-id }}/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ðŸ§¹ Cleanup Old Backups
  cleanup:
    name: ðŸ§¹ Cleanup Old Backups
    needs: backup
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ—‘ï¸ Delete Old Backup Releases
        uses: actions/github-script@v8
        with:
          script: |
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            // Keep only last 10 backup releases
            const backupReleases = releases.filter(r => r.name.startsWith('ðŸ“¦ Backup'));
            if (backupReleases.length > 10) {
              const toDelete = backupReleases.slice(10);
              for (const release of toDelete) {
                await github.rest.repos.deleteRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: release.id,
                });
                console.log(`Deleted old backup: ${release.name}`);
              }
            }

      - name: ðŸ—‘ï¸ Delete Old Artifacts
        uses: actions/github-script@v8
        with:
          script: |
            const { data: artifacts } = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            // Keep only last 20 backup artifacts
            const backupArtifacts = artifacts.artifacts.filter(a => a.name.startsWith('aigestion-backup-'));
            if (backupArtifacts.length > 20) {
              const toDelete = backupArtifacts.slice(20);
              for (const artifact of toDelete) {
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id,
                });
                console.log(`Deleted old artifact: ${artifact.name}`);
              }
            }

  # ðŸ“Š Backup Report
  backup-report:
    name: ðŸ“Š Backup Report
    needs: [backup, cleanup]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“Š Generate Backup Report
        run: |
          cat > backup-report.md << EOF
          # ðŸ“Š Backup Report

          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Workflow:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ## ðŸ“¦ Backup Status
          - **Backup ID:** ${{ needs.backup.outputs.backup-id }}
          - **Backup Date:** ${{ needs.backup.outputs.backup-date }}
          - **Status:** ${{ needs.backup.result }}
          - **Cleanup Status:** ${{ needs.cleanup.result }}

          ## ðŸ“ˆ Statistics
          - **Total Backups:** $(gh release list --repo ${{ github.repository }} --limit 100 | grep -c "ðŸ“¦ Backup" || echo "0")
          - **Storage Used:** Check artifacts size

          ## ðŸ”„ Next Scheduled Backup
          - **When:** Every Sunday at 3:00 AM UTC
          - **Retention:** 90 days for artifacts, 10 releases

          ---
          *Generated by GitHub Actions*
          EOF

      - name: ðŸ“¤ Upload Report
        uses: actions/upload-artifact@v6
        with:
          name: backup-report-${{ github.run_number }}
          path: backup-report.md

      - name: ðŸ“§ Send Report
        uses: dawidd6/action-send-mail@v7
        if: always()
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ðŸ“Š AIGestion Backup Report - ${{ needs.backup.result }}"
          body: file://backup-report.md
          to: ${{ secrets.ADMIN_EMAIL }}
          from: "AIGestion Backup <noreply@aigestion.net>"
