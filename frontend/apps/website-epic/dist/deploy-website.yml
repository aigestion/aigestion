name: Deploy Website Epic to GitHub Pages
on:
  push:
    branches:
      - main
      master
  jobs:
    - name: Deploy to GitHub Pages
      runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Build application
        run: npm run build
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
      - name: Cache build artifacts
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: ./dist
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    timeout-minutes: 10

  permissions:
    contents: read
    pages: write
    id-token: write

  # Enable Pages
  pages:
    branches:
      - main
    source: frontend/apps/src
    build:
      output: 'dist'
      base: '/'
    domain: aigestion.net

  # Custom domain configuration
  custom_domain: aigestion.net

  # SSL/TLS
  ssl:
    enforce: true

  # Jekyll configuration
  plugins:
    - jekyll-optional
    - jekyll-sitemap
    - jekyll-feed
    - jekyll-seo
    - jekyll-paginate

  # Exclude files from processing
  exclude:
    - frontend/apps/node_modules/
    - frontend/apps/.vite/
    - frontend/apps/dist/
    - frontend/apps/src/__tests__/
    - frontend/apps/src/__tests__/e2e/
    - frontend/apps/src/monitoring/
    - frontend/apps/src/security/
    - frontend/apps/src/testing/
    frontend/apps/src/patterns/

  # Include specific files
  include:
    - frontend/apps/public/
    - frontend/apps/src/
    - frontend/apps/manifest.json
    - frontend/apps/sw.js
    - frontend/apps/sw-advanced.js

# Additional build optimizations
build:
  minify: true
  sourcemap: true
  rollup:
    output:
      manualChunks:
        vendor: ['react', 'react-dom']
        three: ['three', '@react-three/fiber', '@react-three/drei']
        framer: ['framer-motion']
        lucide: ['lucide-react']
        supabase: ['@supabase/supabase-js']
        tailwind: ['tailwindcss']
        vitest: ['vitest', '@testing-library/react', '@testing-library/jest-dom']
        react-router: ['react-router-dom']
    },
    chunkSizeWarningLimit: 1000,

# Environment variables
env:
  VITE_API_URL: https://api.aigestion.net
  VITE_SUPABASE_URL: https://jhvtjyfmgncrrbzqpbkt.supabase.co
  VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
  VITE_PWA: true
  VITE_GENERATE_SOURCEMAP: true

# Development server configuration
server:
  port: 5173
  host: true
  cors: true
  strictPort: false

# Testing configuration
test:
  globals:
    define: {
      'import.meta.env.VITE_API_URL': 'https://api.aigestion.net',
      'import.meta.env.VITE_SUPABASE_URL': 'https://jhvtjyfmgncrrbzqpbkt.supabase.co',
      'import.meta.env.VITE_SUPABASE_ANON_KEY': '***',
    },
  environment: jsdom
  setupFiles: ['./src/setupTests.ts'],
  testTimeout: 30000,
  reporters: ['default', 'coverage', 'junit', 'vitest'],
  include: [
    'src/**/*.{test,spec}.{test,spec.ts,tsx,jsx}',
    'src/**/__tests__/**/*.{test,spec}.{test,spec.ts,tsx}',
  ],
  coverage: {
    reporter: ['text', 'html', 'lcov', 'json'],
    reportsDirectory: 'coverage',
    exclude: [
      'src/**/*.{test,spec}.{test,spec.ts,tsx}',
      'src/**/__tests__/**/*.{test,spec}.{test,spec.ts,tsx}',
      'src/**/components/**/*.{test,spec}.{test,spec.ts,tsx}',
    ],
  },
}

