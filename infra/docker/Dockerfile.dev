# Development environment with hot reload
FROM node:20-alpine

# Install build dependencies and enable pnpm
RUN apk add --no-cache \
    libc6-compat \
    python3 \
    make \
    g++ \
    git \
    curl \
    && corepack enable && corepack prepare pnpm@latest --activate

WORKDIR /app

# Copy workspace config
COPY pnpm-lock.yaml pnpm-workspace.yaml package.json ./

# Copy backend specific config
COPY backend/package.json ./backend/
# Copy frontend specific config
COPY frontend/package.json ./frontend/
# Copy sub-packages manifests for pnpm workspace resolution
COPY packages/dashboard-core/package.json ./packages/dashboard-core/
COPY packages/decentraland-parcel/package.json ./packages/decentraland-parcel/
COPY packages/design-system-v2/package.json ./packages/design-system-v2/
COPY packages/eslint-config/package.json ./packages/eslint-config/
COPY packages/nexus-core-nestjs/package.json ./packages/nexus-core-nestjs/
COPY packages/nexus-shared/package.json ./packages/nexus-shared/

# Install dependencies
# Using --no-frozen-lockfile in dev to facilitate workspace resolution if manifests changed
RUN pnpm install --no-frozen-lockfile

# Final copy of source code
COPY . .

# Expose ports (Base ports, overridden by compose)
EXPOSE 5173 3000

# Default CMD (Overridden by compose for specific filters)
CMD ["pnpm", "dev"]
