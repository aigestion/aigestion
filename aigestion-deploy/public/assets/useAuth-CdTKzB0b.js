import{j as e}from"./vendor-3d-CTa5dsNI.js";import{r as a}from"./vendor-react-C91fTXKM.js";import{c as t}from"./vendor-data-CncgVCKE.js";const i=({children:t,className:i=""})=>{const n=a.useRef(null),[o,s]=a.useState({x:0,y:0}),[r,c]=a.useState(0);return e.jsxs("div",{ref:n,onMouseMove:e=>{if(!n.current)return;const a=n.current.getBoundingClientRect();s({x:e.clientX-a.left,y:e.clientY-a.top})},onMouseEnter:()=>{c(1)},onMouseLeave:()=>{c(0)},className:`relative w-full h-full overflow-hidden bg-nexus-obsidian ${i}`,children:[e.jsx("div",{className:"pointer-events-none absolute -inset-px transition duration-300",style:{opacity:r,background:`radial-gradient(600px circle at ${o.x}px ${o.y}px, rgba(138, 43, 226, 0.15), transparent 40%)`}}),e.jsx("div",{className:"pointer-events-none absolute -inset-px transition duration-300",style:{opacity:r,background:`radial-gradient(400px circle at ${o.x}px ${o.y}px, rgba(0, 245, 255, 0.1), transparent 40%)`}}),t]})},n=t("https://nbymcxvlcfyhebzjurml.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ieW1jeHZsY2Z5aGViemp1cm1sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NzU1MDAsImV4cCI6MjA4NTE1MTUwMH0.naLyb4Fc2o0-c4K2S_D7rEXasUN-xu7zcBtX-nVHldA",{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,storage:"undefined"!=typeof window?window.localStorage:void 0,storageKey:"aigestion-auth-token",flowType:"pkce"},realtime:{params:{eventsPerSecond:10},heartbeatIntervalMs:15e3},global:{headers:{"x-application-name":"aigestion-frontend","x-app-version":"2.0.0"},fetch:async function(e,a){for(let i=0;i<=3;i++)try{const t=await fetch(e,a);if(t.ok||t.status>=400&&t.status<500)return t;if(3===i)return t;await new Promise(e=>setTimeout(e,300*Math.pow(2,i)))}catch(t){if(3===i)throw t;await new Promise(e=>setTimeout(e,300*Math.pow(2,i)))}return fetch(e,a)}},db:{schema:"public"}});async function o(e,a={}){const t=`/api${e}`,i={"Content-Type":"application/json",...a.headers};try{const e=await fetch(t,{...a,headers:i}),n=await e.json();if(!e.ok)throw new Error(n.message||"Error de conexi\xf3n");return n.data||n}catch(n){throw n}}const s=async e=>o("/auth/register",{method:"POST",body:JSON.stringify(e)}),r=async e=>o("/auth/verify-email",{method:"POST",body:JSON.stringify(e)}),c=async(e,a)=>o("/auth/role",{method:"PUT",headers:{Authorization:`Bearer ${a}`},body:JSON.stringify(e)}),l=async(e,a)=>o("/auth/plan",{method:"PUT",headers:{Authorization:`Bearer ${a}`},body:JSON.stringify(e)}),u=["admin@aigestion.net","nemisanalex@gmail.com"];function d(){const[e,t]=a.useState({session:null,user:null,loading:!0,isAuthenticated:!1,isAdmin:!1,isMobileApp:!1}),i=a.useCallback(()=>"localhost"===window.location.hostname||window.location.protocol.includes("capacitor")||"file:"===window.location.protocol||""===window.location.port,[]),o=a.useCallback(e=>{const a=e.user_metadata||{};return{email:e.email,name:a.name||e.email.split("@")[0],subscription:a.subscription||"free",role:a.role||"client",avatar:a.avatar,phone:a.phone,phoneVerified:a.phoneVerified||!1,emailVerified:null!=e.email_confirmed_at,lastLogin:new Date,createdAt:e.created_at?new Date(e.created_at):new Date}},[]),d=a.useCallback(e=>{const a=u.includes(e.email)||"admin"===e.role,t=i();return!(!a||t)&&(window.location.href="https://admin.aigestion.net",!0)},[i]),h=a.useCallback(async e=>{t(e=>({...e,loading:!0}));try{if(e?.user){const a=o(e.user);if(d(a))return;t({session:e,user:a,loading:!1,isAuthenticated:!0,isAdmin:u.includes(a.email)||"admin"===a.role,isMobileApp:i()})}else t({session:null,user:null,loading:!1,isAuthenticated:!1,isAdmin:!1,isMobileApp:i()})}catch(a){t(e=>({...e,loading:!1,isAuthenticated:!1,user:null,session:null}))}},[o,d,i]),p=a.useCallback(async(e,a)=>{if(t(e=>({...e,loading:!0})),n)try{const{data:t,error:i}=await n.auth.signInWithPassword({email:e,password:a});if(i)throw i;t.session?.user&&await h(t.session)}catch(i){throw t(e=>({...e,loading:!1})),i}else setTimeout(()=>{t(a=>({...a,loading:!1,isAuthenticated:!0,user:{email:e,name:e.split("@")[0],subscription:"free",role:"client"},session:{}}))},1e3)},[h]),f=a.useCallback(async()=>{if(t(e=>({...e,loading:!0})),n)try{await n.auth.signOut(),await h(null)}catch(e){t({session:null,user:null,loading:!1,isAuthenticated:!1,isAdmin:!1,isMobileApp:i()})}else t({session:null,user:null,loading:!1,isAuthenticated:!1,isAdmin:!1,isMobileApp:i()})},[h,i]),w=a.useCallback(async()=>{if(n)try{const{data:e,error:a}=await n.auth.refreshSession();if(a)throw a;await h(e.session)}catch(e){await h(null)}},[h]),m=a.useCallback(async a=>{if(!e.user||!e.session)throw new Error("No authenticated user");if(n){t(e=>({...e,loading:!0}));try{const{error:e}=await n.auth.updateUser({data:a});if(e)throw e;await w()}catch(i){throw t(e=>({...e,loading:!1})),i}}},[e.user,e.session,w]),y=a.useCallback(async e=>{if(n)try{const{error:a}=await n.functions.invoke("send-phone-verification",{body:{phone:e}});if(a)throw new Error("Error al enviar c\xf3digo de verificaci\xf3n")}catch(a){throw a}},[]),g=a.useCallback(async(e,a)=>{if(!n){if("123456"===a)return void(await m({phone:e,phoneVerified:!0}));throw new Error("C\xf3digo inv\xe1lido. En modo demo usa: 123456")}try{const{error:t}=await n.functions.invoke("verify-phone-code",{body:{phone:e,code:a}});if(t)throw new Error("C\xf3digo de verificaci\xf3n inv\xe1lido");await m({phone:e,phoneVerified:!0})}catch(t){throw t}},[m]),b=a.useCallback(()=>e.user?.phoneVerified||!1,[e.user]),k=a.useCallback(async(e,a,i)=>{t(e=>({...e,loading:!0}));try{const{user:n,token:o}=await s({name:e,email:a,password:i}),r={id:n._id||n.id,name:n.name,email:n.email,role:n.role,subscription:"free",emailVerified:!1,phoneVerified:!1};t(e=>({...e,loading:!1,user:r,token:o}))}catch(n){throw t(e=>({...e,loading:!1})),n}},[]),v=a.useCallback(async(a,i)=>{try{await r({userId:a,code:i}),e.user&&e.user.id===a&&t(e=>({...e,user:{...e.user,emailVerified:!0}}))}catch(n){throw n}},[e.user]),C=a.useCallback(async(a,i)=>{try{if(!e.token)throw new Error("No auth token");const{user:n}=await c({userId:a,role:i},e.token);e.user&&t(e=>({...e,user:{...e.user,role:i}}))}catch(n){throw n}},[e.token,e.user]),A=a.useCallback(async(a,i)=>{try{if(!e.token)throw new Error("No auth token");const{user:n}=await l({userId:a,plan:i},e.token);e.user&&t(e=>({...e,user:{...e.user,subscriptionPlan:i}}))}catch(n){throw n}},[e.token,e.user]);return a.useEffect(()=>{if(!n)return void t(e=>({...e,loading:!1}));n.auth.getSession().then(({data:{session:e}})=>h(e)).catch(e=>{t(e=>({...e,loading:!1}))});const{data:{subscription:e}}=n.auth.onAuthStateChange((e,a)=>{h(a)});return()=>e.unsubscribe()},[h]),{...e,login:p,logout:f,refreshSession:w,updateUser:m,verifyPhone:g,register:k,verifyEmail:v,updateRole:C,updatePlan:A,sendPhoneVerificationCode:y,checkPhoneVerification:b}}export{i as S,n as s,d as u};
